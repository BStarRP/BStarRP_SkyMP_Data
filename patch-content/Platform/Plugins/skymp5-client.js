/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./node_modules/eventemitter3/index.js":
/*!*********************************************!*\
  !*** ./node_modules/eventemitter3/index.js ***!
  \*********************************************/
/***/ ((module) => {



var has = Object.prototype.hasOwnProperty
  , prefix = '~';

/**
 * Constructor to create a storage for our `EE` objects.
 * An `Events` instance is a plain object whose properties are event names.
 *
 * @constructor
 * @private
 */
function Events() {}

//
// We try to not inherit from `Object.prototype`. In some engines creating an
// instance in this way is faster than calling `Object.create(null)` directly.
// If `Object.create(null)` is not supported we prefix the event names with a
// character to make sure that the built-in object properties are not
// overridden or used as an attack vector.
//
if (Object.create) {
  Events.prototype = Object.create(null);

  //
  // This hack is needed because the `__proto__` property is still inherited in
  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.
  //
  if (!new Events().__proto__) prefix = false;
}

/**
 * Representation of a single event listener.
 *
 * @param {Function} fn The listener function.
 * @param {*} context The context to invoke the listener with.
 * @param {Boolean} [once=false] Specify if the listener is a one-time listener.
 * @constructor
 * @private
 */
function EE(fn, context, once) {
  this.fn = fn;
  this.context = context;
  this.once = once || false;
}

/**
 * Add a listener for a given event.
 *
 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} context The context to invoke the listener with.
 * @param {Boolean} once Specify if the listener is a one-time listener.
 * @returns {EventEmitter}
 * @private
 */
function addListener(emitter, event, fn, context, once) {
  if (typeof fn !== 'function') {
    throw new TypeError('The listener must be a function');
  }

  var listener = new EE(fn, context || emitter, once)
    , evt = prefix ? prefix + event : event;

  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;
  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);
  else emitter._events[evt] = [emitter._events[evt], listener];

  return emitter;
}

/**
 * Clear event by name.
 *
 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
 * @param {(String|Symbol)} evt The Event name.
 * @private
 */
function clearEvent(emitter, evt) {
  if (--emitter._eventsCount === 0) emitter._events = new Events();
  else delete emitter._events[evt];
}

/**
 * Minimal `EventEmitter` interface that is molded against the Node.js
 * `EventEmitter` interface.
 *
 * @constructor
 * @public
 */
function EventEmitter() {
  this._events = new Events();
  this._eventsCount = 0;
}

/**
 * Return an array listing the events for which the emitter has registered
 * listeners.
 *
 * @returns {Array}
 * @public
 */
EventEmitter.prototype.eventNames = function eventNames() {
  var names = []
    , events
    , name;

  if (this._eventsCount === 0) return names;

  for (name in (events = this._events)) {
    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);
  }

  if (Object.getOwnPropertySymbols) {
    return names.concat(Object.getOwnPropertySymbols(events));
  }

  return names;
};

/**
 * Return the listeners registered for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Array} The registered listeners.
 * @public
 */
EventEmitter.prototype.listeners = function listeners(event) {
  var evt = prefix ? prefix + event : event
    , handlers = this._events[evt];

  if (!handlers) return [];
  if (handlers.fn) return [handlers.fn];

  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {
    ee[i] = handlers[i].fn;
  }

  return ee;
};

/**
 * Return the number of listeners listening to a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Number} The number of listeners.
 * @public
 */
EventEmitter.prototype.listenerCount = function listenerCount(event) {
  var evt = prefix ? prefix + event : event
    , listeners = this._events[evt];

  if (!listeners) return 0;
  if (listeners.fn) return 1;
  return listeners.length;
};

/**
 * Calls each of the listeners registered for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Boolean} `true` if the event had listeners, else `false`.
 * @public
 */
EventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {
  var evt = prefix ? prefix + event : event;

  if (!this._events[evt]) return false;

  var listeners = this._events[evt]
    , len = arguments.length
    , args
    , i;

  if (listeners.fn) {
    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);

    switch (len) {
      case 1: return listeners.fn.call(listeners.context), true;
      case 2: return listeners.fn.call(listeners.context, a1), true;
      case 3: return listeners.fn.call(listeners.context, a1, a2), true;
      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;
      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;
      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;
    }

    for (i = 1, args = new Array(len -1); i < len; i++) {
      args[i - 1] = arguments[i];
    }

    listeners.fn.apply(listeners.context, args);
  } else {
    var length = listeners.length
      , j;

    for (i = 0; i < length; i++) {
      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);

      switch (len) {
        case 1: listeners[i].fn.call(listeners[i].context); break;
        case 2: listeners[i].fn.call(listeners[i].context, a1); break;
        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;
        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;
        default:
          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {
            args[j - 1] = arguments[j];
          }

          listeners[i].fn.apply(listeners[i].context, args);
      }
    }
  }

  return true;
};

/**
 * Add a listener for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} [context=this] The context to invoke the listener with.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.on = function on(event, fn, context) {
  return addListener(this, event, fn, context, false);
};

/**
 * Add a one-time listener for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} [context=this] The context to invoke the listener with.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.once = function once(event, fn, context) {
  return addListener(this, event, fn, context, true);
};

/**
 * Remove the listeners of a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn Only remove the listeners that match this function.
 * @param {*} context Only remove the listeners that have this context.
 * @param {Boolean} once Only remove one-time listeners.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {
  var evt = prefix ? prefix + event : event;

  if (!this._events[evt]) return this;
  if (!fn) {
    clearEvent(this, evt);
    return this;
  }

  var listeners = this._events[evt];

  if (listeners.fn) {
    if (
      listeners.fn === fn &&
      (!once || listeners.once) &&
      (!context || listeners.context === context)
    ) {
      clearEvent(this, evt);
    }
  } else {
    for (var i = 0, events = [], length = listeners.length; i < length; i++) {
      if (
        listeners[i].fn !== fn ||
        (once && !listeners[i].once) ||
        (context && listeners[i].context !== context)
      ) {
        events.push(listeners[i]);
      }
    }

    //
    // Reset the array, or remove it completely if we have no more listeners.
    //
    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;
    else clearEvent(this, evt);
  }

  return this;
};

/**
 * Remove all listeners, or those of the specified event.
 *
 * @param {(String|Symbol)} [event] The event name.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {
  var evt;

  if (event) {
    evt = prefix ? prefix + event : event;
    if (this._events[evt]) clearEvent(this, evt);
  } else {
    this._events = new Events();
    this._eventsCount = 0;
  }

  return this;
};

//
// Alias methods names because people roll like that.
//
EventEmitter.prototype.off = EventEmitter.prototype.removeListener;
EventEmitter.prototype.addListener = EventEmitter.prototype.on;

//
// Expose the prefix.
//
EventEmitter.prefixed = prefix;

//
// Allow `EventEmitter` to be imported as module namespace.
//
EventEmitter.EventEmitter = EventEmitter;

//
// Expose the module.
//
if (true) {
  module.exports = EventEmitter;
}


/***/ }),

/***/ "./src/extensions/formTypeEx.ts":
/*!**************************************!*\
  !*** ./src/extensions/formTypeEx.ts ***!
  \**************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormTypeEx: () => (/* binding */ FormTypeEx)
/* harmony export */ });
var FormTypeEx = /** @class */ (function () {
    function FormTypeEx() {
    }
    FormTypeEx.isItem = function (type) {
        return type === 42 /* FormType.Ammo */ ||
            type === 26 /* FormType.Armor */ ||
            type === 27 /* FormType.Book */ ||
            type === 30 /* FormType.Ingredient */ ||
            type === 31 /* FormType.Light */ ||
            type === 46 /* FormType.Potion */ ||
            type === 23 /* FormType.ScrollItem */ ||
            type === 52 /* FormType.SoulGem */ ||
            type === 41 /* FormType.Weapon */ ||
            type === 32 /* FormType.Misc */;
    };
    return FormTypeEx;
}());



/***/ }),

/***/ "./src/extensions/objectReferenceEx.ts":
/*!*********************************************!*\
  !*** ./src/extensions/objectReferenceEx.ts ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ObjectReferenceEx: () => (/* binding */ ObjectReferenceEx)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _formTypeEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./formTypeEx */ "./src/extensions/formTypeEx.ts");


var ObjectReferenceEx = /** @class */ (function () {
    function ObjectReferenceEx() {
    }
    ObjectReferenceEx.getWorldOrCell = function (self) {
        var world = self.getWorldSpace();
        if (world) {
            return world.getFormID();
        }
        var cell = self.getParentCell();
        if (cell) {
            return cell.getFormID();
        }
        return 0;
    };
    ObjectReferenceEx.getPos = function (self) {
        return [self.getPositionX(), self.getPositionY(), self.getPositionZ()];
    };
    ;
    ObjectReferenceEx.getDistance = function (a, b) {
        var deltaX = a[0] - b[0];
        var deltaY = a[1] - b[1];
        var deltaZ = a[2] - b[2];
        return Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
    };
    ;
    ObjectReferenceEx.getDistanceNoZ = function (a, b) {
        var deltaX = a[0] - b[0];
        var deltaY = a[1] - b[1];
        return Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    };
    ;
    ObjectReferenceEx.dealWithRef = function (self, base) {
        var _a, _b;
        var t = base.getType();
        var isItem = _formTypeEx__WEBPACK_IMPORTED_MODULE_1__.FormTypeEx.isItem(t);
        // BlackFallsBarrow02, door isn't opening via SetOpen so we're hacking it.
        // Not blocking activation & asking parent to activate until will be in the correct state
        // See also modelApplyUtils.ts
        var caveGSecretDoor01 = 0x6f703;
        // You can also block for t === FormType.Flora || t === FormType.Tree, but I don't think it's necessary.
        if (t === 40 /* FormType.Furniture */
            || t === 24 /* FormType.Activator */
            || t === 28 /* FormType.Container */
            || isItem
            || t === 43 /* FormType.NPC */
            || (t === 29 /* FormType.Door */ && ((_a = self.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) !== caveGSecretDoor01)) {
            self.blockActivation(true);
        }
        else {
            self.blockActivation(false);
        }
        if (self.isLocked()) {
            self.lock(false, false);
        }
        if (isItem) {
            self.setMotionType(4 /* MotionType.Keyframed */, false);
        }
        // https://github.com/skyrim-multiplayer/issue-tracker/issues/36
        if (t === 39 /* FormType.Flora */ && ((_b = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Flora.from(base)) === null || _b === void 0 ? void 0 : _b.getIngredient())) {
            self.setMotionType(4 /* MotionType.Keyframed */, false);
        }
    };
    return ObjectReferenceEx;
}());



/***/ }),

/***/ "./src/features/authModel.ts":
/*!***********************************!*\
  !*** ./src/features/authModel.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   authGameDataStorageKey: () => (/* binding */ authGameDataStorageKey)
/* harmony export */ });
;
;
;
var authGameDataStorageKey = "authGameData";


/***/ }),

/***/ "./src/lib/errors.ts":
/*!***************************!*\
  !*** ./src/lib/errors.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NeverError: () => (/* binding */ NeverError),
/* harmony export */   RespawnNeededError: () => (/* binding */ RespawnNeededError)
/* harmony export */ });
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var RespawnNeededError = /** @class */ (function (_super) {
    __extends(RespawnNeededError, _super);
    function RespawnNeededError(message) {
        var _this = _super.call(this, message) || this;
        Object.setPrototypeOf(_this, RespawnNeededError.prototype);
        return _this;
    }
    return RespawnNeededError;
}(Error));

var NeverError = /** @class */ (function (_super) {
    __extends(NeverError, _super);
    function NeverError(message) {
        var _this = _super.call(this, "NeverError: ".concat(JSON.stringify(message))) || this;
        Object.setPrototypeOf(_this, NeverError.prototype);
        return _this;
    }
    return NeverError;
}(Error));



/***/ }),

/***/ "./src/lib/idManager.ts":
/*!******************************!*\
  !*** ./src/lib/idManager.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   IdManager: () => (/* binding */ IdManager)
/* harmony export */ });
var IdManager = /** @class */ (function () {
    function IdManager() {
        this.idByValue = new Array();
        this.valueById = new Array();
        this.minimumUnusedId = 0;
    }
    IdManager.prototype.allocateIdFor = function (value) {
        if (this.idByValue.length <= value) {
            this.idByValue.length = value + 1;
        }
        this.idByValue[value] = this.minimumUnusedId;
        if (this.valueById.length <= this.minimumUnusedId) {
            this.valueById.length = this.minimumUnusedId + 1;
        }
        this.valueById[this.minimumUnusedId] = value;
        var res = this.minimumUnusedId;
        this.minimumUnusedId++;
        while (this.valueById.length > this.minimumUnusedId &&
            typeof this.valueById[this.minimumUnusedId] === "number") {
            this.minimumUnusedId++;
        }
        return res;
    };
    IdManager.prototype.freeIdFor = function (value) {
        var id = this.idByValue[value];
        if (id < this.minimumUnusedId) {
            this.minimumUnusedId = id;
        }
        this.idByValue[value] = undefined;
        this.valueById[id] = undefined;
        return;
    };
    IdManager.prototype.getId = function (value) {
        var r = this.idByValue[value];
        return typeof r === "number" ? r : -1;
    };
    IdManager.prototype.getValueById = function (id) {
        return this.valueById[id];
    };
    return IdManager;
}());



/***/ }),

/***/ "./src/lib/nameof.ts":
/*!***************************!*\
  !*** ./src/lib/nameof.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   nameof: () => (/* binding */ nameof)
/* harmony export */ });
function nameof(key) {
    return key;
}


/***/ }),

/***/ "./src/logging.ts":
/*!************************!*\
  !*** ./src/logging.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   logError: () => (/* binding */ logError),
/* harmony export */   logTrace: () => (/* binding */ logTrace)
/* harmony export */ });
/* harmony import */ var _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @skyrim-platform/skyrim-platform */ "skyrimPlatform");
/* harmony import */ var _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__);
var __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};

// TODO: redirect this to spdlog
function logError(service) {
    var rest = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        rest[_i - 1] = arguments[_i];
    }
    var restProcessed = rest.map(function (item) {
        if (item instanceof Error) {
            return item.stack || item.message;
        }
        return item;
    });
    _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__.printConsole.apply(void 0, __spreadArray(["Error in ".concat(typeof service !== "string" ? service.constructor.name : service, ":")], restProcessed, false));
}
// TODO: redirect this to spdlog
function logTrace(service) {
    var rest = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        rest[_i - 1] = arguments[_i];
    }
    var restProcessed = rest.map(function (item) {
        if (item instanceof Error) {
            return item.stack || item.message;
        }
        return item;
    });
    _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__.printConsole.apply(void 0, __spreadArray(["Trace in ".concat(typeof service !== "string" ? service.constructor.name : service, ":")], restProcessed, false));
}


/***/ }),

/***/ "./src/messages.ts":
/*!*************************!*\
  !*** ./src/messages.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   MsgType: () => (/* binding */ MsgType)
/* harmony export */ });
var MsgType;
(function (MsgType) {
    MsgType[MsgType["CustomPacket"] = 1] = "CustomPacket";
    MsgType[MsgType["UpdateMovement"] = 2] = "UpdateMovement";
    MsgType[MsgType["UpdateAnimation"] = 3] = "UpdateAnimation";
    MsgType[MsgType["UpdateAppearance"] = 4] = "UpdateAppearance";
    MsgType[MsgType["UpdateEquipment"] = 5] = "UpdateEquipment";
    MsgType[MsgType["Activate"] = 6] = "Activate";
    MsgType[MsgType["UpdateProperty"] = 7] = "UpdateProperty";
    MsgType[MsgType["PutItem"] = 8] = "PutItem";
    MsgType[MsgType["TakeItem"] = 9] = "TakeItem";
    MsgType[MsgType["FinishSpSnippet"] = 10] = "FinishSpSnippet";
    MsgType[MsgType["OnEquip"] = 11] = "OnEquip";
    MsgType[MsgType["ConsoleCommand"] = 12] = "ConsoleCommand";
    MsgType[MsgType["CraftItem"] = 13] = "CraftItem";
    MsgType[MsgType["Host"] = 14] = "Host";
    MsgType[MsgType["CustomEvent"] = 15] = "CustomEvent";
    MsgType[MsgType["ChangeValues"] = 16] = "ChangeValues";
    MsgType[MsgType["OnHit"] = 17] = "OnHit";
    MsgType[MsgType["DeathStateContainer"] = 18] = "DeathStateContainer";
    MsgType[MsgType["DropItem"] = 19] = "DropItem";
    MsgType[MsgType["Teleport"] = 20] = "Teleport";
    MsgType[MsgType["OpenContainer"] = 21] = "OpenContainer";
    MsgType[MsgType["PlayerBowShot"] = 22] = "PlayerBowShot";
    MsgType[MsgType["SpellCast"] = 23] = "SpellCast";
    MsgType[MsgType["UpdateAnimVariables"] = 24] = "UpdateAnimVariables";
    // ex-strings
    MsgType[MsgType["DestroyActor"] = 25] = "DestroyActor";
    MsgType[MsgType["HostStart"] = 26] = "HostStart";
    MsgType[MsgType["HostStop"] = 27] = "HostStop";
    MsgType[MsgType["SetInventory"] = 28] = "SetInventory";
    MsgType[MsgType["SetRaceMenuOpen"] = 29] = "SetRaceMenuOpen";
    MsgType[MsgType["SpSnippet"] = 30] = "SpSnippet";
    MsgType[MsgType["Teleport2"] = 31] = "Teleport2";
    MsgType[MsgType["UpdateGamemodeData"] = 32] = "UpdateGamemodeData";
    MsgType[MsgType["CreateActor"] = 33] = "CreateActor";
    MsgType[MsgType["VoiceChatMessage"] = 34] = "VoiceChatMessage";
    MsgType[MsgType["UpdateVoiceChatMessage"] = 35] = "UpdateVoiceChatMessage";
})(MsgType || (MsgType = {}));


/***/ }),

/***/ "./src/services/events/events.ts":
/*!***************************************!*\
  !*** ./src/services/events/events.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EventEmitterFactory: () => (/* binding */ EventEmitterFactory)
/* harmony export */ });
/* harmony import */ var eventemitter3__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! eventemitter3 */ "./node_modules/eventemitter3/index.mjs");

var EventEmitterFactory = /** @class */ (function () {
    function EventEmitterFactory() {
    }
    EventEmitterFactory.makeEventEmitter = function () {
        return (new eventemitter3__WEBPACK_IMPORTED_MODULE_0__.EventEmitter());
    };
    return EventEmitterFactory;
}());



/***/ }),

/***/ "./src/services/services/activationService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/activationService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ActivationService: () => (/* binding */ ActivationService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _lastInvService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// TODO: refactor this out



var ActivationService = /** @class */ (function (_super) {
    __extends(ActivationService, _super);
    function ActivationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("activate", function (e) { return _this.onActivate(e); });
        return _this;
    }
    ActivationService.prototype.onActivate = function (e) {
        var lastInvService = this.controller.lookupListener(_lastInvService__WEBPACK_IMPORTED_MODULE_4__.LastInvService);
        lastInvService.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_2__.getInventory)(this.sp.Game.getPlayer());
        var caster = e.caster ? e.caster.getFormID() : 0;
        var target = e.target ? e.target.getFormID() : 0;
        if (!target || !caster) {
            return;
        }
        // Actors never have non-ff ids locally in skymp
        if (caster !== 0x14 && caster < 0xff000000) {
            return;
        }
        target = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__.localIdToRemoteId)(target);
        if (!target) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logError)(this, 'localIdToRemoteId returned 0 (target) in on(\'activate\')');
            return;
        }
        caster = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__.localIdToRemoteId)(caster);
        if (!caster) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logError)(this, 'localIdToRemoteId returned 0 (caster) in on(\'activate\')');
            return;
        }
        var openState = e.target.getOpenState();
        if (openState === 2 /* OpenState.Opening */ || openState === 4 /* OpenState.Closing */) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Ignoring activation of door because it's already opening or closing");
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.Activate,
                data: { caster: caster, target: target, isSecondActivation: false }
            },
            reliability: "reliable"
        });
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Sent activation for caster=", caster.toString(16), "and target=", target.toString(16));
    };
    return ActivationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/animDebugService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/animDebugService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnimDebugService: () => (/* binding */ AnimDebugService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__);
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};



var playerId = 0x14;
var AnimDebugService = /** @class */ (function (_super) {
    __extends(AnimDebugService, _super);
    function AnimDebugService(sp, controller) {
        var _this = this;
        var _a;
        _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.settings = _this.sp.settings["skymp5-client"]["animDebug"];
        // clear previous texts in case of hotreload
        if (_this.sp.storage[AnimQueueCollection.Name] && _this.sp.storage[AnimQueueCollection.Name].clearSPText) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Destroying old AnimQueueCollection");
            try {
                _this.sp.storage[AnimQueueCollection.Name].clearSPText();
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Failed to destroy old AnimQueueCollection:", e);
            }
        }
        var self = _this;
        _this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) { },
            leave: function (ctx) {
                self.onSendAnimationEventLeave(ctx);
            }
        }, playerId, playerId);
        if (!_this.settings || !_this.settings.isActive) {
            return _this;
        }
        if ((_a = _this.settings.textOutput) === null || _a === void 0 ? void 0 : _a.isActive) {
            _this.queue = new AnimQueueCollection(_this.sp, _this.settings);
            _this.sp.storage[AnimQueueCollection.name] = _this.queue;
        }
        return _this;
    }
    AnimDebugService.prototype.onSendAnimationEventLeave = function (ctx) {
        if (this.queue === undefined) {
            return;
        }
        this.queue.push(ctx.animEventName, ctx.animationSucceeded ? animationSucceededTextColor : animationNotSucceededTextColor);
    };
    return AnimDebugService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

var animationSucceededTextColor = [255, 255, 255, 1];
var animationNotSucceededTextColor = [255, 0, 0, 1];
var AnimQueueCollection = /** @class */ (function () {
    function AnimQueueCollection(sp, settings) {
        var _a, _b, _c, _d, _e, _f;
        this.sp = sp;
        var arrayLength = (_b = (_a = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _a === void 0 ? void 0 : _a.itemCount) !== null && _b !== void 0 ? _b : 5;
        var startPos = (_d = (_c = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _c === void 0 ? void 0 : _c.startPos) !== null && _d !== void 0 ? _d : { x: 650, y: 600 };
        ;
        var yPosDelta = (_f = (_e = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _e === void 0 ? void 0 : _e.yPosDelta) !== null && _f !== void 0 ? _f : 32;
        var y = startPos.y;
        this.list = new Array(arrayLength);
        for (var idx = 0; idx < arrayLength; ++idx) {
            this.list[idx] = { name: "", textId: sp.createText(startPos.x, y, "", animationSucceededTextColor), color: animationSucceededTextColor };
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__.setTextSize)(this.list[idx].textId, 0.5);
            y += yPosDelta;
        }
    }
    AnimQueueCollection.prototype.clearSPText = function () {
        var _this = this;
        if (this.list.length === 0) {
            return;
        }
        this.list.forEach(function (item) { return _this.sp.destroyText(item.textId); });
    };
    AnimQueueCollection.prototype.push = function (animName, color) {
        var prevItem = null;
        for (var idx = this.list.length - 1; idx >= 0; --idx) {
            var item = this.list[idx];
            prevItem = __assign({}, item);
            item.name = animName;
            item.color = color;
            this.sp.setTextString(item.textId, item.name);
            this.sp.setTextColor(item.textId, item.color);
            animName = prevItem.name;
            color = prevItem.color;
        }
    };
    AnimQueueCollection.Name = "AnimQueueCollection";
    return AnimQueueCollection;
}());


/***/ }),

/***/ "./src/services/services/authService.ts":
/*!**********************************************!*\
  !*** ./src/services/services/authService.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AuthService: () => (/* binding */ AuthService)
/* harmony export */ });
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! crypto */ "crypto");
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _timersService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _characterSelectService__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./characterSelectService */ "./src/services/services/characterSelectService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();









// Define as module-level variables instead of global declarations
var window = global.window || globalThis.window || {};
// Constants used on both client and browser side (see browsersideWidgetSetter)
var events = {
    openDiscordOauth: 'openDiscordOauth',
    authAttempt: 'authAttemptEvent',
    openGithub: 'openGithub',
    openPatreon: 'openPatreon',
    clearAuthData: 'clearAuthData',
    updateRequired: 'updateRequired',
    backToLogin: 'backToLogin',
    joinDiscord: 'joinDiscord',
    hideBrowser: 'hideBrowser',
};
// Vaiables used on both client and browser side (see browsersideWidgetSetter)
var browserState = {
    comment: '',
    failCount: 9000,
    loginFailedReason: '',
};
var authData = null;
var AuthService = /** @class */ (function (_super) {
    __extends(AuthService, _super);
    function AuthService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.deniedWidgetSetter = function () {
            var widget = {
                type: "form",
                id: 2,
                caption: "Update Available",
                elements: [
                    {
                        type: "text",
                        text: "hooray! update released",
                        tags: []
                    },
                    {
                        type: "text",
                        text: "download now at",
                        tags: []
                    },
                    {
                        type: "text",
                        text: "skymp.net",
                        tags: []
                    },
                    {
                        type: "button",
                        text: "open skymp.net",
                        tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                        click: function () { return window.skyrimPlatform.sendMessage(events.updateRequired); },
                        hint: "Go to download page",
                    }
                ]
            };
            window.skyrimPlatform.widgets.set([widget]);
            // Make sure gamemode will not be able to update widgets anymore
            window.skyrimPlatform.widgets = null;
        };
        _this.loginFailedWidgetSetter = function () {
            var splitParts = browserState.loginFailedReason.split('\n');
            var textElements = splitParts.map(function (part) { return ({
                type: "text",
                text: part,
                tags: [],
            }); });
            var widget = {
                type: "form",
                id: 2,
                caption: "Error",
                elements: new Array()
            };
            textElements.forEach(function (element) { return widget.elements.push(element); });
            if (browserState.loginFailedReason === 'please join the discord server') {
                widget.elements.push({
                    type: "button",
                    text: "Join Server",
                    tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.joinDiscord); },
                    hint: null
                });
            }
            widget.elements.push({
                type: "button",
                text: "Back",
                tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                click: function () { return window.skyrimPlatform.sendMessage(events.backToLogin); },
                hint: undefined
            });
            if (window.skyrimPlatform && window.skyrimPlatform.widgets) {
                window.skyrimPlatform.widgets.set([widget]);
            }
        };
        _this.loginWidgetSetter = function () {
            // Note: isConnecting is injected via getText() wrapper
            // @ts-ignore - isConnecting is provided by FunctionInfo.getText()
            var connecting = isConnecting;
            var authDataUsername = authData ? (authData.discordUsername
                ? authData.discordUsername
                : "id: ".concat(authData.masterApiId)) : "not authorized";
            var buttonText = authData ? "Change Account" : "Login via Discord";
            var elements = [
                {
                    type: "text",
                    text: authDataUsername,
                    tags: [],
                }
            ];
            // Only show buttons if not connecting
            if (!connecting) {
                elements.push({
                    type: "button",
                    text: buttonText,
                    tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.openDiscordOauth); },
                    hint: "You can login or change account",
                });
                elements.push({
                    type: "button",
                    text: "Connect",
                    tags: ["BUTTON_STYLE_FRAME", "ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.authAttempt); },
                    hint: "Connect to game server",
                });
            }
            // Always show status text
            elements.push({
                type: "text",
                text: browserState.comment,
                tags: [],
            });
            var loginWidget = {
                type: "form",
                id: 1,
                caption: "Authentication",
                elements: elements
            };
            window.skyrimPlatform.widgets.set([loginWidget]);
        };
        _this.browsersideWidgetSetter = function () {
            var loginWidget = {
                type: "form",
                id: 1,
                caption: "Authentication",
                elements: [
                    {
                        type: "text",
                        text: (authData ? (authData.discordUsername
                            ? "".concat(authData.discordUsername)
                            : "id: ".concat(authData.masterApiId)) : "not authorized"),
                        tags: [],
                    },
                    {
                        type: "button",
                        text: authData ? "Change Account" : "Login via Discord",
                        tags: [],
                        click: function () { return window.skyrimPlatform.sendMessage(events.openDiscordOauth); },
                        hint: "You can login or change account",
                    },
                    {
                        type: "button",
                        text: "Connect",
                        tags: ["BUTTON_STYLE_FRAME", "ELEMENT_STYLE_MARGIN_EXTENDED"],
                        click: function () { return window.skyrimPlatform.sendMessage(events.authAttempt); },
                        hint: "Connect to game server",
                    },
                    {
                        type: "text",
                        text: browserState.comment,
                        tags: [],
                    },
                ]
            };
            window.skyrimPlatform.widgets.set([loginWidget]);
        };
        _this._isListenBrowserMessage = false;
        _this.trigger = {
            authNeededFired: false,
            browserWindowLoadedFired: false,
            get conditionMet() {
                return this.authNeededFired && this.browserWindowLoadedFired;
            }
        };
        _this.discordAuthState = crypto__WEBPACK_IMPORTED_MODULE_0__.randomBytes(32).toString('hex');
        _this.authDialogOpen = false;
        _this.loggingStartMoment = 0;
        _this.authAttemptProgressIndicator = false;
        _this.authAttemptProgressIndicatorCounter = 0;
        _this.lastSlowCounter = -1;
        _this.playerEverSawActualGameplay = false;
        _this.githubUrl = "https://github.com/BStarRP/skymp";
        _this.patreonUrl = "https://www.patreon.com/c/bruinstar";
        _this.discordUrl = "https://discord.gg/bstarrp";
        _this.pluginAuthDataName = "auth-data-no-load";
        _this.controller.emitter.on("authNeeded", function (e) { return _this.onAuthNeeded(e); });
        _this.controller.emitter.on("browserWindowLoaded", function (e) { return _this.onBrowserWindowLoaded(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.emitter.on("connectionAccepted", function () { return _this.handleConnectionAccepted(); });
        _this.controller.emitter.on("connectionDenied", function (e) { return _this.handleConnectionDenied(e); });
        _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage(e); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    AuthService.prototype.onAuthNeeded = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received authNeeded event");
        this.setListenBrowserMessage(true, 'authNeeded received');
        // Try to read auth data from disk first
        authData = this.readAuthDataFromDisk();
        // If no auth file exists, check for offline mode settings
        if (!authData) {
            var settingsGameData = this.sp.settings["skymp5-client"]["gameData"];
            var hasOfflineSettings = Number.isInteger(settingsGameData === null || settingsGameData === void 0 ? void 0 : settingsGameData.profileId);
            if (hasOfflineSettings) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "No auth file found, using offline mode from settings with profileId:", settingsGameData.profileId);
                this.controller.emitter.emit("authAttempt", {
                    authGameData: {
                        local: {
                            profileId: settingsGameData.profileId,
                            accessToken: settingsGameData.accessToken
                        }
                    }
                });
                return;
            }
        }
        // Auth file exists or no offline settings - show login menu
        if (authData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth file found, showing login menu with existing auth data");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "No auth file and no offline settings, showing login menu");
        }
        this.setListenBrowserMessage(true, 'regular auth needed');
        // Show browser and load the UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        // Try to load the UI explicitly
        try {
            this.sp.browser.loadUrl("file:///Data/Platform/UI/index.html");
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Attempted to load UI from file:///Data/Platform/UI/index.html");
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Failed to load UI:", e);
        }
        // Set trigger flag and wait for browser to load
        this.trigger.authNeededFired = true;
        this.onBrowserWindowLoadedAndOnlineAuthNeeded();
    };
    AuthService.prototype.onBrowserWindowLoadedShowStartWindow = function (data) {
        var _a;
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        authData = data;
        (_a = this.sp.browser) === null || _a === void 0 ? void 0 : _a.executeJavaScript("window?.useMenuStore?.getState().onStart(".concat(JSON.stringify(data), ")"));
    };
    AuthService.prototype.onBrowserWindowLoaded = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received browserWindowLoaded event");
        this.trigger.browserWindowLoadedFired = true;
        this.onBrowserWindowLoadedAndOnlineAuthNeeded();
    };
    AuthService.prototype.onCreateActorMessage = function (e) {
        if (e.message.isMe) {
            if (this.authDialogOpen) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received createActorMessage for self, resetting widgets");
                this.sp.browser.executeJavaScript('window.skyrimPlatform.widgets.set([]);');
                this.authDialogOpen = false;
            }
            else {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received createActorMessage for self, but auth dialog was not open so not resetting widgets");
            }
        }
        this.loggingStartMoment = 0;
        this.authAttemptProgressIndicator = false;
    };
    AuthService.prototype.onCustomPacketMessage = function (event) {
        var msg = event.message;
        var msgContent = {};
        try {
            msgContent = JSON.parse(msg.contentJsonDump);
        }
        catch (e) {
            if (e instanceof SyntaxError) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "onCustomPacketMessage failed to parse JSON", e.message, "json:", msg.contentJsonDump);
                return;
            }
            else {
                throw e;
            }
        }
        switch (msgContent["customPacketType"]) {
            // case 'loginRequired':
            //   logTrace(this, 'loginRequired received');
            //   this.loginWithSkympIoCredentials();
            //   break;
            case 'loginFailedNotLoggedViaDiscord':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedNotLoggedViaDiscord received');
                browserState.loginFailedReason = 'please login via discord';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedNotLoggedViaDiscord received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedNotInTheDiscordServer':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedNotInTheDiscordServer received');
                browserState.loginFailedReason = 'please join the discord server';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedNotInTheDiscordServer received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedBanned':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedBanned received');
                browserState.loginFailedReason = 'you are banned';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedBanned received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedIpMismatch':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedIpMismatch received');
                browserState.loginFailedReason = 'what was that?';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedIpMismatch received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
        }
    };
    AuthService.prototype.onBrowserWindowLoadedAndOnlineAuthNeeded = function () {
        var _this = this;
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "isListenBrowserMessage was false for some reason, aborting auth");
            return;
        }
        if (!this.trigger.conditionMet) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserWindowLoadedAndOnlineAuthNeeded waiting for both triggers to load");
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Showing widgets and starting loop");
        // Make sure auth data is loaded
        if (!authData) {
            authData = this.readAuthDataFromDisk();
        }
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        // Delay initial state injection to ensure React is mounted
        var timersService = this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService);
        timersService.setTimeout(function () {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, 'Sending initial auth state to React UI');
            _this.refreshWidgets();
        }, 500);
        // Start Discord OAuth login state checking loop
        this.checkLoginState();
    };
    AuthService.prototype.onBrowserMessage = function (e) {
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserMessage: isListenBrowserMessage was false, ignoring message", JSON.stringify(e.arguments));
            return;
        }
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserMessage:", JSON.stringify(e.arguments));
        var eventKey = e.arguments[0];
        switch (eventKey) {
            case events.openDiscordOauth:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "openDiscordOauth event received, opening browser");
                browserState.comment = 'opening browser...';
                this.refreshWidgets();
                var settingsService_1 = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
                var discordAuthBaseUrl = this.sp.settings["skymp5-client"]["discord-auth-url"] || "http://localhost:".concat(this.getServerPort());
                var discordAuthUrl = "".concat(discordAuthBaseUrl, "/api/users/login-discord?state=").concat(this.discordAuthState);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Loading Discord OAuth URL:", discordAuthUrl);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "win32 object:", this.sp.win32);
                try {
                    this.sp.win32.loadUrl(discordAuthUrl);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "win32.loadUrl called successfully");
                }
                catch (error) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Failed to call win32.loadUrl:", error);
                }
                // Launch checkLoginState loop
                this.checkLoginState();
                break;
            case events.authAttempt:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "authAttempt event received (Connect button clicked)");
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Current authData:", authData);
                if (authData === null) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "authData is null, cannot connect");
                    browserState.comment = 'please login first';
                    this.refreshWidgets();
                    break;
                }
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Emitting authAttempt event with authData:", JSON.stringify(authData));
                // Emit authAttempt event to trigger connection
                this.controller.emitter.emit("authAttempt", { authGameData: { remote: authData } });
                this.authAttemptProgressIndicator = true;
                break;
            case events.clearAuthData:
                // Doesn't seem to be used - launcher manages auth data
                break;
            case events.openGithub:
                this.sp.win32.loadUrl(this.githubUrl);
                break;
            case events.openPatreon:
                this.sp.win32.loadUrl(this.patreonUrl);
                break;
            case events.updateRequired:
                this.sp.win32.loadUrl("https://skymp.net/UpdInstall");
                break;
            case events.backToLogin:
                // Check if user manually went back from character select
                var characterSelectService = this.controller.lookupListener(_characterSelectService__WEBPACK_IMPORTED_MODULE_8__.CharacterSelectService);
                if (characterSelectService && characterSelectService.resetAuthState) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'User manually went back from character select, resetting auth state');
                    // Reset flag
                    characterSelectService.resetAuthState = false;
                    // Clear progress indicator to prevent auto-connect
                    this.authAttemptProgressIndicator = false;
                    // Clear logging start moment
                    this.loggingStartMoment = 0;
                    // Clear any error messages
                    browserState.loginFailedReason = '';
                    browserState.comment = '';
                }
                // Reload auth data from disk so user sees their previous account info
                authData = this.readAuthDataFromDisk();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Reloaded auth data after Back button pressed:', authData ? 'found' : 'not found');
                // Refresh the React UI with updated auth state
                this.refreshWidgets();
                break;
            case events.joinDiscord:
                this.sp.win32.loadUrl(this.discordUrl);
                break;
            case events.hideBrowser:
                this.sp.browser.setVisible(false);
                this.sp.browser.setFocused(false);
                break;
            case 'requestAuthState':
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'React UI requesting auth state, sending current state');
                this.refreshWidgets();
                break;
            default:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Unknown event key", eventKey);
                break;
        }
    };
    AuthService.prototype.createPlaySession = function (token, callback) {
        var client = new this.sp.HttpClient("http://localhost:".concat(this.getServerPort()));
        var route = "/api/users/me/play/main";
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Creating play session ".concat(route));
        client.post(route, {
            body: '{}',
            contentType: 'application/json',
            headers: {
                'authorization': "Bearer ".concat(token),
            },
            // @ts-ignore
        }, function (res) {
            if (res.status != 200) {
                callback('', 'status code ' + res.status);
            }
            else {
                // TODO: handle JSON.parse failure?
                callback(JSON.parse(res.body).session, '');
            }
        });
    };
    AuthService.prototype.checkLoginState = function () {
        var _this = this;
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "checkLoginState: isListenBrowserMessage was false, aborting check");
            return;
        }
        var timersService = this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService);
        // Social engineering protection, don't show the full state
        var halfDiscordAuthState = this.discordAuthState.slice(0, 16);
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Checking login state", halfDiscordAuthState, '...');
        new this.sp.HttpClient("http://localhost:".concat(this.getServerPort()))
            .get("/api/users/login-discord/status?state=" + this.discordAuthState, undefined, 
        // @ts-ignore
        function (response) {
            switch (response.status) {
                case 200:
                    var _a = JSON.parse(response.body), token = _a.token, masterApiId_1 = _a.masterApiId, discordUsername_1 = _a.discordUsername, discordDiscriminator_1 = _a.discordDiscriminator, discordAvatar_1 = _a.discordAvatar;
                    browserState.failCount = 0;
                    _this.createPlaySession(token, function (playSession, error) {
                        if (error) {
                            browserState.failCount = 0;
                            browserState.comment = (error);
                            timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
                            _this.refreshWidgets();
                            return;
                        }
                        authData = {
                            session: playSession,
                            masterApiId: masterApiId_1,
                            discordUsername: discordUsername_1,
                            discordDiscriminator: discordDiscriminator_1,
                            discordAvatar: discordAvatar_1,
                        };
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Discord auth successful, authData set:", JSON.stringify(authData));
                        browserState.comment = 'connected successfully';
                        _this.refreshWidgets();
                    });
                    break;
                case 401: // Unauthorized
                    browserState.failCount = 0;
                    browserState.comment = ''; //(`Still waiting...`);
                    timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
                    break;
                case 403: // Forbidden
                case 404: // Not found
                    browserState.failCount = 9000;
                    browserState.comment = ("Fail: ".concat(response.body));
                    break;
                default:
                    ++browserState.failCount;
                    browserState.comment = "Server returned ".concat(response.status.toString() || "???", " \"").concat(response.body || response.error, "\"");
                    timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
            }
        });
    };
    ;
    AuthService.prototype.refreshWidgets = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'refreshAuthUI called');
        // Inject auth state into window for React UI
        var authState = {
            authData: authData,
            comment: browserState.comment,
            loginFailedReason: browserState.loginFailedReason,
            isConnecting: this.authAttemptProgressIndicator
        };
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.auth = ".concat(JSON.stringify(authState), ";\n      window.dispatchEvent(new CustomEvent('skymp:authUpdate', { detail: ").concat(JSON.stringify(authState), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
        this.authDialogOpen = true;
    };
    ;
    AuthService.prototype.readAuthDataFromDisk = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Reading", this.pluginAuthDataName, "from disk");
        try {
            // @ts-expect-error (TODO: Remove in 2.10.0)
            var data = this.sp.getPluginSourceCode(this.pluginAuthDataName, "PluginsNoLoad");
            if (!data) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Read empty", this.pluginAuthDataName, "returning null");
                return null;
            }
            return JSON.parse(data.slice(2)) || null;
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Error reading", this.pluginAuthDataName, "from disk:", e, ", falling back to null");
            return null;
        }
    };
    AuthService.prototype.writeAuthDataToDisk = function (data) {
        // Auth data writing is handled by the launcher, client only reads
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth data writing disabled - launcher manages auth data");
    };
    ;
    AuthService.prototype.handleConnectionDenied = function (e) {
        var _this = this;
        this.authAttemptProgressIndicator = false;
        if (e.error.toLowerCase().includes("invalid password")) {
            this.controller.once("tick", function () {
                _this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
            });
            browserState.loginFailedReason = 'invalid password';
            this.refreshWidgets();
            this.sp.browser.setVisible(true);
            this.sp.browser.setFocused(true);
            this.controller.once("update", function () {
                _this.sp.Game.disablePlayerControls(true, true, true, true, true, true, true, true, 0);
            });
            this.setListenBrowserMessage(true, 'connectionDenied event received');
        }
    };
    AuthService.prototype.handleConnectionAccepted = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "handleConnectionAccepted called");
        // Keep browser message listener active so user can still interact with auth menu
        // this.setListenBrowserMessage(false, 'connectionAccepted event received');
        this.loggingStartMoment = Date.now();
        var authData = this.sp.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_1__.authGameDataStorageKey];
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth data from storage:", JSON.stringify(authData));
        if (authData === null || authData === void 0 ? void 0 : authData.local) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Logging in offline mode, profileId =", authData.local.profileId);
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_6__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: 'loginWithSkympIo',
                    gameData: {
                        profileId: authData.local.profileId,
                    },
                }),
            };
            this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable"
            });
            return;
        }
        if (authData === null || authData === void 0 ? void 0 : authData.remote) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Logging in as a master API user');
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_6__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: 'loginWithSkympIo',
                    gameData: {
                        session: authData.remote.session,
                        masterApiId: authData.remote.masterApiId,
                        discordUsername: authData.remote.discordUsername,
                        discordDiscriminator: authData.remote.discordDiscriminator,
                        discordAvatar: authData.remote.discordAvatar,
                    },
                }),
            };
            this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable"
            });
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, 'Not found authentication method');
    };
    ;
    AuthService.prototype.onTick = function () {
        // TODO: Should be no hardcoded/magic-number limit
        // TODO: Busy waiting is bad. Should be replaced with some kind of event
        var maxLoggingDelay = 15000;
        if (this.loggingStartMoment && Date.now() - this.loggingStartMoment > maxLoggingDelay) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Max logging delay reached received');
            if (this.playerEverSawActualGameplay) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Player saw actual gameplay, reconnecting');
                this.loggingStartMoment = 0;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).reconnect();
                // TODO: should we prompt user to relogin?
            }
            else {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Player never saw actual gameplay, showing login dialog');
                this.loggingStartMoment = 0;
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                browserState.comment = "";
                browserState.loginFailedReason = 'technical difficulties\nplease try again\nor contact us on discord';
                this.refreshWidgets();
                authData = null;
                // Note: Auth data cleanup handled by launcher
            }
        }
        if (this.authAttemptProgressIndicator) {
            this.authAttemptProgressIndicatorCounter++;
            if (this.authAttemptProgressIndicatorCounter === 1000000) {
                this.authAttemptProgressIndicatorCounter = 0;
            }
            var slowCounter = Math.floor(this.authAttemptProgressIndicatorCounter / 15);
            var newSlowCounter = Math.floor(slowCounter / 1); // Only changes every ~15 ticks
            // Only refresh widgets when the dot pattern changes
            if (newSlowCounter !== this.lastSlowCounter) {
                this.lastSlowCounter = newSlowCounter;
                var dot = slowCounter % 3 === 0 ? '.' : slowCounter % 3 === 1 ? '..' : '...';
                browserState.comment = "connecting" + dot;
                this.refreshWidgets();
            }
        }
    };
    AuthService.prototype.onceUpdate = function () {
        this.playerEverSawActualGameplay = true;
    };
    AuthService.prototype.isListenBrowserMessage = function () {
        return this._isListenBrowserMessage;
    };
    AuthService.prototype.setListenBrowserMessage = function (value, reason) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "setListenBrowserMessage:", value, "reason:", reason);
        this._isListenBrowserMessage = value;
    };
    AuthService.prototype.getServerPort = function () {
        // Use the same port that the UI server uses (typically 3000 for dev, port+1 for custom ports)
        // This matches the pattern in ui.ts
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
        var serverPort = settingsService.getServerPort();
        return serverPort === 7777 ? 3000 : serverPort + 1;
    };
    return AuthService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/blockPapyrusEventsService.ts":
/*!************************************************************!*\
  !*** ./src/services/services/blockPapyrusEventsService.ts ***!
  \************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BlockPapyrusEventsService: () => (/* binding */ BlockPapyrusEventsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var BlockPapyrusEventsService = /** @class */ (function (_super) {
    __extends(BlockPapyrusEventsService, _super);
    function BlockPapyrusEventsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("tick", function () { return _this.onceTick(); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    BlockPapyrusEventsService.prototype.onceTick = function () {
        // @ts-ignore
        this.sp.blockPapyrusEvents(true);
    };
    BlockPapyrusEventsService.prototype.onceUpdate = function () {
        this.sp.TESModPlatform.blockPapyrusEvents(true);
    };
    return BlockPapyrusEventsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/blockedAnimationsService.ts":
/*!***********************************************************!*\
  !*** ./src/services/services/blockedAnimationsService.ts ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BlockedAnimationsService: () => (/* binding */ BlockedAnimationsService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var BlockedAnimationsService = /** @class */ (function (_super) {
    __extends(BlockedAnimationsService, _super);
    function BlockedAnimationsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var blockedAnims = [];
        var self = _this;
        blockedAnims.forEach(function (blockedAnim) {
            _this.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(self, "blocking animation event", ctx.animEventName);
                    ctx.animEventName = "";
                },
                leave: function () { }
            }, 0x14, 0x14, blockedAnim);
        });
        return _this;
    }
    return BlockedAnimationsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/browserService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/browserService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BrowserService: () => (/* binding */ BrowserService)
/* harmony export */ });
/* harmony import */ var _view_formView__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/formView */ "./src/view/formView.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: send event instead of direct dependency on FormView class



var unfocusEventString = "window.dispatchEvent(new CustomEvent('skymp5-client:browserUnfocused', {}))";
var focusEventString = "window.dispatchEvent(new CustomEvent('skymp5-client:browserFocused', {}))";
var BrowserService = /** @class */ (function (_super) {
    __extends(BrowserService, _super);
    function BrowserService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.badMenusOpen = new Set();
        _this.badMenus = [
            "BarterMenu" /* Menu.Barter */,
            "Book Menu" /* Menu.Book */,
            "ContainerMenu" /* Menu.Container */,
            "Crafting Menu" /* Menu.Crafting */,
            "GiftMenu" /* Menu.Gift */,
            "InventoryMenu" /* Menu.Inventory */,
            "Journal Menu" /* Menu.Journal */,
            "Lockpicking Menu" /* Menu.Lockpicking */,
            "Loading Menu" /* Menu.Loading */,
            "MapMenu" /* Menu.Map */,
            "RaceSex Menu" /* Menu.RaceSex */,
            "StatsMenu" /* Menu.Stats */,
            "TweenMenu" /* Menu.Tween */,
            //Menu.Console,
            //Menu.Main,
        ];
        _this.sp.browser.setVisible(false);
        _this.controller.emitter.on("queryKeyCodeBindings", function (e) { return _this.onQueryKeyCodeBindings(e); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.on("menuOpen", function (e) { return _this.onMenuOpen(e); });
        _this.controller.on("menuClose", function (e) { return _this.onMenuClose(e); });
        return _this;
    }
    // TODO: keycodes should be configurable
    BrowserService.prototype.onQueryKeyCodeBindings = function (e) {
        if (e.isDown([59 /* DxScanCode.F1 */])) {
            _view_formView__WEBPACK_IMPORTED_MODULE_0__.FormView.isDisplayingNicknames = !_view_formView__WEBPACK_IMPORTED_MODULE_0__.FormView.isDisplayingNicknames;
        }
        if (e.isDown([60 /* DxScanCode.F2 */])) {
            this.sp.browser.setVisible(!this.sp.browser.isVisible());
        }
        if (this.badMenusOpen.size === 0 && e.isDown([64 /* DxScanCode.F6 */])) {
            var newState = !this.sp.browser.isFocused();
            this.sp.browser.setFocused(newState);
            if (newState) {
                this.sp.browser.executeJavaScript(focusEventString);
            }
            else {
                this.sp.browser.executeJavaScript(unfocusEventString);
            }
        }
        if (this.badMenusOpen.size === 0 && e.isDown([28 /* DxScanCode.Enter */])) {
            this.sp.browser.setFocused(true);
            this.sp.browser.executeJavaScript(focusEventString);
        }
        if (e.isDown([1 /* DxScanCode.Escape */])) {
            if (this.sp.browser.isFocused()) {
                this.sp.browser.setFocused(false);
                this.sp.browser.executeJavaScript(unfocusEventString);
            }
        }
    };
    BrowserService.prototype.onceUpdate = function () {
        this.sp.browser.setVisible(true);
    };
    BrowserService.prototype.onBrowserMessage = function (e) {
        var onFrontLoadedEventKey = "front-loaded";
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received browser message:", JSON.stringify(e.arguments));
        if (e.arguments[0] === onFrontLoadedEventKey) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received front-loaded message, emitting browserWindowLoaded event");
            this.controller.emitter.emit("browserWindowLoaded", {});
        }
    };
    BrowserService.prototype.onMenuOpen = function (e) {
        if (this.isBadMenu(e.name)) {
            this.sp.browser.setVisible(false);
            this.badMenusOpen.add(e.name);
        }
        else if (e.name === "HUD Menu" /* Menu.HUD */) {
            this.sp.browser.setVisible(true);
        }
    };
    BrowserService.prototype.onMenuClose = function (e) {
        if (this.badMenusOpen.delete(e.name)) {
            if (this.badMenusOpen.size === 0) {
                this.sp.browser.setVisible(true);
            }
        }
        if (e.name === "HUD Menu" /* Menu.HUD */) {
            this.sp.browser.setVisible(false);
        }
    };
    BrowserService.prototype.isBadMenu = function (menu) {
        return this.badMenus.includes(menu);
    };
    return BrowserService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/characterSelectService.ts":
/*!*********************************************************!*\
  !*** ./src/services/services/characterSelectService.ts ***!
  \*********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CharacterSelectService: () => (/* binding */ CharacterSelectService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




// Events used on both client and browser side
var events = {
    selectCharacter: 'characterSelect_select',
    createCharacter: 'characterSelect_create',
    deleteCharacter: 'characterSelect_delete',
    backToLogin: 'characterSelect_back',
};
var CharacterSelectService = /** @class */ (function (_super) {
    __extends(CharacterSelectService, _super);
    function CharacterSelectService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.characterSelectActive = false;
        _this.resetAuthState = false;
        _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage(e); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        // Listen for loginSuccess event from AuthService
        _this.controller.emitter.on("loginSuccess", function (e) { return _this.onLoginSuccess(e); });
        return _this;
    }
    CharacterSelectService.prototype.onLoginSuccess = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Received loginSuccess event, user authenticated");
        // The server will send character list automatically after login
        // No need to request it here
    };
    CharacterSelectService.prototype.onCustomPacketMessage = function (event) {
        try {
            var content = JSON.parse(event.message.contentJsonDump);
            switch (content.customPacketType) {
                case "characterList":
                    this.handleCharacterList(content);
                    break;
                case "characterError":
                    this.handleCharacterError(content.message || "Unknown error occurred");
                    break;
            }
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)(this, "Error parsing custom packet: ".concat(e));
        }
    };
    CharacterSelectService.prototype.handleCharacterList = function (data) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Received character list: ".concat(data.characters.length, " characters, ").concat(data.maxSlots, " max slots"));
        this.characterSelectActive = true;
        // Inject data into window for custom UI access (following skyrim-roleplay pattern)
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.characterSelect = ".concat(JSON.stringify(data), ";\n      window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: ").concat(JSON.stringify(data), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
        // Show browser for character selection UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
    };
    CharacterSelectService.prototype.handleCharacterError = function (message) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)(this, "Character error: ".concat(message));
        // Inject error into window for custom UI access
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.characterSelectError = ".concat(JSON.stringify(message), ";\n      window.dispatchEvent(new CustomEvent('skymp:characterError', { detail: ").concat(JSON.stringify({ message: message }), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
    };
    CharacterSelectService.prototype.onCreateActorMessage = function (e) {
        // Hide character select screen when player spawns in world
        if (this.characterSelectActive) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Player spawned, hiding character select screen");
            var clearScript = "\n        if (window.skymp) {\n          window.skymp.characterSelect = null;\n          window.skymp.characterSelectError = null;\n        }\n        window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: null }));\n      ";
            this.sp.browser.executeJavaScript(clearScript);
            this.characterSelectActive = false;
        }
    };
    CharacterSelectService.prototype.onBrowserMessage = function (e) {
        var eventKey = e.arguments[0];
        var eventData = e.arguments[1];
        switch (eventKey) {
            case events.selectCharacter:
                this.sendSelectCharacter(eventData);
                break;
            case events.createCharacter:
                this.sendCreateCharacter();
                break;
            case events.deleteCharacter:
                this.sendDeleteCharacter(eventData);
                break;
            case events.backToLogin:
                this.handleBackToLogin();
                break;
        }
    };
    CharacterSelectService.prototype.sendSelectCharacter = function (visibleId) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Selecting character visibleId=".concat(visibleId));
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'selectCharacter',
                visibleId: visibleId,
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.sendCreateCharacter = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Creating new character");
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'createCharacter',
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.sendDeleteCharacter = function (visibleId) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Deleting character visibleId=".concat(visibleId));
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'deleteCharacter',
                visibleId: visibleId,
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.handleBackToLogin = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Back to login - returning to fresh auth screen");
        // Set flag to prevent auto-reconnect in authService
        this.resetAuthState = true;
        // Clear character select data
        var clearScript = "\n      if (window.skymp) {\n        window.skymp.characterSelect = null;\n        window.skymp.characterSelectError = null;\n      }\n      window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: null }));\n    ";
        this.sp.browser.executeJavaScript(clearScript);
        this.characterSelectActive = false;
        // Close connection and ensure browser stays visible for auth screen
        this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_3__.NetworkingService).close();
        // Keep browser visible for auth UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
    };
    return CharacterSelectService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/clientListener.ts":
/*!*************************************************!*\
  !*** ./src/services/services/clientListener.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ClientListener: () => (/* binding */ ClientListener)
/* harmony export */ });
;
var ClientListener = /** @class */ (function () {
    function ClientListener() {
        // Don't let TypeScript treat this class as empty
        this._nonEmptyClassMark = '';
    }
    return ClientListener;
}());



/***/ }),

/***/ "./src/services/services/consoleCommandsService.ts":
/*!*********************************************************!*\
  !*** ./src/services/services/consoleCommandsService.ts ***!
  \*********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ConsoleCommandsService: () => (/* binding */ ConsoleCommandsService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: refactor this out


var CmdArgument;
(function (CmdArgument) {
    CmdArgument[CmdArgument["ObjectReference"] = 0] = "ObjectReference";
    CmdArgument[CmdArgument["BaseForm"] = 1] = "BaseForm";
    CmdArgument[CmdArgument["Int"] = 2] = "Int";
    CmdArgument[CmdArgument["String"] = 3] = "String";
})(CmdArgument || (CmdArgument = {}));
var ConsoleCommandsService = /** @class */ (function (_super) {
    __extends(ConsoleCommandsService, _super);
    function ConsoleCommandsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.immuneSchema = ["mp"];
        _this.nonVanilaCommands = ["mp"];
        _this.schemas = ConsoleCommandsService.createSchemas();
        _this.setupMpCommand();
        _this.setupVanilaCommands();
        return _this;
    }
    ConsoleCommandsService.createSchemas = function () {
        var schemas = new Map();
        schemas.set("additem", [CmdArgument.ObjectReference, CmdArgument.BaseForm, CmdArgument.Int]);
        schemas.set("equipitem", [CmdArgument.ObjectReference, CmdArgument.BaseForm]);
        schemas.set("placeatme", [CmdArgument.ObjectReference, CmdArgument.BaseForm]);
        schemas.set("disable", [CmdArgument.ObjectReference]);
        schemas.set("mp", [CmdArgument.ObjectReference, CmdArgument.String]);
        return schemas;
    };
    ConsoleCommandsService.prototype.setupMpCommand = function () {
        var command = this.sp.findConsoleCommand(" ConfigureUM") || this.sp.findConsoleCommand("test");
        if (command === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "command was null in setupMpCommand");
            return;
        }
        command.shortName = "mp";
        command.execute = this.getCommandExecutor("mp");
    };
    ConsoleCommandsService.prototype.setupVanilaCommands = function () {
        var _this = this;
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "Setting up vanila commands");
        this.schemas.forEach(function (_, commandName) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Setting up command", commandName);
            var command = _this.sp.findConsoleCommand(commandName);
            if (command === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "command", commandName, "was null in setupVanilaCommands");
                return;
            }
            if (_this.nonVanilaCommands.includes(commandName)) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "command", commandName, " is non-vanila command");
                return;
            }
            command.execute = _this.getCommandExecutor(commandName);
        });
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "Vanila commands set up");
    };
    ConsoleCommandsService.prototype.getCommandExecutor = function (commandName) {
        var _this = this;
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            // TODO: handle possible exceptions in this function
            var schema = _this.schemas.get(commandName);
            if (schema === undefined) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Schema not found for command", commandName);
                return false;
            }
            if (args.length !== schema.length && !_this.immuneSchema.includes(commandName)) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Mismatch found in the schema of", commandName, "command");
                return false;
            }
            for (var i = 0; i < args.length; ++i) {
                switch (schema[i]) {
                    case CmdArgument.ObjectReference:
                        args[i] = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(parseInt("".concat(args[i])));
                        break;
                }
            }
            for (var i = 0; i < args.length; ++i) {
                if (typeof args[i] !== "string" && typeof args[i] !== "number") {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Bad argument type in command", commandName, "argument index", i);
                    return false;
                }
            }
            _this.controller.emitter.emit("sendMessage", {
                message: {
                    t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.ConsoleCommand,
                    data: {
                        commandName: commandName,
                        args: args
                    }
                },
                reliability: "reliable"
            });
            // Meant to be shown to user, not for logging
            _this.sp.printConsole("sent");
            return false;
        };
    };
    return ConsoleCommandsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_3__.ClientListener));



/***/ }),

/***/ "./src/services/services/containersService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/containersService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ContainersService: () => (/* binding */ ContainersService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _lastInvService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};








var ContainersService = /** @class */ (function (_super) {
    __extends(ContainersService, _super);
    function ContainersService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    ContainersService.prototype.onContainerChanged = function (e) {
        var _this = this;
        var sweetCantDropService = this.controller.lookupListener(_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_6__.SweetTaffySweetCantDropService);
        if (e.oldContainer && e.newContainer) {
            if (e.oldContainer.getFormID() === 0x14 ||
                e.newContainer.getFormID() === 0x14) {
                var lastInvService_1 = this.controller.lookupListener(_lastInvService__WEBPACK_IMPORTED_MODULE_5__.LastInvService);
                if (!lastInvService_1.lastInv) {
                    lastInvService_1.lastInv = (0,_remoteServer__WEBPACK_IMPORTED_MODULE_3__.getPcInventory)();
                }
                if (lastInvService_1.lastInv) {
                    var newInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.getInventory)(this.sp.Game.getPlayer());
                    // It seems that 'ignoreWorn = false' fixes this:
                    // https://github.com/skyrim-multiplayer/issue-tracker/issues/43
                    // For some reason excess diff is produced when 'ignoreWorn = true'
                    // I thought that it would be vice versa but that's how it works
                    var ignoreWorn = false;
                    var diff = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.getDiff)(lastInvService_1.lastInv, newInv, ignoreWorn);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('diff:');
                    for (var i = 0; i < diff.entries.length; ++i) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("[".concat(i, "] ").concat(JSON.stringify(diff.entries[i])));
                    }
                    var msgs = diff.entries
                        .filter(function (entry) {
                        // TODO: review this condition, seems to be incorrect
                        return entry.count > 0
                            ? sweetCantDropService.canDropOrPutItem(entry.baseId)
                            : true;
                    })
                        .filter(function (entry) { return entry.count !== 0; })
                        .map(function (entry) {
                        var _a;
                        var entryCopy = JSON.parse(JSON.stringify(entry));
                        var msg = __assign(__assign({}, entryCopy), { t: entry.count > 0 ? _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PutItem : _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.TakeItem, target: e.oldContainer.getFormID() === 0x14
                                ? (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__.localIdToRemoteId)(e.newContainer.getFormID())
                                : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__.localIdToRemoteId)(e.oldContainer.getFormID()) });
                        msg.count = Math.abs(msg.count);
                        if (((_a = _this.sp.Game.getFormEx(entry.baseId)) === null || _a === void 0 ? void 0 : _a.getName()) === msg.name) {
                            delete msg.name;
                        }
                        return msg;
                    });
                    msgs.forEach(function (msg) { return _this.controller.emitter.emit("sendMessage", {
                        message: msg,
                        reliability: "reliable"
                    }); });
                    // Prevent emitting 1,2,3,4,5 changes when taking/putting 5 potions one by one
                    // This code makes it 1,1,1,1,1 but works only for extra-less items
                    // At the moment of writing this I think it's not needed for items with extras
                    diff.entries.forEach(function (entry) {
                        if (lastInvService_1.lastInv && !(0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.hasExtras)(entry)) {
                            var put = entry.count > 0;
                            var take = entry.count < 0;
                            if (put) {
                                lastInvService_1.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.removeSimpleItemsAsManyAsPossible)(lastInvService_1.lastInv, entry.baseId, entry.count);
                            }
                            else if (take) {
                                var add = { entries: [entry] };
                                add.entries[0].count *= -1;
                                lastInvService_1.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.sumInventories)(lastInvService_1.lastInv, add);
                            }
                        }
                    });
                }
            }
        }
    };
    return ContainersService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/craftService.ts":
/*!***********************************************!*\
  !*** ./src/services/services/craftService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CraftService: () => (/* binding */ CraftService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out




var CraftService = /** @class */ (function (_super) {
    __extends(CraftService, _super);
    function CraftService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.furnitureStreak = new Map();
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    CraftService.prototype.onContainerChanged = function (e) {
        var oldContainerId = e.oldContainer ? e.oldContainer.getFormID() : 0;
        var newContainerId = e.newContainer ? e.newContainer.getFormID() : 0;
        var baseObjId = e.baseObj ? e.baseObj.getFormID() : 0;
        if (oldContainerId !== 0x14 && newContainerId !== 0x14) {
            return;
        }
        var furnitureRef = this.sp.Game.getPlayer().getFurnitureReference();
        if (!furnitureRef) {
            return;
        }
        var furnitureId = furnitureRef.getFormID();
        if (oldContainerId === 0x14 && newContainerId === 0) {
            var craftInputObjects = this.furnitureStreak.get(furnitureId);
            if (!craftInputObjects) {
                craftInputObjects = { entries: [] };
            }
            craftInputObjects.entries.push({
                baseId: baseObjId,
                count: e.numItems,
            });
            this.furnitureStreak.set(furnitureId, craftInputObjects);
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Adding baseObjId", baseObjId.toString(16), "numItems", e.numItems, "to craft");
        }
        else if (oldContainerId === 0 && newContainerId === 0x14) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Finishing craft');
            var craftInputObjects = this.furnitureStreak.get(furnitureId);
            if (craftInputObjects && craftInputObjects.entries.length) {
                this.furnitureStreak.delete(furnitureId);
                var workbench = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(furnitureId);
                if (!workbench) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "localIdToRemoteId returned 0 for furnitureId", furnitureId);
                    return;
                }
                var resultObjectId = baseObjId;
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Sending craft workbench", workbench, "resultObjectId", resultObjectId, "craftInputObjects", JSON.stringify(craftInputObjects.entries));
                this.controller.emitter.emit("sendMessage", {
                    message: {
                        t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CraftItem,
                        data: { workbench: workbench, craftInputObjects: craftInputObjects, resultObjectId: resultObjectId },
                    },
                    reliability: "reliable"
                });
            }
        }
    };
    return CraftService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/deathService.ts":
/*!***********************************************!*\
  !*** ./src/services/services/deathService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DeathService: () => (/* binding */ DeathService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _ragdollService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./ragdollService */ "./src/services/services/ragdollService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var DeathService = /** @class */ (function (_super) {
    __extends(DeathService, _super);
    function DeathService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.applyDeathState = function (actor, isDead) {
            if (actor.isDead() === isDead && _this.isPlayer(actor) === false) {
                return;
            }
            if (isDead === true) {
                _this.killActor(actor, null);
            }
            else {
                _this.resurrectActor(actor);
            }
        };
        _this.killActor = function (actor, killer) {
            if (killer === void 0) { killer = null; }
            if (_this.isPlayer(actor) === true) {
                _this.playerDead = true;
                _this.busyForOtherReasonsCounter++;
                _this.sp.Utility.wait(7.5).then(function () { return _this.busyForOtherReasonsCounter--; });
                _this.allowedPlayerAnimations = [];
                actor.setDontMove(true);
                _this.killWithPush(actor);
            }
            else {
                actor.endDeferredKill();
                actor.kill(killer);
            }
        };
        _this.resurrectActor = function (actor) {
            if (_this.isPlayer(actor) === true) {
                _this.playerDead = false;
                _this.busyForOtherReasonsCounter++;
                _this.sp.Utility.wait(7.5).then(function () { return _this.busyForOtherReasonsCounter--; });
                _this.allowedPlayerAnimations = null;
                actor.setDontMove(false);
                _this.ressurectWithPushKill(actor);
            }
            else {
                throw new _lib_errors__WEBPACK_IMPORTED_MODULE_2__.RespawnNeededError("needs to be respawned");
            }
        };
        _this.killWithPush = function (actor) {
            var _a;
            (_a = _this.allowedPlayerAnimations) === null || _a === void 0 ? void 0 : _a.push(_sync_animation__WEBPACK_IMPORTED_MODULE_3__.AnimationEventName.Ragdoll);
            actor.pushActorAway(actor, 0);
        };
        _this.ressurectWithPushKill = function (act) {
            var formId = act.getFormID();
            var ragdollService = _this.controller.lookupListener(_ragdollService__WEBPACK_IMPORTED_MODULE_4__.RagdollService);
            ragdollService.safeRemoveRagdollFromWorld(act, function () {
                var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(_this.sp.Game.getFormEx(formId));
                if (!actor) {
                    return;
                }
                // TODO: should use actor variable instead of getPlayer?
                // TODO: use different iGetUpType if ressurecting under water
                _this.sp.Game.getPlayer().setAnimationVariableInt("iGetUpType", 1);
                _this.sp.Debug.sendAnimationEvent(actor, _sync_animation__WEBPACK_IMPORTED_MODULE_3__.AnimationEventName.GetUpBegin);
            });
        };
        _this.isPlayer = function (actor) {
            return actor.getFormID() === _this.playerActorId;
        };
        // Null to allow all animations. Empty array to disallow all
        _this.allowedPlayerAnimations = null;
        _this.playerActorId = 0x14;
        _this.playerDead = false;
        _this.busyForOtherReasonsCounter = 0;
        controller.once("update", function () { return _this.onceUpdate(); });
        controller.emitter.on("applyDeathStateEvent", function (e) { return _this.onApplyDeathState(e); });
        _this.hookDisableKillMoves();
        _this.hookDisableStagger();
        _this.hookDisableBlockedAnims();
        return _this;
    }
    DeathService.prototype.isBusy = function () {
        return this.playerDead || this.busyForOtherReasonsCounter > 0;
    };
    DeathService.prototype.onceUpdate = function () {
        var player = this.sp.Game.getPlayer();
        player === null || player === void 0 ? void 0 : player.startDeferredKill();
    };
    DeathService.prototype.onApplyDeathState = function (e) {
        this.applyDeathState(e.actor, e.isDead);
    };
    DeathService.prototype.hookDisableKillMoves = function () {
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                ctx.animEventName = "";
            },
            leave: function () { },
        }, 0xff000000, 0xffffffff, "KillMove*");
    };
    DeathService.prototype.hookDisableStagger = function () {
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                ctx.animEventName = "";
            },
            leave: function () { },
        }, 0xff000000, 0xffffffff, "staggerStart");
    };
    DeathService.prototype.hookDisableBlockedAnims = function () {
        var _this = this;
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                if (_this.allowedPlayerAnimations === null) {
                    return;
                }
                if (!_this.allowedPlayerAnimations.includes(ctx.animEventName)) {
                    ctx.animEventName = "";
                }
            },
            leave: function () { },
        }, this.playerActorId, this.playerActorId);
    };
    return DeathService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableDifficultySelectionService.ts":
/*!********************************************************************!*\
  !*** ./src/services/services/disableDifficultySelectionService.ts ***!
  \********************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableDifficultySelectionService: () => (/* binding */ DisableDifficultySelectionService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var DisableDifficultySelectionService = /** @class */ (function (_super) {
    __extends(DisableDifficultySelectionService, _super);
    function DisableDifficultySelectionService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.difficulty = 5;
        _this.counter = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    DisableDifficultySelectionService.prototype.onUpdate = function () {
        this.counter++;
        if (this.counter >= 60) {
            this.counter = 0;
            this.sp.Utility.setINIInt("iDifficulty:GamePlay", this.difficulty);
        }
    };
    return DisableDifficultySelectionService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableFastTravelService.ts":
/*!***********************************************************!*\
  !*** ./src/services/services/disableFastTravelService.ts ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableFastTravelService: () => (/* binding */ DisableFastTravelService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var DisableFastTravelService = /** @class */ (function (_super) {
    __extends(DisableFastTravelService, _super);
    function DisableFastTravelService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    DisableFastTravelService.prototype.onUpdate = function () {
        this.sp.Game.enableFastTravel(false);
    };
    return DisableFastTravelService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableSkillAdvanceService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/disableSkillAdvanceService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableSkillAdvanceService: () => (/* binding */ DisableSkillAdvanceService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var DisableSkillAdvanceService = /** @class */ (function (_super) {
    __extends(DisableSkillAdvanceService, _super);
    function DisableSkillAdvanceService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    DisableSkillAdvanceService.prototype.onceUpdate = function () {
        // turn off player level exp
        this.sp.Game.setGameSettingFloat("fXPPerSkillRank", 0);
        // turn off skill exp
        this.turnOffSkillLocalExp(18 /* ActorValue.Alteration */);
        this.turnOffSkillLocalExp(19 /* ActorValue.Conjuration */);
        this.turnOffSkillLocalExp(20 /* ActorValue.Destruction */);
        this.turnOffSkillLocalExp(21 /* ActorValue.Illusion */);
        this.turnOffSkillLocalExp(22 /* ActorValue.Restoration */);
        this.turnOffSkillLocalExp(23 /* ActorValue.Enchanting */);
        this.turnOffSkillLocalExp(6 /* ActorValue.OneHanded */);
        this.turnOffSkillLocalExp(7 /* ActorValue.TwoHanded */);
        this.turnOffSkillLocalExp(8 /* ActorValue.Archery */);
        this.turnOffSkillLocalExp(9 /* ActorValue.Block */);
        this.turnOffSkillLocalExp(10 /* ActorValue.Smithing */);
        this.turnOffSkillLocalExp(11 /* ActorValue.HeavyArmor */);
        this.turnOffSkillLocalExp(12 /* ActorValue.LightArmor */);
        this.turnOffSkillLocalExp(13 /* ActorValue.Pickpocket */);
        this.turnOffSkillLocalExp(14 /* ActorValue.Lockpicking */);
        this.turnOffSkillLocalExp(15 /* ActorValue.Sneak */);
        this.turnOffSkillLocalExp(16 /* ActorValue.Alchemy */);
        this.turnOffSkillLocalExp(17 /* ActorValue.Speech */);
    };
    DisableSkillAdvanceService.prototype.turnOffSkillLocalExp = function (av) {
        var avi = this.sp.ActorValueInfo.getActorValueInfoByID(av);
        if (avi === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Not found ActorValueInfo for actor value", av);
            return;
        }
        avi.setSkillUseMult(0);
        avi.setSkillOffsetMult(0);
    };
    ;
    return DisableSkillAdvanceService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/dropItemService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/dropItemService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DropItemService: () => (/* binding */ DropItemService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _worldCleanerService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var DropItemService = /** @class */ (function (_super) {
    __extends(DropItemService, _super);
    function DropItemService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    DropItemService.prototype.onContainerChanged = function (e) {
        var _this = this;
        var _a;
        var sweetCantDropService = this.controller.lookupListener(_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_2__.SweetTaffySweetCantDropService);
        var pl = this.sp.Game.getPlayer();
        var isPlayer = pl && e.oldContainer && pl.getFormID() === e.oldContainer.getFormID();
        var noContainer = e.newContainer === null || e.newContainer === undefined;
        var isReference = e.reference !== null;
        if (e.newContainer && e.newContainer.getFormID() === pl.getFormID())
            return;
        if (!this.sp.Ui.isMenuOpen("InventoryMenu"))
            return;
        if (isPlayer &&
            isReference &&
            noContainer &&
            sweetCantDropService.canDropOrPutItem(e.baseObj.getFormID())) {
            var radius = 2000;
            var baseId = e.baseObj.getFormID();
            var player = this.sp.Game.getPlayer();
            var set = new Set();
            for (var i = 0; i < 200; i++) {
                var refrId = (_a = this.sp.Game.findRandomReferenceOfType(this.sp.Game.getFormEx(baseId), player.getPositionX(), player.getPositionY(), player.getPositionZ(), radius)) === null || _a === void 0 ? void 0 : _a.getFormID();
                if (refrId) {
                    set.add(refrId);
                }
                else {
                    break;
                }
            }
            var numFound_1 = 0;
            var worldCleanerService_1 = this.controller.lookupListener(_worldCleanerService__WEBPACK_IMPORTED_MODULE_3__.WorldCleanerService);
            set.forEach(function (refrId) {
                var ref = _this.sp.ObjectReference.from(_this.sp.Game.getFormEx(refrId));
                if (ref !== null && ref.isDeleted() === false) {
                    var refrId_1 = ref.getFormID();
                    if (worldCleanerService_1.getWcProtection(refrId_1) === 0) {
                        ref.delete();
                        ++numFound_1;
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Found and deleted reference " + refrId_1.toString(16));
                    }
                    else {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Found reference " + refrId_1.toString(16) + " but it's protected");
                    }
                }
            });
            if (!numFound_1) {
                return (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Ignoring item drop as false positive");
            }
            var t = _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.DropItem;
            var count = e.numItems;
            this.controller.emitter.emit("sendMessage", {
                message: {
                    t: t,
                    baseId: baseId,
                    count: count,
                },
                reliability: "reliable"
            });
        }
    };
    return DropItemService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/enforceLimitationsService.ts":
/*!************************************************************!*\
  !*** ./src/services/services/enforceLimitationsService.ts ***!
  \************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EnforceLimitationsService: () => (/* binding */ EnforceLimitationsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var EnforceLimitationsService = /** @class */ (function (_super) {
    __extends(EnforceLimitationsService, _super);
    function EnforceLimitationsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.once("update", function () { return _this.onceUpdate(); });
        controller.emitter.on("gameLoad", function (e) { return _this.onGameLoad(e); });
        return _this;
    }
    EnforceLimitationsService.prototype.onceUpdate = function () {
        this.sp.Game.setInChargen(true, true, false);
    };
    EnforceLimitationsService.prototype.onGameLoad = function (event) {
        this.sp.Game.setInChargen(true, true, false);
    };
    return EnforceLimitationsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/frontHotReloadService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/frontHotReloadService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FrontHotReloadService: () => (/* binding */ FrontHotReloadService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var FrontHotReloadService = /** @class */ (function (_super) {
    __extends(FrontHotReloadService, _super);
    function FrontHotReloadService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var enable = !!_this.sp.settings["skymp5-client"]["enable-front-hotreload"];
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "enable-front-hotreload is", enable);
        if (!enable) {
            return _this;
        }
        // TODO: refactor out very similar code in skympClient.ts
        var authGameData = _this.sp.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_1__.authGameDataStorageKey];
        var storageHasValidAuthGameData = (authGameData === null || authGameData === void 0 ? void 0 : authGameData.local) || (authGameData === null || authGameData === void 0 ? void 0 : authGameData.remote);
        if (storageHasValidAuthGameData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Recovered AuthGameData from storage, starting FrontHotReloadService");
            _this.connectToFrontHotReload();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Unable to recover AuthGameData from storage, waiting for auth");
            _this.controller.emitter.on("authAttempt", function (e) { return _this.onAuthAttempt(e); });
        }
        return _this;
    }
    FrontHotReloadService.prototype.onAuthAttempt = function (e) {
        this.connectToFrontHotReload();
    };
    FrontHotReloadService.prototype.connectToFrontHotReload = function () {
        var _this = this;
        this.controller.once("update", function () {
            var url = "localhost:1234";
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Loading url", url);
            _this.sp.browser.loadUrl(url);
        });
    };
    return FrontHotReloadService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/gamemodeEventSourceService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/gamemodeEventSourceService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   GamemodeEventSourceService: () => (/* binding */ GamemodeEventSourceService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// The reason we use global skyrimPlatform is that this.sp may be limited, and gamemode api needs unlimited access to skyrimPlatform
// Sligthly different types



var GamemodeEventSourceService = /** @class */ (function (_super) {
    __extends(GamemodeEventSourceService, _super);
    function GamemodeEventSourceService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.setupEventSource = function (ctx) {
            _this.controller.once('update', function () {
                try {
                    ctx._fn(ctx);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "'eventSources", ctx._eventName, "- Added");
                }
                catch (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", ctx._eventName, "-", e);
                }
            });
        };
        if (Array.isArray(_this.sp.storage['eventSourceContexts'])) {
            _this.sp.storage['eventSourceContexts'] = _this.sp.storage['eventSourceContexts'].filter(function (ctx) { return !ctx._expired; });
            _this.sp.storage['eventSourceContexts'].forEach(function (ctx) {
                _this.setupEventSource(ctx);
            });
        }
        _this.controller.emitter.on("updateGamemodeDataMessage", function (e) { return _this.onUpdateGamemodeDataMessage(e); });
        return _this;
    }
    GamemodeEventSourceService.prototype.onUpdateGamemodeDataMessage = function (event) {
        var _this = this;
        if (this.sp.settings["skymp5-client"]["disable-gamemode-updates"]) {
            if (this.sp.storage['GamemodeEventSourceService_sawEventSources'] === true) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings");
                return;
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings - processing first update only");
            this.sp.storage['GamemodeEventSourceService_sawEventSources'] = true;
        }
        if (!Array.isArray(this.sp.storage['eventSourceContexts'])) {
            this.sp.storage['eventSourceContexts'] = [];
        }
        else {
            this.sp.storage['eventSourceContexts'].forEach(function (ctx) {
                ctx.sendEvent = function () { };
                ctx._expired = true;
            });
        }
        var eventSourcesRecord = {};
        event.message.eventSources.forEach(function (pair) { return eventSourcesRecord[pair.name] = pair.content; });
        var eventNames = Object.keys(eventSourcesRecord);
        var blockedEventSources = this.sp.settings["skymp5-client"]["blockedEventSources"];
        if (Array.isArray(blockedEventSources)) {
            blockedEventSources.forEach(function (blockedEventSource) {
                eventNames = eventNames.filter(function (eventName) { return eventName !== blockedEventSource; });
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "'eventSources", blockedEventSource, "- Blocked by the client");
            });
        }
        var serverJsVerificationService = this.controller.lookupListener(_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__.ServerJsVerificationService);
        eventNames.forEach(function (eventName) {
            var result = serverJsVerificationService.verifyServerJs(eventSourcesRecord[eventName]);
            if (result.src === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", eventName, 'Verification failed:', result.error);
                return;
            }
            try {
                var fn = new Function('ctx', result.src);
                var ctx = {
                    refr: undefined,
                    value: undefined,
                    _model: undefined,
                    _view: undefined,
                    i: -1,
                    get: function (_propName) {
                        throw new Error("ctx.get can't be used in event source");
                    },
                    respawn: function () {
                        throw new Error("ctx.respawn can't be used in event source");
                    },
                    sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
                    sendEvent: function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        var message = {
                            t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CustomEvent,
                            argsJsonDumps: args.map(function (arg) { return JSON.stringify(arg); }),
                            eventName: eventName
                        };
                        _this.controller.emitter.emit("sendMessage", {
                            message: message,
                            reliability: "reliable"
                        });
                    },
                    getFormIdInServerFormat: function (clientsideFormId) {
                        return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(clientsideFormId);
                    },
                    getFormIdInClientFormat: function (serversideFormId) {
                        return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.remoteIdToLocalId)(serversideFormId);
                    },
                    _fn: fn,
                    _eventName: eventName,
                    state: {},
                };
                _this.sp.storage['eventSourceContexts'].push(ctx);
                _this.setupEventSource(ctx);
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", eventName, "-", e);
            }
        });
    };
    return GamemodeEventSourceService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/gamemodeUpdateService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/gamemodeUpdateService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   GamemodeUpdateService: () => (/* binding */ GamemodeUpdateService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: refactor

// The reason we use global skyrimPlatform is that this.sp may be limited, and gamemode api needs unlimited access to skyrimPlatform
// Sligthly different types



var GamemodeUpdateService = /** @class */ (function (_super) {
    __extends(GamemodeUpdateService, _super);
    function GamemodeUpdateService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("updateGamemodeDataMessage", function (e) { return _this.onUpdateGamemodeDataMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.updateOwnerCtx = {
            sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
            refr: undefined,
            value: undefined,
            _model: undefined,
            getFormIdInServerFormat: function (clientsideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(clientsideFormId);
            },
            getFormIdInClientFormat: function (serversideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(serversideFormId);
            },
            get: function (propName) {
                return this._model[propName];
            },
            state: {},
            _view: undefined,
            i: -1,
            respawn: function () { throw new Error("ctx.respawn is not available for updateOwner"); }
        };
        _this.updateNeighborCtx = {
            refr: undefined,
            value: undefined,
            _model: undefined,
            sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
            state: undefined,
            _view: undefined,
            i: -1,
            getFormIdInServerFormat: function (clientsideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(clientsideFormId);
            },
            getFormIdInClientFormat: function (serversideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(serversideFormId);
            },
            get: function (propName) {
                return this._model[propName];
            },
            respawn: function () {
                this._view.destroyForm(this.i);
            }
        };
        _this.updateNeighborFunctionsKeys = [];
        _this.updateNeighborFunctions = {};
        return _this;
    }
    GamemodeUpdateService.prototype.setFormViewArray = function (formViewArray) {
        this.updateNeighborCtx._view = formViewArray;
    };
    GamemodeUpdateService.prototype.setI = function (i) {
        this.updateNeighborCtx.i = i;
    };
    GamemodeUpdateService.prototype.updateNeighbor = function (refr, model, state) {
        for (var _i = 0, _a = this.updateNeighborFunctionsKeys; _i < _a.length; _i++) {
            var key = _a[_i];
            var v = model[key];
            // According to docs:
            // In `updateOwner`/`updateNeighbor` equals to a value of a currently processed property.
            // Can't be `undefined` here, since updates are not received for `undefined` property values.
            // In other contexts is always `undefined`.
            if (v !== undefined) {
                this.updateNeighborCtx.refr = refr;
                this.updateNeighborCtx.value = v;
                this.updateNeighborCtx._model = model;
                this.updateNeighborCtx.state = state;
                var f = this.updateNeighborFunctions[key];
                // Actually, 'f' should always be a valid function, but who knows
                try {
                    if (f) {
                        f(this.updateNeighborCtx);
                    }
                }
                catch (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "updateNeighbor", key, '-', e);
                }
            }
        }
    };
    GamemodeUpdateService.prototype.onUpdateGamemodeDataMessage = function (event) {
        if (this.sp.settings["skymp5-client"]["disable-gamemode-updates"]) {
            if (this.sp.storage['GamemodeUpdateService_sawUpdateFunctions'] === true) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings");
                return;
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings - processing first update only");
            this.sp.storage['GamemodeUpdateService_sawUpdateFunctions'] = true;
        }
        this.sp.storage['updateNeighborFunctions'] = undefined;
        this.sp.storage['updateOwnerFunctions'] = undefined;
        this.updateGamemodeUpdateFunctions('updateNeighborFunctions', event.message.updateNeighborFunctions);
        this.updateGamemodeUpdateFunctions('updateOwnerFunctions', event.message.updateOwnerFunctions);
    };
    GamemodeUpdateService.prototype.onCreateActorMessage = function (event) {
        var _this = this;
        if (!event.message.isMe) {
            return;
        }
        // Otherwise worldModel.playerCharacterFormIdx may be unassigned
        this.controller.once("tick", function () {
            var remoteServer = _this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_1__.RemoteServer);
            var worldModel = remoteServer.getWorldModel();
            var myFormModel = worldModel.forms[worldModel.playerCharacterFormIdx];
            if (!myFormModel) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "Unable to find formModel with index", worldModel.playerCharacterFormIdx);
                return;
            }
            _this.setOwnerModel(myFormModel);
        });
    };
    GamemodeUpdateService.prototype.onTick = function () {
        var keys = this.sp.storage["updateNeighborFunctions_keys"];
        if (keys && Array.isArray(keys)) {
            this.updateNeighborFunctionsKeys = keys;
        }
        else {
            this.updateNeighborFunctionsKeys = [];
        }
        // TODO: Shouldn't we check storage value before assignment?
        this.updateNeighborFunctions = this.sp.storage["updateNeighborFunctions"];
    };
    GamemodeUpdateService.prototype.onUpdate = function () {
        var playerRef = this.sp.ObjectReference.from(this.sp.Game.getPlayer());
        var keys = this.sp.storage["updateOwnerFunctions_keys"];
        if (!keys || !Array.isArray(keys)) {
            keys = [];
        }
        var funcs = this.sp.storage["updateOwnerFunctions"];
        if (this.sp.storage["ownerModelSet"] !== true) {
            return;
        }
        var ownerModel = this.sp.storage["ownerModel"];
        for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {
            var propName = keys_1[_i];
            var f = funcs[propName];
            // Actually, must always be a valid funciton, but who knows
            if (!f) {
                continue;
            }
            this.updateOwnerCtx._model = ownerModel;
            if (!this.updateOwnerCtx._model) {
                continue;
            }
            this.updateOwnerCtx.value = this.updateOwnerCtx._model[propName];
            if (this.updateOwnerCtx.value === undefined) {
                continue;
            }
            this.updateOwnerCtx.refr = playerRef;
            this.updateOwnerCtx._model = ownerModel;
            try {
                if (f) {
                    f(this.updateOwnerCtx);
                }
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "updateOwner", propName, '-', e);
            }
        }
    };
    GamemodeUpdateService.prototype.setOwnerModel = function (ownerModel) {
        this.sp.storage["ownerModel"] = ownerModel;
        this.sp.storage["ownerModelSet"] = true;
    };
    ;
    GamemodeUpdateService.prototype.updateGamemodeUpdateFunctions = function (storageVar, functionSources) {
        var serverJsVerificationService = this.controller.lookupListener(_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__.ServerJsVerificationService);
        var functionSourcesRecord = {};
        functionSources.forEach(function (pair) { return functionSourcesRecord[pair.name] = pair.content; });
        this.sp.storage[storageVar] = functionSourcesRecord;
        for (var _i = 0, _a = Object.keys(functionSourcesRecord); _i < _a.length; _i++) {
            var propName = _a[_i];
            var result = serverJsVerificationService.verifyServerJs(this.sp.storage[storageVar][propName]);
            if (result.src === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, storageVar, propName, 'Verification failed:', result.error);
                delete this.sp.storage[storageVar][propName];
                continue;
            }
            try {
                this.sp.storage[storageVar][propName] = new Function('ctx', result.src);
                var emptyFunction = functionSourcesRecord[propName] === '';
                if (emptyFunction) {
                    delete this.sp.storage[storageVar][propName];
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, storageVar, propName, 'Added empty');
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, storageVar, propName, 'Added');
                }
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, storageVar, propName, e);
            }
        }
        this.sp.storage["".concat(storageVar, "_keys")] = Object.keys(this.sp.storage[storageVar]);
    };
    return GamemodeUpdateService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/hitService.ts":
/*!*********************************************!*\
  !*** ./src/services/services/hitService.ts ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   HitService: () => (/* binding */ HitService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out




var HitService = /** @class */ (function (_super) {
    __extends(HitService, _super);
    function HitService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.recentMagicHits = new Map();
        controller.on('hit', function (e) { return _this.onHit(e); });
        return _this;
    }
    HitService.prototype.onHit = function (e) {
        // TODO: add more logging in case of 'return'
        // TODO: allow non-weapon sources
        var aggressor = e.aggressor.getFormID();
        if (aggressor < 0xff000000 && aggressor !== 0x14)
            return; // all skymp npcs are FF+
        if (aggressor >= 0xff000000) {
            // TODO: make host service
            var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.storage['hosted'];
            var alreadyHosted = false;
            if (Array.isArray(hosted)) {
                var remoteId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(aggressor);
                if (hosted.includes(remoteId) || hosted.includes(remoteId + 0x100000000)) {
                    alreadyHosted = true;
                }
            }
            if (!alreadyHosted) {
                return;
            }
        }
        var base = e.target.getBaseObject();
        var type = base === null || base === void 0 ? void 0 : base.getType();
        if (type === 34 /* FormType.Static */ || type === 36 /* FormType.MovableStatic */) {
            return;
        }
        var isWeapon = this.sp.Weapon.from(e.source);
        var isSpell = !isWeapon && this.sp.Spell.from(e.source);
        var isScroll = !isWeapon && !isSpell && this.sp.Scroll.from(e.source);
        if (!isWeapon && !isSpell && !isScroll) {
            return;
        }
        // prevent double hit that happens for some reason with magic projectiles
        if (isSpell || isScroll) {
            var aggressorId = e.aggressor.getFormID();
            var now = Date.now();
            var lastHitTime = this.recentMagicHits.get(aggressorId);
            if (lastHitTime && now - lastHitTime < 100) {
                return;
            }
            this.recentMagicHits.set(aggressorId, now);
        }
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.OnHit, data: this.getHitData(e) },
            reliability: "reliable"
        });
    };
    HitService.prototype.getHitData = function (e) {
        var hitData = {
            aggressor: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.aggressor.getFormID()),
            isBashAttack: e.isBashAttack,
            isHitBlocked: e.isHitBlocked,
            isPowerAttack: e.isPowerAttack,
            isSneakAttack: e.isSneakAttack,
            projectile: e.projectile ? e.projectile.getFormID() : 0,
            source: e.source ? e.source.getFormID() : 0,
            target: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.target.getFormID())
        };
        return hitData;
    };
    return HitService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/keyboardEventsService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/keyboardEventsService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   KeyboardEventsService: () => (/* binding */ KeyboardEventsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var KeyboardEventsService = /** @class */ (function (_super) {
    __extends(KeyboardEventsService, _super);
    function KeyboardEventsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastNumKeys = 0;
        controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    KeyboardEventsService.prototype.onUpdate = function () {
        var _this = this;
        var numKeys = this.sp.Input.getNumKeysPressed();
        if (this.lastNumKeys !== numKeys) {
            this.lastNumKeys = numKeys;
            this.controller.emitter.emit("queryKeyCodeBindings", {
                isDown: function (binding) {
                    if (binding.every(function (key) { return _this.sp.Input.isKeyPressed(key); })) {
                        return true;
                    }
                    return false;
                }
            });
        }
    };
    return KeyboardEventsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/lastInvService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/lastInvService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LastInvService: () => (/* binding */ LastInvService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var LastInvService = /** @class */ (function (_super) {
    __extends(LastInvService, _super);
    function LastInvService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        return _this;
    }
    Object.defineProperty(LastInvService.prototype, "lastInv", {
        get: function () {
            return this._lastInv;
        },
        set: function (newValue) {
            this._lastInv = newValue;
        },
        enumerable: false,
        configurable: true
    });
    return LastInvService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/loadGameService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/loadGameService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LoadGameService: () => (/* binding */ LoadGameService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var LoadGameService = /** @class */ (function (_super) {
    __extends(LoadGameService, _super);
    function LoadGameService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this._isCausedBySkyrimPlatform = false;
        _this.controller.on("loadGame", function () { return _this.onLoadGame(); });
        return _this;
    }
    LoadGameService.prototype.loadGame = function (pos, rot, worldOrCell, changeFormNpc, loadOrder, time) {
        try {
            // @ts-ignore
            this.sp.loadGame(pos, rot, worldOrCell, changeFormNpc, loadOrder, time);
        }
        catch (e) {
            // Hotfix non-vanilla headparts bug
            // @ts-ignore
            this.sp.loadGame(pos, rot, worldOrCell, undefined, loadOrder, time);
        }
        this._isCausedBySkyrimPlatform = true;
    };
    LoadGameService.prototype.onLoadGame = function () {
        var _this = this;
        try {
            var gameLoadEvent = {
                isCausedBySkyrimPlatform: this._isCausedBySkyrimPlatform
            };
            this.controller.emitter.emit("gameLoad", gameLoadEvent);
        }
        catch (e) {
            this.controller.once("tick", function () {
                _this._isCausedBySkyrimPlatform = false;
            });
            throw e;
        }
        this.controller.once("tick", function () {
            _this._isCausedBySkyrimPlatform = false;
        });
    };
    return LoadGameService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/loadOrderVerificationService.ts":
/*!***************************************************************!*\
  !*** ./src/services/services/loadOrderVerificationService.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LoadOrderVerificationService: () => (/* binding */ LoadOrderVerificationService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _view_formView__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../view/formView */ "./src/view/formView.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var STATE_KEY = 'loadOrderCheckState';
;
var LoadOrderVerificationService = /** @class */ (function (_super) {
    __extends(LoadOrderVerificationService, _super);
    function LoadOrderVerificationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    LoadOrderVerificationService.prototype.onceUpdate = function () {
        this.verifyLoadOrder();
    };
    LoadOrderVerificationService.prototype.verifyLoadOrder = function () {
        var _this = this;
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_4__.SettingsService);
        this.resetText();
        var clientMods = this.getClientMods();
        this.printModOrder('Client load order:', clientMods);
        return settingsService.getServerMods()
            .then(function (serverMods) {
            _this.printModOrder('Server load order:', serverMods);
            if (clientMods.length < serverMods.length) {
                throw new Error("Missing some server mods. Server has ".concat(serverMods.length, ", we have ").concat(clientMods.length));
            }
            if (clientMods.length > serverMods.length) {
                _this.updateText('LOAD ORDER WARNING: you have more mods than server!\n(or could not receive server mod list)\nCheck console for details.', [255, 255, 0, 1], 5);
            }
            var fail = [];
            for (var i = 0; i < serverMods.length; ++i) {
                // Need case-insensitive check for 1.6+
                if (clientMods[i].filename.toLowerCase() !== serverMods[i].filename.toLowerCase() ||
                    clientMods[i].size !== serverMods[i].size ||
                    clientMods[i].crc32 !== serverMods[i].crc32) {
                    fail.push(i);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("".concat(i, "-th mod (numbered from 0) does not match."));
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Server has ".concat(JSON.stringify(serverMods[i])));
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("We have ".concat(JSON.stringify(clientMods[i])));
                }
            }
            if (fail.length !== 0) {
                throw new Error('Load order check failed! Indices: ' + JSON.stringify(fail));
            }
        })
            .catch(function (err) {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(err);
            if (_this.sp.settings['skymp5-client']['ignoreLoadOrderMismatch']) {
                _this.updateText('LOAD ORDER ERROR!\nHowever, ignoring it because of ignoreLoadOrderMismatch being set.' +
                    '\nExpect EVERYTHING BREAK, unless you know what you are doing.\nCheck console for details.' +
                    '\nThis message will disappear after 30 seconds.', [255, 0, 0, 1], 30);
                return;
            }
            _this.updateText('LOAD ORDER ERROR!\nCheck console for details.', [255, 0, 0, 1]);
        });
    };
    ;
    LoadOrderVerificationService.prototype.getState = function () {
        if (typeof this.sp.storage[STATE_KEY] !== 'object') {
            return {};
        }
        return this.sp.storage[STATE_KEY];
    };
    ;
    LoadOrderVerificationService.prototype.setState = function (replacement) {
        var oldState = this.sp.storage[STATE_KEY] = this.getState();
        for (var _i = 0, _a = Object.entries(replacement); _i < _a.length; _i++) {
            var _b = _a[_i], k = _b[0], v = _b[1];
            oldState[k] = v;
        }
    };
    ;
    LoadOrderVerificationService.prototype.resetText = function () {
        var statusTextId = this.getState().statusTextId;
        if (statusTextId) {
            this.sp.destroyText(statusTextId);
            statusTextId = undefined;
            this.setState({ statusTextId: statusTextId });
        }
    };
    ;
    LoadOrderVerificationService.prototype.updateText = function (text, color, clearDelay) {
        var _this = this;
        var _a = (0,_view_formView__WEBPACK_IMPORTED_MODULE_1__.getScreenResolution)(), width = _a.width, height = _a.height;
        this.resetText();
        var statusTextId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(width / 2, height / 2, text, color);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(statusTextId, 0.5);
        this.setState({ statusTextId: statusTextId });
        if (clearDelay) {
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(clearDelay).then(function () { return _this.resetText(); });
        }
    };
    LoadOrderVerificationService.prototype.enumerateClientMods = function (getCount, getAt) {
        var result = [];
        for (var i = 0; i < getCount(); ++i) {
            var filename = getAt(i);
            var _a = this.getFileInfoSafe(filename), crc32 = _a.crc32, size = _a.size;
            result.push({ filename: filename, crc32: crc32, size: size });
        }
        return result;
    };
    LoadOrderVerificationService.prototype.getClientMods = function () {
        return this.enumerateClientMods(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getModCount, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getModName);
    };
    ;
    LoadOrderVerificationService.prototype.printModOrder = function (header, order) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(header);
        for (var _i = 0, _a = Object.entries(order); _i < _a.length; _i++) {
            var _b = _a[_i], i = _b[0], mod = _b[1];
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("#".concat(i, " ").concat(JSON.stringify(mod)));
        }
    };
    ;
    LoadOrderVerificationService.prototype.getFileInfoSafe = function (filename) {
        try {
            return this.sp.getFileInfo(filename);
        }
        catch (e) {
            var message = e.message;
            if (typeof message === "string" && message.includes('is not a valid argument')) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Failed to get file info for", filename);
                return { crc32: 0, size: 0 };
            }
            else {
                throw e;
            }
        }
    };
    return LoadOrderVerificationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/magicSyncService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/magicSyncService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   MagicSyncService: () => (/* binding */ MagicSyncService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out

// @ts-expect-error (TODO: Remove in 2.10.0)



var MagicSyncService = /** @class */ (function (_super) {
    __extends(MagicSyncService, _super);
    function MagicSyncService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.playerId = 0x14;
        _this.sendUpdateAnimationVariablesRateMs = 500;
        _this.lastSpellCastEventMsg = null;
        _this.lastSendUpdateAnimationVariables = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.on("spellCast", function (e) { return _this.onSpellCast(e); });
        var self = _this;
        _this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) { },
            leave: function (ctx) {
                self.onSendAnimationEventLeave(ctx);
            }
        }, _this.playerId, _this.playerId);
        return _this;
    }
    MagicSyncService.prototype.onUpdate = function () {
        var _this = this;
        if (this.isAnyMagicStuffEquiped() === false) {
            return;
        }
        if (Date.now() - this.lastSendUpdateAnimationVariables <= this.sendUpdateAnimationVariablesRateMs) {
            return;
        }
        this.lastSendUpdateAnimationVariables = Date.now();
        this.controller.once('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.Game.getPlayer();
            if (!ac) {
                return;
            }
            var animVariables = _this.getAnimationVariablesFromActorConverted(ac.getFormID());
            _this.controller.emitter.emit("sendMessage", {
                message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.UpdateAnimVariables, data: _this.getUpdateAnimVariablesEventData(ac, animVariables) },
                reliability: "reliable"
            });
        });
    };
    MagicSyncService.prototype.onSpellCast = function (event) {
        var isInterruptCast = false;
        var msg = this.getSpellCastEventData(event, isInterruptCast);
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.SpellCast, data: msg },
            reliability: "reliable"
        });
        this.lastSpellCastEventMsg = msg;
    };
    MagicSyncService.prototype.onSendAnimationEventLeave = function (ctx) {
        var _this = this;
        if (!this.lastSpellCastEventMsg || !this.isInteraptSpellCastAnim(ctx.animEventName)) {
            return;
        }
        this.controller.once('update', function () {
            if (!_this.lastSpellCastEventMsg || _this.lastSpellCastEventMsg.interruptCast) {
                return;
            }
            var msg = _this.lastSpellCastEventMsg;
            msg.interruptCast = true;
            msg.actorAnimationVariables = _this.getAnimationVariablesFromActorConverted((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.remoteIdToLocalId)(_this.lastSpellCastEventMsg.caster));
            _this.controller.emitter.emit("sendMessage", {
                message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.SpellCast, data: msg },
                reliability: "reliable"
            });
        });
    };
    MagicSyncService.prototype.getSpellCastEventData = function (e, isInterruptCast) {
        var spellCastData = {
            caster: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.caster.getFormID(), true),
            // @ts-expect-error (TODO: Remove in 2.10.0)
            target: e.target ? (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.target.getFormID(), true) : 0,
            spell: e.spell ? e.spell.getFormID() : 0,
            interruptCast: isInterruptCast,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            isDualCasting: e.isDualCasting,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            castingSource: e.castingSource,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            aimAngle: e.aimAngle,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            aimHeading: e.aimHeading,
            actorAnimationVariables: this.getAnimationVariablesFromActorConverted(e.caster.getFormID()),
        };
        return spellCastData;
    };
    MagicSyncService.prototype.getAnimationVariablesFromActorConverted = function (actorId) {
        var animVars = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.getAnimationVariablesFromActor)(actorId);
        var booleans = animVars.booleans;
        var floats = animVars.floats;
        var integers = animVars.integers;
        return {
            booleans: Array.from(new Uint8Array(booleans)),
            floats: Array.from(new Uint8Array(floats)),
            integers: Array.from(new Uint8Array(integers)),
        };
    };
    MagicSyncService.prototype.getUpdateAnimVariablesEventData = function (ac, animVariables) {
        var animVarsData = {
            actorRemoteId: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(ac.getFormID(), true),
            actorAnimationVariables: animVariables,
        };
        return animVarsData;
    };
    MagicSyncService.prototype.isInteraptSpellCastAnim = function (animEventName) {
        var eventName = animEventName.toLowerCase();
        return eventName === "mlh_equipped_event" || eventName === "mrh_equipped_event";
    };
    ;
    MagicSyncService.prototype.isSpellCastAnim = function (animEventName) {
        var eventName = animEventName.toLowerCase();
        var isSpellCastAnimForLeftHand = eventName === "mlh_spellaimedconcentrationstart" || eventName === "mlh_spellaimedstart" || eventName === "mlh_spellready_event" ||
            eventName === "mlh_spellrelease_event" || eventName === "mlh_equipped_event";
        var isSpellCastAnimForRightHand = eventName === "mrh_spellaimedconcentrationstart" || eventName === "mrh_spellaimedstart" || eventName === "mrh_spellready_event" ||
            eventName === "mrh_spellrelease_event" || eventName === "mrh_equipped_event";
        return isSpellCastAnimForLeftHand || isSpellCastAnimForRightHand;
    };
    ;
    MagicSyncService.prototype.isAnyMagicStuffEquiped = function () {
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.Game.getPlayer();
        if (!ac) {
            return false;
        }
        if (ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Left) || ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Right)) {
            return true;
        }
        if (ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Voise) || ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Instant)) {
            return true;
        }
        var leftHandEquipmentType = ac.getEquippedItemType(1 /* SlotType.Left */);
        var rightHandEquipmentType = ac.getEquippedItemType(2 /* SlotType.Right */);
        // TODO: Spell => SpellOrScroll, since Spell is now a deprecated name (TODO: Remove in 2.10.0)
        if (leftHandEquipmentType === 9 /* EquippedItemType.Spell */ || leftHandEquipmentType === 8 /* EquippedItemType.Staff */ ||
            rightHandEquipmentType === 9 /* EquippedItemType.Spell */ || rightHandEquipmentType === 8 /* EquippedItemType.Staff */) {
            return true;
        }
        return false;
    };
    return MagicSyncService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/netInfoService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/netInfoService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NetInfoService: () => (/* binding */ NetInfoService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var NetInfoService = /** @class */ (function (_super) {
    __extends(NetInfoService, _super);
    function NetInfoService(sp, controller) {
        var _this = this;
        var _a;
        _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.receivedPacketCount = 0;
        _this.sentPacketCount = 0;
        _this.localLagUnits = 0;
        _this.delayMs = 1000;
        _this.lastDt = 0;
        _this.dt = 0;
        _this.greenARGB = [0, 128, 0, 1];
        _this.redARGB = [255, 0, 0, 1];
        // clear previous texts in case of hotreload
        if (_this.sp.storage[NetInfoTexts.Name] && _this.sp.storage[NetInfoTexts.Name].clear) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Destroying old NetInfoTexts");
            try {
                (_a = _this.sp.storage[NetInfoTexts.Name]) === null || _a === void 0 ? void 0 : _a.clear();
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(_this, "Failed to destroy old NetInfoTexts:", e);
            }
        }
        if (!_this.isEnabled()) {
            return _this;
        }
        _this.textIds = new NetInfoTexts(_this.sp);
        _this.sp.storage[NetInfoTexts.Name] = _this.textIds;
        _this.lastDt = Date.now();
        _this.controller.emitter.on("sendMessage", function (e) { return _this.onSendMessage(e); });
        _this.controller.emitter.on("sendMessageWithRefrId", function (e) { return _this.onSendMessageWithRefrId(e); });
        _this.controller.emitter.on("anyMessage", function (e) { return _this.onAnyMessage(e); });
        _this.controller.emitter.on("newLocalLagValueCalculated", function (e) { return _this.onNewLocalLagValueCalculated(e); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    NetInfoService.prototype.onSendMessage = function (e) {
        this.addSentPacketCount(1);
    };
    NetInfoService.prototype.onSendMessageWithRefrId = function (e) {
        this.addSentPacketCount(1);
    };
    NetInfoService.prototype.onAnyMessage = function (e) {
        this.addReceivedPacketCount(1);
    };
    NetInfoService.prototype.onNewLocalLagValueCalculated = function (e) {
        this.setLocalLagUnits(e.lagUnitsNoZ);
    };
    NetInfoService.prototype.onUpdate = function () {
        if (this.textIds === undefined) {
            return;
        }
        this.dt += Date.now() - this.lastDt;
        this.lastDt = Date.now();
        var isConnected = this.sp.mpClientPlugin.isConnected();
        this.sp.setTextString(this.textIds.connectionStateTextId, "".concat(isConnected ? "ON" : "OFF"));
        this.sp.setTextColor(this.textIds.connectionStateTextId, isConnected ? this.greenARGB : this.redARGB);
        // https://www.creationkit.com/index.php?title=Unit
        var units = this.getLocalLagUnits();
        var unitsInMeter = 70.0218818381;
        var meters = Math.round(units / unitsInMeter * 10) / 10;
        this.sp.setTextString(this.textIds.localPositionLagAmountTextId, "".concat(units, " units (~").concat(meters, " m)"));
        if (this.delayMs > this.dt) {
            return;
        }
        this.sp.setTextString(this.textIds.receivedPacketAmountTextId, "".concat(Math.round(this.getAndClearReceivedPacketCount())));
        this.sp.setTextString(this.textIds.sentPacketAmountTextId, "".concat(Math.round(this.getAndClearSentPacketCount())));
        this.dt = 0;
    };
    NetInfoService.prototype.addReceivedPacketCount = function (count) {
        this.receivedPacketCount += count;
    };
    NetInfoService.prototype.getAndClearReceivedPacketCount = function () {
        var value = this.receivedPacketCount;
        this.receivedPacketCount = 0;
        return value;
    };
    NetInfoService.prototype.addSentPacketCount = function (count) {
        this.sentPacketCount += count;
    };
    NetInfoService.prototype.getAndClearSentPacketCount = function () {
        var value = this.sentPacketCount;
        this.sentPacketCount = 0;
        return value;
    };
    NetInfoService.prototype.setLocalLagUnits = function (distance) {
        this.localLagUnits = distance;
    };
    NetInfoService.prototype.getLocalLagUnits = function () {
        return this.localLagUnits;
    };
    NetInfoService.prototype.isEnabled = function () {
        return !!this.sp.settings["skymp5-client"]["show-net-info"];
    };
    return NetInfoService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));

var NetInfoTexts = /** @class */ (function () {
    function NetInfoTexts(sp, connectionStaticTextId, connectionStateTextId, receivedPacketStaticTextId, receivedPacketAmountTextId, sentPacketStaticTextId, sentPacketAmountTextId, localPositionLagStaticTextId, localPositionLagAmountTextId) {
        if (connectionStaticTextId === void 0) { connectionStaticTextId = sp.createText(100, 350, "connection:", [255, 255, 255, 1]); }
        if (connectionStateTextId === void 0) { connectionStateTextId = sp.createText(220, 350, "", [255, 255, 255, 1]); }
        if (receivedPacketStaticTextId === void 0) { receivedPacketStaticTextId = sp.createText(120, 390, "incoming (p/s):", [255, 255, 255, 1]); }
        if (receivedPacketAmountTextId === void 0) { receivedPacketAmountTextId = sp.createText(250, 390, "", [255, 255, 255, 1]); }
        if (sentPacketStaticTextId === void 0) { sentPacketStaticTextId = sp.createText(120, 430, "outgoing (p/s):", [255, 255, 255, 1]); }
        if (sentPacketAmountTextId === void 0) { sentPacketAmountTextId = sp.createText(250, 430, "", [255, 255, 255, 1]); }
        if (localPositionLagStaticTextId === void 0) { localPositionLagStaticTextId = sp.createText(90, 470, "local lag:", [255, 255, 255, 1]); }
        if (localPositionLagAmountTextId === void 0) { localPositionLagAmountTextId = sp.createText(250, 470, "", [255, 255, 255, 1]); }
        this.sp = sp;
        this.connectionStaticTextId = connectionStaticTextId;
        this.connectionStateTextId = connectionStateTextId;
        this.receivedPacketStaticTextId = receivedPacketStaticTextId;
        this.receivedPacketAmountTextId = receivedPacketAmountTextId;
        this.sentPacketStaticTextId = sentPacketStaticTextId;
        this.sentPacketAmountTextId = sentPacketAmountTextId;
        this.localPositionLagStaticTextId = localPositionLagStaticTextId;
        this.localPositionLagAmountTextId = localPositionLagAmountTextId;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.connectionStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.connectionStateTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.receivedPacketStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.receivedPacketAmountTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.sentPacketStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.sentPacketAmountTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.localPositionLagStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.localPositionLagAmountTextId, 0.5);
    }
    NetInfoTexts.prototype.clear = function () {
        this.sp.destroyText(this.connectionStaticTextId);
        this.sp.destroyText(this.connectionStateTextId);
        this.sp.destroyText(this.receivedPacketStaticTextId);
        this.sp.destroyText(this.receivedPacketAmountTextId);
        this.sp.destroyText(this.sentPacketStaticTextId);
        this.sp.destroyText(this.sentPacketAmountTextId);
        this.sp.destroyText(this.localPositionLagStaticTextId);
        this.sp.destroyText(this.localPositionLagAmountTextId);
    };
    NetInfoTexts.Name = "netInfoTexts";
    return NetInfoTexts;
}());


/***/ }),

/***/ "./src/services/services/networkingService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/networkingService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NetworkingService: () => (/* binding */ NetworkingService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var NetworkingService = /** @class */ (function (_super) {
    __extends(NetworkingService, _super);
    function NetworkingService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.emitter.on("sendMessage", function (e) { return _this.onSendMessage(e); });
        _this.controller.emitter.on("sendRawMessage", function (e) { return _this.onSendRawMessage(e); });
        _this.controller.emitter.on("sendMessageWithRefrId", function (e) { return _this.onSendMessageWithRefrId(e); });
        return _this;
    }
    NetworkingService.prototype.onSendMessage = function (e) {
        this.sp.mpClientPlugin.send(JSON.stringify(e.message), this.isReliable(e.reliability));
    };
    NetworkingService.prototype.onSendRawMessage = function (e) {
        // @ts-expect-error
        this.sp.mpClientPlugin.sendRaw(e.rawMessage, e.rawMessage.byteLength, this.isReliable(e.reliability));
    };
    NetworkingService.prototype.onSendMessageWithRefrId = function (e) {
        var refrId = e.message._refrId;
        var remoteServer = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_4__.RemoteServer);
        var idxInModel = refrId
            ? remoteServer.getWorldModel().forms.findIndex(function (f) { return f && f.refrId === refrId; })
            : remoteServer.getWorldModel().playerCharacterFormIdx;
        // fixes "can't get property idx of null or undefined"
        if (!remoteServer.getWorldModel().forms[idxInModel]) {
            return;
        }
        // @ts-ignore
        e.message.idx = remoteServer.getWorldModel().forms[idxInModel].idx;
        delete e.message._refrId;
        this.sp.mpClientPlugin.send(JSON.stringify(e.message), this.isReliable(e.reliability));
    };
    NetworkingService.prototype.connect = function (hostName, port) {
        this.serverAddress = { hostName: hostName, port: port };
        this.createClientSafe();
    };
    NetworkingService.prototype.reconnect = function () {
        this.createClientSafe();
    };
    NetworkingService.prototype.close = function () {
        this.sp.mpClientPlugin.destroyClient();
    };
    NetworkingService.prototype.isConnected = function () {
        return this.sp.mpClientPlugin.isConnected();
    };
    NetworkingService.prototype.onTick = function () {
        var _this = this;
        this.sp.mpClientPlugin.tick(function (packetType, rawContent, error) {
            switch (packetType) {
                case "connectionAccepted":
                    _this.controller.emitter.emit("connectionAccepted", {});
                    break;
                case "connectionDenied":
                    _this.controller.emitter.emit("connectionDenied", { error: error });
                    _this.reconnect();
                    break;
                case "connectionFailed":
                    _this.controller.emitter.emit("connectionFailed", {});
                    _this.reconnect();
                    break;
                case "disconnect":
                    _this.controller.emitter.emit("connectionDisconnect", {});
                    _this.reconnect();
                    break;
                case "message":
                    // TODO: in theory can be empty jsonContent and non-empty error
                    var msgAny = void 0;
                    if (rawContent === null) {
                        msgAny = {};
                        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "null rawContent");
                    }
                    else if ((new Uint8Array(rawContent)[0]) === 0x7b) {
                        // assume json
                        msgAny = JSON.parse(_this.sp.decodeUtf8(rawContent));
                    }
                    else {
                        // assume raw
                        var event = { rawContent: rawContent };
                        return _this.controller.emitter.emit("anyRawMessage", event);
                    }
                    if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.OpenContainer) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("openContainerMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateMovement) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateMovementMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimation) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAnimationMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateEquipment) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateEquipmentMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.ChangeValues) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("changeValuesMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SpellCast) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("spellCastMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimVariables) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAnimVariablesMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAppearance) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAppearanceMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Teleport) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("teleportMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateProperty) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updatePropertyMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.DeathStateContainer) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("deathStateContainerMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CreateActor) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("createActorMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CustomPacket) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("customPacketMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.DestroyActor) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("destroyActorMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.HostStart) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("hostStartMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.HostStop) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("hostStopMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SetInventory) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("setInventoryMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SetRaceMenuOpen) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("setRaceMenuOpenMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SpSnippet) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("spSnippetMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateGamemodeData) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateGamemodeDataMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Teleport2) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("teleportMessage2", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else {
                        // throw new NeverError(msgAny);
                        throw new Error("Unhandled MsgType " + msgAny.t);
                    }
                    break;
            }
        });
    };
    NetworkingService.prototype.createClientSafe = function () {
        var _a = this.serverAddress, hostName = _a.hostName, port = _a.port;
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "createClientSafe " + hostName + ":" + port);
        if (this.serverAddress.hostName !== "" && this.serverAddress.port !== 0) {
            this.sp.mpClientPlugin.createClient(hostName, port);
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "createClientSafe failed");
        }
    };
    Object.defineProperty(NetworkingService.prototype, "serverAddress", {
        get: function () {
            var res = this.sp.storage["serverAddress"];
            if (typeof res === "object") {
                var result = res;
                if (typeof result.hostName === "string" && typeof result.port === "number") {
                    return result;
                }
            }
            return { hostName: "", port: 0 };
        },
        set: function (newValue) {
            this.sp.storage["serverAddress"] = newValue;
        },
        enumerable: false,
        configurable: true
    });
    NetworkingService.prototype.isReliable = function (reliability) {
        switch (reliability) {
            case "reliable":
                return true;
            case "unreliable":
                return false;
            default:
                throw new _lib_errors__WEBPACK_IMPORTED_MODULE_1__.NeverError(reliability);
        }
    };
    return NetworkingService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_3__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/playerBowShotService.ts":
/*!*******************************************************!*\
  !*** ./src/services/services/playerBowShotService.ts ***!
  \*******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PlayerBowShotService: () => (/* binding */ PlayerBowShotService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var PlayerBowShotService = /** @class */ (function (_super) {
    __extends(PlayerBowShotService, _super);
    function PlayerBowShotService(sp, controller) {
        var _this_1 = _super.call(this) || this;
        _this_1.sp = sp;
        _this_1.controller = controller;
        _this_1.score = 0;
        _this_1.inventoryUnblockMoment = 0;
        _this_1.controller.emitter.on("queryBlockSetInventoryEvent", function (e) { return _this_1.onQueryBlockSetInventoryEvent(e); });
        _this_1.controller.on("playerBowShot", function (e) { return _this_1.onPlayerBowShot(e); });
        var _this = _this_1;
        var eventPatterns = ["attackRelease", "crossbowAttackStart"];
        eventPatterns.forEach(function (eventPattern) {
            _this_1.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) {
                },
                leave: function (ctx) {
                    if (!ctx.animationSucceeded) {
                        return;
                    }
                    if (ctx.animEventName === "crossbowAttackStart") {
                        _this.score = 1;
                    }
                    else if (ctx.animEventName === "attackRelease") {
                        if (_this.score === 1) {
                            _this.controller.once("update", function () { _this.onPlayerCrossbowShot(); });
                            _this.score = 0;
                        }
                    }
                    else {
                        _this.score = 0;
                    }
                }
            }, 0x14, 0x14, eventPattern);
        });
        return _this_1;
    }
    PlayerBowShotService.prototype.onQueryBlockSetInventoryEvent = function (e) {
        if (Date.now() < this.inventoryUnblockMoment) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Blocked inventory operation");
            e.block();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Not blocked inventory operation");
        }
    };
    PlayerBowShotService.prototype.onPlayerBowShot = function (e) {
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PlayerBowShot,
                weaponId: e.weapon.getFormID(),
                ammoId: e.ammo.getFormID(),
                power: e.power,
                isSunGazing: e.isSunGazing || false
            },
            reliability: "unreliable"
        });
    };
    PlayerBowShotService.prototype.onPlayerCrossbowShot = function () {
        var actor = this.sp.Game.getPlayer();
        if (actor === null) {
            return;
        }
        var crossbow = actor.getEquippedWeapon(false);
        if (crossbow === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Couldn't get equipped weapon");
            return;
        }
        var weaponType = crossbow.getWeaponType();
        if (weaponType !== 9 /* WeaponType.Crossbow */) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Expected weapon to be crossbow, but got WeaponType", weaponType);
            return;
        }
        var equippedAmmoEntries = (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.getEquipment)(actor, 0).inv.entries.filter(function (entry) { return entry.worn && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(entry.baseId)); });
        if (equippedAmmoEntries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Ammo not found");
            return;
        }
        if (equippedAmmoEntries.length > 1) {
            var equippedAmmoIds = equippedAmmoEntries.map(function (entry) { return entry.baseId; });
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Found more than 1 ammos:", equippedAmmoIds);
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PlayerBowShot,
                weaponId: crossbow.getFormID(),
                ammoId: equippedAmmoEntries[0].baseId,
                isSunGazing: false,
                power: 1.0
            },
            reliability: "unreliable"
        });
        // Fixes race condition when the server removes an item faster than local crossbow does that: -1 total
        // Then crossbow removes one more item: -2 total
        // The item is being added back: -1 total (which is correct but looks ugly in process)
        this.inventoryUnblockMoment = Date.now() + 5 * 1000;
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Sent crossbow shot");
    };
    return PlayerBowShotService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/profilingService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/profilingService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ProfilingService: () => (/* binding */ ProfilingService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var inspector__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! inspector */ "inspector");
/* harmony import */ var inspector__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(inspector__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! fs */ "fs");
/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_3__);
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};




var ProfilingService = /** @class */ (function (_super) {
    __extends(ProfilingService, _super);
    function ProfilingService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var settings = sp.settings["skymp5-client"];
        if (!settings["enableProfiling"]) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "ProfilingService: disabled");
            return _this;
        }
        var profilingDurationMs = _this.getInteger(settings["profilingDurationMs"]) || 10000;
        var session = new inspector__WEBPACK_IMPORTED_MODULE_2__.Session();
        session.connect();
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "ProfilingService: start");
        _this.startProfiling(session, profilingDurationMs);
        return _this;
    }
    ProfilingService.prototype.startProfiling = function (session, profilingDurationMs) {
        return __awaiter(this, void 0, void 0, function () {
            var profile, fileNameSuffix;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, new Promise(function (resolve, reject) {
                            session.post('Profiler.enable', function (err) {
                                if (err) {
                                    reject(err);
                                }
                                else {
                                    resolve(undefined);
                                }
                            });
                        })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, new Promise(function (resolve, reject) {
                                session.post('Profiler.start', function (err) {
                                    if (err) {
                                        reject(err);
                                    }
                                    else {
                                        resolve(undefined);
                                    }
                                });
                            })];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, new Promise(function (resolve) {
                                setTimeout(resolve, profilingDurationMs);
                            })];
                    case 3:
                        _a.sent();
                        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "ProfilingService: stop");
                        return [4 /*yield*/, new Promise(function (resolve, reject) {
                                session.post('Profiler.stop', function (err, res) {
                                    if (err) {
                                        reject(err);
                                    }
                                    else {
                                        resolve(res);
                                    }
                                });
                            })];
                    case 4:
                        profile = (_a.sent()).profile;
                        fileNameSuffix = Math.random().toString().replace(".0", "");
                        fs__WEBPACK_IMPORTED_MODULE_3__.writeFileSync("./profile".concat(fileNameSuffix, ".cpuprofile"), JSON.stringify(profile));
                        return [2 /*return*/];
                }
            });
        });
    };
    ProfilingService.prototype.getInteger = function (value) {
        if (typeof value === 'number') {
            if (Number.isInteger(value)) {
                return value;
            }
        }
        return undefined;
    };
    return ProfilingService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/ragdollService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/ragdollService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   RagdollService: () => (/* binding */ RagdollService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var RagdollService = /** @class */ (function (_super) {
    __extends(RagdollService, _super);
    function RagdollService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        // TODO: think about tracking ragdoll state of player
        _this.safeRemoveRagdollFromWorld = function (actor, afterRemoveCallback) {
            _this.setLocalDamageMult(0);
            actor.forceRemoveRagdollFromWorld().then(function () {
                _this.controller.once("update", function () {
                    _this.setLocalDamageMult(_this.defaultLocalDamageMult);
                    afterRemoveCallback();
                });
            });
        };
        _this.defaultLocalDamageMult = 1;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    RagdollService.prototype.onceUpdate = function () {
        this.setLocalDamageMult(this.defaultLocalDamageMult);
    };
    RagdollService.prototype.setLocalDamageMult = function (damageMult) {
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCE", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCH", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCL", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCN", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCVE", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCVH", damageMult);
    };
    return RagdollService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/remoteServer.ts":
/*!***********************************************!*\
  !*** ./src/services/services/remoteServer.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   RemoteServer: () => (/* binding */ RemoteServer),
/* harmony export */   getPcInventory: () => (/* binding */ getPcInventory)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _lib_idManager__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../lib/idManager */ "./src/lib/idManager.ts");
/* harmony import */ var _lib_nameof__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../lib/nameof */ "./src/lib/nameof.ts");
/* harmony import */ var _sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../sync/actorvalues */ "./src/sync/actorvalues.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _sync_spell__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../../sync/spell */ "./src/sync/spell.ts");
/* harmony import */ var _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ../../view/modelApplyUtils */ "./src/view/modelApplyUtils.ts");
/* harmony import */ var _loadGameService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./loadGameService */ "./src/services/services/loadGameService.ts");
/* harmony import */ var _ragdollService__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./ragdollService */ "./src/services/services/ragdollService.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _timeService__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./timeService */ "./src/services/services/timeService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _voiceChatService__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./voiceChatService */ "./src/services/services/voiceChatService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
// @ts-expect-error (TODO: Remove in 2.10.0)



/* eslint-disable @typescript-eslint/no-empty-function */













// TODO: refactor worldViewMisc into service





var getPcInventory = function () {
    var res = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['pcInv'];
    if (typeof res === 'object' && res['entries']) {
        return res;
    }
    return undefined;
};
var setPcInventory = function (inv) {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['pcInv'] = inv;
};
var pcInvLastApply = 0;
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.on)('update', function () {
    if ((0,_sync_equipment__WEBPACK_IMPORTED_MODULE_7__.isBadMenuShown)()) {
        return;
    }
    if (Date.now() - pcInvLastApply > 5000) {
        pcInvLastApply = Date.now();
        var pcInv = getPcInventory();
        if (pcInv) {
            (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_8__.applyInventory)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), pcInv, false, true);
        }
    }
});
var unequipIronHelmet = function () {
    var ironHelment = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Armor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(0x00012e4d));
    var pl = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
    if (pl) {
        pl.unequipItem(ironHelment, false, true);
    }
};
var RemoteServer = /** @class */ (function (_super) {
    __extends(RemoteServer, _super);
    function RemoteServer(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.numSetInventory = 0;
        _this.controller.emitter.on("hostStartMessage", function (e) { return _this.onHostStartMessage(e); });
        _this.controller.emitter.on("hostStopMessage", function (e) { return _this.onHostStopMessage(e); });
        _this.controller.emitter.on("setInventoryMessage", function (e) { return _this.onSetInventoryMessage(e); });
        _this.controller.emitter.on("openContainerMessage", function (e) { return _this.onOpenContainerMessage(e); });
        _this.controller.emitter.on("updateMovementMessage", function (e) { return _this.onUpdateMovementMessage(e); });
        _this.controller.emitter.on("updateAnimationMessage", function (e) { return _this.onUpdateAnimationMessage(e); });
        _this.controller.emitter.on("updateEquipmentMessage", function (e) { return _this.onUpdateEquipmentMessage(e); });
        _this.controller.emitter.on("changeValuesMessage", function (e) { return _this.onChangeValuesMessage(e); });
        _this.controller.emitter.on("updateAppearanceMessage", function (e) { return _this.onUpdateAppearanceMessage(e); });
        _this.controller.emitter.on("teleportMessage", function (e) { return _this.onTeleportMessage(e); });
        _this.controller.emitter.on("teleportMessage2", function (e) { return _this.onTeleportMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.emitter.on("destroyActorMessage", function (e) { return _this.onDestroyActorMessage(e); });
        _this.controller.emitter.on("setRaceMenuOpenMessage", function (e) { return _this.onSetRaceMenuOpenMessage(e); });
        _this.controller.emitter.on("updatePropertyMessage", function (e) { return _this.onUpdatePropertyMessage(e); });
        _this.controller.emitter.on("deathStateContainerMessage", function (e) { return _this.onDeathStateContainerMessage(e); });
        _this.controller.emitter.on("connectionAccepted", function () { return _this.handleConnectionAccepted(); });
        _this.controller.emitter.on("spellCastMessage", function (e) { return _this.onSpellCastMessage(e); });
        _this.controller.emitter.on("updateAnimVariablesMessage", function (e) { return _this.onUpdateAnimVariablesMessage(e); });
        _this.controller.emitter.on("voiceChatMessage", function (e) { return _this.onVoiceChatMessage(e); });
        _this.controller.emitter.on("updateVoiceChatMessage", function (e) { return _this.onUpdateVoiceChatMessage(e); });
        return _this;
    }
    RemoteServer.prototype.onHostStartMessage = function (event) {
        var msg = event.message;
        var target = msg.target;
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        if (typeof hosted !== typeof []) {
            // if you try to switch to Set please checkout .concat usage.
            // concat compiles but doesn't work as expected
            hosted = new Array();
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'] = hosted;
        }
        if (!hosted.includes(target)) {
            hosted.push(target);
        }
    };
    RemoteServer.prototype.onHostStopMessage = function (event) {
        var msg = event.message;
        var target = msg.target;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, 'hostStop ' + target.toString(16));
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        if (typeof hosted === typeof []) {
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'] = hosted.filter(function (x) { return x !== target; });
        }
    };
    RemoteServer.prototype.onSetInventoryMessage = function (event) {
        var _this = this;
        this.numSetInventory++;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            setPcInventory(msg.inventory);
            var blocked = false;
            _this.controller.emitter.emit('queryBlockSetInventoryEvent', {
                block: function () { return blocked = true; }
            });
            if (!blocked) {
                pcInvLastApply = 0;
            }
        });
    };
    RemoteServer.prototype.onOpenContainerMessage = function (event) {
        var _this = this;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return __awaiter(_this, void 0, void 0, function () {
            var remoteId, localId, refr, baseObject, baseType, functionChecker, factName, delaySeconds;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                    case 1:
                        _a.sent(); // Give a chance to update inventory
                        remoteId = event.message.target;
                        localId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(remoteId);
                        refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(localId));
                        if (refr === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, 'onOpenContainerMessage - refr not found', 'remoteId', remoteId.toString(16), 'localId', localId.toString(16));
                            return [2 /*return*/];
                        }
                        refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), true);
                        baseObject = refr.getBaseObject();
                        baseType = baseObject === null || baseObject === void 0 ? void 0 : baseObject.getType();
                        functionChecker = null;
                        factName = "";
                        delaySeconds = -1.0;
                        if (baseType === 28 /* FormType.Container */) {
                            functionChecker = function () { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen("ContainerMenu"); };
                            factName = "'ContainerMenu open'";
                            delaySeconds = 0.0;
                        }
                        else if (baseType === 40 /* FormType.Furniture */) {
                            functionChecker = function () { var _a; return !!((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.getFurnitureReference()); };
                            factName = "'getFurnitureReference not null'";
                            delaySeconds = 1.0;
                        }
                        if (functionChecker === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - not a container or furniture", baseType);
                            return [2 /*return*/];
                        }
                        // In SkyMP containers have 2-nd, closing activation under the hood.
                        // This differs from Skyrim's behavior, where it's just one activation.
                        (function () { return __awaiter(_this, void 0, void 0, function () {
                            var message;
                            var _this = this;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting for", factName, "to be true");
                                        _a.label = 1;
                                    case 1:
                                        if (!!functionChecker()) return [3 /*break*/, 3];
                                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                                    case 2:
                                        _a.sent();
                                        return [3 /*break*/, 1];
                                    case 3:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting for", factName, "to be false");
                                        _a.label = 4;
                                    case 4:
                                        if (!functionChecker()) return [3 /*break*/, 6];
                                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                                    case 5:
                                        _a.sent();
                                        return [3 /*break*/, 4];
                                    case 6:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - menu closed", factName);
                                        message = {
                                            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.Activate,
                                            data: {
                                                caster: 0x14, target: event.message.target, isSecondActivation: true
                                            }
                                        };
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting", delaySeconds, "seconds before sending ActivateMessage");
                                        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.waitMenuMode(delaySeconds).then(function () {
                                            _this.controller.emitter.emit("sendMessage", {
                                                message: message,
                                                reliability: "reliable"
                                            });
                                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "onOpenContainerMesage - sent ActivateMessage", message);
                                        });
                                        return [2 /*return*/];
                                }
                            });
                        }); })();
                        return [2 /*return*/];
                }
            });
        }); });
    };
    RemoteServer.prototype.onTeleportMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var id = ("idx" in msg && typeof msg.idx === "number") ? _this.getIdManager().getId(msg.idx) : _this.getMyActorIndex();
            var refr = id === _this.getMyActorIndex() ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer() : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getObjectReference)(id);
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "Teleporting id", id, "refrId", refr === null || refr === void 0 ? void 0 : refr.getFormID().toString(16), "...", msg.pos, 'cell/world is', msg.worldOrCell.toString(16));
            var ragdollService = _this.controller.lookupListener(_ragdollService__WEBPACK_IMPORTED_MODULE_12__.RagdollService);
            var refrId = refr === null || refr === void 0 ? void 0 : refr.getFormID();
            var removeRagdollCallback = function () {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.moveRefrToPosition(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId || 0)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Cell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.worldOrCell)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.WorldSpace.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.worldOrCell)), msg.pos[0], msg.pos[1], msg.pos[2], msg.rot[0], msg.rot[1], msg.rot[2]);
            };
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor /*&& actor.getFormID() === 0x14*/) {
                ragdollService.safeRemoveRagdollFromWorld(actor, removeRagdollCallback);
            }
            else {
                removeRagdollCallback();
            }
        });
    };
    RemoteServer.prototype.onCreateActorMessage = function (event) {
        var _this = this;
        var _a;
        var msg = event.message;
        if (this.skipFormViewCreation(msg)) {
            var refrId_1 = msg.refrId;
            this.onceLoad(refrId_1, function (refr) {
                var _a;
                if (refr) {
                    _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.dealWithRef(refr, refr.getBaseObject());
                    if (msg.props) {
                        if (msg.props.inventory) {
                            _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelInventory(refr, msg.props.inventory);
                        }
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsOpen(refr, !!msg.props['isOpen']);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsHarvested(refr, !!msg.props['isHarvested']);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelNodeScale(refr, msg.props.setNodeScale);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelNodeTextureSet(refr, msg.props.setNodeTextureSet);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsDisabled(refr, !!msg.props['disabled']);
                        // TODO: move to a separate module
                        var animation_1 = msg.props.lastAnimation;
                        if (typeof animation_1 === "string") {
                            var refrid_1 = refr.getFormID();
                            (function () { return __awaiter(_this, void 0, void 0, function () {
                                var i_1, res2;
                                var _a;
                                return __generator(this, function (_b) {
                                    switch (_b.label) {
                                        case 0:
                                            i_1 = 0;
                                            _b.label = 1;
                                        case 1:
                                            if (!(i_1 < 5)) return [3 /*break*/, 4];
                                            res2 = (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrid_1))) === null || _a === void 0 ? void 0 : _a.playAnimation(animation_1);
                                            if (res2) {
                                                return [3 /*break*/, 4];
                                            }
                                            return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(2)];
                                        case 2:
                                            _b.sent();
                                            _b.label = 3;
                                        case 3:
                                            i_1++;
                                            return [3 /*break*/, 1];
                                        case 4: return [2 /*return*/];
                                    }
                                });
                            }); })();
                        }
                        var displayName = msg.props.displayName;
                        // keep in sync with spSnippetService.ts
                        if (typeof displayName === "string") {
                            var replaceValue = (_a = refr.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getName();
                            if (replaceValue !== undefined) {
                                displayName = displayName.replace(/%original_name%/g, replaceValue);
                            }
                            else {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, "Couldn't get a replaceValue for SetDisplayName, refr.getFormID() was", refr.getFormID().toString(16));
                            }
                            refr.setDisplayName(displayName, true);
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "calling setDisplayName", displayName, "for", refr.getFormID().toString(16));
                        }
                    }
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed to apply model to', refrId_1.toString(16));
                }
            });
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Create actor");
        var i = this.getIdManager().allocateIdFor(msg.idx);
        if (this.worldModel.forms.length <= i) {
            this.worldModel.forms.length = i + 1;
        }
        var movement = undefined;
        // TODO: better check if it is an npc (not an object reference)
        if (msg.refrId !== undefined && msg.refrId >= 0xff000000) {
            movement = {
                pos: msg.transform.pos,
                rot: msg.transform.rot,
                worldOrCell: msg.transform.worldOrCell,
                runMode: 'Standing',
                direction: 0,
                isInJumpState: false,
                isSneaking: false,
                isBlocking: false,
                isWeapDrawn: false,
                isDead: false,
                healthPercentage: 1.0,
                speed: 0,
            };
        }
        var form = {
            idx: msg.idx,
            movement: movement,
            numMovementChanges: 0,
            numAppearanceChanges: 0,
            baseId: msg.baseId,
            refrId: msg.refrId,
            isMyClone: msg.isMe,
        };
        this.worldModel.forms[i] = form;
        if (msg.appearance) {
            form.appearance = msg.appearance;
        }
        if (msg.equipment) {
            form.equipment = msg.equipment;
        }
        if (msg.isDead) {
            form.isDead = msg.isDead;
        }
        if (msg.animation) {
            form.animation = msg.animation;
        }
        if (msg.props) {
            for (var propName in msg.props) {
                form[propName] = msg.props[propName];
            }
        }
        msg.customPropsJsonDumps.forEach(function (element) {
            var _a;
            var parsed;
            try {
                parsed = JSON.parse(element.propValueJsonDump);
            }
            catch (e) {
                if (e instanceof SyntaxError) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, "createActor", (_a = msg.refrId) === null || _a === void 0 ? void 0 : _a.toString(16), "failed to parse custom prop", element.propName, element.propValueJsonDump, e.message);
                }
                else {
                    throw e;
                }
            }
            form[element.propName] = parsed;
        });
        if (msg.isMe) {
            this.worldModel.playerCharacterFormIdx = i;
            this.worldModel.playerCharacterRefrId = msg.refrId || 0;
        }
        // TODO: move to a separate module
        if (msg.props && !msg.props.isHostedByOther) {
        }
        if (msg.props && msg.props.isRaceMenuOpen && msg.isMe) {
            this.onSetRaceMenuOpenMessage({ message: { t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.SetRaceMenuOpen, open: true } });
        }
        var numSetInventory = this.numSetInventory;
        var applyPcInv = function () {
            if (msg.equipment) {
                (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_7__.applyEquipment)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), msg.equipment);
            }
            if (numSetInventory !== _this.numSetInventory) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, 'Skipping inventory apply due to newer setInventory message');
                return;
            }
            if (msg.props && msg.props.inventory) {
                _this.onSetInventoryMessage({
                    message: {
                        t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.SetInventory,
                        inventory: msg.props.inventory
                    }
                });
            }
        };
        if (msg.isMe && msg.props && msg.props.learnedSpells) {
            var learnedSpells_1 = msg.props.learnedSpells;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(function () {
                    var player = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                    if (player) {
                        (0,_sync_spell__WEBPACK_IMPORTED_MODULE_9__.removeAllSpells)(player);
                        (0,_sync_spell__WEBPACK_IMPORTED_MODULE_9__.learnSpells)(player, learnedSpells_1);
                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "player learnedSpells:", JSON.stringify(learnedSpells_1));
                    }
                });
            });
        }
        if (msg.isMe) {
            if ((_a = msg.props) === null || _a === void 0 ? void 0 : _a.isDead) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
                    _this.controller.emitter.emit("applyDeathStateEvent", {
                        actor: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(),
                        isDead: true
                    });
                });
            }
        }
        if (msg.isMe) {
            var spawnTask_1 = { running: false };
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                // Use MoveRefrToPosition to spawn if possible (not in main menu)
                // In case of connection lost this is essential
                if (!spawnTask_1.running) {
                    spawnTask_1.running = true;
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, 'Using moveRefrToPosition to spawn player');
                    (function () { return __awaiter(_this, void 0, void 0, function () {
                        var pl, pos, sqr, distance;
                        return __generator(this, function (_a) {
                            switch (_a.label) {
                                case 0:
                                    if (false) {}
                                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, 'Spawning...');
                                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.moveRefrToPosition(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Cell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.transform.worldOrCell)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.WorldSpace.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.transform.worldOrCell)), msg.transform.pos[0], msg.transform.pos[1], msg.transform.pos[2], msg.transform.rot[0], msg.transform.rot[1], msg.transform.rot[2]);
                                    return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1)];
                                case 1:
                                    _a.sent();
                                    pl = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                                    if (!pl) {
                                        return [3 /*break*/, 2];
                                    }
                                    pos = [
                                        pl.getPositionX(),
                                        pl.getPositionY(),
                                        pl.getPositionZ(),
                                    ];
                                    sqr = function (x) { return x * x; };
                                    distance = Math.sqrt(sqr(pos[0] - msg.transform.pos[0]) +
                                        sqr(pos[1] - msg.transform.pos[1]));
                                    if (distance < 256) {
                                        return [3 /*break*/, 2];
                                    }
                                    return [3 /*break*/, 0];
                                case 2: return [2 /*return*/];
                            }
                        });
                    }); })();
                    // Unfortunatelly it requires two calls to work
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(applyPcInv);
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1.3).then(applyPcInv);
                    // Note: appearance part was copy-pasted
                    if (msg.appearance) {
                        (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(msg.appearance);
                    }
                }
                if (msg.props) {
                    var baseActorValues_1 = new Map([
                        ['healRate', msg.props.healRate],
                        ['healRateMult', msg.props.healRateMult],
                        ['health', msg.props.health],
                        ['magickaRate', msg.props.magickaRate],
                        ['magickaRateMult', msg.props.magickaRateMult],
                        ['magicka', msg.props.magicka],
                        ['staminaRate', msg.props.staminaRate],
                        ['staminaRateMult', msg.props.staminaRateMult],
                        ['stamina', msg.props.stamina],
                        ['healthPercentage', msg.props.healthPercentage],
                        ['staminaPercentage', msg.props.staminaPercentage],
                        ['magickaPercentage', msg.props.magickaPercentage],
                    ]);
                    var player_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                    if (player_1) {
                        baseActorValues_1.forEach(function (value, key) {
                            if (typeof value === 'number') {
                                if (key.includes('Percentage')) {
                                    var subKey = key.replace('Percentage', '');
                                    var subValue = baseActorValues_1.get(subKey);
                                    if (typeof subValue === 'number') {
                                        (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(player_1, subKey, value);
                                    }
                                }
                                else {
                                    player_1.setActorValue(key, value);
                                }
                            }
                        });
                    }
                }
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('tick', function () {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('tick', function () {
                    if (!spawnTask_1.running) {
                        spawnTask_1.running = true;
                        var loadOrder = new Array();
                        for (var i_2 = 0; i_2 < _this.sp.Game.getModCount(); ++i_2) {
                            loadOrder.push(_this.sp.Game.getModName(i_2));
                        }
                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "loading game in world/cell", msg.transform.worldOrCell.toString(16));
                        var loadGameService = _this.controller.lookupListener(_loadGameService__WEBPACK_IMPORTED_MODULE_11__.LoadGameService);
                        loadGameService.loadGame(msg.transform.pos, msg.transform.rot, msg.transform.worldOrCell, msg.appearance
                            ? {
                                name: msg.appearance.name,
                                raceId: msg.appearance.raceId,
                                // TODO: In types, isFemale is under face, but in the reality SP expects it here. Fix required.
                                // @ts-expect-error
                                isFemale: msg.appearance.isFemale,
                                face: {
                                    hairColor: msg.appearance.hairColor,
                                    bodySkinColor: msg.appearance.skinColor,
                                    headTextureSetId: msg.appearance.headTextureSetId,
                                    headPartIds: msg.appearance.headpartIds,
                                    presets: msg.appearance.presets
                                },
                            }
                            : undefined, loadOrder, { minutes: 0, seconds: 0, hours: _this.controller.lookupListener(_timeService__WEBPACK_IMPORTED_MODULE_16__.TimeService).getTime().newGameHourValue });
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                            applyPcInv();
                            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.3).then(applyPcInv);
                            // Note: appearance part was copy-pasted
                            if (msg.appearance) {
                                (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(msg.appearance);
                            }
                        });
                    }
                });
            });
        }
    };
    RemoteServer.prototype.onDestroyActorMessage = function (event) {
        var _a;
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        this.worldModel.forms[i] = undefined;
        (_a = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getViewFromStorage)()) === null || _a === void 0 ? void 0 : _a.syncFormArray(this.worldModel);
        // Shrink to fit
        while (1) {
            var length = this.worldModel.forms.length;
            if (!length) {
                break;
            }
            if (this.worldModel.forms[length - 1]) {
                break;
            }
            this.worldModel.forms.length = length - 1;
        }
        if (this.worldModel.playerCharacterFormIdx === i) {
            this.worldModel.playerCharacterFormIdx = -1;
            this.worldModel.playerCharacterRefrId = 0;
            // TODO: move to a separate module
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.quitToMainMenu(); });
        }
        this.getIdManager().freeIdFor(msg.idx);
    };
    RemoteServer.prototype.onUpdateMovementMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateMovementMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.movement = msg.data;
        if (!form.numMovementChanges) {
            form.numMovementChanges = 0;
        }
        form.numMovementChanges++;
    };
    RemoteServer.prototype.onUpdateAnimationMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateAnimationMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.animation = msg.data;
    };
    RemoteServer.prototype.onUpdateAppearanceMessage = function (event) {
        var _this = this;
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateAppearanceMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.appearance = msg.data || undefined;
        if (!form.numAppearanceChanges) {
            form.numAppearanceChanges = 0;
        }
        form.numAppearanceChanges++;
        var newAppearance = msg.data;
        if (i === this.getMyActorIndex() && newAppearance) {
            this.controller.once("update", function () {
                (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(newAppearance);
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "Applied appearance to the player");
            });
        }
    };
    RemoteServer.prototype.onUpdateEquipmentMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateEquipmentMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.equipment = msg.data;
    };
    RemoteServer.prototype.onUpdatePropertyMessage = function (event) {
        var _this = this;
        var msg = event.message;
        var msgData = this.extractUpdatePropertyMessageData(msg);
        if (this.skipFormViewCreation(msg)) {
            var refrId_2 = msg.refrId;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId_2));
                if (!refr) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'UpdateProperty: refr not found');
                    return;
                }
                if (msg.propName === 'inventory') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelInventory(refr, msgData);
                }
                else if (msg.propName === 'isOpen') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsOpen(refr, !!msgData);
                }
                else if (msg.propName === 'isHarvested') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsHarvested(refr, !!msgData);
                }
                else if (msg.propName === 'disabled') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsDisabled(refr, !!msgData);
                }
            });
            return;
        }
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        form[msg.propName] = msgData;
    };
    RemoteServer.prototype.onDeathStateContainerMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Received death state:", JSON.stringify(msg.tIsDead));
        var id = this.getIdManager().getId(msg.tIsDead.idx);
        var form = this.worldModel.forms[id];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Form with idx", msg.tIsDead.idx, "not found");
            return;
        }
        if (msg.tIsDead.propName !== (0,_lib_nameof__WEBPACK_IMPORTED_MODULE_4__.nameof)('isDead')) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Invalid propName", msg.tIsDead.propName);
            return;
        }
        var msgData = this.extractUpdatePropertyMessageData(msg.tIsDead);
        if (typeof msgData !== 'boolean') {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Invalid data", msgData);
            return;
        }
        if (msg.tChangeValues) {
            this.onChangeValuesMessage({ message: msg.tChangeValues });
        }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return _this.onUpdatePropertyMessage({ message: msg.tIsDead }); });
        if (msg.tTeleport) {
            this.onTeleportMessage({ message: msg.tTeleport });
        }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var _a;
            var actor = id === _this.getWorldModel().playerCharacterFormIdx
                ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()
                : skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)((_a = form.refrId) !== null && _a !== void 0 ? _a : 0)));
            if (actor) {
                try {
                    _this.controller.emitter.emit("applyDeathStateEvent", {
                        actor: actor,
                        isDead: msgData
                    });
                }
                catch (e) {
                    if (e instanceof _lib_errors__WEBPACK_IMPORTED_MODULE_13__.RespawnNeededError) {
                        actor.disableNoWait(false);
                        actor.delete();
                    }
                    else {
                        throw e;
                    }
                }
            }
        });
    };
    RemoteServer.prototype.handleConnectionAccepted = function () {
        this.worldModel.forms = [];
        this.worldModel.playerCharacterFormIdx = -1;
        this.worldModel.playerCharacterRefrId = 0;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Handle connection accepted");
    };
    RemoteServer.prototype.onChangeValuesMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var id = _this.getIdManager().getId(msg.idx);
            var refr = id === _this.getMyActorIndex() ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer() : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getObjectReference)(id);
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (!ac) {
                return;
            }
            var _a = msg.data, health = _a.health, stamina = _a.stamina, magicka = _a.magicka;
            if (typeof health === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'health', health);
            }
            if (typeof stamina === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'stamina', stamina);
            }
            if (typeof magicka === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'magicka', magicka);
            }
        });
    };
    RemoteServer.prototype.onSetRaceMenuOpenMessage = function (event) {
        var msg = event.message;
        if (msg.open) {
            // wait 0.3s cause we can see visual bugs when teleporting
            // and showing this menu at the same time in onConnect
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.3).then(function () {
                    unequipIronHelmet();
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.showRaceMenu();
                });
            });
        }
        else {
            // TODO: Implement closeMenu in SkyrimPlatform
        }
    };
    /** Packet handlers end **/
    RemoteServer.prototype.getWorldModel = function () {
        return this.worldModel;
    };
    RemoteServer.prototype.getMyActorIndex = function () {
        return this.worldModel.playerCharacterFormIdx;
    };
    RemoteServer.prototype.getMyRemoteRefrId = function () {
        return this.worldModel.playerCharacterRefrId;
    };
    RemoteServer.prototype.getIdManager = function () {
        return this.idManager_;
    };
    Object.defineProperty(RemoteServer.prototype, "worldModel", {
        get: function () {
            if (typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"] === "function") {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"] = { forms: [], playerCharacterFormIdx: -1, playerCharacterRefrId: 0 };
            }
            return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"];
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(RemoteServer.prototype, "idManager_", {
        get: function () {
            if (typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"] === "function") {
                // Note: full IdManager object preserved across hot-reloads, including methods.
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"] = new _lib_idManager__WEBPACK_IMPORTED_MODULE_3__.IdManager();
            }
            return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"];
        },
        enumerable: false,
        configurable: true
    });
    RemoteServer.prototype.onceLoad = function (refrId, callback, maxAttempts) {
        var _this = this;
        if (maxAttempts === void 0) { maxAttempts = 120; }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
            if (refr) {
                callback(refr);
            }
            else {
                maxAttempts--;
                if (maxAttempts > 0) {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return _this.onceLoad(refrId, callback, maxAttempts); });
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed to load object reference ' + refrId.toString(16));
                }
            }
        });
    };
    ;
    RemoteServer.prototype.skipFormViewCreation = function (msg) {
        // Optimization added in #1186, however it doesn't work for doors for some reason
        return msg.refrId && msg.refrId < 0xff000000 && msg.baseRecordType !== 'DOOR';
    };
    ;
    RemoteServer.prototype.extractUpdatePropertyMessageData = function (updatePropertyMessage) {
        var msgData = updatePropertyMessage.data;
        if (updatePropertyMessage.dataDump !== undefined) {
            try {
                msgData = JSON.parse(updatePropertyMessage.dataDump);
            }
            catch (e) {
                if (e instanceof SyntaxError) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, 'extractUpdatePropertyMessageData - Failed to parse dataDump', updatePropertyMessage.dataDump);
                    return;
                }
                else {
                    throw e;
                }
            }
        }
        return msgData;
    };
    RemoteServer.prototype.onSpellCastMessage = function (event) {
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.caster)));
            if (!ac) {
                return;
            }
            var actorAnimationVariables = {
                booleans: new Uint8Array(msg.data.actorAnimationVariables.booleans),
                floats: new Uint8Array(msg.data.actorAnimationVariables.floats),
                integers: new Uint8Array(msg.data.actorAnimationVariables.integers)
            };
            if (msg.data.interruptCast) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.interruptCast)(ac.getFormID(), msg.data.castingSource, actorAnimationVariables);
                return;
            }
            var spell = ac.getEquippedSpell(msg.data.castingSource);
            if (spell) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.castSpellImmediate)(ac.getFormID(), msg.data.castingSource, spell.getFormID(), (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.target), msg.data.aimAngle, msg.data.aimHeading, actorAnimationVariables);
            }
        });
    };
    RemoteServer.prototype.onUpdateAnimVariablesMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.actorRemoteId)));
            if (!ac) {
                return;
            }
            var actorAnimationVariables = {
                booleans: new Uint8Array(msg.data.actorAnimationVariables.booleans),
                floats: new Uint8Array(msg.data.actorAnimationVariables.floats),
                integers: new Uint8Array(msg.data.actorAnimationVariables.integers)
            };
            var isApplyed = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.applyAnimationVariablesToActor)(ac.getFormID(), actorAnimationVariables);
            if (!isApplyed) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed apply AnimationVariables to actor with id: ' + ac.getFormID().toString(16));
            }
        });
    };
    RemoteServer.prototype.onVoiceChatMessage = function (event) {
        var msg = event.message;
        // Update form model with isTalking state
        var speakerForm = this.worldModel.forms.find(function (f) { return f && f.refrId === msg.data.speakerId; });
        if (speakerForm) {
            speakerForm.isTalking = msg.data.isTalking;
        }
        // Forward to VoiceChatService for processing
        var voiceChatService = this.controller.lookupListener(_voiceChatService__WEBPACK_IMPORTED_MODULE_18__.VoiceChatService);
        if (voiceChatService) {
            var audioData = new Uint8Array(msg.data.audioData);
            voiceChatService.onReceiveVoiceData(msg.data.speakerId, audioData.buffer, 0, 0, 0);
        }
    };
    RemoteServer.prototype.onUpdateVoiceChatMessage = function (event) {
        var msg = event.message;
        // Update form model with isTalking state
        var speakerForm = this.worldModel.forms.find(function (f) { return f && f.refrId === msg.data.speakerId; });
        if (speakerForm) {
            speakerForm.isTalking = msg.data.isTalking;
        }
        // Forward to VoiceChatService with 3D position data
        var voiceChatService = this.controller.lookupListener(_voiceChatService__WEBPACK_IMPORTED_MODULE_18__.VoiceChatService);
        if (voiceChatService) {
            var audioData = new Uint8Array(msg.data.audioData);
            voiceChatService.onReceiveVoiceData(msg.data.speakerId, audioData.buffer, msg.data.position[0], // x
            msg.data.position[1], // y
            msg.data.position[2] // z
            );
        }
    };
    return RemoteServer;
}(_clientListener__WEBPACK_IMPORTED_MODULE_14__.ClientListener));



/***/ }),

/***/ "./src/services/services/sendInputsService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/sendInputsService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SendInputsService: () => (/* binding */ SendInputsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _singlePlayerService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_movementGet__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/movementGet */ "./src/sync/movementGet.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_actorvalues__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../sync/actorvalues */ "./src/sync/actorvalues.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _view_hostAttempts__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../../view/hostAttempts */ "./src/view/hostAttempts.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _deathService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./deathService */ "./src/services/services/deathService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




// TODO: refactor this out









var playerFormId = 0x14;
// TODO: split this service into EquipmentService, MovementService, AnimationService, ActorValueService, HostAttemptsService
var SendInputsService = /** @class */ (function (_super) {
    __extends(SendInputsService, _super);
    function SendInputsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastSendMovementMoment = new Map();
        _this.playerAnimSource = new Map(); // TODO: make service
        _this.lastAnimationSent = new Map();
        _this.actorValuesNeedUpdate = false;
        _this.isRaceSexMenuShown = false;
        _this.equipmentChanged = false;
        _this.numEquipmentChanges = 0;
        _this.prevValues = { health: 0, stamina: 0, magicka: 0 };
        _this.prevActorValuesUpdateTime = 0;
        _this.prevCastingDetectedTime = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.on("equip", function (e) { return _this.onEquip(e); });
        _this.controller.on("unequip", function (e) { return _this.onUnequip(e); });
        _this.controller.on("loadGame", function () { return _this.onLoadGame(); });
        return _this;
    }
    SendInputsService.prototype.onUpdate = function () {
        if (!this.singlePlayerService.isSinglePlayer) {
            this.sendInputs();
            var player = this.sp.Game.getPlayer();
            var isPlayerCasting = player.getAnimationVariableBool("IsCastingRight")
                || player.getAnimationVariableBool("IsCastingLeft")
                || player.getAnimationVariableBool("IsCastingDual");
            if (isPlayerCasting) {
                this.prevCastingDetectedTime = Date.now();
            }
        }
    };
    SendInputsService.prototype.onEquip = function (event) {
        if (!event.actor || !event.baseObj) {
            return;
        }
        if (event.actor.getFormID() !== playerFormId) {
            return;
        }
        var type = event.baseObj.getType();
        if (type !== 27 /* FormType.Book */ && type !== 46 /* FormType.Potion */ && type !== 30 /* FormType.Ingredient */) {
            // Trigger UpdateEquipment only for equips that are not spell tomes, potions, ingredients
            this.equipmentChanged = true;
        }
        // Send OnEquip for any equips including spell tomes, potions, ingredients
        // Otherwise, the server won't trigger spell learn, potion drink, ingredient eat and Papyrus scripts
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.OnEquip, baseId: event.baseObj.getFormID() },
            reliability: "unreliable"
        });
    };
    SendInputsService.prototype.onUnequip = function (event) {
        if (!event.actor || !event.baseObj) {
            return;
        }
        if (event.actor.getFormID() === playerFormId) {
            this.equipmentChanged = true;
        }
    };
    SendInputsService.prototype.onLoadGame = function () {
        var _this = this;
        // Currently only armor is equipped after relogging (see remoteServer.ts)
        // This hack forces sending /equipment without weapons/ back to the server
        this.sp.Utility.wait(3).then(function () { return (_this.equipmentChanged = true); });
    };
    SendInputsService.prototype.sendInputs = function () {
        var _this = this;
        var hosted = typeof this.sp.storage['hosted'] === typeof [] ? this.sp.storage['hosted'] : [];
        var targets = [undefined].concat(hosted);
        var modelSource = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_10__.RemoteServer);
        var world = modelSource.getWorldModel();
        targets.forEach(function (target) {
            var targetFormModel = target ? _this.getForm(target, world) : _this.getForm(undefined, world);
            _this.sendMovement(target, targetFormModel);
            _this.sendAnimation(target);
            _this.sendAppearance(target);
            _this.sendEquipment(target);
            _this.sendActorValuePercentage(target, targetFormModel);
        });
        this.sendHostAttempts();
    };
    SendInputsService.prototype.sendMovement = function (_refrId, form) {
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        var refrIdStr = "".concat(_refrId);
        var sendMovementRateMs = 130;
        var now = Date.now();
        var last = this.lastSendMovementMoment.get(refrIdStr);
        if (!last || now - last > sendMovementRateMs) {
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateMovement,
                data: (0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_3__.getMovement)(owner, form),
                _refrId: _refrId
            };
            this.controller.emitter.emit("sendMessageWithRefrId", {
                message: message,
                reliability: "unreliable"
            });
            this.lastSendMovementMoment.set(refrIdStr, now);
        }
    };
    SendInputsService.prototype.sendActorValuePercentage = function (_refrId, form) {
        var _a;
        var canSend = form && ((_a = form.isDead) !== null && _a !== void 0 ? _a : false) === false;
        if (!canSend) {
            return;
        }
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        var av = (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_7__.getActorValues)(this.sp.Game.getPlayer());
        var currentTime = Date.now();
        if (this.actorValuesNeedUpdate === false &&
            this.prevValues.health === av.health &&
            this.prevValues.stamina === av.stamina &&
            this.prevValues.magicka === av.magicka) {
            return;
        }
        if (currentTime - this.prevActorValuesUpdateTime < 2000 &&
            this.actorValuesNeedUpdate === false) {
            return;
        }
        // Delaying actor values update due to casting
        // TODO: use partial updates for actor values once server finally supports it
        // i.e. keep sending health and stamina during casting, but delay magicka update
        if (currentTime - this.prevCastingDetectedTime < 500 &&
            av.health > 0 // don't delay death actor value update
        ) {
            return;
        }
        var deathService = this.controller.lookupListener(_deathService__WEBPACK_IMPORTED_MODULE_11__.DeathService);
        if (deathService.isBusy()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_12__.logTrace)(this, "Not sending actor values, death service is busy");
            return;
        }
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.ChangeValues,
            data: av,
            _refrId: _refrId
        };
        this.controller.emitter.emit("sendMessageWithRefrId", {
            message: message,
            reliability: "unreliable"
        });
        this.actorValuesNeedUpdate = false;
        this.prevValues = av;
        this.prevActorValuesUpdateTime = currentTime;
    };
    SendInputsService.prototype.sendAnimation = function (_refrId) {
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        // Extermly important that it's a local id since AnimationSource depends on it
        var refrIdStr = owner.getFormID().toString(16);
        var animSource = this.playerAnimSource.get(refrIdStr);
        if (!animSource) {
            animSource = new _sync_animation__WEBPACK_IMPORTED_MODULE_5__.AnimationSource(owner);
            this.playerAnimSource.set(refrIdStr, animSource);
        }
        var anim = animSource.getAnimation();
        var lastAnimationSent = this.lastAnimationSent.get(refrIdStr);
        if (!lastAnimationSent ||
            anim.numChanges !== lastAnimationSent.numChanges) {
            // Drink potion anim from this mod https://www.nexusmods.com/skyrimspecialedition/mods/97660
            if (anim.animEventName !== '' && !anim.animEventName.startsWith("DrinkPotion_")) {
                this.lastAnimationSent.set(refrIdStr, anim);
                this.updateActorValuesAfterAnimation(anim.animEventName);
                var message = {
                    t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimation,
                    data: anim,
                    _refrId: _refrId
                };
                this.controller.emitter.emit("sendMessageWithRefrId", {
                    message: message,
                    reliability: "unreliable"
                });
            }
        }
    };
    SendInputsService.prototype.sendAppearance = function (_refrId) {
        if (_refrId) {
            return;
        }
        var shown = this.sp.Ui.isMenuOpen('RaceSex Menu');
        if (shown != this.isRaceSexMenuShown) {
            this.isRaceSexMenuShown = shown;
            if (!shown) {
                this.sp.printConsole('Exited from race menu');
                var appearance = (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.getAppearance)(this.sp.Game.getPlayer());
                // TODO: log appearance contents to debug appearance issues?
                var message = {
                    t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAppearance,
                    data: appearance,
                    _refrId: _refrId
                };
                this.controller.emitter.emit("sendMessageWithRefrId", {
                    message: message,
                    reliability: "reliable"
                });
            }
        }
    };
    SendInputsService.prototype.sendEquipment = function (_refrId) {
        if (_refrId) {
            return;
        }
        if (this.equipmentChanged) {
            this.equipmentChanged = false;
            ++this.numEquipmentChanges;
            var eq = (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_8__.getEquipment)(this.sp.Game.getPlayer(), this.numEquipmentChanges);
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateEquipment,
                data: eq,
                _refrId: _refrId
            };
            this.controller.emitter.emit("sendMessageWithRefrId", {
                message: message,
                reliability: "reliable"
            });
        }
    };
    SendInputsService.prototype.sendHostAttempts = function () {
        var remoteId = (0,_view_hostAttempts__WEBPACK_IMPORTED_MODULE_9__.nextHostAttempt)();
        if (!remoteId) {
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Host,
                remoteId: remoteId
            },
            reliability: "unreliable"
        });
    };
    SendInputsService.prototype.getInputOwner = function (_refrId) {
        return _refrId
            ? this.sp.Actor.from(this.sp.Game.getFormEx(_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_4__.remoteIdToLocalId(_refrId)))
            : this.sp.Game.getPlayer();
    };
    SendInputsService.prototype.getForm = function (refrId, world) {
        var form = refrId
            ? world === null || world === void 0 ? void 0 : world.forms.find(function (f) { return (f === null || f === void 0 ? void 0 : f.refrId) === refrId; })
            : world.forms[world.playerCharacterFormIdx];
        return form;
    };
    SendInputsService.prototype.updateActorValuesAfterAnimation = function (animName) {
        if (animName === 'JumpLand' ||
            animName === 'JumpLandDirectional' ||
            animName === 'DeathAnim') {
            this.actorValuesNeedUpdate = true;
        }
    };
    Object.defineProperty(SendInputsService.prototype, "singlePlayerService", {
        get: function () {
            return this.controller.lookupListener(_singlePlayerService__WEBPACK_IMPORTED_MODULE_1__.SinglePlayerService);
        },
        enumerable: false,
        configurable: true
    });
    return SendInputsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/serverJsVerificationService.ts":
/*!**************************************************************!*\
  !*** ./src/services/services/serverJsVerificationService.ts ***!
  \**************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ServerJsVerificationService: () => (/* binding */ ServerJsVerificationService)
/* harmony export */ });
/* harmony import */ var node_crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! node:crypto */ "node:crypto");
/* harmony import */ var node_crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(node_crypto__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var ServerJsVerificationService = /** @class */ (function (_super) {
    __extends(ServerJsVerificationService, _super);
    function ServerJsVerificationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        return _this;
    }
    ServerJsVerificationService.prototype.verifyServerJs = function (src) {
        if (!src) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Empty server JS, skipping verification');
            return { src: src, error: null };
        }
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_2__.SettingsService);
        var getTargetPeerResult = settingsService.getTargetPeer();
        if (!getTargetPeerResult.targetPeerCached) {
            return { src: null, error: 'target peer not ready' };
        }
        var publicKeys = getTargetPeerResult.targetPeerCached.publicKeys;
        if (!publicKeys) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'No public keys configured, skipping server JS verification');
            return { src: src, error: null };
        }
        var lastLineStart = src.lastIndexOf('\n') + 1;
        var sigPrefix = '// skymp:sig:y:';
        if (lastLineStart === 0 || !src.substring(lastLineStart).startsWith(sigPrefix)) {
            return { src: null, error: 'no signature found' };
        }
        var _a = src.substring(lastLineStart + sigPrefix.length).split(':'), keyId = _a[0], sig = _a[1];
        if (!this.isAlphaNumeric(keyId)) {
            return { src: null, error: 'malformed key id' };
        }
        var key = publicKeys[keyId];
        if (!key) {
            return { src: null, error: 'unknown key' };
        }
        var toVerify = this.toArrayBufferView(src.substring(0, lastLineStart - 1), 'utf8');
        if (!(0,node_crypto__WEBPACK_IMPORTED_MODULE_0__.verify)(null, toVerify, key, this.toArrayBufferView(sig, 'base64'))) {
            return { src: null, error: 'bad signature' };
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Server JS verified with key ".concat(keyId));
        return { src: src, error: null };
    };
    ServerJsVerificationService.prototype.isAlphaNumeric = function (str) {
        for (var i = 0; i < str.length; ++i) {
            var code = str.charCodeAt(i);
            if (!((97 <= code && code <= 122) ||
                (65 <= code && code <= 90) ||
                (48 <= code && code <= 57))) {
                return false;
            }
        }
        return true;
    };
    ServerJsVerificationService.prototype.toArrayBufferView = function (str, enc) {
        var buf = Buffer.from(str, enc);
        return new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);
    };
    return ServerJsVerificationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/settingsService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/settingsService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SettingsService: () => (/* binding */ SettingsService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _authService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./authService */ "./src/services/services/authService.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _timersService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};





var SettingsService = /** @class */ (function (_super) {
    __extends(SettingsService, _super);
    function SettingsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.targetPeerCache = null;
        return _this;
    }
    SettingsService.prototype.getServerMasterKey = function () {
        var masterKey = this.sp.settings["skymp5-client"]["server-master-key"];
        if (!masterKey) {
            masterKey = this.sp.settings["skymp5-client"]["master-key"];
        }
        if (!masterKey) {
            masterKey = this.sp.settings["skymp5-client"]["server-ip"] + ":" + this.sp.settings["skymp5-client"]["server-port"];
        }
        return masterKey;
    };
    SettingsService.prototype.getMasterUrl = function () {
        return this.normalizeUrl(this.sp.settings["skymp5-client"]["master"] || "https://gateway.skymp.net");
    };
    SettingsService.prototype.makeMasterApiClient = function () {
        var masterApiBaseUrl = this.getMasterUrl();
        return new skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.HttpClient(masterApiBaseUrl);
    };
    SettingsService.prototype.getTargetPeer = function (callback) {
        var _this = this;
        if (this.targetPeerCache) {
            callback === null || callback === void 0 ? void 0 : callback(this.targetPeerCache);
            return { targetPeerCached: this.targetPeerCache };
        }
        this.getTargetPeerImpl(function (targetPeer) {
            _this.targetPeerCache = targetPeer;
            callback === null || callback === void 0 ? void 0 : callback(targetPeer);
        });
        return { targetPeerCached: null };
    };
    // have to use callbacks here: promises don't work in the main menu
    SettingsService.prototype.getTargetPeerImpl = function (callback) {
        var _this = this;
        var masterApiClient = this.makeMasterApiClient();
        var masterKey = this.getServerMasterKey();
        var serverInfoRequestTimeoutMs = 5000;
        var defaultPeer = {
            host: this.sp.settings['skymp5-client']['server-ip'],
            port: this.sp.settings['skymp5-client']['server-port'],
            publicKeys: this.sp.settings['skymp5-client']['server-public-keys'],
        };
        var resolved = false;
        var states = {
            start: function () {
                var _a;
                try {
                    if (_this.sp.settings['skymp5-client']['server-info-ignore']) {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, 'Skipping serverinfo request due to server-info-ignore in config');
                        states.resolve(defaultPeer);
                        return;
                    }
                    _this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService).setTimeout(function () { return states.reject(new Error('getTargetPeer: serverinfo request timed out')); }, serverInfoRequestTimeoutMs);
                    var headers = {};
                    var session = (_a = _this.controller.lookupListener(_authService__WEBPACK_IMPORTED_MODULE_1__.AuthService).readAuthDataFromDisk()) === null || _a === void 0 ? void 0 : _a.session;
                    if (session) {
                        headers['X-Session'] = session;
                    }
                    masterApiClient.get("/api/servers/".concat(masterKey, "/serverinfo"), { headers: headers }, states.handleResponse);
                }
                catch (e) {
                    states.reject(e);
                }
            },
            handleResponse: function (res) {
                try {
                    if (res.status !== 200) {
                        throw new Error("status ".concat(res.status));
                    }
                    states.resolve(JSON.parse(res.body));
                }
                catch (e) {
                    states.reject(e);
                }
            },
            resolve: function (targetPeer) {
                if (resolved) {
                    return;
                }
                resolved = true;
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Resolved target peer", targetPeer);
                var enrichedTargetPeer = __assign({}, targetPeer);
                enrichedTargetPeer.publicKeys = __assign(__assign({}, defaultPeer.publicKeys), targetPeer.publicKeys);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Enriched target peer", enrichedTargetPeer);
                callback(enrichedTargetPeer);
            },
            reject: function (err) {
                if (resolved) {
                    return;
                }
                resolved = true;
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Server info request failed, falling back to", defaultPeer, "; error:", err);
                callback(defaultPeer);
            },
        };
        states.start();
    };
    SettingsService.prototype.getServerMods = function () {
        return __awaiter(this, void 0, void 0, function () {
            var masterApiClient, masterKey, attempt, res, manifest, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        masterApiClient = this.makeMasterApiClient();
                        masterKey = this.getServerMasterKey();
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(masterKey);
                        attempt = 0;
                        _a.label = 1;
                    case 1:
                        if (!(attempt < 5)) return [3 /*break*/, 7];
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 4, , 6]);
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Trying to get server mods, attempt ".concat(attempt));
                        return [4 /*yield*/, masterApiClient.get("/api/servers/".concat(masterKey, "/manifest.json"))];
                    case 3:
                        res = _a.sent();
                        if (res.status != 200) {
                            throw new Error("status code ".concat(res.status, ", error ").concat(res.error));
                        }
                        manifest = JSON.parse(res.body);
                        if (manifest.versionMajor !== 1) {
                            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("server manifest version is ".concat(manifest.versionMajor, ", we expect 1"));
                            return [2 /*return*/, []];
                        }
                        return [2 /*return*/, manifest.mods];
                    case 4:
                        e_1 = _a.sent();
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Request/parse error: ".concat(e_1));
                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1 + Math.random())];
                    case 5:
                        _a.sent();
                        return [3 /*break*/, 6];
                    case 6:
                        ++attempt;
                        return [3 /*break*/, 1];
                    case 7: return [2 /*return*/, []];
                }
            });
        });
    };
    ;
    SettingsService.prototype.getServerPort = function () {
        // Return the server port from settings
        return this.sp.settings['skymp5-client']['server-port'] || 7777;
    };
    SettingsService.prototype.normalizeUrl = function (url) {
        if (url.endsWith('/')) {
            return url.slice(0, url.length - 1);
        }
        return url;
    };
    ;
    return SettingsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/singlePlayerService.ts":
/*!******************************************************!*\
  !*** ./src/services/services/singlePlayerService.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SinglePlayerService: () => (/* binding */ SinglePlayerService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SinglePlayerService = /** @class */ (function (_super) {
    __extends(SinglePlayerService, _super);
    function SinglePlayerService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this._isSinglePlayer = false;
        _this.controller.emitter.on("gameLoad", function (e) { return _this.onGameLoad(e); });
        return _this;
    }
    Object.defineProperty(SinglePlayerService.prototype, "isSinglePlayer", {
        get: function () {
            return this._isSinglePlayer;
        },
        enumerable: false,
        configurable: true
    });
    SinglePlayerService.prototype.onGameLoad = function (event) {
        if (!event.isCausedBySkyrimPlatform && !this._isSinglePlayer) {
            this.sp.Debug.messageBox('Save has been loaded in multiplayer, switching to the single-player mode');
            this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).close();
            this._isSinglePlayer = true;
            this.sp.Game.setInChargen(false, false, false);
        }
    };
    return SinglePlayerService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/skympClient.ts":
/*!**********************************************!*\
  !*** ./src/services/services/skympClient.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SkympClient: () => (/* binding */ SkympClient)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();







(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('Hello Multiplayer!');
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('settings:', skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.settings['skymp5-client']);
var SkympClient = /** @class */ (function (_super) {
    __extends(SkympClient, _super);
    function SkympClient(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("connectionFailed", function (e) { return _this.onConnectionFailed(e); });
        _this.controller.emitter.on("connectionDenied", function (e) { return _this.onConnectionDenied(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onActorCreateMessage(e); });
        // TODO: refactor out very similar code in frontHotReloadService.ts
        var authGameData = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_3__.authGameDataStorageKey];
        var storageHasValidAuthGameData = (authGameData === null || authGameData === void 0 ? void 0 : authGameData.local) || (authGameData === null || authGameData === void 0 ? void 0 : authGameData.remote);
        if (storageHasValidAuthGameData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(_this, "Recovered AuthGameData from storage, starting client");
            _this.startClient();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(_this, "Unable to recover AuthGameData from storage, requesting auth");
            // Next tick because we're in constructor of the service, AuthService may not be listening events yet
            _this.controller.once("tick", function () {
                _this.controller.emitter.emit("authNeeded", {});
            });
            _this.controller.emitter.on("authAttempt", function (e) { return _this.onAuthAttempt(e); });
        }
        return _this;
    }
    SkympClient.prototype.onAuthAttempt = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Caught auth event");
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_3__.authGameDataStorageKey] = e.authGameData;
        this.startClient();
        // TODO: remove this when you will be able to see errors without console
        // this.sp.browser.setFocused(false);
    };
    SkympClient.prototype.onActorCreateMessage = function (e) {
        if (e.message.isMe) {
            this.sp.browser.setFocused(false);
        }
    };
    SkympClient.prototype.onConnectionFailed = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Connection failed");
    };
    SkympClient.prototype.onConnectionDenied = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Connection denied: " + e.error);
    };
    SkympClient.prototype.startClient = function () {
        var _this = this;
        // once("tick", ...) is needed to ensure networking service initialized
        this.controller.once("tick", function () { return _this.establishConnectionConditional(); });
        this.ctor();
    };
    SkympClient.prototype.ctor = function () {
        // TODO: refactor into service
        (0,_sync_animation__WEBPACK_IMPORTED_MODULE_2__.setupHooks)();
        this.sp.printConsole('SkympClient ctor');
    };
    SkympClient.prototype.establishConnectionConditional = function () {
        var _this = this;
        var isConnected = this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).isConnected();
        if (isConnected) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, 'Reconnect is not required');
            return;
        }
        this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_6__.SettingsService).getTargetPeer(function (_a) {
            var host = _a.host, port = _a.port;
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage.targetIp = host;
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage.targetPort = port;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Connecting to ".concat(host, ":").concat(port));
            _this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).connect(host, port);
        });
    };
    return SkympClient;
}(_clientListener__WEBPACK_IMPORTED_MODULE_4__.ClientListener));



/***/ }),

/***/ "./src/services/services/spSnippetService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/spSnippetService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpSnippetService: () => (/* binding */ SpSnippetService)
/* harmony export */ });
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _view_worldView__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../view/worldView */ "./src/view/worldView.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};


// TODO: refactor worldViewMisc into service



var SpSnippetService = /** @class */ (function (_super) {
    __extends(SpSnippetService, _super);
    function SpSnippetService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("spSnippetMessage", function (e) { return _this.onSpSnippetMessage(e); });
        _this.spAny = sp;
        return _this;
    }
    SpSnippetService.prototype.onSpSnippetMessage = function (event) {
        var _this = this;
        var msg = event.message;
        this.controller.once('update', function () { return __awaiter(_this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                this.run(msg)
                    .then(function (res) {
                    var isNoResultSnippet = msg.snippetIdx === 0xffffffff;
                    if (isNoResultSnippet) {
                        return;
                    }
                    if (res === undefined) {
                        res = null;
                    }
                    if (res !== null
                        && typeof res !== "number"
                        && typeof res !== "string"
                        && typeof res !== "boolean") {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(_this, "Unsupported SpSnippet result type '".concat(typeof res, "'"));
                        return;
                    }
                    var message = res === null ? {
                        t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.FinishSpSnippet,
                        snippetIdx: msg.snippetIdx
                    }
                        : {
                            t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.FinishSpSnippet,
                            returnValue: res,
                            snippetIdx: msg.snippetIdx,
                        };
                    _this.controller.emitter.emit("sendMessage", {
                        message: message,
                        reliability: "reliable"
                    });
                })
                    .catch(function (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(_this, 'SpSnippet ' + msg.class + ' ' + msg.function + ' failed ' + e);
                });
                return [2 /*return*/];
            });
        }); });
    };
    SpSnippetService.prototype.run = function (snippet) {
        var _a;
        return __awaiter(this, void 0, void 0, function () {
            var functionLowerCase, classLowerCase, newName, selfId, self, replaceValue, worldView_1, form, sign, count, soundId, sound, name, name;
            var _this = this;
            return __generator(this, function (_b) {
                functionLowerCase = snippet.function.toLowerCase();
                classLowerCase = snippet.class.toLowerCase();
                // keep in sync with remoteServer.ts
                if (classLowerCase === "objectreference") {
                    if (functionLowerCase === "setdisplayname") {
                        newName = snippet.arguments[0];
                        if (typeof newName === "string") {
                            selfId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(snippet.selfId);
                            self = this.sp.ObjectReference.from(this.sp.Game.getFormEx(selfId));
                            replaceValue = (_a = self === null || self === void 0 ? void 0 : self.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getName();
                            if (replaceValue !== undefined) {
                                newName = newName.replace(/%original_name%/g, replaceValue);
                                snippet.arguments[0] = newName;
                            }
                            else {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Couldn't get a replaceValue for SetDisplayName, snippet.selfId was", snippet.selfId.toString(16));
                            }
                        }
                        else {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Encountered SetDisplayName with non-string argument", newName);
                        }
                    }
                }
                if (classLowerCase === "game") {
                    if (functionLowerCase === "showracemenu" || functionLowerCase === "showlimitedracemenu") {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "showracemenu called");
                        worldView_1 = this.controller.lookupListener(_view_worldView__WEBPACK_IMPORTED_MODULE_4__.WorldView);
                        worldView_1.setFormViewUpdateAllowed(false);
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Waiting 1.0s before calling showracemenu");
                        this.sp.Utility.wait(1.0).then(function () {
                            _this.runStatic(snippet);
                            worldView_1.waitGameTimeAndAllowFormViewUpdate(1.0);
                        });
                        return [2 /*return*/];
                    }
                }
                if (classLowerCase === "skymphacks") {
                    if (functionLowerCase === "additem" || functionLowerCase === "removeitem") {
                        form = this.sp.Form.from(this.deserializeArg(snippet.arguments[0]));
                        if (form === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Unable to find form with id " + snippet.arguments[0].formId.toString(16));
                            return [2 /*return*/];
                        }
                        sign = snippet.function === "AddItem" ? "+" : "-";
                        count = snippet.arguments[1];
                        soundId = 0x334ab;
                        if (form.getFormID() !== 0xf) {
                            soundId = 0x14115;
                        }
                        sound = this.sp.Sound.from(this.sp.Game.getFormEx(soundId));
                        if (sound !== null) {
                            name = form.getName();
                            if (name.trim() === "") {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Sound will not be played because item has no name");
                            }
                            else {
                                sound.play(this.sp.Game.getPlayer());
                            }
                        }
                        else {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Unable to find sound with id " + soundId.toString(16));
                        }
                        if (count <= 0) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Positive count expected, got " + count.toString());
                        }
                        else {
                            name = form.getName();
                            if (name.trim() === "") {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Notification will not be shown because item has no name");
                            }
                            else {
                                this.sp.Debug.notification(sign + " " + name + " (" + count + ")");
                            }
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, sign + " " + name + " (" + count + ")");
                        }
                    }
                    else
                        throw new Error("Unknown SkympHack - " + snippet.function);
                    return [2 /*return*/];
                }
                return [2 /*return*/, snippet.selfId ? this.runMethod(snippet) : this.runStatic(snippet)];
            });
        });
    };
    ;
    SpSnippetService.prototype.deserializeArg = function (arg) {
        if (typeof arg === "object") {
            var formId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(arg.formId);
            var form = this.sp.Game.getFormEx(formId);
            var cl = this.spAny[arg.type];
            if (!cl) {
                var matchingKey = Object.keys(this.spAny).find(function (key) {
                    return key.toLowerCase() === arg.type.toLowerCase();
                });
                if (matchingKey) {
                    cl = this.spAny[matchingKey];
                }
            }
            if (!cl) {
                throw new Error("deserializeArg - Class ".concat(arg.type, " not found"));
            }
            var gameObject = cl.from(form);
            return gameObject;
        }
        return arg;
    };
    ;
    SpSnippetService.prototype.runMethod = function (snippet) {
        return __awaiter(this, void 0, void 0, function () {
            var selfId, self, cl, matchingKey, selfCasted, f;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        selfId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(snippet.selfId);
                        self = this.sp.Game.getFormEx(selfId);
                        if (!self)
                            throw new Error("Unable to find form with id ".concat(selfId.toString(16)));
                        cl = this.spAny[snippet.class];
                        if (!cl) {
                            matchingKey = Object.keys(this.spAny).find(function (key) {
                                return key.toLowerCase() === snippet.class.toLowerCase();
                            });
                            if (matchingKey) {
                                cl = this.spAny[matchingKey];
                            }
                        }
                        if (!cl) {
                            throw new Error("runMethod - Class ".concat(snippet.class, " not found, found"));
                        }
                        selfCasted = cl.from(self);
                        if (!selfCasted)
                            throw new Error("Form ".concat(selfId.toString(16), " is not instance of ").concat(snippet.class, ", form type is ").concat(self.getType()));
                        f = selfCasted[snippet.function];
                        return [4 /*yield*/, f.apply(selfCasted, snippet.arguments.map(function (arg) { return _this.deserializeArg(arg); }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ;
    SpSnippetService.prototype.runStatic = function (snippet) {
        return __awaiter(this, void 0, void 0, function () {
            var papyrusClass;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        papyrusClass = this.spAny[snippet.class];
                        return [4 /*yield*/, papyrusClass[snippet.function].apply(papyrusClass, snippet.arguments.map(function (arg) { return _this.deserializeArg(arg); }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ;
    return SpSnippetService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/spVersionCheckService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/spVersionCheckService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpVersionCheckService: () => (/* binding */ SpVersionCheckService)
/* harmony export */ });
/* harmony import */ var _version__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../version */ "./src/version.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SpVersionCheckService = /** @class */ (function (_super) {
    __extends(SpVersionCheckService, _super);
    function SpVersionCheckService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SpVersionCheckService.prototype.onceUpdate = function () {
        var _this = this;
        var realVersion = this.sp.getPlatformVersion();
        if (!_version__WEBPACK_IMPORTED_MODULE_0__.requiredVersion.includes(realVersion)) {
            this.sp.Debug.messageBox("You need to have on of those SkyrimPlatform versions ".concat(JSON.stringify(_version__WEBPACK_IMPORTED_MODULE_0__.requiredVersion), " to join this server. Your current version is ").concat(realVersion));
            this.sp.Utility.waitMenuMode(0.5).then(function () {
                _this.controller.on('update', function () {
                    if (!_this.sp.Ui.isMenuOpen('MessageBoxMenu')) {
                        _this.sp.Game.quitToMainMenu();
                    }
                });
            });
        }
    };
    return SpVersionCheckService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetCameraEnforcementService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetCameraEnforcementService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetCameraEnforcementService: () => (/* binding */ SweetCameraEnforcementService)
/* harmony export */ });
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var playerId = 0x14;
// ex AnimDebugService part
var SweetCameraEnforcementService = /** @class */ (function (_super) {
    __extends(SweetCameraEnforcementService, _super);
    function SweetCameraEnforcementService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.currentAnim = null;
        _this.stopAnimInProgress = false;
        _this.exitAnimName = null;
        _this.interruptAnimName = null;
        _this.tryInvokeAnimCount = 0;
        _this.lastNotificationMoment = 0;
        _this.tryInvokeAnimCountMax = 1000000000;
        _this.exitAnimEvent = undefined;
        _this.optionsCache = undefined;
        _this.optionCb = undefined;
        _this.usePlayerControlsDelayMs = true;
        var hasSweetPie = _this.hasSweetPie();
        if (!hasSweetPie) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.settings = _this.sp.settings["skymp5-client"]["animDebug"];
        if (hasSweetPie) {
            var self_1 = _this;
            _this.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) { },
                leave: function (ctx) {
                    self_1.onSendAnimationEventLeave(ctx);
                    self_1.onSendExitAnimationEventLeave(ctx); // Tracking the successful launch of the exit animation
                },
            }, playerId, playerId);
            _this.controller.on("buttonEvent", function (e) { return _this.onButtonEvent(e); });
            _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage2(e); });
        }
        return _this;
    }
    SweetCameraEnforcementService.prototype.onCustomPacketMessage2 = function (e) {
        var _this = this;
        var content = {};
        try {
            content = JSON.parse(e.message.contentJsonDump);
        }
        catch (err) {
            if (err instanceof SyntaxError) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Failed to parse custom packet contentJsonDump:", e.message.contentJsonDump, "Error:", err);
                return;
            }
            throw err;
        }
        if (content["customPacketType"] !== "invokeAnim") {
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received custom packet with customPacketType invokeAnim");
        var name = content["animEventName"];
        var requestId = content["requestId"];
        var weaponDrawnAllowed = content["weaponDrawnAllowed"];
        var furnitureAllowed = content["furnitureAllowed"];
        var exitAnimName = content["exitAnimName"];
        var interruptAnimName = content["interruptAnimName"];
        var timeMs = content["timeMs"];
        var isPlayExitAnimAfterwardsEnabled = content["isPlayExitAnimAfterwardsEnabled"];
        var parentAnimEventName = content["parentAnimEventName"];
        var enablePlayerControlsDelayMs = content["enablePlayerControlsDelayMs"];
        var preferInterruptAnimAsExitAnimTimeMs = content["preferInterruptAnimAsExitAnimTimeMs"];
        if (typeof name !== "string") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Expected animEventName to be string");
            return;
        }
        if (typeof requestId !== "string" && typeof requestId !== "number" && typeof requestId !== "undefined") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Expected requestId to be string or number or undefined");
            return;
        }
        this.controller.once("update", function () {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Trying to invoke anim", name, "with weaponDrawnAllowed=", weaponDrawnAllowed, ", furnitureAllowed=", furnitureAllowed, ", exitAnimName=", exitAnimName, ", interruptAnimName=", interruptAnimName, ", timeMs=", timeMs, ", isPlayExitAnimAfterwardsEnabled=", isPlayExitAnimAfterwardsEnabled, ", parentAnimEventName=", parentAnimEventName, ", enablePlayerControlsDelayMs=", enablePlayerControlsDelayMs, ", preferInterruptAnimAsExitAnimTimeMs=", preferInterruptAnimAsExitAnimTimeMs);
            var result = _this.tryInvokeAnim(name, { weaponDrawnAllowed: weaponDrawnAllowed, furnitureAllowed: furnitureAllowed, exitAnimName: exitAnimName, interruptAnimName: interruptAnimName, timeMs: timeMs, isPlayExitAnimAfterwardsEnabled: isPlayExitAnimAfterwardsEnabled, parentAnimEventName: parentAnimEventName, enablePlayerControlsDelayMs: enablePlayerControlsDelayMs, preferInterruptAnimAsExitAnimTimeMs: preferInterruptAnimAsExitAnimTimeMs });
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: "invokeAnimResult",
                    result: result,
                    requestId: requestId,
                })
            };
            _this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable",
            });
        });
    };
    SweetCameraEnforcementService.prototype.onSendAnimationEventLeave = function (ctx) {
        var _this = this;
        var animLowerCase = ctx.animEventName.toLowerCase();
        if (animLowerCase.startsWith("idle") && !animLowerCase.startsWith("idleforcedefaultstate")) {
            this.controller.once("update", function () {
                var _a;
                // This is only for player.playidle
                if (!_this.sp.Ui.isMenuOpen("Console" /* Menu.Console */)) {
                    return;
                }
                if ((_a = _this.sp.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.getFurnitureReference()) {
                    return;
                }
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Forcing third person and disabling player controls");
                _this.sp.Game.forceThirdPerson();
                _this.sp.Game.disablePlayerControls(true, false, true, false, false, false, false, false, 0);
                _this.currentAnim = { name: ctx.animEventName, options: null, preferInterruptAnimState: null };
                _this.startAntiExploitPolling();
            });
        }
    };
    SweetCameraEnforcementService.prototype.exitAnim = function (options) {
        var _this = this;
        var _a, _b;
        // TODO(1): See another TODO(1) in this file
        if (options.playExitAnim) {
            var useInterruptAnimAsExitAnim = false;
            if (options.useInterruptAnimAsExitAnim) {
                useInterruptAnimAsExitAnim = true;
                this.usePlayerControlsDelayMs = false;
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Using interrupt anim as exit anim: ".concat(this.interruptAnimName, ". Reason: useInterruptAnimAsExitAnim is true"));
            }
            if ((_b = (_a = this.currentAnim) === null || _a === void 0 ? void 0 : _a.preferInterruptAnimState) === null || _b === void 0 ? void 0 : _b.prefer) {
                useInterruptAnimAsExitAnim = true;
                this.usePlayerControlsDelayMs = false;
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Using interrupt anim as exit anim: ".concat(this.interruptAnimName, ". Reason: preferInterruptAnimState.prefer is true"));
            }
            var animEventToSend = useInterruptAnimAsExitAnim ? (this.interruptAnimName || "IdleStop") : (this.exitAnimName || "IdleForceDefaultState");
            this.sp.Debug.sendAnimationEvent(this.sp.Game.getPlayer(), animEventToSend);
            this.exitAnimEvent = animEventToSend;
            this.optionsCache = options;
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Sent animation event:", animEventToSend);
        }
        else {
            this.currentAnim = null;
            var enablePlayerControlsDelaySeconds = (typeof options.enablePlayerControlsDelayMs === "number"
                && options.enablePlayerControlsDelayMs > 0
                && Number.isFinite(options.enablePlayerControlsDelayMs)
                && this.usePlayerControlsDelayMs)
                ? options.enablePlayerControlsDelayMs / 1000
                : 0.5;
            var stopAnimDelaySeconds = enablePlayerControlsDelaySeconds + 0.5;
            this.stopAnimInProgress = true;
            this.sp.Utility.wait(enablePlayerControlsDelaySeconds).then(function () {
                _this.sp.Game.enablePlayerControls(true, false, true, false, false, false, false, false, 0);
            });
            this.sp.Utility.wait(stopAnimDelaySeconds).then(function () {
                _this.stopAnimInProgress = false;
                if (_this.optionCb) {
                    _this.optionCb();
                    _this.optionCb = undefined;
                }
            });
        }
    };
    SweetCameraEnforcementService.prototype.onSendExitAnimationEventLeave = function (ctx) {
        var _this = this;
        if (ctx.animationSucceeded && this.exitAnimEvent && this.optionsCache && ctx.animEventName === this.exitAnimEvent) {
            this.currentAnim = null;
            var enablePlayerControlsDelaySeconds = (typeof this.optionsCache.enablePlayerControlsDelayMs === "number"
                && this.optionsCache.enablePlayerControlsDelayMs > 0
                && Number.isFinite(this.optionsCache.enablePlayerControlsDelayMs)
                && this.usePlayerControlsDelayMs)
                ? this.optionsCache.enablePlayerControlsDelayMs / 1000
                : 0.5;
            var stopAnimDelaySeconds = enablePlayerControlsDelaySeconds + 0.5;
            this.stopAnimInProgress = true;
            this.optionsCache = undefined;
            this.exitAnimEvent = undefined;
            this.usePlayerControlsDelayMs = true;
            this.sp.Utility.wait(enablePlayerControlsDelaySeconds).then(function () {
                _this.sp.Game.enablePlayerControls(true, false, true, false, false, false, false, false, 0);
            });
            this.sp.Utility.wait(stopAnimDelaySeconds).then(function () {
                _this.stopAnimInProgress = false;
                if (_this.optionCb) {
                    _this.optionCb();
                    _this.optionCb = undefined;
                }
            });
        }
        else {
            this.optionsCache = undefined;
            this.exitAnimEvent = undefined;
            if (this.optionCb) {
                this.optionCb = undefined;
            }
        }
    };
    SweetCameraEnforcementService.prototype.startAntiExploitPolling = function (mode) {
        // Fixes https://github.com/skyrim-multiplayer/skymp5-gamemode/issues/240
        // P.S. There is a very similar code in skymp5-gamemode
        // See disableCheats.ts, skymp5-gamemode for comments
        var _this = this;
        if (mode === void 0) { mode = "death"; }
        var _callNative = this.sp.callNative;
        var cameraState = -1;
        var needsExitingAnim = false;
        var f = function (i) {
            var _a;
            if (i >= 10 * 60) {
                return;
            }
            cameraState = _callNative("Game", "getCameraState", undefined);
            needsExitingAnim = _this.needsExitingAnim;
            if (!needsExitingAnim) {
                return f(Infinity);
            }
            if (cameraState === 0) { // 1-st person
                _callNative("Game", "forceThirdPerson", undefined);
                _this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
                if (mode === "death") {
                    (_a = _this.sp.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.damageActorValue("Health", 10000);
                }
                return f(Infinity);
            }
            _this.controller.once("update", function () { return f(i + 1); });
        };
        f(0);
    };
    SweetCameraEnforcementService.prototype.onButtonEvent = function (e) {
        var _a, _b;
        // TODO: de-hardcode controls
        if (e.isPressed) {
            return;
        }
        if (e.code === 57 /* DxScanCode.Spacebar */
            || e.code === 17 /* DxScanCode.W */
            || e.code === 30 /* DxScanCode.A */
            || e.code === 31 /* DxScanCode.S */
            || e.code === 32 /* DxScanCode.D */) {
            if (this.needsExitingAnim) {
                if ((_a = this.currentAnim) === null || _a === void 0 ? void 0 : _a.options) {
                    this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: this.currentAnim.options.enablePlayerControlsDelayMs });
                }
                else {
                    this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
                }
            }
        }
        else {
            if (this.needsExitingAnim) {
                var intervalMs = (_b = this.settings) === null || _b === void 0 ? void 0 : _b.exitAnimNotificationIntervalMs;
                if (!intervalMs || (Date.now() - this.lastNotificationMoment) >= intervalMs) {
                    this.lastNotificationMoment = Date.now();
                    this.sp.Debug.notification(",    ");
                }
            }
        }
        if (!e.isUp) {
            return;
        }
        if (!this.settings || !this.settings.animKeys) {
            return;
        }
        var animEvent = this.settings.animKeys[e.code];
        if (!animEvent) {
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Starting anims from keyboard is disabled in this version");
        // this.tryInvokeAnim(animEvent, {
        //     weaponDrawnAllowed: false,
        //     furnitureAllowed: false,
        //     exitAnimName: null,
        //     interruptAnimName: null,
        //     timeMs: 0,
        //     isPlayExitAnimAfterwardsEnabled: true,
        //     parentAnimEventName: null,
        //     enablePlayerControlsDelayMs: null,
        //     preferInterruptAnimAsExitAnimTimeMs: null,
        // });
    };
    SweetCameraEnforcementService.prototype.tryInvokeAnim = function (animEvent, options) {
        var _this = this;
        this.tryInvokeAnimCount++;
        if (this.tryInvokeAnimCount >= this.tryInvokeAnimCountMax) {
            this.tryInvokeAnimCount = 0;
        }
        var currentInvokeAnimCount = this.tryInvokeAnimCount;
        if (typeof options.exitAnimName === "string") {
            this.exitAnimName = options.exitAnimName;
        }
        else {
            this.exitAnimName = null;
        }
        if (typeof options.interruptAnimName === "string") {
            this.interruptAnimName = options.interruptAnimName;
        }
        else {
            this.interruptAnimName = null;
        }
        if (typeof options.timeMs === "number" && options.timeMs > 0 && Number.isFinite(options.timeMs)) {
            var timeSeconds = options.timeMs / 1000;
            // Using Utility.wait makes sense because it waits game time, not simply real time.
            this.sp.Utility.wait(timeSeconds).then(function () {
                if (_this.tryInvokeAnimCount !== currentInvokeAnimCount) {
                    return;
                }
                if (!_this.needsExitingAnim) {
                    return;
                }
                var isPlayExitAnimAfterwardsEnabled = typeof options.isPlayExitAnimAfterwardsEnabled === "boolean" ? options.isPlayExitAnimAfterwardsEnabled : true;
                _this.exitAnim({ playExitAnim: isPlayExitAnimAfterwardsEnabled, enablePlayerControlsDelayMs: options.enablePlayerControlsDelayMs });
            });
        }
        var player = this.sp.Game.getPlayer();
        if (!player) {
            return { success: false, reason: "player_not_found" };
        }
        if (player.isWeaponDrawn() && !options.weaponDrawnAllowed) {
            return { success: false, reason: "weapon_drawn" };
        }
        if (player.getAnimationVariableBool("bInJumpState")) {
            return { success: false, reason: "jump_state" };
        }
        if (this.sp.Ui.isMenuOpen("FavoritesMenu" /* Menu.Favorites */)) {
            return { success: false, reason: "favorites_menu_open" };
        }
        if (this.sp.Ui.isMenuOpen("Console" /* Menu.Console */)) {
            return { success: false, reason: "console_menu_open" };
        }
        if (this.stopAnimInProgress) {
            return { success: false, reason: "busy_stopping_anim" };
        }
        if (player.getFurnitureReference() && !options.furnitureAllowed) {
            return { success: false, reason: "player_in_furniture" };
        }
        if (player.isSneaking()) {
            return { success: false, reason: "player_sneaking" };
        }
        if (player.isSwimming()) {
            return { success: false, reason: "player_swimming" };
        }
        if (animEvent.toLowerCase() === "idleforcedefaultstate") {
            if (this.needsExitingAnim) {
                this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
            }
        }
        else {
            var doInvoke = function () {
                _this.sp.Game.forceThirdPerson();
                _this.sp.Game.disablePlayerControls(true, false, true, false, false, false, false, false, 0);
                _this.sp.Debug.sendAnimationEvent(_this.sp.Game.getPlayer(), animEvent);
                var preferInterruptAnimState = null;
                if (typeof options.preferInterruptAnimAsExitAnimTimeMs === "number"
                    && options.preferInterruptAnimAsExitAnimTimeMs > 0
                    && Number.isFinite(options.preferInterruptAnimAsExitAnimTimeMs)) {
                    var state_1 = { prefer: true };
                    (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Prefer interrupt anim as exit anim for ".concat(options.preferInterruptAnimAsExitAnimTimeMs, " ms"));
                    _this.sp.Utility.wait(options.preferInterruptAnimAsExitAnimTimeMs / 1000).then(function () {
                        state_1.prefer = false;
                        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Prefer interrupt anim as exit anim state changed to false");
                    });
                    preferInterruptAnimState = state_1;
                }
                _this.currentAnim = { name: animEvent, options: options, preferInterruptAnimState: preferInterruptAnimState };
                _this.startAntiExploitPolling("no_death");
            };
            if (typeof options.parentAnimEventName === "string" && this.currentAnimName === options.parentAnimEventName) {
                doInvoke();
            }
            else if (Array.isArray(options.parentAnimEventName) && options.parentAnimEventName.includes(this.currentAnimName)) {
                doInvoke();
            }
            else if (this.needsExitingAnim) {
                // TODO (1): consider not using enablePlayerControlsDelayMs here, because useInterruptAnimAsExitAnim doesn't need it
                this.optionCb = doInvoke;
                this.exitAnim({ playExitAnim: true, useInterruptAnimAsExitAnim: true, enablePlayerControlsDelayMs: options.enablePlayerControlsDelayMs });
            }
            else {
                doInvoke();
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Sent animation event: ".concat(animEvent));
        }
        return { success: true };
    };
    SweetCameraEnforcementService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    Object.defineProperty(SweetCameraEnforcementService.prototype, "needsExitingAnim", {
        get: function () {
            return this.currentAnimName !== null;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(SweetCameraEnforcementService.prototype, "currentAnimName", {
        get: function () {
            return this.currentAnim ? this.currentAnim.name : null;
        },
        enumerable: false,
        configurable: true
    });
    return SweetCameraEnforcementService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyDynamicPerksService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetTaffyDynamicPerksService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyDynamicPerksService: () => (/* binding */ SweetTaffyDynamicPerksService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SweetTaffyDynamicPerksService = /** @class */ (function (_super) {
    __extends(SweetTaffyDynamicPerksService, _super);
    function SweetTaffyDynamicPerksService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.requestAddPerksToActors = function (actorIds, perkIds) {
            _this.controller.once("update", function () {
                var actors = actorIds.map(function (actorId) { return _this.sp.Actor.from(_this.sp.Game.getFormEx(actorId)); }).filter(function (actor) { return actor !== null; });
                var perks = perkIds.map(function (perkId) { return _this.sp.Perk.from(_this.sp.Game.getFormEx(perkId)); }).filter(function (perk) { return perk !== null; });
                actors.forEach(function (actor) { return perks.forEach(function (perk) { return actor === null || actor === void 0 ? void 0 : actor.addPerk(perk); }); });
            });
        };
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features enabled");
        }
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        controller.emitter.on("setInventoryMessage", function (e) { return _this.onSetInventoryMessage(e); });
        controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        return _this;
    }
    SweetTaffyDynamicPerksService.prototype.onContainerChanged = function (e) {
        if (!this.hasSweetPie()) {
            return;
        }
        if (e.oldContainer && e.newContainer) {
            if (e.newContainer.getFormID() === 0x14 && e.numItems > 0) {
                this.handlePlayerInventoryChanged({
                    baseId: e.baseObj.getFormID(),
                    count: e.numItems,
                });
            }
        }
    };
    SweetTaffyDynamicPerksService.prototype.onSetInventoryMessage = function (e) {
        var _this = this;
        if (!this.hasSweetPie()) {
            return;
        }
        var entries = e.message.inventory.entries;
        if (entries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received SetInventoryMessage with empty inventory");
            return;
        }
        this.controller.once("update", function () {
            entries.forEach(function (entry) { return _this.handlePlayerInventoryChanged(entry); });
        });
    };
    SweetTaffyDynamicPerksService.prototype.onCreateActorMessage = function (e) {
        var _this = this;
        var _a, _b;
        if (!this.hasSweetPie()) {
            return;
        }
        if (!e.message.isMe) {
            return;
        }
        var entries = (_b = (_a = e.message.props) === null || _a === void 0 ? void 0 : _a.inventory) === null || _b === void 0 ? void 0 : _b.entries;
        if (entries === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received CreateActorMessage without inventory");
            return;
        }
        if (entries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received CreateActorMessage with empty inventory");
            return;
        }
        this.controller.once("update", function () {
            entries.forEach(function (entry) { return _this.handlePlayerInventoryChanged(entry); });
        });
    };
    SweetTaffyDynamicPerksService.prototype.handlePlayerInventoryChanged = function (entry) {
        if (!this.hasSweetPie()) {
            return;
        }
        var item = this.sp.Game.getFormEx(entry.baseId);
        if (!item) {
            return;
        }
        if (entry.count <= 0) {
            return;
        }
        var perkIds = this.getPerkIdsByKeyword(item);
        if (perkIds) {
            var playerId = 0x14;
            this.requestAddPerksToActors([playerId], perkIds);
        }
    };
    SweetTaffyDynamicPerksService.prototype.getPerkIdsByKeyword = function (item) {
        var _this = this;
        var result = new Array();
        this.getKeywordPerkMap().forEach(function (v, k) {
            var keyWord = _this.sp.Keyword.getKeyword(k);
            if (item.hasKeyword(keyWord)) {
                result.push(v);
            }
        });
        return result.length > 0 ? result : null;
    };
    // TODO: move this to config
    SweetTaffyDynamicPerksService.prototype.getKeywordPerkMap = function () {
        return new Map([
            // 
            ["SweetPerkBow1", 0x1036F0],
            ["SweetPerkBow2", 0x58F61],
            ["SweetPerkBow3", 0x105F19],
            ["SweetPerkBow4", 0x58F63],
            // 
            ["SweetPerkSneak1", 0x58210],
            ["SweetPerkSneak2", 0x105F23],
            ["SweetPerkSneak3", 0x58208],
            ["SweetPerkSneak4", 0x58211],
            // 
            ["SweetPerkArmorLight1", 0x105F22],
            ["SweetPerkArmorLight2", 0x51B1C],
            // 
            ["SweetPerkEnchant2", 0x108A44],
            ["SweetPerkEnchant1", 0x58F7C],
            // 
            ["SweetPerkArmorHeavy1", 0xBCD2B],
            ["SweetPerkArmorHeavy2", 0x58F6D],
            // 
            ["SweetPerkBlock1", 0x58F67],
            ["SweetPerkBlock2", 0x106253],
            ["SweetPerkBlock3", 0x58F6A],
            ["SweetPerkBlock4", 0x58F69],
            // , , , , , ,  ( )
            ["SweetPerk1Hand2Hand1", 0x58F6F],
            ["SweetPerk2Hand2", 0xCB407],
            ["SweetPerk2Hand3", 0x96590],
            ["SweetPerk2Hand4", 0x52D51],
            // , , , , , , ,  ( )
            ["SweetPerk1Hand2Hand1", 0x58F6F],
            ["SweetPerk1Hand2", 0xCB406],
            ["SweetPerk1Hand3", 0x106256],
            ["SweetPerk1Hand4", 0x52D50],
        ]);
    };
    SweetTaffyDynamicPerksService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyDynamicPerksService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyNicknamesService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/sweetTaffyNicknamesService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyNicknamesService: () => (/* binding */ SweetTaffyNicknamesService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var SweetTaffyNicknamesService = /** @class */ (function (_super) {
    __extends(SweetTaffyNicknamesService, _super);
    function SweetTaffyNicknamesService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.emitter.on("nicknameCreate", function (e) { return _this.onNicknameCreate(e); });
        controller.emitter.on("nicknameDestroy", function (e) { return _this.onNicknameDestroy(e); });
        return _this;
    }
    SweetTaffyNicknamesService.prototype.onNicknameCreate = function (e) {
        var _a;
        var storageNickname = typeof this.sp.storage["idTextNickname"] === 'object'
            ? this.sp.storage["idTextNickname"]
            : null;
        if (storageNickname === null && e.remoteRefrId) {
            this.sp.storage["idTextNickname"] = (_a = {}, _a[e.remoteRefrId] = e.textId, _a);
        }
        else if (storageNickname !== null && e.remoteRefrId) {
            storageNickname[e.remoteRefrId] = e.textId;
            this.sp.storage["idTextNickname"] = storageNickname;
        }
    };
    SweetTaffyNicknamesService.prototype.onNicknameDestroy = function (e) {
        var storageNickname = typeof this.sp.storage["idTextNickname"] === 'object'
            ? this.sp.storage["idTextNickname"]
            : null;
        if (storageNickname !== null && e.remoteRefrId) {
            delete storageNickname[e.remoteRefrId];
            this.sp.storage["idTextNickname"] = storageNickname;
        }
    };
    return SweetTaffyNicknamesService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/sweetTaffyPlayerCombatService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetTaffyPlayerCombatService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyPlayerCombatService: () => (/* binding */ SweetTaffyPlayerCombatService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: move to service
var playerLastStaminaValue = 0;
var playerLastIsSprintingValue = false;
var blockPlayerControlTimeStamp = 0;
var isPlayerControlDisabled = true;
var playerAttackTimeout = 0;
var activeTimers = new Set();
// TODO: move to config
var staminaAttackMap = new Map([
    ["Std", 7],
    ["Power", 35],
    ["Jump", 15],
    ["Bow", 25],
    ["Crossbow", 30],
]);
// TODO: consider splitting this service (separate stamina and timer management)
// TODO: subscribe events/hooks in constructor
var SweetTaffyPlayerCombatService = /** @class */ (function (_super) {
    __extends(SweetTaffyPlayerCombatService, _super);
    function SweetTaffyPlayerCombatService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SweetTaffyPlayerCombatService.prototype.onceUpdate = function () {
        this.setAttackStaminaRestriction();
        this.registerHandlersIfNeeded();
    };
    SweetTaffyPlayerCombatService.prototype.setAttackStaminaRestriction = function () {
        var _this = this;
        if (!this.hasSweetPie()) {
            return;
        }
        this.controller.on("update", function () {
            var player = _this.sp.Game.getPlayer();
            playerLastStaminaValue = player.getActorValue("Stamina");
            playerLastIsSprintingValue = player.isSprinting();
        });
        for (var _i = 0, _a = ['SprintStart']; _i < _a.length; _i++) {
            var pattern = _a[_i];
            var sp = this.sp;
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    if (playerLastStaminaValue < 7.5) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _b = 0, _c = ['blockStart']; _b < _c.length; _b++) {
            var pattern = _c[_b];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    if (playerLastIsSprintingValue) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _d = 0, _e = ['attackStart*', 'AttackStart*']; _d < _e.length; _d++) {
            var pattern = _e[_d];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Std")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _f = 0, _g = ['attackPowerStart*', 'AttackPowerStart*']; _f < _g.length; _f++) {
            var pattern = _g[_f];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Power")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _h = 0, _j = ['JumpDirectionalStart*', 'JumpStandingStart*']; _h < _j.length; _h++) {
            var pattern = _j[_h];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Jump")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _k = 0, _l = ['bowAttackStart*']; _k < _l.length; _k++) {
            var pattern = _l[_k];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Bow")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _m = 0, _o = ['crossbowAttackStart*']; _m < _o.length; _m++) {
            var pattern = _o[_m];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Crossbow")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
    };
    SweetTaffyPlayerCombatService.prototype.registerHandlersIfNeeded = function () {
        var _this = this;
        var self = this;
        if (!this.hasSweetPie()) {
            return;
        }
        for (var _i = 0, _a = ['attackStart*', 'AttackStart*']; _i < _a.length; _i++) {
            var pattern = _a[_i];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function () { }),
                leave: (function (ctx) { return self.blockPlayerAttack(ctx.animEventName.toLowerCase().includes('lefthand')); }),
            }, 0x14, 0x14, pattern);
        }
        for (var _b = 0, _c = ['attackPowerStart*', 'AttackPowerStart*', 'Jump*']; _b < _c.length; _b++) {
            var pattern = _c[_b];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function () { }),
                leave: (function () {
                    playerAttackTimeout = 0;
                    activeTimers.clear();
                }),
            }, 0x14, 0x14, pattern);
        }
        this.controller.on("update", function () {
            if (isPlayerControlDisabled === true && Date.now() - blockPlayerControlTimeStamp >= playerAttackTimeout) {
                _this.sp.Game.getPlayer().setDontMove(false);
                isPlayerControlDisabled = false;
            }
        });
    };
    SweetTaffyPlayerCombatService.prototype.blockPlayerAttack = function (isLeftHand) {
        var _this = this;
        this.controller.once("update", function () {
            var _a;
            var player = _this.sp.Game.getPlayer();
            if (player.getAnimationVariableBool("bInJumpState")) {
                return;
            }
            var _b = _this.getTimings((_a = player.getEquippedWeapon(isLeftHand)) === null || _a === void 0 ? void 0 : _a.getWeaponType()), delay = _b[0], timeout = _b[1];
            var rnd = Math.random().toString();
            activeTimers.add(rnd);
            _this.sp.Utility.wait(delay / 1000).then(function () {
                if (!activeTimers.delete(rnd)) {
                    return;
                }
                _this.controller.once("update", function () {
                    isPlayerControlDisabled = true;
                    blockPlayerControlTimeStamp = Date.now();
                    _this.sp.Game.getPlayer().setDontMove(true);
                    playerAttackTimeout = timeout;
                });
            });
        });
    };
    SweetTaffyPlayerCombatService.prototype.getAndValidateTimingsConfigKey = function (key, weaponTimings) {
        var value = weaponTimings[key];
        if (value && Array.isArray(value) && value.length === 2) {
            var element0 = value[0];
            if (typeof element0 !== "number") {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "Invalid timings config for weapon type", key, value);
                return [0, 0];
            }
            var element1 = value[1];
            if (typeof element1 !== "number") {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "Invalid timings config for weapon type", key, value);
                return [0, 0];
            }
            return [element0, element1];
        }
        return [0, 0];
    };
    ;
    SweetTaffyPlayerCombatService.prototype.getSettingsFromFile = function () {
        var sweetTaffyPlayerCombatService = this.sp.settings["skymp5-client"]["sweetTaffyPlayerCombatService"];
        if (!sweetTaffyPlayerCombatService || typeof sweetTaffyPlayerCombatService !== "object") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No sweetTaffyPlayerCombatService settings found");
            return null;
        }
        var weaponTimings = sweetTaffyPlayerCombatService.weaponTimings;
        if (!weaponTimings || typeof weaponTimings !== "object") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No weaponTimings settings found");
            return null;
        }
        return weaponTimings;
    };
    SweetTaffyPlayerCombatService.prototype.getSettingsDefault = function () {
        return {
            fist: [0, 30],
            sword: [0, 30],
            dagger: [0, 60],
            warAxe: [0, 60],
            mace: [0, 65],
            greatsword: [0, 65],
            // Note: both of Battleaxe and Warhammer weapon types correspond to id=6.
            battleaxe: [0, 70],
            warhammer: [0, 70],
            bow: [0, 70],
            staff: [0, 70],
            crossbow: [0, 70],
        };
    };
    SweetTaffyPlayerCombatService.prototype.getTimingsFromConfig = function (weapon) {
        if (!weapon) {
            weapon = 0 /* WeaponType.Fist */;
        }
        // skymp5-client-settings.txt is perfectly editable by users, so we don't use it for now.
        // It's well-tested though, so we can enable it once we have a protection mechanism.
        // const weaponTimings = this.getSettingsFromFile();
        var weaponTimings = this.getSettingsDefault();
        if (!weaponTimings) {
            return null;
        }
        var weaponTimingsResult = {
            fist: [0, 0],
            sword: [0, 0],
            dagger: [0, 0],
            warAxe: [0, 0],
            mace: [0, 0],
            greatsword: [0, 0],
            battleaxe: [0, 0],
            warhammer: [0, 0],
            bow: [0, 0],
            staff: [0, 0],
            crossbow: [0, 0],
        };
        weaponTimingsResult.fist = this.getAndValidateTimingsConfigKey("fist", weaponTimings);
        weaponTimingsResult.sword = this.getAndValidateTimingsConfigKey("sword", weaponTimings);
        weaponTimingsResult.dagger = this.getAndValidateTimingsConfigKey("dagger", weaponTimings);
        weaponTimingsResult.warAxe = this.getAndValidateTimingsConfigKey("warAxe", weaponTimings);
        weaponTimingsResult.mace = this.getAndValidateTimingsConfigKey("mace", weaponTimings);
        weaponTimingsResult.greatsword = this.getAndValidateTimingsConfigKey("greatsword", weaponTimings);
        weaponTimingsResult.battleaxe = this.getAndValidateTimingsConfigKey("battleaxe", weaponTimings);
        weaponTimingsResult.warhammer = this.getAndValidateTimingsConfigKey("warhammer", weaponTimings);
        weaponTimingsResult.bow = this.getAndValidateTimingsConfigKey("bow", weaponTimings);
        weaponTimingsResult.staff = this.getAndValidateTimingsConfigKey("staff", weaponTimings);
        weaponTimingsResult.crossbow = this.getAndValidateTimingsConfigKey("crossbow", weaponTimings);
        switch (weapon) {
            case 0 /* WeaponType.Fist */:
                return weaponTimingsResult.fist;
            case 1 /* WeaponType.Sword */:
                return weaponTimingsResult.sword;
            case 2 /* WeaponType.Dagger */:
                return weaponTimingsResult.dagger;
            case 3 /* WeaponType.WarAxe */:
                return weaponTimingsResult.warAxe;
            case 4 /* WeaponType.Mace */:
                return weaponTimingsResult.mace;
            case 5 /* WeaponType.Greatsword */:
                return weaponTimingsResult.greatsword;
            case 6 /* WeaponType.Battleaxe */:
                return weaponTimingsResult.battleaxe;
            case 6 /* WeaponType.Warhammer */:
                return weaponTimingsResult.warhammer;
            case 7 /* WeaponType.Bow */:
                return weaponTimingsResult.bow;
            case 8 /* WeaponType.Staff */:
                return weaponTimingsResult.staff;
            case 9 /* WeaponType.Crossbow */:
                return weaponTimingsResult.crossbow;
            default:
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No timings found for weapon type", weapon);
                return null;
        }
    };
    SweetTaffyPlayerCombatService.prototype.getTimings = function (weapon) {
        var timingsFromConfig = this.getTimingsFromConfig(weapon);
        if (!weapon || !timingsFromConfig) {
            weapon = 0 /* WeaponType.Fist */;
            timingsFromConfig = this.getTimingsFromConfig(weapon);
        }
        if (!timingsFromConfig) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No timings found for weapon type", weapon);
            return [0, 0];
        }
        return timingsFromConfig;
    };
    ;
    SweetTaffyPlayerCombatService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyPlayerCombatService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffySkillMenuService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/sweetTaffySkillMenuService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffySkillMenuService: () => (/* binding */ SweetTaffySkillMenuService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// TODO: move to server/gamemode
var SweetTaffySkillMenuService = /** @class */ (function (_super) {
    __extends(SweetTaffySkillMenuService, _super);
    function SweetTaffySkillMenuService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.altars = [
            0x00100780, 0x000D9883, 0x000D987B, 0x000D9881, 0x000D9887, 0x000FB997,
            0x000D9885, 0x000D987D, 0x00071854, 0x07187500, 0x0200c86b, 0x000d987f,
            0x07058d4e, 0x07058d53, 0x070A6912, 0x07058d51, 0x07058d50, 0x07058d4f,
            0x07058d4d, 0x07058d4c, 0x07058d4b, 0x0705e2fa, 0x07058d4a, 0x07058d49,
            0x0705e367, 0x07058d48, 0x07058d55, 0x07058d46, 0x07058d47, 0x0705e2b0,
            0x07058d45
        ];
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("activate", function (e) { return _this.onActivate(e); });
        return _this;
    }
    SweetTaffySkillMenuService.prototype.onActivate = function (event) {
        var _a;
        if (!this.hasSweetPie()) {
            return;
        }
        if (!this.altars.includes(((_a = event.target.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) || -1)) {
            return;
        }
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.browser.setFocused(true);
        var src = "window.dispatchEvent(new CustomEvent('initSkillMenu'))";
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.browser.executeJavaScript(src);
    };
    SweetTaffySkillMenuService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffySkillMenuService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyStaticPerksService.ts":
/*!***************************************************************!*\
  !*** ./src/services/services/sweetTaffyStaticPerksService.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyStaticPerksService: () => (/* binding */ SweetTaffyStaticPerksService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SweetTaffyStaticPerksService = /** @class */ (function (_super) {
    __extends(SweetTaffyStaticPerksService, _super);
    function SweetTaffyStaticPerksService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        // TODO: move this to config
        _this.stealth = [0xBE126, 0xC07C6, 0xC07C7, 0xC07C8, 0xC07C9];
        _this.magic = [0x58213, 0x105F24, 0x58214];
        _this.warrior = [0xCB40D, 0xCB40F, 0xCB414, 0xCB411, 0xCB412, 0xCB410, 0xCB40E];
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SweetTaffyStaticPerksService.prototype.onceUpdate = function () {
        if (!this.hasSweetPie()) {
            return;
        }
        this.addStaticPerksToThePlayer();
    };
    SweetTaffyStaticPerksService.prototype.addStaticPerksToThePlayer = function () {
        var _this = this;
        var player = this.sp.Game.getPlayer();
        var allStaticPerkIds = this.stealth.concat(this.magic).concat(this.warrior);
        allStaticPerkIds.forEach(function (perkId) {
            player.addPerk(_this.sp.Perk.from(_this.sp.Game.getFormEx(perkId)));
        });
    };
    SweetTaffyStaticPerksService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyStaticPerksService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffySweetCantDropService.ts":
/*!*****************************************************************!*\
  !*** ./src/services/services/sweetTaffySweetCantDropService.ts ***!
  \*****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffySweetCantDropService: () => (/* binding */ SweetTaffySweetCantDropService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

// TODO: move to the server/gamemode
var SweetTaffySweetCantDropService = /** @class */ (function (_super) {
    __extends(SweetTaffySweetCantDropService, _super);
    function SweetTaffySweetCantDropService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.cantDropKeyword = "SweetCantDrop";
        return _this;
    }
    SweetTaffySweetCantDropService.prototype.canDropOrPutItem = function (itemId) {
        var item = this.sp.Game.getFormEx(itemId);
        if (item !== null) {
            if (item.hasKeyword(this.sp.Keyword.getKeyword(this.cantDropKeyword))) {
                return false;
            }
        }
        return true;
    };
    return SweetTaffySweetCantDropService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/timeService.ts":
/*!**********************************************!*\
  !*** ./src/services/services/timeService.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   TimeService: () => (/* binding */ TimeService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var TimeService = /** @class */ (function (_super) {
    __extends(TimeService, _super);
    function TimeService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastTimeUpd = 0;
        controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    TimeService.prototype.getTime = function () {
        var hoursOffsetSetting = this.sp.settings["skymp5-client"]["hoursOffset"];
        var hoursOffset = typeof hoursOffsetSetting === "number" ? hoursOffsetSetting : 0;
        var hoursOffsetMs = hoursOffset * 60 * 60 * 1000;
        var d = new Date(Date.now() + hoursOffsetMs);
        var newGameHourValue = 0;
        newGameHourValue += d.getUTCHours();
        newGameHourValue += d.getUTCMinutes() / 60;
        newGameHourValue += d.getUTCSeconds() / 60 / 60;
        newGameHourValue += d.getUTCMilliseconds() / 60 / 60 / 1000;
        return { newGameHourValue: newGameHourValue, date: d };
    };
    TimeService.prototype.every2seconds = function () {
        var gameHourId = 0x38;
        var gameMonthId = 0x36;
        var gameDayId = 0x37;
        var gameYearId = 0x35;
        var timeScaleId = 0x3a;
        var gameHour = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameHourId));
        var gameDay = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameDayId));
        var gameMonth = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameMonthId));
        var gameYear = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameYearId));
        var timeScale = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(timeScaleId));
        if (!gameHour || !gameDay || !gameMonth || !gameYear || !timeScale) {
            return;
        }
        var _a = this.getTime(), newGameHourValue = _a.newGameHourValue, date = _a.date;
        var diff = Math.abs(gameHour.getValue() - newGameHourValue);
        if (diff >= 1 / 60) {
            gameHour.setValue(newGameHourValue);
            gameDay.setValue(date.getUTCDate());
            gameMonth.setValue(date.getUTCMonth());
            gameYear.setValue(date.getUTCFullYear() - 2020 + 199);
        }
        timeScale.setValue(gameHour.getValue() > newGameHourValue ? 0.6 : 1.2);
    };
    TimeService.prototype.onUpdate = function () {
        if (Date.now() - this.lastTimeUpd <= 2000) {
            return;
        }
        this.lastTimeUpd = Date.now();
        this.every2seconds();
    };
    return TimeService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/timersService.ts":
/*!************************************************!*\
  !*** ./src/services/services/timersService.ts ***!
  \************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   TimersService: () => (/* binding */ TimersService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var ProcessMethodType;
(function (ProcessMethodType) {
    ProcessMethodType["update"] = "update";
    ProcessMethodType["tick"] = "tick";
})(ProcessMethodType || (ProcessMethodType = {}));
var TimersService = /** @class */ (function (_super) {
    __extends(TimersService, _super);
    function TimersService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.timersArr = new Array();
        _this.intervalsArr = new Array();
        _this.lastCallTime = Date.now();
        _this.processMethodTypeStorageKey = "updateTypeStorageKey";
        var storageProcessMethod = sp.storage[_this.processMethodTypeStorageKey];
        if (typeof storageProcessMethod !== "function") {
            _this.setProcessMethod(storageProcessMethod);
        }
        else {
            _this.setProcessMethod(ProcessMethodType.tick);
        }
        _this.controller.on("menuOpen", function (e) { return _this.onMenuOpen(e); });
        _this.controller.on("preLoadGame", function () { return _this.onPreLoadGame(); });
        return _this;
    }
    TimersService.prototype.setTimeout = function (handler, timeout) {
        var args = [];
        for (var _i = 2; _i < arguments.length; _i++) {
            args[_i - 2] = arguments[_i];
        }
        var timer = { handler: handler, args: args, delayMs: timeout !== null && timeout !== void 0 ? timeout : 0, passedMs: 0 };
        for (var i = 0; i < this.timersArr.length; ++i) {
            if (!this.timersArr[i]) {
                this.timersArr[i] = timer;
                return i + 1;
            }
        }
        return this.timersArr.push(timer);
    };
    TimersService.prototype.clearTimeout = function (id) {
        if (id === undefined) {
            this.timersArr = new Array();
            return;
        }
        if (id <= 0 || id > this.timersArr.length) {
            return;
        }
        this.timersArr[id - 1] = null;
        return;
    };
    TimersService.prototype.setInterval = function (handler, timeout) {
        var args = [];
        for (var _i = 2; _i < arguments.length; _i++) {
            args[_i - 2] = arguments[_i];
        }
        var timer = { handler: handler, args: args, delayMs: timeout !== null && timeout !== void 0 ? timeout : 0, passedMs: 0 };
        for (var i = 0; i < this.intervalsArr.length; ++i) {
            if (!this.intervalsArr[i]) {
                this.intervalsArr[i] = timer;
                return i + 1;
            }
        }
        return this.intervalsArr.push(timer);
    };
    TimersService.prototype.clearInterval = function (id) {
        if (id === undefined) {
            this.intervalsArr = new Array();
            return;
        }
        if (id <= 0 || id > this.intervalsArr.length) {
            return;
        }
        this.intervalsArr[id - 1] = null;
        return;
    };
    TimersService.prototype.setProcessMethod = function (method) {
        var _this = this;
        switch (method) {
            case ProcessMethodType.tick:
                this.sp.storage[this.processMethodTypeStorageKey] = ProcessMethodType.tick;
                this.updateEventHandle = this.controller.on(ProcessMethodType.tick, function () { return _this.processTimers(); });
                return;
            case ProcessMethodType.update:
                this.sp.storage[this.processMethodTypeStorageKey] = ProcessMethodType.update;
                this.updateEventHandle = this.controller.on(ProcessMethodType.update, function () { return _this.processTimers(); });
                return;
            default:
                break;
        }
        try {
            if (this.sp.Game.getPlayer()) {
                // FIXME(GM-1008)
            }
            this.setProcessMethod(ProcessMethodType.update);
        }
        catch (_a) {
            this.setProcessMethod(ProcessMethodType.tick);
        }
    };
    TimersService.prototype.processTimers = function () {
        var dt = Date.now() - this.lastCallTime;
        this.lastCallTime = Date.now();
        // process timers
        for (var i = 0; i < this.timersArr.length; ++i) {
            var timer = this.timersArr[i];
            if (timer) {
                timer.passedMs += dt;
                if (timer.passedMs >= timer.delayMs) {
                    this.timersArr[i] = null;
                    if (typeof timer.handler === "function") {
                        timer.handler.call(this, timer.args);
                    }
                    else {
                        eval(timer.handler);
                    }
                }
            }
            else if (i === this.timersArr.length - 1) {
                // remove last unused element
                this.timersArr.length -= 1;
            }
        }
        // process intervals
        for (var i = 0; i < this.intervalsArr.length; ++i) {
            var interval = this.intervalsArr[i];
            if (interval) {
                interval.passedMs += dt;
                if (interval.passedMs >= interval.delayMs) {
                    interval.passedMs = 0;
                    if (typeof interval.handler === "function") {
                        interval.handler.call(this, interval.args);
                    }
                    else {
                        eval(interval.handler);
                    }
                }
            }
            else if (i === this.intervalsArr.length - 1) {
                // remove last unused element
                this.intervalsArr.length -= 1;
            }
        }
    };
    TimersService.prototype.onMenuOpen = function (e) {
        if (e.name === "Main Menu" /* Menu.Main */) {
            if (this.updateEventHandle) {
                this.sp.unsubscribe(this.updateEventHandle);
            }
            this.setProcessMethod(ProcessMethodType.tick);
        }
    };
    TimersService.prototype.onPreLoadGame = function () {
        if (this.updateEventHandle) {
            this.sp.unsubscribe(this.updateEventHandle);
        }
        this.setProcessMethod(ProcessMethodType.update);
    };
    return TimersService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/voiceChatService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/voiceChatService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   VoiceChatService: () => (/* binding */ VoiceChatService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var VoiceChatService = /** @class */ (function (_super) {
    __extends(VoiceChatService, _super);
    function VoiceChatService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.isInitialized = false;
        _this.isTalking = false;
        _this.pushToTalkKey = 0x56; // V key
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    VoiceChatService.prototype.onConnect = function () {
        // Voice chat initialization handled elsewhere for now
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Connected");
    };
    VoiceChatService.prototype.onDisconnect = function () {
        if (this.isTalking) {
            this.stopTalking();
        }
        this.isInitialized = false;
    };
    VoiceChatService.prototype.onTick = function () {
        if (!this.isInitialized) {
            return;
        }
        // Check push-to-talk key state
        var keyPressed = this.sp.Input.isKeyPressed(this.pushToTalkKey);
        if (keyPressed && !this.isTalking) {
            this.startTalking();
        }
        else if (!keyPressed && this.isTalking) {
            this.stopTalking();
        }
    };
    VoiceChatService.prototype.onUpdate = function () {
        // Handle continuous voice chat updates if needed
    };
    VoiceChatService.prototype.startTalking = function () {
        try {
            this.isTalking = true;
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Started talking");
            // Actual voice capture handled by underlying system
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to start talking: ".concat(error));
        }
    };
    VoiceChatService.prototype.stopTalking = function () {
        try {
            this.isTalking = false;
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Stopped talking");
            // Actual voice capture stopping handled by underlying system
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to stop talking: ".concat(error));
        }
    };
    // Handle incoming voice chat data from other players
    VoiceChatService.prototype.onReceiveVoiceData = function (speakerId, audioData, x, y, z) {
        if (!this.isInitialized) {
            return;
        }
        try {
            // Voice playback handled by underlying system
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Received voice data from ".concat(speakerId, " at (").concat(x, ", ").concat(y, ", ").concat(z, ")"));
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to process voice data: ".concat(error));
        }
    };
    // Handle binary voice packets received from the server
    VoiceChatService.prototype.onPacket = function (type, rawContent, error) {
        if (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Packet error: ".concat(error));
            return;
        }
        if (!rawContent || rawContent.byteLength === 0) {
            return;
        }
        // Check if this is a binary voice packet
        var data = new Uint8Array(rawContent);
        if (data[0] === 135) { // BinaryVoicePacketId
            if (rawContent.byteLength >= 9) {
                // Extract speaker ID (4 bytes)
                var speakerIdBytes = data.slice(1, 5);
                var speakerId_1 = new DataView(speakerIdBytes.buffer).getUint32(0, true);
                // Extract data size (4 bytes)
                var dataSizeBytes = data.slice(5, 9);
                var dataSize = new DataView(dataSizeBytes.buffer).getUint32(0, true);
                if (rawContent.byteLength === 9 + dataSize) {
                    // Extract audio data
                    var audioData = data.slice(9);
                    // Get speaker position from world model
                    var remoteServer = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_2__.RemoteServer);
                    var worldModel = remoteServer.getWorldModel();
                    var x = 0, y = 0, z = 0;
                    // Find the speaker in the world model to get position
                    var speakerForm = worldModel.forms.find(function (f) { return f && f.refrId === speakerId_1; });
                    if (speakerForm && speakerForm.movement) {
                        x = speakerForm.movement.pos[0];
                        y = speakerForm.movement.pos[1];
                        z = speakerForm.movement.pos[2];
                    }
                    this.onReceiveVoiceData(speakerId_1, audioData.buffer, x, y, z);
                }
            }
        }
    };
    // Get current push-to-talk key
    VoiceChatService.prototype.getPushToTalkKey = function () {
        return this.pushToTalkKey;
    };
    // Set push-to-talk key
    VoiceChatService.prototype.setPushToTalkKey = function (key) {
        if (this.isTalking) {
            this.stopTalking();
        }
        this.pushToTalkKey = key;
    };
    // Check if currently talking
    VoiceChatService.prototype.getIsTalking = function () {
        return this.isTalking;
    };
    // Check if voice chat is initialized
    VoiceChatService.prototype.getIsInitialized = function () {
        return this.isInitialized;
    };
    return VoiceChatService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/worldCleanerService.ts":
/*!******************************************************!*\
  !*** ./src/services/services/worldCleanerService.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WorldCleanerService: () => (/* binding */ WorldCleanerService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var WorldCleanerService = /** @class */ (function (_super) {
    __extends(WorldCleanerService, _super);
    function WorldCleanerService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.protection = new Map();
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.emitter.on("gameLoad", function () { return _this.onGameLoad(); });
        return _this;
    }
    WorldCleanerService.prototype.modWcProtection = function (actorId, mod) {
        var currentProtection = this.protection.get(actorId);
        this.protection.set(actorId, currentProtection ? currentProtection + mod : mod);
    };
    WorldCleanerService.prototype.getWcProtection = function (actorId) {
        return this.protection.get(actorId) || 0;
    };
    WorldCleanerService.prototype.onGameLoad = function () {
        var player = this.sp.Game.getPlayer();
        if (!player) {
            return;
        }
        this.initialPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(player);
        this.initialCellOrWorld = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(player);
    };
    WorldCleanerService.prototype.onUpdate = function () {
        this.processOneActor();
    };
    WorldCleanerService.prototype.processOneActor = function () {
        var _this = this;
        var _a;
        var pc = this.sp.Game.getPlayer();
        if (pc === null) {
            return;
        }
        var actor = this.sp.Game.findRandomActor(pc.getPositionX(), pc.getPositionY(), pc.getPositionZ(), 8192);
        if (actor === null) {
            return;
        }
        var actorId = actor.getFormID();
        var currentProtection = this.protection.get(actorId) || 0;
        if (currentProtection > 0) {
            return;
        }
        if (actorId === 0x14 || actor.isDisabled() || actor.isDeleted()) {
            return;
        }
        if (this.isActorInDialogue(actor)) {
            // Deleting actor in dialogue crashes Skyrim
            // https://github.com/skyrim-multiplayer/issue-tracker/issues/13
            actor.setPosition(0, 0, 0);
            actor.disableNoWait(true); // Seems to not crash
            return;
        }
        // Keep vanila pre-placed bodies, but delete player bodies
        if (actor.isDead() && actorId < 0xff000000) {
            actor.blockActivation(true);
            return;
        }
        var pos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(actor);
        var cellOrWorld = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(actor);
        var chickenRace = 0xa919d;
        // We discovered anomaly chickens that fail to Disable if we load game near to them
        // Refs: 106C22, 106C23
        if (actorId < 0xff000000 && ((_a = actor.getRace()) === null || _a === void 0 ? void 0 : _a.getFormID()) === chickenRace) {
            if (this.initialPos && _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getDistanceNoZ(pos, this.initialPos) < 4096) {
                if (cellOrWorld === this.initialCellOrWorld) {
                    if (this.isActorInDialogue(actor)) {
                        return;
                    }
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Deleting chicken anomaly", actorId.toString(16));
                    actor.killSilent(null);
                    actor.blockActivation(true);
                    actor.disableNoWait(false);
                    actor.setAlpha(0, false);
                    return;
                }
            }
        }
        actor.disable(false).then(function () {
            var ac = _this.sp.Actor.from(_this.sp.Game.getFormEx(actorId));
            if (!ac || _this.isActorInDialogue(ac)) {
                return;
            }
            ac.delete();
        });
    };
    WorldCleanerService.prototype.isActorInDialogue = function (ac) {
        return ac.isInDialogueWithPlayer() || ac.getDialogueTarget() !== null;
    };
    return WorldCleanerService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/spApiInteractor.ts":
/*!*****************************************!*\
  !*** ./src/services/spApiInteractor.ts ***!
  \*****************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpApiInteractor: () => (/* binding */ SpApiInteractor)
/* harmony export */ });
/* harmony import */ var _events_events__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./events/events */ "./src/services/events/events.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);


var SpApiInteractor = /** @class */ (function () {
    function SpApiInteractor() {
    }
    SpApiInteractor.setup = function (listeners) {
        listeners.forEach(function (listener) { return SpApiInteractor.registerListenerForLookup(listener.constructor, listener); });
    };
    SpApiInteractor.getControllerInstance = function () {
        if (SpApiInteractor.controller) {
            return SpApiInteractor.controller;
        }
        SpApiInteractor.controller = {
            // TODO: handle errors in event handlers. will output to game console by default
            on: skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.on,
            once: skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.once,
            emitter: _events_events__WEBPACK_IMPORTED_MODULE_0__.EventEmitterFactory.makeEventEmitter(),
            lookupListener: function (constructor) {
                var listener = SpApiInteractor.listenersForLookupByName.get(constructor);
                if (listener === undefined) {
                    throw new Error("listener not found for name '".concat(constructor.name, "'"));
                }
                if (!(listener instanceof constructor)) {
                    throw new Error("listener class mismatch for name '".concat(constructor.name, "'"));
                }
                return listener;
            },
        };
        return SpApiInteractor.controller;
    };
    SpApiInteractor.registerListenerForLookup = function (constructor, listener) {
        if (SpApiInteractor.listenersForLookupByName.has(constructor)) {
            throw new Error("listener re-registration for name '".concat(constructor, "'"));
        }
        SpApiInteractor.listenersForLookupByName.set(constructor, listener);
    };
    SpApiInteractor.listenersForLookupByName = new Map();
    return SpApiInteractor;
}());



/***/ }),

/***/ "./src/sync/actorvalues.ts":
/*!*********************************!*\
  !*** ./src/sync/actorvalues.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getActorValues: () => (/* binding */ getActorValues),
/* harmony export */   getMaximumActorValue: () => (/* binding */ getMaximumActorValue),
/* harmony export */   setActorValuePercentage: () => (/* binding */ setActorValuePercentage)
/* harmony export */ });
var getActorValues = function (ac) {
    if (!ac) {
        return { health: 0, stamina: 0, magicka: 0 };
    }
    var healthPercentage = (ac.isDead()) ? 0 : ac.getActorValuePercentage("health");
    var staminaPercentage = ac.getActorValuePercentage("stamina");
    var magickaPercentage = ac.getActorValuePercentage("magicka");
    var resultActorValue = {
        health: healthPercentage,
        stamina: staminaPercentage,
        magicka: magickaPercentage,
    };
    return resultActorValue;
};
var getMaximumActorValue = function (ac, avName) {
    var currentPercentage = ac.getActorValuePercentage(avName);
    return currentPercentage === 0 ?
        ac.getBaseActorValue(avName) :
        Math.ceil(ac.getActorValue(avName) / currentPercentage);
};
var setActorValuePercentage = function (ac, avName, percentage) {
    // Actor value percentage for health may be below zero (-1.8 for example, it means u have -180% health)
    var currentPercentage = ac.getActorValuePercentage(avName);
    if (currentPercentage === percentage) {
        return;
    }
    var currentMaxValue = getMaximumActorValue(ac, avName);
    var deltaPercentage = percentage - currentPercentage;
    if (deltaPercentage > 0) {
        ac.restoreActorValue(avName, deltaPercentage * currentMaxValue);
    }
    else if (deltaPercentage < 0) {
        ac.damageActorValue(avName, deltaPercentage * currentMaxValue);
    }
};


/***/ }),

/***/ "./src/sync/animation.ts":
/*!*******************************!*\
  !*** ./src/sync/animation.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnimationEventName: () => (/* binding */ AnimationEventName),
/* harmony export */   AnimationSource: () => (/* binding */ AnimationSource),
/* harmony export */   applyAnimation: () => (/* binding */ applyAnimation),
/* harmony export */   setDefaultAnimsDisabled: () => (/* binding */ setDefaultAnimsDisabled),
/* harmony export */   setupHooks: () => (/* binding */ setupHooks)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _movementApply__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./movementApply */ "./src/sync/movementApply.ts");
/* eslint-disable @typescript-eslint/no-empty-function */


var AnimationEventName;
(function (AnimationEventName) {
    AnimationEventName["Ragdoll"] = "Ragdoll";
    AnimationEventName["GetUpBegin"] = "GetUpBegin";
})(AnimationEventName || (AnimationEventName = {}));
;
var allowedIdles = new Array();
var refsWithDefaultAnimsDisabled = new Set();
var allowedAnims = new Set();
var actorSitAnimsLowerCase = [
    'idlestoolenterplayer',
    'idlestoolenter',
    'idlestoolenterinstant',
    'idlechairrightenter',
    'idlechairleftenter',
    'idlechairfrontenter',
    'idlechairenterinstant',
    'idlejarlchairenter',
    'idlejarlchairenterinstant',
    'idlesnowelfprincechairdialogue',
    'idlesnowelfprincechairenter',
    'idlesnowelfprincechairenterinstant',
    'idlechairchildenterinstant',
    'idlechairchildfrontenter',
    'idlechairchildleftenter',
    'idlechairchildrightenter',
];
var actorGetUpAnimsLowerCase = [
    'idlestoolbackexit',
    'idlechairrightexit',
    'idlechairrightquickexit',
    'idlechairleftexit',
    'idlechairleftquickexit',
    'idlechairfrontexit',
    'idlechairfrontquickexit',
    'idlechairchildfrontexit',
    'idlechairchildleftexit',
    'idlechairchildrightexit'
];
// It's critical for values to be the correct case, not just lowercase, otherwise 'allowedIdles' check will break
// We don't want to modify the check itself, because it'll be slower
var animOverridesLowerCase = {
    'idlechairbook_onepage': 'IdleChairEnterInstant',
    'idlechairshoulderflex': 'IdleChairEnterInstant',
    'idlechairwrite': 'IdleChairEnterInstant',
    'idlechairarmscrossedvar1': 'IdleChairEnterInstant',
    'chaireatingstart_vampiremeat': 'IdleChairEnterInstant',
    'chairreadingstart': 'IdleChairEnterInstant',
    'chairvampireeatingstart': 'IdleChairEnterInstant',
    'chairdrinkingstart': 'IdleChairEnterInstant',
    'chaireatingstart': 'IdleChairEnterInstant',
    // The only triple animation we know for now. One base anim to sit, then two to eat
    'chaireatingsoupstart': 'IdleChairEnterInstant',
    'idleeatsoup': 'IdleChairEnterInstant',
    // No need to re-play the animation, use instant variant for spawning actors
    // This is not essential, but makes the sync feel more smooth. The list is not complete.
    'idlechairrightenter': 'IdleChairEnterInstant',
    'idlechairleftenter': 'IdleChairEnterInstant',
    'idlechairfrontenter': 'IdleChairEnterInstant',
    // Untested yet looks correct
    'idlesnowelfprincefireandforget': 'IdleSnowElfPrinceChairEnterInstant',
    'idletablemugenter': 'IdleTableEnterInstant',
    'idletabledrinkenter': 'IdleTableEnterInstant',
    'idletabledrinkandmugenter': 'IdleTableEnterInstant'
};
// unclassified:
// IdleChairEnterInstant
// IdleChairEnterStart
// IdleChairEnterStop
// IdleChairEnterToSit
// IdleChairExitStart
// IdleChairExitToStand
// IdleChairSitting
// IdleLeftChairEnterStart
// ChairIdle
// IdleRightChairEnterStart
// IdleLeftChairEnterStart
var isIdle = function (animEventName) {
    var animEventNameLowerCase = animEventName.toLowerCase();
    return (animEventNameLowerCase === "motiondrivenidle" ||
        (animEventNameLowerCase.startsWith("idle") &&
            animEventNameLowerCase !== "idlestop" &&
            animEventNameLowerCase !== "idleforcedefaultstate"));
};
var applyAnimation = function (refr, anim, state) {
    if (state.lastNumChanges === anim.numChanges) {
        return;
    }
    state.lastNumChanges = anim.numChanges;
    if (state.useAnimOverrides) {
        var animOverride = animOverridesLowerCase[anim.animEventName.toLowerCase()];
        if (animOverride !== undefined) {
            anim.animEventName = animOverride;
        }
    }
    var animEventNameLowerCase = anim.animEventName.toLowerCase();
    if (isIdle(anim.animEventName)) {
        allowedIdles.push([refr.getFormID(), anim.animEventName]);
    }
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (anim.animEventName === "SkympFakeEquip") {
        if (ac) {
            (0,_movementApply__WEBPACK_IMPORTED_MODULE_1__.applyWeapDrawn)(ac, true);
        }
        return;
    }
    if (anim.animEventName === "SkympFakeUnequip") {
        if (ac) {
            (0,_movementApply__WEBPACK_IMPORTED_MODULE_1__.applyWeapDrawn)(ac, false);
        }
        return;
    }
    if (anim.animEventName === "Ragdoll") {
        if (ac) {
            if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["animationFunc1Set"] === true) {
                // @ts-ignore
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["animationFunc1"](ac);
            }
            else {
                ac.pushActorAway(ac, 0);
                ac.setActorValue("Variable10", -1000);
            }
        }
        return;
    }
    if (refsWithDefaultAnimsDisabled.has(refr.getFormID())) {
        if (animEventNameLowerCase.includes("attack")) {
            allowedAnims.add(refr.getFormID() + ":" + anim.animEventName);
        }
    }
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(refr, anim.animEventName);
    if (anim.animEventName === "GetUpBegin") {
        var refrId_1 = refr.getFormID();
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId_1));
            if (ac) {
                ac.setActorValue("Variable10", 1000);
            }
        });
    }
    if (actorSitAnimsLowerCase.find(function (x) { return x === animEventNameLowerCase; }) !== undefined) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setCollision)(refr.getFormID(), false);
    }
    if (actorGetUpAnimsLowerCase.find(function (x) { return x === animEventNameLowerCase; }) !== undefined) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setCollision)(refr.getFormID(), true);
    }
};
var setDefaultAnimsDisabled = function (refrId, disabled) {
    if (disabled) {
        refsWithDefaultAnimsDisabled.add(refrId);
    }
    else {
        refsWithDefaultAnimsDisabled.delete(refrId);
    }
};
var AnimationSource = /** @class */ (function () {
    function AnimationSource(refr) {
        var _this = this;
        this.refrId = 0;
        this.numChanges = 0;
        this.animEventName = "";
        this.weapNonDrawnBlocker = 0;
        this.weapDrawnBlocker = 0;
        this.sneakBlocker = null;
        this.refrId = refr.getFormID();
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.hooks.sendAnimationEvent.add({
            enter: function () { },
            leave: function (ctx) {
                if (ctx.selfId !== _this.refrId) {
                    return;
                }
                if (!ctx.animationSucceeded) {
                    // Workaround, see carryAnimSystem.ts in gamemode
                    // Case-sensetive check here for better performance
                    if (ctx.animEventName !== "OffsetCarryBasketStart") {
                        return;
                    }
                }
                _this.onSendAnimationEvent(ctx.animEventName);
            },
        });
    }
    AnimationSource.prototype.filterMovement = function (mov) {
        if (this.weapDrawnBlocker >= Date.now()) {
            mov.isWeapDrawn = true;
        }
        if (this.weapNonDrawnBlocker >= Date.now()) {
            mov.isWeapDrawn = false;
        }
        if (this.sneakBlocker === mov.isSneaking) {
            this.sneakBlocker = null;
        }
        else if (this.sneakBlocker === true) {
            mov.isSneaking = true;
        }
        else if (this.sneakBlocker === false) {
            mov.isSneaking = false;
        }
        return mov;
    };
    AnimationSource.prototype.getAnimation = function () {
        var _a = this, numChanges = _a.numChanges, animEventName = _a.animEventName;
        return { numChanges: numChanges, animEventName: animEventName };
    };
    AnimationSource.prototype.onSendAnimationEvent = function (animEventName) {
        if (ignoredAnims.has(animEventName)) {
            return;
        }
        var lower = animEventName.toLowerCase();
        var isTorchEvent = lower.includes("torch");
        if (animEventName.toLowerCase().includes("unequip") && !isTorchEvent) {
            this.weapNonDrawnBlocker = Date.now() + 300;
            animEventName = "SkympFakeUnequip";
        }
        else if (animEventName.toLowerCase().includes("equip") && !isTorchEvent) {
            this.weapDrawnBlocker = Date.now() + 300;
            animEventName = "SkympFakeEquip";
        }
        if (animEventName === "SneakStart") {
            this.sneakBlocker = true;
            return;
        }
        if (animEventName === "SneakStop") {
            this.sneakBlocker = false;
            return;
        }
        this.numChanges++;
        this.animEventName = animEventName;
    };
    return AnimationSource;
}());

var ignoredAnims = new Set([
    "moveStart",
    "moveStop",
    "turnStop",
    "CyclicCrossBlend",
    "CyclicFreeze",
    "TurnLeft",
    "TurnRight",
]);
var setupHooks = function () {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.hooks.sendAnimationEvent.add({
        enter: function (ctx) {
            if (refsWithDefaultAnimsDisabled.has(ctx.selfId)) {
                if (ctx.animEventName.toLowerCase().includes("attack")) {
                    var animKey = ctx.selfId + ":" + ctx.animEventName;
                    if (allowedAnims.has(animKey)) {
                        allowedAnims.delete(animKey);
                    }
                    else {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("block anim " + ctx.animEventName);
                        return (ctx.animEventName = "");
                    }
                }
            }
            // ShowRaceMenu forces this anim
            if (ctx.animEventName === "OffsetBoundStandingPlayerInstant") {
                return (ctx.animEventName = "");
            }
            // Disable idle animations for 0xff actors
            if (ctx.selfId < 0xff000000) {
                return;
            }
            if (isIdle(ctx.animEventName)) {
                var i = allowedIdles.findIndex(function (pair) {
                    return pair[0] === ctx.selfId && pair[1] === ctx.animEventName;
                });
                i === -1 ? (ctx.animEventName = "") : allowedIdles.splice(i, 1);
            }
        },
        leave: function () { },
    });
};


/***/ }),

/***/ "./src/sync/appearance.ts":
/*!********************************!*\
  !*** ./src/sync/appearance.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyAppearance: () => (/* binding */ applyAppearance),
/* harmony export */   applyAppearanceToPlayer: () => (/* binding */ applyAppearanceToPlayer),
/* harmony export */   applyTints: () => (/* binding */ applyTints),
/* harmony export */   getAppearance: () => (/* binding */ getAppearance),
/* harmony export */   silentVoiceTypeId: () => (/* binding */ silentVoiceTypeId)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var getAppearance = function (actor) {
    var base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(actor.getBaseObject());
    var hairColor = base.getHairColor();
    var skinColor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.getSkinColor(base);
    var newAppearance = {
        isFemale: base.getSex() === 1,
        raceId: base.getRace() ? base.getRace().getFormID() : 0,
        weight: base.getWeight(),
        hairColor: hairColor ? hairColor.getColor() : 0,
        headpartIds: [],
        headTextureSetId: base.getFaceTextureSet()
            ? base.getFaceTextureSet().getFormID()
            : 0,
        options: new Array(19),
        presets: new Array(4),
        tints: [],
        skinColor: skinColor ? skinColor.getColor() : 0,
        name: actor.getBaseObject().getName(),
    };
    var numHeadparts = base.getNumHeadParts();
    for (var i = 0; i < numHeadparts; ++i) {
        var part = base.getNthHeadPart(i);
        if (part) {
            newAppearance.headpartIds.push(part.getFormID());
        }
    }
    for (var i = 0; i < newAppearance.options.length; ++i) {
        newAppearance.options[i] = base.getFaceMorph(i);
    }
    for (var i = 0; i < newAppearance.presets.length; ++i) {
        newAppearance.presets[i] = base.getFacePreset(i);
    }
    var numTints = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getFormID() === actor.getFormID()
        ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNumTintMasks()
        : 0;
    for (var i = 0; i < numTints; ++i) {
        var tint = {
            texturePath: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskTexturePath(i),
            type: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskType(i),
            argb: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskColor(i),
        };
        newAppearance.tints.push(tint);
    }
    return newAppearance;
};
var isVisible = function (argb) { return argb > 0x00ffffff || argb < 0; };
var applyTints = function (actor, appearance) {
    if (!appearance) {
        throw new Error("null appearance has been passed to applyTints");
    }
    var tints = appearance.tints.filter(function (t) { return isVisible(t.argb); });
    var raceWarPaintRegex = /.*Head.+WarPaint.*/;
    var uniWarPaintRegex = /.*HeadWarPaint.*/;
    var raceSpecificWarPaint = tints.filter(function (t) { return isVisible(t.argb) && t.texturePath.match(raceWarPaintRegex); }).length; // MaleHeadNordWarPaint
    var uniWarPaint = tints.filter(function (t) { return isVisible(t.argb) && t.texturePath.match(uniWarPaintRegex); }).length; // MaleHeadWarPaint
    if (raceSpecificWarPaint + uniWarPaint > 1) {
        // If visible war paints of these two types present, then Skyrim crashes
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("bad warpaint!", raceSpecificWarPaint, uniWarPaint);
        return;
    }
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.clearTintMasks(actor);
    tints.forEach(function (tint) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.pushTintMask(actor, tint.type, tint.argb, tint.texturePath);
    });
    var playerBaseId = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getBaseObject().getFormID();
    if (actor)
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setFormIdUnsafe(actor.getBaseObject(), playerBaseId);
};
var silentVoiceTypeId = 0x0002f7c3;
var applyAppearanceCommon = function (appearance, npc) {
    var race = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Race.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(appearance.raceId));
    var headparts = appearance.headpartIds
        .map(function (id) { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.HeadPart.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id)); })
        .filter(function (headpart) { return !!headpart; });
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcSex(npc, appearance.isFemale ? 1 : 0);
    if (race) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcRace(npc, race);
    }
    npc.setWeight(appearance.weight);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcSkinColor(npc, appearance.skinColor);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcHairColor(npc, appearance.hairColor);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.resizeHeadpartsArray(npc, headparts.length);
    headparts.forEach(function (v, i) { return npc.setNthHeadPart(v, i); });
    npc.setFaceTextureSet(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TextureSet.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(appearance.headTextureSetId))); // setFaceTextureSet supports null argument
    npc.setVoiceType(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.VoiceType.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(silentVoiceTypeId)));
    appearance.options.forEach(function (v, i) { return npc.setFaceMorph(v, i); });
    appearance.presets.forEach(function (v, i) { return npc.setFacePreset(v, i); });
    if (appearance.name) {
        npc.setName(appearance.name);
    }
    else {
        // for undefined or empty name
        npc.setName(" ");
    }
};
var applyAppearance = function (appearance) {
    var npc = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.createNpc();
    if (!npc) {
        throw new Error("createNpc returned null");
    }
    applyAppearanceCommon(appearance, npc);
    return npc;
};
var applyAppearanceToPlayer = function (appearance) {
    applyAppearanceCommon(appearance, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getBaseObject()));
    applyTints(null, appearance);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().queueNiNodeUpdate();
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.0625).then(function () {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
            var _a;
            (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.startDeferredKill();
        });
    });
};


/***/ }),

/***/ "./src/sync/equipment.ts":
/*!*******************************!*\
  !*** ./src/sync/equipment.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyEquipment: () => (/* binding */ applyEquipment),
/* harmony export */   getEquipedSpell: () => (/* binding */ getEquipedSpell),
/* harmony export */   getEquipment: () => (/* binding */ getEquipment),
/* harmony export */   isBadMenuShown: () => (/* binding */ isBadMenuShown),
/* harmony export */   syncSpellEquipment: () => (/* binding */ syncSpellEquipment)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _inventory__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./inventory */ "./src/sync/inventory.ts");


var getEquipedSpell = function (refr, spellType) {
    var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (!actor) {
        return 0;
    }
    switch (spellType) {
        case 0 /* SpellType.Left */: {
            var spell = actor.getEquippedSpell(0 /* SpellType.Left */);
            return spell ? spell.getFormID() : 0;
        }
        case 1 /* SpellType.Right */: {
            var spell = actor.getEquippedSpell(1 /* SpellType.Right */);
            return spell ? spell.getFormID() : 0;
        }
        case 2 /* SpellType.Voice */: {
            var spell = actor.getEquippedSpell(2 /* SpellType.Voice */);
            return spell ? spell.getFormID() : 0;
        }
        case 3 /* SpellType.Instant */: {
            var spell = actor.getEquippedSpell(3 /* SpellType.Instant */);
            return spell ? spell.getFormID() : 0;
        }
        default: {
            return 0;
        }
    }
};
var filterWorn = function (inv) {
    return { entries: inv.entries.filter(function (x) { return x.worn || x.wornLeft; }) };
};
var removeUnnecessaryExtra = function (inv, ignoreAmmo) {
    return {
        entries: inv.entries.map(function (x) {
            var r = JSON.parse(JSON.stringify(x));
            r.chargePercent = r.maxCharge;
            if (ignoreAmmo) {
                r.count = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(x.baseId)) ? r.count : 1;
            }
            else {
                r.count = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(x.baseId)) ? 1000 : 1;
            }
            delete r.name;
            return r;
        }),
    };
};
var getEquipment = function (ac, numChanges) {
    return {
        inv: (0,_inventory__WEBPACK_IMPORTED_MODULE_1__.getInventory)(ac),
        leftSpell: getEquipedSpell(ac, 0 /* SpellType.Left */),
        rightSpell: getEquipedSpell(ac, 1 /* SpellType.Right */),
        voiceSpell: getEquipedSpell(ac, 2 /* SpellType.Voice */),
        instantSpell: getEquipedSpell(ac, 3 /* SpellType.Instant */),
        numChanges: numChanges,
    };
};
var syncSpellEquipment = function (ac, spellBaseId, spellType) {
    if (spellBaseId !== undefined && spellBaseId > 0) {
        ac.equipSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Spell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(spellBaseId)), spellType);
    }
    else {
        var equipedSpell = ac.getEquippedSpell(spellType);
        if (equipedSpell) {
            ac.unequipSpell(equipedSpell, spellType);
        }
    }
};
var applyEquipment = function (ac, eq) {
    ac.removeAllItems(null, false, true);
    ac.unequipAll();
    ac.removeAllItems(null, false, true);
    var newInventory = removeUnnecessaryExtra(filterWorn(eq.inv), ac.getFormID() === 0x14);
    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setInventory)(ac.getFormID(), newInventory);
    syncSpellEquipment(ac, eq.leftSpell, 0 /* SpellType.Left */);
    syncSpellEquipment(ac, eq.rightSpell, 1 /* SpellType.Right */);
    syncSpellEquipment(ac, eq.voiceSpell, 2 /* SpellType.Voice */);
    syncSpellEquipment(ac, eq.instantSpell, 3 /* SpellType.Instant */);
    return true;
};
var isBadMenuShown = function () {
    return (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('InventoryMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('FavoritesMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('MagicMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('ContainerMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('Crafting Menu') // Actually I don't think it causes crashes
    );
};


/***/ }),

/***/ "./src/sync/inventory.ts":
/*!*******************************!*\
  !*** ./src/sync/inventory.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyInventory: () => (/* binding */ applyInventory),
/* harmony export */   getDiff: () => (/* binding */ getDiff),
/* harmony export */   getInventory: () => (/* binding */ getInventory),
/* harmony export */   hasExtras: () => (/* binding */ hasExtras),
/* harmony export */   removeSimpleItemsAsManyAsPossible: () => (/* binding */ removeSimpleItemsAsManyAsPossible),
/* harmony export */   sumInventories: () => (/* binding */ sumInventories)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

// 'loxsword (Legendary)' => 'loxsword'
var getRealName = function (s) {
    if (!s) {
        return s;
    }
    var arr = s.split(" ");
    if (arr.length && arr[arr.length - 1].match(/^\(.*\)$/)) {
        arr.pop();
    }
    return arr.join(" ");
};
// 'aaaaaaaaaaaaaaaa' => 'aaa...'
var cropName = function (s) {
    if (!s) {
        return s;
    }
    var max = 128;
    return s.length >= max
        ? s
            .split("")
            .filter(function (x, i) { return i < max; })
            .join("")
            .concat("...")
        : s;
};
var checkIfNameIsGeneratedByGame = function (aStr, bStr, formName) {
    if (!aStr.length && bStr.startsWith(formName)) {
        var bEnding = bStr.substr(formName.length);
        if (bEnding.match(/^\s\(.*\)$/)) {
            return true;
        }
    }
    return false;
};
var namesEqual = function (a, b) {
    var aStr = a.name || "";
    var bStr = b.name || "";
    if (cropName(getRealName(aStr)) === cropName(getRealName(bStr))) {
        return true;
    }
    if (a.baseId === b.baseId) {
        var form = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(a.baseId);
        if (form) {
            var formName = form.getName();
            if (checkIfNameIsGeneratedByGame(aStr, bStr, formName) ||
                checkIfNameIsGeneratedByGame(bStr, aStr, formName))
                return true;
        }
    }
    return false;
};
var extrasEqual = function (a, b, ignoreWorn) {
    if (ignoreWorn === void 0) { ignoreWorn = false; }
    return (a.health === b.health &&
        a.enchantmentId === b.enchantmentId &&
        a.maxCharge === b.maxCharge &&
        !!a.removeEnchantmentOnUnequip === !!b.removeEnchantmentOnUnequip &&
        a.chargePercent === b.chargePercent &&
        //namesEqual(a, b) &&
        a.soul === b.soul &&
        a.poisonId === b.poisonId &&
        a.poisonCount === b.poisonCount &&
        ((!!a.worn === !!b.worn && !!a.wornLeft === !!b.wornLeft) || ignoreWorn));
};
var hasExtras = function (e) {
    return !extrasEqual(e, { baseId: 0, count: 0 });
};
var extractExtraData = function (refr, extraList, out) {
    // I see that ExtraWorn is not emitted for 0xFF actors when arrows are equipped. Fixing
    var item = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(out.baseId);
    if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(item)) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (actor && actor.isEquipped(item)) {
            out.worn = true;
        }
    }
    (extraList || []).forEach(function (extra) {
        switch (extra.type) {
            case "Health":
                out.health = Math.round(extra.health * 10) / 10;
                // TESModPlatform::AddItemEx makes all items at least 1.01 health
                if (out.health === 1) {
                    delete out.health;
                }
                break;
            case "Count":
                out.count = extra.count;
                break;
            case "Enchantment":
                out.enchantmentId = extra.enchantmentId;
                out.maxCharge = extra.maxCharge;
                out.removeEnchantmentOnUnequip = extra.removeOnUnequip;
                break;
            case "Charge":
                out.chargePercent = extra.charge;
                break;
            case "Poison":
                out.poisonId = extra.poisonId;
                out.poisonCount = extra.count;
                break;
            case "Soul":
                out.soul = extra.soul;
                break;
            case "TextDisplayData":
                out.name = extra.name;
                break;
            case "Worn":
                out.worn = true;
                break;
            case "WornLeft":
                out.wornLeft = true;
                break;
        }
    });
};
var squash = function (inv) {
    var res = new Array();
    inv.entries.forEach(function (e) {
        var same = res.find(function (x) { return e.baseId === x.baseId && extrasEqual(x, e); });
        if (same) {
            same.count += e.count;
        }
        else {
            res.push(JSON.parse(JSON.stringify(e)));
        }
    });
    return { entries: res.filter(function (x) { return x.count !== 0; }) };
};
var getExtraContainerChangesAsInventory = function (refr) {
    var extraContainerChanges = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getExtraContainerChanges)(refr.getFormID());
    var entries = new Array();
    (extraContainerChanges || []).forEach(function (changesEntry) {
        var entry = {
            baseId: changesEntry.baseId,
            count: changesEntry.countDelta,
        };
        (changesEntry.extendDataList || []).forEach(function (extraList) {
            var e = {
                baseId: entry.baseId,
                count: 1,
            };
            extractExtraData(refr, extraList, e);
            entries.push(e);
            entry.count -= e.count;
        });
        if (entry.count !== 0) {
            entries.push(entry);
        }
    });
    var res = { entries: entries };
    res = squash(res);
    return res;
};
var getBaseContainerAsInventory = function (refr) {
    return {
        entries: (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getContainer)(refr.getBaseObject().getFormID()),
    };
};
var sumInventories = function (lhs, rhs) {
    var leftEntriesWithExtras = lhs.entries.filter(function (e) { return hasExtras(e); });
    var rightEntriesWithExtras = rhs.entries.filter(function (e) { return hasExtras(e); });
    var leftEntriesSimple = lhs.entries.filter(function (e) { return !hasExtras(e); });
    var rightEntriesSimple = rhs.entries.filter(function (e) { return !hasExtras(e); });
    leftEntriesSimple.forEach(function (e) {
        var matching = rightEntriesSimple.find(function (x) { return x.baseId === e.baseId; });
        if (matching) {
            e.count += matching.count;
            matching.count = 0;
        }
    });
    return {
        entries: leftEntriesWithExtras
            .concat(rightEntriesWithExtras)
            .concat(leftEntriesSimple)
            .concat(rightEntriesSimple)
            .filter(function (e) { return e.count !== 0; }),
    };
};
var removeSimpleItemsAsManyAsPossible = function (inv, baseId, count) {
    var res = { entries: [] };
    res.entries = JSON.parse(JSON.stringify(inv.entries));
    var entry = res.entries.find(function (e) { return !hasExtras(e) && e.baseId === baseId; });
    if (entry) {
        entry.count -= count;
    }
    res.entries = res.entries.filter(function (e) { return e.count > 0; });
    return res;
};
var getDiff = function (lhs, rhs, ignoreWorn) {
    var lhsCopy = JSON.parse(JSON.stringify(lhs));
    var rhsCopy = JSON.parse(JSON.stringify(rhs));
    rhsCopy.entries.forEach(function (e) {
        var sameFromLeft = lhsCopy.entries.find(function (x) { return x.baseId === e.baseId && extrasEqual(x, e, ignoreWorn); });
        if (sameFromLeft) {
            sameFromLeft.count -= e.count;
        }
        else {
            lhsCopy.entries.push(e);
            lhsCopy.entries[lhsCopy.entries.length - 1].count *= -1;
        }
    });
    return { entries: lhsCopy.entries.filter(function (x) { return x.count !== 0; }) };
};
var getInventory = function (refr) {
    return squash(sumInventories(getBaseContainerAsInventory(refr), getExtraContainerChangesAsInventory(refr)));
};
var basesReset = function () {
    if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesResetExists"] !== true) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesResetExists"] = true;
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesReset"] = new Set();
    }
    return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesReset"];
};
var resetBase = function (refr) {
    var base = refr.getBaseObject();
    var baseId = base ? base.getFormID() : 0;
    if (!basesReset().has(baseId)) {
        basesReset().add(baseId);
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.resetContainer(base);
        refr.removeAllItems(null, false, true);
    }
};
var applyInventory = function (refr, newInventory, enableCrashProtection, ignoreWorn) {
    if (ignoreWorn === void 0) { ignoreWorn = false; }
    resetBase(refr);
    var diff = getDiff(newInventory, getInventory(refr), ignoreWorn).entries;
    var res = true;
    diff.sort(function (a, b) { return (a.count < b.count ? -1 : 1); });
    diff.forEach(function (e, i) {
        if (i > 0 && enableCrashProtection) {
            res = false;
            return;
        }
        var absCount = Math.abs(e.count);
        var queueNiNodeUpdateNeeded = false;
        var worn = !!e.worn;
        var wornLeft = !!e.wornLeft;
        var oneStepCount = e.count / absCount;
        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.baseId);
        if (!f) {
            return (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Bad form ID ".concat(e.baseId.toString(16)));
        }
        var type = f.getType();
        // For misc items, potions and ingredients we don't want to split them into multiple items
        // This was made to fix a performance issue with users having 10000+ of misc items (i.e. gold)
        if (type === 32 /* FormType.Misc */ ||
            type === 46 /* FormType.Potion */ ||
            type === 30 /* FormType.Ingredient */) {
            absCount = 1;
            oneStepCount = e.count;
        }
        else {
            if (absCount > 1000) {
                absCount = 1;
                oneStepCount = 1;
                // Also for arrows with strange count
                if (worn && e.count < 0) {
                    absCount = 0;
                }
            }
            if (e.count > 1 && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.baseId))) {
                absCount = 1;
                oneStepCount = e.count;
                if (e.count > 60000) {
                    // Why would actor have 60k arrows?
                    e.count = 1;
                }
            }
        }
        for (var i_1 = 0; i_1 < absCount; ++i_1) {
            if (worn || wornLeft) {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.pushWornState(!!worn, !!wornLeft);
                queueNiNodeUpdateNeeded = true;
            }
            var addItemExArgs = void 0;
            addItemExArgs = [
                refr,
                f,
                oneStepCount,
                e.health ? e.health : 1,
                e.enchantmentId
                    ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Enchantment.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.enchantmentId))
                    : null,
                e.maxCharge ? e.maxCharge : 0,
                !!e.removeEnchantmentOnUnequip,
                e.chargePercent ? e.chargePercent : 0,
                e.name ? cropName(e.name) : f.getName(),
                e.soul ? e.soul : 0,
                e.poisonId ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Potion.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.poisonId)) : null,
                e.poisonCount ? e.poisonCount : 0
            ];
            var argsToPrint = addItemExArgs.map(function (arg) {
                if (arg instanceof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference) {
                    return "ObjectReference(".concat(arg.getFormID().toString(16), ")");
                }
                else if (arg instanceof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Form) {
                    return "Form(".concat(arg.getFormID().toString(16), ")");
                }
                else {
                    return JSON.stringify(arg);
                }
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("TESModPlatform.addItemEx(".concat(argsToPrint.join(", "), ")"));
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.addItemEx.apply(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform, addItemExArgs);
        }
        if (queueNiNodeUpdateNeeded) {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (ac) {
                ac.queueNiNodeUpdate();
            }
        }
    });
    return res;
};


/***/ }),

/***/ "./src/sync/movementApply.ts":
/*!***********************************!*\
  !*** ./src/sync/movementApply.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyMovement: () => (/* binding */ applyMovement),
/* harmony export */   applyWeapDrawn: () => (/* binding */ applyWeapDrawn)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");




var sqr = function (x) { return x * x; };
var applyMovement = function (refr, m, isMyClone) {
    if (teleportIfNeed(refr, m)) {
        return;
    }
    // Z axis isn't useful here
    var acX = refr.getPositionX();
    var acY = refr.getPositionY();
    var lagUnitsNoZ = Math.round(Math.sqrt(sqr(m.pos[0] - acX) + sqr(m.pos[1] - acY)));
    if (isMyClone === true) {
        _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__.SpApiInteractor.getControllerInstance().emitter.emit("newLocalLagValueCalculated", { lagUnitsNoZ: lagUnitsNoZ });
    }
    translateTo(refr, m);
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (!ac) {
        return;
    }
    var lookAt = null;
    if (m.lookAt) {
        try {
            lookAt = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.findClosestActor(m.lookAt[0], m.lookAt[1], m.lookAt[2], 128);
        }
        catch (e) {
            lookAt = null;
        }
    }
    if (lookAt) {
        ac.setHeadTracking(true);
        ac.setLookAt(lookAt, false);
    }
    else {
        ac.setHeadTracking(false);
    }
    // ac.stopCombat();
    ac.blockActivation(true);
    keepOffsetFromActor(ac, m);
    applySprinting(ac, m.runMode === "Sprinting");
    applyBlocking(ac, m);
    applySneaking(ac, m.isSneaking);
    applyWeapDrawn(ac, m.isWeapDrawn);
    applyHealthPercentage(ac, m.healthPercentage);
    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__.SpApiInteractor.getControllerInstance().emitter.emit("applyDeathStateEvent", { actor: ac, isDead: m.isDead });
};
var keepOffsetFromActor = function (ac, m) {
    var offsetAngle = m.rot[2] - ac.getAngleZ();
    if (Math.abs(offsetAngle) < 5) {
        offsetAngle = 0;
    }
    if (m.runMode === "Standing") {
        return ac.keepOffsetFromActor(ac, 0, 0, 0, 0, 0, offsetAngle, 1, 1);
    }
    var offset = [
        3 * Math.sin((m.direction / 180) * Math.PI),
        3 * Math.cos((m.direction / 180) * Math.PI),
        getOffsetZ(m.runMode),
    ];
    ac.keepOffsetFromActor(ac, offset[0], offset[1], offset[2], 0, 0, offsetAngle, m.runMode === "Walking" ? 2048 : 1, 1);
};
var getOffsetZ = function (runMode) {
    switch (runMode) {
        case "Walking":
            return -512;
        case "Running":
            return -1024;
    }
    return 0;
};
var applySprinting = function (ac, isSprinting) {
    if (ac.isSprinting() != isSprinting) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, isSprinting ? "SprintStart" : "SprintStop");
    }
};
var applyBlocking = function (ac, m) {
    if (ac.getAnimationVariableBool("IsBlocking") != m.isBlocking) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, m.isBlocking ? "BlockStart" : "BlockStop");
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, m.isSneaking ? "SneakStart" : "SneakStop");
    }
};
var applySneaking = function (ac, isSneaking) {
    var currentIsSneaking = ac.isSneaking() || ac.getAnimationVariableBool("IsSneaking");
    if (currentIsSneaking != isSneaking) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, isSneaking ? "SneakStart" : "SneakStop");
    }
};
var applyWeapDrawn = function (ac, isWeapDrawn) {
    if (ac.isWeaponDrawn() !== isWeapDrawn) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, isWeapDrawn ? 1 : 0);
    }
};
var applyHealthPercentage = function (ac, healthPercentage) {
    var currentPercentage = ac.getActorValuePercentage('health');
    if (currentPercentage === healthPercentage) {
        return;
    }
    var currentMax = ac.getBaseActorValue('health');
    var deltaPercentage = healthPercentage - currentPercentage;
    var k = 0.25;
    if (deltaPercentage > 0) {
        ac.restoreActorValue('health', deltaPercentage * currentMax * k);
    }
    else if (deltaPercentage < 0) {
        ac.damageActorValue('health', deltaPercentage * currentMax * k);
    }
};
// Use global temp var to avoid allocation of an array on each translateTo
var gTempTargetPos = [0, 0, 0];
var translateTo = function (refr, m) {
    var _a;
    var time = 0.2;
    if (m.isInJumpState || m.runMode !== "Standing") {
        time = 0.2;
    }
    // Local lag compensation
    // TODO: Remove "|| 0" hack (added to support old MpClientPlugin)
    var distanceAdd = (m.speed || 0) * time;
    var direction = m.rot[2] + m.direction;
    gTempTargetPos[0] = m.pos[0];
    gTempTargetPos[1] = m.pos[1];
    gTempTargetPos[2] = m.pos[2];
    // We do not want to add pos in case of standing-jumping
    if (m.runMode !== "Standing") {
        gTempTargetPos[0] += Math.sin(direction / 180 * Math.PI) * distanceAdd;
        gTempTargetPos[1] += Math.cos(direction / 180 * Math.PI) * distanceAdd;
    }
    var refrRealPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(refr);
    var distance = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(refrRealPos, gTempTargetPos);
    var speed = distance / time;
    var angleDiff = Math.abs(m.rot[2] - refr.getAngleZ());
    if (m.runMode !== "Standing" ||
        m.isInJumpState ||
        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistanceNoZ(refrRealPos, gTempTargetPos) > 8 ||
        angleDiff > 80 ||
        ((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) === null || _a === void 0 ? void 0 : _a.getSitState()) === 3) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (actor && actor.getActorValue("Variable10") < -999) {
            return;
        }
        if (!actor || !actor.isDead()) {
            refr.translateTo(gTempTargetPos[0], gTempTargetPos[1], gTempTargetPos[2], m.rot[0], m.rot[1], m.rot[2], speed, 0);
        }
    }
};
var teleportIfNeed = function (refr, m) {
    if (isInDifferentWorldOrCell(refr, m.worldOrCell) ||
        (!refr.is3DLoaded() && isInDifferentExteriorCell(refr, m.pos))) {
        throw new _lib_errors__WEBPACK_IMPORTED_MODULE_1__.RespawnNeededError("needs to be respawned");
    }
    return false;
};
var cellWidth = 4096;
var isInDifferentExteriorCell = function (refr, pos) {
    var currentPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(refr);
    var playerPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
    var targetDistanceToPlayer = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(playerPos, pos);
    var currentDistanceToPlayer = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(playerPos, currentPos);
    return currentDistanceToPlayer > cellWidth && targetDistanceToPlayer <= cellWidth;
};
var isInDifferentWorldOrCell = function (refr, worldOrCell) {
    return worldOrCell !== _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getWorldOrCell(refr);
};


/***/ }),

/***/ "./src/sync/movementGet.ts":
/*!*********************************!*\
  !*** ./src/sync/movementGet.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getMovement: () => (/* binding */ getMovement)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");


var PlayerCharacterSpeedCalculator = /** @class */ (function () {
    function PlayerCharacterSpeedCalculator() {
    }
    PlayerCharacterSpeedCalculator.savePosition = function (pos, worldOrCell) {
        this.lastPcPos = pos;
        this.lastPcPosCheck = Date.now();
        this.lastPcWorldOrCell = worldOrCell;
    };
    PlayerCharacterSpeedCalculator.getSpeed = function (currentPos, worldOrCell) {
        if (this.lastPcPosCheck === -1) {
            return 0;
        }
        var timeDeltaSec = (Date.now() - this.lastPcPosCheck) / 1000;
        if (timeDeltaSec > 5)
            return 0; // Too inaccurate
        if (timeDeltaSec === 0)
            return 0; // Division by zero
        if (worldOrCell !== this.lastPcWorldOrCell) {
            return 0;
        }
        var distance = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getDistance(currentPos, this.lastPcPos);
        return distance / timeDeltaSec;
    };
    PlayerCharacterSpeedCalculator.lastPcPos = [0, 0, 0];
    PlayerCharacterSpeedCalculator.lastPcPosCheck = -1;
    PlayerCharacterSpeedCalculator.lastPcWorldOrCell = 0;
    return PlayerCharacterSpeedCalculator;
}());
var getMovement = function (refr, form) {
    var _a;
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    // It is running for ObjectReferences because Standing
    // Doesn't lead to translateTo call
    var runMode = ac ? getRunMode(ac) : "Running";
    var healthPercentage = ac && ac.getActorValuePercentage("health");
    if (ac && ac.isDead()) {
        healthPercentage = 0;
    }
    var lookAt = undefined;
    if (refr.getFormID() !== 0x14) {
        var combatTarget = ac === null || ac === void 0 ? void 0 : ac.getCombatTarget();
        if (combatTarget) {
            lookAt = [
                combatTarget.getPositionX(),
                combatTarget.getPositionY(),
                combatTarget.getPositionZ(),
            ];
        }
    }
    var pos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(refr);
    var speed;
    if (refr.getFormID() !== 0x14) {
        speed = refr.getAnimationVariableFloat("SpeedSampled");
    }
    else {
        // Real players often run into the wall.
        // We need to have zero speed in this case. SpeedSampled doesn't help
        var w = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(refr);
        speed = PlayerCharacterSpeedCalculator.getSpeed(pos, w);
        PlayerCharacterSpeedCalculator.savePosition(pos, w);
        // It's unrealistic speed. It still may happen due to teleports
        if (speed > 2000) {
            speed = 0;
        }
    }
    var worldOrCell = refr.getWorldSpace() || refr.getParentCell();
    return {
        worldOrCell: (worldOrCell === null || worldOrCell === void 0 ? void 0 : worldOrCell.getFormID()) || 0,
        pos: pos,
        rot: [refr.getAngleX(), refr.getAngleY(), refr.getAngleZ()],
        runMode: runMode,
        direction: runMode !== "Standing"
            ? 360 * refr.getAnimationVariableFloat("Direction")
            : 0,
        isInJumpState: !!(ac && ac.getAnimationVariableBool("bInJumpState")),
        isSneaking: !!(ac && isSneaking(ac)),
        isBlocking: !!(ac && ac.getAnimationVariableBool("IsBlocking")),
        isWeapDrawn: !!(ac && ac.isWeaponDrawn()),
        isDead: ((_a = form === null || form === void 0 ? void 0 : form.isDead) !== null && _a !== void 0 ? _a : false) || !!(ac && ac.isDead()),
        healthPercentage: healthPercentage || 0,
        lookAt: lookAt,
        speed: speed
    };
};
var isSneaking = function (ac) {
    return ac.isSneaking() || ac.getAnimationVariableBool("IsSneaking");
};
var getRunMode = function (ac) {
    if (ac.isSprinting()) {
        return "Sprinting";
    }
    var speed = ac.getAnimationVariableFloat("SpeedSampled");
    if (!speed) {
        return "Standing";
    }
    var furniture = ac.getFurnitureReference();
    if (furniture !== null)
        return "Standing"; // TODO: Sitting?
    var isRunning = true;
    if (ac.getFormID() == 0x14) {
        if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.isPlayerRunningEnabled() || speed < 150)
            isRunning = false;
    }
    else {
        if (!ac.isRunning() || speed < 150) {
            isRunning = false;
        }
    }
    if (ac.getAnimationVariableFloat("IsBlocking")) {
        isRunning = isSneaking(ac);
    }
    var carryWeight = ac.getActorValue("CarryWeight");
    var totalItemWeight = ac.getTotalItemWeight();
    if (carryWeight < totalItemWeight) {
        isRunning = false;
    }
    return isRunning ? "Running" : "Walking";
};


/***/ }),

/***/ "./src/sync/spell.ts":
/*!***************************!*\
  !*** ./src/sync/spell.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   learnSpells: () => (/* binding */ learnSpells),
/* harmony export */   removeAllSpells: () => (/* binding */ removeAllSpells)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var removeAllSpells = function (actor) {
    var spellToRemove = new Array();
    for (var i = 0; i < actor.getSpellCount(); i++) {
        var spell = actor.getNthSpell(i);
        if (spell) {
            spellToRemove.push(spell);
        }
    }
    for (var _i = 0, spellToRemove_1 = spellToRemove; _i < spellToRemove_1.length; _i++) {
        var spell = spellToRemove_1[_i];
        var removeResult = actor.removeSpell(spell);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("removeResult: ".concat(removeResult, ", spellIdToRemove: ").concat(spell
            .getFormID()
            .toString(16), ", spellName: ").concat(spell.getName()));
    }
};
var learnSpells = function (actor, spellsIds) {
    for (var _i = 0, spellsIds_1 = spellsIds; _i < spellsIds_1.length; _i++) {
        var spellId = spellsIds_1[_i];
        var spell = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Spell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(spellId));
        if (spell) {
            var addResult = actor.addSpell(spell, false);
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("addResult: ".concat(addResult, ", spellIdToLearn: ").concat(spell
                .getFormID()
                .toString(16), ", spellName: ").concat(spell.getName()));
        }
    }
};


/***/ }),

/***/ "./src/version.ts":
/*!************************!*\
  !*** ./src/version.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   requiredVersion: () => (/* binding */ requiredVersion),
/* harmony export */   verifyVersion: () => (/* binding */ verifyVersion)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var requiredVersion = '2.9.0';
var realVersion = typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getPlatformVersion === 'function' ? (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getPlatformVersion)() : 'unknown';
// TODO: no one actually calls this function. make a service
var verifyVersion = function () {
    if (!requiredVersion.includes(realVersion)) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.messageBox("You need to have on of those SkyrimPlatform versions ".concat(JSON.stringify(requiredVersion), " to join this server. Your current version is ").concat(realVersion));
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.waitMenuMode(0.5).then(function () {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.on)('update', function () {
                if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('MessageBoxMenu')) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.quitToMainMenu();
                }
            });
        });
    }
};


/***/ }),

/***/ "./src/view/formView.ts":
/*!******************************!*\
  !*** ./src/view/formView.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormView: () => (/* binding */ FormView),
/* harmony export */   getScreenResolution: () => (/* binding */ getScreenResolution)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _sync_movementApply__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../sync/movementApply */ "./src/sync/movementApply.ts");
/* harmony import */ var _spawnProcess__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./spawnProcess */ "./src/view/spawnProcess.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./playerCharacterDataHolder */ "./src/view/playerCharacterDataHolder.ts");
/* harmony import */ var _sync_movementGet__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../sync/movementGet */ "./src/sync/movementGet.ts");
/* harmony import */ var _hostAttempts__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./hostAttempts */ "./src/view/hostAttempts.ts");
/* harmony import */ var _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./modelApplyUtils */ "./src/view/modelApplyUtils.ts");
/* harmony import */ var _worldViewMisc__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ../services/services/worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");
















var _screenResolution;
var getScreenResolution = function () {
    if (!_screenResolution) {
        _screenResolution = {
            width: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.getINIInt("iSize W:Display"),
            height: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.getINIInt("iSize H:Display"),
        };
    }
    return _screenResolution;
};
var FormView = /** @class */ (function () {
    function FormView(remoteRefrId) {
        this.remoteRefrId = remoteRefrId;
        this.lastHarvestedApply = 0;
        this.lastOpenApply = 0;
        this.isSetNodeTextureSetApplied = false;
        this.isSetNodeScaleApplied = false;
        this.refrId = 0;
        this.ready = false;
        this.animState = this.getDefaultAnimState();
        this.movState = {
            lastNumChanges: 0,
            lastApply: 0,
            lastRehost: 0,
            everApplied: false,
        };
        this.appearanceState = this.getDefaultAppearanceState();
        this.eqState = this.getDefaultEquipState();
        this.appearanceBasedBaseId = 0;
        this.leveledBaseId = 0;
        this.isOnScreen = false;
        this.lastPcWorldOrCell = 0;
        this.lastWorldOrCell = 0;
        this.spawnMoment = 0;
        this.wasHostedByOther = undefined;
        this.state = {};
        this.localImmortal = false;
        this.textNameId = undefined;
        this.voiceIndicatorId = undefined;
    }
    FormView.prototype.update = function (model) {
        var _this = this;
        var _a, _b, _c, _d, _e, _f, _g, _h;
        // Other players mutate into PC clones when moving to another location
        if (model.movement) {
            if (!this.lastWorldOrCell)
                this.lastWorldOrCell = model.movement.worldOrCell;
            if (this.lastWorldOrCell !== model.movement.worldOrCell) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("[1] worldOrCell changed, destroying FormView ".concat(this.lastWorldOrCell.toString(16), " => ").concat(model.movement.worldOrCell.toString(16)));
                this.lastWorldOrCell = model.movement.worldOrCell;
                this.destroy();
                this.refrId = 0;
                this.appearanceBasedBaseId = 0;
                return;
            }
        }
        // Don't spawn dead actors if not already
        if (model.isDead) {
            if (this.refrId === 0) {
                return;
            }
        }
        // Players with different worldOrCell should be invisible
        if (model.movement) {
            var worldOrCell = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.getWorldOrCell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
            if (worldOrCell !== 0 &&
                model.movement.worldOrCell !== worldOrCell) {
                this.destroy();
                this.refrId = 0;
                return;
            }
        }
        // Apply appearance before base form selection to prevent double-spawn
        if (model.appearance || (!model.appearance && this.appearanceState.appearance)) {
            if (!this.appearanceState.appearance ||
                model.numAppearanceChanges !== this.appearanceState.lastNumChanges) {
                // Both non-null
                if (model.appearance && this.appearanceState.appearance) {
                    var modelAppearanceCopy = JSON.parse(JSON.stringify(model.appearance));
                    var stateAppearanceCopy = JSON.parse(JSON.stringify(this.appearanceState.appearance));
                    modelAppearanceCopy.name = "";
                    stateAppearanceCopy.name = "";
                    var equalWithoutNames = JSON.stringify(modelAppearanceCopy) === JSON.stringify(stateAppearanceCopy);
                    if (equalWithoutNames) {
                        // Change name inplace
                        var refr_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
                        (_a = refr_1 === null || refr_1 === void 0 ? void 0 : refr_1.getBaseObject()) === null || _a === void 0 ? void 0 : _a.setName(model.appearance.name);
                        refr_1 === null || refr_1 === void 0 ? void 0 : refr_1.setDisplayName(model.appearance.name, true);
                        //printConsole("Appearance updated, changing name inplace");
                    }
                    else {
                        // Force re-apply appearance on the next getAppearanceBasedBase call
                        this.appearanceBasedBaseId = 0;
                        //printConsole("Appearance updated");
                    }
                }
                else {
                    // Force re-apply appearance on the next getAppearanceBasedBase call
                    this.appearanceBasedBaseId = 0;
                    //printConsole("Appearance updated");
                }
                this.appearanceState.appearance = model.appearance || null;
                this.appearanceState.lastNumChanges = model.numAppearanceChanges;
            }
        }
        var refId = model.refrId && model.refrId < 0xff000000 ? model.refrId : undefined;
        if (refId) {
            if (this.refrId !== refId) {
                this.destroy();
                this.refrId = model.refrId;
                this.ready = true;
                var refr_2 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
                if (refr_2) {
                    var base = refr_2.getBaseObject();
                    if (base) {
                        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.dealWithRef(refr_2, base);
                    }
                }
            }
        }
        else {
            var templateChain = model.templateChain;
            // There is no place for random/leveling in 1-sized chain
            // Just spawn an NPC, do not generate a temporary TESNPC form
            if ((templateChain === null || templateChain === void 0 ? void 0 : templateChain.length) === 1) {
                templateChain = undefined;
            }
            // TODO: getLeveledBase crashes too often ATM
            var base = null; //Game.getFormEx(this.getLeveledBase(templateChain));
            if (base === null) {
                base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(model.baseId || NaN);
            }
            if (base === null) {
                base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.getAppearanceBasedBase());
            }
            if (base === null) {
                return;
            }
            var refr_3 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
            var respawnRequired = false;
            if (!refr_3) {
                respawnRequired = true;
            }
            else if (!refr_3.getBaseObject()) {
                respawnRequired = true;
            }
            else if (refr_3.getBaseObject().getFormID() !== base.getFormID()) {
                respawnRequired = true;
            }
            if (respawnRequired) {
                this.destroy();
                var player_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                var spawnMethodOriginal = {
                    spawn: function (baseForm, _spawnPosition, _spawnRotation) {
                        return player_1.placeAtMe(baseForm, 1, true, true);
                    },
                    triggerSpawnProcess: function (spawningRefr, spawnPosition, appearance, callback) {
                        new _spawnProcess__WEBPACK_IMPORTED_MODULE_6__.SpawnProcess(appearance, spawnPosition, spawningRefr.getFormID(), callback);
                    }
                };
                var spawnMethodStub = {
                    spawn: function (baseForm, spawnPosition, spawnRotation) {
                        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc1"];
                        var ref = f(baseForm, spawnPosition, spawnRotation);
                        return ref;
                    },
                    triggerSpawnProcess: function (spawningRefr, spawnPosition, appearance, callback) {
                        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc2"];
                        f(spawningRefr, spawnPosition, appearance, callback);
                    }
                };
                var spawnUsingStubMethod = base.getType() === 43 /* FormType.NPC */
                    && !this.appearanceState.appearance
                    && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc1Set"] === true
                    && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc2Set"] === true;
                var spawnMethod = spawnUsingStubMethod ? spawnMethodStub : spawnMethodOriginal;
                if (model.movement) {
                    refr_3 = spawnMethod.spawn(base, model.movement.pos, model.movement.rot);
                }
                else {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("model.movement was " + model.movement);
                }
                this.state = {};
                delete this.wasHostedByOther;
                if (base.getType() !== 43 /* FormType.NPC */) {
                    refr_3 === null || refr_3 === void 0 ? void 0 : refr_3.setAngle(((_b = model.movement) === null || _b === void 0 ? void 0 : _b.rot[0]) || 0, ((_c = model.movement) === null || _c === void 0 ? void 0 : _c.rot[1]) || 0, ((_d = model.movement) === null || _d === void 0 ? void 0 : _d.rot[2]) || 0);
                }
                else {
                    var race = (_f = (_e = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _e === void 0 ? void 0 : _e.getRace()) === null || _f === void 0 ? void 0 : _f.getFormID();
                    var draugrRace = 0xd53;
                    var falmerRace = 0x131f4;
                    var chaurusRace = 0x131eb;
                    var frostbiteSpiderRaceGiant = 0x4e507;
                    var frostbiteSpiderRaceLarge = 0x53477;
                    var dwarvenCenturionRace = 0x131f1;
                    var dwarvenSphereRace = 0x131f2;
                    var dwarvenSpiderRace = 0x131f3;
                    var sprigganRace = 0x2013b77;
                    var sprigganRace2 = 0xf3903;
                    var sprigganRace3 = 0x13204;
                    var sprigganRace4 = 0x401b644;
                    var sprigganRace5 = 0x9aa44;
                    var wolfRace = 0x1320a;
                    // potential masterambushscript
                    if (race === draugrRace
                        || race === falmerRace
                        || race === chaurusRace
                        || race === frostbiteSpiderRaceGiant
                        || race === frostbiteSpiderRaceLarge
                        || race === dwarvenCenturionRace
                        || race === dwarvenSphereRace
                        || race === dwarvenSpiderRace
                        || race === sprigganRace
                        || race === sprigganRace2
                        || race === sprigganRace3
                        || race === sprigganRace4
                        || race === sprigganRace5
                        || race === wolfRace) {
                        (_g = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _g === void 0 ? void 0 : _g.setActorValue("Aggression", 2);
                    }
                }
                if (refr_3 !== null) {
                    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__.WorldCleanerService).modWcProtection(refr_3.getFormID(), 1);
                }
                // TODO: reset all states?
                this.eqState = this.getDefaultEquipState();
                this.animState = this.getDefaultAnimState();
                this.ready = false;
                var spawnPos = void 0;
                if (model.movement) {
                    spawnPos = model.movement.pos;
                    // printConsole("Spawn NPC at movement.pos");
                }
                else {
                    spawnPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.getPos(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Spawn NPC at player pos");
                }
                if (refr_3) {
                    spawnMethod.triggerSpawnProcess(refr_3, spawnPos, model.appearance || null, function () {
                        _this.ready = true;
                        _this.spawnMoment = Date.now();
                    });
                }
                else {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Unable to triggerSpawnProcess for null refr");
                }
                if (model.appearance && model.appearance.name) {
                    refr_3 === null || refr_3 === void 0 ? void 0 : refr_3.setDisplayName("" + model.appearance.name, true);
                }
                (_h = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _h === void 0 ? void 0 : _h.setActorValue("attackDamageMult", 0);
            }
            this.refrId = refr_3.getFormID();
        }
        if (!this.ready) {
            return;
        }
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
        if (refr) {
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor && !this.localImmortal) {
                actor.startDeferredKill();
                actor.setActorValue("health", 1000000);
                actor.setActorValue("magicka", 1000000);
                this.localImmortal = true;
            }
            this.applyAll(refr, model);
            var gamemodeUpdateService = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_15__.GamemodeUpdateService);
            gamemodeUpdateService.updateNeighbor(refr, model, this.state);
        }
    };
    FormView.prototype.destroy = function () {
        this.isOnScreen = false;
        this.spawnMoment = 0;
        var refrId = this.refrId;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
            if (refrId >= 0xff000000) {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
                if (refr) {
                    refr.delete();
                }
                _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__.WorldCleanerService).modWcProtection(refrId, -1);
                var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
                if (ac) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, -1);
                }
            }
        });
        this.localImmortal = false;
        this.removeNickname();
    };
    FormView.prototype.applyAll = function (refr, model) {
        var _a, _b, _c;
        var forcedWeapDrawn = null;
        if (_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getCrosshairRefId() === this.refrId) {
            this.lastHarvestedApply = 0;
            this.lastOpenApply = 0;
        }
        var now = Date.now();
        if (now - this.lastHarvestedApply > 666) {
            this.lastHarvestedApply = now;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelIsHarvested(refr, !!model.isHarvested);
        }
        if (now - this.lastOpenApply > 133) {
            this.lastOpenApply = now;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelIsOpen(refr, !!model.isOpen);
        }
        if (!this.isSetNodeScaleApplied) {
            this.isSetNodeScaleApplied = true;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelNodeScale(refr, model.setNodeScale);
        }
        if (!this.isSetNodeTextureSetApplied) {
            this.isSetNodeTextureSetApplied = true;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelNodeTextureSet(refr, model.setNodeTextureSet);
        }
        if (model.inventory &&
            _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getCrosshairRefId() == this.refrId &&
            !(0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.isBadMenuShown)()) {
            // Do not let actors breaking their equipment via inventory apply
            // However, actually, actors do not have inventory in their models
            // Except your clone.
            if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) {
                _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelInventory(refr, model.inventory);
                model.inventory = undefined;
            }
        }
        if (model.animation) {
            if (model.animation.animEventName === "SkympFakeUnequip") {
                forcedWeapDrawn = false;
            }
            else if (model.animation.animEventName === "SkympFakeEquip") {
                forcedWeapDrawn = true;
            }
        }
        // TODO: make host service
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        var alreadyHosted = false;
        if (Array.isArray(hosted)) {
            var remoteId = (0,_worldViewMisc__WEBPACK_IMPORTED_MODULE_12__.localIdToRemoteId)(this.refrId);
            if (hosted.includes(remoteId) || hosted.includes(remoteId + 0x100000000)) {
                alreadyHosted = true;
            }
        }
        (0,_sync_animation__WEBPACK_IMPORTED_MODULE_1__.setDefaultAnimsDisabled)(this.refrId, alreadyHosted ? false : true);
        if (alreadyHosted) {
            (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) === null || _a === void 0 ? void 0 : _a.clearKeepOffsetFromActor();
        }
        if (model.movement) {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (this.movState.lastApply &&
                Date.now() - this.movState.lastApply > 1500) {
                if (Date.now() - this.movState.lastRehost > 1000) {
                    this.movState.lastRehost = Date.now();
                    var remoteId = this.remoteRefrId;
                    if (ac && ac.is3DLoaded()) {
                        this.tryHostIfNeed(ac, remoteId);
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("tryHostIfNeed - reason: not seeing movement for long time");
                    }
                }
            }
            if (+model.numMovementChanges !==
                this.movState.lastNumChanges ||
                Date.now() - this.movState.lastApply > 2000) {
                this.movState.lastApply = Date.now();
                if (model.isHostedByOther || !this.movState.everApplied) {
                    var backup = model.movement.isWeapDrawn;
                    if (forcedWeapDrawn === true || forcedWeapDrawn === false) {
                        model.movement.isWeapDrawn = forcedWeapDrawn;
                    }
                    try {
                        (0,_sync_movementApply__WEBPACK_IMPORTED_MODULE_5__.applyMovement)(refr, model.movement, !!model.isMyClone);
                    }
                    catch (e) {
                        if (e instanceof _lib_errors__WEBPACK_IMPORTED_MODULE_4__.RespawnNeededError) {
                            this.lastWorldOrCell = model.movement.worldOrCell;
                            this.destroy();
                            this.refrId = 0;
                            this.appearanceBasedBaseId = 0;
                            return;
                        }
                        else {
                            throw e;
                        }
                    }
                    model.movement.isWeapDrawn = backup;
                    this.movState.lastNumChanges = +model.numMovementChanges;
                    this.movState.everApplied = true;
                }
                else {
                    var remoteId = this.remoteRefrId;
                    if (ac && remoteId && ac.is3DLoaded()) {
                        ac.clearKeepOffsetFromActor();
                        // TODO: make host service
                        var hosted_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
                        var alreadyHosted_1 = false;
                        if (Array.isArray(hosted_1)) {
                            var remoteId_1 = (0,_worldViewMisc__WEBPACK_IMPORTED_MODULE_12__.localIdToRemoteId)(ac.getFormID());
                            if (hosted_1.includes(remoteId_1) || hosted_1.includes(remoteId_1 + 0x100000000)) {
                                alreadyHosted_1 = true;
                            }
                        }
                        if (!alreadyHosted_1) {
                            if (this.tryHostIfNeed(ac, remoteId)) {
                                // previously, we did this cleanup on each update
                                // but I guess it's too expensive and can possibly hurt FPS
                                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, -1);
                            }
                        }
                    }
                }
            }
        }
        if (refr.is3DLoaded()) {
            if (model.animation) {
                (0,_sync_animation__WEBPACK_IMPORTED_MODULE_1__.applyAnimation)(refr, model.animation, this.animState);
            }
            // Use them only once, for spawning actors with correct animations
            this.animState.useAnimOverrides = false;
        }
        if (model.appearance) {
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor && !_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.isInJumpState()) {
                if (_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell()) {
                    if (this.lastPcWorldOrCell &&
                        _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell() !== this.lastPcWorldOrCell) {
                        // Redraw tints if PC world/cell changed
                        this.isOnScreen = false;
                    }
                    this.lastPcWorldOrCell = _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell();
                }
                var headPos = [
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionX(actor, "NPC Head [Head]", false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionY(actor, "NPC Head [Head]", false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionZ(actor, "NPC Head [Head]", false),
                ];
                var screenPoint = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.worldPointToScreenPoint)(headPos)[0];
                var isOnScreen = screenPoint[0] > 0 &&
                    screenPoint[1] > 0 &&
                    screenPoint[2] > 0 &&
                    screenPoint[0] < 1 &&
                    screenPoint[1] < 1 &&
                    screenPoint[2] < 1;
                if (isOnScreen != this.isOnScreen) {
                    this.isOnScreen = isOnScreen;
                    if (isOnScreen) {
                        actor.queueNiNodeUpdate();
                        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().queueNiNodeUpdate();
                    }
                }
            }
        }
        if (model.equipment) {
            if (this.eqState.lastNumChanges !== model.equipment.numChanges) {
                var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
                // If we do not block inventory here, we will be able to reproduce the bug:
                // 1. Place ~90 bots and force them to reequip iron swords to the left hand (rate should be ~50ms)
                // 2. Open your inventory and reequip different items fast
                // 3. After 1-2 minutes close your inventory and see that HUD disappeared
                if (ac &&
                    !(0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.isBadMenuShown)() &&
                    Date.now() - this.eqState.lastEqMoment > 500 &&
                    Date.now() - this.spawnMoment > -1 &&
                    this.spawnMoment > 0) {
                    //if (this.spawnMoment > 0 && Date.now() - this.spawnMoment > 5000) {
                    if ((0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.applyEquipment)(ac, model.equipment)) {
                        this.eqState.lastNumChanges = model.equipment.numChanges;
                    }
                    this.eqState.lastEqMoment = Date.now();
                    //}
                    //const res: boolean = applyEquipment(ac, model.equipment);
                    //if (res) this.eqState.lastNumChanges = model.equipment.numChanges;
                }
            }
        }
        if (FormView.isDisplayingNicknames && this.refrId && ((_b = model.appearance) === null || _b === void 0 ? void 0 : _b.name)) {
            var headPart = "NPC Head [Head]";
            var maxNicknameDrawDistance = 1000;
            var playerActor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
            var isVisibleByPlayer = !((_c = model.movement) === null || _c === void 0 ? void 0 : _c.isSneaking)
                && playerActor.getDistance(refr) <= maxNicknameDrawDistance
                && playerActor.hasLOS(refr)
                && !this.isSweetHidePerson(refr);
            if (isVisibleByPlayer) {
                var headScreenPos = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.worldPointToScreenPoint)([
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionX(refr, headPart, false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionY(refr, headPart, false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionZ(refr, headPart, false) + 32
                ])[0];
                var resolution = getScreenResolution();
                var textXPos = Math.round(headScreenPos[0] * resolution.width);
                var textYPos = Math.round((1 - headScreenPos[1]) * resolution.height);
                var isTalkingText = (model === null || model === void 0 ? void 0 : model.isTalking) ? "Speaking" : "";
                if (!this.textNameId && headScreenPos[2] > 0) {
                    this.textNameId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(textXPos, textYPos, refr.getDisplayName(), [1, 1, 1, 0.8]);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.textNameId, 0.5);
                    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().emitter.emit("nicknameCreate", {
                        remoteRefrId: this.getRemoteRefrId(),
                        textId: this.textNameId
                    });
                }
                else {
                    var deleteNickname = headScreenPos[2] < 0;
                    if (deleteNickname) {
                        this.removeNickname();
                    }
                    if (this.textNameId) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextPos)(this.textNameId, textXPos, textYPos);
                    }
                }
                if (!this.voiceIndicatorId) {
                    this.voiceIndicatorId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(textXPos, textYPos - 35, "", [1, 0.85, 0.2, 0.8]);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.voiceIndicatorId, 0.4);
                }
                else {
                    if (this.voiceIndicatorId) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextString)(this.voiceIndicatorId, headScreenPos[2] >= 0 ? isTalkingText : "");
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextPos)(this.voiceIndicatorId, textXPos, textYPos - 35);
                    }
                }
            }
            else {
                this.removeNickname();
            }
        }
        else {
            this.removeNickname();
        }
    };
    FormView.prototype.isSweetHidePerson = function (refr) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (!actor) {
            return false;
        }
        var keyword = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Keyword.getKeyword('SweetHidePerson');
        return actor.wornHasKeyword(keyword);
    };
    FormView.prototype.removeNickname = function () {
        if (this.textNameId) {
            _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().emitter.emit("nicknameDestroy", {
                remoteRefrId: this.getRemoteRefrId(),
                textId: this.textNameId
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.destroyText)(this.textNameId);
            this.textNameId = undefined;
        }
        if (this.voiceIndicatorId) {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.destroyText)(this.voiceIndicatorId);
            this.voiceIndicatorId = undefined;
        }
    };
    FormView.prototype.getAppearanceBasedBase = function () {
        var base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.appearanceBasedBaseId));
        if (!base && this.appearanceState.appearance) {
            this.appearanceBasedBaseId = (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_2__.applyAppearance)(this.appearanceState.appearance).getFormID();
        }
        return this.appearanceBasedBaseId;
    };
    FormView.prototype.getLeveledBase = function (templateChain) {
        if (templateChain === undefined) {
            return 0;
        }
        var str = templateChain.join(',');
        if (this.leveledBaseId === 0) {
            // @ts-ignore
            var leveledBase = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.evaluateLeveledNpc(str);
            if (!leveledBase) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Failed to evaluate leveled npc", str);
            }
            this.leveledBaseId = (leveledBase === null || leveledBase === void 0 ? void 0 : leveledBase.getFormID()) || 0;
        }
        return this.leveledBaseId;
    };
    FormView.prototype.getDefaultEquipState = function () {
        return { lastNumChanges: 0, lastEqMoment: 0 };
    };
    ;
    FormView.prototype.getDefaultAppearanceState = function () {
        return { lastNumChanges: 0, appearance: null };
    };
    ;
    FormView.prototype.getDefaultAnimState = function () {
        return { lastNumChanges: 0, useAnimOverrides: true };
    };
    ;
    FormView.prototype.tryHostIfNeed = function (ac, remoteId) {
        var last = _hostAttempts__WEBPACK_IMPORTED_MODULE_10__.lastTryHost[remoteId];
        if (!last || Date.now() - last >= 1000) {
            _hostAttempts__WEBPACK_IMPORTED_MODULE_10__.lastTryHost[remoteId] = Date.now();
            if ((0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_9__.getMovement)(ac).worldOrCell ===
                (0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_9__.getMovement)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()).worldOrCell) {
                (0,_hostAttempts__WEBPACK_IMPORTED_MODULE_10__.tryHost)(remoteId);
                return true;
            }
        }
        return false;
    };
    ;
    FormView.prototype.getLocalRefrId = function () {
        return this.refrId;
    };
    FormView.prototype.getRemoteRefrId = function () {
        return this.remoteRefrId;
    };
    FormView.isDisplayingNicknames = true;
    return FormView;
}());



/***/ }),

/***/ "./src/view/formViewArray.ts":
/*!***********************************!*\
  !*** ./src/view/formViewArray.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormViewArray: () => (/* binding */ FormViewArray)
/* harmony export */ });
/* harmony import */ var _formView__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./formView */ "./src/view/formView.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");



var FormViewArray = /** @class */ (function () {
    function FormViewArray() {
        this.formViews = new Array();
    }
    FormViewArray.prototype.updateForm = function (form, i) {
        var view = this.formViews[i];
        if (!view) {
            this.formViews[i] = new _formView__WEBPACK_IMPORTED_MODULE_0__.FormView(form.refrId);
        }
        else {
            view.update(form);
        }
    };
    FormViewArray.prototype.destroyForm = function (i) {
        var formView = this.formViews[i];
        if (formView === undefined) {
            return;
        }
        formView.destroy();
        this.formViews[i] = undefined;
    };
    FormViewArray.prototype.resize = function (newSize) {
        if (this.formViews.length > newSize) {
            this.formViews.slice(newSize).forEach(function (v) { return v && v.destroy(); });
        }
        this.formViews.length = newSize;
    };
    FormViewArray.prototype.updateAll = function (model, showMe, isCloneView) {
        var gamemodeUpdateService = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_2__.GamemodeUpdateService);
        gamemodeUpdateService.setFormViewArray(this);
        var forms = model.forms;
        var n = forms.length;
        for (var i = 0; i < n; ++i) {
            var form = forms[i];
            if (!form || (model.playerCharacterFormIdx === i && !showMe)) {
                this.destroyForm(i);
                continue;
            }
            var realPos = undefined;
            var offset = model.playerCharacterFormIdx === i || isCloneView;
            if (offset && form.movement) {
                realPos = form.movement.pos;
                form.movement.pos = [
                    realPos[0] + 128,
                    realPos[1] + 128,
                    realPos[2],
                ];
            }
            if (isCloneView) {
                // Prevent using the same refr by normal and clone views
                if (!form.refrId || form.refrId >= 0xff000000) {
                    var backup = form.isHostedByOther;
                    form.isHostedByOther = true;
                    // TODO: Explain why do not GamemodeApiSupport.setI(i); here
                    this.updateForm(form, i);
                    form.isHostedByOther = backup;
                }
            }
            else {
                gamemodeUpdateService.setI(i);
                this.updateForm(form, i);
            }
            if (offset && form.movement && realPos) {
                form.movement.pos = realPos;
            }
        }
    };
    FormViewArray.prototype.syncFormView = function (model, showMe) {
        for (var i = 0; i < model.forms.length; ++i) {
            if (!model.forms[i] || (model.playerCharacterFormIdx === i && !showMe)) {
                this.destroyForm(i);
                continue;
            }
        }
    };
    FormViewArray.prototype.getRemoteRefrId = function (clientsideRefrId) {
        if (clientsideRefrId < 0xff000000)
            throw new Error("This function is only for 0xff forms");
        var formView = this.formViews.find(function (formView) {
            return formView && formView.getLocalRefrId() === clientsideRefrId;
        });
        return formView ? formView.getRemoteRefrId() : 0;
    };
    FormViewArray.prototype.getLocalRefrId = function (remoteRefrId) {
        if (remoteRefrId < 0xff000000)
            throw new Error("This function is only for 0xff forms");
        var formView = this.formViews.find(function (formView) {
            return formView && formView.getRemoteRefrId() === remoteRefrId;
        });
        return formView ? formView.getLocalRefrId() : 0;
    };
    FormViewArray.prototype.getNthFormView = function (i) {
        return this.formViews[i];
    };
    FormViewArray.prototype.getFormViewsArrayLength = function () {
        return this.formViews.length;
    };
    return FormViewArray;
}());



/***/ }),

/***/ "./src/view/hostAttempts.ts":
/*!**********************************!*\
  !*** ./src/view/hostAttempts.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   lastTryHost: () => (/* binding */ lastTryHost),
/* harmony export */   nextHostAttempt: () => (/* binding */ nextHostAttempt),
/* harmony export */   tryHost: () => (/* binding */ tryHost)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"] = [];
var tryHost = function (targetRemoteId) {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"].push(targetRemoteId);
};
var nextHostAttempt = function () {
    var arr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"];
    if (arr.length === 0) {
        return undefined;
    }
    return arr.shift();
};
var lastTryHost = {};


/***/ }),

/***/ "./src/view/modelApplyUtils.ts":
/*!*************************************!*\
  !*** ./src/view/modelApplyUtils.ts ***!
  \*************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ModelApplyUtils: () => (/* binding */ ModelApplyUtils)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../logging */ "./src/logging.ts");



// For 0xff000000+ used from FormView
// For objects from master files used directly from remoteServer.ts
var ModelApplyUtils = /** @class */ (function () {
    function ModelApplyUtils() {
    }
    ModelApplyUtils.applyModelInventory = function (refr, inventory) {
        (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_1__.applyInventory)(refr, inventory, false, true);
    };
    ModelApplyUtils.applyModelIsOpen = function (refr, isOpen) {
        var _a;
        refr.setOpen(isOpen);
        // See also objectReferenceEx.ts
        var caveGSecretDoor01 = 0x6f703;
        // TODO: add more activators to support more cells
        var parentActivatorId = 0x460ca;
        if (((_a = refr.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) === caveGSecretDoor01) {
            var openOrOpening = [1, 2].includes(refr.getOpenState());
            if (openOrOpening) {
                if (!isOpen) {
                    refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getForm(parentActivatorId)), false);
                }
            }
            if (!openOrOpening) {
                if (isOpen) {
                    refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getForm(parentActivatorId)), false);
                }
            }
        }
    };
    ModelApplyUtils.applyModelIsDisabled = function (refr, disabled) {
        var wasDisabled = refr.isDisabled();
        if (wasDisabled == disabled) {
            return;
        }
        if (disabled) {
            refr.disable(false);
        }
        else {
            refr.enable(true);
        }
    };
    ModelApplyUtils.applyModelIsHarvested = function (refr, isHarvested) {
        var base = refr.getBaseObject();
        if (base) {
            var t = base.getType();
            if (t == 38 /* FormType.Tree */ || t == 39 /* FormType.Flora */) {
                var wasHarvested = refr.isHarvested();
                if (isHarvested != wasHarvested) {
                    var ac = null;
                    if (isHarvested) {
                        for (var i = 0; i < 20; ++i) {
                            ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.findRandomActor(refr.getPositionX(), refr.getPositionY(), refr.getPositionZ(), 10000);
                            if (ac && ac.getFormID() !== 0x14) {
                                break;
                            }
                        }
                    }
                    if (isHarvested && ac && ac.getFormID() !== 0x14) {
                        refr.activate(ac, true);
                    }
                    else {
                        refr.setHarvested(isHarvested);
                        var id_1 = refr.getFormID();
                        refr.disable(false).then(function () {
                            var restoredRefr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id_1));
                            if (restoredRefr) {
                                restoredRefr.enable(false);
                            }
                        });
                    }
                }
            }
            else {
                var wasHarvested = refr.isDisabled();
                if (isHarvested != wasHarvested) {
                    if (isHarvested) {
                        var id_2 = refr.getFormID();
                        refr.disable(false).then(function () {
                            var restoredRefr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id_2));
                            if (restoredRefr && !restoredRefr.isDisabled()) {
                                restoredRefr.delete();
                                // Deletion takes time, so in practice this would be called a lot of times
                            }
                        });
                    }
                    else {
                        refr.enable(true);
                    }
                }
            }
        }
    };
    ModelApplyUtils.applyModelNodeTextureSet = function (refr, setNodeTextureSet) {
        if (setNodeTextureSet) {
            setNodeTextureSet.forEach(function (element) {
                var firstPerson = false;
                var textureSet = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TextureSet.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(element.textureSetId));
                if (textureSet !== null) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.setNodeTextureSet(refr, element.nodeName, textureSet, firstPerson);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)("ModelApplyUtils", refr.getFormID().toString(16), "Applied texture set", element.textureSetId.toString(16), "to", element.nodeName);
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)("ModelApplyUtils", refr.getFormID().toString(16), "Failed to apply texture set", element.textureSetId.toString(16), "to", element.nodeName);
                }
            });
        }
    };
    ModelApplyUtils.applyModelNodeScale = function (refr, setNodeScale) {
        if (setNodeScale) {
            setNodeScale.forEach(function (element) {
                var firstPerson = false;
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.setNodeScale(refr, element.nodeName, element.scale, firstPerson);
                (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)("ModelApplyUtils", refr.getFormID().toString(16), "Applied node scale", element.scale, "to", element.nodeName);
            });
        }
    };
    return ModelApplyUtils;
}());



/***/ }),

/***/ "./src/view/playerCharacterDataHolder.ts":
/*!***********************************************!*\
  !*** ./src/view/playerCharacterDataHolder.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PlayerCharacterDataHolder: () => (/* binding */ PlayerCharacterDataHolder)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");


var PlayerCharacterDataHolder = /** @class */ (function () {
    function PlayerCharacterDataHolder() {
    }
    PlayerCharacterDataHolder.updateData = function () {
        var _a;
        var player = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
        if (!player) {
            return;
        }
        this.inJumpState = player.getAnimationVariableBool("bInJumpState");
        this.worldOrCell = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(player);
        this.crosshairRefId = ((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getCurrentCrosshairRef()) === null || _a === void 0 ? void 0 : _a.getFormID()) || 0;
    };
    PlayerCharacterDataHolder.isInJumpState = function () {
        return this.inJumpState;
    };
    PlayerCharacterDataHolder.getWorldOrCell = function () {
        return this.worldOrCell;
    };
    PlayerCharacterDataHolder.getCrosshairRefId = function () {
        return this.crosshairRefId;
    };
    PlayerCharacterDataHolder.inJumpState = false;
    PlayerCharacterDataHolder.worldOrCell = 0;
    PlayerCharacterDataHolder.crosshairRefId = 0;
    return PlayerCharacterDataHolder;
}());



/***/ }),

/***/ "./src/view/spawnProcess.ts":
/*!**********************************!*\
  !*** ./src/view/spawnProcess.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpawnProcess: () => (/* binding */ SpawnProcess)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");



var SpawnProcess = /** @class */ (function () {
    function SpawnProcess(appearance, pos, refrId, callback) {
        var _this = this;
        this.callback = callback;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        refr.setPosition.apply(refr, pos).then(function () { return _this.enable(appearance, refrId); });
    }
    SpawnProcess.prototype.enable = function (appearance, refrId) {
        var _this = this;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (ac && appearance) {
            (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_1__.applyTints)(ac, appearance);
        }
        refr.enable(false).then(function () { return _this.resurrect(refrId); });
    };
    SpawnProcess.prototype.resurrect = function (refrId) {
        var _this = this;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (ac) {
            return ac.resurrect().then(function () {
                _this.callback();
            });
        }
        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.dealWithRef(refr, refr.getBaseObject());
        return refr.setMotionType(4 /* MotionType.Keyframed */, true).then(this.callback);
    };
    return SpawnProcess;
}());



/***/ }),

/***/ "./src/view/worldView.ts":
/*!*******************************!*\
  !*** ./src/view/worldView.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WorldView: () => (/* binding */ WorldView)
/* harmony export */ });
/* harmony import */ var _formViewArray__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./formViewArray */ "./src/view/formViewArray.ts");
/* harmony import */ var _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./playerCharacterDataHolder */ "./src/view/playerCharacterDataHolder.ts");
/* harmony import */ var _services_services_clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../logging */ "./src/logging.ts");
/* harmony import */ var _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../services/services/singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../services/services/remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();






var WorldView = /** @class */ (function (_super) {
    __extends(WorldView, _super);
    function WorldView(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on("update", function () { return _this.onUpdate(); });
        controller.once("update", function () { return _this.onceUpdate(); });
        _this.state = _this.makeEmptyState();
        var oldView = _this.sp.storage["view"];
        // can't use instanceof here because each hot reload creates a new class
        _this.oldView = typeof oldView === "object" ? oldView : undefined;
        _this.sp.storage["view"] = _this;
        return _this;
    }
    WorldView.prototype.getRemoteRefrId = function (clientsideRefrId) {
        return this.state.formViews.getRemoteRefrId(clientsideRefrId);
    };
    WorldView.prototype.getLocalRefrId = function (remoteRefrId) {
        return this.state.formViews.getLocalRefrId(remoteRefrId);
    };
    WorldView.prototype.syncFormArray = function (model) {
        var settings = this.sp.settings;
        var showMe = settings['skymp5-client']['show-me'];
        this.state.formViews.syncFormView(model, !!showMe);
    };
    WorldView.prototype.destroy = function () {
        this.state.formViews.resize(0);
        this.state.cloneFormViews.resize(0); // Recenrly added, not tested if it's needed
        this.state = this.makeEmptyState();
    };
    WorldView.prototype.getFormViews = function () {
        return this.state.formViews;
    };
    WorldView.prototype.onUpdate = function () {
        this.resetAllFormViewsIfPlayerChangedWorld();
        var singlePlayerService = this.controller.lookupListener(_services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_4__.SinglePlayerService);
        if (!singlePlayerService.isSinglePlayer) {
            var modelSource = this.controller.lookupListener(_services_services_remoteServer__WEBPACK_IMPORTED_MODULE_5__.RemoteServer);
            this.updateWorld(modelSource.getWorldModel());
        }
    };
    WorldView.prototype.onceUpdate = function () {
        if (this.oldView) {
            this.oldView.destroy();
            this.oldView = undefined;
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Previous View destroyed');
        }
        this.waitGameTimeAndAllowFormViewUpdate(1.0);
    };
    WorldView.prototype.resetAllFormViewsIfPlayerChangedWorld = function () {
        var state = this.state;
        var pc = this.sp.Game.getPlayer();
        var pcWorldOrCell = (pc.getWorldSpace() || pc.getParentCell()).getFormID();
        if (state.pcWorldOrCell !== pcWorldOrCell) {
            if (state.pcWorldOrCell) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Reset all form views');
                state.formViews.resize(0);
                state.cloneFormViews.resize(0);
            }
            state.pcWorldOrCell = pcWorldOrCell;
        }
    };
    // Work around showRaceMenu issue
    // Default nord in Race Menu will have very ugly face
    // If other players are spawning when we show this menu
    // TODO: separate listener
    WorldView.prototype.waitGameTimeAndAllowFormViewUpdate = function (seconds) {
        var _this = this;
        // Wait 1s game time (time spent in Race Menu isn't counted)
        this.sp.Utility.wait(seconds).then(function () {
            _this.state.allowUpdate = true;
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(_this, 'Update is now allowed');
        });
    };
    WorldView.prototype.setFormViewUpdateAllowed = function (allowed) {
        this.state.allowUpdate = allowed;
        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Update is now', allowed ? 'allowed' : 'disallowed');
    };
    WorldView.prototype.updateWorld = function (model) {
        var settings = this.sp.settings;
        var state = this.state;
        if (!state.allowUpdate) {
            model = {
                forms: [],
                playerCharacterFormIdx: model.playerCharacterFormIdx,
                playerCharacterRefrId: model.playerCharacterRefrId
            };
        }
        var skipUpdates = settings['skymp5-client']['skipUpdates'];
        // skip 50% of updates if specified in the settings
        state.counter = !state.counter;
        if (state.counter && skipUpdates) {
            return;
        }
        state.formViews.resize(model.forms.length);
        var showMe = settings['skymp5-client']['show-me'];
        var showClones = settings['skymp5-client']['show-clones'];
        _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_1__.PlayerCharacterDataHolder.updateData();
        state.formViews.updateAll(model, !!showMe, false);
        if (showClones) {
            state.cloneFormViews.updateAll(model, false, true);
        }
        else {
            state.cloneFormViews.resize(0);
        }
    };
    WorldView.prototype.makeEmptyState = function () {
        return {
            formViews: new _formViewArray__WEBPACK_IMPORTED_MODULE_0__.FormViewArray(),
            cloneFormViews: new _formViewArray__WEBPACK_IMPORTED_MODULE_0__.FormViewArray(),
            allowUpdate: false,
            pcWorldOrCell: 0,
            counter: false,
        };
    };
    return WorldView;
}(_services_services_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/view/worldViewMisc.ts":
/*!***********************************!*\
  !*** ./src/view/worldViewMisc.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getObjectReference: () => (/* binding */ getObjectReference),
/* harmony export */   getViewFromStorage: () => (/* binding */ getViewFromStorage),
/* harmony export */   localIdToRemoteId: () => (/* binding */ localIdToRemoteId),
/* harmony export */   remoteIdToLocalId: () => (/* binding */ remoteIdToLocalId)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/remoteServer */ "./src/services/services/remoteServer.ts");



var getViewFromStorage = function () {
    var res = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["view"];
    // can't use instanceof here because each hot reload creates a new class
    if (typeof res === "object") {
        return res;
    }
    return undefined;
};
var localIdToRemoteId = function (localFormId, newCast) {
    if (newCast === void 0) { newCast = false; }
    if (newCast && localFormId == 0x14) {
        return _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_remoteServer__WEBPACK_IMPORTED_MODULE_2__.RemoteServer).getMyRemoteRefrId();
    }
    if (localFormId >= 0xff000000) {
        var view = getViewFromStorage();
        if (!view) {
            return 0;
        }
        localFormId = view.getRemoteRefrId(localFormId);
        if (!localFormId) {
            return 0;
        }
        // serverside ids are 64bit
        if (localFormId >= 0x100000000) {
            localFormId -= 0x100000000;
        }
    }
    return localFormId;
};
var remoteIdToLocalId = function (remoteFormId) {
    if (remoteFormId >= 0xff000000) {
        var view = getViewFromStorage();
        if (!view) {
            return 0;
        }
        remoteFormId = view.getLocalRefrId(remoteFormId);
        if (!remoteFormId) {
            return 0;
        }
    }
    return remoteFormId;
};
var getObjectReference = function (i) {
    var view = getViewFromStorage();
    if (view) {
        var formView = view.getFormViews().getNthFormView(i);
        if (formView) {
            var refrId = formView.getLocalRefrId();
            if (refrId > 0) {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
                if (refr !== null) {
                    return refr;
                }
            }
        }
    }
    return null;
};


/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "inspector":
/*!****************************!*\
  !*** external "inspector" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("inspector");

/***/ }),

/***/ "node:crypto":
/*!******************************!*\
  !*** external "node:crypto" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:crypto");

/***/ }),

/***/ "skyrimPlatform":
/*!***********************************!*\
  !*** external ["skyrimPlatform"] ***!
  \***********************************/
/***/ ((module) => {

module.exports = skyrimPlatform;

/***/ }),

/***/ "./node_modules/eventemitter3/index.mjs":
/*!**********************************************!*\
  !*** ./node_modules/eventemitter3/index.mjs ***!
  \**********************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EventEmitter: () => (/* reexport default export from named module */ _index_js__WEBPACK_IMPORTED_MODULE_0__),
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony import */ var _index_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index.js */ "./node_modules/eventemitter3/index.js");



/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (_index_js__WEBPACK_IMPORTED_MODULE_0__);


/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/compat get default export */
/******/ 	(() => {
/******/ 		// getDefaultExport function for compatibility with non-harmony modules
/******/ 		__webpack_require__.n = (module) => {
/******/ 			var getter = module && module.__esModule ?
/******/ 				() => (module['default']) :
/******/ 				() => (module);
/******/ 			__webpack_require__.d(getter, { a: getter });
/******/ 			return getter;
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _services_services_skympClient__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./services/services/skympClient */ "./src/services/services/skympClient.ts");
/* harmony import */ var _services_services_blockPapyrusEventsService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./services/services/blockPapyrusEventsService */ "./src/services/services/blockPapyrusEventsService.ts");
/* harmony import */ var _services_services_enforceLimitationsService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./services/services/enforceLimitationsService */ "./src/services/services/enforceLimitationsService.ts");
/* harmony import */ var _services_services_loadGameService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./services/services/loadGameService */ "./src/services/services/loadGameService.ts");
/* harmony import */ var _services_services_sendInputsService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./services/services/sendInputsService */ "./src/services/services/sendInputsService.ts");
/* harmony import */ var _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./services/services/singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_timeService__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./services/services/timeService */ "./src/services/services/timeService.ts");
/* harmony import */ var _services_services_spVersionCheckService__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./services/services/spVersionCheckService */ "./src/services/services/spVersionCheckService.ts");
/* harmony import */ var _services_services_consoleCommandsService__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./services/services/consoleCommandsService */ "./src/services/services/consoleCommandsService.ts");
/* harmony import */ var _services_services_lastInvService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./services/services/lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _services_services_activationService__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./services/services/activationService */ "./src/services/services/activationService.ts");
/* harmony import */ var _services_services_craftService__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./services/services/craftService */ "./src/services/services/craftService.ts");
/* harmony import */ var _services_services_dropItemService__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./services/services/dropItemService */ "./src/services/services/dropItemService.ts");
/* harmony import */ var _services_services_hitService__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ./services/services/hitService */ "./src/services/services/hitService.ts");
/* harmony import */ var _services_services_ragdollService__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./services/services/ragdollService */ "./src/services/services/ragdollService.ts");
/* harmony import */ var _services_services_deathService__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ./services/services/deathService */ "./src/services/services/deathService.ts");
/* harmony import */ var _services_services_containersService__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./services/services/containersService */ "./src/services/services/containersService.ts");
/* harmony import */ var _services_services_networkingService__WEBPACK_IMPORTED_MODULE_19__ = __webpack_require__(/*! ./services/services/networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_20__ = __webpack_require__(/*! ./services/services/remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _services_services_spSnippetService__WEBPACK_IMPORTED_MODULE_21__ = __webpack_require__(/*! ./services/services/spSnippetService */ "./src/services/services/spSnippetService.ts");
/* harmony import */ var _services_services_sweetTaffyDynamicPerksService__WEBPACK_IMPORTED_MODULE_22__ = __webpack_require__(/*! ./services/services/sweetTaffyDynamicPerksService */ "./src/services/services/sweetTaffyDynamicPerksService.ts");
/* harmony import */ var _services_services_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_23__ = __webpack_require__(/*! ./services/services/sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _services_services_sweetTaffyStaticPerksService__WEBPACK_IMPORTED_MODULE_24__ = __webpack_require__(/*! ./services/services/sweetTaffyStaticPerksService */ "./src/services/services/sweetTaffyStaticPerksService.ts");
/* harmony import */ var _services_services_disableSkillAdvanceService__WEBPACK_IMPORTED_MODULE_25__ = __webpack_require__(/*! ./services/services/disableSkillAdvanceService */ "./src/services/services/disableSkillAdvanceService.ts");
/* harmony import */ var _services_services_disableFastTravelService__WEBPACK_IMPORTED_MODULE_26__ = __webpack_require__(/*! ./services/services/disableFastTravelService */ "./src/services/services/disableFastTravelService.ts");
/* harmony import */ var _services_services_disableDifficultySelectionService__WEBPACK_IMPORTED_MODULE_27__ = __webpack_require__(/*! ./services/services/disableDifficultySelectionService */ "./src/services/services/disableDifficultySelectionService.ts");
/* harmony import */ var _services_services_sweetTaffyPlayerCombatService__WEBPACK_IMPORTED_MODULE_28__ = __webpack_require__(/*! ./services/services/sweetTaffyPlayerCombatService */ "./src/services/services/sweetTaffyPlayerCombatService.ts");
/* harmony import */ var _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_29__ = __webpack_require__(/*! ./services/services/worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _services_services_sweetTaffySkillMenuService__WEBPACK_IMPORTED_MODULE_30__ = __webpack_require__(/*! ./services/services/sweetTaffySkillMenuService */ "./src/services/services/sweetTaffySkillMenuService.ts");
/* harmony import */ var _services_services_loadOrderVerificationService__WEBPACK_IMPORTED_MODULE_31__ = __webpack_require__(/*! ./services/services/loadOrderVerificationService */ "./src/services/services/loadOrderVerificationService.ts");
/* harmony import */ var _services_services_browserService__WEBPACK_IMPORTED_MODULE_32__ = __webpack_require__(/*! ./services/services/browserService */ "./src/services/services/browserService.ts");
/* harmony import */ var _services_services_authService__WEBPACK_IMPORTED_MODULE_33__ = __webpack_require__(/*! ./services/services/authService */ "./src/services/services/authService.ts");
/* harmony import */ var _services_services_characterSelectService__WEBPACK_IMPORTED_MODULE_34__ = __webpack_require__(/*! ./services/services/characterSelectService */ "./src/services/services/characterSelectService.ts");
/* harmony import */ var _services_services_netInfoService__WEBPACK_IMPORTED_MODULE_35__ = __webpack_require__(/*! ./services/services/netInfoService */ "./src/services/services/netInfoService.ts");
/* harmony import */ var _services_services_animDebugService__WEBPACK_IMPORTED_MODULE_36__ = __webpack_require__(/*! ./services/services/animDebugService */ "./src/services/services/animDebugService.ts");
/* harmony import */ var _services_services_timersService__WEBPACK_IMPORTED_MODULE_37__ = __webpack_require__(/*! ./services/services/timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _services_services_playerBowShotService__WEBPACK_IMPORTED_MODULE_38__ = __webpack_require__(/*! ./services/services/playerBowShotService */ "./src/services/services/playerBowShotService.ts");
/* harmony import */ var _services_services_gamemodeEventSourceService__WEBPACK_IMPORTED_MODULE_39__ = __webpack_require__(/*! ./services/services/gamemodeEventSourceService */ "./src/services/services/gamemodeEventSourceService.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_40__ = __webpack_require__(/*! ./services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");
/* harmony import */ var _services_services_frontHotReloadService__WEBPACK_IMPORTED_MODULE_41__ = __webpack_require__(/*! ./services/services/frontHotReloadService */ "./src/services/services/frontHotReloadService.ts");
/* harmony import */ var _services_services_blockedAnimationsService__WEBPACK_IMPORTED_MODULE_42__ = __webpack_require__(/*! ./services/services/blockedAnimationsService */ "./src/services/services/blockedAnimationsService.ts");
/* harmony import */ var _services_services_voiceChatService__WEBPACK_IMPORTED_MODULE_43__ = __webpack_require__(/*! ./services/services/voiceChatService */ "./src/services/services/voiceChatService.ts");
/* harmony import */ var _view_worldView__WEBPACK_IMPORTED_MODULE_44__ = __webpack_require__(/*! ./view/worldView */ "./src/view/worldView.ts");
/* harmony import */ var _services_services_keyboardEventsService__WEBPACK_IMPORTED_MODULE_45__ = __webpack_require__(/*! ./services/services/keyboardEventsService */ "./src/services/services/keyboardEventsService.ts");
/* harmony import */ var _services_services_magicSyncService__WEBPACK_IMPORTED_MODULE_46__ = __webpack_require__(/*! ./services/services/magicSyncService */ "./src/services/services/magicSyncService.ts");
/* harmony import */ var _services_services_profilingService__WEBPACK_IMPORTED_MODULE_47__ = __webpack_require__(/*! ./services/services/profilingService */ "./src/services/services/profilingService.ts");
/* harmony import */ var _services_services_settingsService__WEBPACK_IMPORTED_MODULE_48__ = __webpack_require__(/*! ./services/services/settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _services_services_sweetCameraEnforcementService__WEBPACK_IMPORTED_MODULE_49__ = __webpack_require__(/*! ./services/services/sweetCameraEnforcementService */ "./src/services/services/sweetCameraEnforcementService.ts");
/* harmony import */ var _services_services_sweetTaffyNicknamesService__WEBPACK_IMPORTED_MODULE_50__ = __webpack_require__(/*! ./services/services/sweetTaffyNicknamesService */ "./src/services/services/sweetTaffyNicknamesService.ts");
/* harmony import */ var _services_services_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_51__ = __webpack_require__(/*! ./services/services/serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");





















































(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.setINIBool("bAlwaysActive:General", true);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.setGameSettingInt("iDeathDropWeaponChance", 0);
});
var main = function () {
    try {
        var controller = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__.SpApiInteractor.getControllerInstance();
        var listeners = [
            new _services_services_blockPapyrusEventsService__WEBPACK_IMPORTED_MODULE_2__.BlockPapyrusEventsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_loadGameService__WEBPACK_IMPORTED_MODULE_4__.LoadGameService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_6__.SinglePlayerService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_enforceLimitationsService__WEBPACK_IMPORTED_MODULE_3__.EnforceLimitationsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sendInputsService__WEBPACK_IMPORTED_MODULE_5__.SendInputsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_skympClient__WEBPACK_IMPORTED_MODULE_1__.SkympClient(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_timeService__WEBPACK_IMPORTED_MODULE_8__.TimeService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_spVersionCheckService__WEBPACK_IMPORTED_MODULE_9__.SpVersionCheckService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_consoleCommandsService__WEBPACK_IMPORTED_MODULE_10__.ConsoleCommandsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_lastInvService__WEBPACK_IMPORTED_MODULE_11__.LastInvService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_activationService__WEBPACK_IMPORTED_MODULE_12__.ActivationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_craftService__WEBPACK_IMPORTED_MODULE_13__.CraftService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_dropItemService__WEBPACK_IMPORTED_MODULE_14__.DropItemService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_hitService__WEBPACK_IMPORTED_MODULE_15__.HitService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_ragdollService__WEBPACK_IMPORTED_MODULE_16__.RagdollService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_deathService__WEBPACK_IMPORTED_MODULE_17__.DeathService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_containersService__WEBPACK_IMPORTED_MODULE_18__.ContainersService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_networkingService__WEBPACK_IMPORTED_MODULE_19__.NetworkingService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_20__.RemoteServer(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_spSnippetService__WEBPACK_IMPORTED_MODULE_21__.SpSnippetService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_settingsService__WEBPACK_IMPORTED_MODULE_48__.SettingsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyDynamicPerksService__WEBPACK_IMPORTED_MODULE_22__.SweetTaffyDynamicPerksService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyStaticPerksService__WEBPACK_IMPORTED_MODULE_24__.SweetTaffyStaticPerksService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_23__.SweetTaffySweetCantDropService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyPlayerCombatService__WEBPACK_IMPORTED_MODULE_28__.SweetTaffyPlayerCombatService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffySkillMenuService__WEBPACK_IMPORTED_MODULE_30__.SweetTaffySkillMenuService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetCameraEnforcementService__WEBPACK_IMPORTED_MODULE_49__.SweetCameraEnforcementService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableSkillAdvanceService__WEBPACK_IMPORTED_MODULE_25__.DisableSkillAdvanceService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableFastTravelService__WEBPACK_IMPORTED_MODULE_26__.DisableFastTravelService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableDifficultySelectionService__WEBPACK_IMPORTED_MODULE_27__.DisableDifficultySelectionService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_29__.WorldCleanerService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_loadOrderVerificationService__WEBPACK_IMPORTED_MODULE_31__.LoadOrderVerificationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_browserService__WEBPACK_IMPORTED_MODULE_32__.BrowserService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_authService__WEBPACK_IMPORTED_MODULE_33__.AuthService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_characterSelectService__WEBPACK_IMPORTED_MODULE_34__.CharacterSelectService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_netInfoService__WEBPACK_IMPORTED_MODULE_35__.NetInfoService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_animDebugService__WEBPACK_IMPORTED_MODULE_36__.AnimDebugService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_timersService__WEBPACK_IMPORTED_MODULE_37__.TimersService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_playerBowShotService__WEBPACK_IMPORTED_MODULE_38__.PlayerBowShotService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_gamemodeEventSourceService__WEBPACK_IMPORTED_MODULE_39__.GamemodeEventSourceService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_40__.GamemodeUpdateService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_frontHotReloadService__WEBPACK_IMPORTED_MODULE_41__.FrontHotReloadService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_blockedAnimationsService__WEBPACK_IMPORTED_MODULE_42__.BlockedAnimationsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_voiceChatService__WEBPACK_IMPORTED_MODULE_43__.VoiceChatService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _view_worldView__WEBPACK_IMPORTED_MODULE_44__.WorldView(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_keyboardEventsService__WEBPACK_IMPORTED_MODULE_45__.KeyboardEventsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_magicSyncService__WEBPACK_IMPORTED_MODULE_46__.MagicSyncService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_profilingService__WEBPACK_IMPORTED_MODULE_47__.ProfilingService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyNicknamesService__WEBPACK_IMPORTED_MODULE_50__.SweetTaffyNicknamesService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_51__.ServerJsVerificationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
        ];
        _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__.SpApiInteractor.setup(listeners);
    }
    catch (e) {
        // TODO: handle setup failure. will output to game console by default
        throw e;
    }
};
// [18.08.2023]
// I saw "attempt to call hooks.add while in hook context" error
// I'm not sure if it's a C++ bug in SkyrimPlatform or an artifact of webpack+hotreload
// But let's for now ensure that "main" executes inside tick context
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("tick", main);

/******/ })()
;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ087QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ087QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FDbENBO0FBR3FDO0FBQ1k7QUFDMUM7QUFDUDtBQUNBO0FBQ0E7QUFDQSxDQUFDLGdEQUFnRDtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWEsaURBQUs7QUFDbEI7QUFDQTtBQUNBLFlBQVksOERBQWM7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVksOERBQWM7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdCQUFnQixtREFBTztBQUN2QjtBQUNBLGdCQUFnQixtREFBTztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QUFnQixrRkFBZ0IsQ0FBQywyQ0FBRTtBQUNuQyxnQkFBZ0Isa0ZBQWdCLENBQUMsMkNBQUU7QUFDbkMsZ0JBQWdCLHNHQUEwQixDQUFDLDJDQUFFO0FBQzdDLGdCQUFnQix3R0FBMkIsQ0FBQywyQ0FBRTtBQUM5QztBQUNBLFFBQVEsc0VBQWU7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvREFBSSIsInNvdXJjZXMiOlsid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9ub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2V4dGVuc2lvbnMvZm9ybVR5cGVFeC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXgudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9mZWF0dXJlcy9hdXRoTW9kZWwudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9saWIvZXJyb3JzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvbGliL2lkTWFuYWdlci50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2xpYi9uYW1lb2YudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9sb2dnaW5nLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvbWVzc2FnZXMudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9ldmVudHMvZXZlbnRzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvYWN0aXZhdGlvblNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9hbmltRGVidWdTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvYXV0aFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9ibG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvYmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvYnJvd3NlclNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9jaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvY2xpZW50TGlzdGVuZXIudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9jb25zb2xlQ29tbWFuZHNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvY29udGFpbmVyc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9jcmFmdFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9kZWF0aFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9kaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9kaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9kaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Ryb3BJdGVtU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2VuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9mcm9udEhvdFJlbG9hZFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9nYW1lbW9kZUV2ZW50U291cmNlU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2dhbWVtb2RlVXBkYXRlU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2hpdFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9rZXlib2FyZEV2ZW50c1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9sYXN0SW52U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2xvYWRHYW1lU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2xvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9tYWdpY1N5bmNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvbmV0SW5mb1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9uZXR3b3JraW5nU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3BsYXllckJvd1Nob3RTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvcHJvZmlsaW5nU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3JhZ2RvbGxTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvcmVtb3RlU2VydmVyLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc2VuZElucHV0c1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zZXR0aW5nc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zaW5nbGVQbGF5ZXJTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc2t5bXBDbGllbnQudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zcFNuaXBwZXRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3BWZXJzaW9uQ2hlY2tTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy90aW1lU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3RpbWVyc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy92b2ljZUNoYXRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvd29ybGRDbGVhbmVyU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NwQXBpSW50ZXJhY3Rvci50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvYWN0b3J2YWx1ZXMudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL2FuaW1hdGlvbi50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvYXBwZWFyYW5jZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvZXF1aXBtZW50LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9pbnZlbnRvcnkudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL21vdmVtZW50QXBwbHkudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL21vdmVtZW50R2V0LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9zcGVsbC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZlcnNpb24udHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L2Zvcm1WaWV3LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy9mb3JtVmlld0FycmF5LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy9ob3N0QXR0ZW1wdHMudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L21vZGVsQXBwbHlVdGlscy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvcGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvc3Bhd25Qcm9jZXNzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy93b3JsZFZpZXcudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L3dvcmxkVmlld01pc2MudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC9leHRlcm5hbCBub2RlLWNvbW1vbmpzIFwiY3J5cHRvXCIiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC9leHRlcm5hbCBub2RlLWNvbW1vbmpzIFwiZnNcIiIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L2V4dGVybmFsIG5vZGUtY29tbW9uanMgXCJpbnNwZWN0b3JcIiIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L2V4dGVybmFsIG5vZGUtY29tbW9uanMgXCJub2RlOmNyeXB0b1wiIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvZXh0ZXJuYWwgdmFyIFtcInNreXJpbVBsYXRmb3JtXCJdIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9ub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5tanMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC93ZWJwYWNrL2Jvb3RzdHJhcCIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L3dlYnBhY2svcnVudGltZS9jb21wYXQgZ2V0IGRlZmF1bHQgZXhwb3J0Iiwid2VicGFjazovL3NreW1wNS1jbGllbnQvd2VicGFjay9ydW50aW1lL2RlZmluZSBwcm9wZXJ0eSBnZXR0ZXJzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvd2VicGFjay9ydW50aW1lL2hhc093blByb3BlcnR5IHNob3J0aGFuZCIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L3dlYnBhY2svcnVudGltZS9tYWtlIG5hbWVzcGFjZSBvYmplY3QiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBoYXMgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5XG4gICwgcHJlZml4ID0gJ34nO1xuXG4vKipcbiAqIENvbnN0cnVjdG9yIHRvIGNyZWF0ZSBhIHN0b3JhZ2UgZm9yIG91ciBgRUVgIG9iamVjdHMuXG4gKiBBbiBgRXZlbnRzYCBpbnN0YW5jZSBpcyBhIHBsYWluIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIGFyZSBldmVudCBuYW1lcy5cbiAqXG4gKiBAY29uc3RydWN0b3JcbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIEV2ZW50cygpIHt9XG5cbi8vXG4vLyBXZSB0cnkgdG8gbm90IGluaGVyaXQgZnJvbSBgT2JqZWN0LnByb3RvdHlwZWAuIEluIHNvbWUgZW5naW5lcyBjcmVhdGluZyBhblxuLy8gaW5zdGFuY2UgaW4gdGhpcyB3YXkgaXMgZmFzdGVyIHRoYW4gY2FsbGluZyBgT2JqZWN0LmNyZWF0ZShudWxsKWAgZGlyZWN0bHkuXG4vLyBJZiBgT2JqZWN0LmNyZWF0ZShudWxsKWAgaXMgbm90IHN1cHBvcnRlZCB3ZSBwcmVmaXggdGhlIGV2ZW50IG5hbWVzIHdpdGggYVxuLy8gY2hhcmFjdGVyIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBidWlsdC1pbiBvYmplY3QgcHJvcGVydGllcyBhcmUgbm90XG4vLyBvdmVycmlkZGVuIG9yIHVzZWQgYXMgYW4gYXR0YWNrIHZlY3Rvci5cbi8vXG5pZiAoT2JqZWN0LmNyZWF0ZSkge1xuICBFdmVudHMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAvL1xuICAvLyBUaGlzIGhhY2sgaXMgbmVlZGVkIGJlY2F1c2UgdGhlIGBfX3Byb3RvX19gIHByb3BlcnR5IGlzIHN0aWxsIGluaGVyaXRlZCBpblxuICAvLyBzb21lIG9sZCBicm93c2VycyBsaWtlIEFuZHJvaWQgNCwgaVBob25lIDUuMSwgT3BlcmEgMTEgYW5kIFNhZmFyaSA1LlxuICAvL1xuICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlO1xufVxuXG4vKipcbiAqIFJlcHJlc2VudGF0aW9uIG9mIGEgc2luZ2xlIGV2ZW50IGxpc3RlbmVyLlxuICpcbiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi5cbiAqIEBwYXJhbSB7Kn0gY29udGV4dCBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguXG4gKiBAcGFyYW0ge0Jvb2xlYW59IFtvbmNlPWZhbHNlXSBTcGVjaWZ5IGlmIHRoZSBsaXN0ZW5lciBpcyBhIG9uZS10aW1lIGxpc3RlbmVyLlxuICogQGNvbnN0cnVjdG9yXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBFRShmbiwgY29udGV4dCwgb25jZSkge1xuICB0aGlzLmZuID0gZm47XG4gIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XG4gIHRoaXMub25jZSA9IG9uY2UgfHwgZmFsc2U7XG59XG5cbi8qKlxuICogQWRkIGEgbGlzdGVuZXIgZm9yIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgUmVmZXJlbmNlIHRvIHRoZSBgRXZlbnRFbWl0dGVyYCBpbnN0YW5jZS5cbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi5cbiAqIEBwYXJhbSB7Kn0gY29udGV4dCBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguXG4gKiBAcGFyYW0ge0Jvb2xlYW59IG9uY2UgU3BlY2lmeSBpZiB0aGUgbGlzdGVuZXIgaXMgYSBvbmUtdGltZSBsaXN0ZW5lci5cbiAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9XG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBhZGRMaXN0ZW5lcihlbWl0dGVyLCBldmVudCwgZm4sIGNvbnRleHQsIG9uY2UpIHtcbiAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RoZSBsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTtcbiAgfVxuXG4gIHZhciBsaXN0ZW5lciA9IG5ldyBFRShmbiwgY29udGV4dCB8fCBlbWl0dGVyLCBvbmNlKVxuICAgICwgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDtcblxuICBpZiAoIWVtaXR0ZXIuX2V2ZW50c1tldnRdKSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IGxpc3RlbmVyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrO1xuICBlbHNlIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0uZm4pIGVtaXR0ZXIuX2V2ZW50c1tldnRdLnB1c2gobGlzdGVuZXIpO1xuICBlbHNlIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gW2VtaXR0ZXIuX2V2ZW50c1tldnRdLCBsaXN0ZW5lcl07XG5cbiAgcmV0dXJuIGVtaXR0ZXI7XG59XG5cbi8qKlxuICogQ2xlYXIgZXZlbnQgYnkgbmFtZS5cbiAqXG4gKiBAcGFyYW0ge0V2ZW50RW1pdHRlcn0gZW1pdHRlciBSZWZlcmVuY2UgdG8gdGhlIGBFdmVudEVtaXR0ZXJgIGluc3RhbmNlLlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2dCBUaGUgRXZlbnQgbmFtZS5cbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIGNsZWFyRXZlbnQoZW1pdHRlciwgZXZ0KSB7XG4gIGlmICgtLWVtaXR0ZXIuX2V2ZW50c0NvdW50ID09PSAwKSBlbWl0dGVyLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7XG4gIGVsc2UgZGVsZXRlIGVtaXR0ZXIuX2V2ZW50c1tldnRdO1xufVxuXG4vKipcbiAqIE1pbmltYWwgYEV2ZW50RW1pdHRlcmAgaW50ZXJmYWNlIHRoYXQgaXMgbW9sZGVkIGFnYWluc3QgdGhlIE5vZGUuanNcbiAqIGBFdmVudEVtaXR0ZXJgIGludGVyZmFjZS5cbiAqXG4gKiBAY29uc3RydWN0b3JcbiAqIEBwdWJsaWNcbiAqL1xuZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkge1xuICB0aGlzLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7XG4gIHRoaXMuX2V2ZW50c0NvdW50ID0gMDtcbn1cblxuLyoqXG4gKiBSZXR1cm4gYW4gYXJyYXkgbGlzdGluZyB0aGUgZXZlbnRzIGZvciB3aGljaCB0aGUgZW1pdHRlciBoYXMgcmVnaXN0ZXJlZFxuICogbGlzdGVuZXJzLlxuICpcbiAqIEByZXR1cm5zIHtBcnJheX1cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5ldmVudE5hbWVzID0gZnVuY3Rpb24gZXZlbnROYW1lcygpIHtcbiAgdmFyIG5hbWVzID0gW11cbiAgICAsIGV2ZW50c1xuICAgICwgbmFtZTtcblxuICBpZiAodGhpcy5fZXZlbnRzQ291bnQgPT09IDApIHJldHVybiBuYW1lcztcblxuICBmb3IgKG5hbWUgaW4gKGV2ZW50cyA9IHRoaXMuX2V2ZW50cykpIHtcbiAgICBpZiAoaGFzLmNhbGwoZXZlbnRzLCBuYW1lKSkgbmFtZXMucHVzaChwcmVmaXggPyBuYW1lLnNsaWNlKDEpIDogbmFtZSk7XG4gIH1cblxuICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykge1xuICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTtcbiAgfVxuXG4gIHJldHVybiBuYW1lcztcbn07XG5cbi8qKlxuICogUmV0dXJuIHRoZSBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBmb3IgYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcmV0dXJucyB7QXJyYXl9IFRoZSByZWdpc3RlcmVkIGxpc3RlbmVycy5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnQpIHtcbiAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnRcbiAgICAsIGhhbmRsZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07XG5cbiAgaWYgKCFoYW5kbGVycykgcmV0dXJuIFtdO1xuICBpZiAoaGFuZGxlcnMuZm4pIHJldHVybiBbaGFuZGxlcnMuZm5dO1xuXG4gIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykge1xuICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47XG4gIH1cblxuICByZXR1cm4gZWU7XG59O1xuXG4vKipcbiAqIFJldHVybiB0aGUgbnVtYmVyIG9mIGxpc3RlbmVycyBsaXN0ZW5pbmcgdG8gYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtYmVyIG9mIGxpc3RlbmVycy5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24gbGlzdGVuZXJDb3VudChldmVudCkge1xuICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudFxuICAgICwgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07XG5cbiAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwO1xuICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTtcbiAgcmV0dXJuIGxpc3RlbmVycy5sZW5ndGg7XG59O1xuXG4vKipcbiAqIENhbGxzIGVhY2ggb2YgdGhlIGxpc3RlbmVycyByZWdpc3RlcmVkIGZvciBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEByZXR1cm5zIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIGV2ZW50IGhhZCBsaXN0ZW5lcnMsIGVsc2UgYGZhbHNlYC5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gZW1pdChldmVudCwgYTEsIGEyLCBhMywgYTQsIGE1KSB7XG4gIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50O1xuXG4gIGlmICghdGhpcy5fZXZlbnRzW2V2dF0pIHJldHVybiBmYWxzZTtcblxuICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF1cbiAgICAsIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGhcbiAgICAsIGFyZ3NcbiAgICAsIGk7XG5cbiAgaWYgKGxpc3RlbmVycy5mbikge1xuICAgIGlmIChsaXN0ZW5lcnMub25jZSkgdGhpcy5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzLmZuLCB1bmRlZmluZWQsIHRydWUpO1xuXG4gICAgc3dpdGNoIChsZW4pIHtcbiAgICAgIGNhc2UgMTogcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0KSwgdHJ1ZTtcbiAgICAgIGNhc2UgMjogcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSksIHRydWU7XG4gICAgICBjYXNlIDM6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyKSwgdHJ1ZTtcbiAgICAgIGNhc2UgNDogcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzKSwgdHJ1ZTtcbiAgICAgIGNhc2UgNTogcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCksIHRydWU7XG4gICAgICBjYXNlIDY6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMywgYTQsIGE1KSwgdHJ1ZTtcbiAgICB9XG5cbiAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtMSk7IGkgPCBsZW47IGkrKykge1xuICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07XG4gICAgfVxuXG4gICAgbGlzdGVuZXJzLmZuLmFwcGx5KGxpc3RlbmVycy5jb250ZXh0LCBhcmdzKTtcbiAgfSBlbHNlIHtcbiAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aFxuICAgICAgLCBqO1xuXG4gICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAobGlzdGVuZXJzW2ldLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyc1tpXS5mbiwgdW5kZWZpbmVkLCB0cnVlKTtcblxuICAgICAgc3dpdGNoIChsZW4pIHtcbiAgICAgICAgY2FzZSAxOiBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCk7IGJyZWFrO1xuICAgICAgICBjYXNlIDI6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSk7IGJyZWFrO1xuICAgICAgICBjYXNlIDM6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOyBicmVhaztcbiAgICAgICAgY2FzZSA0OiBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEsIGEyLCBhMyk7IGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLTEpOyBqIDwgbGVuOyBqKyspIHtcbiAgICAgICAgICAgIGFyZ3NbaiAtIDFdID0gYXJndW1lbnRzW2pdO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGxpc3RlbmVyc1tpXS5mbi5hcHBseShsaXN0ZW5lcnNbaV0uY29udGV4dCwgYXJncyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59O1xuXG4vKipcbiAqIEFkZCBhIGxpc3RlbmVyIGZvciBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi5cbiAqIEBwYXJhbSB7Kn0gW2NvbnRleHQ9dGhpc10gVGhlIGNvbnRleHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciB3aXRoLlxuICogQHJldHVybnMge0V2ZW50RW1pdHRlcn0gYHRoaXNgLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gZnVuY3Rpb24gb24oZXZlbnQsIGZuLCBjb250ZXh0KSB7XG4gIHJldHVybiBhZGRMaXN0ZW5lcih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIGZhbHNlKTtcbn07XG5cbi8qKlxuICogQWRkIGEgb25lLXRpbWUgbGlzdGVuZXIgZm9yIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLlxuICogQHBhcmFtIHsqfSBbY29udGV4dD10aGlzXSBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguXG4gKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIG9uY2UoZXZlbnQsIGZuLCBjb250ZXh0KSB7XG4gIHJldHVybiBhZGRMaXN0ZW5lcih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIHRydWUpO1xufTtcblxuLyoqXG4gKiBSZW1vdmUgdGhlIGxpc3RlbmVycyBvZiBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIE9ubHkgcmVtb3ZlIHRoZSBsaXN0ZW5lcnMgdGhhdCBtYXRjaCB0aGlzIGZ1bmN0aW9uLlxuICogQHBhcmFtIHsqfSBjb250ZXh0IE9ubHkgcmVtb3ZlIHRoZSBsaXN0ZW5lcnMgdGhhdCBoYXZlIHRoaXMgY29udGV4dC5cbiAqIEBwYXJhbSB7Qm9vbGVhbn0gb25jZSBPbmx5IHJlbW92ZSBvbmUtdGltZSBsaXN0ZW5lcnMuXG4gKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudCwgZm4sIGNvbnRleHQsIG9uY2UpIHtcbiAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7XG5cbiAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7XG4gIGlmICghZm4pIHtcbiAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07XG5cbiAgaWYgKGxpc3RlbmVycy5mbikge1xuICAgIGlmIChcbiAgICAgIGxpc3RlbmVycy5mbiA9PT0gZm4gJiZcbiAgICAgICghb25jZSB8fCBsaXN0ZW5lcnMub25jZSkgJiZcbiAgICAgICghY29udGV4dCB8fCBsaXN0ZW5lcnMuY29udGV4dCA9PT0gY29udGV4dClcbiAgICApIHtcbiAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50cyA9IFtdLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChcbiAgICAgICAgbGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fFxuICAgICAgICAob25jZSAmJiAhbGlzdGVuZXJzW2ldLm9uY2UpIHx8XG4gICAgICAgIChjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KVxuICAgICAgKSB7XG4gICAgICAgIGV2ZW50cy5wdXNoKGxpc3RlbmVyc1tpXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy9cbiAgICAvLyBSZXNldCB0aGUgYXJyYXksIG9yIHJlbW92ZSBpdCBjb21wbGV0ZWx5IGlmIHdlIGhhdmUgbm8gbW9yZSBsaXN0ZW5lcnMuXG4gICAgLy9cbiAgICBpZiAoZXZlbnRzLmxlbmd0aCkgdGhpcy5fZXZlbnRzW2V2dF0gPSBldmVudHMubGVuZ3RoID09PSAxID8gZXZlbnRzWzBdIDogZXZlbnRzO1xuICAgIGVsc2UgY2xlYXJFdmVudCh0aGlzLCBldnQpO1xuICB9XG5cbiAgcmV0dXJuIHRoaXM7XG59O1xuXG4vKipcbiAqIFJlbW92ZSBhbGwgbGlzdGVuZXJzLCBvciB0aG9zZSBvZiB0aGUgc3BlY2lmaWVkIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBbZXZlbnRdIFRoZSBldmVudCBuYW1lLlxuICogQHJldHVybnMge0V2ZW50RW1pdHRlcn0gYHRoaXNgLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudCkge1xuICB2YXIgZXZ0O1xuXG4gIGlmIChldmVudCkge1xuICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7XG4gICAgaWYgKHRoaXMuX2V2ZW50c1tldnRdKSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpO1xuICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDtcbiAgfVxuXG4gIHJldHVybiB0aGlzO1xufTtcblxuLy9cbi8vIEFsaWFzIG1ldGhvZHMgbmFtZXMgYmVjYXVzZSBwZW9wbGUgcm9sbCBsaWtlIHRoYXQuXG4vL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vZmYgPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyO1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUub247XG5cbi8vXG4vLyBFeHBvc2UgdGhlIHByZWZpeC5cbi8vXG5FdmVudEVtaXR0ZXIucHJlZml4ZWQgPSBwcmVmaXg7XG5cbi8vXG4vLyBBbGxvdyBgRXZlbnRFbWl0dGVyYCB0byBiZSBpbXBvcnRlZCBhcyBtb2R1bGUgbmFtZXNwYWNlLlxuLy9cbkV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7XG5cbi8vXG4vLyBFeHBvc2UgdGhlIG1vZHVsZS5cbi8vXG5pZiAoJ3VuZGVmaW5lZCcgIT09IHR5cGVvZiBtb2R1bGUpIHtcbiAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7XG59XG4iLCJ2YXIgRm9ybVR5cGVFeCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIEZvcm1UeXBlRXgoKSB7XHJcbiAgICB9XHJcbiAgICBGb3JtVHlwZUV4LmlzSXRlbSA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIHR5cGUgPT09IDQyIC8qIEZvcm1UeXBlLkFtbW8gKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMjYgLyogRm9ybVR5cGUuQXJtb3IgKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMjcgLyogRm9ybVR5cGUuQm9vayAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAzMCAvKiBGb3JtVHlwZS5JbmdyZWRpZW50ICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDMxIC8qIEZvcm1UeXBlLkxpZ2h0ICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDQ2IC8qIEZvcm1UeXBlLlBvdGlvbiAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAyMyAvKiBGb3JtVHlwZS5TY3JvbGxJdGVtICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDUyIC8qIEZvcm1UeXBlLlNvdWxHZW0gKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gNDEgLyogRm9ybVR5cGUuV2VhcG9uICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDMyIC8qIEZvcm1UeXBlLk1pc2MgKi87XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEZvcm1UeXBlRXg7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IEZvcm1UeXBlRXggfTtcclxuIiwiaW1wb3J0IHsgRmxvcmEgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgRm9ybVR5cGVFeCB9IGZyb20gXCIuL2Zvcm1UeXBlRXhcIjtcclxudmFyIE9iamVjdFJlZmVyZW5jZUV4ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gT2JqZWN0UmVmZXJlbmNlRXgoKSB7XHJcbiAgICB9XHJcbiAgICBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbCA9IGZ1bmN0aW9uIChzZWxmKSB7XHJcbiAgICAgICAgdmFyIHdvcmxkID0gc2VsZi5nZXRXb3JsZFNwYWNlKCk7XHJcbiAgICAgICAgaWYgKHdvcmxkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB3b3JsZC5nZXRGb3JtSUQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGNlbGwgPSBzZWxmLmdldFBhcmVudENlbGwoKTtcclxuICAgICAgICBpZiAoY2VsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gY2VsbC5nZXRGb3JtSUQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9O1xyXG4gICAgT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zID0gZnVuY3Rpb24gKHNlbGYpIHtcclxuICAgICAgICByZXR1cm4gW3NlbGYuZ2V0UG9zaXRpb25YKCksIHNlbGYuZ2V0UG9zaXRpb25ZKCksIHNlbGYuZ2V0UG9zaXRpb25aKCldO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlID0gZnVuY3Rpb24gKGEsIGIpIHtcclxuICAgICAgICB2YXIgZGVsdGFYID0gYVswXSAtIGJbMF07XHJcbiAgICAgICAgdmFyIGRlbHRhWSA9IGFbMV0gLSBiWzFdO1xyXG4gICAgICAgIHZhciBkZWx0YVogPSBhWzJdIC0gYlsyXTtcclxuICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KGRlbHRhWCAqIGRlbHRhWCArIGRlbHRhWSAqIGRlbHRhWSArIGRlbHRhWiAqIGRlbHRhWik7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2VOb1ogPSBmdW5jdGlvbiAoYSwgYikge1xyXG4gICAgICAgIHZhciBkZWx0YVggPSBhWzBdIC0gYlswXTtcclxuICAgICAgICB2YXIgZGVsdGFZID0gYVsxXSAtIGJbMV07XHJcbiAgICAgICAgcmV0dXJuIE1hdGguc3FydChkZWx0YVggKiBkZWx0YVggKyBkZWx0YVkgKiBkZWx0YVkpO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIE9iamVjdFJlZmVyZW5jZUV4LmRlYWxXaXRoUmVmID0gZnVuY3Rpb24gKHNlbGYsIGJhc2UpIHtcclxuICAgICAgICB2YXIgX2EsIF9iO1xyXG4gICAgICAgIHZhciB0ID0gYmFzZS5nZXRUeXBlKCk7XHJcbiAgICAgICAgdmFyIGlzSXRlbSA9IEZvcm1UeXBlRXguaXNJdGVtKHQpO1xyXG4gICAgICAgIC8vIEJsYWNrRmFsbHNCYXJyb3cwMiwgZG9vciBpc24ndCBvcGVuaW5nIHZpYSBTZXRPcGVuIHNvIHdlJ3JlIGhhY2tpbmcgaXQuXHJcbiAgICAgICAgLy8gTm90IGJsb2NraW5nIGFjdGl2YXRpb24gJiBhc2tpbmcgcGFyZW50IHRvIGFjdGl2YXRlIHVudGlsIHdpbGwgYmUgaW4gdGhlIGNvcnJlY3Qgc3RhdGVcclxuICAgICAgICAvLyBTZWUgYWxzbyBtb2RlbEFwcGx5VXRpbHMudHNcclxuICAgICAgICB2YXIgY2F2ZUdTZWNyZXREb29yMDEgPSAweDZmNzAzO1xyXG4gICAgICAgIC8vIFlvdSBjYW4gYWxzbyBibG9jayBmb3IgdCA9PT0gRm9ybVR5cGUuRmxvcmEgfHwgdCA9PT0gRm9ybVR5cGUuVHJlZSwgYnV0IEkgZG9uJ3QgdGhpbmsgaXQncyBuZWNlc3NhcnkuXHJcbiAgICAgICAgaWYgKHQgPT09IDQwIC8qIEZvcm1UeXBlLkZ1cm5pdHVyZSAqL1xyXG4gICAgICAgICAgICB8fCB0ID09PSAyNCAvKiBGb3JtVHlwZS5BY3RpdmF0b3IgKi9cclxuICAgICAgICAgICAgfHwgdCA9PT0gMjggLyogRm9ybVR5cGUuQ29udGFpbmVyICovXHJcbiAgICAgICAgICAgIHx8IGlzSXRlbVxyXG4gICAgICAgICAgICB8fCB0ID09PSA0MyAvKiBGb3JtVHlwZS5OUEMgKi9cclxuICAgICAgICAgICAgfHwgKHQgPT09IDI5IC8qIEZvcm1UeXBlLkRvb3IgKi8gJiYgKChfYSA9IHNlbGYuZ2V0QmFzZU9iamVjdCgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Rm9ybUlEKCkpICE9PSBjYXZlR1NlY3JldERvb3IwMSkpIHtcclxuICAgICAgICAgICAgc2VsZi5ibG9ja0FjdGl2YXRpb24odHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBzZWxmLmJsb2NrQWN0aXZhdGlvbihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzZWxmLmlzTG9ja2VkKCkpIHtcclxuICAgICAgICAgICAgc2VsZi5sb2NrKGZhbHNlLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpc0l0ZW0pIHtcclxuICAgICAgICAgICAgc2VsZi5zZXRNb3Rpb25UeXBlKDQgLyogTW90aW9uVHlwZS5LZXlmcmFtZWQgKi8sIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3NreXJpbS1tdWx0aXBsYXllci9pc3N1ZS10cmFja2VyL2lzc3Vlcy8zNlxyXG4gICAgICAgIGlmICh0ID09PSAzOSAvKiBGb3JtVHlwZS5GbG9yYSAqLyAmJiAoKF9iID0gRmxvcmEuZnJvbShiYXNlKSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmdldEluZ3JlZGllbnQoKSkpIHtcclxuICAgICAgICAgICAgc2VsZi5zZXRNb3Rpb25UeXBlKDQgLyogTW90aW9uVHlwZS5LZXlmcmFtZWQgKi8sIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIE9iamVjdFJlZmVyZW5jZUV4O1xyXG59KCkpO1xyXG5leHBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9O1xyXG4iLCI7XHJcbjtcclxuO1xyXG5leHBvcnQgdmFyIGF1dGhHYW1lRGF0YVN0b3JhZ2VLZXkgPSBcImF1dGhHYW1lRGF0YVwiO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIFJlc3Bhd25OZWVkZWRFcnJvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhSZXNwYXduTmVlZGVkRXJyb3IsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBSZXNwYXduTmVlZGVkRXJyb3IobWVzc2FnZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIG1lc3NhZ2UpIHx8IHRoaXM7XHJcbiAgICAgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKF90aGlzLCBSZXNwYXduTmVlZGVkRXJyb3IucHJvdG90eXBlKTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gUmVzcGF3bk5lZWRlZEVycm9yO1xyXG59KEVycm9yKSk7XHJcbmV4cG9ydCB7IFJlc3Bhd25OZWVkZWRFcnJvciB9O1xyXG52YXIgTmV2ZXJFcnJvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhOZXZlckVycm9yLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTmV2ZXJFcnJvcihtZXNzYWdlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgXCJOZXZlckVycm9yOiBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpKSB8fCB0aGlzO1xyXG4gICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihfdGhpcywgTmV2ZXJFcnJvci5wcm90b3R5cGUpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIHJldHVybiBOZXZlckVycm9yO1xyXG59KEVycm9yKSk7XHJcbmV4cG9ydCB7IE5ldmVyRXJyb3IgfTtcclxuIiwidmFyIElkTWFuYWdlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIElkTWFuYWdlcigpIHtcclxuICAgICAgICB0aGlzLmlkQnlWYWx1ZSA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIHRoaXMudmFsdWVCeUlkID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgdGhpcy5taW5pbXVtVW51c2VkSWQgPSAwO1xyXG4gICAgfVxyXG4gICAgSWRNYW5hZ2VyLnByb3RvdHlwZS5hbGxvY2F0ZUlkRm9yID0gZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaWRCeVZhbHVlLmxlbmd0aCA8PSB2YWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmlkQnlWYWx1ZS5sZW5ndGggPSB2YWx1ZSArIDE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaWRCeVZhbHVlW3ZhbHVlXSA9IHRoaXMubWluaW11bVVudXNlZElkO1xyXG4gICAgICAgIGlmICh0aGlzLnZhbHVlQnlJZC5sZW5ndGggPD0gdGhpcy5taW5pbXVtVW51c2VkSWQpIHtcclxuICAgICAgICAgICAgdGhpcy52YWx1ZUJ5SWQubGVuZ3RoID0gdGhpcy5taW5pbXVtVW51c2VkSWQgKyAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnZhbHVlQnlJZFt0aGlzLm1pbmltdW1VbnVzZWRJZF0gPSB2YWx1ZTtcclxuICAgICAgICB2YXIgcmVzID0gdGhpcy5taW5pbXVtVW51c2VkSWQ7XHJcbiAgICAgICAgdGhpcy5taW5pbXVtVW51c2VkSWQrKztcclxuICAgICAgICB3aGlsZSAodGhpcy52YWx1ZUJ5SWQubGVuZ3RoID4gdGhpcy5taW5pbXVtVW51c2VkSWQgJiZcclxuICAgICAgICAgICAgdHlwZW9mIHRoaXMudmFsdWVCeUlkW3RoaXMubWluaW11bVVudXNlZElkXSA9PT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICB0aGlzLm1pbmltdW1VbnVzZWRJZCsrO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfTtcclxuICAgIElkTWFuYWdlci5wcm90b3R5cGUuZnJlZUlkRm9yID0gZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgdmFyIGlkID0gdGhpcy5pZEJ5VmFsdWVbdmFsdWVdO1xyXG4gICAgICAgIGlmIChpZCA8IHRoaXMubWluaW11bVVudXNlZElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWluaW11bVVudXNlZElkID0gaWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaWRCeVZhbHVlW3ZhbHVlXSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLnZhbHVlQnlJZFtpZF0gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfTtcclxuICAgIElkTWFuYWdlci5wcm90b3R5cGUuZ2V0SWQgPSBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICB2YXIgciA9IHRoaXMuaWRCeVZhbHVlW3ZhbHVlXTtcclxuICAgICAgICByZXR1cm4gdHlwZW9mIHIgPT09IFwibnVtYmVyXCIgPyByIDogLTE7XHJcbiAgICB9O1xyXG4gICAgSWRNYW5hZ2VyLnByb3RvdHlwZS5nZXRWYWx1ZUJ5SWQgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy52YWx1ZUJ5SWRbaWRdO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBJZE1hbmFnZXI7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IElkTWFuYWdlciB9O1xyXG4iLCJleHBvcnQgZnVuY3Rpb24gbmFtZW9mKGtleSkge1xyXG4gICAgcmV0dXJuIGtleTtcclxufVxyXG4iLCJ2YXIgX19zcHJlYWRBcnJheSA9ICh0aGlzICYmIHRoaXMuX19zcHJlYWRBcnJheSkgfHwgZnVuY3Rpb24gKHRvLCBmcm9tLCBwYWNrKSB7XHJcbiAgICBpZiAocGFjayB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAyKSBmb3IgKHZhciBpID0gMCwgbCA9IGZyb20ubGVuZ3RoLCBhcjsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgIGlmIChhciB8fCAhKGkgaW4gZnJvbSkpIHtcclxuICAgICAgICAgICAgaWYgKCFhcikgYXIgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChmcm9tLCAwLCBpKTtcclxuICAgICAgICAgICAgYXJbaV0gPSBmcm9tW2ldO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0by5jb25jYXQoYXIgfHwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZnJvbSkpO1xyXG59O1xyXG5pbXBvcnQgeyBwcmludENvbnNvbGUgfSBmcm9tIFwiQHNreXJpbS1wbGF0Zm9ybS9za3lyaW0tcGxhdGZvcm1cIjtcclxuLy8gVE9ETzogcmVkaXJlY3QgdGhpcyB0byBzcGRsb2dcclxuZXhwb3J0IGZ1bmN0aW9uIGxvZ0Vycm9yKHNlcnZpY2UpIHtcclxuICAgIHZhciByZXN0ID0gW107XHJcbiAgICBmb3IgKHZhciBfaSA9IDE7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgIHJlc3RbX2kgLSAxXSA9IGFyZ3VtZW50c1tfaV07XHJcbiAgICB9XHJcbiAgICB2YXIgcmVzdFByb2Nlc3NlZCA9IHJlc3QubWFwKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBFcnJvcikge1xyXG4gICAgICAgICAgICByZXR1cm4gaXRlbS5zdGFjayB8fCBpdGVtLm1lc3NhZ2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBpdGVtO1xyXG4gICAgfSk7XHJcbiAgICBwcmludENvbnNvbGUuYXBwbHkodm9pZCAwLCBfX3NwcmVhZEFycmF5KFtcIkVycm9yIGluIFwiLmNvbmNhdCh0eXBlb2Ygc2VydmljZSAhPT0gXCJzdHJpbmdcIiA/IHNlcnZpY2UuY29uc3RydWN0b3IubmFtZSA6IHNlcnZpY2UsIFwiOlwiKV0sIHJlc3RQcm9jZXNzZWQsIGZhbHNlKSk7XHJcbn1cclxuLy8gVE9ETzogcmVkaXJlY3QgdGhpcyB0byBzcGRsb2dcclxuZXhwb3J0IGZ1bmN0aW9uIGxvZ1RyYWNlKHNlcnZpY2UpIHtcclxuICAgIHZhciByZXN0ID0gW107XHJcbiAgICBmb3IgKHZhciBfaSA9IDE7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgIHJlc3RbX2kgLSAxXSA9IGFyZ3VtZW50c1tfaV07XHJcbiAgICB9XHJcbiAgICB2YXIgcmVzdFByb2Nlc3NlZCA9IHJlc3QubWFwKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBFcnJvcikge1xyXG4gICAgICAgICAgICByZXR1cm4gaXRlbS5zdGFjayB8fCBpdGVtLm1lc3NhZ2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBpdGVtO1xyXG4gICAgfSk7XHJcbiAgICBwcmludENvbnNvbGUuYXBwbHkodm9pZCAwLCBfX3NwcmVhZEFycmF5KFtcIlRyYWNlIGluIFwiLmNvbmNhdCh0eXBlb2Ygc2VydmljZSAhPT0gXCJzdHJpbmdcIiA/IHNlcnZpY2UuY29uc3RydWN0b3IubmFtZSA6IHNlcnZpY2UsIFwiOlwiKV0sIHJlc3RQcm9jZXNzZWQsIGZhbHNlKSk7XHJcbn1cclxuIiwiZXhwb3J0IHZhciBNc2dUeXBlO1xyXG4oZnVuY3Rpb24gKE1zZ1R5cGUpIHtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkN1c3RvbVBhY2tldFwiXSA9IDFdID0gXCJDdXN0b21QYWNrZXRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZU1vdmVtZW50XCJdID0gMl0gPSBcIlVwZGF0ZU1vdmVtZW50XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVBbmltYXRpb25cIl0gPSAzXSA9IFwiVXBkYXRlQW5pbWF0aW9uXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVBcHBlYXJhbmNlXCJdID0gNF0gPSBcIlVwZGF0ZUFwcGVhcmFuY2VcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZUVxdWlwbWVudFwiXSA9IDVdID0gXCJVcGRhdGVFcXVpcG1lbnRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkFjdGl2YXRlXCJdID0gNl0gPSBcIkFjdGl2YXRlXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVQcm9wZXJ0eVwiXSA9IDddID0gXCJVcGRhdGVQcm9wZXJ0eVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiUHV0SXRlbVwiXSA9IDhdID0gXCJQdXRJdGVtXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJUYWtlSXRlbVwiXSA9IDldID0gXCJUYWtlSXRlbVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiRmluaXNoU3BTbmlwcGV0XCJdID0gMTBdID0gXCJGaW5pc2hTcFNuaXBwZXRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIk9uRXF1aXBcIl0gPSAxMV0gPSBcIk9uRXF1aXBcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkNvbnNvbGVDb21tYW5kXCJdID0gMTJdID0gXCJDb25zb2xlQ29tbWFuZFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQ3JhZnRJdGVtXCJdID0gMTNdID0gXCJDcmFmdEl0ZW1cIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkhvc3RcIl0gPSAxNF0gPSBcIkhvc3RcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkN1c3RvbUV2ZW50XCJdID0gMTVdID0gXCJDdXN0b21FdmVudFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQ2hhbmdlVmFsdWVzXCJdID0gMTZdID0gXCJDaGFuZ2VWYWx1ZXNcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIk9uSGl0XCJdID0gMTddID0gXCJPbkhpdFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiRGVhdGhTdGF0ZUNvbnRhaW5lclwiXSA9IDE4XSA9IFwiRGVhdGhTdGF0ZUNvbnRhaW5lclwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiRHJvcEl0ZW1cIl0gPSAxOV0gPSBcIkRyb3BJdGVtXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJUZWxlcG9ydFwiXSA9IDIwXSA9IFwiVGVsZXBvcnRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIk9wZW5Db250YWluZXJcIl0gPSAyMV0gPSBcIk9wZW5Db250YWluZXJcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlBsYXllckJvd1Nob3RcIl0gPSAyMl0gPSBcIlBsYXllckJvd1Nob3RcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlNwZWxsQ2FzdFwiXSA9IDIzXSA9IFwiU3BlbGxDYXN0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVBbmltVmFyaWFibGVzXCJdID0gMjRdID0gXCJVcGRhdGVBbmltVmFyaWFibGVzXCI7XHJcbiAgICAvLyBleC1zdHJpbmdzXHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJEZXN0cm95QWN0b3JcIl0gPSAyNV0gPSBcIkRlc3Ryb3lBY3RvclwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiSG9zdFN0YXJ0XCJdID0gMjZdID0gXCJIb3N0U3RhcnRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkhvc3RTdG9wXCJdID0gMjddID0gXCJIb3N0U3RvcFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiU2V0SW52ZW50b3J5XCJdID0gMjhdID0gXCJTZXRJbnZlbnRvcnlcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlNldFJhY2VNZW51T3BlblwiXSA9IDI5XSA9IFwiU2V0UmFjZU1lbnVPcGVuXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJTcFNuaXBwZXRcIl0gPSAzMF0gPSBcIlNwU25pcHBldFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVGVsZXBvcnQyXCJdID0gMzFdID0gXCJUZWxlcG9ydDJcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZUdhbWVtb2RlRGF0YVwiXSA9IDMyXSA9IFwiVXBkYXRlR2FtZW1vZGVEYXRhXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJDcmVhdGVBY3RvclwiXSA9IDMzXSA9IFwiQ3JlYXRlQWN0b3JcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlZvaWNlQ2hhdE1lc3NhZ2VcIl0gPSAzNF0gPSBcIlZvaWNlQ2hhdE1lc3NhZ2VcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZVZvaWNlQ2hhdE1lc3NhZ2VcIl0gPSAzNV0gPSBcIlVwZGF0ZVZvaWNlQ2hhdE1lc3NhZ2VcIjtcclxufSkoTXNnVHlwZSB8fCAoTXNnVHlwZSA9IHt9KSk7XHJcbiIsImltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudGVtaXR0ZXIzXCI7XHJcbnZhciBFdmVudEVtaXR0ZXJGYWN0b3J5ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyRmFjdG9yeSgpIHtcclxuICAgIH1cclxuICAgIEV2ZW50RW1pdHRlckZhY3RvcnkubWFrZUV2ZW50RW1pdHRlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gKG5ldyBFdmVudEVtaXR0ZXIoKSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEV2ZW50RW1pdHRlckZhY3Rvcnk7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IEV2ZW50RW1pdHRlckZhY3RvcnkgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBnZXRJbnZlbnRvcnkgfSBmcm9tIFwiLi4vLi4vc3luYy9pbnZlbnRvcnlcIjtcclxuLy8gVE9ETzogcmVmYWN0b3IgdGhpcyBvdXRcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IExhc3RJbnZTZXJ2aWNlIH0gZnJvbSBcIi4vbGFzdEludlNlcnZpY2VcIjtcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIEFjdGl2YXRpb25TZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEFjdGl2YXRpb25TZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQWN0aXZhdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImFjdGl2YXRlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkFjdGl2YXRlKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBBY3RpdmF0aW9uU2VydmljZS5wcm90b3R5cGUub25BY3RpdmF0ZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIGxhc3RJbnZTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKExhc3RJbnZTZXJ2aWNlKTtcclxuICAgICAgICBsYXN0SW52U2VydmljZS5sYXN0SW52ID0gZ2V0SW52ZW50b3J5KHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgdmFyIGNhc3RlciA9IGUuY2FzdGVyID8gZS5jYXN0ZXIuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldCA/IGUudGFyZ2V0LmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICBpZiAoIXRhcmdldCB8fCAhY2FzdGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQWN0b3JzIG5ldmVyIGhhdmUgbm9uLWZmIGlkcyBsb2NhbGx5IGluIHNreW1wXHJcbiAgICAgICAgaWYgKGNhc3RlciAhPT0gMHgxNCAmJiBjYXN0ZXIgPCAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGFyZ2V0ID0gbG9jYWxJZFRvUmVtb3RlSWQodGFyZ2V0KTtcclxuICAgICAgICBpZiAoIXRhcmdldCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCAnbG9jYWxJZFRvUmVtb3RlSWQgcmV0dXJuZWQgMCAodGFyZ2V0KSBpbiBvbihcXCdhY3RpdmF0ZVxcJyknKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXN0ZXIgPSBsb2NhbElkVG9SZW1vdGVJZChjYXN0ZXIpO1xyXG4gICAgICAgIGlmICghY2FzdGVyKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsICdsb2NhbElkVG9SZW1vdGVJZCByZXR1cm5lZCAwIChjYXN0ZXIpIGluIG9uKFxcJ2FjdGl2YXRlXFwnKScpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBvcGVuU3RhdGUgPSBlLnRhcmdldC5nZXRPcGVuU3RhdGUoKTtcclxuICAgICAgICBpZiAob3BlblN0YXRlID09PSAyIC8qIE9wZW5TdGF0ZS5PcGVuaW5nICovIHx8IG9wZW5TdGF0ZSA9PT0gNCAvKiBPcGVuU3RhdGUuQ2xvc2luZyAqLykge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIklnbm9yaW5nIGFjdGl2YXRpb24gb2YgZG9vciBiZWNhdXNlIGl0J3MgYWxyZWFkeSBvcGVuaW5nIG9yIGNsb3NpbmdcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5BY3RpdmF0ZSxcclxuICAgICAgICAgICAgICAgIGRhdGE6IHsgY2FzdGVyOiBjYXN0ZXIsIHRhcmdldDogdGFyZ2V0LCBpc1NlY29uZEFjdGl2YXRpb246IGZhbHNlIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VudCBhY3RpdmF0aW9uIGZvciBjYXN0ZXI9XCIsIGNhc3Rlci50b1N0cmluZygxNiksIFwiYW5kIHRhcmdldD1cIiwgdGFyZ2V0LnRvU3RyaW5nKDE2KSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEFjdGl2YXRpb25TZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEFjdGl2YXRpb25TZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBfX2Fzc2lnbiA9ICh0aGlzICYmIHRoaXMuX19hc3NpZ24pIHx8IGZ1bmN0aW9uICgpIHtcclxuICAgIF9fYXNzaWduID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbih0KSB7XHJcbiAgICAgICAgZm9yICh2YXIgcywgaSA9IDEsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7XHJcbiAgICAgICAgICAgIHMgPSBhcmd1bWVudHNbaV07XHJcbiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gcykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSlcclxuICAgICAgICAgICAgICAgIHRbcF0gPSBzW3BdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gX19hc3NpZ24uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxufTtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBzZXRUZXh0U2l6ZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG52YXIgcGxheWVySWQgPSAweDE0O1xyXG52YXIgQW5pbURlYnVnU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhBbmltRGVidWdTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQW5pbURlYnVnU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnNldHRpbmdzID0gX3RoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiYW5pbURlYnVnXCJdO1xyXG4gICAgICAgIC8vIGNsZWFyIHByZXZpb3VzIHRleHRzIGluIGNhc2Ugb2YgaG90cmVsb2FkXHJcbiAgICAgICAgaWYgKF90aGlzLnNwLnN0b3JhZ2VbQW5pbVF1ZXVlQ29sbGVjdGlvbi5OYW1lXSAmJiBfdGhpcy5zcC5zdG9yYWdlW0FuaW1RdWV1ZUNvbGxlY3Rpb24uTmFtZV0uY2xlYXJTUFRleHQpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRGVzdHJveWluZyBvbGQgQW5pbVF1ZXVlQ29sbGVjdGlvblwiKTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbQW5pbVF1ZXVlQ29sbGVjdGlvbi5OYW1lXS5jbGVhclNQVGV4dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJGYWlsZWQgdG8gZGVzdHJveSBvbGQgQW5pbVF1ZXVlQ29sbGVjdGlvbjpcIiwgZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNlbGYgPSBfdGhpcztcclxuICAgICAgICBfdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHsgfSxcclxuICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYub25TZW5kQW5pbWF0aW9uRXZlbnRMZWF2ZShjdHgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgcGxheWVySWQsIHBsYXllcklkKTtcclxuICAgICAgICBpZiAoIV90aGlzLnNldHRpbmdzIHx8ICFfdGhpcy5zZXR0aW5ncy5pc0FjdGl2ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICgoX2EgPSBfdGhpcy5zZXR0aW5ncy50ZXh0T3V0cHV0KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuaXNBY3RpdmUpIHtcclxuICAgICAgICAgICAgX3RoaXMucXVldWUgPSBuZXcgQW5pbVF1ZXVlQ29sbGVjdGlvbihfdGhpcy5zcCwgX3RoaXMuc2V0dGluZ3MpO1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5zdG9yYWdlW0FuaW1RdWV1ZUNvbGxlY3Rpb24ubmFtZV0gPSBfdGhpcy5xdWV1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQW5pbURlYnVnU2VydmljZS5wcm90b3R5cGUub25TZW5kQW5pbWF0aW9uRXZlbnRMZWF2ZSA9IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICBpZiAodGhpcy5xdWV1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKGN0eC5hbmltRXZlbnROYW1lLCBjdHguYW5pbWF0aW9uU3VjY2VlZGVkID8gYW5pbWF0aW9uU3VjY2VlZGVkVGV4dENvbG9yIDogYW5pbWF0aW9uTm90U3VjY2VlZGVkVGV4dENvbG9yKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQW5pbURlYnVnU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBBbmltRGVidWdTZXJ2aWNlIH07XHJcbnZhciBhbmltYXRpb25TdWNjZWVkZWRUZXh0Q29sb3IgPSBbMjU1LCAyNTUsIDI1NSwgMV07XHJcbnZhciBhbmltYXRpb25Ob3RTdWNjZWVkZWRUZXh0Q29sb3IgPSBbMjU1LCAwLCAwLCAxXTtcclxudmFyIEFuaW1RdWV1ZUNvbGxlY3Rpb24gPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBBbmltUXVldWVDb2xsZWN0aW9uKHNwLCBzZXR0aW5ncykge1xyXG4gICAgICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mO1xyXG4gICAgICAgIHRoaXMuc3AgPSBzcDtcclxuICAgICAgICB2YXIgYXJyYXlMZW5ndGggPSAoX2IgPSAoX2EgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MudGV4dE91dHB1dCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLml0ZW1Db3VudCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogNTtcclxuICAgICAgICB2YXIgc3RhcnRQb3MgPSAoX2QgPSAoX2MgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MudGV4dE91dHB1dCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnN0YXJ0UG9zKSAhPT0gbnVsbCAmJiBfZCAhPT0gdm9pZCAwID8gX2QgOiB7IHg6IDY1MCwgeTogNjAwIH07XHJcbiAgICAgICAgO1xyXG4gICAgICAgIHZhciB5UG9zRGVsdGEgPSAoX2YgPSAoX2UgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MudGV4dE91dHB1dCkgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLnlQb3NEZWx0YSkgIT09IG51bGwgJiYgX2YgIT09IHZvaWQgMCA/IF9mIDogMzI7XHJcbiAgICAgICAgdmFyIHkgPSBzdGFydFBvcy55O1xyXG4gICAgICAgIHRoaXMubGlzdCA9IG5ldyBBcnJheShhcnJheUxlbmd0aCk7XHJcbiAgICAgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgYXJyYXlMZW5ndGg7ICsraWR4KSB7XHJcbiAgICAgICAgICAgIHRoaXMubGlzdFtpZHhdID0geyBuYW1lOiBcIlwiLCB0ZXh0SWQ6IHNwLmNyZWF0ZVRleHQoc3RhcnRQb3MueCwgeSwgXCJcIiwgYW5pbWF0aW9uU3VjY2VlZGVkVGV4dENvbG9yKSwgY29sb3I6IGFuaW1hdGlvblN1Y2NlZWRlZFRleHRDb2xvciB9O1xyXG4gICAgICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLmxpc3RbaWR4XS50ZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgICAgIHkgKz0geVBvc0RlbHRhO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIEFuaW1RdWV1ZUNvbGxlY3Rpb24ucHJvdG90eXBlLmNsZWFyU1BUZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKHRoaXMubGlzdC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxpc3QuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgeyByZXR1cm4gX3RoaXMuc3AuZGVzdHJveVRleHQoaXRlbS50ZXh0SWQpOyB9KTtcclxuICAgIH07XHJcbiAgICBBbmltUXVldWVDb2xsZWN0aW9uLnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24gKGFuaW1OYW1lLCBjb2xvcikge1xyXG4gICAgICAgIHZhciBwcmV2SXRlbSA9IG51bGw7XHJcbiAgICAgICAgZm9yICh2YXIgaWR4ID0gdGhpcy5saXN0Lmxlbmd0aCAtIDE7IGlkeCA+PSAwOyAtLWlkeCkge1xyXG4gICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMubGlzdFtpZHhdO1xyXG4gICAgICAgICAgICBwcmV2SXRlbSA9IF9fYXNzaWduKHt9LCBpdGVtKTtcclxuICAgICAgICAgICAgaXRlbS5uYW1lID0gYW5pbU5hbWU7XHJcbiAgICAgICAgICAgIGl0ZW0uY29sb3IgPSBjb2xvcjtcclxuICAgICAgICAgICAgdGhpcy5zcC5zZXRUZXh0U3RyaW5nKGl0ZW0udGV4dElkLCBpdGVtLm5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLnNldFRleHRDb2xvcihpdGVtLnRleHRJZCwgaXRlbS5jb2xvcik7XHJcbiAgICAgICAgICAgIGFuaW1OYW1lID0gcHJldkl0ZW0ubmFtZTtcclxuICAgICAgICAgICAgY29sb3IgPSBwcmV2SXRlbS5jb2xvcjtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQW5pbVF1ZXVlQ29sbGVjdGlvbi5OYW1lID0gXCJBbmltUXVldWVDb2xsZWN0aW9uXCI7XHJcbiAgICByZXR1cm4gQW5pbVF1ZXVlQ29sbGVjdGlvbjtcclxufSgpKTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XHJcbmltcG9ydCB7IGF1dGhHYW1lRGF0YVN0b3JhZ2VLZXkgfSBmcm9tIFwiLi4vLi4vZmVhdHVyZXMvYXV0aE1vZGVsXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgVGltZXJzU2VydmljZSB9IGZyb20gXCIuL3RpbWVyc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgTmV0d29ya2luZ1NlcnZpY2UgfSBmcm9tIFwiLi9uZXR3b3JraW5nU2VydmljZVwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IFNldHRpbmdzU2VydmljZSB9IGZyb20gXCIuL3NldHRpbmdzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlIH0gZnJvbSBcIi4vY2hhcmFjdGVyU2VsZWN0U2VydmljZVwiO1xyXG4vLyBEZWZpbmUgYXMgbW9kdWxlLWxldmVsIHZhcmlhYmxlcyBpbnN0ZWFkIG9mIGdsb2JhbCBkZWNsYXJhdGlvbnNcclxudmFyIHdpbmRvdyA9IGdsb2JhbC53aW5kb3cgfHwgZ2xvYmFsVGhpcy53aW5kb3cgfHwge307XHJcbi8vIENvbnN0YW50cyB1c2VkIG9uIGJvdGggY2xpZW50IGFuZCBicm93c2VyIHNpZGUgKHNlZSBicm93c2Vyc2lkZVdpZGdldFNldHRlcilcclxudmFyIGV2ZW50cyA9IHtcclxuICAgIG9wZW5EaXNjb3JkT2F1dGg6ICdvcGVuRGlzY29yZE9hdXRoJyxcclxuICAgIGF1dGhBdHRlbXB0OiAnYXV0aEF0dGVtcHRFdmVudCcsXHJcbiAgICBvcGVuR2l0aHViOiAnb3BlbkdpdGh1YicsXHJcbiAgICBvcGVuUGF0cmVvbjogJ29wZW5QYXRyZW9uJyxcclxuICAgIGNsZWFyQXV0aERhdGE6ICdjbGVhckF1dGhEYXRhJyxcclxuICAgIHVwZGF0ZVJlcXVpcmVkOiAndXBkYXRlUmVxdWlyZWQnLFxyXG4gICAgYmFja1RvTG9naW46ICdiYWNrVG9Mb2dpbicsXHJcbiAgICBqb2luRGlzY29yZDogJ2pvaW5EaXNjb3JkJyxcclxuICAgIGhpZGVCcm93c2VyOiAnaGlkZUJyb3dzZXInLFxyXG59O1xyXG4vLyBWYWlhYmxlcyB1c2VkIG9uIGJvdGggY2xpZW50IGFuZCBicm93c2VyIHNpZGUgKHNlZSBicm93c2Vyc2lkZVdpZGdldFNldHRlcilcclxudmFyIGJyb3dzZXJTdGF0ZSA9IHtcclxuICAgIGNvbW1lbnQ6ICcnLFxyXG4gICAgZmFpbENvdW50OiA5MDAwLFxyXG4gICAgbG9naW5GYWlsZWRSZWFzb246ICcnLFxyXG59O1xyXG52YXIgYXV0aERhdGEgPSBudWxsO1xyXG52YXIgQXV0aFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQXV0aFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBBdXRoU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5kZW5pZWRXaWRnZXRTZXR0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB3aWRnZXQgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImZvcm1cIixcclxuICAgICAgICAgICAgICAgIGlkOiAyLFxyXG4gICAgICAgICAgICAgICAgY2FwdGlvbjogXCJVcGRhdGUgQXZhaWxhYmxlXCIsXHJcbiAgICAgICAgICAgICAgICBlbGVtZW50czogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFwiaG9vcmF5ISB1cGRhdGUgcmVsZWFzZWRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW11cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFwiZG93bmxvYWQgbm93IGF0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcInNreW1wLm5ldFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcIm9wZW4gc2t5bXAubmV0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtcIkVMRU1FTlRfU1RZTEVfTUFSR0lOX0VYVEVOREVEXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy51cGRhdGVSZXF1aXJlZCk7IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpbnQ6IFwiR28gdG8gZG93bmxvYWQgcGFnZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMuc2V0KFt3aWRnZXRdKTtcclxuICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGdhbWVtb2RlIHdpbGwgbm90IGJlIGFibGUgdG8gdXBkYXRlIHdpZGdldHMgYW55bW9yZVxyXG4gICAgICAgICAgICB3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cyA9IG51bGw7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5sb2dpbkZhaWxlZFdpZGdldFNldHRlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHNwbGl0UGFydHMgPSBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24uc3BsaXQoJ1xcbicpO1xyXG4gICAgICAgICAgICB2YXIgdGV4dEVsZW1lbnRzID0gc3BsaXRQYXJ0cy5tYXAoZnVuY3Rpb24gKHBhcnQpIHsgcmV0dXJuICh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgIHRleHQ6IHBhcnQsXHJcbiAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgfSk7IH0pO1xyXG4gICAgICAgICAgICB2YXIgd2lkZ2V0ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJmb3JtXCIsXHJcbiAgICAgICAgICAgICAgICBpZDogMixcclxuICAgICAgICAgICAgICAgIGNhcHRpb246IFwiRXJyb3JcIixcclxuICAgICAgICAgICAgICAgIGVsZW1lbnRzOiBuZXcgQXJyYXkoKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0ZXh0RWxlbWVudHMuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkgeyByZXR1cm4gd2lkZ2V0LmVsZW1lbnRzLnB1c2goZWxlbWVudCk7IH0pO1xyXG4gICAgICAgICAgICBpZiAoYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID09PSAncGxlYXNlIGpvaW4gdGhlIGRpc2NvcmQgc2VydmVyJykge1xyXG4gICAgICAgICAgICAgICAgd2lkZ2V0LmVsZW1lbnRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJKb2luIFNlcnZlclwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtcIkVMRU1FTlRfU1RZTEVfTUFSR0lOX0VYVEVOREVEXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLmpvaW5EaXNjb3JkKTsgfSxcclxuICAgICAgICAgICAgICAgICAgICBoaW50OiBudWxsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB3aWRnZXQuZWxlbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgdGV4dDogXCJCYWNrXCIsXHJcbiAgICAgICAgICAgICAgICB0YWdzOiBbXCJFTEVNRU5UX1NUWUxFX01BUkdJTl9FWFRFTkRFRFwiXSxcclxuICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLmJhY2tUb0xvZ2luKTsgfSxcclxuICAgICAgICAgICAgICAgIGhpbnQ6IHVuZGVmaW5lZFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKHdpbmRvdy5za3lyaW1QbGF0Zm9ybSAmJiB3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cykge1xyXG4gICAgICAgICAgICAgICAgd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMuc2V0KFt3aWRnZXRdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMubG9naW5XaWRnZXRTZXR0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vIE5vdGU6IGlzQ29ubmVjdGluZyBpcyBpbmplY3RlZCB2aWEgZ2V0VGV4dCgpIHdyYXBwZXJcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSAtIGlzQ29ubmVjdGluZyBpcyBwcm92aWRlZCBieSBGdW5jdGlvbkluZm8uZ2V0VGV4dCgpXHJcbiAgICAgICAgICAgIHZhciBjb25uZWN0aW5nID0gaXNDb25uZWN0aW5nO1xyXG4gICAgICAgICAgICB2YXIgYXV0aERhdGFVc2VybmFtZSA9IGF1dGhEYXRhID8gKGF1dGhEYXRhLmRpc2NvcmRVc2VybmFtZVxyXG4gICAgICAgICAgICAgICAgPyBhdXRoRGF0YS5kaXNjb3JkVXNlcm5hbWVcclxuICAgICAgICAgICAgICAgIDogXCJpZDogXCIuY29uY2F0KGF1dGhEYXRhLm1hc3RlckFwaUlkKSkgOiBcIm5vdCBhdXRob3JpemVkXCI7XHJcbiAgICAgICAgICAgIHZhciBidXR0b25UZXh0ID0gYXV0aERhdGEgPyBcIkNoYW5nZSBBY2NvdW50XCIgOiBcIkxvZ2luIHZpYSBEaXNjb3JkXCI7XHJcbiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhdXRoRGF0YVVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICAvLyBPbmx5IHNob3cgYnV0dG9ucyBpZiBub3QgY29ubmVjdGluZ1xyXG4gICAgICAgICAgICBpZiAoIWNvbm5lY3RpbmcpIHtcclxuICAgICAgICAgICAgICAgIGVsZW1lbnRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogYnV0dG9uVGV4dCxcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXCJFTEVNRU5UX1NUWUxFX01BUkdJTl9FWFRFTkRFRFwiXSxcclxuICAgICAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy5vcGVuRGlzY29yZE9hdXRoKTsgfSxcclxuICAgICAgICAgICAgICAgICAgICBoaW50OiBcIllvdSBjYW4gbG9naW4gb3IgY2hhbmdlIGFjY291bnRcIixcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgZWxlbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcIkNvbm5lY3RcIixcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXCJCVVRUT05fU1RZTEVfRlJBTUVcIiwgXCJFTEVNRU5UX1NUWUxFX01BUkdJTl9FWFRFTkRFRFwiXSxcclxuICAgICAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy5hdXRoQXR0ZW1wdCk7IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaGludDogXCJDb25uZWN0IHRvIGdhbWUgc2VydmVyXCIsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBBbHdheXMgc2hvdyBzdGF0dXMgdGV4dFxyXG4gICAgICAgICAgICBlbGVtZW50cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgdGV4dDogYnJvd3NlclN0YXRlLmNvbW1lbnQsXHJcbiAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHZhciBsb2dpbldpZGdldCA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwiZm9ybVwiLFxyXG4gICAgICAgICAgICAgICAgaWQ6IDEsXHJcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIkF1dGhlbnRpY2F0aW9uXCIsXHJcbiAgICAgICAgICAgICAgICBlbGVtZW50czogZWxlbWVudHNcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMuc2V0KFtsb2dpbldpZGdldF0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMuYnJvd3NlcnNpZGVXaWRnZXRTZXR0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBsb2dpbldpZGdldCA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwiZm9ybVwiLFxyXG4gICAgICAgICAgICAgICAgaWQ6IDEsXHJcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIkF1dGhlbnRpY2F0aW9uXCIsXHJcbiAgICAgICAgICAgICAgICBlbGVtZW50czogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IChhdXRoRGF0YSA/IChhdXRoRGF0YS5kaXNjb3JkVXNlcm5hbWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gXCJcIi5jb25jYXQoYXV0aERhdGEuZGlzY29yZFVzZXJuYW1lKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBcImlkOiBcIi5jb25jYXQoYXV0aERhdGEubWFzdGVyQXBpSWQpKSA6IFwibm90IGF1dGhvcml6ZWRcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhdXRoRGF0YSA/IFwiQ2hhbmdlIEFjY291bnRcIiA6IFwiTG9naW4gdmlhIERpc2NvcmRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLm9wZW5EaXNjb3JkT2F1dGgpOyB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoaW50OiBcIllvdSBjYW4gbG9naW4gb3IgY2hhbmdlIGFjY291bnRcIixcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJDb25uZWN0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtcIkJVVFRPTl9TVFlMRV9GUkFNRVwiLCBcIkVMRU1FTlRfU1RZTEVfTUFSR0lOX0VYVEVOREVEXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy5hdXRoQXR0ZW1wdCk7IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpbnQ6IFwiQ29ubmVjdCB0byBnYW1lIHNlcnZlclwiLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogYnJvd3NlclN0YXRlLmNvbW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzLnNldChbbG9naW5XaWRnZXRdKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLl9pc0xpc3RlbkJyb3dzZXJNZXNzYWdlID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMudHJpZ2dlciA9IHtcclxuICAgICAgICAgICAgYXV0aE5lZWRlZEZpcmVkOiBmYWxzZSxcclxuICAgICAgICAgICAgYnJvd3NlcldpbmRvd0xvYWRlZEZpcmVkOiBmYWxzZSxcclxuICAgICAgICAgICAgZ2V0IGNvbmRpdGlvbk1ldCgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhOZWVkZWRGaXJlZCAmJiB0aGlzLmJyb3dzZXJXaW5kb3dMb2FkZWRGaXJlZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMuZGlzY29yZEF1dGhTdGF0ZSA9IGNyeXB0by5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xyXG4gICAgICAgIF90aGlzLmF1dGhEaWFsb2dPcGVuID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICBfdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvckNvdW50ZXIgPSAwO1xyXG4gICAgICAgIF90aGlzLmxhc3RTbG93Q291bnRlciA9IC0xO1xyXG4gICAgICAgIF90aGlzLnBsYXllckV2ZXJTYXdBY3R1YWxHYW1lcGxheSA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmdpdGh1YlVybCA9IFwiaHR0cHM6Ly9naXRodWIuY29tL0JTdGFyUlAvc2t5bXBcIjtcclxuICAgICAgICBfdGhpcy5wYXRyZW9uVXJsID0gXCJodHRwczovL3d3dy5wYXRyZW9uLmNvbS9jL2JydWluc3RhclwiO1xyXG4gICAgICAgIF90aGlzLmRpc2NvcmRVcmwgPSBcImh0dHBzOi8vZGlzY29yZC5nZy9ic3RhcnJwXCI7XHJcbiAgICAgICAgX3RoaXMucGx1Z2luQXV0aERhdGFOYW1lID0gXCJhdXRoLWRhdGEtbm8tbG9hZFwiO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImF1dGhOZWVkZWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQXV0aE5lZWRlZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiYnJvd3NlcldpbmRvd0xvYWRlZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Ccm93c2VyV2luZG93TG9hZGVkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3JlYXRlQWN0b3JNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjb25uZWN0aW9uQWNjZXB0ZWRcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuaGFuZGxlQ29ubmVjdGlvbkFjY2VwdGVkKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNvbm5lY3Rpb25EZW5pZWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLmhhbmRsZUNvbm5lY3Rpb25EZW5pZWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImN1c3RvbVBhY2tldE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3VzdG9tUGFja2V0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImJyb3dzZXJNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkJyb3dzZXJNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblRpY2soKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQXV0aE5lZWRlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBhdXRoTmVlZGVkIGV2ZW50XCIpO1xyXG4gICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ2F1dGhOZWVkZWQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAvLyBUcnkgdG8gcmVhZCBhdXRoIGRhdGEgZnJvbSBkaXNrIGZpcnN0XHJcbiAgICAgICAgYXV0aERhdGEgPSB0aGlzLnJlYWRBdXRoRGF0YUZyb21EaXNrKCk7XHJcbiAgICAgICAgLy8gSWYgbm8gYXV0aCBmaWxlIGV4aXN0cywgY2hlY2sgZm9yIG9mZmxpbmUgbW9kZSBzZXR0aW5nc1xyXG4gICAgICAgIGlmICghYXV0aERhdGEpIHtcclxuICAgICAgICAgICAgdmFyIHNldHRpbmdzR2FtZURhdGEgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImdhbWVEYXRhXCJdO1xyXG4gICAgICAgICAgICB2YXIgaGFzT2ZmbGluZVNldHRpbmdzID0gTnVtYmVyLmlzSW50ZWdlcihzZXR0aW5nc0dhbWVEYXRhID09PSBudWxsIHx8IHNldHRpbmdzR2FtZURhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzR2FtZURhdGEucHJvZmlsZUlkKTtcclxuICAgICAgICAgICAgaWYgKGhhc09mZmxpbmVTZXR0aW5ncykge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJObyBhdXRoIGZpbGUgZm91bmQsIHVzaW5nIG9mZmxpbmUgbW9kZSBmcm9tIHNldHRpbmdzIHdpdGggcHJvZmlsZUlkOlwiLCBzZXR0aW5nc0dhbWVEYXRhLnByb2ZpbGVJZCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYXV0aEF0dGVtcHRcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgIGF1dGhHYW1lRGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZmlsZUlkOiBzZXR0aW5nc0dhbWVEYXRhLnByb2ZpbGVJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc1Rva2VuOiBzZXR0aW5nc0dhbWVEYXRhLmFjY2Vzc1Rva2VuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBBdXRoIGZpbGUgZXhpc3RzIG9yIG5vIG9mZmxpbmUgc2V0dGluZ3MgLSBzaG93IGxvZ2luIG1lbnVcclxuICAgICAgICBpZiAoYXV0aERhdGEpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJBdXRoIGZpbGUgZm91bmQsIHNob3dpbmcgbG9naW4gbWVudSB3aXRoIGV4aXN0aW5nIGF1dGggZGF0YVwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTm8gYXV0aCBmaWxlIGFuZCBubyBvZmZsaW5lIHNldHRpbmdzLCBzaG93aW5nIGxvZ2luIG1lbnVcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ3JlZ3VsYXIgYXV0aCBuZWVkZWQnKTtcclxuICAgICAgICAvLyBTaG93IGJyb3dzZXIgYW5kIGxvYWQgdGhlIFVJXHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICAgICAgLy8gVHJ5IHRvIGxvYWQgdGhlIFVJIGV4cGxpY2l0bHlcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIubG9hZFVybChcImZpbGU6Ly8vRGF0YS9QbGF0Zm9ybS9VSS9pbmRleC5odG1sXCIpO1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkF0dGVtcHRlZCB0byBsb2FkIFVJIGZyb20gZmlsZTovLy9EYXRhL1BsYXRmb3JtL1VJL2luZGV4Lmh0bWxcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRmFpbGVkIHRvIGxvYWQgVUk6XCIsIGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBTZXQgdHJpZ2dlciBmbGFnIGFuZCB3YWl0IGZvciBicm93c2VyIHRvIGxvYWRcclxuICAgICAgICB0aGlzLnRyaWdnZXIuYXV0aE5lZWRlZEZpcmVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLm9uQnJvd3NlcldpbmRvd0xvYWRlZEFuZE9ubGluZUF1dGhOZWVkZWQoKTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25Ccm93c2VyV2luZG93TG9hZGVkU2hvd1N0YXJ0V2luZG93ID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICAgICAgYXV0aERhdGEgPSBkYXRhO1xyXG4gICAgICAgIChfYSA9IHRoaXMuc3AuYnJvd3NlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmV4ZWN1dGVKYXZhU2NyaXB0KFwid2luZG93Py51c2VNZW51U3RvcmU/LmdldFN0YXRlKCkub25TdGFydChcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkoZGF0YSksIFwiKVwiKSk7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQnJvd3NlcldpbmRvd0xvYWRlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBicm93c2VyV2luZG93TG9hZGVkIGV2ZW50XCIpO1xyXG4gICAgICAgIHRoaXMudHJpZ2dlci5icm93c2VyV2luZG93TG9hZGVkRmlyZWQgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMub25Ccm93c2VyV2luZG93TG9hZGVkQW5kT25saW5lQXV0aE5lZWRlZCgpO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkNyZWF0ZUFjdG9yTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKGUubWVzc2FnZS5pc01lKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmF1dGhEaWFsb2dPcGVuKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGNyZWF0ZUFjdG9yTWVzc2FnZSBmb3Igc2VsZiwgcmVzZXR0aW5nIHdpZGdldHNcIik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoJ3dpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzLnNldChbXSk7Jyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhEaWFsb2dPcGVuID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGNyZWF0ZUFjdG9yTWVzc2FnZSBmb3Igc2VsZiwgYnV0IGF1dGggZGlhbG9nIHdhcyBub3Qgb3BlbiBzbyBub3QgcmVzZXR0aW5nIHdpZGdldHNcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkN1c3RvbVBhY2tldE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgbXNnQ29udGVudCA9IHt9O1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIG1zZ0NvbnRlbnQgPSBKU09OLnBhcnNlKG1zZy5jb250ZW50SnNvbkR1bXApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uQ3VzdG9tUGFja2V0TWVzc2FnZSBmYWlsZWQgdG8gcGFyc2UgSlNPTlwiLCBlLm1lc3NhZ2UsIFwianNvbjpcIiwgbXNnLmNvbnRlbnRKc29uRHVtcCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN3aXRjaCAobXNnQ29udGVudFtcImN1c3RvbVBhY2tldFR5cGVcIl0pIHtcclxuICAgICAgICAgICAgLy8gY2FzZSAnbG9naW5SZXF1aXJlZCc6XHJcbiAgICAgICAgICAgIC8vICAgbG9nVHJhY2UodGhpcywgJ2xvZ2luUmVxdWlyZWQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgLy8gICB0aGlzLmxvZ2luV2l0aFNreW1wSW9DcmVkZW50aWFscygpO1xyXG4gICAgICAgICAgICAvLyAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdsb2dpbkZhaWxlZE5vdExvZ2dlZFZpYURpc2NvcmQnOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnbG9naW5GYWlsZWROb3RMb2dnZWRWaWFEaXNjb3JkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAncGxlYXNlIGxvZ2luIHZpYSBkaXNjb3JkJztcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdsb2dpbkZhaWxlZE5vdExvZ2dlZFZpYURpc2NvcmQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdsb2dpbkZhaWxlZE5vdEluVGhlRGlzY29yZFNlcnZlcic6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdsb2dpbkZhaWxlZE5vdEluVGhlRGlzY29yZFNlcnZlciByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJ3BsZWFzZSBqb2luIHRoZSBkaXNjb3JkIHNlcnZlcic7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAnbG9naW5GYWlsZWROb3RJblRoZURpc2NvcmRTZXJ2ZXIgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdsb2dpbkZhaWxlZEJhbm5lZCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdsb2dpbkZhaWxlZEJhbm5lZCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJ3lvdSBhcmUgYmFubmVkJztcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdsb2dpbkZhaWxlZEJhbm5lZCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xvZ2luRmFpbGVkSXBNaXNtYXRjaCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdsb2dpbkZhaWxlZElwTWlzbWF0Y2ggcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICd3aGF0IHdhcyB0aGF0Pyc7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAnbG9naW5GYWlsZWRJcE1pc21hdGNoIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQnJvd3NlcldpbmRvd0xvYWRlZEFuZE9ubGluZUF1dGhOZWVkZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoIXRoaXMuaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcImlzTGlzdGVuQnJvd3Nlck1lc3NhZ2Ugd2FzIGZhbHNlIGZvciBzb21lIHJlYXNvbiwgYWJvcnRpbmcgYXV0aFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMudHJpZ2dlci5jb25kaXRpb25NZXQpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbkJyb3dzZXJXaW5kb3dMb2FkZWRBbmRPbmxpbmVBdXRoTmVlZGVkIHdhaXRpbmcgZm9yIGJvdGggdHJpZ2dlcnMgdG8gbG9hZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNob3dpbmcgd2lkZ2V0cyBhbmQgc3RhcnRpbmcgbG9vcFwiKTtcclxuICAgICAgICAvLyBNYWtlIHN1cmUgYXV0aCBkYXRhIGlzIGxvYWRlZFxyXG4gICAgICAgIGlmICghYXV0aERhdGEpIHtcclxuICAgICAgICAgICAgYXV0aERhdGEgPSB0aGlzLnJlYWRBdXRoRGF0YUZyb21EaXNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgICAgIC8vIERlbGF5IGluaXRpYWwgc3RhdGUgaW5qZWN0aW9uIHRvIGVuc3VyZSBSZWFjdCBpcyBtb3VudGVkXHJcbiAgICAgICAgdmFyIHRpbWVyc1NlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoVGltZXJzU2VydmljZSk7XHJcbiAgICAgICAgdGltZXJzU2VydmljZS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsICdTZW5kaW5nIGluaXRpYWwgYXV0aCBzdGF0ZSB0byBSZWFjdCBVSScpO1xyXG4gICAgICAgICAgICBfdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgIH0sIDUwMCk7XHJcbiAgICAgICAgLy8gU3RhcnQgRGlzY29yZCBPQXV0aCBsb2dpbiBzdGF0ZSBjaGVja2luZyBsb29wXHJcbiAgICAgICAgdGhpcy5jaGVja0xvZ2luU3RhdGUoKTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25Ccm93c2VyTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzTGlzdGVuQnJvd3Nlck1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbkJyb3dzZXJNZXNzYWdlOiBpc0xpc3RlbkJyb3dzZXJNZXNzYWdlIHdhcyBmYWxzZSwgaWdub3JpbmcgbWVzc2FnZVwiLCBKU09OLnN0cmluZ2lmeShlLmFyZ3VtZW50cykpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzZXR0aW5nc1NlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2V0dGluZ3NTZXJ2aWNlKTtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uQnJvd3Nlck1lc3NhZ2U6XCIsIEpTT04uc3RyaW5naWZ5KGUuYXJndW1lbnRzKSk7XHJcbiAgICAgICAgdmFyIGV2ZW50S2V5ID0gZS5hcmd1bWVudHNbMF07XHJcbiAgICAgICAgc3dpdGNoIChldmVudEtleSkge1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5vcGVuRGlzY29yZE9hdXRoOlxyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvcGVuRGlzY29yZE9hdXRoIGV2ZW50IHJlY2VpdmVkLCBvcGVuaW5nIGJyb3dzZXJcIik7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICdvcGVuaW5nIGJyb3dzZXIuLi4nO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHNldHRpbmdzU2VydmljZV8xID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNldHRpbmdzU2VydmljZSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgZGlzY29yZEF1dGhCYXNlVXJsID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJkaXNjb3JkLWF1dGgtdXJsXCJdIHx8IFwiaHR0cDovL2xvY2FsaG9zdDpcIi5jb25jYXQodGhpcy5nZXRTZXJ2ZXJQb3J0KCkpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRpc2NvcmRBdXRoVXJsID0gXCJcIi5jb25jYXQoZGlzY29yZEF1dGhCYXNlVXJsLCBcIi9hcGkvdXNlcnMvbG9naW4tZGlzY29yZD9zdGF0ZT1cIikuY29uY2F0KHRoaXMuZGlzY29yZEF1dGhTdGF0ZSk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkxvYWRpbmcgRGlzY29yZCBPQXV0aCBVUkw6XCIsIGRpc2NvcmRBdXRoVXJsKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwid2luMzIgb2JqZWN0OlwiLCB0aGlzLnNwLndpbjMyKTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcC53aW4zMi5sb2FkVXJsKGRpc2NvcmRBdXRoVXJsKTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIndpbjMyLmxvYWRVcmwgY2FsbGVkIHN1Y2Nlc3NmdWxseVwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRmFpbGVkIHRvIGNhbGwgd2luMzIubG9hZFVybDpcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gTGF1bmNoIGNoZWNrTG9naW5TdGF0ZSBsb29wXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrTG9naW5TdGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmF1dGhBdHRlbXB0OlxyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJhdXRoQXR0ZW1wdCBldmVudCByZWNlaXZlZCAoQ29ubmVjdCBidXR0b24gY2xpY2tlZClcIik7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkN1cnJlbnQgYXV0aERhdGE6XCIsIGF1dGhEYXRhKTtcclxuICAgICAgICAgICAgICAgIGlmIChhdXRoRGF0YSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiYXV0aERhdGEgaXMgbnVsbCwgY2Fubm90IGNvbm5lY3RcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAncGxlYXNlIGxvZ2luIGZpcnN0JztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkVtaXR0aW5nIGF1dGhBdHRlbXB0IGV2ZW50IHdpdGggYXV0aERhdGE6XCIsIEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKSk7XHJcbiAgICAgICAgICAgICAgICAvLyBFbWl0IGF1dGhBdHRlbXB0IGV2ZW50IHRvIHRyaWdnZXIgY29ubmVjdGlvblxyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImF1dGhBdHRlbXB0XCIsIHsgYXV0aEdhbWVEYXRhOiB7IHJlbW90ZTogYXV0aERhdGEgfSB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuY2xlYXJBdXRoRGF0YTpcclxuICAgICAgICAgICAgICAgIC8vIERvZXNuJ3Qgc2VlbSB0byBiZSB1c2VkIC0gbGF1bmNoZXIgbWFuYWdlcyBhdXRoIGRhdGFcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5vcGVuR2l0aHViOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC53aW4zMi5sb2FkVXJsKHRoaXMuZ2l0aHViVXJsKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5vcGVuUGF0cmVvbjpcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Aud2luMzIubG9hZFVybCh0aGlzLnBhdHJlb25VcmwpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLnVwZGF0ZVJlcXVpcmVkOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC53aW4zMi5sb2FkVXJsKFwiaHR0cHM6Ly9za3ltcC5uZXQvVXBkSW5zdGFsbFwiKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5iYWNrVG9Mb2dpbjpcclxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHVzZXIgbWFudWFsbHkgd2VudCBiYWNrIGZyb20gY2hhcmFjdGVyIHNlbGVjdFxyXG4gICAgICAgICAgICAgICAgdmFyIGNoYXJhY3RlclNlbGVjdFNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoQ2hhcmFjdGVyU2VsZWN0U2VydmljZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hhcmFjdGVyU2VsZWN0U2VydmljZSAmJiBjaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnJlc2V0QXV0aFN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1VzZXIgbWFudWFsbHkgd2VudCBiYWNrIGZyb20gY2hhcmFjdGVyIHNlbGVjdCwgcmVzZXR0aW5nIGF1dGggc3RhdGUnKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBSZXNldCBmbGFnXHJcbiAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVyU2VsZWN0U2VydmljZS5yZXNldEF1dGhTdGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIHByb2dyZXNzIGluZGljYXRvciB0byBwcmV2ZW50IGF1dG8tY29ubmVjdFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGxvZ2dpbmcgc3RhcnQgbW9tZW50XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGFueSBlcnJvciBtZXNzYWdlc1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBSZWxvYWQgYXV0aCBkYXRhIGZyb20gZGlzayBzbyB1c2VyIHNlZXMgdGhlaXIgcHJldmlvdXMgYWNjb3VudCBpbmZvXHJcbiAgICAgICAgICAgICAgICBhdXRoRGF0YSA9IHRoaXMucmVhZEF1dGhEYXRhRnJvbURpc2soKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdSZWxvYWRlZCBhdXRoIGRhdGEgYWZ0ZXIgQmFjayBidXR0b24gcHJlc3NlZDonLCBhdXRoRGF0YSA/ICdmb3VuZCcgOiAnbm90IGZvdW5kJyk7XHJcbiAgICAgICAgICAgICAgICAvLyBSZWZyZXNoIHRoZSBSZWFjdCBVSSB3aXRoIHVwZGF0ZWQgYXV0aCBzdGF0ZVxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmpvaW5EaXNjb3JkOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC53aW4zMi5sb2FkVXJsKHRoaXMuZGlzY29yZFVybCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuaGlkZUJyb3dzZXI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAncmVxdWVzdEF1dGhTdGF0ZSc6XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUmVhY3QgVUkgcmVxdWVzdGluZyBhdXRoIHN0YXRlLCBzZW5kaW5nIGN1cnJlbnQgc3RhdGUnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJVbmtub3duIGV2ZW50IGtleVwiLCBldmVudEtleSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLmNyZWF0ZVBsYXlTZXNzaW9uID0gZnVuY3Rpb24gKHRva2VuLCBjYWxsYmFjaykge1xyXG4gICAgICAgIHZhciBjbGllbnQgPSBuZXcgdGhpcy5zcC5IdHRwQ2xpZW50KFwiaHR0cDovL2xvY2FsaG9zdDpcIi5jb25jYXQodGhpcy5nZXRTZXJ2ZXJQb3J0KCkpKTtcclxuICAgICAgICB2YXIgcm91dGUgPSBcIi9hcGkvdXNlcnMvbWUvcGxheS9tYWluXCI7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDcmVhdGluZyBwbGF5IHNlc3Npb24gXCIuY29uY2F0KHJvdXRlKSk7XHJcbiAgICAgICAgY2xpZW50LnBvc3Qocm91dGUsIHtcclxuICAgICAgICAgICAgYm9keTogJ3t9JyxcclxuICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAgICAgJ2F1dGhvcml6YXRpb24nOiBcIkJlYXJlciBcIi5jb25jYXQodG9rZW4pLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgfSwgZnVuY3Rpb24gKHJlcykge1xyXG4gICAgICAgICAgICBpZiAocmVzLnN0YXR1cyAhPSAyMDApIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCcnLCAnc3RhdHVzIGNvZGUgJyArIHJlcy5zdGF0dXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogaGFuZGxlIEpTT04ucGFyc2UgZmFpbHVyZT9cclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKEpTT04ucGFyc2UocmVzLmJvZHkpLnNlc3Npb24sICcnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5jaGVja0xvZ2luU3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoIXRoaXMuaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcImNoZWNrTG9naW5TdGF0ZTogaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSB3YXMgZmFsc2UsIGFib3J0aW5nIGNoZWNrXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0aW1lcnNTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFRpbWVyc1NlcnZpY2UpO1xyXG4gICAgICAgIC8vIFNvY2lhbCBlbmdpbmVlcmluZyBwcm90ZWN0aW9uLCBkb24ndCBzaG93IHRoZSBmdWxsIHN0YXRlXHJcbiAgICAgICAgdmFyIGhhbGZEaXNjb3JkQXV0aFN0YXRlID0gdGhpcy5kaXNjb3JkQXV0aFN0YXRlLnNsaWNlKDAsIDE2KTtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNoZWNraW5nIGxvZ2luIHN0YXRlXCIsIGhhbGZEaXNjb3JkQXV0aFN0YXRlLCAnLi4uJyk7XHJcbiAgICAgICAgbmV3IHRoaXMuc3AuSHR0cENsaWVudChcImh0dHA6Ly9sb2NhbGhvc3Q6XCIuY29uY2F0KHRoaXMuZ2V0U2VydmVyUG9ydCgpKSlcclxuICAgICAgICAgICAgLmdldChcIi9hcGkvdXNlcnMvbG9naW4tZGlzY29yZC9zdGF0dXM/c3RhdGU9XCIgKyB0aGlzLmRpc2NvcmRBdXRoU3RhdGUsIHVuZGVmaW5lZCwgXHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHJlc3BvbnNlLnN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAyMDA6XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KSwgdG9rZW4gPSBfYS50b2tlbiwgbWFzdGVyQXBpSWRfMSA9IF9hLm1hc3RlckFwaUlkLCBkaXNjb3JkVXNlcm5hbWVfMSA9IF9hLmRpc2NvcmRVc2VybmFtZSwgZGlzY29yZERpc2NyaW1pbmF0b3JfMSA9IF9hLmRpc2NvcmREaXNjcmltaW5hdG9yLCBkaXNjb3JkQXZhdGFyXzEgPSBfYS5kaXNjb3JkQXZhdGFyO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5mYWlsQ291bnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNyZWF0ZVBsYXlTZXNzaW9uKHRva2VuLCBmdW5jdGlvbiAocGxheVNlc3Npb24sIGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmZhaWxDb3VudCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9IChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lcnNTZXJ2aWNlLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuY2hlY2tMb2dpblN0YXRlKCk7IH0sIE1hdGguZmxvb3IoKDEuNSArIE1hdGgucmFuZG9tKCkgKiAyKSAqIDEwMDApKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0aERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uOiBwbGF5U2Vzc2lvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hc3RlckFwaUlkOiBtYXN0ZXJBcGlJZF8xLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29yZFVzZXJuYW1lOiBkaXNjb3JkVXNlcm5hbWVfMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvcmREaXNjcmltaW5hdG9yOiBkaXNjb3JkRGlzY3JpbWluYXRvcl8xLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29yZEF2YXRhcjogZGlzY29yZEF2YXRhcl8xLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJEaXNjb3JkIGF1dGggc3VjY2Vzc2Z1bCwgYXV0aERhdGEgc2V0OlwiLCBKU09OLnN0cmluZ2lmeShhdXRoRGF0YSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICdjb25uZWN0ZWQgc3VjY2Vzc2Z1bGx5JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDAxOiAvLyBVbmF1dGhvcml6ZWRcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuZmFpbENvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICcnOyAvLyhgU3RpbGwgd2FpdGluZy4uLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVyc1NlcnZpY2Uuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5jaGVja0xvZ2luU3RhdGUoKTsgfSwgTWF0aC5mbG9vcigoMS41ICsgTWF0aC5yYW5kb20oKSAqIDIpICogMTAwMCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA0MDM6IC8vIEZvcmJpZGRlblxyXG4gICAgICAgICAgICAgICAgY2FzZSA0MDQ6IC8vIE5vdCBmb3VuZFxyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5mYWlsQ291bnQgPSA5MDAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gKFwiRmFpbDogXCIuY29uY2F0KHJlc3BvbnNlLmJvZHkpKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgKyticm93c2VyU3RhdGUuZmFpbENvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gXCJTZXJ2ZXIgcmV0dXJuZWQgXCIuY29uY2F0KHJlc3BvbnNlLnN0YXR1cy50b1N0cmluZygpIHx8IFwiPz8/XCIsIFwiIFxcXCJcIikuY29uY2F0KHJlc3BvbnNlLmJvZHkgfHwgcmVzcG9uc2UuZXJyb3IsIFwiXFxcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICB0aW1lcnNTZXJ2aWNlLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuY2hlY2tMb2dpblN0YXRlKCk7IH0sIE1hdGguZmxvb3IoKDEuNSArIE1hdGgucmFuZG9tKCkgKiAyKSAqIDEwMDApKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5yZWZyZXNoV2lkZ2V0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCAncmVmcmVzaEF1dGhVSSBjYWxsZWQnKTtcclxuICAgICAgICAvLyBJbmplY3QgYXV0aCBzdGF0ZSBpbnRvIHdpbmRvdyBmb3IgUmVhY3QgVUlcclxuICAgICAgICB2YXIgYXV0aFN0YXRlID0ge1xyXG4gICAgICAgICAgICBhdXRoRGF0YTogYXV0aERhdGEsXHJcbiAgICAgICAgICAgIGNvbW1lbnQ6IGJyb3dzZXJTdGF0ZS5jb21tZW50LFxyXG4gICAgICAgICAgICBsb2dpbkZhaWxlZFJlYXNvbjogYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uLFxyXG4gICAgICAgICAgICBpc0Nvbm5lY3Rpbmc6IHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvclxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdmFyIGluamVjdFNjcmlwdCA9IFwiXFxuICAgICAgd2luZG93LnNreW1wID0gd2luZG93LnNreW1wIHx8IHt9O1xcbiAgICAgIHdpbmRvdy5za3ltcC5hdXRoID0gXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGF1dGhTdGF0ZSksIFwiO1xcbiAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA6YXV0aFVwZGF0ZScsIHsgZGV0YWlsOiBcIikuY29uY2F0KEpTT04uc3RyaW5naWZ5KGF1dGhTdGF0ZSksIFwiIH0pKTtcXG4gICAgXCIpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChpbmplY3RTY3JpcHQpO1xyXG4gICAgICAgIHRoaXMuYXV0aERpYWxvZ09wZW4gPSB0cnVlO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5yZWFkQXV0aERhdGFGcm9tRGlzayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlYWRpbmdcIiwgdGhpcy5wbHVnaW5BdXRoRGF0YU5hbWUsIFwiZnJvbSBkaXNrXCIpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5zcC5nZXRQbHVnaW5Tb3VyY2VDb2RlKHRoaXMucGx1Z2luQXV0aERhdGFOYW1lLCBcIlBsdWdpbnNOb0xvYWRcIik7XHJcbiAgICAgICAgICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWFkIGVtcHR5XCIsIHRoaXMucGx1Z2luQXV0aERhdGFOYW1lLCBcInJldHVybmluZyBudWxsXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YS5zbGljZSgyKSkgfHwgbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJFcnJvciByZWFkaW5nXCIsIHRoaXMucGx1Z2luQXV0aERhdGFOYW1lLCBcImZyb20gZGlzazpcIiwgZSwgXCIsIGZhbGxpbmcgYmFjayB0byBudWxsXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLndyaXRlQXV0aERhdGFUb0Rpc2sgPSBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIC8vIEF1dGggZGF0YSB3cml0aW5nIGlzIGhhbmRsZWQgYnkgdGhlIGxhdW5jaGVyLCBjbGllbnQgb25seSByZWFkc1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQXV0aCBkYXRhIHdyaXRpbmcgZGlzYWJsZWQgLSBsYXVuY2hlciBtYW5hZ2VzIGF1dGggZGF0YVwiKTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuaGFuZGxlQ29ubmVjdGlvbkRlbmllZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICBpZiAoZS5lcnJvci50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFwiaW52YWxpZCBwYXNzd29yZFwiKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICdpbnZhbGlkIHBhc3N3b3JkJztcclxuICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZGlzYWJsZVBsYXllckNvbnRyb2xzKHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIDApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAnY29ubmVjdGlvbkRlbmllZCBldmVudCByZWNlaXZlZCcpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuaGFuZGxlQ29ubmVjdGlvbkFjY2VwdGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiaGFuZGxlQ29ubmVjdGlvbkFjY2VwdGVkIGNhbGxlZFwiKTtcclxuICAgICAgICAvLyBLZWVwIGJyb3dzZXIgbWVzc2FnZSBsaXN0ZW5lciBhY3RpdmUgc28gdXNlciBjYW4gc3RpbGwgaW50ZXJhY3Qgd2l0aCBhdXRoIG1lbnVcclxuICAgICAgICAvLyB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKGZhbHNlLCAnY29ubmVjdGlvbkFjY2VwdGVkIGV2ZW50IHJlY2VpdmVkJyk7XHJcbiAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHZhciBhdXRoRGF0YSA9IHRoaXMuc3Auc3RvcmFnZVthdXRoR2FtZURhdGFTdG9yYWdlS2V5XTtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkF1dGggZGF0YSBmcm9tIHN0b3JhZ2U6XCIsIEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKSk7XHJcbiAgICAgICAgaWYgKGF1dGhEYXRhID09PSBudWxsIHx8IGF1dGhEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoRGF0YS5sb2NhbCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkxvZ2dpbmcgaW4gb2ZmbGluZSBtb2RlLCBwcm9maWxlSWQgPVwiLCBhdXRoRGF0YS5sb2NhbC5wcm9maWxlSWQpO1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tUGFja2V0LFxyXG4gICAgICAgICAgICAgICAgY29udGVudEpzb25EdW1wOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tUGFja2V0VHlwZTogJ2xvZ2luV2l0aFNreW1wSW8nLFxyXG4gICAgICAgICAgICAgICAgICAgIGdhbWVEYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGVJZDogYXV0aERhdGEubG9jYWwucHJvZmlsZUlkLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhdXRoRGF0YSA9PT0gbnVsbCB8fCBhdXRoRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aERhdGEucmVtb3RlKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdMb2dnaW5nIGluIGFzIGEgbWFzdGVyIEFQSSB1c2VyJyk7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21QYWNrZXQsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50SnNvbkR1bXA6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21QYWNrZXRUeXBlOiAnbG9naW5XaXRoU2t5bXBJbycsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2FtZURhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbjogYXV0aERhdGEucmVtb3RlLnNlc3Npb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hc3RlckFwaUlkOiBhdXRoRGF0YS5yZW1vdGUubWFzdGVyQXBpSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvcmRVc2VybmFtZTogYXV0aERhdGEucmVtb3RlLmRpc2NvcmRVc2VybmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29yZERpc2NyaW1pbmF0b3I6IGF1dGhEYXRhLnJlbW90ZS5kaXNjb3JkRGlzY3JpbWluYXRvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29yZEF2YXRhcjogYXV0aERhdGEucmVtb3RlLmRpc2NvcmRBdmF0YXIsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9nRXJyb3IodGhpcywgJ05vdCBmb3VuZCBhdXRoZW50aWNhdGlvbiBtZXRob2QnKTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25UaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIFRPRE86IFNob3VsZCBiZSBubyBoYXJkY29kZWQvbWFnaWMtbnVtYmVyIGxpbWl0XHJcbiAgICAgICAgLy8gVE9ETzogQnVzeSB3YWl0aW5nIGlzIGJhZC4gU2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggc29tZSBraW5kIG9mIGV2ZW50XHJcbiAgICAgICAgdmFyIG1heExvZ2dpbmdEZWxheSA9IDE1MDAwO1xyXG4gICAgICAgIGlmICh0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCAmJiBEYXRlLm5vdygpIC0gdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPiBtYXhMb2dnaW5nRGVsYXkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ01heCBsb2dnaW5nIGRlbGF5IHJlYWNoZWQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMucGxheWVyRXZlclNhd0FjdHVhbEdhbWVwbGF5KSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUGxheWVyIHNhdyBhY3R1YWwgZ2FtZXBsYXksIHJlY29ubmVjdGluZycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5yZWNvbm5lY3QoKTtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IHNob3VsZCB3ZSBwcm9tcHQgdXNlciB0byByZWxvZ2luP1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1BsYXllciBuZXZlciBzYXcgYWN0dWFsIGdhbWVwbGF5LCBzaG93aW5nIGxvZ2luIGRpYWxvZycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAndGVjaG5pY2FsIGRpZmZpY3VsdGllc1xcbnBsZWFzZSB0cnkgYWdhaW5cXG5vciBjb250YWN0IHVzIG9uIGRpc2NvcmQnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYXV0aERhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgLy8gTm90ZTogQXV0aCBkYXRhIGNsZWFudXAgaGFuZGxlZCBieSBsYXVuY2hlclxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IpIHtcclxuICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yQ291bnRlcisrO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yQ291bnRlciA9PT0gMTAwMDAwMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yQ291bnRlciA9IDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHNsb3dDb3VudGVyID0gTWF0aC5mbG9vcih0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3JDb3VudGVyIC8gMTUpO1xyXG4gICAgICAgICAgICB2YXIgbmV3U2xvd0NvdW50ZXIgPSBNYXRoLmZsb29yKHNsb3dDb3VudGVyIC8gMSk7IC8vIE9ubHkgY2hhbmdlcyBldmVyeSB+MTUgdGlja3NcclxuICAgICAgICAgICAgLy8gT25seSByZWZyZXNoIHdpZGdldHMgd2hlbiB0aGUgZG90IHBhdHRlcm4gY2hhbmdlc1xyXG4gICAgICAgICAgICBpZiAobmV3U2xvd0NvdW50ZXIgIT09IHRoaXMubGFzdFNsb3dDb3VudGVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RTbG93Q291bnRlciA9IG5ld1Nsb3dDb3VudGVyO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRvdCA9IHNsb3dDb3VudGVyICUgMyA9PT0gMCA/ICcuJyA6IHNsb3dDb3VudGVyICUgMyA9PT0gMSA/ICcuLicgOiAnLi4uJztcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gXCJjb25uZWN0aW5nXCIgKyBkb3Q7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5wbGF5ZXJFdmVyU2F3QWN0dWFsR2FtZXBsYXkgPSB0cnVlO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5pc0xpc3RlbkJyb3dzZXJNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pc0xpc3RlbkJyb3dzZXJNZXNzYWdlO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVhc29uKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJzZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZTpcIiwgdmFsdWUsIFwicmVhc29uOlwiLCByZWFzb24pO1xyXG4gICAgICAgIHRoaXMuX2lzTGlzdGVuQnJvd3Nlck1lc3NhZ2UgPSB2YWx1ZTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuZ2V0U2VydmVyUG9ydCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBVc2UgdGhlIHNhbWUgcG9ydCB0aGF0IHRoZSBVSSBzZXJ2ZXIgdXNlcyAodHlwaWNhbGx5IDMwMDAgZm9yIGRldiwgcG9ydCsxIGZvciBjdXN0b20gcG9ydHMpXHJcbiAgICAgICAgLy8gVGhpcyBtYXRjaGVzIHRoZSBwYXR0ZXJuIGluIHVpLnRzXHJcbiAgICAgICAgdmFyIHNldHRpbmdzU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXR0aW5nc1NlcnZpY2UpO1xyXG4gICAgICAgIHZhciBzZXJ2ZXJQb3J0ID0gc2V0dGluZ3NTZXJ2aWNlLmdldFNlcnZlclBvcnQoKTtcclxuICAgICAgICByZXR1cm4gc2VydmVyUG9ydCA9PT0gNzc3NyA/IDMwMDAgOiBzZXJ2ZXJQb3J0ICsgMTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQXV0aFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQXV0aFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVGljaygpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgdGhpcy5zcC5ibG9ja1BhcHlydXNFdmVudHModHJ1ZSk7XHJcbiAgICB9O1xyXG4gICAgQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLlRFU01vZFBsYXRmb3JtLmJsb2NrUGFweXJ1c0V2ZW50cyh0cnVlKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEJsb2NrZWRBbmltYXRpb25zU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEJsb2NrZWRBbmltYXRpb25zU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICB2YXIgYmxvY2tlZEFuaW1zID0gW107XHJcbiAgICAgICAgdmFyIHNlbGYgPSBfdGhpcztcclxuICAgICAgICBibG9ja2VkQW5pbXMuZm9yRWFjaChmdW5jdGlvbiAoYmxvY2tlZEFuaW0pIHtcclxuICAgICAgICAgICAgX3RoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHNlbGYsIFwiYmxvY2tpbmcgYW5pbWF0aW9uIGV2ZW50XCIsIGN0eC5hbmltRXZlbnROYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uICgpIHsgfVxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBibG9ja2VkQW5pbSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIEJsb2NrZWRBbmltYXRpb25zU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuLy8gVE9ETzogc2VuZCBldmVudCBpbnN0ZWFkIG9mIGRpcmVjdCBkZXBlbmRlbmN5IG9uIEZvcm1WaWV3IGNsYXNzXHJcbmltcG9ydCB7IEZvcm1WaWV3IH0gZnJvbSBcIi4uLy4uL3ZpZXcvZm9ybVZpZXdcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciB1bmZvY3VzRXZlbnRTdHJpbmcgPSBcIndpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA1LWNsaWVudDpicm93c2VyVW5mb2N1c2VkJywge30pKVwiO1xyXG52YXIgZm9jdXNFdmVudFN0cmluZyA9IFwid2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDUtY2xpZW50OmJyb3dzZXJGb2N1c2VkJywge30pKVwiO1xyXG52YXIgQnJvd3NlclNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQnJvd3NlclNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBCcm93c2VyU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5iYWRNZW51c09wZW4gPSBuZXcgU2V0KCk7XHJcbiAgICAgICAgX3RoaXMuYmFkTWVudXMgPSBbXHJcbiAgICAgICAgICAgIFwiQmFydGVyTWVudVwiIC8qIE1lbnUuQmFydGVyICovLFxyXG4gICAgICAgICAgICBcIkJvb2sgTWVudVwiIC8qIE1lbnUuQm9vayAqLyxcclxuICAgICAgICAgICAgXCJDb250YWluZXJNZW51XCIgLyogTWVudS5Db250YWluZXIgKi8sXHJcbiAgICAgICAgICAgIFwiQ3JhZnRpbmcgTWVudVwiIC8qIE1lbnUuQ3JhZnRpbmcgKi8sXHJcbiAgICAgICAgICAgIFwiR2lmdE1lbnVcIiAvKiBNZW51LkdpZnQgKi8sXHJcbiAgICAgICAgICAgIFwiSW52ZW50b3J5TWVudVwiIC8qIE1lbnUuSW52ZW50b3J5ICovLFxyXG4gICAgICAgICAgICBcIkpvdXJuYWwgTWVudVwiIC8qIE1lbnUuSm91cm5hbCAqLyxcclxuICAgICAgICAgICAgXCJMb2NrcGlja2luZyBNZW51XCIgLyogTWVudS5Mb2NrcGlja2luZyAqLyxcclxuICAgICAgICAgICAgXCJMb2FkaW5nIE1lbnVcIiAvKiBNZW51LkxvYWRpbmcgKi8sXHJcbiAgICAgICAgICAgIFwiTWFwTWVudVwiIC8qIE1lbnUuTWFwICovLFxyXG4gICAgICAgICAgICBcIlJhY2VTZXggTWVudVwiIC8qIE1lbnUuUmFjZVNleCAqLyxcclxuICAgICAgICAgICAgXCJTdGF0c01lbnVcIiAvKiBNZW51LlN0YXRzICovLFxyXG4gICAgICAgICAgICBcIlR3ZWVuTWVudVwiIC8qIE1lbnUuVHdlZW4gKi8sXHJcbiAgICAgICAgICAgIC8vTWVudS5Db25zb2xlLFxyXG4gICAgICAgICAgICAvL01lbnUuTWFpbixcclxuICAgICAgICBdO1xyXG4gICAgICAgIF90aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZShmYWxzZSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwicXVlcnlLZXlDb2RlQmluZGluZ3NcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uUXVlcnlLZXlDb2RlQmluZGluZ3MoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJicm93c2VyTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Ccm93c2VyTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcIm1lbnVPcGVuXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk1lbnVPcGVuKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwibWVudUNsb3NlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk1lbnVDbG9zZShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgLy8gVE9ETzoga2V5Y29kZXMgc2hvdWxkIGJlIGNvbmZpZ3VyYWJsZVxyXG4gICAgQnJvd3NlclNlcnZpY2UucHJvdG90eXBlLm9uUXVlcnlLZXlDb2RlQmluZGluZ3MgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmIChlLmlzRG93bihbNTkgLyogRHhTY2FuQ29kZS5GMSAqL10pKSB7XHJcbiAgICAgICAgICAgIEZvcm1WaWV3LmlzRGlzcGxheWluZ05pY2tuYW1lcyA9ICFGb3JtVmlldy5pc0Rpc3BsYXlpbmdOaWNrbmFtZXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlLmlzRG93bihbNjAgLyogRHhTY2FuQ29kZS5GMiAqL10pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKCF0aGlzLnNwLmJyb3dzZXIuaXNWaXNpYmxlKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5iYWRNZW51c09wZW4uc2l6ZSA9PT0gMCAmJiBlLmlzRG93bihbNjQgLyogRHhTY2FuQ29kZS5GNiAqL10pKSB7XHJcbiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9ICF0aGlzLnNwLmJyb3dzZXIuaXNGb2N1c2VkKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKG5ld1N0YXRlKTtcclxuICAgICAgICAgICAgaWYgKG5ld1N0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoZm9jdXNFdmVudFN0cmluZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQodW5mb2N1c0V2ZW50U3RyaW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5iYWRNZW51c09wZW4uc2l6ZSA9PT0gMCAmJiBlLmlzRG93bihbMjggLyogRHhTY2FuQ29kZS5FbnRlciAqL10pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoZm9jdXNFdmVudFN0cmluZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlLmlzRG93bihbMSAvKiBEeFNjYW5Db2RlLkVzY2FwZSAqL10pKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLmJyb3dzZXIuaXNGb2N1c2VkKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdCh1bmZvY3VzRXZlbnRTdHJpbmcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEJyb3dzZXJTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgfTtcclxuICAgIEJyb3dzZXJTZXJ2aWNlLnByb3RvdHlwZS5vbkJyb3dzZXJNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgb25Gcm9udExvYWRlZEV2ZW50S2V5ID0gXCJmcm9udC1sb2FkZWRcIjtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGJyb3dzZXIgbWVzc2FnZTpcIiwgSlNPTi5zdHJpbmdpZnkoZS5hcmd1bWVudHMpKTtcclxuICAgICAgICBpZiAoZS5hcmd1bWVudHNbMF0gPT09IG9uRnJvbnRMb2FkZWRFdmVudEtleSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGZyb250LWxvYWRlZCBtZXNzYWdlLCBlbWl0dGluZyBicm93c2VyV2luZG93TG9hZGVkIGV2ZW50XCIpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYnJvd3NlcldpbmRvd0xvYWRlZFwiLCB7fSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEJyb3dzZXJTZXJ2aWNlLnByb3RvdHlwZS5vbk1lbnVPcGVuID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAodGhpcy5pc0JhZE1lbnUoZS5uYW1lKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZShmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMuYmFkTWVudXNPcGVuLmFkZChlLm5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChlLm5hbWUgPT09IFwiSFVEIE1lbnVcIiAvKiBNZW51LkhVRCAqLykge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQnJvd3NlclNlcnZpY2UucHJvdG90eXBlLm9uTWVudUNsb3NlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAodGhpcy5iYWRNZW51c09wZW4uZGVsZXRlKGUubmFtZSkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYmFkTWVudXNPcGVuLnNpemUgPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlLm5hbWUgPT09IFwiSFVEIE1lbnVcIiAvKiBNZW51LkhVRCAqLykge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZShmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEJyb3dzZXJTZXJ2aWNlLnByb3RvdHlwZS5pc0JhZE1lbnUgPSBmdW5jdGlvbiAobWVudSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmJhZE1lbnVzLmluY2x1ZGVzKG1lbnUpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBCcm93c2VyU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBCcm93c2VyU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IE5ldHdvcmtpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vbmV0d29ya2luZ1NlcnZpY2VcIjtcclxuLy8gRXZlbnRzIHVzZWQgb24gYm90aCBjbGllbnQgYW5kIGJyb3dzZXIgc2lkZVxyXG52YXIgZXZlbnRzID0ge1xyXG4gICAgc2VsZWN0Q2hhcmFjdGVyOiAnY2hhcmFjdGVyU2VsZWN0X3NlbGVjdCcsXHJcbiAgICBjcmVhdGVDaGFyYWN0ZXI6ICdjaGFyYWN0ZXJTZWxlY3RfY3JlYXRlJyxcclxuICAgIGRlbGV0ZUNoYXJhY3RlcjogJ2NoYXJhY3RlclNlbGVjdF9kZWxldGUnLFxyXG4gICAgYmFja1RvTG9naW46ICdjaGFyYWN0ZXJTZWxlY3RfYmFjaycsXHJcbn07XHJcbnZhciBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKENoYXJhY3RlclNlbGVjdFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNoYXJhY3RlclNlbGVjdEFjdGl2ZSA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLnJlc2V0QXV0aFN0YXRlID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3VzdG9tUGFja2V0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DdXN0b21QYWNrZXRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwiYnJvd3Nlck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQnJvd3Nlck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DcmVhdGVBY3Rvck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIC8vIExpc3RlbiBmb3IgbG9naW5TdWNjZXNzIGV2ZW50IGZyb20gQXV0aFNlcnZpY2VcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJsb2dpblN1Y2Nlc3NcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTG9naW5TdWNjZXNzKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5vbkxvZ2luU3VjY2VzcyA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBsb2dpblN1Y2Nlc3MgZXZlbnQsIHVzZXIgYXV0aGVudGljYXRlZFwiKTtcclxuICAgICAgICAvLyBUaGUgc2VydmVyIHdpbGwgc2VuZCBjaGFyYWN0ZXIgbGlzdCBhdXRvbWF0aWNhbGx5IGFmdGVyIGxvZ2luXHJcbiAgICAgICAgLy8gTm8gbmVlZCB0byByZXF1ZXN0IGl0IGhlcmVcclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5vbkN1c3RvbVBhY2tldE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB2YXIgY29udGVudCA9IEpTT04ucGFyc2UoZXZlbnQubWVzc2FnZS5jb250ZW50SnNvbkR1bXApO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGNvbnRlbnQuY3VzdG9tUGFja2V0VHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNoYXJhY3Rlckxpc3RcIjpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUNoYXJhY3Rlckxpc3QoY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY2hhcmFjdGVyRXJyb3JcIjpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUNoYXJhY3RlckVycm9yKGNvbnRlbnQubWVzc2FnZSB8fCBcIlVua25vd24gZXJyb3Igb2NjdXJyZWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJFcnJvciBwYXJzaW5nIGN1c3RvbSBwYWNrZXQ6IFwiLmNvbmNhdChlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLmhhbmRsZUNoYXJhY3Rlckxpc3QgPSBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgY2hhcmFjdGVyIGxpc3Q6IFwiLmNvbmNhdChkYXRhLmNoYXJhY3RlcnMubGVuZ3RoLCBcIiBjaGFyYWN0ZXJzLCBcIikuY29uY2F0KGRhdGEubWF4U2xvdHMsIFwiIG1heCBzbG90c1wiKSk7XHJcbiAgICAgICAgdGhpcy5jaGFyYWN0ZXJTZWxlY3RBY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgIC8vIEluamVjdCBkYXRhIGludG8gd2luZG93IGZvciBjdXN0b20gVUkgYWNjZXNzIChmb2xsb3dpbmcgc2t5cmltLXJvbGVwbGF5IHBhdHRlcm4pXHJcbiAgICAgICAgdmFyIGluamVjdFNjcmlwdCA9IFwiXFxuICAgICAgd2luZG93LnNreW1wID0gd2luZG93LnNreW1wIHx8IHt9O1xcbiAgICAgIHdpbmRvdy5za3ltcC5jaGFyYWN0ZXJTZWxlY3QgPSBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkoZGF0YSksIFwiO1xcbiAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA6Y2hhcmFjdGVyTGlzdCcsIHsgZGV0YWlsOiBcIikuY29uY2F0KEpTT04uc3RyaW5naWZ5KGRhdGEpLCBcIiB9KSk7XFxuICAgIFwiKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoaW5qZWN0U2NyaXB0KTtcclxuICAgICAgICAvLyBTaG93IGJyb3dzZXIgZm9yIGNoYXJhY3RlciBzZWxlY3Rpb24gVUlcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5oYW5kbGVDaGFyYWN0ZXJFcnJvciA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7XHJcbiAgICAgICAgbG9nRXJyb3IodGhpcywgXCJDaGFyYWN0ZXIgZXJyb3I6IFwiLmNvbmNhdChtZXNzYWdlKSk7XHJcbiAgICAgICAgLy8gSW5qZWN0IGVycm9yIGludG8gd2luZG93IGZvciBjdXN0b20gVUkgYWNjZXNzXHJcbiAgICAgICAgdmFyIGluamVjdFNjcmlwdCA9IFwiXFxuICAgICAgd2luZG93LnNreW1wID0gd2luZG93LnNreW1wIHx8IHt9O1xcbiAgICAgIHdpbmRvdy5za3ltcC5jaGFyYWN0ZXJTZWxlY3RFcnJvciA9IFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShtZXNzYWdlKSwgXCI7XFxuICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDpjaGFyYWN0ZXJFcnJvcicsIHsgZGV0YWlsOiBcIikuY29uY2F0KEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogbWVzc2FnZSB9KSwgXCIgfSkpO1xcbiAgICBcIik7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGluamVjdFNjcmlwdCk7XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUub25DcmVhdGVBY3Rvck1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIC8vIEhpZGUgY2hhcmFjdGVyIHNlbGVjdCBzY3JlZW4gd2hlbiBwbGF5ZXIgc3Bhd25zIGluIHdvcmxkXHJcbiAgICAgICAgaWYgKHRoaXMuY2hhcmFjdGVyU2VsZWN0QWN0aXZlKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUGxheWVyIHNwYXduZWQsIGhpZGluZyBjaGFyYWN0ZXIgc2VsZWN0IHNjcmVlblwiKTtcclxuICAgICAgICAgICAgdmFyIGNsZWFyU2NyaXB0ID0gXCJcXG4gICAgICAgIGlmICh3aW5kb3cuc2t5bXApIHtcXG4gICAgICAgICAgd2luZG93LnNreW1wLmNoYXJhY3RlclNlbGVjdCA9IG51bGw7XFxuICAgICAgICAgIHdpbmRvdy5za3ltcC5jaGFyYWN0ZXJTZWxlY3RFcnJvciA9IG51bGw7XFxuICAgICAgICB9XFxuICAgICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wOmNoYXJhY3Rlckxpc3QnLCB7IGRldGFpbDogbnVsbCB9KSk7XFxuICAgICAgXCI7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChjbGVhclNjcmlwdCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhcmFjdGVyU2VsZWN0QWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLm9uQnJvd3Nlck1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBldmVudEtleSA9IGUuYXJndW1lbnRzWzBdO1xyXG4gICAgICAgIHZhciBldmVudERhdGEgPSBlLmFyZ3VtZW50c1sxXTtcclxuICAgICAgICBzd2l0Y2ggKGV2ZW50S2V5KSB7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLnNlbGVjdENoYXJhY3RlcjpcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VuZFNlbGVjdENoYXJhY3RlcihldmVudERhdGEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmNyZWF0ZUNoYXJhY3RlcjpcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VuZENyZWF0ZUNoYXJhY3RlcigpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmRlbGV0ZUNoYXJhY3RlcjpcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VuZERlbGV0ZUNoYXJhY3RlcihldmVudERhdGEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmJhY2tUb0xvZ2luOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVCYWNrVG9Mb2dpbigpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLnNlbmRTZWxlY3RDaGFyYWN0ZXIgPSBmdW5jdGlvbiAodmlzaWJsZUlkKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZWxlY3RpbmcgY2hhcmFjdGVyIHZpc2libGVJZD1cIi5jb25jYXQodmlzaWJsZUlkKSk7XHJcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tUGFja2V0LFxyXG4gICAgICAgICAgICBjb250ZW50SnNvbkR1bXA6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgIGN1c3RvbVBhY2tldFR5cGU6ICdzZWxlY3RDaGFyYWN0ZXInLFxyXG4gICAgICAgICAgICAgICAgdmlzaWJsZUlkOiB2aXNpYmxlSWQsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLnNlbmRDcmVhdGVDaGFyYWN0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDcmVhdGluZyBuZXcgY2hhcmFjdGVyXCIpO1xyXG4gICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbVBhY2tldCxcclxuICAgICAgICAgICAgY29udGVudEpzb25EdW1wOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICBjdXN0b21QYWNrZXRUeXBlOiAnY3JlYXRlQ2hhcmFjdGVyJyxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUuc2VuZERlbGV0ZUNoYXJhY3RlciA9IGZ1bmN0aW9uICh2aXNpYmxlSWQpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkRlbGV0aW5nIGNoYXJhY3RlciB2aXNpYmxlSWQ9XCIuY29uY2F0KHZpc2libGVJZCkpO1xyXG4gICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbVBhY2tldCxcclxuICAgICAgICAgICAgY29udGVudEpzb25EdW1wOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICBjdXN0b21QYWNrZXRUeXBlOiAnZGVsZXRlQ2hhcmFjdGVyJyxcclxuICAgICAgICAgICAgICAgIHZpc2libGVJZDogdmlzaWJsZUlkLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5oYW5kbGVCYWNrVG9Mb2dpbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkJhY2sgdG8gbG9naW4gLSByZXR1cm5pbmcgdG8gZnJlc2ggYXV0aCBzY3JlZW5cIik7XHJcbiAgICAgICAgLy8gU2V0IGZsYWcgdG8gcHJldmVudCBhdXRvLXJlY29ubmVjdCBpbiBhdXRoU2VydmljZVxyXG4gICAgICAgIHRoaXMucmVzZXRBdXRoU3RhdGUgPSB0cnVlO1xyXG4gICAgICAgIC8vIENsZWFyIGNoYXJhY3RlciBzZWxlY3QgZGF0YVxyXG4gICAgICAgIHZhciBjbGVhclNjcmlwdCA9IFwiXFxuICAgICAgaWYgKHdpbmRvdy5za3ltcCkge1xcbiAgICAgICAgd2luZG93LnNreW1wLmNoYXJhY3RlclNlbGVjdCA9IG51bGw7XFxuICAgICAgICB3aW5kb3cuc2t5bXAuY2hhcmFjdGVyU2VsZWN0RXJyb3IgPSBudWxsO1xcbiAgICAgIH1cXG4gICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wOmNoYXJhY3Rlckxpc3QnLCB7IGRldGFpbDogbnVsbCB9KSk7XFxuICAgIFwiO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChjbGVhclNjcmlwdCk7XHJcbiAgICAgICAgdGhpcy5jaGFyYWN0ZXJTZWxlY3RBY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICAvLyBDbG9zZSBjb25uZWN0aW9uIGFuZCBlbnN1cmUgYnJvd3NlciBzdGF5cyB2aXNpYmxlIGZvciBhdXRoIHNjcmVlblxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAvLyBLZWVwIGJyb3dzZXIgdmlzaWJsZSBmb3IgYXV0aCBVSVxyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IENoYXJhY3RlclNlbGVjdFNlcnZpY2UgfTtcclxuIiwiO1xyXG52YXIgQ2xpZW50TGlzdGVuZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBDbGllbnRMaXN0ZW5lcigpIHtcclxuICAgICAgICAvLyBEb24ndCBsZXQgVHlwZVNjcmlwdCB0cmVhdCB0aGlzIGNsYXNzIGFzIGVtcHR5XHJcbiAgICAgICAgdGhpcy5fbm9uRW1wdHlDbGFzc01hcmsgPSAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBDbGllbnRMaXN0ZW5lcjtcclxufSgpKTtcclxuZXhwb3J0IHsgQ2xpZW50TGlzdGVuZXIgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuLy8gVE9ETzogcmVmYWN0b3IgdGhpcyBvdXRcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIENtZEFyZ3VtZW50O1xyXG4oZnVuY3Rpb24gKENtZEFyZ3VtZW50KSB7XHJcbiAgICBDbWRBcmd1bWVudFtDbWRBcmd1bWVudFtcIk9iamVjdFJlZmVyZW5jZVwiXSA9IDBdID0gXCJPYmplY3RSZWZlcmVuY2VcIjtcclxuICAgIENtZEFyZ3VtZW50W0NtZEFyZ3VtZW50W1wiQmFzZUZvcm1cIl0gPSAxXSA9IFwiQmFzZUZvcm1cIjtcclxuICAgIENtZEFyZ3VtZW50W0NtZEFyZ3VtZW50W1wiSW50XCJdID0gMl0gPSBcIkludFwiO1xyXG4gICAgQ21kQXJndW1lbnRbQ21kQXJndW1lbnRbXCJTdHJpbmdcIl0gPSAzXSA9IFwiU3RyaW5nXCI7XHJcbn0pKENtZEFyZ3VtZW50IHx8IChDbWRBcmd1bWVudCA9IHt9KSk7XHJcbnZhciBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKENvbnNvbGVDb21tYW5kc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmltbXVuZVNjaGVtYSA9IFtcIm1wXCJdO1xyXG4gICAgICAgIF90aGlzLm5vblZhbmlsYUNvbW1hbmRzID0gW1wibXBcIl07XHJcbiAgICAgICAgX3RoaXMuc2NoZW1hcyA9IENvbnNvbGVDb21tYW5kc1NlcnZpY2UuY3JlYXRlU2NoZW1hcygpO1xyXG4gICAgICAgIF90aGlzLnNldHVwTXBDb21tYW5kKCk7XHJcbiAgICAgICAgX3RoaXMuc2V0dXBWYW5pbGFDb21tYW5kcygpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIENvbnNvbGVDb21tYW5kc1NlcnZpY2UuY3JlYXRlU2NoZW1hcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgc2NoZW1hcyA9IG5ldyBNYXAoKTtcclxuICAgICAgICBzY2hlbWFzLnNldChcImFkZGl0ZW1cIiwgW0NtZEFyZ3VtZW50Lk9iamVjdFJlZmVyZW5jZSwgQ21kQXJndW1lbnQuQmFzZUZvcm0sIENtZEFyZ3VtZW50LkludF0pO1xyXG4gICAgICAgIHNjaGVtYXMuc2V0KFwiZXF1aXBpdGVtXCIsIFtDbWRBcmd1bWVudC5PYmplY3RSZWZlcmVuY2UsIENtZEFyZ3VtZW50LkJhc2VGb3JtXSk7XHJcbiAgICAgICAgc2NoZW1hcy5zZXQoXCJwbGFjZWF0bWVcIiwgW0NtZEFyZ3VtZW50Lk9iamVjdFJlZmVyZW5jZSwgQ21kQXJndW1lbnQuQmFzZUZvcm1dKTtcclxuICAgICAgICBzY2hlbWFzLnNldChcImRpc2FibGVcIiwgW0NtZEFyZ3VtZW50Lk9iamVjdFJlZmVyZW5jZV0pO1xyXG4gICAgICAgIHNjaGVtYXMuc2V0KFwibXBcIiwgW0NtZEFyZ3VtZW50Lk9iamVjdFJlZmVyZW5jZSwgQ21kQXJndW1lbnQuU3RyaW5nXSk7XHJcbiAgICAgICAgcmV0dXJuIHNjaGVtYXM7XHJcbiAgICB9O1xyXG4gICAgQ29uc29sZUNvbW1hbmRzU2VydmljZS5wcm90b3R5cGUuc2V0dXBNcENvbW1hbmQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLnNwLmZpbmRDb25zb2xlQ29tbWFuZChcIiBDb25maWd1cmVVTVwiKSB8fCB0aGlzLnNwLmZpbmRDb25zb2xlQ29tbWFuZChcInRlc3RcIik7XHJcbiAgICAgICAgaWYgKGNvbW1hbmQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJjb21tYW5kIHdhcyBudWxsIGluIHNldHVwTXBDb21tYW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbW1hbmQuc2hvcnROYW1lID0gXCJtcFwiO1xyXG4gICAgICAgIGNvbW1hbmQuZXhlY3V0ZSA9IHRoaXMuZ2V0Q29tbWFuZEV4ZWN1dG9yKFwibXBcIik7XHJcbiAgICB9O1xyXG4gICAgQ29uc29sZUNvbW1hbmRzU2VydmljZS5wcm90b3R5cGUuc2V0dXBWYW5pbGFDb21tYW5kcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2V0dGluZyB1cCB2YW5pbGEgY29tbWFuZHNcIik7XHJcbiAgICAgICAgdGhpcy5zY2hlbWFzLmZvckVhY2goZnVuY3Rpb24gKF8sIGNvbW1hbmROYW1lKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlNldHRpbmcgdXAgY29tbWFuZFwiLCBjb21tYW5kTmFtZSk7XHJcbiAgICAgICAgICAgIHZhciBjb21tYW5kID0gX3RoaXMuc3AuZmluZENvbnNvbGVDb21tYW5kKGNvbW1hbmROYW1lKTtcclxuICAgICAgICAgICAgaWYgKGNvbW1hbmQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcImNvbW1hbmRcIiwgY29tbWFuZE5hbWUsIFwid2FzIG51bGwgaW4gc2V0dXBWYW5pbGFDb21tYW5kc1wiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoX3RoaXMubm9uVmFuaWxhQ29tbWFuZHMuaW5jbHVkZXMoY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJjb21tYW5kXCIsIGNvbW1hbmROYW1lLCBcIiBpcyBub24tdmFuaWxhIGNvbW1hbmRcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29tbWFuZC5leGVjdXRlID0gX3RoaXMuZ2V0Q29tbWFuZEV4ZWN1dG9yKGNvbW1hbmROYW1lKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlZhbmlsYSBjb21tYW5kcyBzZXQgdXBcIik7XHJcbiAgICB9O1xyXG4gICAgQ29uc29sZUNvbW1hbmRzU2VydmljZS5wcm90b3R5cGUuZ2V0Q29tbWFuZEV4ZWN1dG9yID0gZnVuY3Rpb24gKGNvbW1hbmROYW1lKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYXJncyA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIFRPRE86IGhhbmRsZSBwb3NzaWJsZSBleGNlcHRpb25zIGluIHRoaXMgZnVuY3Rpb25cclxuICAgICAgICAgICAgdmFyIHNjaGVtYSA9IF90aGlzLnNjaGVtYXMuZ2V0KGNvbW1hbmROYW1lKTtcclxuICAgICAgICAgICAgaWYgKHNjaGVtYSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJTY2hlbWEgbm90IGZvdW5kIGZvciBjb21tYW5kXCIsIGNvbW1hbmROYW1lKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggIT09IHNjaGVtYS5sZW5ndGggJiYgIV90aGlzLmltbXVuZVNjaGVtYS5pbmNsdWRlcyhjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIk1pc21hdGNoIGZvdW5kIGluIHRoZSBzY2hlbWEgb2ZcIiwgY29tbWFuZE5hbWUsIFwiY29tbWFuZFwiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoc2NoZW1hW2ldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBDbWRBcmd1bWVudC5PYmplY3RSZWZlcmVuY2U6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBsb2NhbElkVG9SZW1vdGVJZChwYXJzZUludChcIlwiLmNvbmNhdChhcmdzW2ldKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1tpXSAhPT0gXCJzdHJpbmdcIiAmJiB0eXBlb2YgYXJnc1tpXSAhPT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIkJhZCBhcmd1bWVudCB0eXBlIGluIGNvbW1hbmRcIiwgY29tbWFuZE5hbWUsIFwiYXJndW1lbnQgaW5kZXhcIiwgaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ29uc29sZUNvbW1hbmQsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kTmFtZTogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IGFyZ3NcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gTWVhbnQgdG8gYmUgc2hvd24gdG8gdXNlciwgbm90IGZvciBsb2dnaW5nXHJcbiAgICAgICAgICAgIF90aGlzLnNwLnByaW50Q29uc29sZShcInNlbnRcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIHJldHVybiBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IENvbnNvbGVDb21tYW5kc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBfX2Fzc2lnbiA9ICh0aGlzICYmIHRoaXMuX19hc3NpZ24pIHx8IGZ1bmN0aW9uICgpIHtcclxuICAgIF9fYXNzaWduID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbih0KSB7XHJcbiAgICAgICAgZm9yICh2YXIgcywgaSA9IDEsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7XHJcbiAgICAgICAgICAgIHMgPSBhcmd1bWVudHNbaV07XHJcbiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gcykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSlcclxuICAgICAgICAgICAgICAgIHRbcF0gPSBzW3BdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gX19hc3NpZ24uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxufTtcclxuaW1wb3J0IHsgcHJpbnRDb25zb2xlIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBnZXRQY0ludmVudG9yeSB9IGZyb20gXCIuL3JlbW90ZVNlcnZlclwiO1xyXG5pbXBvcnQgeyBnZXRJbnZlbnRvcnksIGdldERpZmYsIGhhc0V4dHJhcywgcmVtb3ZlU2ltcGxlSXRlbXNBc01hbnlBc1Bvc3NpYmxlLCBzdW1JbnZlbnRvcmllcyB9IGZyb20gXCIuLi8uLi9zeW5jL2ludmVudG9yeVwiO1xyXG5pbXBvcnQgeyBMYXN0SW52U2VydmljZSB9IGZyb20gXCIuL2xhc3RJbnZTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSB9IGZyb20gXCIuL3N3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZVwiO1xyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxudmFyIENvbnRhaW5lcnNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKENvbnRhaW5lcnNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQ29udGFpbmVyc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgY29udHJvbGxlci5vbignY29udGFpbmVyQ2hhbmdlZCcsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNvbnRhaW5lckNoYW5nZWQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIENvbnRhaW5lcnNTZXJ2aWNlLnByb3RvdHlwZS5vbkNvbnRhaW5lckNoYW5nZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHN3ZWV0Q2FudERyb3BTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSk7XHJcbiAgICAgICAgaWYgKGUub2xkQ29udGFpbmVyICYmIGUubmV3Q29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIGlmIChlLm9sZENvbnRhaW5lci5nZXRGb3JtSUQoKSA9PT0gMHgxNCB8fFxyXG4gICAgICAgICAgICAgICAgZS5uZXdDb250YWluZXIuZ2V0Rm9ybUlEKCkgPT09IDB4MTQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBsYXN0SW52U2VydmljZV8xID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKExhc3RJbnZTZXJ2aWNlKTtcclxuICAgICAgICAgICAgICAgIGlmICghbGFzdEludlNlcnZpY2VfMS5sYXN0SW52KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFzdEludlNlcnZpY2VfMS5sYXN0SW52ID0gZ2V0UGNJbnZlbnRvcnkoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChsYXN0SW52U2VydmljZV8xLmxhc3RJbnYpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3SW52ID0gZ2V0SW52ZW50b3J5KHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gSXQgc2VlbXMgdGhhdCAnaWdub3JlV29ybiA9IGZhbHNlJyBmaXhlcyB0aGlzOlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9za3lyaW0tbXVsdGlwbGF5ZXIvaXNzdWUtdHJhY2tlci9pc3N1ZXMvNDNcclxuICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gZXhjZXNzIGRpZmYgaXMgcHJvZHVjZWQgd2hlbiAnaWdub3JlV29ybiA9IHRydWUnXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gSSB0aG91Z2h0IHRoYXQgaXQgd291bGQgYmUgdmljZSB2ZXJzYSBidXQgdGhhdCdzIGhvdyBpdCB3b3Jrc1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpZ25vcmVXb3JuID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRpZmYgPSBnZXREaWZmKGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiwgbmV3SW52LCBpZ25vcmVXb3JuKTtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoJ2RpZmY6Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaWZmLmVudHJpZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiW1wiLmNvbmNhdChpLCBcIl0gXCIpLmNvbmNhdChKU09OLnN0cmluZ2lmeShkaWZmLmVudHJpZXNbaV0pKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtc2dzID0gZGlmZi5lbnRyaWVzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IHJldmlldyB0aGlzIGNvbmRpdGlvbiwgc2VlbXMgdG8gYmUgaW5jb3JyZWN0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnRyeS5jb3VudCA+IDBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gc3dlZXRDYW50RHJvcFNlcnZpY2UuY2FuRHJvcE9yUHV0SXRlbShlbnRyeS5iYXNlSWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoZW50cnkpIHsgcmV0dXJuIGVudHJ5LmNvdW50ICE9PSAwOyB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbnRyeUNvcHkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGVudHJ5KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtc2cgPSBfX2Fzc2lnbihfX2Fzc2lnbih7fSwgZW50cnlDb3B5KSwgeyB0OiBlbnRyeS5jb3VudCA+IDAgPyBNc2dUeXBlLlB1dEl0ZW0gOiBNc2dUeXBlLlRha2VJdGVtLCB0YXJnZXQ6IGUub2xkQ29udGFpbmVyLmdldEZvcm1JRCgpID09PSAweDE0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBsb2NhbElkVG9SZW1vdGVJZChlLm5ld0NvbnRhaW5lci5nZXRGb3JtSUQoKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGxvY2FsSWRUb1JlbW90ZUlkKGUub2xkQ29udGFpbmVyLmdldEZvcm1JRCgpKSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbXNnLmNvdW50ID0gTWF0aC5hYnMobXNnLmNvdW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCgoX2EgPSBfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChlbnRyeS5iYXNlSWQpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0TmFtZSgpKSA9PT0gbXNnLm5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBtc2cubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbXNnO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIG1zZ3MuZm9yRWFjaChmdW5jdGlvbiAobXNnKSB7IHJldHVybiBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbXNnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7IH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgZW1pdHRpbmcgMSwyLDMsNCw1IGNoYW5nZXMgd2hlbiB0YWtpbmcvcHV0dGluZyA1IHBvdGlvbnMgb25lIGJ5IG9uZVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY29kZSBtYWtlcyBpdCAxLDEsMSwxLDEgYnV0IHdvcmtzIG9ubHkgZm9yIGV4dHJhLWxlc3MgaXRlbXNcclxuICAgICAgICAgICAgICAgICAgICAvLyBBdCB0aGUgbW9tZW50IG9mIHdyaXRpbmcgdGhpcyBJIHRoaW5rIGl0J3Mgbm90IG5lZWRlZCBmb3IgaXRlbXMgd2l0aCBleHRyYXNcclxuICAgICAgICAgICAgICAgICAgICBkaWZmLmVudHJpZXMuZm9yRWFjaChmdW5jdGlvbiAoZW50cnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiAmJiAhaGFzRXh0cmFzKGVudHJ5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHB1dCA9IGVudHJ5LmNvdW50ID4gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YWtlID0gZW50cnkuY291bnQgPCAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHB1dCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiA9IHJlbW92ZVNpbXBsZUl0ZW1zQXNNYW55QXNQb3NzaWJsZShsYXN0SW52U2VydmljZV8xLmxhc3RJbnYsIGVudHJ5LmJhc2VJZCwgZW50cnkuY291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGFrZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhZGQgPSB7IGVudHJpZXM6IFtlbnRyeV0gfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGQuZW50cmllc1swXS5jb3VudCAqPSAtMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0SW52U2VydmljZV8xLmxhc3RJbnYgPSBzdW1JbnZlbnRvcmllcyhsYXN0SW52U2VydmljZV8xLmxhc3RJbnYsIGFkZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gQ29udGFpbmVyc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQ29udGFpbmVyc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHRoaXMgb3V0XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIENyYWZ0U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhDcmFmdFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBDcmFmdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuZnVybml0dXJlU3RyZWFrID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oJ2NvbnRhaW5lckNoYW5nZWQnLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Db250YWluZXJDaGFuZ2VkKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBDcmFmdFNlcnZpY2UucHJvdG90eXBlLm9uQ29udGFpbmVyQ2hhbmdlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIG9sZENvbnRhaW5lcklkID0gZS5vbGRDb250YWluZXIgPyBlLm9sZENvbnRhaW5lci5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgdmFyIG5ld0NvbnRhaW5lcklkID0gZS5uZXdDb250YWluZXIgPyBlLm5ld0NvbnRhaW5lci5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgdmFyIGJhc2VPYmpJZCA9IGUuYmFzZU9iaiA/IGUuYmFzZU9iai5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgaWYgKG9sZENvbnRhaW5lcklkICE9PSAweDE0ICYmIG5ld0NvbnRhaW5lcklkICE9PSAweDE0KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGZ1cm5pdHVyZVJlZiA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKS5nZXRGdXJuaXR1cmVSZWZlcmVuY2UoKTtcclxuICAgICAgICBpZiAoIWZ1cm5pdHVyZVJlZikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBmdXJuaXR1cmVJZCA9IGZ1cm5pdHVyZVJlZi5nZXRGb3JtSUQoKTtcclxuICAgICAgICBpZiAob2xkQ29udGFpbmVySWQgPT09IDB4MTQgJiYgbmV3Q29udGFpbmVySWQgPT09IDApIHtcclxuICAgICAgICAgICAgdmFyIGNyYWZ0SW5wdXRPYmplY3RzID0gdGhpcy5mdXJuaXR1cmVTdHJlYWsuZ2V0KGZ1cm5pdHVyZUlkKTtcclxuICAgICAgICAgICAgaWYgKCFjcmFmdElucHV0T2JqZWN0cykge1xyXG4gICAgICAgICAgICAgICAgY3JhZnRJbnB1dE9iamVjdHMgPSB7IGVudHJpZXM6IFtdIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY3JhZnRJbnB1dE9iamVjdHMuZW50cmllcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIGJhc2VJZDogYmFzZU9iaklkLFxyXG4gICAgICAgICAgICAgICAgY291bnQ6IGUubnVtSXRlbXMsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmZ1cm5pdHVyZVN0cmVhay5zZXQoZnVybml0dXJlSWQsIGNyYWZ0SW5wdXRPYmplY3RzKTtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJBZGRpbmcgYmFzZU9iaklkXCIsIGJhc2VPYmpJZC50b1N0cmluZygxNiksIFwibnVtSXRlbXNcIiwgZS5udW1JdGVtcywgXCJ0byBjcmFmdFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAob2xkQ29udGFpbmVySWQgPT09IDAgJiYgbmV3Q29udGFpbmVySWQgPT09IDB4MTQpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ0ZpbmlzaGluZyBjcmFmdCcpO1xyXG4gICAgICAgICAgICB2YXIgY3JhZnRJbnB1dE9iamVjdHMgPSB0aGlzLmZ1cm5pdHVyZVN0cmVhay5nZXQoZnVybml0dXJlSWQpO1xyXG4gICAgICAgICAgICBpZiAoY3JhZnRJbnB1dE9iamVjdHMgJiYgY3JhZnRJbnB1dE9iamVjdHMuZW50cmllcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZnVybml0dXJlU3RyZWFrLmRlbGV0ZShmdXJuaXR1cmVJZCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgd29ya2JlbmNoID0gbG9jYWxJZFRvUmVtb3RlSWQoZnVybml0dXJlSWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF3b3JrYmVuY2gpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcImxvY2FsSWRUb1JlbW90ZUlkIHJldHVybmVkIDAgZm9yIGZ1cm5pdHVyZUlkXCIsIGZ1cm5pdHVyZUlkKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0T2JqZWN0SWQgPSBiYXNlT2JqSWQ7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlbmRpbmcgY3JhZnQgd29ya2JlbmNoXCIsIHdvcmtiZW5jaCwgXCJyZXN1bHRPYmplY3RJZFwiLCByZXN1bHRPYmplY3RJZCwgXCJjcmFmdElucHV0T2JqZWN0c1wiLCBKU09OLnN0cmluZ2lmeShjcmFmdElucHV0T2JqZWN0cy5lbnRyaWVzKSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5DcmFmdEl0ZW0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHsgd29ya2JlbmNoOiB3b3JrYmVuY2gsIGNyYWZ0SW5wdXRPYmplY3RzOiBjcmFmdElucHV0T2JqZWN0cywgcmVzdWx0T2JqZWN0SWQ6IHJlc3VsdE9iamVjdElkIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gQ3JhZnRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IENyYWZ0U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQWN0b3IgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBSZXNwYXduTmVlZGVkRXJyb3IgfSBmcm9tIFwiLi4vLi4vbGliL2Vycm9yc1wiO1xyXG5pbXBvcnQgeyBBbmltYXRpb25FdmVudE5hbWUgfSBmcm9tIFwiLi4vLi4vc3luYy9hbmltYXRpb25cIjtcclxuaW1wb3J0IHsgUmFnZG9sbFNlcnZpY2UgfSBmcm9tIFwiLi9yYWdkb2xsU2VydmljZVwiO1xyXG52YXIgRGVhdGhTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKERlYXRoU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIERlYXRoU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5hcHBseURlYXRoU3RhdGUgPSBmdW5jdGlvbiAoYWN0b3IsIGlzRGVhZCkge1xyXG4gICAgICAgICAgICBpZiAoYWN0b3IuaXNEZWFkKCkgPT09IGlzRGVhZCAmJiBfdGhpcy5pc1BsYXllcihhY3RvcikgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGlzRGVhZCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMua2lsbEFjdG9yKGFjdG9yLCBudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnJlc3VycmVjdEFjdG9yKGFjdG9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMua2lsbEFjdG9yID0gZnVuY3Rpb24gKGFjdG9yLCBraWxsZXIpIHtcclxuICAgICAgICAgICAgaWYgKGtpbGxlciA9PT0gdm9pZCAwKSB7IGtpbGxlciA9IG51bGw7IH1cclxuICAgICAgICAgICAgaWYgKF90aGlzLmlzUGxheWVyKGFjdG9yKSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMucGxheWVyRGVhZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5idXN5Rm9yT3RoZXJSZWFzb25zQ291bnRlcisrO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuVXRpbGl0eS53YWl0KDcuNSkudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5idXN5Rm9yT3RoZXJSZWFzb25zQ291bnRlci0tOyB9KTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmFsbG93ZWRQbGF5ZXJBbmltYXRpb25zID0gW107XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5zZXREb250TW92ZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmtpbGxXaXRoUHVzaChhY3Rvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5lbmREZWZlcnJlZEtpbGwoKTtcclxuICAgICAgICAgICAgICAgIGFjdG9yLmtpbGwoa2lsbGVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMucmVzdXJyZWN0QWN0b3IgPSBmdW5jdGlvbiAoYWN0b3IpIHtcclxuICAgICAgICAgICAgaWYgKF90aGlzLmlzUGxheWVyKGFjdG9yKSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMucGxheWVyRGVhZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuYnVzeUZvck90aGVyUmVhc29uc0NvdW50ZXIrKztcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLlV0aWxpdHkud2FpdCg3LjUpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuYnVzeUZvck90aGVyUmVhc29uc0NvdW50ZXItLTsgfSk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5hbGxvd2VkUGxheWVyQW5pbWF0aW9ucyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5zZXREb250TW92ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5yZXNzdXJlY3RXaXRoUHVzaEtpbGwoYWN0b3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJlc3Bhd25OZWVkZWRFcnJvcihcIm5lZWRzIHRvIGJlIHJlc3Bhd25lZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMua2lsbFdpdGhQdXNoID0gZnVuY3Rpb24gKGFjdG9yKSB7XHJcbiAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgKF9hID0gX3RoaXMuYWxsb3dlZFBsYXllckFuaW1hdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wdXNoKEFuaW1hdGlvbkV2ZW50TmFtZS5SYWdkb2xsKTtcclxuICAgICAgICAgICAgYWN0b3IucHVzaEFjdG9yQXdheShhY3RvciwgMCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5yZXNzdXJlY3RXaXRoUHVzaEtpbGwgPSBmdW5jdGlvbiAoYWN0KSB7XHJcbiAgICAgICAgICAgIHZhciBmb3JtSWQgPSBhY3QuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgIHZhciByYWdkb2xsU2VydmljZSA9IF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmFnZG9sbFNlcnZpY2UpO1xyXG4gICAgICAgICAgICByYWdkb2xsU2VydmljZS5zYWZlUmVtb3ZlUmFnZG9sbEZyb21Xb3JsZChhY3QsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20oX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZm9ybUlkKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogc2hvdWxkIHVzZSBhY3RvciB2YXJpYWJsZSBpbnN0ZWFkIG9mIGdldFBsYXllcj9cclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IHVzZSBkaWZmZXJlbnQgaUdldFVwVHlwZSBpZiByZXNzdXJlY3RpbmcgdW5kZXIgd2F0ZXJcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkuc2V0QW5pbWF0aW9uVmFyaWFibGVJbnQoXCJpR2V0VXBUeXBlXCIsIDEpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KGFjdG9yLCBBbmltYXRpb25FdmVudE5hbWUuR2V0VXBCZWdpbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMuaXNQbGF5ZXIgPSBmdW5jdGlvbiAoYWN0b3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFjdG9yLmdldEZvcm1JRCgpID09PSBfdGhpcy5wbGF5ZXJBY3RvcklkO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8gTnVsbCB0byBhbGxvdyBhbGwgYW5pbWF0aW9ucy4gRW1wdHkgYXJyYXkgdG8gZGlzYWxsb3cgYWxsXHJcbiAgICAgICAgX3RoaXMuYWxsb3dlZFBsYXllckFuaW1hdGlvbnMgPSBudWxsO1xyXG4gICAgICAgIF90aGlzLnBsYXllckFjdG9ySWQgPSAweDE0O1xyXG4gICAgICAgIF90aGlzLnBsYXllckRlYWQgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5idXN5Rm9yT3RoZXJSZWFzb25zQ291bnRlciA9IDA7XHJcbiAgICAgICAgY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgY29udHJvbGxlci5lbWl0dGVyLm9uKFwiYXBwbHlEZWF0aFN0YXRlRXZlbnRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQXBwbHlEZWF0aFN0YXRlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5ob29rRGlzYWJsZUtpbGxNb3ZlcygpO1xyXG4gICAgICAgIF90aGlzLmhvb2tEaXNhYmxlU3RhZ2dlcigpO1xyXG4gICAgICAgIF90aGlzLmhvb2tEaXNhYmxlQmxvY2tlZEFuaW1zKCk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRGVhdGhTZXJ2aWNlLnByb3RvdHlwZS5pc0J1c3kgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGxheWVyRGVhZCB8fCB0aGlzLmJ1c3lGb3JPdGhlclJlYXNvbnNDb3VudGVyID4gMDtcclxuICAgIH07XHJcbiAgICBEZWF0aFNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHBsYXllciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBwbGF5ZXIgPT09IG51bGwgfHwgcGxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwbGF5ZXIuc3RhcnREZWZlcnJlZEtpbGwoKTtcclxuICAgIH07XHJcbiAgICBEZWF0aFNlcnZpY2UucHJvdG90eXBlLm9uQXBwbHlEZWF0aFN0YXRlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLmFwcGx5RGVhdGhTdGF0ZShlLmFjdG9yLCBlLmlzRGVhZCk7XHJcbiAgICB9O1xyXG4gICAgRGVhdGhTZXJ2aWNlLnByb3RvdHlwZS5ob29rRGlzYWJsZUtpbGxNb3ZlcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKCkgeyB9LFxyXG4gICAgICAgIH0sIDB4ZmYwMDAwMDAsIDB4ZmZmZmZmZmYsIFwiS2lsbE1vdmUqXCIpO1xyXG4gICAgfTtcclxuICAgIERlYXRoU2VydmljZS5wcm90b3R5cGUuaG9va0Rpc2FibGVTdGFnZ2VyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICAgICAgfSwgMHhmZjAwMDAwMCwgMHhmZmZmZmZmZiwgXCJzdGFnZ2VyU3RhcnRcIik7XHJcbiAgICB9O1xyXG4gICAgRGVhdGhTZXJ2aWNlLnByb3RvdHlwZS5ob29rRGlzYWJsZUJsb2NrZWRBbmltcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuYWxsb3dlZFBsYXllckFuaW1hdGlvbnMgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIV90aGlzLmFsbG93ZWRQbGF5ZXJBbmltYXRpb25zLmluY2x1ZGVzKGN0eC5hbmltRXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uICgpIHsgfSxcclxuICAgICAgICB9LCB0aGlzLnBsYXllckFjdG9ySWQsIHRoaXMucGxheWVyQWN0b3JJZCk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIERlYXRoU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBEZWF0aFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuZGlmZmljdWx0eSA9IDU7XHJcbiAgICAgICAgX3RoaXMuY291bnRlciA9IDA7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuY291bnRlcisrO1xyXG4gICAgICAgIGlmICh0aGlzLmNvdW50ZXIgPj0gNjApIHtcclxuICAgICAgICAgICAgdGhpcy5jb3VudGVyID0gMDtcclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LnNldElOSUludChcImlEaWZmaWN1bHR5OkdhbWVQbGF5XCIsIHRoaXMuZGlmZmljdWx0eSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuZW5hYmxlRmFzdFRyYXZlbChmYWxzZSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIERpc2FibGVGYXN0VHJhdmVsU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyB0dXJuIG9mZiBwbGF5ZXIgbGV2ZWwgZXhwXHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmWFBQZXJTa2lsbFJhbmtcIiwgMCk7XHJcbiAgICAgICAgLy8gdHVybiBvZmYgc2tpbGwgZXhwXHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxOCAvKiBBY3RvclZhbHVlLkFsdGVyYXRpb24gKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTkgLyogQWN0b3JWYWx1ZS5Db25qdXJhdGlvbiAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgyMCAvKiBBY3RvclZhbHVlLkRlc3RydWN0aW9uICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDIxIC8qIEFjdG9yVmFsdWUuSWxsdXNpb24gKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMjIgLyogQWN0b3JWYWx1ZS5SZXN0b3JhdGlvbiAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgyMyAvKiBBY3RvclZhbHVlLkVuY2hhbnRpbmcgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoNiAvKiBBY3RvclZhbHVlLk9uZUhhbmRlZCAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCg3IC8qIEFjdG9yVmFsdWUuVHdvSGFuZGVkICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDggLyogQWN0b3JWYWx1ZS5BcmNoZXJ5ICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDkgLyogQWN0b3JWYWx1ZS5CbG9jayAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxMCAvKiBBY3RvclZhbHVlLlNtaXRoaW5nICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDExIC8qIEFjdG9yVmFsdWUuSGVhdnlBcm1vciAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxMiAvKiBBY3RvclZhbHVlLkxpZ2h0QXJtb3IgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTMgLyogQWN0b3JWYWx1ZS5QaWNrcG9ja2V0ICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDE0IC8qIEFjdG9yVmFsdWUuTG9ja3BpY2tpbmcgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTUgLyogQWN0b3JWYWx1ZS5TbmVhayAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxNiAvKiBBY3RvclZhbHVlLkFsY2hlbXkgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTcgLyogQWN0b3JWYWx1ZS5TcGVlY2ggKi8pO1xyXG4gICAgfTtcclxuICAgIERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlLnByb3RvdHlwZS50dXJuT2ZmU2tpbGxMb2NhbEV4cCA9IGZ1bmN0aW9uIChhdikge1xyXG4gICAgICAgIHZhciBhdmkgPSB0aGlzLnNwLkFjdG9yVmFsdWVJbmZvLmdldEFjdG9yVmFsdWVJbmZvQnlJRChhdik7XHJcbiAgICAgICAgaWYgKGF2aSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIk5vdCBmb3VuZCBBY3RvclZhbHVlSW5mbyBmb3IgYWN0b3IgdmFsdWVcIiwgYXYpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGF2aS5zZXRTa2lsbFVzZU11bHQoMCk7XHJcbiAgICAgICAgYXZpLnNldFNraWxsT2Zmc2V0TXVsdCgwKTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICByZXR1cm4gRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UgfSBmcm9tIFwiLi9zd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgV29ybGRDbGVhbmVyU2VydmljZSB9IGZyb20gXCIuL3dvcmxkQ2xlYW5lclNlcnZpY2VcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgRHJvcEl0ZW1TZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKERyb3BJdGVtU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIERyb3BJdGVtU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBjb250cm9sbGVyLm9uKCdjb250YWluZXJDaGFuZ2VkJywgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ29udGFpbmVyQ2hhbmdlZChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRHJvcEl0ZW1TZXJ2aWNlLnByb3RvdHlwZS5vbkNvbnRhaW5lckNoYW5nZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBzd2VldENhbnREcm9wU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UpO1xyXG4gICAgICAgIHZhciBwbCA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICB2YXIgaXNQbGF5ZXIgPSBwbCAmJiBlLm9sZENvbnRhaW5lciAmJiBwbC5nZXRGb3JtSUQoKSA9PT0gZS5vbGRDb250YWluZXIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgdmFyIG5vQ29udGFpbmVyID0gZS5uZXdDb250YWluZXIgPT09IG51bGwgfHwgZS5uZXdDb250YWluZXIgPT09IHVuZGVmaW5lZDtcclxuICAgICAgICB2YXIgaXNSZWZlcmVuY2UgPSBlLnJlZmVyZW5jZSAhPT0gbnVsbDtcclxuICAgICAgICBpZiAoZS5uZXdDb250YWluZXIgJiYgZS5uZXdDb250YWluZXIuZ2V0Rm9ybUlEKCkgPT09IHBsLmdldEZvcm1JRCgpKVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgaWYgKCF0aGlzLnNwLlVpLmlzTWVudU9wZW4oXCJJbnZlbnRvcnlNZW51XCIpKVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgaWYgKGlzUGxheWVyICYmXHJcbiAgICAgICAgICAgIGlzUmVmZXJlbmNlICYmXHJcbiAgICAgICAgICAgIG5vQ29udGFpbmVyICYmXHJcbiAgICAgICAgICAgIHN3ZWV0Q2FudERyb3BTZXJ2aWNlLmNhbkRyb3BPclB1dEl0ZW0oZS5iYXNlT2JqLmdldEZvcm1JRCgpKSkge1xyXG4gICAgICAgICAgICB2YXIgcmFkaXVzID0gMjAwMDtcclxuICAgICAgICAgICAgdmFyIGJhc2VJZCA9IGUuYmFzZU9iai5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgdmFyIHBsYXllciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgdmFyIHNldCA9IG5ldyBTZXQoKTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAyMDA7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlZnJJZCA9IChfYSA9IHRoaXMuc3AuR2FtZS5maW5kUmFuZG9tUmVmZXJlbmNlT2ZUeXBlKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoYmFzZUlkKSwgcGxheWVyLmdldFBvc2l0aW9uWCgpLCBwbGF5ZXIuZ2V0UG9zaXRpb25ZKCksIHBsYXllci5nZXRQb3NpdGlvblooKSwgcmFkaXVzKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnJJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldC5hZGQocmVmcklkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBudW1Gb3VuZF8xID0gMDtcclxuICAgICAgICAgICAgdmFyIHdvcmxkQ2xlYW5lclNlcnZpY2VfMSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihXb3JsZENsZWFuZXJTZXJ2aWNlKTtcclxuICAgICAgICAgICAgc2V0LmZvckVhY2goZnVuY3Rpb24gKHJlZnJJZCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlZiA9IF90aGlzLnNwLk9iamVjdFJlZmVyZW5jZS5mcm9tKF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCAmJiByZWYuaXNEZWxldGVkKCkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZnJJZF8xID0gcmVmLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3b3JsZENsZWFuZXJTZXJ2aWNlXzEuZ2V0V2NQcm90ZWN0aW9uKHJlZnJJZF8xKSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWYuZGVsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICsrbnVtRm91bmRfMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRm91bmQgYW5kIGRlbGV0ZWQgcmVmZXJlbmNlIFwiICsgcmVmcklkXzEudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkZvdW5kIHJlZmVyZW5jZSBcIiArIHJlZnJJZF8xLnRvU3RyaW5nKDE2KSArIFwiIGJ1dCBpdCdzIHByb3RlY3RlZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAoIW51bUZvdW5kXzEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsb2dUcmFjZSh0aGlzLCBcIklnbm9yaW5nIGl0ZW0gZHJvcCBhcyBmYWxzZSBwb3NpdGl2ZVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgdCA9IE1zZ1R5cGUuRHJvcEl0ZW07XHJcbiAgICAgICAgICAgIHZhciBjb3VudCA9IGUubnVtSXRlbXM7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdDogdCxcclxuICAgICAgICAgICAgICAgICAgICBiYXNlSWQ6IGJhc2VJZCxcclxuICAgICAgICAgICAgICAgICAgICBjb3VudDogY291bnQsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIERyb3BJdGVtU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBEcm9wSXRlbVNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgY29udHJvbGxlci5lbWl0dGVyLm9uKFwiZ2FtZUxvYWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uR2FtZUxvYWQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEluQ2hhcmdlbih0cnVlLCB0cnVlLCBmYWxzZSk7XHJcbiAgICB9O1xyXG4gICAgRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZS5wcm90b3R5cGUub25HYW1lTG9hZCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRJbkNoYXJnZW4odHJ1ZSwgdHJ1ZSwgZmFsc2UpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgYXV0aEdhbWVEYXRhU3RvcmFnZUtleSB9IGZyb20gXCIuLi8uLi9mZWF0dXJlcy9hdXRoTW9kZWxcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEZyb250SG90UmVsb2FkU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEZyb250SG90UmVsb2FkU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICB2YXIgZW5hYmxlID0gISFfdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJlbmFibGUtZnJvbnQtaG90cmVsb2FkXCJdO1xyXG4gICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcImVuYWJsZS1mcm9udC1ob3RyZWxvYWQgaXNcIiwgZW5hYmxlKTtcclxuICAgICAgICBpZiAoIWVuYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFRPRE86IHJlZmFjdG9yIG91dCB2ZXJ5IHNpbWlsYXIgY29kZSBpbiBza3ltcENsaWVudC50c1xyXG4gICAgICAgIHZhciBhdXRoR2FtZURhdGEgPSBfdGhpcy5zcC5zdG9yYWdlW2F1dGhHYW1lRGF0YVN0b3JhZ2VLZXldO1xyXG4gICAgICAgIHZhciBzdG9yYWdlSGFzVmFsaWRBdXRoR2FtZURhdGEgPSAoYXV0aEdhbWVEYXRhID09PSBudWxsIHx8IGF1dGhHYW1lRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aEdhbWVEYXRhLmxvY2FsKSB8fCAoYXV0aEdhbWVEYXRhID09PSBudWxsIHx8IGF1dGhHYW1lRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aEdhbWVEYXRhLnJlbW90ZSk7XHJcbiAgICAgICAgaWYgKHN0b3JhZ2VIYXNWYWxpZEF1dGhHYW1lRGF0YSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJSZWNvdmVyZWQgQXV0aEdhbWVEYXRhIGZyb20gc3RvcmFnZSwgc3RhcnRpbmcgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlXCIpO1xyXG4gICAgICAgICAgICBfdGhpcy5jb25uZWN0VG9Gcm9udEhvdFJlbG9hZCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiVW5hYmxlIHRvIHJlY292ZXIgQXV0aEdhbWVEYXRhIGZyb20gc3RvcmFnZSwgd2FpdGluZyBmb3IgYXV0aFwiKTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiYXV0aEF0dGVtcHRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQXV0aEF0dGVtcHQoZSk7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBGcm9udEhvdFJlbG9hZFNlcnZpY2UucHJvdG90eXBlLm9uQXV0aEF0dGVtcHQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuY29ubmVjdFRvRnJvbnRIb3RSZWxvYWQoKTtcclxuICAgIH07XHJcbiAgICBGcm9udEhvdFJlbG9hZFNlcnZpY2UucHJvdG90eXBlLmNvbm5lY3RUb0Zyb250SG90UmVsb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdXJsID0gXCJsb2NhbGhvc3Q6MTIzNFwiO1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJMb2FkaW5nIHVybFwiLCB1cmwpO1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5icm93c2VyLmxvYWRVcmwodXJsKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gRnJvbnRIb3RSZWxvYWRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEZyb250SG90UmVsb2FkU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQsIHJlbW90ZUlkVG9Mb2NhbElkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuLy8gVGhlIHJlYXNvbiB3ZSB1c2UgZ2xvYmFsIHNreXJpbVBsYXRmb3JtIGlzIHRoYXQgdGhpcy5zcCBtYXkgYmUgbGltaXRlZCwgYW5kIGdhbWVtb2RlIGFwaSBuZWVkcyB1bmxpbWl0ZWQgYWNjZXNzIHRvIHNreXJpbVBsYXRmb3JtXHJcbi8vIFNsaWd0aGx5IGRpZmZlcmVudCB0eXBlc1xyXG5pbXBvcnQgKiBhcyBza3lyaW1QbGF0Zm9ybSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlXCI7XHJcbnZhciBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnNldHVwRXZlbnRTb3VyY2UgPSBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBjdHguX2ZuKGN0eCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiJ2V2ZW50U291cmNlc1wiLCBjdHguX2V2ZW50TmFtZSwgXCItIEFkZGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCInZXZlbnRTb3VyY2VzXCIsIGN0eC5fZXZlbnROYW1lLCBcIi1cIiwgZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoX3RoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddKSkge1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10gPSBfdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10uZmlsdGVyKGZ1bmN0aW9uIChjdHgpIHsgcmV0dXJuICFjdHguX2V4cGlyZWQ7IH0pO1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10uZm9yRWFjaChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zZXR1cEV2ZW50U291cmNlKGN0eCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICh0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImRpc2FibGUtZ2FtZW1vZGUtdXBkYXRlc1wiXSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5zdG9yYWdlWydHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZV9zYXdFdmVudFNvdXJjZXMnXSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJHYW1lbW9kZSB1cGRhdGVzIGFyZSBkaXNhYmxlZCBieSBzZXR0aW5nc1wiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkdhbWVtb2RlIHVwZGF0ZXMgYXJlIGRpc2FibGVkIGJ5IHNldHRpbmdzIC0gcHJvY2Vzc2luZyBmaXJzdCB1cGRhdGUgb25seVwiKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlWydHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZV9zYXdFdmVudFNvdXJjZXMnXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXSkpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10gPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddLmZvckVhY2goZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgY3R4LnNlbmRFdmVudCA9IGZ1bmN0aW9uICgpIHsgfTtcclxuICAgICAgICAgICAgICAgIGN0eC5fZXhwaXJlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZXZlbnRTb3VyY2VzUmVjb3JkID0ge307XHJcbiAgICAgICAgZXZlbnQubWVzc2FnZS5ldmVudFNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbiAocGFpcikgeyByZXR1cm4gZXZlbnRTb3VyY2VzUmVjb3JkW3BhaXIubmFtZV0gPSBwYWlyLmNvbnRlbnQ7IH0pO1xyXG4gICAgICAgIHZhciBldmVudE5hbWVzID0gT2JqZWN0LmtleXMoZXZlbnRTb3VyY2VzUmVjb3JkKTtcclxuICAgICAgICB2YXIgYmxvY2tlZEV2ZW50U291cmNlcyA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiYmxvY2tlZEV2ZW50U291cmNlc1wiXTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShibG9ja2VkRXZlbnRTb3VyY2VzKSkge1xyXG4gICAgICAgICAgICBibG9ja2VkRXZlbnRTb3VyY2VzLmZvckVhY2goZnVuY3Rpb24gKGJsb2NrZWRFdmVudFNvdXJjZSkge1xyXG4gICAgICAgICAgICAgICAgZXZlbnROYW1lcyA9IGV2ZW50TmFtZXMuZmlsdGVyKGZ1bmN0aW9uIChldmVudE5hbWUpIHsgcmV0dXJuIGV2ZW50TmFtZSAhPT0gYmxvY2tlZEV2ZW50U291cmNlOyB9KTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIidldmVudFNvdXJjZXNcIiwgYmxvY2tlZEV2ZW50U291cmNlLCBcIi0gQmxvY2tlZCBieSB0aGUgY2xpZW50XCIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgIGV2ZW50TmFtZXMuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnROYW1lKSB7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBzZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UudmVyaWZ5U2VydmVySnMoZXZlbnRTb3VyY2VzUmVjb3JkW2V2ZW50TmFtZV0pO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0LnNyYyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiJ2V2ZW50U291cmNlc1wiLCBldmVudE5hbWUsICdWZXJpZmljYXRpb24gZmFpbGVkOicsIHJlc3VsdC5lcnJvcik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBmbiA9IG5ldyBGdW5jdGlvbignY3R4JywgcmVzdWx0LnNyYyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgY3R4ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnI6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgICAgIF9tb2RlbDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgICAgIF92aWV3OiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgaTogLTEsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoX3Byb3BOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImN0eC5nZXQgY2FuJ3QgYmUgdXNlZCBpbiBldmVudCBzb3VyY2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICByZXNwYXduOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImN0eC5yZXNwYXduIGNhbid0IGJlIHVzZWQgaW4gZXZlbnQgc291cmNlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgc3A6IHNreXJpbVBsYXRmb3JtLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbmRFdmVudDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21FdmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NKc29uRHVtcHM6IGFyZ3MubWFwKGZ1bmN0aW9uIChhcmcpIHsgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZyk7IH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnROYW1lOiBldmVudE5hbWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGdldEZvcm1JZEluU2VydmVyRm9ybWF0OiBmdW5jdGlvbiAoY2xpZW50c2lkZUZvcm1JZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxJZFRvUmVtb3RlSWQoY2xpZW50c2lkZUZvcm1JZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBnZXRGb3JtSWRJbkNsaWVudEZvcm1hdDogZnVuY3Rpb24gKHNlcnZlcnNpZGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbW90ZUlkVG9Mb2NhbElkKHNlcnZlcnNpZGVGb3JtSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgX2ZuOiBmbixcclxuICAgICAgICAgICAgICAgICAgICBfZXZlbnROYW1lOiBldmVudE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGU6IHt9LFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXS5wdXNoKGN0eCk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zZXR1cEV2ZW50U291cmNlKGN0eCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIidldmVudFNvdXJjZXNcIiwgZXZlbnROYW1lLCBcIi1cIiwgZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi9yZW1vdGVTZXJ2ZXJcIjtcclxuLy8gVE9ETzogcmVmYWN0b3JcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQsIHJlbW90ZUlkVG9Mb2NhbElkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG4vLyBUaGUgcmVhc29uIHdlIHVzZSBnbG9iYWwgc2t5cmltUGxhdGZvcm0gaXMgdGhhdCB0aGlzLnNwIG1heSBiZSBsaW1pdGVkLCBhbmQgZ2FtZW1vZGUgYXBpIG5lZWRzIHVubGltaXRlZCBhY2Nlc3MgdG8gc2t5cmltUGxhdGZvcm1cclxuLy8gU2xpZ3RobHkgZGlmZmVyZW50IHR5cGVzXHJcbmltcG9ydCAqIGFzIHNreXJpbVBsYXRmb3JtIGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2VcIjtcclxudmFyIEdhbWVtb2RlVXBkYXRlU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhHYW1lbW9kZVVwZGF0ZVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBHYW1lbW9kZVVwZGF0ZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3JlYXRlQWN0b3JNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblRpY2soKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBfdGhpcy51cGRhdGVPd25lckN0eCA9IHtcclxuICAgICAgICAgICAgc3A6IHNreXJpbVBsYXRmb3JtLFxyXG4gICAgICAgICAgICByZWZyOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIHZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIF9tb2RlbDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBnZXRGb3JtSWRJblNlcnZlckZvcm1hdDogZnVuY3Rpb24gKGNsaWVudHNpZGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbElkVG9SZW1vdGVJZChjbGllbnRzaWRlRm9ybUlkKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0Rm9ybUlkSW5DbGllbnRGb3JtYXQ6IGZ1bmN0aW9uIChzZXJ2ZXJzaWRlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3RlSWRUb0xvY2FsSWQoc2VydmVyc2lkZUZvcm1JZCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKHByb3BOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxbcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzdGF0ZToge30sXHJcbiAgICAgICAgICAgIF92aWV3OiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGk6IC0xLFxyXG4gICAgICAgICAgICByZXNwYXduOiBmdW5jdGlvbiAoKSB7IHRocm93IG5ldyBFcnJvcihcImN0eC5yZXNwYXduIGlzIG5vdCBhdmFpbGFibGUgZm9yIHVwZGF0ZU93bmVyXCIpOyB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy51cGRhdGVOZWlnaGJvckN0eCA9IHtcclxuICAgICAgICAgICAgcmVmcjogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBfbW9kZWw6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgc3A6IHNreXJpbVBsYXRmb3JtLFxyXG4gICAgICAgICAgICBzdGF0ZTogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBfdmlldzogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBpOiAtMSxcclxuICAgICAgICAgICAgZ2V0Rm9ybUlkSW5TZXJ2ZXJGb3JtYXQ6IGZ1bmN0aW9uIChjbGllbnRzaWRlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxJZFRvUmVtb3RlSWQoY2xpZW50c2lkZUZvcm1JZCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGdldEZvcm1JZEluQ2xpZW50Rm9ybWF0OiBmdW5jdGlvbiAoc2VydmVyc2lkZUZvcm1JZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbW90ZUlkVG9Mb2NhbElkKHNlcnZlcnNpZGVGb3JtSWQpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChwcm9wTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vZGVsW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVzcGF3bjogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fdmlldy5kZXN0cm95Rm9ybSh0aGlzLmkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9uc0tleXMgPSBbXTtcclxuICAgICAgICBfdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9ucyA9IHt9O1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUuc2V0Rm9ybVZpZXdBcnJheSA9IGZ1bmN0aW9uIChmb3JtVmlld0FycmF5KSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckN0eC5fdmlldyA9IGZvcm1WaWV3QXJyYXk7XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5zZXRJID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4LmkgPSBpO1xyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUudXBkYXRlTmVpZ2hib3IgPSBmdW5jdGlvbiAocmVmciwgbW9kZWwsIHN0YXRlKSB7XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfYSA9IHRoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNLZXlzOyBfaSA8IF9hLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIga2V5ID0gX2FbX2ldO1xyXG4gICAgICAgICAgICB2YXIgdiA9IG1vZGVsW2tleV07XHJcbiAgICAgICAgICAgIC8vIEFjY29yZGluZyB0byBkb2NzOlxyXG4gICAgICAgICAgICAvLyBJbiBgdXBkYXRlT3duZXJgL2B1cGRhdGVOZWlnaGJvcmAgZXF1YWxzIHRvIGEgdmFsdWUgb2YgYSBjdXJyZW50bHkgcHJvY2Vzc2VkIHByb3BlcnR5LlxyXG4gICAgICAgICAgICAvLyBDYW4ndCBiZSBgdW5kZWZpbmVkYCBoZXJlLCBzaW5jZSB1cGRhdGVzIGFyZSBub3QgcmVjZWl2ZWQgZm9yIGB1bmRlZmluZWRgIHByb3BlcnR5IHZhbHVlcy5cclxuICAgICAgICAgICAgLy8gSW4gb3RoZXIgY29udGV4dHMgaXMgYWx3YXlzIGB1bmRlZmluZWRgLlxyXG4gICAgICAgICAgICBpZiAodiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4LnJlZnIgPSByZWZyO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckN0eC52YWx1ZSA9IHY7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4Ll9tb2RlbCA9IG1vZGVsO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckN0eC5zdGF0ZSA9IHN0YXRlO1xyXG4gICAgICAgICAgICAgICAgdmFyIGYgPSB0aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zW2tleV07XHJcbiAgICAgICAgICAgICAgICAvLyBBY3R1YWxseSwgJ2YnIHNob3VsZCBhbHdheXMgYmUgYSB2YWxpZCBmdW5jdGlvbiwgYnV0IHdobyBrbm93c1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMudXBkYXRlTmVpZ2hib3JDdHgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJ1cGRhdGVOZWlnaGJvclwiLCBrZXksICctJywgZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICBpZiAodGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJkaXNhYmxlLWdhbWVtb2RlLXVwZGF0ZXNcIl0pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3Auc3RvcmFnZVsnR2FtZW1vZGVVcGRhdGVTZXJ2aWNlX3Nhd1VwZGF0ZUZ1bmN0aW9ucyddID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkdhbWVtb2RlIHVwZGF0ZXMgYXJlIGRpc2FibGVkIGJ5IHNldHRpbmdzXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiR2FtZW1vZGUgdXBkYXRlcyBhcmUgZGlzYWJsZWQgYnkgc2V0dGluZ3MgLSBwcm9jZXNzaW5nIGZpcnN0IHVwZGF0ZSBvbmx5XCIpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbJ0dhbWVtb2RlVXBkYXRlU2VydmljZV9zYXdVcGRhdGVGdW5jdGlvbnMnXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3Auc3RvcmFnZVsndXBkYXRlTmVpZ2hib3JGdW5jdGlvbnMnXSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbJ3VwZGF0ZU93bmVyRnVuY3Rpb25zJ10gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy51cGRhdGVHYW1lbW9kZVVwZGF0ZUZ1bmN0aW9ucygndXBkYXRlTmVpZ2hib3JGdW5jdGlvbnMnLCBldmVudC5tZXNzYWdlLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZUdhbWVtb2RlVXBkYXRlRnVuY3Rpb25zKCd1cGRhdGVPd25lckZ1bmN0aW9ucycsIGV2ZW50Lm1lc3NhZ2UudXBkYXRlT3duZXJGdW5jdGlvbnMpO1xyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUub25DcmVhdGVBY3Rvck1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICghZXZlbnQubWVzc2FnZS5pc01lKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gT3RoZXJ3aXNlIHdvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCBtYXkgYmUgdW5hc3NpZ25lZFxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByZW1vdGVTZXJ2ZXIgPSBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJlbW90ZVNlcnZlcik7XHJcbiAgICAgICAgICAgIHZhciB3b3JsZE1vZGVsID0gcmVtb3RlU2VydmVyLmdldFdvcmxkTW9kZWwoKTtcclxuICAgICAgICAgICAgdmFyIG15Rm9ybU1vZGVsID0gd29ybGRNb2RlbC5mb3Jtc1t3b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHhdO1xyXG4gICAgICAgICAgICBpZiAoIW15Rm9ybU1vZGVsKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJVbmFibGUgdG8gZmluZCBmb3JtTW9kZWwgd2l0aCBpbmRleFwiLCB3b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF90aGlzLnNldE93bmVyTW9kZWwobXlGb3JtTW9kZWwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUub25UaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBrZXlzID0gdGhpcy5zcC5zdG9yYWdlW1widXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNfa2V5c1wiXTtcclxuICAgICAgICBpZiAoa2V5cyAmJiBBcnJheS5pc0FycmF5KGtleXMpKSB7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNLZXlzID0ga2V5cztcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNLZXlzID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFRPRE86IFNob3VsZG4ndCB3ZSBjaGVjayBzdG9yYWdlIHZhbHVlIGJlZm9yZSBhc3NpZ25tZW50P1xyXG4gICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnMgPSB0aGlzLnNwLnN0b3JhZ2VbXCJ1cGRhdGVOZWlnaGJvckZ1bmN0aW9uc1wiXTtcclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBwbGF5ZXJSZWYgPSB0aGlzLnNwLk9iamVjdFJlZmVyZW5jZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgdmFyIGtleXMgPSB0aGlzLnNwLnN0b3JhZ2VbXCJ1cGRhdGVPd25lckZ1bmN0aW9uc19rZXlzXCJdO1xyXG4gICAgICAgIGlmICgha2V5cyB8fCAhQXJyYXkuaXNBcnJheShrZXlzKSkge1xyXG4gICAgICAgICAgICBrZXlzID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBmdW5jcyA9IHRoaXMuc3Auc3RvcmFnZVtcInVwZGF0ZU93bmVyRnVuY3Rpb25zXCJdO1xyXG4gICAgICAgIGlmICh0aGlzLnNwLnN0b3JhZ2VbXCJvd25lck1vZGVsU2V0XCJdICE9PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG93bmVyTW9kZWwgPSB0aGlzLnNwLnN0b3JhZ2VbXCJvd25lck1vZGVsXCJdO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwga2V5c18xID0ga2V5czsgX2kgPCBrZXlzXzEubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IGtleXNfMVtfaV07XHJcbiAgICAgICAgICAgIHZhciBmID0gZnVuY3NbcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICAvLyBBY3R1YWxseSwgbXVzdCBhbHdheXMgYmUgYSB2YWxpZCBmdW5jaXRvbiwgYnV0IHdobyBrbm93c1xyXG4gICAgICAgICAgICBpZiAoIWYpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlT3duZXJDdHguX21vZGVsID0gb3duZXJNb2RlbDtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLnVwZGF0ZU93bmVyQ3R4Ll9tb2RlbCkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51cGRhdGVPd25lckN0eC52YWx1ZSA9IHRoaXMudXBkYXRlT3duZXJDdHguX21vZGVsW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgaWYgKHRoaXMudXBkYXRlT3duZXJDdHgudmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51cGRhdGVPd25lckN0eC5yZWZyID0gcGxheWVyUmVmO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU93bmVyQ3R4Ll9tb2RlbCA9IG93bmVyTW9kZWw7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGYodGhpcy51cGRhdGVPd25lckN0eCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwidXBkYXRlT3duZXJcIiwgcHJvcE5hbWUsICctJywgZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5zZXRPd25lck1vZGVsID0gZnVuY3Rpb24gKG93bmVyTW9kZWwpIHtcclxuICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJvd25lck1vZGVsXCJdID0gb3duZXJNb2RlbDtcclxuICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJvd25lck1vZGVsU2V0XCJdID0gdHJ1ZTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLnVwZGF0ZUdhbWVtb2RlVXBkYXRlRnVuY3Rpb25zID0gZnVuY3Rpb24gKHN0b3JhZ2VWYXIsIGZ1bmN0aW9uU291cmNlcykge1xyXG4gICAgICAgIHZhciBzZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICB2YXIgZnVuY3Rpb25Tb3VyY2VzUmVjb3JkID0ge307XHJcbiAgICAgICAgZnVuY3Rpb25Tb3VyY2VzLmZvckVhY2goZnVuY3Rpb24gKHBhaXIpIHsgcmV0dXJuIGZ1bmN0aW9uU291cmNlc1JlY29yZFtwYWlyLm5hbWVdID0gcGFpci5jb250ZW50OyB9KTtcclxuICAgICAgICB0aGlzLnNwLnN0b3JhZ2Vbc3RvcmFnZVZhcl0gPSBmdW5jdGlvblNvdXJjZXNSZWNvcmQ7XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfYSA9IE9iamVjdC5rZXlzKGZ1bmN0aW9uU291cmNlc1JlY29yZCk7IF9pIDwgX2EubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IF9hW19pXTtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZS52ZXJpZnlTZXJ2ZXJKcyh0aGlzLnNwLnN0b3JhZ2Vbc3RvcmFnZVZhcl1bcHJvcE5hbWVdKTtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdC5zcmMgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIHN0b3JhZ2VWYXIsIHByb3BOYW1lLCAnVmVyaWZpY2F0aW9uIGZhaWxlZDonLCByZXN1bHQuZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc3Auc3RvcmFnZVtzdG9yYWdlVmFyXVtwcm9wTmFtZV07XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW3N0b3JhZ2VWYXJdW3Byb3BOYW1lXSA9IG5ldyBGdW5jdGlvbignY3R4JywgcmVzdWx0LnNyYyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgZW1wdHlGdW5jdGlvbiA9IGZ1bmN0aW9uU291cmNlc1JlY29yZFtwcm9wTmFtZV0gPT09ICcnO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVtcHR5RnVuY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zcC5zdG9yYWdlW3N0b3JhZ2VWYXJdW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBzdG9yYWdlVmFyLCBwcm9wTmFtZSwgJ0FkZGVkIGVtcHR5Jyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBzdG9yYWdlVmFyLCBwcm9wTmFtZSwgJ0FkZGVkJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIHN0b3JhZ2VWYXIsIHByb3BOYW1lLCBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJcIi5jb25jYXQoc3RvcmFnZVZhciwgXCJfa2V5c1wiKV0gPSBPYmplY3Qua2V5cyh0aGlzLnNwLnN0b3JhZ2Vbc3RvcmFnZVZhcl0pO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBHYW1lbW9kZVVwZGF0ZVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHRoaXMgb3V0XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBzdG9yYWdlIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG52YXIgSGl0U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhIaXRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gSGl0U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5yZWNlbnRNYWdpY0hpdHMgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgY29udHJvbGxlci5vbignaGl0JywgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uSGl0KGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBIaXRTZXJ2aWNlLnByb3RvdHlwZS5vbkhpdCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgLy8gVE9ETzogYWRkIG1vcmUgbG9nZ2luZyBpbiBjYXNlIG9mICdyZXR1cm4nXHJcbiAgICAgICAgLy8gVE9ETzogYWxsb3cgbm9uLXdlYXBvbiBzb3VyY2VzXHJcbiAgICAgICAgdmFyIGFnZ3Jlc3NvciA9IGUuYWdncmVzc29yLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIGlmIChhZ2dyZXNzb3IgPCAweGZmMDAwMDAwICYmIGFnZ3Jlc3NvciAhPT0gMHgxNClcclxuICAgICAgICAgICAgcmV0dXJuOyAvLyBhbGwgc2t5bXAgbnBjcyBhcmUgRkYrXHJcbiAgICAgICAgaWYgKGFnZ3Jlc3NvciA+PSAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IG1ha2UgaG9zdCBzZXJ2aWNlXHJcbiAgICAgICAgICAgIHZhciBob3N0ZWQgPSBzdG9yYWdlWydob3N0ZWQnXTtcclxuICAgICAgICAgICAgdmFyIGFscmVhZHlIb3N0ZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaG9zdGVkKSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlbW90ZUlkID0gbG9jYWxJZFRvUmVtb3RlSWQoYWdncmVzc29yKTtcclxuICAgICAgICAgICAgICAgIGlmIChob3N0ZWQuaW5jbHVkZXMocmVtb3RlSWQpIHx8IGhvc3RlZC5pbmNsdWRlcyhyZW1vdGVJZCArIDB4MTAwMDAwMDAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFscmVhZHlIb3N0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghYWxyZWFkeUhvc3RlZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBiYXNlID0gZS50YXJnZXQuZ2V0QmFzZU9iamVjdCgpO1xyXG4gICAgICAgIHZhciB0eXBlID0gYmFzZSA9PT0gbnVsbCB8fCBiYXNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBiYXNlLmdldFR5cGUoKTtcclxuICAgICAgICBpZiAodHlwZSA9PT0gMzQgLyogRm9ybVR5cGUuU3RhdGljICovIHx8IHR5cGUgPT09IDM2IC8qIEZvcm1UeXBlLk1vdmFibGVTdGF0aWMgKi8pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgaXNXZWFwb24gPSB0aGlzLnNwLldlYXBvbi5mcm9tKGUuc291cmNlKTtcclxuICAgICAgICB2YXIgaXNTcGVsbCA9ICFpc1dlYXBvbiAmJiB0aGlzLnNwLlNwZWxsLmZyb20oZS5zb3VyY2UpO1xyXG4gICAgICAgIHZhciBpc1Njcm9sbCA9ICFpc1dlYXBvbiAmJiAhaXNTcGVsbCAmJiB0aGlzLnNwLlNjcm9sbC5mcm9tKGUuc291cmNlKTtcclxuICAgICAgICBpZiAoIWlzV2VhcG9uICYmICFpc1NwZWxsICYmICFpc1Njcm9sbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHByZXZlbnQgZG91YmxlIGhpdCB0aGF0IGhhcHBlbnMgZm9yIHNvbWUgcmVhc29uIHdpdGggbWFnaWMgcHJvamVjdGlsZXNcclxuICAgICAgICBpZiAoaXNTcGVsbCB8fCBpc1Njcm9sbCkge1xyXG4gICAgICAgICAgICB2YXIgYWdncmVzc29ySWQgPSBlLmFnZ3Jlc3Nvci5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgIHZhciBsYXN0SGl0VGltZSA9IHRoaXMucmVjZW50TWFnaWNIaXRzLmdldChhZ2dyZXNzb3JJZCk7XHJcbiAgICAgICAgICAgIGlmIChsYXN0SGl0VGltZSAmJiBub3cgLSBsYXN0SGl0VGltZSA8IDEwMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVjZW50TWFnaWNIaXRzLnNldChhZ2dyZXNzb3JJZCwgbm93KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogeyB0OiBNc2dUeXBlLk9uSGl0LCBkYXRhOiB0aGlzLmdldEhpdERhdGEoZSkgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIEhpdFNlcnZpY2UucHJvdG90eXBlLmdldEhpdERhdGEgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBoaXREYXRhID0ge1xyXG4gICAgICAgICAgICBhZ2dyZXNzb3I6IGxvY2FsSWRUb1JlbW90ZUlkKGUuYWdncmVzc29yLmdldEZvcm1JRCgpKSxcclxuICAgICAgICAgICAgaXNCYXNoQXR0YWNrOiBlLmlzQmFzaEF0dGFjayxcclxuICAgICAgICAgICAgaXNIaXRCbG9ja2VkOiBlLmlzSGl0QmxvY2tlZCxcclxuICAgICAgICAgICAgaXNQb3dlckF0dGFjazogZS5pc1Bvd2VyQXR0YWNrLFxyXG4gICAgICAgICAgICBpc1NuZWFrQXR0YWNrOiBlLmlzU25lYWtBdHRhY2ssXHJcbiAgICAgICAgICAgIHByb2plY3RpbGU6IGUucHJvamVjdGlsZSA/IGUucHJvamVjdGlsZS5nZXRGb3JtSUQoKSA6IDAsXHJcbiAgICAgICAgICAgIHNvdXJjZTogZS5zb3VyY2UgPyBlLnNvdXJjZS5nZXRGb3JtSUQoKSA6IDAsXHJcbiAgICAgICAgICAgIHRhcmdldDogbG9jYWxJZFRvUmVtb3RlSWQoZS50YXJnZXQuZ2V0Rm9ybUlEKCkpXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gaGl0RGF0YTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gSGl0U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBIaXRTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBLZXlib2FyZEV2ZW50c1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoS2V5Ym9hcmRFdmVudHNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gS2V5Ym9hcmRFdmVudHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmxhc3ROdW1LZXlzID0gMDtcclxuICAgICAgICBjb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEtleWJvYXJkRXZlbnRzU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbnVtS2V5cyA9IHRoaXMuc3AuSW5wdXQuZ2V0TnVtS2V5c1ByZXNzZWQoKTtcclxuICAgICAgICBpZiAodGhpcy5sYXN0TnVtS2V5cyAhPT0gbnVtS2V5cykge1xyXG4gICAgICAgICAgICB0aGlzLmxhc3ROdW1LZXlzID0gbnVtS2V5cztcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInF1ZXJ5S2V5Q29kZUJpbmRpbmdzXCIsIHtcclxuICAgICAgICAgICAgICAgIGlzRG93bjogZnVuY3Rpb24gKGJpbmRpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZy5ldmVyeShmdW5jdGlvbiAoa2V5KSB7IHJldHVybiBfdGhpcy5zcC5JbnB1dC5pc0tleVByZXNzZWQoa2V5KTsgfSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBLZXlib2FyZEV2ZW50c1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgS2V5Ym9hcmRFdmVudHNTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIExhc3RJbnZTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKExhc3RJbnZTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTGFzdEludlNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExhc3RJbnZTZXJ2aWNlLnByb3RvdHlwZSwgXCJsYXN0SW52XCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xhc3RJbnY7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uIChuZXdWYWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9sYXN0SW52ID0gbmV3VmFsdWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIExhc3RJbnZTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IExhc3RJbnZTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBMb2FkR2FtZVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTG9hZEdhbWVTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTG9hZEdhbWVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLl9pc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm0gPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwibG9hZEdhbWVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25Mb2FkR2FtZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBMb2FkR2FtZVNlcnZpY2UucHJvdG90eXBlLmxvYWRHYW1lID0gZnVuY3Rpb24gKHBvcywgcm90LCB3b3JsZE9yQ2VsbCwgY2hhbmdlRm9ybU5wYywgbG9hZE9yZGVyLCB0aW1lKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICB0aGlzLnNwLmxvYWRHYW1lKHBvcywgcm90LCB3b3JsZE9yQ2VsbCwgY2hhbmdlRm9ybU5wYywgbG9hZE9yZGVyLCB0aW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgLy8gSG90Zml4IG5vbi12YW5pbGxhIGhlYWRwYXJ0cyBidWdcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICB0aGlzLnNwLmxvYWRHYW1lKHBvcywgcm90LCB3b3JsZE9yQ2VsbCwgdW5kZWZpbmVkLCBsb2FkT3JkZXIsIHRpbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9pc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm0gPSB0cnVlO1xyXG4gICAgfTtcclxuICAgIExvYWRHYW1lU2VydmljZS5wcm90b3R5cGUub25Mb2FkR2FtZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHZhciBnYW1lTG9hZEV2ZW50ID0ge1xyXG4gICAgICAgICAgICAgICAgaXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtOiB0aGlzLl9pc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImdhbWVMb2FkXCIsIGdhbWVMb2FkRXZlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuX2lzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgX3RoaXMuX2lzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybSA9IGZhbHNlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBMb2FkR2FtZVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgTG9hZEdhbWVTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBHYW1lLCBVdGlsaXR5LCBwcmludENvbnNvbGUsIGNyZWF0ZVRleHQsIHNldFRleHRTaXplIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGdldFNjcmVlblJlc29sdXRpb24gfSBmcm9tIFwiLi4vLi4vdmlldy9mb3JtVmlld1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSBcIi4vc2V0dGluZ3NTZXJ2aWNlXCI7XHJcbnZhciBTVEFURV9LRVkgPSAnbG9hZE9yZGVyQ2hlY2tTdGF0ZSc7XHJcbjtcclxudmFyIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnZlcmlmeUxvYWRPcmRlcigpO1xyXG4gICAgfTtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnZlcmlmeUxvYWRPcmRlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBzZXR0aW5nc1NlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2V0dGluZ3NTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLnJlc2V0VGV4dCgpO1xyXG4gICAgICAgIHZhciBjbGllbnRNb2RzID0gdGhpcy5nZXRDbGllbnRNb2RzKCk7XHJcbiAgICAgICAgdGhpcy5wcmludE1vZE9yZGVyKCdDbGllbnQgbG9hZCBvcmRlcjonLCBjbGllbnRNb2RzKTtcclxuICAgICAgICByZXR1cm4gc2V0dGluZ3NTZXJ2aWNlLmdldFNlcnZlck1vZHMoKVxyXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoc2VydmVyTW9kcykge1xyXG4gICAgICAgICAgICBfdGhpcy5wcmludE1vZE9yZGVyKCdTZXJ2ZXIgbG9hZCBvcmRlcjonLCBzZXJ2ZXJNb2RzKTtcclxuICAgICAgICAgICAgaWYgKGNsaWVudE1vZHMubGVuZ3RoIDwgc2VydmVyTW9kcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1pc3Npbmcgc29tZSBzZXJ2ZXIgbW9kcy4gU2VydmVyIGhhcyBcIi5jb25jYXQoc2VydmVyTW9kcy5sZW5ndGgsIFwiLCB3ZSBoYXZlIFwiKS5jb25jYXQoY2xpZW50TW9kcy5sZW5ndGgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY2xpZW50TW9kcy5sZW5ndGggPiBzZXJ2ZXJNb2RzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMudXBkYXRlVGV4dCgnTE9BRCBPUkRFUiBXQVJOSU5HOiB5b3UgaGF2ZSBtb3JlIG1vZHMgdGhhbiBzZXJ2ZXIhXFxuKG9yIGNvdWxkIG5vdCByZWNlaXZlIHNlcnZlciBtb2QgbGlzdClcXG5DaGVjayBjb25zb2xlIGZvciBkZXRhaWxzLicsIFsyNTUsIDI1NSwgMCwgMV0sIDUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBmYWlsID0gW107XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VydmVyTW9kcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgLy8gTmVlZCBjYXNlLWluc2Vuc2l0aXZlIGNoZWNrIGZvciAxLjYrXHJcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50TW9kc1tpXS5maWxlbmFtZS50b0xvd2VyQ2FzZSgpICE9PSBzZXJ2ZXJNb2RzW2ldLmZpbGVuYW1lLnRvTG93ZXJDYXNlKCkgfHxcclxuICAgICAgICAgICAgICAgICAgICBjbGllbnRNb2RzW2ldLnNpemUgIT09IHNlcnZlck1vZHNbaV0uc2l6ZSB8fFxyXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudE1vZHNbaV0uY3JjMzIgIT09IHNlcnZlck1vZHNbaV0uY3JjMzIpIHtcclxuICAgICAgICAgICAgICAgICAgICBmYWlsLnB1c2goaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiXCIuY29uY2F0KGksIFwiLXRoIG1vZCAobnVtYmVyZWQgZnJvbSAwKSBkb2VzIG5vdCBtYXRjaC5cIikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlNlcnZlciBoYXMgXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KHNlcnZlck1vZHNbaV0pKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiV2UgaGF2ZSBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkoY2xpZW50TW9kc1tpXSkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZmFpbC5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTG9hZCBvcmRlciBjaGVjayBmYWlsZWQhIEluZGljZXM6ICcgKyBKU09OLnN0cmluZ2lmeShmYWlsKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICBwcmludENvbnNvbGUoZXJyKTtcclxuICAgICAgICAgICAgaWYgKF90aGlzLnNwLnNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ2lnbm9yZUxvYWRPcmRlck1pc21hdGNoJ10pIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZVRleHQoJ0xPQUQgT1JERVIgRVJST1IhXFxuSG93ZXZlciwgaWdub3JpbmcgaXQgYmVjYXVzZSBvZiBpZ25vcmVMb2FkT3JkZXJNaXNtYXRjaCBiZWluZyBzZXQuJyArXHJcbiAgICAgICAgICAgICAgICAgICAgJ1xcbkV4cGVjdCBFVkVSWVRISU5HIEJSRUFLLCB1bmxlc3MgeW91IGtub3cgd2hhdCB5b3UgYXJlIGRvaW5nLlxcbkNoZWNrIGNvbnNvbGUgZm9yIGRldGFpbHMuJyArXHJcbiAgICAgICAgICAgICAgICAgICAgJ1xcblRoaXMgbWVzc2FnZSB3aWxsIGRpc2FwcGVhciBhZnRlciAzMCBzZWNvbmRzLicsIFsyNTUsIDAsIDAsIDFdLCAzMCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX3RoaXMudXBkYXRlVGV4dCgnTE9BRCBPUkRFUiBFUlJPUiFcXG5DaGVjayBjb25zb2xlIGZvciBkZXRhaWxzLicsIFsyNTUsIDAsIDAsIDFdKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHRoaXMuc3Auc3RvcmFnZVtTVEFURV9LRVldICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICByZXR1cm4ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLnNwLnN0b3JhZ2VbU1RBVEVfS0VZXTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChyZXBsYWNlbWVudCkge1xyXG4gICAgICAgIHZhciBvbGRTdGF0ZSA9IHRoaXMuc3Auc3RvcmFnZVtTVEFURV9LRVldID0gdGhpcy5nZXRTdGF0ZSgpO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSBPYmplY3QuZW50cmllcyhyZXBsYWNlbWVudCk7IF9pIDwgX2EubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBfYiA9IF9hW19pXSwgayA9IF9iWzBdLCB2ID0gX2JbMV07XHJcbiAgICAgICAgICAgIG9sZFN0YXRlW2tdID0gdjtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUucmVzZXRUZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBzdGF0dXNUZXh0SWQgPSB0aGlzLmdldFN0YXRlKCkuc3RhdHVzVGV4dElkO1xyXG4gICAgICAgIGlmIChzdGF0dXNUZXh0SWQpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dChzdGF0dXNUZXh0SWQpO1xyXG4gICAgICAgICAgICBzdGF0dXNUZXh0SWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzdGF0dXNUZXh0SWQ6IHN0YXR1c1RleHRJZCB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUudXBkYXRlVGV4dCA9IGZ1bmN0aW9uICh0ZXh0LCBjb2xvciwgY2xlYXJEZWxheSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hID0gZ2V0U2NyZWVuUmVzb2x1dGlvbigpLCB3aWR0aCA9IF9hLndpZHRoLCBoZWlnaHQgPSBfYS5oZWlnaHQ7XHJcbiAgICAgICAgdGhpcy5yZXNldFRleHQoKTtcclxuICAgICAgICB2YXIgc3RhdHVzVGV4dElkID0gY3JlYXRlVGV4dCh3aWR0aCAvIDIsIGhlaWdodCAvIDIsIHRleHQsIGNvbG9yKTtcclxuICAgICAgICBzZXRUZXh0U2l6ZShzdGF0dXNUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHN0YXR1c1RleHRJZDogc3RhdHVzVGV4dElkIH0pO1xyXG4gICAgICAgIGlmIChjbGVhckRlbGF5KSB7XHJcbiAgICAgICAgICAgIFV0aWxpdHkud2FpdChjbGVhckRlbGF5KS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLnJlc2V0VGV4dCgpOyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUuZW51bWVyYXRlQ2xpZW50TW9kcyA9IGZ1bmN0aW9uIChnZXRDb3VudCwgZ2V0QXQpIHtcclxuICAgICAgICB2YXIgcmVzdWx0ID0gW107XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBnZXRDb3VudCgpOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gZ2V0QXQoaSk7XHJcbiAgICAgICAgICAgIHZhciBfYSA9IHRoaXMuZ2V0RmlsZUluZm9TYWZlKGZpbGVuYW1lKSwgY3JjMzIgPSBfYS5jcmMzMiwgc2l6ZSA9IF9hLnNpemU7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHsgZmlsZW5hbWU6IGZpbGVuYW1lLCBjcmMzMjogY3JjMzIsIHNpemU6IHNpemUgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9O1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUuZ2V0Q2xpZW50TW9kcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5lbnVtZXJhdGVDbGllbnRNb2RzKEdhbWUuZ2V0TW9kQ291bnQsIEdhbWUuZ2V0TW9kTmFtZSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUucHJpbnRNb2RPcmRlciA9IGZ1bmN0aW9uIChoZWFkZXIsIG9yZGVyKSB7XHJcbiAgICAgICAgcHJpbnRDb25zb2xlKGhlYWRlcik7XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfYSA9IE9iamVjdC5lbnRyaWVzKG9yZGVyKTsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIF9iID0gX2FbX2ldLCBpID0gX2JbMF0sIG1vZCA9IF9iWzFdO1xyXG4gICAgICAgICAgICBwcmludENvbnNvbGUoXCIjXCIuY29uY2F0KGksIFwiIFwiKS5jb25jYXQoSlNPTi5zdHJpbmdpZnkobW9kKSkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5nZXRGaWxlSW5mb1NhZmUgPSBmdW5jdGlvbiAoZmlsZW5hbWUpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zcC5nZXRGaWxlSW5mbyhmaWxlbmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZS5tZXNzYWdlO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgPT09IFwic3RyaW5nXCIgJiYgbWVzc2FnZS5pbmNsdWRlcygnaXMgbm90IGEgdmFsaWQgYXJndW1lbnQnKSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJGYWlsZWQgdG8gZ2V0IGZpbGUgaW5mbyBmb3JcIiwgZmlsZW5hbWUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY3JjMzI6IDAsIHNpemU6IDAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuLy8gVE9ETzogcmVmYWN0b3IgdGhpcyBvdXRcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQsIHJlbW90ZUlkVG9Mb2NhbElkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG4vLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG5pbXBvcnQgeyBHYW1lLCBnZXRBbmltYXRpb25WYXJpYWJsZXNGcm9tQWN0b3IsIFNwZWxsVHlwZSB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tICcuL2NsaWVudExpc3RlbmVyJztcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG52YXIgTWFnaWNTeW5jU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhNYWdpY1N5bmNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTWFnaWNTeW5jU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5wbGF5ZXJJZCA9IDB4MTQ7XHJcbiAgICAgICAgX3RoaXMuc2VuZFVwZGF0ZUFuaW1hdGlvblZhcmlhYmxlc1JhdGVNcyA9IDUwMDtcclxuICAgICAgICBfdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2cgPSBudWxsO1xyXG4gICAgICAgIF90aGlzLmxhc3RTZW5kVXBkYXRlQW5pbWF0aW9uVmFyaWFibGVzID0gMDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJzcGVsbENhc3RcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU3BlbGxDYXN0KGUpOyB9KTtcclxuICAgICAgICB2YXIgc2VsZiA9IF90aGlzO1xyXG4gICAgICAgIF90aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkgeyB9LFxyXG4gICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5vblNlbmRBbmltYXRpb25FdmVudExlYXZlKGN0eCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCBfdGhpcy5wbGF5ZXJJZCwgX3RoaXMucGxheWVySWQpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNBbnlNYWdpY1N0dWZmRXF1aXBlZCgpID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5sYXN0U2VuZFVwZGF0ZUFuaW1hdGlvblZhcmlhYmxlcyA8PSB0aGlzLnNlbmRVcGRhdGVBbmltYXRpb25WYXJpYWJsZXNSYXRlTXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxhc3RTZW5kVXBkYXRlQW5pbWF0aW9uVmFyaWFibGVzID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGFuaW1WYXJpYWJsZXMgPSBfdGhpcy5nZXRBbmltYXRpb25WYXJpYWJsZXNGcm9tQWN0b3JDb252ZXJ0ZWQoYWMuZ2V0Rm9ybUlEKCkpO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHsgdDogTXNnVHlwZS5VcGRhdGVBbmltVmFyaWFibGVzLCBkYXRhOiBfdGhpcy5nZXRVcGRhdGVBbmltVmFyaWFibGVzRXZlbnREYXRhKGFjLCBhbmltVmFyaWFibGVzKSB9LFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5vblNwZWxsQ2FzdCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBpc0ludGVycnVwdENhc3QgPSBmYWxzZTtcclxuICAgICAgICB2YXIgbXNnID0gdGhpcy5nZXRTcGVsbENhc3RFdmVudERhdGEoZXZlbnQsIGlzSW50ZXJydXB0Q2FzdCk7XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogeyB0OiBNc2dUeXBlLlNwZWxsQ2FzdCwgZGF0YTogbXNnIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZyA9IG1zZztcclxuICAgIH07XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRBbmltYXRpb25FdmVudExlYXZlID0gZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCF0aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZyB8fCAhdGhpcy5pc0ludGVyYXB0U3BlbGxDYXN0QW5pbShjdHguYW5pbUV2ZW50TmFtZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoIV90aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZyB8fCBfdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2cuaW50ZXJydXB0Q2FzdCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBtc2cgPSBfdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2c7XHJcbiAgICAgICAgICAgIG1zZy5pbnRlcnJ1cHRDYXN0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgbXNnLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzID0gX3RoaXMuZ2V0QW5pbWF0aW9uVmFyaWFibGVzRnJvbUFjdG9yQ29udmVydGVkKHJlbW90ZUlkVG9Mb2NhbElkKF90aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZy5jYXN0ZXIpKTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiB7IHQ6IE1zZ1R5cGUuU3BlbGxDYXN0LCBkYXRhOiBtc2cgfSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUuZ2V0U3BlbGxDYXN0RXZlbnREYXRhID0gZnVuY3Rpb24gKGUsIGlzSW50ZXJydXB0Q2FzdCkge1xyXG4gICAgICAgIHZhciBzcGVsbENhc3REYXRhID0ge1xyXG4gICAgICAgICAgICBjYXN0ZXI6IGxvY2FsSWRUb1JlbW90ZUlkKGUuY2FzdGVyLmdldEZvcm1JRCgpLCB0cnVlKSxcclxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICAgICAgdGFyZ2V0OiBlLnRhcmdldCA/IGxvY2FsSWRUb1JlbW90ZUlkKGUudGFyZ2V0LmdldEZvcm1JRCgpLCB0cnVlKSA6IDAsXHJcbiAgICAgICAgICAgIHNwZWxsOiBlLnNwZWxsID8gZS5zcGVsbC5nZXRGb3JtSUQoKSA6IDAsXHJcbiAgICAgICAgICAgIGludGVycnVwdENhc3Q6IGlzSW50ZXJydXB0Q2FzdCxcclxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICAgICAgaXNEdWFsQ2FzdGluZzogZS5pc0R1YWxDYXN0aW5nLFxyXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgICAgICBjYXN0aW5nU291cmNlOiBlLmNhc3RpbmdTb3VyY2UsXHJcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgICAgIGFpbUFuZ2xlOiBlLmFpbUFuZ2xlLFxyXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgICAgICBhaW1IZWFkaW5nOiBlLmFpbUhlYWRpbmcsXHJcbiAgICAgICAgICAgIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzOiB0aGlzLmdldEFuaW1hdGlvblZhcmlhYmxlc0Zyb21BY3RvckNvbnZlcnRlZChlLmNhc3Rlci5nZXRGb3JtSUQoKSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gc3BlbGxDYXN0RGF0YTtcclxuICAgIH07XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5nZXRBbmltYXRpb25WYXJpYWJsZXNGcm9tQWN0b3JDb252ZXJ0ZWQgPSBmdW5jdGlvbiAoYWN0b3JJZCkge1xyXG4gICAgICAgIHZhciBhbmltVmFycyA9IGdldEFuaW1hdGlvblZhcmlhYmxlc0Zyb21BY3RvcihhY3RvcklkKTtcclxuICAgICAgICB2YXIgYm9vbGVhbnMgPSBhbmltVmFycy5ib29sZWFucztcclxuICAgICAgICB2YXIgZmxvYXRzID0gYW5pbVZhcnMuZmxvYXRzO1xyXG4gICAgICAgIHZhciBpbnRlZ2VycyA9IGFuaW1WYXJzLmludGVnZXJzO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGJvb2xlYW5zOiBBcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGJvb2xlYW5zKSksXHJcbiAgICAgICAgICAgIGZsb2F0czogQXJyYXkuZnJvbShuZXcgVWludDhBcnJheShmbG9hdHMpKSxcclxuICAgICAgICAgICAgaW50ZWdlcnM6IEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoaW50ZWdlcnMpKSxcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLmdldFVwZGF0ZUFuaW1WYXJpYWJsZXNFdmVudERhdGEgPSBmdW5jdGlvbiAoYWMsIGFuaW1WYXJpYWJsZXMpIHtcclxuICAgICAgICB2YXIgYW5pbVZhcnNEYXRhID0ge1xyXG4gICAgICAgICAgICBhY3RvclJlbW90ZUlkOiBsb2NhbElkVG9SZW1vdGVJZChhYy5nZXRGb3JtSUQoKSwgdHJ1ZSksXHJcbiAgICAgICAgICAgIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzOiBhbmltVmFyaWFibGVzLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIGFuaW1WYXJzRGF0YTtcclxuICAgIH07XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5pc0ludGVyYXB0U3BlbGxDYXN0QW5pbSA9IGZ1bmN0aW9uIChhbmltRXZlbnROYW1lKSB7XHJcbiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICByZXR1cm4gZXZlbnROYW1lID09PSBcIm1saF9lcXVpcHBlZF9ldmVudFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtcmhfZXF1aXBwZWRfZXZlbnRcIjtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5pc1NwZWxsQ2FzdEFuaW0gPSBmdW5jdGlvbiAoYW5pbUV2ZW50TmFtZSkge1xyXG4gICAgICAgIHZhciBldmVudE5hbWUgPSBhbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgdmFyIGlzU3BlbGxDYXN0QW5pbUZvckxlZnRIYW5kID0gZXZlbnROYW1lID09PSBcIm1saF9zcGVsbGFpbWVkY29uY2VudHJhdGlvbnN0YXJ0XCIgfHwgZXZlbnROYW1lID09PSBcIm1saF9zcGVsbGFpbWVkc3RhcnRcIiB8fCBldmVudE5hbWUgPT09IFwibWxoX3NwZWxscmVhZHlfZXZlbnRcIiB8fFxyXG4gICAgICAgICAgICBldmVudE5hbWUgPT09IFwibWxoX3NwZWxscmVsZWFzZV9ldmVudFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtbGhfZXF1aXBwZWRfZXZlbnRcIjtcclxuICAgICAgICB2YXIgaXNTcGVsbENhc3RBbmltRm9yUmlnaHRIYW5kID0gZXZlbnROYW1lID09PSBcIm1yaF9zcGVsbGFpbWVkY29uY2VudHJhdGlvbnN0YXJ0XCIgfHwgZXZlbnROYW1lID09PSBcIm1yaF9zcGVsbGFpbWVkc3RhcnRcIiB8fCBldmVudE5hbWUgPT09IFwibXJoX3NwZWxscmVhZHlfZXZlbnRcIiB8fFxyXG4gICAgICAgICAgICBldmVudE5hbWUgPT09IFwibXJoX3NwZWxscmVsZWFzZV9ldmVudFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtcmhfZXF1aXBwZWRfZXZlbnRcIjtcclxuICAgICAgICByZXR1cm4gaXNTcGVsbENhc3RBbmltRm9yTGVmdEhhbmQgfHwgaXNTcGVsbENhc3RBbmltRm9yUmlnaHRIYW5kO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLmlzQW55TWFnaWNTdHVmZkVxdWlwZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGFjID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFjLmdldEVxdWlwcGVkU3BlbGwoU3BlbGxUeXBlLkxlZnQpIHx8IGFjLmdldEVxdWlwcGVkU3BlbGwoU3BlbGxUeXBlLlJpZ2h0KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFjLmdldEVxdWlwcGVkU3BlbGwoU3BlbGxUeXBlLlZvaXNlKSB8fCBhYy5nZXRFcXVpcHBlZFNwZWxsKFNwZWxsVHlwZS5JbnN0YW50KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGxlZnRIYW5kRXF1aXBtZW50VHlwZSA9IGFjLmdldEVxdWlwcGVkSXRlbVR5cGUoMSAvKiBTbG90VHlwZS5MZWZ0ICovKTtcclxuICAgICAgICB2YXIgcmlnaHRIYW5kRXF1aXBtZW50VHlwZSA9IGFjLmdldEVxdWlwcGVkSXRlbVR5cGUoMiAvKiBTbG90VHlwZS5SaWdodCAqLyk7XHJcbiAgICAgICAgLy8gVE9ETzogU3BlbGwgPT4gU3BlbGxPclNjcm9sbCwgc2luY2UgU3BlbGwgaXMgbm93IGEgZGVwcmVjYXRlZCBuYW1lIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgIGlmIChsZWZ0SGFuZEVxdWlwbWVudFR5cGUgPT09IDkgLyogRXF1aXBwZWRJdGVtVHlwZS5TcGVsbCAqLyB8fCBsZWZ0SGFuZEVxdWlwbWVudFR5cGUgPT09IDggLyogRXF1aXBwZWRJdGVtVHlwZS5TdGFmZiAqLyB8fFxyXG4gICAgICAgICAgICByaWdodEhhbmRFcXVpcG1lbnRUeXBlID09PSA5IC8qIEVxdWlwcGVkSXRlbVR5cGUuU3BlbGwgKi8gfHwgcmlnaHRIYW5kRXF1aXBtZW50VHlwZSA9PT0gOCAvKiBFcXVpcHBlZEl0ZW1UeXBlLlN0YWZmICovKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIE1hZ2ljU3luY1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgTWFnaWNTeW5jU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgc2V0VGV4dFNpemUgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgTmV0SW5mb1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTmV0SW5mb1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBOZXRJbmZvU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnJlY2VpdmVkUGFja2V0Q291bnQgPSAwO1xyXG4gICAgICAgIF90aGlzLnNlbnRQYWNrZXRDb3VudCA9IDA7XHJcbiAgICAgICAgX3RoaXMubG9jYWxMYWdVbml0cyA9IDA7XHJcbiAgICAgICAgX3RoaXMuZGVsYXlNcyA9IDEwMDA7XHJcbiAgICAgICAgX3RoaXMubGFzdER0ID0gMDtcclxuICAgICAgICBfdGhpcy5kdCA9IDA7XHJcbiAgICAgICAgX3RoaXMuZ3JlZW5BUkdCID0gWzAsIDEyOCwgMCwgMV07XHJcbiAgICAgICAgX3RoaXMucmVkQVJHQiA9IFsyNTUsIDAsIDAsIDFdO1xyXG4gICAgICAgIC8vIGNsZWFyIHByZXZpb3VzIHRleHRzIGluIGNhc2Ugb2YgaG90cmVsb2FkXHJcbiAgICAgICAgaWYgKF90aGlzLnNwLnN0b3JhZ2VbTmV0SW5mb1RleHRzLk5hbWVdICYmIF90aGlzLnNwLnN0b3JhZ2VbTmV0SW5mb1RleHRzLk5hbWVdLmNsZWFyKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkRlc3Ryb3lpbmcgb2xkIE5ldEluZm9UZXh0c1wiKTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIChfYSA9IF90aGlzLnNwLnN0b3JhZ2VbTmV0SW5mb1RleHRzLk5hbWVdKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xlYXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiRmFpbGVkIHRvIGRlc3Ryb3kgb2xkIE5ldEluZm9UZXh0czpcIiwgZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFfdGhpcy5pc0VuYWJsZWQoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLnRleHRJZHMgPSBuZXcgTmV0SW5mb1RleHRzKF90aGlzLnNwKTtcclxuICAgICAgICBfdGhpcy5zcC5zdG9yYWdlW05ldEluZm9UZXh0cy5OYW1lXSA9IF90aGlzLnRleHRJZHM7XHJcbiAgICAgICAgX3RoaXMubGFzdER0ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZW5kTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZW5kTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNlbmRNZXNzYWdlV2l0aFJlZnJJZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiYW55TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BbnlNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJuZXdMb2NhbExhZ1ZhbHVlQ2FsY3VsYXRlZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25OZXdMb2NhbExhZ1ZhbHVlQ2FsY3VsYXRlZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUub25TZW5kTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5hZGRTZW50UGFja2V0Q291bnQoMSk7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZE1lc3NhZ2VXaXRoUmVmcklkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLmFkZFNlbnRQYWNrZXRDb3VudCgxKTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUub25BbnlNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLmFkZFJlY2VpdmVkUGFja2V0Q291bnQoMSk7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLm9uTmV3TG9jYWxMYWdWYWx1ZUNhbGN1bGF0ZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuc2V0TG9jYWxMYWdVbml0cyhlLmxhZ1VuaXRzTm9aKTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudGV4dElkcyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5kdCArPSBEYXRlLm5vdygpIC0gdGhpcy5sYXN0RHQ7XHJcbiAgICAgICAgdGhpcy5sYXN0RHQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHZhciBpc0Nvbm5lY3RlZCA9IHRoaXMuc3AubXBDbGllbnRQbHVnaW4uaXNDb25uZWN0ZWQoKTtcclxuICAgICAgICB0aGlzLnNwLnNldFRleHRTdHJpbmcodGhpcy50ZXh0SWRzLmNvbm5lY3Rpb25TdGF0ZVRleHRJZCwgXCJcIi5jb25jYXQoaXNDb25uZWN0ZWQgPyBcIk9OXCIgOiBcIk9GRlwiKSk7XHJcbiAgICAgICAgdGhpcy5zcC5zZXRUZXh0Q29sb3IodGhpcy50ZXh0SWRzLmNvbm5lY3Rpb25TdGF0ZVRleHRJZCwgaXNDb25uZWN0ZWQgPyB0aGlzLmdyZWVuQVJHQiA6IHRoaXMucmVkQVJHQik7XHJcbiAgICAgICAgLy8gaHR0cHM6Ly93d3cuY3JlYXRpb25raXQuY29tL2luZGV4LnBocD90aXRsZT1Vbml0XHJcbiAgICAgICAgdmFyIHVuaXRzID0gdGhpcy5nZXRMb2NhbExhZ1VuaXRzKCk7XHJcbiAgICAgICAgdmFyIHVuaXRzSW5NZXRlciA9IDcwLjAyMTg4MTgzODE7XHJcbiAgICAgICAgdmFyIG1ldGVycyA9IE1hdGgucm91bmQodW5pdHMgLyB1bml0c0luTWV0ZXIgKiAxMCkgLyAxMDtcclxuICAgICAgICB0aGlzLnNwLnNldFRleHRTdHJpbmcodGhpcy50ZXh0SWRzLmxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQsIFwiXCIuY29uY2F0KHVuaXRzLCBcIiB1bml0cyAoflwiKS5jb25jYXQobWV0ZXJzLCBcIiBtKVwiKSk7XHJcbiAgICAgICAgaWYgKHRoaXMuZGVsYXlNcyA+IHRoaXMuZHQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNwLnNldFRleHRTdHJpbmcodGhpcy50ZXh0SWRzLnJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkLCBcIlwiLmNvbmNhdChNYXRoLnJvdW5kKHRoaXMuZ2V0QW5kQ2xlYXJSZWNlaXZlZFBhY2tldENvdW50KCkpKSk7XHJcbiAgICAgICAgdGhpcy5zcC5zZXRUZXh0U3RyaW5nKHRoaXMudGV4dElkcy5zZW50UGFja2V0QW1vdW50VGV4dElkLCBcIlwiLmNvbmNhdChNYXRoLnJvdW5kKHRoaXMuZ2V0QW5kQ2xlYXJTZW50UGFja2V0Q291bnQoKSkpKTtcclxuICAgICAgICB0aGlzLmR0ID0gMDtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuYWRkUmVjZWl2ZWRQYWNrZXRDb3VudCA9IGZ1bmN0aW9uIChjb3VudCkge1xyXG4gICAgICAgIHRoaXMucmVjZWl2ZWRQYWNrZXRDb3VudCArPSBjb3VudDtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuZ2V0QW5kQ2xlYXJSZWNlaXZlZFBhY2tldENvdW50ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB2YWx1ZSA9IHRoaXMucmVjZWl2ZWRQYWNrZXRDb3VudDtcclxuICAgICAgICB0aGlzLnJlY2VpdmVkUGFja2V0Q291bnQgPSAwO1xyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuYWRkU2VudFBhY2tldENvdW50ID0gZnVuY3Rpb24gKGNvdW50KSB7XHJcbiAgICAgICAgdGhpcy5zZW50UGFja2V0Q291bnQgKz0gY291bnQ7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLmdldEFuZENsZWFyU2VudFBhY2tldENvdW50ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuc2VudFBhY2tldENvdW50O1xyXG4gICAgICAgIHRoaXMuc2VudFBhY2tldENvdW50ID0gMDtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLnNldExvY2FsTGFnVW5pdHMgPSBmdW5jdGlvbiAoZGlzdGFuY2UpIHtcclxuICAgICAgICB0aGlzLmxvY2FsTGFnVW5pdHMgPSBkaXN0YW5jZTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuZ2V0TG9jYWxMYWdVbml0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbExhZ1VuaXRzO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5pc0VuYWJsZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJzaG93LW5ldC1pbmZvXCJdO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBOZXRJbmZvU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBOZXRJbmZvU2VydmljZSB9O1xyXG52YXIgTmV0SW5mb1RleHRzID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gTmV0SW5mb1RleHRzKHNwLCBjb25uZWN0aW9uU3RhdGljVGV4dElkLCBjb25uZWN0aW9uU3RhdGVUZXh0SWQsIHJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkLCByZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCwgc2VudFBhY2tldFN0YXRpY1RleHRJZCwgc2VudFBhY2tldEFtb3VudFRleHRJZCwgbG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZCwgbG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCkge1xyXG4gICAgICAgIGlmIChjb25uZWN0aW9uU3RhdGljVGV4dElkID09PSB2b2lkIDApIHsgY29ubmVjdGlvblN0YXRpY1RleHRJZCA9IHNwLmNyZWF0ZVRleHQoMTAwLCAzNTAsIFwiY29ubmVjdGlvbjpcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChjb25uZWN0aW9uU3RhdGVUZXh0SWQgPT09IHZvaWQgMCkgeyBjb25uZWN0aW9uU3RhdGVUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDIyMCwgMzUwLCBcIlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKHJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkID09PSB2b2lkIDApIHsgcmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDEyMCwgMzkwLCBcImluY29taW5nIChwL3MpOlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKHJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkID09PSB2b2lkIDApIHsgcmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDI1MCwgMzkwLCBcIlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKHNlbnRQYWNrZXRTdGF0aWNUZXh0SWQgPT09IHZvaWQgMCkgeyBzZW50UGFja2V0U3RhdGljVGV4dElkID0gc3AuY3JlYXRlVGV4dCgxMjAsIDQzMCwgXCJvdXRnb2luZyAocC9zKTpcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChzZW50UGFja2V0QW1vdW50VGV4dElkID09PSB2b2lkIDApIHsgc2VudFBhY2tldEFtb3VudFRleHRJZCA9IHNwLmNyZWF0ZVRleHQoMjUwLCA0MzAsIFwiXCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAobG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZCA9PT0gdm9pZCAwKSB7IGxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDkwLCA0NzAsIFwibG9jYWwgbGFnOlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKGxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQgPT09IHZvaWQgMCkgeyBsb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkID0gc3AuY3JlYXRlVGV4dCgyNTAsIDQ3MCwgXCJcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIHRoaXMuc3AgPSBzcDtcclxuICAgICAgICB0aGlzLmNvbm5lY3Rpb25TdGF0aWNUZXh0SWQgPSBjb25uZWN0aW9uU3RhdGljVGV4dElkO1xyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvblN0YXRlVGV4dElkID0gY29ubmVjdGlvblN0YXRlVGV4dElkO1xyXG4gICAgICAgIHRoaXMucmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQgPSByZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZDtcclxuICAgICAgICB0aGlzLnJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkID0gcmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5zZW50UGFja2V0U3RhdGljVGV4dElkID0gc2VudFBhY2tldFN0YXRpY1RleHRJZDtcclxuICAgICAgICB0aGlzLnNlbnRQYWNrZXRBbW91bnRUZXh0SWQgPSBzZW50UGFja2V0QW1vdW50VGV4dElkO1xyXG4gICAgICAgIHRoaXMubG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZCA9IGxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5sb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkID0gbG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZDtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLmNvbm5lY3Rpb25TdGF0aWNUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5jb25uZWN0aW9uU3RhdGVUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5yZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLnJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMuc2VudFBhY2tldFN0YXRpY1RleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLnNlbnRQYWNrZXRBbW91bnRUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5sb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMubG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCwgMC41KTtcclxuICAgIH1cclxuICAgIE5ldEluZm9UZXh0cy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLmNvbm5lY3Rpb25TdGF0aWNUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5jb25uZWN0aW9uU3RhdGVUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5yZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLnJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMuc2VudFBhY2tldFN0YXRpY1RleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLnNlbnRQYWNrZXRBbW91bnRUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5sb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMubG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCk7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1RleHRzLk5hbWUgPSBcIm5ldEluZm9UZXh0c1wiO1xyXG4gICAgcmV0dXJuIE5ldEluZm9UZXh0cztcclxufSgpKTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IE5ldmVyRXJyb3IgfSBmcm9tIFwiLi4vLi4vbGliL2Vycm9yc1wiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4vcmVtb3RlU2VydmVyXCI7XHJcbnZhciBOZXR3b3JraW5nU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhOZXR3b3JraW5nU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIE5ldHdvcmtpbmdTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVGljaygpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZW5kTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZW5kTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2VuZFJhd01lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2VuZFJhd01lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZW5kTWVzc2FnZVdpdGhSZWZySWQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLnNlbmQoSlNPTi5zdHJpbmdpZnkoZS5tZXNzYWdlKSwgdGhpcy5pc1JlbGlhYmxlKGUucmVsaWFiaWxpdHkpKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUub25TZW5kUmF3TWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxyXG4gICAgICAgIHRoaXMuc3AubXBDbGllbnRQbHVnaW4uc2VuZFJhdyhlLnJhd01lc3NhZ2UsIGUucmF3TWVzc2FnZS5ieXRlTGVuZ3RoLCB0aGlzLmlzUmVsaWFibGUoZS5yZWxpYWJpbGl0eSkpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRNZXNzYWdlV2l0aFJlZnJJZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIHJlZnJJZCA9IGUubWVzc2FnZS5fcmVmcklkO1xyXG4gICAgICAgIHZhciByZW1vdGVTZXJ2ZXIgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmVtb3RlU2VydmVyKTtcclxuICAgICAgICB2YXIgaWR4SW5Nb2RlbCA9IHJlZnJJZFxyXG4gICAgICAgICAgICA/IHJlbW90ZVNlcnZlci5nZXRXb3JsZE1vZGVsKCkuZm9ybXMuZmluZEluZGV4KGZ1bmN0aW9uIChmKSB7IHJldHVybiBmICYmIGYucmVmcklkID09PSByZWZySWQ7IH0pXHJcbiAgICAgICAgICAgIDogcmVtb3RlU2VydmVyLmdldFdvcmxkTW9kZWwoKS5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4O1xyXG4gICAgICAgIC8vIGZpeGVzIFwiY2FuJ3QgZ2V0IHByb3BlcnR5IGlkeCBvZiBudWxsIG9yIHVuZGVmaW5lZFwiXHJcbiAgICAgICAgaWYgKCFyZW1vdGVTZXJ2ZXIuZ2V0V29ybGRNb2RlbCgpLmZvcm1zW2lkeEluTW9kZWxdKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIGUubWVzc2FnZS5pZHggPSByZW1vdGVTZXJ2ZXIuZ2V0V29ybGRNb2RlbCgpLmZvcm1zW2lkeEluTW9kZWxdLmlkeDtcclxuICAgICAgICBkZWxldGUgZS5tZXNzYWdlLl9yZWZySWQ7XHJcbiAgICAgICAgdGhpcy5zcC5tcENsaWVudFBsdWdpbi5zZW5kKEpTT04uc3RyaW5naWZ5KGUubWVzc2FnZSksIHRoaXMuaXNSZWxpYWJsZShlLnJlbGlhYmlsaXR5KSk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLmNvbm5lY3QgPSBmdW5jdGlvbiAoaG9zdE5hbWUsIHBvcnQpIHtcclxuICAgICAgICB0aGlzLnNlcnZlckFkZHJlc3MgPSB7IGhvc3ROYW1lOiBob3N0TmFtZSwgcG9ydDogcG9ydCB9O1xyXG4gICAgICAgIHRoaXMuY3JlYXRlQ2xpZW50U2FmZSgpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5yZWNvbm5lY3QgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVDbGllbnRTYWZlKCk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AubXBDbGllbnRQbHVnaW4uZGVzdHJveUNsaWVudCgpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zcC5tcENsaWVudFBsdWdpbi5pc0Nvbm5lY3RlZCgpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5vblRpY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLnRpY2soZnVuY3Rpb24gKHBhY2tldFR5cGUsIHJhd0NvbnRlbnQsIGVycm9yKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAocGFja2V0VHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNvbm5lY3Rpb25BY2NlcHRlZFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY29ubmVjdGlvbkFjY2VwdGVkXCIsIHt9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjb25uZWN0aW9uRGVuaWVkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjb25uZWN0aW9uRGVuaWVkXCIsIHsgZXJyb3I6IGVycm9yIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnJlY29ubmVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNvbm5lY3Rpb25GYWlsZWRcIjpcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImNvbm5lY3Rpb25GYWlsZWRcIiwge30pO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnJlY29ubmVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImRpc2Nvbm5lY3RcIjpcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImNvbm5lY3Rpb25EaXNjb25uZWN0XCIsIHt9KTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZWNvbm5lY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJtZXNzYWdlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogaW4gdGhlb3J5IGNhbiBiZSBlbXB0eSBqc29uQ29udGVudCBhbmQgbm9uLWVtcHR5IGVycm9yXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1zZ0FueSA9IHZvaWQgMDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmF3Q29udGVudCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtc2dBbnkgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwibnVsbCByYXdDb250ZW50XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgobmV3IFVpbnQ4QXJyYXkocmF3Q29udGVudClbMF0pID09PSAweDdiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc3VtZSBqc29uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1zZ0FueSA9IEpTT04ucGFyc2UoX3RoaXMuc3AuZGVjb2RlVXRmOChyYXdDb250ZW50KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBhc3N1bWUgcmF3XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgcmF3Q29udGVudDogcmF3Q29udGVudCB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlSYXdNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLk9wZW5Db250YWluZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJvcGVuQ29udGFpbmVyTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZU1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlTW92ZW1lbnRNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlQW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlQW5pbWF0aW9uTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZUVxdWlwbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZUVxdWlwbWVudE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5DaGFuZ2VWYWx1ZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjaGFuZ2VWYWx1ZXNNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuU3BlbGxDYXN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic3BlbGxDYXN0TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZUFuaW1WYXJpYWJsZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVBbmltVmFyaWFibGVzTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZUFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVBcHBlYXJhbmNlTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlRlbGVwb3J0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidGVsZXBvcnRNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlUHJvcGVydHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVQcm9wZXJ0eU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5EZWF0aFN0YXRlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiZGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5DcmVhdGVBY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkN1c3RvbVBhY2tldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImN1c3RvbVBhY2tldE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5EZXN0cm95QWN0b3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJkZXN0cm95QWN0b3JNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuSG9zdFN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiaG9zdFN0YXJ0TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkhvc3RTdG9wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiaG9zdFN0b3BNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuU2V0SW52ZW50b3J5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2V0SW52ZW50b3J5TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlNldFJhY2VNZW51T3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNldFJhY2VNZW51T3Blbk1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5TcFNuaXBwZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzcFNuaXBwZXRNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlR2FtZW1vZGVEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlRlbGVwb3J0Mikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInRlbGVwb3J0TWVzc2FnZTJcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhyb3cgbmV3IE5ldmVyRXJyb3IobXNnQW55KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5oYW5kbGVkIE1zZ1R5cGUgXCIgKyBtc2dBbnkudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLmNyZWF0ZUNsaWVudFNhZmUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF9hID0gdGhpcy5zZXJ2ZXJBZGRyZXNzLCBob3N0TmFtZSA9IF9hLmhvc3ROYW1lLCBwb3J0ID0gX2EucG9ydDtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcImNyZWF0ZUNsaWVudFNhZmUgXCIgKyBob3N0TmFtZSArIFwiOlwiICsgcG9ydCk7XHJcbiAgICAgICAgaWYgKHRoaXMuc2VydmVyQWRkcmVzcy5ob3N0TmFtZSAhPT0gXCJcIiAmJiB0aGlzLnNlcnZlckFkZHJlc3MucG9ydCAhPT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLmNyZWF0ZUNsaWVudChob3N0TmFtZSwgcG9ydCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcImNyZWF0ZUNsaWVudFNhZmUgZmFpbGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLCBcInNlcnZlckFkZHJlc3NcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5zcC5zdG9yYWdlW1wic2VydmVyQWRkcmVzc1wiXTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiByZXMgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSByZXM7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdC5ob3N0TmFtZSA9PT0gXCJzdHJpbmdcIiAmJiB0eXBlb2YgcmVzdWx0LnBvcnQgPT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB7IGhvc3ROYW1lOiBcIlwiLCBwb3J0OiAwIH07XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uIChuZXdWYWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJzZXJ2ZXJBZGRyZXNzXCJdID0gbmV3VmFsdWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLmlzUmVsaWFibGUgPSBmdW5jdGlvbiAocmVsaWFiaWxpdHkpIHtcclxuICAgICAgICBzd2l0Y2ggKHJlbGlhYmlsaXR5KSB7XHJcbiAgICAgICAgICAgIGNhc2UgXCJyZWxpYWJsZVwiOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIGNhc2UgXCJ1bnJlbGlhYmxlXCI6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTmV2ZXJFcnJvcihyZWxpYWJpbGl0eSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBOZXR3b3JraW5nU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBOZXR3b3JraW5nU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBBbW1vLCBHYW1lIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBnZXRFcXVpcG1lbnQgfSBmcm9tIFwiLi4vLi4vc3luYy9lcXVpcG1lbnRcIjtcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIFBsYXllckJvd1Nob3RTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFBsYXllckJvd1Nob3RTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gUGxheWVyQm93U2hvdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXNfMSA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXNfMS5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzXzEuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXNfMS5zY29yZSA9IDA7XHJcbiAgICAgICAgX3RoaXNfMS5pbnZlbnRvcnlVbmJsb2NrTW9tZW50ID0gMDtcclxuICAgICAgICBfdGhpc18xLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInF1ZXJ5QmxvY2tTZXRJbnZlbnRvcnlFdmVudFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXNfMS5vblF1ZXJ5QmxvY2tTZXRJbnZlbnRvcnlFdmVudChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXNfMS5jb250cm9sbGVyLm9uKFwicGxheWVyQm93U2hvdFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXNfMS5vblBsYXllckJvd1Nob3QoZSk7IH0pO1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF90aGlzXzE7XHJcbiAgICAgICAgdmFyIGV2ZW50UGF0dGVybnMgPSBbXCJhdHRhY2tSZWxlYXNlXCIsIFwiY3Jvc3Nib3dBdHRhY2tTdGFydFwiXTtcclxuICAgICAgICBldmVudFBhdHRlcm5zLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50UGF0dGVybikge1xyXG4gICAgICAgICAgICBfdGhpc18xLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghY3R4LmFuaW1hdGlvblN1Y2NlZWRlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdHguYW5pbUV2ZW50TmFtZSA9PT0gXCJjcm9zc2Jvd0F0dGFja1N0YXJ0XCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcmUgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjdHguYW5pbUV2ZW50TmFtZSA9PT0gXCJhdHRhY2tSZWxlYXNlXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnNjb3JlID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyBfdGhpcy5vblBsYXllckNyb3NzYm93U2hvdCgpOyB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3JlID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcmUgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgZXZlbnRQYXR0ZXJuKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXNfMTtcclxuICAgIH1cclxuICAgIFBsYXllckJvd1Nob3RTZXJ2aWNlLnByb3RvdHlwZS5vblF1ZXJ5QmxvY2tTZXRJbnZlbnRvcnlFdmVudCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKERhdGUubm93KCkgPCB0aGlzLmludmVudG9yeVVuYmxvY2tNb21lbnQpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJCbG9ja2VkIGludmVudG9yeSBvcGVyYXRpb25cIik7XHJcbiAgICAgICAgICAgIGUuYmxvY2soKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTm90IGJsb2NrZWQgaW52ZW50b3J5IG9wZXJhdGlvblwiKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQm93U2hvdFNlcnZpY2UucHJvdG90eXBlLm9uUGxheWVyQm93U2hvdCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5QbGF5ZXJCb3dTaG90LFxyXG4gICAgICAgICAgICAgICAgd2VhcG9uSWQ6IGUud2VhcG9uLmdldEZvcm1JRCgpLFxyXG4gICAgICAgICAgICAgICAgYW1tb0lkOiBlLmFtbW8uZ2V0Rm9ybUlEKCksXHJcbiAgICAgICAgICAgICAgICBwb3dlcjogZS5wb3dlcixcclxuICAgICAgICAgICAgICAgIGlzU3VuR2F6aW5nOiBlLmlzU3VuR2F6aW5nIHx8IGZhbHNlXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFBsYXllckJvd1Nob3RTZXJ2aWNlLnByb3RvdHlwZS5vblBsYXllckNyb3NzYm93U2hvdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgYWN0b3IgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgaWYgKGFjdG9yID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGNyb3NzYm93ID0gYWN0b3IuZ2V0RXF1aXBwZWRXZWFwb24oZmFsc2UpO1xyXG4gICAgICAgIGlmIChjcm9zc2JvdyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkNvdWxkbid0IGdldCBlcXVpcHBlZCB3ZWFwb25cIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHdlYXBvblR5cGUgPSBjcm9zc2Jvdy5nZXRXZWFwb25UeXBlKCk7XHJcbiAgICAgICAgaWYgKHdlYXBvblR5cGUgIT09IDkgLyogV2VhcG9uVHlwZS5Dcm9zc2JvdyAqLykge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkV4cGVjdGVkIHdlYXBvbiB0byBiZSBjcm9zc2JvdywgYnV0IGdvdCBXZWFwb25UeXBlXCIsIHdlYXBvblR5cGUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBlcXVpcHBlZEFtbW9FbnRyaWVzID0gZ2V0RXF1aXBtZW50KGFjdG9yLCAwKS5pbnYuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7IHJldHVybiBlbnRyeS53b3JuICYmIEFtbW8uZnJvbShHYW1lLmdldEZvcm1FeChlbnRyeS5iYXNlSWQpKTsgfSk7XHJcbiAgICAgICAgaWYgKGVxdWlwcGVkQW1tb0VudHJpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiQW1tbyBub3QgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGVxdWlwcGVkQW1tb0VudHJpZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICB2YXIgZXF1aXBwZWRBbW1vSWRzID0gZXF1aXBwZWRBbW1vRW50cmllcy5tYXAoZnVuY3Rpb24gKGVudHJ5KSB7IHJldHVybiBlbnRyeS5iYXNlSWQ7IH0pO1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkZvdW5kIG1vcmUgdGhhbiAxIGFtbW9zOlwiLCBlcXVpcHBlZEFtbW9JZHMpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuUGxheWVyQm93U2hvdCxcclxuICAgICAgICAgICAgICAgIHdlYXBvbklkOiBjcm9zc2Jvdy5nZXRGb3JtSUQoKSxcclxuICAgICAgICAgICAgICAgIGFtbW9JZDogZXF1aXBwZWRBbW1vRW50cmllc1swXS5iYXNlSWQsXHJcbiAgICAgICAgICAgICAgICBpc1N1bkdhemluZzogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBwb3dlcjogMS4wXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIEZpeGVzIHJhY2UgY29uZGl0aW9uIHdoZW4gdGhlIHNlcnZlciByZW1vdmVzIGFuIGl0ZW0gZmFzdGVyIHRoYW4gbG9jYWwgY3Jvc3Nib3cgZG9lcyB0aGF0OiAtMSB0b3RhbFxyXG4gICAgICAgIC8vIFRoZW4gY3Jvc3Nib3cgcmVtb3ZlcyBvbmUgbW9yZSBpdGVtOiAtMiB0b3RhbFxyXG4gICAgICAgIC8vIFRoZSBpdGVtIGlzIGJlaW5nIGFkZGVkIGJhY2s6IC0xIHRvdGFsICh3aGljaCBpcyBjb3JyZWN0IGJ1dCBsb29rcyB1Z2x5IGluIHByb2Nlc3MpXHJcbiAgICAgICAgdGhpcy5pbnZlbnRvcnlVbmJsb2NrTW9tZW50ID0gRGF0ZS5ub3coKSArIDUgKiAxMDAwO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VudCBjcm9zc2JvdyBzaG90XCIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBQbGF5ZXJCb3dTaG90U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBQbGF5ZXJCb3dTaG90U2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbnZhciBfX2dlbmVyYXRvciA9ICh0aGlzICYmIHRoaXMuX19nZW5lcmF0b3IpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBib2R5KSB7XHJcbiAgICB2YXIgXyA9IHsgbGFiZWw6IDAsIHNlbnQ6IGZ1bmN0aW9uKCkgeyBpZiAodFswXSAmIDEpIHRocm93IHRbMV07IHJldHVybiB0WzFdOyB9LCB0cnlzOiBbXSwgb3BzOiBbXSB9LCBmLCB5LCB0LCBnO1xyXG4gICAgcmV0dXJuIGcgPSB7IG5leHQ6IHZlcmIoMCksIFwidGhyb3dcIjogdmVyYigxKSwgXCJyZXR1cm5cIjogdmVyYigyKSB9LCB0eXBlb2YgU3ltYm9sID09PSBcImZ1bmN0aW9uXCIgJiYgKGdbU3ltYm9sLml0ZXJhdG9yXSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSksIGc7XHJcbiAgICBmdW5jdGlvbiB2ZXJiKG4pIHsgcmV0dXJuIGZ1bmN0aW9uICh2KSB7IHJldHVybiBzdGVwKFtuLCB2XSk7IH07IH1cclxuICAgIGZ1bmN0aW9uIHN0ZXAob3ApIHtcclxuICAgICAgICBpZiAoZikgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkdlbmVyYXRvciBpcyBhbHJlYWR5IGV4ZWN1dGluZy5cIik7XHJcbiAgICAgICAgd2hpbGUgKGcgJiYgKGcgPSAwLCBvcFswXSAmJiAoXyA9IDApKSwgXykgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKGYgPSAxLCB5ICYmICh0ID0gb3BbMF0gJiAyID8geVtcInJldHVyblwiXSA6IG9wWzBdID8geVtcInRocm93XCJdIHx8ICgodCA9IHlbXCJyZXR1cm5cIl0pICYmIHQuY2FsbCh5KSwgMCkgOiB5Lm5leHQpICYmICEodCA9IHQuY2FsbCh5LCBvcFsxXSkpLmRvbmUpIHJldHVybiB0O1xyXG4gICAgICAgICAgICBpZiAoeSA9IDAsIHQpIG9wID0gW29wWzBdICYgMiwgdC52YWx1ZV07XHJcbiAgICAgICAgICAgIHN3aXRjaCAob3BbMF0pIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgMDogY2FzZSAxOiB0ID0gb3A7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA0OiBfLmxhYmVsKys7IHJldHVybiB7IHZhbHVlOiBvcFsxXSwgZG9uZTogZmFsc2UgfTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNTogXy5sYWJlbCsrOyB5ID0gb3BbMV07IG9wID0gWzBdOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNzogb3AgPSBfLm9wcy5wb3AoKTsgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEodCA9IF8udHJ5cywgdCA9IHQubGVuZ3RoID4gMCAmJiB0W3QubGVuZ3RoIC0gMV0pICYmIChvcFswXSA9PT0gNiB8fCBvcFswXSA9PT0gMikpIHsgXyA9IDA7IGNvbnRpbnVlOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSAzICYmICghdCB8fCAob3BbMV0gPiB0WzBdICYmIG9wWzFdIDwgdFszXSkpKSB7IF8ubGFiZWwgPSBvcFsxXTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDYgJiYgXy5sYWJlbCA8IHRbMV0pIHsgXy5sYWJlbCA9IHRbMV07IHQgPSBvcDsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodCAmJiBfLmxhYmVsIDwgdFsyXSkgeyBfLmxhYmVsID0gdFsyXTsgXy5vcHMucHVzaChvcCk7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRbMl0pIF8ub3BzLnBvcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgb3AgPSBib2R5LmNhbGwodGhpc0FyZywgXyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkgeyBvcCA9IFs2LCBlXTsgeSA9IDA7IH0gZmluYWxseSB7IGYgPSB0ID0gMDsgfVxyXG4gICAgICAgIGlmIChvcFswXSAmIDUpIHRocm93IG9wWzFdOyByZXR1cm4geyB2YWx1ZTogb3BbMF0gPyBvcFsxXSA6IHZvaWQgMCwgZG9uZTogdHJ1ZSB9O1xyXG4gICAgfVxyXG59O1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgU2Vzc2lvbiB9IGZyb20gJ2luc3BlY3Rvcic7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xyXG52YXIgUHJvZmlsaW5nU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhQcm9maWxpbmdTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gUHJvZmlsaW5nU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICB2YXIgc2V0dGluZ3MgPSBzcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl07XHJcbiAgICAgICAgaWYgKCFzZXR0aW5nc1tcImVuYWJsZVByb2ZpbGluZ1wiXSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJQcm9maWxpbmdTZXJ2aWNlOiBkaXNhYmxlZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcHJvZmlsaW5nRHVyYXRpb25NcyA9IF90aGlzLmdldEludGVnZXIoc2V0dGluZ3NbXCJwcm9maWxpbmdEdXJhdGlvbk1zXCJdKSB8fCAxMDAwMDtcclxuICAgICAgICB2YXIgc2Vzc2lvbiA9IG5ldyBTZXNzaW9uKCk7XHJcbiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KCk7XHJcbiAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUHJvZmlsaW5nU2VydmljZTogc3RhcnRcIik7XHJcbiAgICAgICAgX3RoaXMuc3RhcnRQcm9maWxpbmcoc2Vzc2lvbiwgcHJvZmlsaW5nRHVyYXRpb25Ncyk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgUHJvZmlsaW5nU2VydmljZS5wcm90b3R5cGUuc3RhcnRQcm9maWxpbmcgPSBmdW5jdGlvbiAoc2Vzc2lvbiwgcHJvZmlsaW5nRHVyYXRpb25Ncykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHByb2ZpbGUsIGZpbGVOYW1lU3VmZml4O1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gWzQgLyp5aWVsZCovLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uLnBvc3QoJ1Byb2ZpbGVyLmVuYWJsZScsIGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uLnBvc3QoJ1Byb2ZpbGVyLnN0YXJ0JywgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgcHJvZmlsaW5nRHVyYXRpb25Ncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUHJvZmlsaW5nU2VydmljZTogc3RvcFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24ucG9zdCgnUHJvZmlsZXIuc3RvcCcsIGZ1bmN0aW9uIChlcnIsIHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZmlsZSA9IChfYS5zZW50KCkpLnByb2ZpbGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lU3VmZml4ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygpLnJlcGxhY2UoXCIuMFwiLCBcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhcIi4vcHJvZmlsZVwiLmNvbmNhdChmaWxlTmFtZVN1ZmZpeCwgXCIuY3B1cHJvZmlsZVwiKSwgSlNPTi5zdHJpbmdpZnkocHJvZmlsZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFByb2ZpbGluZ1NlcnZpY2UucHJvdG90eXBlLmdldEludGVnZXIgPSBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBQcm9maWxpbmdTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFByb2ZpbGluZ1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIFJhZ2RvbGxTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFJhZ2RvbGxTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gUmFnZG9sbFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgLy8gVE9ETzogdGhpbmsgYWJvdXQgdHJhY2tpbmcgcmFnZG9sbCBzdGF0ZSBvZiBwbGF5ZXJcclxuICAgICAgICBfdGhpcy5zYWZlUmVtb3ZlUmFnZG9sbEZyb21Xb3JsZCA9IGZ1bmN0aW9uIChhY3RvciwgYWZ0ZXJSZW1vdmVDYWxsYmFjaykge1xyXG4gICAgICAgICAgICBfdGhpcy5zZXRMb2NhbERhbWFnZU11bHQoMCk7XHJcbiAgICAgICAgICAgIGFjdG9yLmZvcmNlUmVtb3ZlUmFnZG9sbEZyb21Xb3JsZCgpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZXRMb2NhbERhbWFnZU11bHQoX3RoaXMuZGVmYXVsdExvY2FsRGFtYWdlTXVsdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWZ0ZXJSZW1vdmVDYWxsYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMuZGVmYXVsdExvY2FsRGFtYWdlTXVsdCA9IDE7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgUmFnZG9sbFNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zZXRMb2NhbERhbWFnZU11bHQodGhpcy5kZWZhdWx0TG9jYWxEYW1hZ2VNdWx0KTtcclxuICAgIH07XHJcbiAgICBSYWdkb2xsU2VydmljZS5wcm90b3R5cGUuc2V0TG9jYWxEYW1hZ2VNdWx0ID0gZnVuY3Rpb24gKGRhbWFnZU11bHQpIHtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZEaWZmTXVsdEhQVG9QQ0VcIiwgZGFtYWdlTXVsdCk7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmRGlmZk11bHRIUFRvUENIXCIsIGRhbWFnZU11bHQpO1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZkRpZmZNdWx0SFBUb1BDTFwiLCBkYW1hZ2VNdWx0KTtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZEaWZmTXVsdEhQVG9QQ05cIiwgZGFtYWdlTXVsdCk7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmRGlmZk11bHRIUFRvUENWRVwiLCBkYW1hZ2VNdWx0KTtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZEaWZmTXVsdEhQVG9QQ1ZIXCIsIGRhbWFnZU11bHQpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBSYWdkb2xsU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBSYWdkb2xsU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG52YXIgX19nZW5lcmF0b3IgPSAodGhpcyAmJiB0aGlzLl9fZ2VuZXJhdG9yKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgYm9keSkge1xyXG4gICAgdmFyIF8gPSB7IGxhYmVsOiAwLCBzZW50OiBmdW5jdGlvbigpIHsgaWYgKHRbMF0gJiAxKSB0aHJvdyB0WzFdOyByZXR1cm4gdFsxXTsgfSwgdHJ5czogW10sIG9wczogW10gfSwgZiwgeSwgdCwgZztcclxuICAgIHJldHVybiBnID0geyBuZXh0OiB2ZXJiKDApLCBcInRocm93XCI6IHZlcmIoMSksIFwicmV0dXJuXCI6IHZlcmIoMikgfSwgdHlwZW9mIFN5bWJvbCA9PT0gXCJmdW5jdGlvblwiICYmIChnW1N5bWJvbC5pdGVyYXRvcl0gPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0pLCBnO1xyXG4gICAgZnVuY3Rpb24gdmVyYihuKSB7IHJldHVybiBmdW5jdGlvbiAodikgeyByZXR1cm4gc3RlcChbbiwgdl0pOyB9OyB9XHJcbiAgICBmdW5jdGlvbiBzdGVwKG9wKSB7XHJcbiAgICAgICAgaWYgKGYpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBleGVjdXRpbmcuXCIpO1xyXG4gICAgICAgIHdoaWxlIChnICYmIChnID0gMCwgb3BbMF0gJiYgKF8gPSAwKSksIF8pIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChmID0gMSwgeSAmJiAodCA9IG9wWzBdICYgMiA/IHlbXCJyZXR1cm5cIl0gOiBvcFswXSA/IHlbXCJ0aHJvd1wiXSB8fCAoKHQgPSB5W1wicmV0dXJuXCJdKSAmJiB0LmNhbGwoeSksIDApIDogeS5uZXh0KSAmJiAhKHQgPSB0LmNhbGwoeSwgb3BbMV0pKS5kb25lKSByZXR1cm4gdDtcclxuICAgICAgICAgICAgaWYgKHkgPSAwLCB0KSBvcCA9IFtvcFswXSAmIDIsIHQudmFsdWVdO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKG9wWzBdKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDA6IGNhc2UgMTogdCA9IG9wOyBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDogXy5sYWJlbCsrOyByZXR1cm4geyB2YWx1ZTogb3BbMV0sIGRvbmU6IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICBjYXNlIDU6IF8ubGFiZWwrKzsgeSA9IG9wWzFdOyBvcCA9IFswXTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDc6IG9wID0gXy5vcHMucG9wKCk7IF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKHQgPSBfLnRyeXMsIHQgPSB0Lmxlbmd0aCA+IDAgJiYgdFt0Lmxlbmd0aCAtIDFdKSAmJiAob3BbMF0gPT09IDYgfHwgb3BbMF0gPT09IDIpKSB7IF8gPSAwOyBjb250aW51ZTsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gMyAmJiAoIXQgfHwgKG9wWzFdID4gdFswXSAmJiBvcFsxXSA8IHRbM10pKSkgeyBfLmxhYmVsID0gb3BbMV07IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSA2ICYmIF8ubGFiZWwgPCB0WzFdKSB7IF8ubGFiZWwgPSB0WzFdOyB0ID0gb3A7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHQgJiYgXy5sYWJlbCA8IHRbMl0pIHsgXy5sYWJlbCA9IHRbMl07IF8ub3BzLnB1c2gob3ApOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0WzJdKSBfLm9wcy5wb3AoKTtcclxuICAgICAgICAgICAgICAgICAgICBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG9wID0gYm9keS5jYWxsKHRoaXNBcmcsIF8pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgb3AgPSBbNiwgZV07IHkgPSAwOyB9IGZpbmFsbHkgeyBmID0gdCA9IDA7IH1cclxuICAgICAgICBpZiAob3BbMF0gJiA1KSB0aHJvdyBvcFsxXTsgcmV0dXJuIHsgdmFsdWU6IG9wWzBdID8gb3BbMV0gOiB2b2lkIDAsIGRvbmU6IHRydWUgfTtcclxuICAgIH1cclxufTtcclxuLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuaW1wb3J0IHsgQWN0b3IsIGludGVycnVwdENhc3QsIGNhc3RTcGVsbEltbWVkaWF0ZSwgYXBwbHlBbmltYXRpb25WYXJpYWJsZXNUb0FjdG9yIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBBcm1vciwgQ2VsbCwgR2FtZSwgT2JqZWN0UmVmZXJlbmNlLCBURVNNb2RQbGF0Zm9ybSwgVWksIFV0aWxpdHksIFdvcmxkU3BhY2UsIG9uLCAvLyBUT0RPOiB1c2UgdGhpcy5jb250cm9sbGVyLm9uIGluc3RlYWRcclxub25jZSwgLy8gVE9ETzogdXNlIHRoaXMuY29udHJvbGxlci5vbmNlIGluc3RlYWRcclxuc3RvcmFnZSwgLy8gVE9ETzogdXNlIHRoaXMuc3Auc3RvcmFnZSBpbnN0ZWFkXHJcbiB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuaW1wb3J0ICogYXMgbWVzc2FnZXMgZnJvbSAnLi4vLi4vbWVzc2FnZXMnO1xyXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktZnVuY3Rpb24gKi9cclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tICcuLi8uLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4JztcclxuaW1wb3J0IHsgSWRNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vbGliL2lkTWFuYWdlcic7XHJcbmltcG9ydCB7IG5hbWVvZiB9IGZyb20gJy4uLy4uL2xpYi9uYW1lb2YnO1xyXG5pbXBvcnQgeyBzZXRBY3RvclZhbHVlUGVyY2VudGFnZSB9IGZyb20gJy4uLy4uL3N5bmMvYWN0b3J2YWx1ZXMnO1xyXG5pbXBvcnQgeyBhcHBseUFwcGVhcmFuY2VUb1BsYXllciB9IGZyb20gJy4uLy4uL3N5bmMvYXBwZWFyYW5jZSc7XHJcbmltcG9ydCB7IGFwcGx5RXF1aXBtZW50LCBpc0JhZE1lbnVTaG93biB9IGZyb20gJy4uLy4uL3N5bmMvZXF1aXBtZW50JztcclxuaW1wb3J0IHsgYXBwbHlJbnZlbnRvcnkgfSBmcm9tICcuLi8uLi9zeW5jL2ludmVudG9yeSc7XHJcbmltcG9ydCB7IGxlYXJuU3BlbGxzLCByZW1vdmVBbGxTcGVsbHMgfSBmcm9tICcuLi8uLi9zeW5jL3NwZWxsJztcclxuaW1wb3J0IHsgTW9kZWxBcHBseVV0aWxzIH0gZnJvbSAnLi4vLi4vdmlldy9tb2RlbEFwcGx5VXRpbHMnO1xyXG5pbXBvcnQgeyBMb2FkR2FtZVNlcnZpY2UgfSBmcm9tICcuL2xvYWRHYW1lU2VydmljZSc7XHJcbmltcG9ydCB7IFJhZ2RvbGxTZXJ2aWNlIH0gZnJvbSAnLi9yYWdkb2xsU2VydmljZSc7XHJcbmltcG9ydCB7IFJlc3Bhd25OZWVkZWRFcnJvciB9IGZyb20gJy4uLy4uL2xpYi9lcnJvcnMnO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gJy4vY2xpZW50TGlzdGVuZXInO1xyXG4vLyBUT0RPOiByZWZhY3RvciB3b3JsZFZpZXdNaXNjIGludG8gc2VydmljZVxyXG5pbXBvcnQgeyBnZXRPYmplY3RSZWZlcmVuY2UsIGdldFZpZXdGcm9tU3RvcmFnZSwgcmVtb3RlSWRUb0xvY2FsSWQsIH0gZnJvbSAnLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjJztcclxuaW1wb3J0IHsgVGltZVNlcnZpY2UgfSBmcm9tICcuL3RpbWVTZXJ2aWNlJztcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSAnLi4vLi4vbG9nZ2luZyc7XHJcbmltcG9ydCB7IFZvaWNlQ2hhdFNlcnZpY2UgfSBmcm9tICcuL3ZvaWNlQ2hhdFNlcnZpY2UnO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSAnLi4vLi4vbWVzc2FnZXMnO1xyXG5leHBvcnQgdmFyIGdldFBjSW52ZW50b3J5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHJlcyA9IHN0b3JhZ2VbJ3BjSW52J107XHJcbiAgICBpZiAodHlwZW9mIHJlcyA9PT0gJ29iamVjdCcgJiYgcmVzWydlbnRyaWVzJ10pIHtcclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxufTtcclxudmFyIHNldFBjSW52ZW50b3J5ID0gZnVuY3Rpb24gKGludikge1xyXG4gICAgc3RvcmFnZVsncGNJbnYnXSA9IGludjtcclxufTtcclxudmFyIHBjSW52TGFzdEFwcGx5ID0gMDtcclxub24oJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgIGlmIChpc0JhZE1lbnVTaG93bigpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKERhdGUubm93KCkgLSBwY0ludkxhc3RBcHBseSA+IDUwMDApIHtcclxuICAgICAgICBwY0ludkxhc3RBcHBseSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdmFyIHBjSW52ID0gZ2V0UGNJbnZlbnRvcnkoKTtcclxuICAgICAgICBpZiAocGNJbnYpIHtcclxuICAgICAgICAgICAgYXBwbHlJbnZlbnRvcnkoR2FtZS5nZXRQbGF5ZXIoKSwgcGNJbnYsIGZhbHNlLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xyXG52YXIgdW5lcXVpcElyb25IZWxtZXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgaXJvbkhlbG1lbnQgPSBBcm1vci5mcm9tKEdhbWUuZ2V0Rm9ybUV4KDB4MDAwMTJlNGQpKTtcclxuICAgIHZhciBwbCA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICBpZiAocGwpIHtcclxuICAgICAgICBwbC51bmVxdWlwSXRlbShpcm9uSGVsbWVudCwgZmFsc2UsIHRydWUpO1xyXG4gICAgfVxyXG59O1xyXG52YXIgUmVtb3RlU2VydmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFJlbW90ZVNlcnZlciwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFJlbW90ZVNlcnZlcihzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5udW1TZXRJbnZlbnRvcnkgPSAwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImhvc3RTdGFydE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uSG9zdFN0YXJ0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiaG9zdFN0b3BNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkhvc3RTdG9wTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2V0SW52ZW50b3J5TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZXRJbnZlbnRvcnlNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJvcGVuQ29udGFpbmVyTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25PcGVuQ29udGFpbmVyTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlTW92ZW1lbnRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZU1vdmVtZW50TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlQW5pbWF0aW9uTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVBbmltYXRpb25NZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVFcXVpcG1lbnRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZUVxdWlwbWVudE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNoYW5nZVZhbHVlc01lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ2hhbmdlVmFsdWVzTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlQXBwZWFyYW5jZU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlQXBwZWFyYW5jZU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInRlbGVwb3J0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25UZWxlcG9ydE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInRlbGVwb3J0TWVzc2FnZTJcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVGVsZXBvcnRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3JlYXRlQWN0b3JNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJkZXN0cm95QWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkRlc3Ryb3lBY3Rvck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNldFJhY2VNZW51T3Blbk1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2V0UmFjZU1lbnVPcGVuTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlUHJvcGVydHlNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZVByb3BlcnR5TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiZGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uRGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNvbm5lY3Rpb25BY2NlcHRlZFwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5oYW5kbGVDb25uZWN0aW9uQWNjZXB0ZWQoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic3BlbGxDYXN0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TcGVsbENhc3RNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVBbmltVmFyaWFibGVzTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVBbmltVmFyaWFibGVzTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidm9pY2VDaGF0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Wb2ljZUNoYXRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVWb2ljZUNoYXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZVZvaWNlQ2hhdE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25Ib3N0U3RhcnRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIHRhcmdldCA9IG1zZy50YXJnZXQ7XHJcbiAgICAgICAgdmFyIGhvc3RlZCA9IHN0b3JhZ2VbJ2hvc3RlZCddO1xyXG4gICAgICAgIGlmICh0eXBlb2YgaG9zdGVkICE9PSB0eXBlb2YgW10pIHtcclxuICAgICAgICAgICAgLy8gaWYgeW91IHRyeSB0byBzd2l0Y2ggdG8gU2V0IHBsZWFzZSBjaGVja291dCAuY29uY2F0IHVzYWdlLlxyXG4gICAgICAgICAgICAvLyBjb25jYXQgY29tcGlsZXMgYnV0IGRvZXNuJ3Qgd29yayBhcyBleHBlY3RlZFxyXG4gICAgICAgICAgICBob3N0ZWQgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICAgICAgc3RvcmFnZVsnaG9zdGVkJ10gPSBob3N0ZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghaG9zdGVkLmluY2x1ZGVzKHRhcmdldCkpIHtcclxuICAgICAgICAgICAgaG9zdGVkLnB1c2godGFyZ2V0KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbkhvc3RTdG9wTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciB0YXJnZXQgPSBtc2cudGFyZ2V0O1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsICdob3N0U3RvcCAnICsgdGFyZ2V0LnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgdmFyIGhvc3RlZCA9IHN0b3JhZ2VbJ2hvc3RlZCddO1xyXG4gICAgICAgIGlmICh0eXBlb2YgaG9zdGVkID09PSB0eXBlb2YgW10pIHtcclxuICAgICAgICAgICAgc3RvcmFnZVsnaG9zdGVkJ10gPSBob3N0ZWQuZmlsdGVyKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4ICE9PSB0YXJnZXQ7IH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uU2V0SW52ZW50b3J5TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5udW1TZXRJbnZlbnRvcnkrKztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHNldFBjSW52ZW50b3J5KG1zZy5pbnZlbnRvcnkpO1xyXG4gICAgICAgICAgICB2YXIgYmxvY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdCgncXVlcnlCbG9ja1NldEludmVudG9yeUV2ZW50Jywge1xyXG4gICAgICAgICAgICAgICAgYmxvY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGJsb2NrZWQgPSB0cnVlOyB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAoIWJsb2NrZWQpIHtcclxuICAgICAgICAgICAgICAgIHBjSW52TGFzdEFwcGx5ID0gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25PcGVuQ29udGFpbmVyTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkgeyByZXR1cm4gX19hd2FpdGVyKF90aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVtb3RlSWQsIGxvY2FsSWQsIHJlZnIsIGJhc2VPYmplY3QsIGJhc2VUeXBlLCBmdW5jdGlvbkNoZWNrZXIsIGZhY3ROYW1lLCBkZWxheVNlY29uZHM7XHJcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6IHJldHVybiBbNCAvKnlpZWxkKi8sIFV0aWxpdHkud2FpdCgwLjEpXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTsgLy8gR2l2ZSBhIGNoYW5jZSB0byB1cGRhdGUgaW52ZW50b3J5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZUlkID0gZXZlbnQubWVzc2FnZS50YXJnZXQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsSWQgPSByZW1vdGVJZFRvTG9jYWxJZChyZW1vdGVJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChsb2NhbElkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWZyID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCAnb25PcGVuQ29udGFpbmVyTWVzc2FnZSAtIHJlZnIgbm90IGZvdW5kJywgJ3JlbW90ZUlkJywgcmVtb3RlSWQudG9TdHJpbmcoMTYpLCAnbG9jYWxJZCcsIGxvY2FsSWQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyLmFjdGl2YXRlKEdhbWUuZ2V0UGxheWVyKCksIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBiYXNlT2JqZWN0ID0gcmVmci5nZXRCYXNlT2JqZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VUeXBlID0gYmFzZU9iamVjdCA9PT0gbnVsbCB8fCBiYXNlT2JqZWN0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBiYXNlT2JqZWN0LmdldFR5cGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb25DaGVja2VyID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmFjdE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxheVNlY29uZHMgPSAtMS4wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZVR5cGUgPT09IDI4IC8qIEZvcm1UeXBlLkNvbnRhaW5lciAqLykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb25DaGVja2VyID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gVWkuaXNNZW51T3BlbihcIkNvbnRhaW5lck1lbnVcIik7IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWN0TmFtZSA9IFwiJ0NvbnRhaW5lck1lbnUgb3BlbidcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5U2Vjb25kcyA9IDAuMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiYXNlVHlwZSA9PT0gNDAgLyogRm9ybVR5cGUuRnVybml0dXJlICovKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkNoZWNrZXIgPSBmdW5jdGlvbiAoKSB7IHZhciBfYTsgcmV0dXJuICEhKChfYSA9IEdhbWUuZ2V0UGxheWVyKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGdXJuaXR1cmVSZWZlcmVuY2UoKSk7IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWN0TmFtZSA9IFwiJ2dldEZ1cm5pdHVyZVJlZmVyZW5jZSBub3QgbnVsbCdcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5U2Vjb25kcyA9IDEuMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZnVuY3Rpb25DaGVja2VyID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uT3BlbkNvbnRhaW5lck1lc2FnZSAtIG5vdCBhIGNvbnRhaW5lciBvciBmdXJuaXR1cmVcIiwgYmFzZVR5cGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluIFNreU1QIGNvbnRhaW5lcnMgaGF2ZSAyLW5kLCBjbG9zaW5nIGFjdGl2YXRpb24gdW5kZXIgdGhlIGhvb2QuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgZGlmZmVycyBmcm9tIFNreXJpbSdzIGJlaGF2aW9yLCB3aGVyZSBpdCdzIGp1c3Qgb25lIGFjdGl2YXRpb24uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7IHJldHVybiBfX2F3YWl0ZXIoX3RoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uT3BlbkNvbnRhaW5lck1lc2FnZSAtIHdhaXRpbmcgZm9yXCIsIGZhY3ROYW1lLCBcInRvIGJlIHRydWVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYS5sYWJlbCA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIWZ1bmN0aW9uQ2hlY2tlcigpKSByZXR1cm4gWzMgLypicmVhayovLCAzXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIFV0aWxpdHkud2FpdCgwLjEpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25PcGVuQ29udGFpbmVyTWVzYWdlIC0gd2FpdGluZyBmb3JcIiwgZmFjdE5hbWUsIFwidG8gYmUgZmFsc2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYS5sYWJlbCA9IDQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZnVuY3Rpb25DaGVja2VyKCkpIHJldHVybiBbMyAvKmJyZWFrKi8sIDZdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgVXRpbGl0eS53YWl0KDAuMSldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCA0XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA2OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbk9wZW5Db250YWluZXJNZXNhZ2UgLSBtZW51IGNsb3NlZFwiLCBmYWN0TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ6IG1lc3NhZ2VzLk1zZ1R5cGUuQWN0aXZhdGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXN0ZXI6IDB4MTQsIHRhcmdldDogZXZlbnQubWVzc2FnZS50YXJnZXQsIGlzU2Vjb25kQWN0aXZhdGlvbjogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uT3BlbkNvbnRhaW5lck1lc2FnZSAtIHdhaXRpbmdcIiwgZGVsYXlTZWNvbmRzLCBcInNlY29uZHMgYmVmb3JlIHNlbmRpbmcgQWN0aXZhdGVNZXNzYWdlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbGl0eS53YWl0TWVudU1vZGUoZGVsYXlTZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIm9uT3BlbkNvbnRhaW5lck1lc2FnZSAtIHNlbnQgQWN0aXZhdGVNZXNzYWdlXCIsIG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pOyB9KSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pOyB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVGVsZXBvcnRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBpZCA9IChcImlkeFwiIGluIG1zZyAmJiB0eXBlb2YgbXNnLmlkeCA9PT0gXCJudW1iZXJcIikgPyBfdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KSA6IF90aGlzLmdldE15QWN0b3JJbmRleCgpO1xyXG4gICAgICAgICAgICB2YXIgcmVmciA9IGlkID09PSBfdGhpcy5nZXRNeUFjdG9ySW5kZXgoKSA/IEdhbWUuZ2V0UGxheWVyKCkgOiBnZXRPYmplY3RSZWZlcmVuY2UoaWQpO1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJUZWxlcG9ydGluZyBpZFwiLCBpZCwgXCJyZWZySWRcIiwgcmVmciA9PT0gbnVsbCB8fCByZWZyID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZWZyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSwgXCIuLi5cIiwgbXNnLnBvcywgJ2NlbGwvd29ybGQgaXMnLCBtc2cud29ybGRPckNlbGwudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgdmFyIHJhZ2RvbGxTZXJ2aWNlID0gX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSYWdkb2xsU2VydmljZSk7XHJcbiAgICAgICAgICAgIHZhciByZWZySWQgPSByZWZyID09PSBudWxsIHx8IHJlZnIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgIHZhciByZW1vdmVSYWdkb2xsQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBURVNNb2RQbGF0Zm9ybS5tb3ZlUmVmclRvUG9zaXRpb24oT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkIHx8IDApKSwgQ2VsbC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KG1zZy53b3JsZE9yQ2VsbCkpLCBXb3JsZFNwYWNlLmZyb20oR2FtZS5nZXRGb3JtRXgobXNnLndvcmxkT3JDZWxsKSksIG1zZy5wb3NbMF0sIG1zZy5wb3NbMV0sIG1zZy5wb3NbMl0sIG1zZy5yb3RbMF0sIG1zZy5yb3RbMV0sIG1zZy5yb3RbMl0pO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAoYWN0b3IgLyomJiBhY3Rvci5nZXRGb3JtSUQoKSA9PT0gMHgxNCovKSB7XHJcbiAgICAgICAgICAgICAgICByYWdkb2xsU2VydmljZS5zYWZlUmVtb3ZlUmFnZG9sbEZyb21Xb3JsZChhY3RvciwgcmVtb3ZlUmFnZG9sbENhbGxiYWNrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlbW92ZVJhZ2RvbGxDYWxsYmFjaygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbkNyZWF0ZUFjdG9yTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIGlmICh0aGlzLnNraXBGb3JtVmlld0NyZWF0aW9uKG1zZykpIHtcclxuICAgICAgICAgICAgdmFyIHJlZnJJZF8xID0gbXNnLnJlZnJJZDtcclxuICAgICAgICAgICAgdGhpcy5vbmNlTG9hZChyZWZySWRfMSwgZnVuY3Rpb24gKHJlZnIpIHtcclxuICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgIGlmIChyZWZyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0UmVmZXJlbmNlRXguZGVhbFdpdGhSZWYocmVmciwgcmVmci5nZXRCYXNlT2JqZWN0KCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtc2cucHJvcHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zZy5wcm9wcy5pbnZlbnRvcnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSW52ZW50b3J5KHJlZnIsIG1zZy5wcm9wcy5pbnZlbnRvcnkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNPcGVuKHJlZnIsICEhbXNnLnByb3BzWydpc09wZW4nXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNIYXJ2ZXN0ZWQocmVmciwgISFtc2cucHJvcHNbJ2lzSGFydmVzdGVkJ10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbE5vZGVTY2FsZShyZWZyLCBtc2cucHJvcHMuc2V0Tm9kZVNjYWxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxOb2RlVGV4dHVyZVNldChyZWZyLCBtc2cucHJvcHMuc2V0Tm9kZVRleHR1cmVTZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzRGlzYWJsZWQocmVmciwgISFtc2cucHJvcHNbJ2Rpc2FibGVkJ10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRvIGEgc2VwYXJhdGUgbW9kdWxlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRpb25fMSA9IG1zZy5wcm9wcy5sYXN0QW5pbWF0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFuaW1hdGlvbl8xID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmcmlkXzEgPSByZWZyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9fYXdhaXRlcihfdGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaV8xLCByZXMyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9iKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2IubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpXzEgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9iLmxhYmVsID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShpXzEgPCA1KSkgcmV0dXJuIFszIC8qYnJlYWsqLywgNF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzMiA9IChfYSA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJpZF8xKSkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wbGF5QW5pbWF0aW9uKGFuaW1hdGlvbl8xKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzMikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCA0XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgVXRpbGl0eS53YWl0KDIpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYi5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2IubGFiZWwgPSAzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlfMSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OiByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOyB9KSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG1zZy5wcm9wcy5kaXNwbGF5TmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8ga2VlcCBpbiBzeW5jIHdpdGggc3BTbmlwcGV0U2VydmljZS50c1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRpc3BsYXlOYW1lID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZVZhbHVlID0gKF9hID0gcmVmci5nZXRCYXNlT2JqZWN0KCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXROYW1lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZVZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZSA9IGRpc3BsYXlOYW1lLnJlcGxhY2UoLyVvcmlnaW5hbF9uYW1lJS9nLCByZXBsYWNlVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiQ291bGRuJ3QgZ2V0IGEgcmVwbGFjZVZhbHVlIGZvciBTZXREaXNwbGF5TmFtZSwgcmVmci5nZXRGb3JtSUQoKSB3YXNcIiwgcmVmci5nZXRGb3JtSUQoKS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5zZXREaXNwbGF5TmFtZShkaXNwbGF5TmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJjYWxsaW5nIHNldERpc3BsYXlOYW1lXCIsIGRpc3BsYXlOYW1lLCBcImZvclwiLCByZWZyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgJ0ZhaWxlZCB0byBhcHBseSBtb2RlbCB0bycsIHJlZnJJZF8xLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ3JlYXRlIGFjdG9yXCIpO1xyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5hbGxvY2F0ZUlkRm9yKG1zZy5pZHgpO1xyXG4gICAgICAgIGlmICh0aGlzLndvcmxkTW9kZWwuZm9ybXMubGVuZ3RoIDw9IGkpIHtcclxuICAgICAgICAgICAgdGhpcy53b3JsZE1vZGVsLmZvcm1zLmxlbmd0aCA9IGkgKyAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbW92ZW1lbnQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgLy8gVE9ETzogYmV0dGVyIGNoZWNrIGlmIGl0IGlzIGFuIG5wYyAobm90IGFuIG9iamVjdCByZWZlcmVuY2UpXHJcbiAgICAgICAgaWYgKG1zZy5yZWZySWQgIT09IHVuZGVmaW5lZCAmJiBtc2cucmVmcklkID49IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgbW92ZW1lbnQgPSB7XHJcbiAgICAgICAgICAgICAgICBwb3M6IG1zZy50cmFuc2Zvcm0ucG9zLFxyXG4gICAgICAgICAgICAgICAgcm90OiBtc2cudHJhbnNmb3JtLnJvdCxcclxuICAgICAgICAgICAgICAgIHdvcmxkT3JDZWxsOiBtc2cudHJhbnNmb3JtLndvcmxkT3JDZWxsLFxyXG4gICAgICAgICAgICAgICAgcnVuTW9kZTogJ1N0YW5kaW5nJyxcclxuICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogMCxcclxuICAgICAgICAgICAgICAgIGlzSW5KdW1wU3RhdGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaXNTbmVha2luZzogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc0Jsb2NraW5nOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGlzV2VhcERyYXduOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGlzRGVhZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBoZWFsdGhQZXJjZW50YWdlOiAxLjAsXHJcbiAgICAgICAgICAgICAgICBzcGVlZDogMCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGZvcm0gPSB7XHJcbiAgICAgICAgICAgIGlkeDogbXNnLmlkeCxcclxuICAgICAgICAgICAgbW92ZW1lbnQ6IG1vdmVtZW50LFxyXG4gICAgICAgICAgICBudW1Nb3ZlbWVudENoYW5nZXM6IDAsXHJcbiAgICAgICAgICAgIG51bUFwcGVhcmFuY2VDaGFuZ2VzOiAwLFxyXG4gICAgICAgICAgICBiYXNlSWQ6IG1zZy5iYXNlSWQsXHJcbiAgICAgICAgICAgIHJlZnJJZDogbXNnLnJlZnJJZCxcclxuICAgICAgICAgICAgaXNNeUNsb25lOiBtc2cuaXNNZSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXSA9IGZvcm07XHJcbiAgICAgICAgaWYgKG1zZy5hcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgIGZvcm0uYXBwZWFyYW5jZSA9IG1zZy5hcHBlYXJhbmNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLmVxdWlwbWVudCkge1xyXG4gICAgICAgICAgICBmb3JtLmVxdWlwbWVudCA9IG1zZy5lcXVpcG1lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cuaXNEZWFkKSB7XHJcbiAgICAgICAgICAgIGZvcm0uaXNEZWFkID0gbXNnLmlzRGVhZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5hbmltYXRpb24pIHtcclxuICAgICAgICAgICAgZm9ybS5hbmltYXRpb24gPSBtc2cuYW5pbWF0aW9uO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLnByb3BzKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIG1zZy5wcm9wcykge1xyXG4gICAgICAgICAgICAgICAgZm9ybVtwcm9wTmFtZV0gPSBtc2cucHJvcHNbcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG1zZy5jdXN0b21Qcm9wc0pzb25EdW1wcy5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7XHJcbiAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgdmFyIHBhcnNlZDtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHBhcnNlZCA9IEpTT04ucGFyc2UoZWxlbWVudC5wcm9wVmFsdWVKc29uRHVtcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJjcmVhdGVBY3RvclwiLCAoX2EgPSBtc2cucmVmcklkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudG9TdHJpbmcoMTYpLCBcImZhaWxlZCB0byBwYXJzZSBjdXN0b20gcHJvcFwiLCBlbGVtZW50LnByb3BOYW1lLCBlbGVtZW50LnByb3BWYWx1ZUpzb25EdW1wLCBlLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmb3JtW2VsZW1lbnQucHJvcE5hbWVdID0gcGFyc2VkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChtc2cuaXNNZSkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9IGk7XHJcbiAgICAgICAgICAgIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJSZWZySWQgPSBtc2cucmVmcklkIHx8IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFRPRE86IG1vdmUgdG8gYSBzZXBhcmF0ZSBtb2R1bGVcclxuICAgICAgICBpZiAobXNnLnByb3BzICYmICFtc2cucHJvcHMuaXNIb3N0ZWRCeU90aGVyKSB7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cucHJvcHMgJiYgbXNnLnByb3BzLmlzUmFjZU1lbnVPcGVuICYmIG1zZy5pc01lKSB7XHJcbiAgICAgICAgICAgIHRoaXMub25TZXRSYWNlTWVudU9wZW5NZXNzYWdlKHsgbWVzc2FnZTogeyB0OiBNc2dUeXBlLlNldFJhY2VNZW51T3Blbiwgb3BlbjogdHJ1ZSB9IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbnVtU2V0SW52ZW50b3J5ID0gdGhpcy5udW1TZXRJbnZlbnRvcnk7XHJcbiAgICAgICAgdmFyIGFwcGx5UGNJbnYgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChtc2cuZXF1aXBtZW50KSB7XHJcbiAgICAgICAgICAgICAgICBhcHBseUVxdWlwbWVudChHYW1lLmdldFBsYXllcigpLCBtc2cuZXF1aXBtZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobnVtU2V0SW52ZW50b3J5ICE9PSBfdGhpcy5udW1TZXRJbnZlbnRvcnkpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCAnU2tpcHBpbmcgaW52ZW50b3J5IGFwcGx5IGR1ZSB0byBuZXdlciBzZXRJbnZlbnRvcnkgbWVzc2FnZScpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChtc2cucHJvcHMgJiYgbXNnLnByb3BzLmludmVudG9yeSkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMub25TZXRJbnZlbnRvcnlNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuU2V0SW52ZW50b3J5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnZlbnRvcnk6IG1zZy5wcm9wcy5pbnZlbnRvcnlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKG1zZy5pc01lICYmIG1zZy5wcm9wcyAmJiBtc2cucHJvcHMubGVhcm5lZFNwZWxscykge1xyXG4gICAgICAgICAgICB2YXIgbGVhcm5lZFNwZWxsc18xID0gbXNnLnByb3BzLmxlYXJuZWRTcGVsbHM7XHJcbiAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxpdHkud2FpdCgxKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGxheWVyID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbFNwZWxscyhwbGF5ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZWFyblNwZWxscyhwbGF5ZXIsIGxlYXJuZWRTcGVsbHNfMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcInBsYXllciBsZWFybmVkU3BlbGxzOlwiLCBKU09OLnN0cmluZ2lmeShsZWFybmVkU3BlbGxzXzEpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cuaXNNZSkge1xyXG4gICAgICAgICAgICBpZiAoKF9hID0gbXNnLnByb3BzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuaXNEZWFkKSB7XHJcbiAgICAgICAgICAgICAgICBvbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFwcGx5RGVhdGhTdGF0ZUV2ZW50XCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3I6IEdhbWUuZ2V0UGxheWVyKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRGVhZDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5pc01lKSB7XHJcbiAgICAgICAgICAgIHZhciBzcGF3blRhc2tfMSA9IHsgcnVubmluZzogZmFsc2UgfTtcclxuICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgLy8gVXNlIE1vdmVSZWZyVG9Qb3NpdGlvbiB0byBzcGF3biBpZiBwb3NzaWJsZSAobm90IGluIG1haW4gbWVudSlcclxuICAgICAgICAgICAgICAgIC8vIEluIGNhc2Ugb2YgY29ubmVjdGlvbiBsb3N0IHRoaXMgaXMgZXNzZW50aWFsXHJcbiAgICAgICAgICAgICAgICBpZiAoIXNwYXduVGFza18xLnJ1bm5pbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBzcGF3blRhc2tfMS5ydW5uaW5nID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgJ1VzaW5nIG1vdmVSZWZyVG9Qb3NpdGlvbiB0byBzcGF3biBwbGF5ZXInKTtcclxuICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgeyByZXR1cm4gX19hd2FpdGVyKF90aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGwsIHBvcywgc3FyLCBkaXN0YW5jZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0cnVlKSByZXR1cm4gWzMgLypicmVhayovLCAyXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1NwYXduaW5nLi4uJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRFU01vZFBsYXRmb3JtLm1vdmVSZWZyVG9Qb3NpdGlvbihHYW1lLmdldFBsYXllcigpLCBDZWxsLmZyb20oR2FtZS5nZXRGb3JtRXgobXNnLnRyYW5zZm9ybS53b3JsZE9yQ2VsbCkpLCBXb3JsZFNwYWNlLmZyb20oR2FtZS5nZXRGb3JtRXgobXNnLnRyYW5zZm9ybS53b3JsZE9yQ2VsbCkpLCBtc2cudHJhbnNmb3JtLnBvc1swXSwgbXNnLnRyYW5zZm9ybS5wb3NbMV0sIG1zZy50cmFuc2Zvcm0ucG9zWzJdLCBtc2cudHJhbnNmb3JtLnJvdFswXSwgbXNnLnRyYW5zZm9ybS5yb3RbMV0sIG1zZy50cmFuc2Zvcm0ucm90WzJdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgVXRpbGl0eS53YWl0KDEpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGwgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXBsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAyXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbC5nZXRQb3NpdGlvblgoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsLmdldFBvc2l0aW9uWSgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGwuZ2V0UG9zaXRpb25aKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNxciA9IGZ1bmN0aW9uICh4KSB7IHJldHVybiB4ICogeDsgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2UgPSBNYXRoLnNxcnQoc3FyKHBvc1swXSAtIG1zZy50cmFuc2Zvcm0ucG9zWzBdKSArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcXIocG9zWzFdIC0gbXNnLnRyYW5zZm9ybS5wb3NbMV0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlIDwgMjU2KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAyXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAwXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6IHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7IH0pKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVW5mb3J0dW5hdGVsbHkgaXQgcmVxdWlyZXMgdHdvIGNhbGxzIHRvIHdvcmtcclxuICAgICAgICAgICAgICAgICAgICBVdGlsaXR5LndhaXQoMSkudGhlbihhcHBseVBjSW52KTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlsaXR5LndhaXQoMS4zKS50aGVuKGFwcGx5UGNJbnYpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIE5vdGU6IGFwcGVhcmFuY2UgcGFydCB3YXMgY29weS1wYXN0ZWRcclxuICAgICAgICAgICAgICAgICAgICBpZiAobXNnLmFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlBcHBlYXJhbmNlVG9QbGF5ZXIobXNnLmFwcGVhcmFuY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChtc2cucHJvcHMpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYmFzZUFjdG9yVmFsdWVzXzEgPSBuZXcgTWFwKFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydoZWFsUmF0ZScsIG1zZy5wcm9wcy5oZWFsUmF0ZV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnaGVhbFJhdGVNdWx0JywgbXNnLnByb3BzLmhlYWxSYXRlTXVsdF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnaGVhbHRoJywgbXNnLnByb3BzLmhlYWx0aF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnbWFnaWNrYVJhdGUnLCBtc2cucHJvcHMubWFnaWNrYVJhdGVdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ21hZ2lja2FSYXRlTXVsdCcsIG1zZy5wcm9wcy5tYWdpY2thUmF0ZU11bHRdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ21hZ2lja2EnLCBtc2cucHJvcHMubWFnaWNrYV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnc3RhbWluYVJhdGUnLCBtc2cucHJvcHMuc3RhbWluYVJhdGVdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ3N0YW1pbmFSYXRlTXVsdCcsIG1zZy5wcm9wcy5zdGFtaW5hUmF0ZU11bHRdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ3N0YW1pbmEnLCBtc2cucHJvcHMuc3RhbWluYV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnaGVhbHRoUGVyY2VudGFnZScsIG1zZy5wcm9wcy5oZWFsdGhQZXJjZW50YWdlXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydzdGFtaW5hUGVyY2VudGFnZScsIG1zZy5wcm9wcy5zdGFtaW5hUGVyY2VudGFnZV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnbWFnaWNrYVBlcmNlbnRhZ2UnLCBtc2cucHJvcHMubWFnaWNrYVBlcmNlbnRhZ2VdLFxyXG4gICAgICAgICAgICAgICAgICAgIF0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwbGF5ZXJfMSA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllcl8xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VBY3RvclZhbHVlc18xLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleS5pbmNsdWRlcygnUGVyY2VudGFnZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdWJLZXkgPSBrZXkucmVwbGFjZSgnUGVyY2VudGFnZScsICcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN1YlZhbHVlID0gYmFzZUFjdG9yVmFsdWVzXzEuZ2V0KHN1YktleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3ViVmFsdWUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRBY3RvclZhbHVlUGVyY2VudGFnZShwbGF5ZXJfMSwgc3ViS2V5LCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllcl8xLnNldEFjdG9yVmFsdWUoa2V5LCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBvbmNlKCd0aWNrJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgb25jZSgndGljaycsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXNwYXduVGFza18xLnJ1bm5pbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Bhd25UYXNrXzEucnVubmluZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2FkT3JkZXIgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaV8yID0gMDsgaV8yIDwgX3RoaXMuc3AuR2FtZS5nZXRNb2RDb3VudCgpOyArK2lfMikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZE9yZGVyLnB1c2goX3RoaXMuc3AuR2FtZS5nZXRNb2ROYW1lKGlfMikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcImxvYWRpbmcgZ2FtZSBpbiB3b3JsZC9jZWxsXCIsIG1zZy50cmFuc2Zvcm0ud29ybGRPckNlbGwudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRHYW1lU2VydmljZSA9IF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTG9hZEdhbWVTZXJ2aWNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9hZEdhbWVTZXJ2aWNlLmxvYWRHYW1lKG1zZy50cmFuc2Zvcm0ucG9zLCBtc2cudHJhbnNmb3JtLnJvdCwgbXNnLnRyYW5zZm9ybS53b3JsZE9yQ2VsbCwgbXNnLmFwcGVhcmFuY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG1zZy5hcHBlYXJhbmNlLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFjZUlkOiBtc2cuYXBwZWFyYW5jZS5yYWNlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogSW4gdHlwZXMsIGlzRmVtYWxlIGlzIHVuZGVyIGZhY2UsIGJ1dCBpbiB0aGUgcmVhbGl0eSBTUCBleHBlY3RzIGl0IGhlcmUuIEZpeCByZXF1aXJlZC5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNGZW1hbGU6IG1zZy5hcHBlYXJhbmNlLmlzRmVtYWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFpckNvbG9yOiBtc2cuYXBwZWFyYW5jZS5oYWlyQ29sb3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHlTa2luQ29sb3I6IG1zZy5hcHBlYXJhbmNlLnNraW5Db2xvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZFRleHR1cmVTZXRJZDogbXNnLmFwcGVhcmFuY2UuaGVhZFRleHR1cmVTZXRJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZFBhcnRJZHM6IG1zZy5hcHBlYXJhbmNlLmhlYWRwYXJ0SWRzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXRzOiBtc2cuYXBwZWFyYW5jZS5wcmVzZXRzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLCBsb2FkT3JkZXIsIHsgbWludXRlczogMCwgc2Vjb25kczogMCwgaG91cnM6IF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoVGltZVNlcnZpY2UpLmdldFRpbWUoKS5uZXdHYW1lSG91clZhbHVlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBseVBjSW52KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlsaXR5LndhaXQoMC4zKS50aGVuKGFwcGx5UGNJbnYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90ZTogYXBwZWFyYW5jZSBwYXJ0IHdhcyBjb3B5LXBhc3RlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zZy5hcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlBcHBlYXJhbmNlVG9QbGF5ZXIobXNnLmFwcGVhcmFuY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25EZXN0cm95QWN0b3JNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV0gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgKF9hID0gZ2V0Vmlld0Zyb21TdG9yYWdlKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zeW5jRm9ybUFycmF5KHRoaXMud29ybGRNb2RlbCk7XHJcbiAgICAgICAgLy8gU2hyaW5rIHRvIGZpdFxyXG4gICAgICAgIHdoaWxlICgxKSB7XHJcbiAgICAgICAgICAgIHZhciBsZW5ndGggPSB0aGlzLndvcmxkTW9kZWwuZm9ybXMubGVuZ3RoO1xyXG4gICAgICAgICAgICBpZiAoIWxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMud29ybGRNb2RlbC5mb3Jtc1tsZW5ndGggLSAxXSkge1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy53b3JsZE1vZGVsLmZvcm1zLmxlbmd0aCA9IGxlbmd0aCAtIDE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9PT0gaSkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9IC0xO1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyUmVmcklkID0gMDtcclxuICAgICAgICAgICAgLy8gVE9ETzogbW92ZSB0byBhIHNlcGFyYXRlIG1vZHVsZVxyXG4gICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7IHJldHVybiBHYW1lLnF1aXRUb01haW5NZW51KCk7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmdldElkTWFuYWdlcigpLmZyZWVJZEZvcihtc2cuaWR4KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlTW92ZW1lbnRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgIHZhciBmb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldO1xyXG4gICAgICAgIGlmIChmb3JtID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvblVwZGF0ZU1vdmVtZW50TWVzc2FnZSAtIEZvcm0gd2l0aCBpZHhcIiwgbXNnLmlkeCwgXCJub3QgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybS5tb3ZlbWVudCA9IG1zZy5kYXRhO1xyXG4gICAgICAgIGlmICghZm9ybS5udW1Nb3ZlbWVudENoYW5nZXMpIHtcclxuICAgICAgICAgICAgZm9ybS5udW1Nb3ZlbWVudENoYW5nZXMgPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtLm51bU1vdmVtZW50Q2hhbmdlcysrO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVBbmltYXRpb25NZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgIHZhciBmb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldO1xyXG4gICAgICAgIGlmIChmb3JtID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvblVwZGF0ZUFuaW1hdGlvbk1lc3NhZ2UgLSBGb3JtIHdpdGggaWR4XCIsIG1zZy5pZHgsIFwibm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm0uYW5pbWF0aW9uID0gbXNnLmRhdGE7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZUFwcGVhcmFuY2VNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV07XHJcbiAgICAgICAgaWYgKGZvcm0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uVXBkYXRlQXBwZWFyYW5jZU1lc3NhZ2UgLSBGb3JtIHdpdGggaWR4XCIsIG1zZy5pZHgsIFwibm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm0uYXBwZWFyYW5jZSA9IG1zZy5kYXRhIHx8IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAoIWZvcm0ubnVtQXBwZWFyYW5jZUNoYW5nZXMpIHtcclxuICAgICAgICAgICAgZm9ybS5udW1BcHBlYXJhbmNlQ2hhbmdlcyA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm0ubnVtQXBwZWFyYW5jZUNoYW5nZXMrKztcclxuICAgICAgICB2YXIgbmV3QXBwZWFyYW5jZSA9IG1zZy5kYXRhO1xyXG4gICAgICAgIGlmIChpID09PSB0aGlzLmdldE15QWN0b3JJbmRleCgpICYmIG5ld0FwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgYXBwbHlBcHBlYXJhbmNlVG9QbGF5ZXIobmV3QXBwZWFyYW5jZSk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJBcHBsaWVkIGFwcGVhcmFuY2UgdG8gdGhlIHBsYXllclwiKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVFcXVpcG1lbnRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgIHZhciBmb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldO1xyXG4gICAgICAgIGlmIChmb3JtID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvblVwZGF0ZUVxdWlwbWVudE1lc3NhZ2UgLSBGb3JtIHdpdGggaWR4XCIsIG1zZy5pZHgsIFwibm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm0uZXF1aXBtZW50ID0gbXNnLmRhdGE7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZVByb3BlcnR5TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIG1zZ0RhdGEgPSB0aGlzLmV4dHJhY3RVcGRhdGVQcm9wZXJ0eU1lc3NhZ2VEYXRhKG1zZyk7XHJcbiAgICAgICAgaWYgKHRoaXMuc2tpcEZvcm1WaWV3Q3JlYXRpb24obXNnKSkge1xyXG4gICAgICAgICAgICB2YXIgcmVmcklkXzIgPSBtc2cucmVmcklkO1xyXG4gICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZF8yKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJlZnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgJ1VwZGF0ZVByb3BlcnR5OiByZWZyIG5vdCBmb3VuZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChtc2cucHJvcE5hbWUgPT09ICdpbnZlbnRvcnknKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJbnZlbnRvcnkocmVmciwgbXNnRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2cucHJvcE5hbWUgPT09ICdpc09wZW4nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc09wZW4ocmVmciwgISFtc2dEYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZy5wcm9wTmFtZSA9PT0gJ2lzSGFydmVzdGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNIYXJ2ZXN0ZWQocmVmciwgISFtc2dEYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZy5wcm9wTmFtZSA9PT0gJ2Rpc2FibGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNEaXNhYmxlZChyZWZyLCAhIW1zZ0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV07XHJcbiAgICAgICAgZm9ybVttc2cucHJvcE5hbWVdID0gbXNnRGF0YTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uRGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgZGVhdGggc3RhdGU6XCIsIEpTT04uc3RyaW5naWZ5KG1zZy50SXNEZWFkKSk7XHJcbiAgICAgICAgdmFyIGlkID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cudElzRGVhZC5pZHgpO1xyXG4gICAgICAgIHZhciBmb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zW2lkXTtcclxuICAgICAgICBpZiAoZm9ybSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25EZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZSAtIEZvcm0gd2l0aCBpZHhcIiwgbXNnLnRJc0RlYWQuaWR4LCBcIm5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLnRJc0RlYWQucHJvcE5hbWUgIT09IG5hbWVvZignaXNEZWFkJykpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvbkRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlIC0gSW52YWxpZCBwcm9wTmFtZVwiLCBtc2cudElzRGVhZC5wcm9wTmFtZSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG1zZ0RhdGEgPSB0aGlzLmV4dHJhY3RVcGRhdGVQcm9wZXJ0eU1lc3NhZ2VEYXRhKG1zZy50SXNEZWFkKTtcclxuICAgICAgICBpZiAodHlwZW9mIG1zZ0RhdGEgIT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uRGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2UgLSBJbnZhbGlkIGRhdGFcIiwgbXNnRGF0YSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy50Q2hhbmdlVmFsdWVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2VWYWx1ZXNNZXNzYWdlKHsgbWVzc2FnZTogbXNnLnRDaGFuZ2VWYWx1ZXMgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlUHJvcGVydHlNZXNzYWdlKHsgbWVzc2FnZTogbXNnLnRJc0RlYWQgfSk7IH0pO1xyXG4gICAgICAgIGlmIChtc2cudFRlbGVwb3J0KSB7XHJcbiAgICAgICAgICAgIHRoaXMub25UZWxlcG9ydE1lc3NhZ2UoeyBtZXNzYWdlOiBtc2cudFRlbGVwb3J0IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgdmFyIGFjdG9yID0gaWQgPT09IF90aGlzLmdldFdvcmxkTW9kZWwoKS5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4XHJcbiAgICAgICAgICAgICAgICA/IEdhbWUuZ2V0UGxheWVyKClcclxuICAgICAgICAgICAgICAgIDogQWN0b3IuZnJvbShHYW1lLmdldEZvcm1FeChyZW1vdGVJZFRvTG9jYWxJZCgoX2EgPSBmb3JtLnJlZnJJZCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMCkpKTtcclxuICAgICAgICAgICAgaWYgKGFjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYXBwbHlEZWF0aFN0YXRlRXZlbnRcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RvcjogYWN0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRGVhZDogbXNnRGF0YVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFJlc3Bhd25OZWVkZWRFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rvci5kaXNhYmxlTm9XYWl0KGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3IuZGVsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuaGFuZGxlQ29ubmVjdGlvbkFjY2VwdGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMud29ybGRNb2RlbC5mb3JtcyA9IFtdO1xyXG4gICAgICAgIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID0gLTE7XHJcbiAgICAgICAgdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlclJlZnJJZCA9IDA7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJIYW5kbGUgY29ubmVjdGlvbiBhY2NlcHRlZFwiKTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uQ2hhbmdlVmFsdWVzTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgaWQgPSBfdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICAgICAgdmFyIHJlZnIgPSBpZCA9PT0gX3RoaXMuZ2V0TXlBY3RvckluZGV4KCkgPyBHYW1lLmdldFBsYXllcigpIDogZ2V0T2JqZWN0UmVmZXJlbmNlKGlkKTtcclxuICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgaWYgKCFhYykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBfYSA9IG1zZy5kYXRhLCBoZWFsdGggPSBfYS5oZWFsdGgsIHN0YW1pbmEgPSBfYS5zdGFtaW5hLCBtYWdpY2thID0gX2EubWFnaWNrYTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBoZWFsdGggPT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgIHNldEFjdG9yVmFsdWVQZXJjZW50YWdlKGFjLCAnaGVhbHRoJywgaGVhbHRoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHN0YW1pbmEgPT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgIHNldEFjdG9yVmFsdWVQZXJjZW50YWdlKGFjLCAnc3RhbWluYScsIHN0YW1pbmEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbWFnaWNrYSA9PT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgc2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoYWMsICdtYWdpY2thJywgbWFnaWNrYSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uU2V0UmFjZU1lbnVPcGVuTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIGlmIChtc2cub3Blbikge1xyXG4gICAgICAgICAgICAvLyB3YWl0IDAuM3MgY2F1c2Ugd2UgY2FuIHNlZSB2aXN1YWwgYnVncyB3aGVuIHRlbGVwb3J0aW5nXHJcbiAgICAgICAgICAgIC8vIGFuZCBzaG93aW5nIHRoaXMgbWVudSBhdCB0aGUgc2FtZSB0aW1lIGluIG9uQ29ubmVjdFxyXG4gICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gVXRpbGl0eS53YWl0KDAuMykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdW5lcXVpcElyb25IZWxtZXQoKTtcclxuICAgICAgICAgICAgICAgICAgICBHYW1lLnNob3dSYWNlTWVudSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgLy8gVE9ETzogSW1wbGVtZW50IGNsb3NlTWVudSBpbiBTa3lyaW1QbGF0Zm9ybVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvKiogUGFja2V0IGhhbmRsZXJzIGVuZCAqKi9cclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuZ2V0V29ybGRNb2RlbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JsZE1vZGVsO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuZ2V0TXlBY3RvckluZGV4ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeDtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLmdldE15UmVtb3RlUmVmcklkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyUmVmcklkO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuZ2V0SWRNYW5hZ2VyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlkTWFuYWdlcl87XHJcbiAgICB9O1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFJlbW90ZVNlcnZlci5wcm90b3R5cGUsIFwid29ybGRNb2RlbFwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RvcmFnZVtcIndvcmxkTW9kZWxcIl0gPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgICAgICAgICAgc3RvcmFnZVtcIndvcmxkTW9kZWxcIl0gPSB7IGZvcm1zOiBbXSwgcGxheWVyQ2hhcmFjdGVyRm9ybUlkeDogLTEsIHBsYXllckNoYXJhY3RlclJlZnJJZDogMCB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBzdG9yYWdlW1wid29ybGRNb2RlbFwiXTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoUmVtb3RlU2VydmVyLnByb3RvdHlwZSwgXCJpZE1hbmFnZXJfXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzdG9yYWdlW1wiaWRNYW5hZ2VyXCJdID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgICAgIC8vIE5vdGU6IGZ1bGwgSWRNYW5hZ2VyIG9iamVjdCBwcmVzZXJ2ZWQgYWNyb3NzIGhvdC1yZWxvYWRzLCBpbmNsdWRpbmcgbWV0aG9kcy5cclxuICAgICAgICAgICAgICAgIHN0b3JhZ2VbXCJpZE1hbmFnZXJcIl0gPSBuZXcgSWRNYW5hZ2VyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN0b3JhZ2VbXCJpZE1hbmFnZXJcIl07XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbmNlTG9hZCA9IGZ1bmN0aW9uIChyZWZySWQsIGNhbGxiYWNrLCBtYXhBdHRlbXB0cykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKG1heEF0dGVtcHRzID09PSB2b2lkIDApIHsgbWF4QXR0ZW1wdHMgPSAxMjA7IH1cclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgICAgIGlmIChyZWZyKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhyZWZyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG1heEF0dGVtcHRzLS07XHJcbiAgICAgICAgICAgICAgICBpZiAobWF4QXR0ZW1wdHMgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZUxvYWQocmVmcklkLCBjYWxsYmFjaywgbWF4QXR0ZW1wdHMpOyB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCAnRmFpbGVkIHRvIGxvYWQgb2JqZWN0IHJlZmVyZW5jZSAnICsgcmVmcklkLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLnNraXBGb3JtVmlld0NyZWF0aW9uID0gZnVuY3Rpb24gKG1zZykge1xyXG4gICAgICAgIC8vIE9wdGltaXphdGlvbiBhZGRlZCBpbiAjMTE4NiwgaG93ZXZlciBpdCBkb2Vzbid0IHdvcmsgZm9yIGRvb3JzIGZvciBzb21lIHJlYXNvblxyXG4gICAgICAgIHJldHVybiBtc2cucmVmcklkICYmIG1zZy5yZWZySWQgPCAweGZmMDAwMDAwICYmIG1zZy5iYXNlUmVjb3JkVHlwZSAhPT0gJ0RPT1InO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuZXh0cmFjdFVwZGF0ZVByb3BlcnR5TWVzc2FnZURhdGEgPSBmdW5jdGlvbiAodXBkYXRlUHJvcGVydHlNZXNzYWdlKSB7XHJcbiAgICAgICAgdmFyIG1zZ0RhdGEgPSB1cGRhdGVQcm9wZXJ0eU1lc3NhZ2UuZGF0YTtcclxuICAgICAgICBpZiAodXBkYXRlUHJvcGVydHlNZXNzYWdlLmRhdGFEdW1wICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIG1zZ0RhdGEgPSBKU09OLnBhcnNlKHVwZGF0ZVByb3BlcnR5TWVzc2FnZS5kYXRhRHVtcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCAnZXh0cmFjdFVwZGF0ZVByb3BlcnR5TWVzc2FnZURhdGEgLSBGYWlsZWQgdG8gcGFyc2UgZGF0YUR1bXAnLCB1cGRhdGVQcm9wZXJ0eU1lc3NhZ2UuZGF0YUR1bXApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG1zZ0RhdGE7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblNwZWxsQ2FzdE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20oR2FtZS5nZXRGb3JtRXgocmVtb3RlSWRUb0xvY2FsSWQobXNnLmRhdGEuY2FzdGVyKSkpO1xyXG4gICAgICAgICAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzID0ge1xyXG4gICAgICAgICAgICAgICAgYm9vbGVhbnM6IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzLmJvb2xlYW5zKSxcclxuICAgICAgICAgICAgICAgIGZsb2F0czogbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMuZmxvYXRzKSxcclxuICAgICAgICAgICAgICAgIGludGVnZXJzOiBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hY3RvckFuaW1hdGlvblZhcmlhYmxlcy5pbnRlZ2VycylcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKG1zZy5kYXRhLmludGVycnVwdENhc3QpIHtcclxuICAgICAgICAgICAgICAgIGludGVycnVwdENhc3QoYWMuZ2V0Rm9ybUlEKCksIG1zZy5kYXRhLmNhc3RpbmdTb3VyY2UsIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgc3BlbGwgPSBhYy5nZXRFcXVpcHBlZFNwZWxsKG1zZy5kYXRhLmNhc3RpbmdTb3VyY2UpO1xyXG4gICAgICAgICAgICBpZiAoc3BlbGwpIHtcclxuICAgICAgICAgICAgICAgIGNhc3RTcGVsbEltbWVkaWF0ZShhYy5nZXRGb3JtSUQoKSwgbXNnLmRhdGEuY2FzdGluZ1NvdXJjZSwgc3BlbGwuZ2V0Rm9ybUlEKCksIHJlbW90ZUlkVG9Mb2NhbElkKG1zZy5kYXRhLnRhcmdldCksIG1zZy5kYXRhLmFpbUFuZ2xlLCBtc2cuZGF0YS5haW1IZWFkaW5nLCBhY3RvckFuaW1hdGlvblZhcmlhYmxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlQW5pbVZhcmlhYmxlc01lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShHYW1lLmdldEZvcm1FeChyZW1vdGVJZFRvTG9jYWxJZChtc2cuZGF0YS5hY3RvclJlbW90ZUlkKSkpO1xyXG4gICAgICAgICAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzID0ge1xyXG4gICAgICAgICAgICAgICAgYm9vbGVhbnM6IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzLmJvb2xlYW5zKSxcclxuICAgICAgICAgICAgICAgIGZsb2F0czogbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMuZmxvYXRzKSxcclxuICAgICAgICAgICAgICAgIGludGVnZXJzOiBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hY3RvckFuaW1hdGlvblZhcmlhYmxlcy5pbnRlZ2VycylcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdmFyIGlzQXBwbHllZCA9IGFwcGx5QW5pbWF0aW9uVmFyaWFibGVzVG9BY3RvcihhYy5nZXRGb3JtSUQoKSwgYWN0b3JBbmltYXRpb25WYXJpYWJsZXMpO1xyXG4gICAgICAgICAgICBpZiAoIWlzQXBwbHllZCkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsICdGYWlsZWQgYXBwbHkgQW5pbWF0aW9uVmFyaWFibGVzIHRvIGFjdG9yIHdpdGggaWQ6ICcgKyBhYy5nZXRGb3JtSUQoKS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblZvaWNlQ2hhdE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICAvLyBVcGRhdGUgZm9ybSBtb2RlbCB3aXRoIGlzVGFsa2luZyBzdGF0ZVxyXG4gICAgICAgIHZhciBzcGVha2VyRm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtcy5maW5kKGZ1bmN0aW9uIChmKSB7IHJldHVybiBmICYmIGYucmVmcklkID09PSBtc2cuZGF0YS5zcGVha2VySWQ7IH0pO1xyXG4gICAgICAgIGlmIChzcGVha2VyRm9ybSkge1xyXG4gICAgICAgICAgICBzcGVha2VyRm9ybS5pc1RhbGtpbmcgPSBtc2cuZGF0YS5pc1RhbGtpbmc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEZvcndhcmQgdG8gVm9pY2VDaGF0U2VydmljZSBmb3IgcHJvY2Vzc2luZ1xyXG4gICAgICAgIHZhciB2b2ljZUNoYXRTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFZvaWNlQ2hhdFNlcnZpY2UpO1xyXG4gICAgICAgIGlmICh2b2ljZUNoYXRTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHZhciBhdWRpb0RhdGEgPSBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hdWRpb0RhdGEpO1xyXG4gICAgICAgICAgICB2b2ljZUNoYXRTZXJ2aWNlLm9uUmVjZWl2ZVZvaWNlRGF0YShtc2cuZGF0YS5zcGVha2VySWQsIGF1ZGlvRGF0YS5idWZmZXIsIDAsIDAsIDApO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlVm9pY2VDaGF0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIC8vIFVwZGF0ZSBmb3JtIG1vZGVsIHdpdGggaXNUYWxraW5nIHN0YXRlXHJcbiAgICAgICAgdmFyIHNwZWFrZXJGb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zLmZpbmQoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIGYgJiYgZi5yZWZySWQgPT09IG1zZy5kYXRhLnNwZWFrZXJJZDsgfSk7XHJcbiAgICAgICAgaWYgKHNwZWFrZXJGb3JtKSB7XHJcbiAgICAgICAgICAgIHNwZWFrZXJGb3JtLmlzVGFsa2luZyA9IG1zZy5kYXRhLmlzVGFsa2luZztcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gRm9yd2FyZCB0byBWb2ljZUNoYXRTZXJ2aWNlIHdpdGggM0QgcG9zaXRpb24gZGF0YVxyXG4gICAgICAgIHZhciB2b2ljZUNoYXRTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFZvaWNlQ2hhdFNlcnZpY2UpO1xyXG4gICAgICAgIGlmICh2b2ljZUNoYXRTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHZhciBhdWRpb0RhdGEgPSBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hdWRpb0RhdGEpO1xyXG4gICAgICAgICAgICB2b2ljZUNoYXRTZXJ2aWNlLm9uUmVjZWl2ZVZvaWNlRGF0YShtc2cuZGF0YS5zcGVha2VySWQsIGF1ZGlvRGF0YS5idWZmZXIsIG1zZy5kYXRhLnBvc2l0aW9uWzBdLCAvLyB4XHJcbiAgICAgICAgICAgIG1zZy5kYXRhLnBvc2l0aW9uWzFdLCAvLyB5XHJcbiAgICAgICAgICAgIG1zZy5kYXRhLnBvc2l0aW9uWzJdIC8vIHpcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFJlbW90ZVNlcnZlcjtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBSZW1vdGVTZXJ2ZXIgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgU2luZ2xlUGxheWVyU2VydmljZSB9IGZyb20gXCIuL3NpbmdsZVBsYXllclNlcnZpY2VcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBnZXRNb3ZlbWVudCB9IGZyb20gXCIuLi8uLi9zeW5jL21vdmVtZW50R2V0XCI7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHRoaXMgb3V0XHJcbmltcG9ydCAqIGFzIHdvcmxkVmlld01pc2MgZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBBbmltYXRpb25Tb3VyY2UgfSBmcm9tIFwiLi4vLi4vc3luYy9hbmltYXRpb25cIjtcclxuaW1wb3J0IHsgZ2V0QXBwZWFyYW5jZSB9IGZyb20gXCIuLi8uLi9zeW5jL2FwcGVhcmFuY2VcIjtcclxuaW1wb3J0IHsgZ2V0QWN0b3JWYWx1ZXMgfSBmcm9tIFwiLi4vLi4vc3luYy9hY3RvcnZhbHVlc1wiO1xyXG5pbXBvcnQgeyBnZXRFcXVpcG1lbnQgfSBmcm9tIFwiLi4vLi4vc3luYy9lcXVpcG1lbnRcIjtcclxuaW1wb3J0IHsgbmV4dEhvc3RBdHRlbXB0IH0gZnJvbSBcIi4uLy4uL3ZpZXcvaG9zdEF0dGVtcHRzXCI7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuL3JlbW90ZVNlcnZlclwiO1xyXG5pbXBvcnQgeyBEZWF0aFNlcnZpY2UgfSBmcm9tIFwiLi9kZWF0aFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgcGxheWVyRm9ybUlkID0gMHgxNDtcclxuLy8gVE9ETzogc3BsaXQgdGhpcyBzZXJ2aWNlIGludG8gRXF1aXBtZW50U2VydmljZSwgTW92ZW1lbnRTZXJ2aWNlLCBBbmltYXRpb25TZXJ2aWNlLCBBY3RvclZhbHVlU2VydmljZSwgSG9zdEF0dGVtcHRzU2VydmljZVxyXG52YXIgU2VuZElucHV0c1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU2VuZElucHV0c1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTZW5kSW5wdXRzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5sYXN0U2VuZE1vdmVtZW50TW9tZW50ID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIF90aGlzLnBsYXllckFuaW1Tb3VyY2UgPSBuZXcgTWFwKCk7IC8vIFRPRE86IG1ha2Ugc2VydmljZVxyXG4gICAgICAgIF90aGlzLmxhc3RBbmltYXRpb25TZW50ID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIF90aGlzLmFjdG9yVmFsdWVzTmVlZFVwZGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmlzUmFjZVNleE1lbnVTaG93biA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmVxdWlwbWVudENoYW5nZWQgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5udW1FcXVpcG1lbnRDaGFuZ2VzID0gMDtcclxuICAgICAgICBfdGhpcy5wcmV2VmFsdWVzID0geyBoZWFsdGg6IDAsIHN0YW1pbmE6IDAsIG1hZ2lja2E6IDAgfTtcclxuICAgICAgICBfdGhpcy5wcmV2QWN0b3JWYWx1ZXNVcGRhdGVUaW1lID0gMDtcclxuICAgICAgICBfdGhpcy5wcmV2Q2FzdGluZ0RldGVjdGVkVGltZSA9IDA7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwiZXF1aXBcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uRXF1aXAoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1bmVxdWlwXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVuZXF1aXAoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJsb2FkR2FtZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbkxvYWRHYW1lKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuc2luZ2xlUGxheWVyU2VydmljZS5pc1NpbmdsZVBsYXllcikge1xyXG4gICAgICAgICAgICB0aGlzLnNlbmRJbnB1dHMoKTtcclxuICAgICAgICAgICAgdmFyIHBsYXllciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgdmFyIGlzUGxheWVyQ2FzdGluZyA9IHBsYXllci5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc0Nhc3RpbmdSaWdodFwiKVxyXG4gICAgICAgICAgICAgICAgfHwgcGxheWVyLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzQ2FzdGluZ0xlZnRcIilcclxuICAgICAgICAgICAgICAgIHx8IHBsYXllci5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc0Nhc3RpbmdEdWFsXCIpO1xyXG4gICAgICAgICAgICBpZiAoaXNQbGF5ZXJDYXN0aW5nKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZDYXN0aW5nRGV0ZWN0ZWRUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUub25FcXVpcCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGlmICghZXZlbnQuYWN0b3IgfHwgIWV2ZW50LmJhc2VPYmopIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXZlbnQuYWN0b3IuZ2V0Rm9ybUlEKCkgIT09IHBsYXllckZvcm1JZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0eXBlID0gZXZlbnQuYmFzZU9iai5nZXRUeXBlKCk7XHJcbiAgICAgICAgaWYgKHR5cGUgIT09IDI3IC8qIEZvcm1UeXBlLkJvb2sgKi8gJiYgdHlwZSAhPT0gNDYgLyogRm9ybVR5cGUuUG90aW9uICovICYmIHR5cGUgIT09IDMwIC8qIEZvcm1UeXBlLkluZ3JlZGllbnQgKi8pIHtcclxuICAgICAgICAgICAgLy8gVHJpZ2dlciBVcGRhdGVFcXVpcG1lbnQgb25seSBmb3IgZXF1aXBzIHRoYXQgYXJlIG5vdCBzcGVsbCB0b21lcywgcG90aW9ucywgaW5ncmVkaWVudHNcclxuICAgICAgICAgICAgdGhpcy5lcXVpcG1lbnRDaGFuZ2VkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gU2VuZCBPbkVxdWlwIGZvciBhbnkgZXF1aXBzIGluY2x1ZGluZyBzcGVsbCB0b21lcywgcG90aW9ucywgaW5ncmVkaWVudHNcclxuICAgICAgICAvLyBPdGhlcndpc2UsIHRoZSBzZXJ2ZXIgd29uJ3QgdHJpZ2dlciBzcGVsbCBsZWFybiwgcG90aW9uIGRyaW5rLCBpbmdyZWRpZW50IGVhdCBhbmQgUGFweXJ1cyBzY3JpcHRzXHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogeyB0OiBNc2dUeXBlLk9uRXF1aXAsIGJhc2VJZDogZXZlbnQuYmFzZU9iai5nZXRGb3JtSUQoKSB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUub25VbmVxdWlwID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgaWYgKCFldmVudC5hY3RvciB8fCAhZXZlbnQuYmFzZU9iaikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChldmVudC5hY3Rvci5nZXRGb3JtSUQoKSA9PT0gcGxheWVyRm9ybUlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXF1aXBtZW50Q2hhbmdlZCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5vbkxvYWRHYW1lID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgLy8gQ3VycmVudGx5IG9ubHkgYXJtb3IgaXMgZXF1aXBwZWQgYWZ0ZXIgcmVsb2dnaW5nIChzZWUgcmVtb3RlU2VydmVyLnRzKVxyXG4gICAgICAgIC8vIFRoaXMgaGFjayBmb3JjZXMgc2VuZGluZyAvZXF1aXBtZW50IHdpdGhvdXQgd2VhcG9ucy8gYmFjayB0byB0aGUgc2VydmVyXHJcbiAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoMykudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiAoX3RoaXMuZXF1aXBtZW50Q2hhbmdlZCA9IHRydWUpOyB9KTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZElucHV0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBob3N0ZWQgPSB0eXBlb2YgdGhpcy5zcC5zdG9yYWdlWydob3N0ZWQnXSA9PT0gdHlwZW9mIFtdID8gdGhpcy5zcC5zdG9yYWdlWydob3N0ZWQnXSA6IFtdO1xyXG4gICAgICAgIHZhciB0YXJnZXRzID0gW3VuZGVmaW5lZF0uY29uY2F0KGhvc3RlZCk7XHJcbiAgICAgICAgdmFyIG1vZGVsU291cmNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJlbW90ZVNlcnZlcik7XHJcbiAgICAgICAgdmFyIHdvcmxkID0gbW9kZWxTb3VyY2UuZ2V0V29ybGRNb2RlbCgpO1xyXG4gICAgICAgIHRhcmdldHMuZm9yRWFjaChmdW5jdGlvbiAodGFyZ2V0KSB7XHJcbiAgICAgICAgICAgIHZhciB0YXJnZXRGb3JtTW9kZWwgPSB0YXJnZXQgPyBfdGhpcy5nZXRGb3JtKHRhcmdldCwgd29ybGQpIDogX3RoaXMuZ2V0Rm9ybSh1bmRlZmluZWQsIHdvcmxkKTtcclxuICAgICAgICAgICAgX3RoaXMuc2VuZE1vdmVtZW50KHRhcmdldCwgdGFyZ2V0Rm9ybU1vZGVsKTtcclxuICAgICAgICAgICAgX3RoaXMuc2VuZEFuaW1hdGlvbih0YXJnZXQpO1xyXG4gICAgICAgICAgICBfdGhpcy5zZW5kQXBwZWFyYW5jZSh0YXJnZXQpO1xyXG4gICAgICAgICAgICBfdGhpcy5zZW5kRXF1aXBtZW50KHRhcmdldCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNlbmRBY3RvclZhbHVlUGVyY2VudGFnZSh0YXJnZXQsIHRhcmdldEZvcm1Nb2RlbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zZW5kSG9zdEF0dGVtcHRzKCk7XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRNb3ZlbWVudCA9IGZ1bmN0aW9uIChfcmVmcklkLCBmb3JtKSB7XHJcbiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5nZXRJbnB1dE93bmVyKF9yZWZySWQpO1xyXG4gICAgICAgIGlmICghb3duZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcmVmcklkU3RyID0gXCJcIi5jb25jYXQoX3JlZnJJZCk7XHJcbiAgICAgICAgdmFyIHNlbmRNb3ZlbWVudFJhdGVNcyA9IDEzMDtcclxuICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB2YXIgbGFzdCA9IHRoaXMubGFzdFNlbmRNb3ZlbWVudE1vbWVudC5nZXQocmVmcklkU3RyKTtcclxuICAgICAgICBpZiAoIWxhc3QgfHwgbm93IC0gbGFzdCA+IHNlbmRNb3ZlbWVudFJhdGVNcykge1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuVXBkYXRlTW92ZW1lbnQsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiBnZXRNb3ZlbWVudChvd25lciwgZm9ybSksXHJcbiAgICAgICAgICAgICAgICBfcmVmcklkOiBfcmVmcklkXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5sYXN0U2VuZE1vdmVtZW50TW9tZW50LnNldChyZWZySWRTdHIsIG5vdyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kQWN0b3JWYWx1ZVBlcmNlbnRhZ2UgPSBmdW5jdGlvbiAoX3JlZnJJZCwgZm9ybSkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgY2FuU2VuZCA9IGZvcm0gJiYgKChfYSA9IGZvcm0uaXNEZWFkKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBmYWxzZSkgPT09IGZhbHNlO1xyXG4gICAgICAgIGlmICghY2FuU2VuZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBvd25lciA9IHRoaXMuZ2V0SW5wdXRPd25lcihfcmVmcklkKTtcclxuICAgICAgICBpZiAoIW93bmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGF2ID0gZ2V0QWN0b3JWYWx1ZXModGhpcy5zcC5HYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIGlmICh0aGlzLmFjdG9yVmFsdWVzTmVlZFVwZGF0ZSA9PT0gZmFsc2UgJiZcclxuICAgICAgICAgICAgdGhpcy5wcmV2VmFsdWVzLmhlYWx0aCA9PT0gYXYuaGVhbHRoICYmXHJcbiAgICAgICAgICAgIHRoaXMucHJldlZhbHVlcy5zdGFtaW5hID09PSBhdi5zdGFtaW5hICYmXHJcbiAgICAgICAgICAgIHRoaXMucHJldlZhbHVlcy5tYWdpY2thID09PSBhdi5tYWdpY2thKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGN1cnJlbnRUaW1lIC0gdGhpcy5wcmV2QWN0b3JWYWx1ZXNVcGRhdGVUaW1lIDwgMjAwMCAmJlxyXG4gICAgICAgICAgICB0aGlzLmFjdG9yVmFsdWVzTmVlZFVwZGF0ZSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBEZWxheWluZyBhY3RvciB2YWx1ZXMgdXBkYXRlIGR1ZSB0byBjYXN0aW5nXHJcbiAgICAgICAgLy8gVE9ETzogdXNlIHBhcnRpYWwgdXBkYXRlcyBmb3IgYWN0b3IgdmFsdWVzIG9uY2Ugc2VydmVyIGZpbmFsbHkgc3VwcG9ydHMgaXRcclxuICAgICAgICAvLyBpLmUuIGtlZXAgc2VuZGluZyBoZWFsdGggYW5kIHN0YW1pbmEgZHVyaW5nIGNhc3RpbmcsIGJ1dCBkZWxheSBtYWdpY2thIHVwZGF0ZVxyXG4gICAgICAgIGlmIChjdXJyZW50VGltZSAtIHRoaXMucHJldkNhc3RpbmdEZXRlY3RlZFRpbWUgPCA1MDAgJiZcclxuICAgICAgICAgICAgYXYuaGVhbHRoID4gMCAvLyBkb24ndCBkZWxheSBkZWF0aCBhY3RvciB2YWx1ZSB1cGRhdGVcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZGVhdGhTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKERlYXRoU2VydmljZSk7XHJcbiAgICAgICAgaWYgKGRlYXRoU2VydmljZS5pc0J1c3koKSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIk5vdCBzZW5kaW5nIGFjdG9yIHZhbHVlcywgZGVhdGggc2VydmljZSBpcyBidXN5XCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICB0OiBNc2dUeXBlLkNoYW5nZVZhbHVlcyxcclxuICAgICAgICAgICAgZGF0YTogYXYsXHJcbiAgICAgICAgICAgIF9yZWZySWQ6IF9yZWZySWRcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmFjdG9yVmFsdWVzTmVlZFVwZGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucHJldlZhbHVlcyA9IGF2O1xyXG4gICAgICAgIHRoaXMucHJldkFjdG9yVmFsdWVzVXBkYXRlVGltZSA9IGN1cnJlbnRUaW1lO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kQW5pbWF0aW9uID0gZnVuY3Rpb24gKF9yZWZySWQpIHtcclxuICAgICAgICB2YXIgb3duZXIgPSB0aGlzLmdldElucHV0T3duZXIoX3JlZnJJZCk7XHJcbiAgICAgICAgaWYgKCFvd25lcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEV4dGVybWx5IGltcG9ydGFudCB0aGF0IGl0J3MgYSBsb2NhbCBpZCBzaW5jZSBBbmltYXRpb25Tb3VyY2UgZGVwZW5kcyBvbiBpdFxyXG4gICAgICAgIHZhciByZWZySWRTdHIgPSBvd25lci5nZXRGb3JtSUQoKS50b1N0cmluZygxNik7XHJcbiAgICAgICAgdmFyIGFuaW1Tb3VyY2UgPSB0aGlzLnBsYXllckFuaW1Tb3VyY2UuZ2V0KHJlZnJJZFN0cik7XHJcbiAgICAgICAgaWYgKCFhbmltU291cmNlKSB7XHJcbiAgICAgICAgICAgIGFuaW1Tb3VyY2UgPSBuZXcgQW5pbWF0aW9uU291cmNlKG93bmVyKTtcclxuICAgICAgICAgICAgdGhpcy5wbGF5ZXJBbmltU291cmNlLnNldChyZWZySWRTdHIsIGFuaW1Tb3VyY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYW5pbSA9IGFuaW1Tb3VyY2UuZ2V0QW5pbWF0aW9uKCk7XHJcbiAgICAgICAgdmFyIGxhc3RBbmltYXRpb25TZW50ID0gdGhpcy5sYXN0QW5pbWF0aW9uU2VudC5nZXQocmVmcklkU3RyKTtcclxuICAgICAgICBpZiAoIWxhc3RBbmltYXRpb25TZW50IHx8XHJcbiAgICAgICAgICAgIGFuaW0ubnVtQ2hhbmdlcyAhPT0gbGFzdEFuaW1hdGlvblNlbnQubnVtQ2hhbmdlcykge1xyXG4gICAgICAgICAgICAvLyBEcmluayBwb3Rpb24gYW5pbSBmcm9tIHRoaXMgbW9kIGh0dHBzOi8vd3d3Lm5leHVzbW9kcy5jb20vc2t5cmltc3BlY2lhbGVkaXRpb24vbW9kcy85NzY2MFxyXG4gICAgICAgICAgICBpZiAoYW5pbS5hbmltRXZlbnROYW1lICE9PSAnJyAmJiAhYW5pbS5hbmltRXZlbnROYW1lLnN0YXJ0c1dpdGgoXCJEcmlua1BvdGlvbl9cIikpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubGFzdEFuaW1hdGlvblNlbnQuc2V0KHJlZnJJZFN0ciwgYW5pbSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUFjdG9yVmFsdWVzQWZ0ZXJBbmltYXRpb24oYW5pbS5hbmltRXZlbnROYW1lKTtcclxuICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuVXBkYXRlQW5pbWF0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IGFuaW0sXHJcbiAgICAgICAgICAgICAgICAgICAgX3JlZnJJZDogX3JlZnJJZFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZEFwcGVhcmFuY2UgPSBmdW5jdGlvbiAoX3JlZnJJZCkge1xyXG4gICAgICAgIGlmIChfcmVmcklkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNob3duID0gdGhpcy5zcC5VaS5pc01lbnVPcGVuKCdSYWNlU2V4IE1lbnUnKTtcclxuICAgICAgICBpZiAoc2hvd24gIT0gdGhpcy5pc1JhY2VTZXhNZW51U2hvd24pIHtcclxuICAgICAgICAgICAgdGhpcy5pc1JhY2VTZXhNZW51U2hvd24gPSBzaG93bjtcclxuICAgICAgICAgICAgaWYgKCFzaG93bikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5wcmludENvbnNvbGUoJ0V4aXRlZCBmcm9tIHJhY2UgbWVudScpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGFwcGVhcmFuY2UgPSBnZXRBcHBlYXJhbmNlKHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBsb2cgYXBwZWFyYW5jZSBjb250ZW50cyB0byBkZWJ1ZyBhcHBlYXJhbmNlIGlzc3Vlcz9cclxuICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuVXBkYXRlQXBwZWFyYW5jZSxcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBhcHBlYXJhbmNlLFxyXG4gICAgICAgICAgICAgICAgICAgIF9yZWZySWQ6IF9yZWZySWRcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kRXF1aXBtZW50ID0gZnVuY3Rpb24gKF9yZWZySWQpIHtcclxuICAgICAgICBpZiAoX3JlZnJJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmVxdWlwbWVudENoYW5nZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5lcXVpcG1lbnRDaGFuZ2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICsrdGhpcy5udW1FcXVpcG1lbnRDaGFuZ2VzO1xyXG4gICAgICAgICAgICB2YXIgZXEgPSBnZXRFcXVpcG1lbnQodGhpcy5zcC5HYW1lLmdldFBsYXllcigpLCB0aGlzLm51bUVxdWlwbWVudENoYW5nZXMpO1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuVXBkYXRlRXF1aXBtZW50LFxyXG4gICAgICAgICAgICAgICAgZGF0YTogZXEsXHJcbiAgICAgICAgICAgICAgICBfcmVmcklkOiBfcmVmcklkXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kSG9zdEF0dGVtcHRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciByZW1vdGVJZCA9IG5leHRIb3N0QXR0ZW1wdCgpO1xyXG4gICAgICAgIGlmICghcmVtb3RlSWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkhvc3QsXHJcbiAgICAgICAgICAgICAgICByZW1vdGVJZDogcmVtb3RlSWRcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLmdldElucHV0T3duZXIgPSBmdW5jdGlvbiAoX3JlZnJJZCkge1xyXG4gICAgICAgIHJldHVybiBfcmVmcklkXHJcbiAgICAgICAgICAgID8gdGhpcy5zcC5BY3Rvci5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgod29ybGRWaWV3TWlzYy5yZW1vdGVJZFRvTG9jYWxJZChfcmVmcklkKSkpXHJcbiAgICAgICAgICAgIDogdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5nZXRGb3JtID0gZnVuY3Rpb24gKHJlZnJJZCwgd29ybGQpIHtcclxuICAgICAgICB2YXIgZm9ybSA9IHJlZnJJZFxyXG4gICAgICAgICAgICA/IHdvcmxkID09PSBudWxsIHx8IHdvcmxkID09PSB2b2lkIDAgPyB2b2lkIDAgOiB3b3JsZC5mb3Jtcy5maW5kKGZ1bmN0aW9uIChmKSB7IHJldHVybiAoZiA9PT0gbnVsbCB8fCBmID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmLnJlZnJJZCkgPT09IHJlZnJJZDsgfSlcclxuICAgICAgICAgICAgOiB3b3JsZC5mb3Jtc1t3b3JsZC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4XTtcclxuICAgICAgICByZXR1cm4gZm9ybTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUudXBkYXRlQWN0b3JWYWx1ZXNBZnRlckFuaW1hdGlvbiA9IGZ1bmN0aW9uIChhbmltTmFtZSkge1xyXG4gICAgICAgIGlmIChhbmltTmFtZSA9PT0gJ0p1bXBMYW5kJyB8fFxyXG4gICAgICAgICAgICBhbmltTmFtZSA9PT0gJ0p1bXBMYW5kRGlyZWN0aW9uYWwnIHx8XHJcbiAgICAgICAgICAgIGFuaW1OYW1lID09PSAnRGVhdGhBbmltJykge1xyXG4gICAgICAgICAgICB0aGlzLmFjdG9yVmFsdWVzTmVlZFVwZGF0ZSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUsIFwic2luZ2xlUGxheWVyU2VydmljZVwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2luZ2xlUGxheWVyU2VydmljZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIFNlbmRJbnB1dHNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNlbmRJbnB1dHNTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyB2ZXJpZnkgfSBmcm9tICdub2RlOmNyeXB0byc7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSAnLi9jbGllbnRMaXN0ZW5lcic7XHJcbmltcG9ydCB7IFNldHRpbmdzU2VydmljZSB9IGZyb20gJy4vc2V0dGluZ3NTZXJ2aWNlJztcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tICcuLi8uLi9sb2dnaW5nJztcclxudmFyIFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS52ZXJpZnlTZXJ2ZXJKcyA9IGZ1bmN0aW9uIChzcmMpIHtcclxuICAgICAgICBpZiAoIXNyYykge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnRW1wdHkgc2VydmVyIEpTLCBza2lwcGluZyB2ZXJpZmljYXRpb24nKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBzcmMsIGVycm9yOiBudWxsIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzZXR0aW5nc1NlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2V0dGluZ3NTZXJ2aWNlKTtcclxuICAgICAgICB2YXIgZ2V0VGFyZ2V0UGVlclJlc3VsdCA9IHNldHRpbmdzU2VydmljZS5nZXRUYXJnZXRQZWVyKCk7XHJcbiAgICAgICAgaWYgKCFnZXRUYXJnZXRQZWVyUmVzdWx0LnRhcmdldFBlZXJDYWNoZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBudWxsLCBlcnJvcjogJ3RhcmdldCBwZWVyIG5vdCByZWFkeScgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHB1YmxpY0tleXMgPSBnZXRUYXJnZXRQZWVyUmVzdWx0LnRhcmdldFBlZXJDYWNoZWQucHVibGljS2V5cztcclxuICAgICAgICBpZiAoIXB1YmxpY0tleXMpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ05vIHB1YmxpYyBrZXlzIGNvbmZpZ3VyZWQsIHNraXBwaW5nIHNlcnZlciBKUyB2ZXJpZmljYXRpb24nKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBzcmMsIGVycm9yOiBudWxsIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBsYXN0TGluZVN0YXJ0ID0gc3JjLmxhc3RJbmRleE9mKCdcXG4nKSArIDE7XHJcbiAgICAgICAgdmFyIHNpZ1ByZWZpeCA9ICcvLyBza3ltcDpzaWc6eTonO1xyXG4gICAgICAgIGlmIChsYXN0TGluZVN0YXJ0ID09PSAwIHx8ICFzcmMuc3Vic3RyaW5nKGxhc3RMaW5lU3RhcnQpLnN0YXJ0c1dpdGgoc2lnUHJlZml4KSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IG51bGwsIGVycm9yOiAnbm8gc2lnbmF0dXJlIGZvdW5kJyB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgX2EgPSBzcmMuc3Vic3RyaW5nKGxhc3RMaW5lU3RhcnQgKyBzaWdQcmVmaXgubGVuZ3RoKS5zcGxpdCgnOicpLCBrZXlJZCA9IF9hWzBdLCBzaWcgPSBfYVsxXTtcclxuICAgICAgICBpZiAoIXRoaXMuaXNBbHBoYU51bWVyaWMoa2V5SWQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogbnVsbCwgZXJyb3I6ICdtYWxmb3JtZWQga2V5IGlkJyB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIga2V5ID0gcHVibGljS2V5c1trZXlJZF07XHJcbiAgICAgICAgaWYgKCFrZXkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBudWxsLCBlcnJvcjogJ3Vua25vd24ga2V5JyB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdG9WZXJpZnkgPSB0aGlzLnRvQXJyYXlCdWZmZXJWaWV3KHNyYy5zdWJzdHJpbmcoMCwgbGFzdExpbmVTdGFydCAtIDEpLCAndXRmOCcpO1xyXG4gICAgICAgIGlmICghdmVyaWZ5KG51bGwsIHRvVmVyaWZ5LCBrZXksIHRoaXMudG9BcnJheUJ1ZmZlclZpZXcoc2lnLCAnYmFzZTY0JykpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogbnVsbCwgZXJyb3I6ICdiYWQgc2lnbmF0dXJlJyB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlcnZlciBKUyB2ZXJpZmllZCB3aXRoIGtleSBcIi5jb25jYXQoa2V5SWQpKTtcclxuICAgICAgICByZXR1cm4geyBzcmM6IHNyYywgZXJyb3I6IG51bGwgfTtcclxuICAgIH07XHJcbiAgICBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLmlzQWxwaGFOdW1lcmljID0gZnVuY3Rpb24gKHN0cikge1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBjb2RlID0gc3RyLmNoYXJDb2RlQXQoaSk7XHJcbiAgICAgICAgICAgIGlmICghKCg5NyA8PSBjb2RlICYmIGNvZGUgPD0gMTIyKSB8fFxyXG4gICAgICAgICAgICAgICAgKDY1IDw9IGNvZGUgJiYgY29kZSA8PSA5MCkgfHxcclxuICAgICAgICAgICAgICAgICg0OCA8PSBjb2RlICYmIGNvZGUgPD0gNTcpKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfTtcclxuICAgIFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUudG9BcnJheUJ1ZmZlclZpZXcgPSBmdW5jdGlvbiAoc3RyLCBlbmMpIHtcclxuICAgICAgICB2YXIgYnVmID0gQnVmZmVyLmZyb20oc3RyLCBlbmMpO1xyXG4gICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShidWYuYnVmZmVyLCBidWYuYnl0ZU9mZnNldCwgYnVmLmJ5dGVMZW5ndGgpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgX19hc3NpZ24gPSAodGhpcyAmJiB0aGlzLl9fYXNzaWduKSB8fCBmdW5jdGlvbiAoKSB7XHJcbiAgICBfX2Fzc2lnbiA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24odCkge1xyXG4gICAgICAgIGZvciAodmFyIHMsIGkgPSAxLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG47IGkrKykge1xyXG4gICAgICAgICAgICBzID0gYXJndW1lbnRzW2ldO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwIGluIHMpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocywgcCkpXHJcbiAgICAgICAgICAgICAgICB0W3BdID0gc1twXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHQ7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIF9fYXNzaWduLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxudmFyIF9fZ2VuZXJhdG9yID0gKHRoaXMgJiYgdGhpcy5fX2dlbmVyYXRvcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIGJvZHkpIHtcclxuICAgIHZhciBfID0geyBsYWJlbDogMCwgc2VudDogZnVuY3Rpb24oKSB7IGlmICh0WzBdICYgMSkgdGhyb3cgdFsxXTsgcmV0dXJuIHRbMV07IH0sIHRyeXM6IFtdLCBvcHM6IFtdIH0sIGYsIHksIHQsIGc7XHJcbiAgICByZXR1cm4gZyA9IHsgbmV4dDogdmVyYigwKSwgXCJ0aHJvd1wiOiB2ZXJiKDEpLCBcInJldHVyblwiOiB2ZXJiKDIpIH0sIHR5cGVvZiBTeW1ib2wgPT09IFwiZnVuY3Rpb25cIiAmJiAoZ1tTeW1ib2wuaXRlcmF0b3JdID0gZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KSwgZztcclxuICAgIGZ1bmN0aW9uIHZlcmIobikgeyByZXR1cm4gZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHN0ZXAoW24sIHZdKTsgfTsgfVxyXG4gICAgZnVuY3Rpb24gc3RlcChvcCkge1xyXG4gICAgICAgIGlmIChmKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiR2VuZXJhdG9yIGlzIGFscmVhZHkgZXhlY3V0aW5nLlwiKTtcclxuICAgICAgICB3aGlsZSAoZyAmJiAoZyA9IDAsIG9wWzBdICYmIChfID0gMCkpLCBfKSB0cnkge1xyXG4gICAgICAgICAgICBpZiAoZiA9IDEsIHkgJiYgKHQgPSBvcFswXSAmIDIgPyB5W1wicmV0dXJuXCJdIDogb3BbMF0gPyB5W1widGhyb3dcIl0gfHwgKCh0ID0geVtcInJldHVyblwiXSkgJiYgdC5jYWxsKHkpLCAwKSA6IHkubmV4dCkgJiYgISh0ID0gdC5jYWxsKHksIG9wWzFdKSkuZG9uZSkgcmV0dXJuIHQ7XHJcbiAgICAgICAgICAgIGlmICh5ID0gMCwgdCkgb3AgPSBbb3BbMF0gJiAyLCB0LnZhbHVlXTtcclxuICAgICAgICAgICAgc3dpdGNoIChvcFswXSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAwOiBjYXNlIDE6IHQgPSBvcDsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDQ6IF8ubGFiZWwrKzsgcmV0dXJuIHsgdmFsdWU6IG9wWzFdLCBkb25lOiBmYWxzZSB9O1xyXG4gICAgICAgICAgICAgICAgY2FzZSA1OiBfLmxhYmVsKys7IHkgPSBvcFsxXTsgb3AgPSBbMF07IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA3OiBvcCA9IF8ub3BzLnBvcCgpOyBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISh0ID0gXy50cnlzLCB0ID0gdC5sZW5ndGggPiAwICYmIHRbdC5sZW5ndGggLSAxXSkgJiYgKG9wWzBdID09PSA2IHx8IG9wWzBdID09PSAyKSkgeyBfID0gMDsgY29udGludWU7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDMgJiYgKCF0IHx8IChvcFsxXSA+IHRbMF0gJiYgb3BbMV0gPCB0WzNdKSkpIHsgXy5sYWJlbCA9IG9wWzFdOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gNiAmJiBfLmxhYmVsIDwgdFsxXSkgeyBfLmxhYmVsID0gdFsxXTsgdCA9IG9wOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0ICYmIF8ubGFiZWwgPCB0WzJdKSB7IF8ubGFiZWwgPSB0WzJdOyBfLm9wcy5wdXNoKG9wKTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodFsyXSkgXy5vcHMucG9wKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcCA9IGJvZHkuY2FsbCh0aGlzQXJnLCBfKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7IG9wID0gWzYsIGVdOyB5ID0gMDsgfSBmaW5hbGx5IHsgZiA9IHQgPSAwOyB9XHJcbiAgICAgICAgaWYgKG9wWzBdICYgNSkgdGhyb3cgb3BbMV07IHJldHVybiB7IHZhbHVlOiBvcFswXSA/IG9wWzFdIDogdm9pZCAwLCBkb25lOiB0cnVlIH07XHJcbiAgICB9XHJcbn07XHJcbmltcG9ydCB7IEh0dHBDbGllbnQsIHByaW50Q29uc29sZSwgVXRpbGl0eSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gXCIuL2F1dGhTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgVGltZXJzU2VydmljZSB9IGZyb20gXCIuL3RpbWVyc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgU2V0dGluZ3NTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNldHRpbmdzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNldHRpbmdzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy50YXJnZXRQZWVyQ2FjaGUgPSBudWxsO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUuZ2V0U2VydmVyTWFzdGVyS2V5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtYXN0ZXJLZXkgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcInNlcnZlci1tYXN0ZXIta2V5XCJdO1xyXG4gICAgICAgIGlmICghbWFzdGVyS2V5KSB7XHJcbiAgICAgICAgICAgIG1hc3RlcktleSA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wibWFzdGVyLWtleVwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFtYXN0ZXJLZXkpIHtcclxuICAgICAgICAgICAgbWFzdGVyS2V5ID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJzZXJ2ZXItaXBcIl0gKyBcIjpcIiArIHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wic2VydmVyLXBvcnRcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBtYXN0ZXJLZXk7XHJcbiAgICB9O1xyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRNYXN0ZXJVcmwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplVXJsKHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wibWFzdGVyXCJdIHx8IFwiaHR0cHM6Ly9nYXRld2F5LnNreW1wLm5ldFwiKTtcclxuICAgIH07XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLm1ha2VNYXN0ZXJBcGlDbGllbnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1hc3RlckFwaUJhc2VVcmwgPSB0aGlzLmdldE1hc3RlclVybCgpO1xyXG4gICAgICAgIHJldHVybiBuZXcgSHR0cENsaWVudChtYXN0ZXJBcGlCYXNlVXJsKTtcclxuICAgIH07XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLmdldFRhcmdldFBlZXIgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICh0aGlzLnRhcmdldFBlZXJDYWNoZSkge1xyXG4gICAgICAgICAgICBjYWxsYmFjayA9PT0gbnVsbCB8fCBjYWxsYmFjayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2FsbGJhY2sodGhpcy50YXJnZXRQZWVyQ2FjaGUpO1xyXG4gICAgICAgICAgICByZXR1cm4geyB0YXJnZXRQZWVyQ2FjaGVkOiB0aGlzLnRhcmdldFBlZXJDYWNoZSB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmdldFRhcmdldFBlZXJJbXBsKGZ1bmN0aW9uICh0YXJnZXRQZWVyKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnRhcmdldFBlZXJDYWNoZSA9IHRhcmdldFBlZXI7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayh0YXJnZXRQZWVyKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4geyB0YXJnZXRQZWVyQ2FjaGVkOiBudWxsIH07XHJcbiAgICB9O1xyXG4gICAgLy8gaGF2ZSB0byB1c2UgY2FsbGJhY2tzIGhlcmU6IHByb21pc2VzIGRvbid0IHdvcmsgaW4gdGhlIG1haW4gbWVudVxyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRUYXJnZXRQZWVySW1wbCA9IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1hc3RlckFwaUNsaWVudCA9IHRoaXMubWFrZU1hc3RlckFwaUNsaWVudCgpO1xyXG4gICAgICAgIHZhciBtYXN0ZXJLZXkgPSB0aGlzLmdldFNlcnZlck1hc3RlcktleSgpO1xyXG4gICAgICAgIHZhciBzZXJ2ZXJJbmZvUmVxdWVzdFRpbWVvdXRNcyA9IDUwMDA7XHJcbiAgICAgICAgdmFyIGRlZmF1bHRQZWVyID0ge1xyXG4gICAgICAgICAgICBob3N0OiB0aGlzLnNwLnNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3NlcnZlci1pcCddLFxyXG4gICAgICAgICAgICBwb3J0OiB0aGlzLnNwLnNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3NlcnZlci1wb3J0J10sXHJcbiAgICAgICAgICAgIHB1YmxpY0tleXM6IHRoaXMuc3Auc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2VydmVyLXB1YmxpYy1rZXlzJ10sXHJcbiAgICAgICAgfTtcclxuICAgICAgICB2YXIgcmVzb2x2ZWQgPSBmYWxzZTtcclxuICAgICAgICB2YXIgc3RhdGVzID0ge1xyXG4gICAgICAgICAgICBzdGFydDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuc3Auc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2VydmVyLWluZm8taWdub3JlJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsICdTa2lwcGluZyBzZXJ2ZXJpbmZvIHJlcXVlc3QgZHVlIHRvIHNlcnZlci1pbmZvLWlnbm9yZSBpbiBjb25maWcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVzLnJlc29sdmUoZGVmYXVsdFBlZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoVGltZXJzU2VydmljZSkuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJldHVybiBzdGF0ZXMucmVqZWN0KG5ldyBFcnJvcignZ2V0VGFyZ2V0UGVlcjogc2VydmVyaW5mbyByZXF1ZXN0IHRpbWVkIG91dCcpKTsgfSwgc2VydmVySW5mb1JlcXVlc3RUaW1lb3V0TXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXJzID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNlc3Npb24gPSAoX2EgPSBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKEF1dGhTZXJ2aWNlKS5yZWFkQXV0aERhdGFGcm9tRGlzaygpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2Vzc2lvbjtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2Vzc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzWydYLVNlc3Npb24nXSA9IHNlc3Npb247XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIG1hc3RlckFwaUNsaWVudC5nZXQoXCIvYXBpL3NlcnZlcnMvXCIuY29uY2F0KG1hc3RlcktleSwgXCIvc2VydmVyaW5mb1wiKSwgeyBoZWFkZXJzOiBoZWFkZXJzIH0sIHN0YXRlcy5oYW5kbGVSZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlcy5yZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGhhbmRsZVJlc3BvbnNlOiBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwic3RhdHVzIFwiLmNvbmNhdChyZXMuc3RhdHVzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlcy5yZXNvbHZlKEpTT04ucGFyc2UocmVzLmJvZHkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVzLnJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVzb2x2ZTogZnVuY3Rpb24gKHRhcmdldFBlZXIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlJlc29sdmVkIHRhcmdldCBwZWVyXCIsIHRhcmdldFBlZXIpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGVucmljaGVkVGFyZ2V0UGVlciA9IF9fYXNzaWduKHt9LCB0YXJnZXRQZWVyKTtcclxuICAgICAgICAgICAgICAgIGVucmljaGVkVGFyZ2V0UGVlci5wdWJsaWNLZXlzID0gX19hc3NpZ24oX19hc3NpZ24oe30sIGRlZmF1bHRQZWVyLnB1YmxpY0tleXMpLCB0YXJnZXRQZWVyLnB1YmxpY0tleXMpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRW5yaWNoZWQgdGFyZ2V0IHBlZXJcIiwgZW5yaWNoZWRUYXJnZXRQZWVyKTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVucmljaGVkVGFyZ2V0UGVlcik7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlamVjdDogZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc29sdmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU2VydmVyIGluZm8gcmVxdWVzdCBmYWlsZWQsIGZhbGxpbmcgYmFjayB0b1wiLCBkZWZhdWx0UGVlciwgXCI7IGVycm9yOlwiLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZGVmYXVsdFBlZXIpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgc3RhdGVzLnN0YXJ0KCk7XHJcbiAgICB9O1xyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRTZXJ2ZXJNb2RzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1hc3RlckFwaUNsaWVudCwgbWFzdGVyS2V5LCBhdHRlbXB0LCByZXMsIG1hbmlmZXN0LCBlXzE7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hc3RlckFwaUNsaWVudCA9IHRoaXMubWFrZU1hc3RlckFwaUNsaWVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXN0ZXJLZXkgPSB0aGlzLmdldFNlcnZlck1hc3RlcktleSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUobWFzdGVyS2V5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLmxhYmVsID0gMTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKGF0dGVtcHQgPCA1KSkgcmV0dXJuIFszIC8qYnJlYWsqLywgN107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLmxhYmVsID0gMjtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnRyeXMucHVzaChbMiwgNCwgLCA2XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlRyeWluZyB0byBnZXQgc2VydmVyIG1vZHMsIGF0dGVtcHQgXCIuY29uY2F0KGF0dGVtcHQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgbWFzdGVyQXBpQ2xpZW50LmdldChcIi9hcGkvc2VydmVycy9cIi5jb25jYXQobWFzdGVyS2V5LCBcIi9tYW5pZmVzdC5qc29uXCIpKV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXMgPSBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzICE9IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwic3RhdHVzIGNvZGUgXCIuY29uY2F0KHJlcy5zdGF0dXMsIFwiLCBlcnJvciBcIikuY29uY2F0KHJlcy5lcnJvcikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hbmlmZXN0ID0gSlNPTi5wYXJzZShyZXMuYm9keSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYW5pZmVzdC52ZXJzaW9uTWFqb3IgIT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcInNlcnZlciBtYW5pZmVzdCB2ZXJzaW9uIGlzIFwiLmNvbmNhdChtYW5pZmVzdC52ZXJzaW9uTWFqb3IsIFwiLCB3ZSBleHBlY3QgMVwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qLywgW11dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovLCBtYW5pZmVzdC5tb2RzXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVfMSA9IF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiUmVxdWVzdC9wYXJzZSBlcnJvcjogXCIuY29uY2F0KGVfMSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBVdGlsaXR5LndhaXQoMC4xICsgTWF0aC5yYW5kb20oKSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCA2XTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDY6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICsrYXR0ZW1wdDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgMV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA3OiByZXR1cm4gWzIgLypyZXR1cm4qLywgW11dO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLmdldFNlcnZlclBvcnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gUmV0dXJuIHRoZSBzZXJ2ZXIgcG9ydCBmcm9tIHNldHRpbmdzXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3Auc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2VydmVyLXBvcnQnXSB8fCA3Nzc3O1xyXG4gICAgfTtcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUubm9ybWFsaXplVXJsID0gZnVuY3Rpb24gKHVybCkge1xyXG4gICAgICAgIGlmICh1cmwuZW5kc1dpdGgoJy8nKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdXJsLnNsaWNlKDAsIHVybC5sZW5ndGggLSAxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVybDtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICByZXR1cm4gU2V0dGluZ3NTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNldHRpbmdzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBOZXR3b3JraW5nU2VydmljZSB9IGZyb20gXCIuL25ldHdvcmtpbmdTZXJ2aWNlXCI7XHJcbnZhciBTaW5nbGVQbGF5ZXJTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNpbmdsZVBsYXllclNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTaW5nbGVQbGF5ZXJTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLl9pc1NpbmdsZVBsYXllciA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImdhbWVMb2FkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkdhbWVMb2FkKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2luZ2xlUGxheWVyU2VydmljZS5wcm90b3R5cGUsIFwiaXNTaW5nbGVQbGF5ZXJcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5faXNTaW5nbGVQbGF5ZXI7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgU2luZ2xlUGxheWVyU2VydmljZS5wcm90b3R5cGUub25HYW1lTG9hZCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGlmICghZXZlbnQuaXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtICYmICF0aGlzLl9pc1NpbmdsZVBsYXllcikge1xyXG4gICAgICAgICAgICB0aGlzLnNwLkRlYnVnLm1lc3NhZ2VCb3goJ1NhdmUgaGFzIGJlZW4gbG9hZGVkIGluIG11bHRpcGxheWVyLCBzd2l0Y2hpbmcgdG8gdGhlIHNpbmdsZS1wbGF5ZXIgbW9kZScpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2lzU2luZ2xlUGxheWVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5zcC5HYW1lLnNldEluQ2hhcmdlbihmYWxzZSwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFNpbmdsZVBsYXllclNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU2luZ2xlUGxheWVyU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgcHJpbnRDb25zb2xlLCBzZXR0aW5ncywgc3RvcmFnZSwgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmltcG9ydCAqIGFzIG5ldHdvcmtpbmcgZnJvbSAnLi9uZXR3b3JraW5nU2VydmljZSc7XHJcbmltcG9ydCB7IHNldHVwSG9va3MgfSBmcm9tICcuLi8uLi9zeW5jL2FuaW1hdGlvbic7XHJcbmltcG9ydCB7IGF1dGhHYW1lRGF0YVN0b3JhZ2VLZXkgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9hdXRoTW9kZWwnO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gJy4vY2xpZW50TGlzdGVuZXInO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xyXG5pbXBvcnQgeyBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tICcuL3NldHRpbmdzU2VydmljZSc7XHJcbnByaW50Q29uc29sZSgnSGVsbG8gTXVsdGlwbGF5ZXIhJyk7XHJcbnByaW50Q29uc29sZSgnc2V0dGluZ3M6Jywgc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXSk7XHJcbnZhciBTa3ltcENsaWVudCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTa3ltcENsaWVudCwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNreW1wQ2xpZW50KHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNvbm5lY3Rpb25GYWlsZWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ29ubmVjdGlvbkZhaWxlZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY29ubmVjdGlvbkRlbmllZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Db25uZWN0aW9uRGVuaWVkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQWN0b3JDcmVhdGVNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICAvLyBUT0RPOiByZWZhY3RvciBvdXQgdmVyeSBzaW1pbGFyIGNvZGUgaW4gZnJvbnRIb3RSZWxvYWRTZXJ2aWNlLnRzXHJcbiAgICAgICAgdmFyIGF1dGhHYW1lRGF0YSA9IHN0b3JhZ2VbYXV0aEdhbWVEYXRhU3RvcmFnZUtleV07XHJcbiAgICAgICAgdmFyIHN0b3JhZ2VIYXNWYWxpZEF1dGhHYW1lRGF0YSA9IChhdXRoR2FtZURhdGEgPT09IG51bGwgfHwgYXV0aEdhbWVEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoR2FtZURhdGEubG9jYWwpIHx8IChhdXRoR2FtZURhdGEgPT09IG51bGwgfHwgYXV0aEdhbWVEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoR2FtZURhdGEucmVtb3RlKTtcclxuICAgICAgICBpZiAoc3RvcmFnZUhhc1ZhbGlkQXV0aEdhbWVEYXRhKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlJlY292ZXJlZCBBdXRoR2FtZURhdGEgZnJvbSBzdG9yYWdlLCBzdGFydGluZyBjbGllbnRcIik7XHJcbiAgICAgICAgICAgIF90aGlzLnN0YXJ0Q2xpZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJVbmFibGUgdG8gcmVjb3ZlciBBdXRoR2FtZURhdGEgZnJvbSBzdG9yYWdlLCByZXF1ZXN0aW5nIGF1dGhcIik7XHJcbiAgICAgICAgICAgIC8vIE5leHQgdGljayBiZWNhdXNlIHdlJ3JlIGluIGNvbnN0cnVjdG9yIG9mIHRoZSBzZXJ2aWNlLCBBdXRoU2VydmljZSBtYXkgbm90IGJlIGxpc3RlbmluZyBldmVudHMgeWV0XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhdXRoTmVlZGVkXCIsIHt9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImF1dGhBdHRlbXB0XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkF1dGhBdHRlbXB0KGUpOyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLm9uQXV0aEF0dGVtcHQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ2F1Z2h0IGF1dGggZXZlbnRcIik7XHJcbiAgICAgICAgc3RvcmFnZVthdXRoR2FtZURhdGFTdG9yYWdlS2V5XSA9IGUuYXV0aEdhbWVEYXRhO1xyXG4gICAgICAgIHRoaXMuc3RhcnRDbGllbnQoKTtcclxuICAgICAgICAvLyBUT0RPOiByZW1vdmUgdGhpcyB3aGVuIHlvdSB3aWxsIGJlIGFibGUgdG8gc2VlIGVycm9ycyB3aXRob3V0IGNvbnNvbGVcclxuICAgICAgICAvLyB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZChmYWxzZSk7XHJcbiAgICB9O1xyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLm9uQWN0b3JDcmVhdGVNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoZS5tZXNzYWdlLmlzTWUpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUub25Db25uZWN0aW9uRmFpbGVkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNvbm5lY3Rpb24gZmFpbGVkXCIpO1xyXG4gICAgfTtcclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5vbkNvbm5lY3Rpb25EZW5pZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ29ubmVjdGlvbiBkZW5pZWQ6IFwiICsgZS5lcnJvcik7XHJcbiAgICB9O1xyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLnN0YXJ0Q2xpZW50ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgLy8gb25jZShcInRpY2tcIiwgLi4uKSBpcyBuZWVkZWQgdG8gZW5zdXJlIG5ldHdvcmtpbmcgc2VydmljZSBpbml0aWFsaXplZFxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5lc3RhYmxpc2hDb25uZWN0aW9uQ29uZGl0aW9uYWwoKTsgfSk7XHJcbiAgICAgICAgdGhpcy5jdG9yKCk7XHJcbiAgICB9O1xyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLmN0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gVE9ETzogcmVmYWN0b3IgaW50byBzZXJ2aWNlXHJcbiAgICAgICAgc2V0dXBIb29rcygpO1xyXG4gICAgICAgIHRoaXMuc3AucHJpbnRDb25zb2xlKCdTa3ltcENsaWVudCBjdG9yJyk7XHJcbiAgICB9O1xyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLmVzdGFibGlzaENvbm5lY3Rpb25Db25kaXRpb25hbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBpc0Nvbm5lY3RlZCA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihuZXR3b3JraW5nLk5ldHdvcmtpbmdTZXJ2aWNlKS5pc0Nvbm5lY3RlZCgpO1xyXG4gICAgICAgIGlmIChpc0Nvbm5lY3RlZCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUmVjb25uZWN0IGlzIG5vdCByZXF1aXJlZCcpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXR0aW5nc1NlcnZpY2UpLmdldFRhcmdldFBlZXIoZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgIHZhciBob3N0ID0gX2EuaG9zdCwgcG9ydCA9IF9hLnBvcnQ7XHJcbiAgICAgICAgICAgIHN0b3JhZ2UudGFyZ2V0SXAgPSBob3N0O1xyXG4gICAgICAgICAgICBzdG9yYWdlLnRhcmdldFBvcnQgPSBwb3J0O1xyXG4gICAgICAgICAgICBwcmludENvbnNvbGUoXCJDb25uZWN0aW5nIHRvIFwiLmNvbmNhdChob3N0LCBcIjpcIikuY29uY2F0KHBvcnQpKTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihuZXR3b3JraW5nLk5ldHdvcmtpbmdTZXJ2aWNlKS5jb25uZWN0KGhvc3QsIHBvcnQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTa3ltcENsaWVudDtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTa3ltcENsaWVudCB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG52YXIgX19nZW5lcmF0b3IgPSAodGhpcyAmJiB0aGlzLl9fZ2VuZXJhdG9yKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgYm9keSkge1xyXG4gICAgdmFyIF8gPSB7IGxhYmVsOiAwLCBzZW50OiBmdW5jdGlvbigpIHsgaWYgKHRbMF0gJiAxKSB0aHJvdyB0WzFdOyByZXR1cm4gdFsxXTsgfSwgdHJ5czogW10sIG9wczogW10gfSwgZiwgeSwgdCwgZztcclxuICAgIHJldHVybiBnID0geyBuZXh0OiB2ZXJiKDApLCBcInRocm93XCI6IHZlcmIoMSksIFwicmV0dXJuXCI6IHZlcmIoMikgfSwgdHlwZW9mIFN5bWJvbCA9PT0gXCJmdW5jdGlvblwiICYmIChnW1N5bWJvbC5pdGVyYXRvcl0gPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0pLCBnO1xyXG4gICAgZnVuY3Rpb24gdmVyYihuKSB7IHJldHVybiBmdW5jdGlvbiAodikgeyByZXR1cm4gc3RlcChbbiwgdl0pOyB9OyB9XHJcbiAgICBmdW5jdGlvbiBzdGVwKG9wKSB7XHJcbiAgICAgICAgaWYgKGYpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBleGVjdXRpbmcuXCIpO1xyXG4gICAgICAgIHdoaWxlIChnICYmIChnID0gMCwgb3BbMF0gJiYgKF8gPSAwKSksIF8pIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChmID0gMSwgeSAmJiAodCA9IG9wWzBdICYgMiA/IHlbXCJyZXR1cm5cIl0gOiBvcFswXSA/IHlbXCJ0aHJvd1wiXSB8fCAoKHQgPSB5W1wicmV0dXJuXCJdKSAmJiB0LmNhbGwoeSksIDApIDogeS5uZXh0KSAmJiAhKHQgPSB0LmNhbGwoeSwgb3BbMV0pKS5kb25lKSByZXR1cm4gdDtcclxuICAgICAgICAgICAgaWYgKHkgPSAwLCB0KSBvcCA9IFtvcFswXSAmIDIsIHQudmFsdWVdO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKG9wWzBdKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDA6IGNhc2UgMTogdCA9IG9wOyBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDogXy5sYWJlbCsrOyByZXR1cm4geyB2YWx1ZTogb3BbMV0sIGRvbmU6IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICBjYXNlIDU6IF8ubGFiZWwrKzsgeSA9IG9wWzFdOyBvcCA9IFswXTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDc6IG9wID0gXy5vcHMucG9wKCk7IF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKHQgPSBfLnRyeXMsIHQgPSB0Lmxlbmd0aCA+IDAgJiYgdFt0Lmxlbmd0aCAtIDFdKSAmJiAob3BbMF0gPT09IDYgfHwgb3BbMF0gPT09IDIpKSB7IF8gPSAwOyBjb250aW51ZTsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gMyAmJiAoIXQgfHwgKG9wWzFdID4gdFswXSAmJiBvcFsxXSA8IHRbM10pKSkgeyBfLmxhYmVsID0gb3BbMV07IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSA2ICYmIF8ubGFiZWwgPCB0WzFdKSB7IF8ubGFiZWwgPSB0WzFdOyB0ID0gb3A7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHQgJiYgXy5sYWJlbCA8IHRbMl0pIHsgXy5sYWJlbCA9IHRbMl07IF8ub3BzLnB1c2gob3ApOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0WzJdKSBfLm9wcy5wb3AoKTtcclxuICAgICAgICAgICAgICAgICAgICBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG9wID0gYm9keS5jYWxsKHRoaXNBcmcsIF8pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgb3AgPSBbNiwgZV07IHkgPSAwOyB9IGZpbmFsbHkgeyBmID0gdCA9IDA7IH1cclxuICAgICAgICBpZiAob3BbMF0gJiA1KSB0aHJvdyBvcFsxXTsgcmV0dXJuIHsgdmFsdWU6IG9wWzBdID8gb3BbMV0gOiB2b2lkIDAsIGRvbmU6IHRydWUgfTtcclxuICAgIH1cclxufTtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHdvcmxkVmlld01pc2MgaW50byBzZXJ2aWNlXHJcbmltcG9ydCB7IHJlbW90ZUlkVG9Mb2NhbElkIH0gZnJvbSAnLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjJztcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgV29ybGRWaWV3IH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3XCI7XHJcbnZhciBTcFNuaXBwZXRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNwU25pcHBldFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTcFNuaXBwZXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNwU25pcHBldE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU3BTbmlwcGV0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuc3BBbnkgPSBzcDtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTcFNuaXBwZXRTZXJ2aWNlLnByb3RvdHlwZS5vblNwU25pcHBldE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfX2F3YWl0ZXIoX3RoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucnVuKG1zZylcclxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzTm9SZXN1bHRTbmlwcGV0ID0gbXNnLnNuaXBwZXRJZHggPT09IDB4ZmZmZmZmZmY7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzTm9SZXN1bHRTbmlwcGV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMgIT09IG51bGxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgdHlwZW9mIHJlcyAhPT0gXCJudW1iZXJcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiB0eXBlb2YgcmVzICE9PSBcInN0cmluZ1wiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHR5cGVvZiByZXMgIT09IFwiYm9vbGVhblwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIlVuc3VwcG9ydGVkIFNwU25pcHBldCByZXN1bHQgdHlwZSAnXCIuY29uY2F0KHR5cGVvZiByZXMsIFwiJ1wiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSByZXMgPT09IG51bGwgPyB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuRmluaXNoU3BTbmlwcGV0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzbmlwcGV0SWR4OiBtc2cuc25pcHBldElkeFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkZpbmlzaFNwU25pcHBldCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlOiByZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbmlwcGV0SWR4OiBtc2cuc25pcHBldElkeCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgJ1NwU25pcHBldCAnICsgbXNnLmNsYXNzICsgJyAnICsgbXNnLmZ1bmN0aW9uICsgJyBmYWlsZWQgJyArIGUpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pOyB9KTtcclxuICAgIH07XHJcbiAgICBTcFNuaXBwZXRTZXJ2aWNlLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoc25pcHBldCkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBmdW5jdGlvbkxvd2VyQ2FzZSwgY2xhc3NMb3dlckNhc2UsIG5ld05hbWUsIHNlbGZJZCwgc2VsZiwgcmVwbGFjZVZhbHVlLCB3b3JsZFZpZXdfMSwgZm9ybSwgc2lnbiwgY291bnQsIHNvdW5kSWQsIHNvdW5kLCBuYW1lLCBuYW1lO1xyXG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9iKSB7XHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbkxvd2VyQ2FzZSA9IHNuaXBwZXQuZnVuY3Rpb24udG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgIGNsYXNzTG93ZXJDYXNlID0gc25pcHBldC5jbGFzcy50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgLy8ga2VlcCBpbiBzeW5jIHdpdGggcmVtb3RlU2VydmVyLnRzXHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NMb3dlckNhc2UgPT09IFwib2JqZWN0cmVmZXJlbmNlXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZnVuY3Rpb25Mb3dlckNhc2UgPT09IFwic2V0ZGlzcGxheW5hbWVcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdOYW1lID0gc25pcHBldC5hcmd1bWVudHNbMF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3TmFtZSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZklkID0gcmVtb3RlSWRUb0xvY2FsSWQoc25pcHBldC5zZWxmSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZiA9IHRoaXMuc3AuT2JqZWN0UmVmZXJlbmNlLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeChzZWxmSWQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VWYWx1ZSA9IChfYSA9IHNlbGYgPT09IG51bGwgfHwgc2VsZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VsZi5nZXRCYXNlT2JqZWN0KCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXROYW1lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZVZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdOYW1lID0gbmV3TmFtZS5yZXBsYWNlKC8lb3JpZ2luYWxfbmFtZSUvZywgcmVwbGFjZVZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbmlwcGV0LmFyZ3VtZW50c1swXSA9IG5ld05hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkNvdWxkbid0IGdldCBhIHJlcGxhY2VWYWx1ZSBmb3IgU2V0RGlzcGxheU5hbWUsIHNuaXBwZXQuc2VsZklkIHdhc1wiLCBzbmlwcGV0LnNlbGZJZC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJFbmNvdW50ZXJlZCBTZXREaXNwbGF5TmFtZSB3aXRoIG5vbi1zdHJpbmcgYXJndW1lbnRcIiwgbmV3TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NMb3dlckNhc2UgPT09IFwiZ2FtZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZ1bmN0aW9uTG93ZXJDYXNlID09PSBcInNob3dyYWNlbWVudVwiIHx8IGZ1bmN0aW9uTG93ZXJDYXNlID09PSBcInNob3dsaW1pdGVkcmFjZW1lbnVcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcInNob3dyYWNlbWVudSBjYWxsZWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmxkVmlld18xID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFdvcmxkVmlldyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmxkVmlld18xLnNldEZvcm1WaWV3VXBkYXRlQWxsb3dlZChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiV2FpdGluZyAxLjBzIGJlZm9yZSBjYWxsaW5nIHNob3dyYWNlbWVudVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoMS4wKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJ1blN0YXRpYyhzbmlwcGV0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmxkVmlld18xLndhaXRHYW1lVGltZUFuZEFsbG93Rm9ybVZpZXdVcGRhdGUoMS4wKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NMb3dlckNhc2UgPT09IFwic2t5bXBoYWNrc1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZ1bmN0aW9uTG93ZXJDYXNlID09PSBcImFkZGl0ZW1cIiB8fCBmdW5jdGlvbkxvd2VyQ2FzZSA9PT0gXCJyZW1vdmVpdGVtXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybSA9IHRoaXMuc3AuRm9ybS5mcm9tKHRoaXMuZGVzZXJpYWxpemVBcmcoc25pcHBldC5hcmd1bWVudHNbMF0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm0gPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiVW5hYmxlIHRvIGZpbmQgZm9ybSB3aXRoIGlkIFwiICsgc25pcHBldC5hcmd1bWVudHNbMF0uZm9ybUlkLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgc2lnbiA9IHNuaXBwZXQuZnVuY3Rpb24gPT09IFwiQWRkSXRlbVwiID8gXCIrXCIgOiBcIi1cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY291bnQgPSBzbmlwcGV0LmFyZ3VtZW50c1sxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc291bmRJZCA9IDB4MzM0YWI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3JtLmdldEZvcm1JRCgpICE9PSAweGYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdW5kSWQgPSAweDE0MTE1O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvdW5kID0gdGhpcy5zcC5Tb3VuZC5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoc291bmRJZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc291bmQgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBmb3JtLmdldE5hbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lLnRyaW0oKSA9PT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU291bmQgd2lsbCBub3QgYmUgcGxheWVkIGJlY2F1c2UgaXRlbSBoYXMgbm8gbmFtZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdW5kLnBsYXkodGhpcy5zcC5HYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiVW5hYmxlIHRvIGZpbmQgc291bmQgd2l0aCBpZCBcIiArIHNvdW5kSWQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY291bnQgPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJQb3NpdGl2ZSBjb3VudCBleHBlY3RlZCwgZ290IFwiICsgY291bnQudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gZm9ybS5nZXROYW1lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZS50cmltKCkgPT09IFwiXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIk5vdGlmaWNhdGlvbiB3aWxsIG5vdCBiZSBzaG93biBiZWNhdXNlIGl0ZW0gaGFzIG5vIG5hbWVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNwLkRlYnVnLm5vdGlmaWNhdGlvbihzaWduICsgXCIgXCIgKyBuYW1lICsgXCIgKFwiICsgY291bnQgKyBcIilcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBzaWduICsgXCIgXCIgKyBuYW1lICsgXCIgKFwiICsgY291bnQgKyBcIilcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmtub3duIFNreW1wSGFjayAtIFwiICsgc25pcHBldC5mdW5jdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi8sIHNuaXBwZXQuc2VsZklkID8gdGhpcy5ydW5NZXRob2Qoc25pcHBldCkgOiB0aGlzLnJ1blN0YXRpYyhzbmlwcGV0KV07XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFNwU25pcHBldFNlcnZpY2UucHJvdG90eXBlLmRlc2VyaWFsaXplQXJnID0gZnVuY3Rpb24gKGFyZykge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYXJnID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgICAgIHZhciBmb3JtSWQgPSByZW1vdGVJZFRvTG9jYWxJZChhcmcuZm9ybUlkKTtcclxuICAgICAgICAgICAgdmFyIGZvcm0gPSB0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGZvcm1JZCk7XHJcbiAgICAgICAgICAgIHZhciBjbCA9IHRoaXMuc3BBbnlbYXJnLnR5cGVdO1xyXG4gICAgICAgICAgICBpZiAoIWNsKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdLZXkgPSBPYmplY3Qua2V5cyh0aGlzLnNwQW55KS5maW5kKGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ga2V5LnRvTG93ZXJDYXNlKCkgPT09IGFyZy50eXBlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmIChtYXRjaGluZ0tleSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsID0gdGhpcy5zcEFueVttYXRjaGluZ0tleV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFjbCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZGVzZXJpYWxpemVBcmcgLSBDbGFzcyBcIi5jb25jYXQoYXJnLnR5cGUsIFwiIG5vdCBmb3VuZFwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGdhbWVPYmplY3QgPSBjbC5mcm9tKGZvcm0pO1xyXG4gICAgICAgICAgICByZXR1cm4gZ2FtZU9iamVjdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFyZztcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBTcFNuaXBwZXRTZXJ2aWNlLnByb3RvdHlwZS5ydW5NZXRob2QgPSBmdW5jdGlvbiAoc25pcHBldCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHNlbGZJZCwgc2VsZiwgY2wsIG1hdGNoaW5nS2V5LCBzZWxmQ2FzdGVkLCBmO1xyXG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmSWQgPSByZW1vdGVJZFRvTG9jYWxJZChzbmlwcGV0LnNlbGZJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHNlbGZJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBmaW5kIGZvcm0gd2l0aCBpZCBcIi5jb25jYXQoc2VsZklkLnRvU3RyaW5nKDE2KSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbCA9IHRoaXMuc3BBbnlbc25pcHBldC5jbGFzc107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2wpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoaW5nS2V5ID0gT2JqZWN0LmtleXModGhpcy5zcEFueSkuZmluZChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleS50b0xvd2VyQ2FzZSgpID09PSBzbmlwcGV0LmNsYXNzLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaGluZ0tleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsID0gdGhpcy5zcEFueVttYXRjaGluZ0tleV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicnVuTWV0aG9kIC0gQ2xhc3MgXCIuY29uY2F0KHNuaXBwZXQuY2xhc3MsIFwiIG5vdCBmb3VuZCwgZm91bmRcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGZDYXN0ZWQgPSBjbC5mcm9tKHNlbGYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGZDYXN0ZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGb3JtIFwiLmNvbmNhdChzZWxmSWQudG9TdHJpbmcoMTYpLCBcIiBpcyBub3QgaW5zdGFuY2Ugb2YgXCIpLmNvbmNhdChzbmlwcGV0LmNsYXNzLCBcIiwgZm9ybSB0eXBlIGlzIFwiKS5jb25jYXQoc2VsZi5nZXRUeXBlKCkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZiA9IHNlbGZDYXN0ZWRbc25pcHBldC5mdW5jdGlvbl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIGYuYXBwbHkoc2VsZkNhc3RlZCwgc25pcHBldC5hcmd1bWVudHMubWFwKGZ1bmN0aW9uIChhcmcpIHsgcmV0dXJuIF90aGlzLmRlc2VyaWFsaXplQXJnKGFyZyk7IH0pKV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gWzIgLypyZXR1cm4qLywgX2Euc2VudCgpXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgU3BTbmlwcGV0U2VydmljZS5wcm90b3R5cGUucnVuU3RhdGljID0gZnVuY3Rpb24gKHNuaXBwZXQpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXB5cnVzQ2xhc3M7XHJcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcHlydXNDbGFzcyA9IHRoaXMuc3BBbnlbc25pcHBldC5jbGFzc107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIHBhcHlydXNDbGFzc1tzbmlwcGV0LmZ1bmN0aW9uXS5hcHBseShwYXB5cnVzQ2xhc3MsIHNuaXBwZXQuYXJndW1lbnRzLm1hcChmdW5jdGlvbiAoYXJnKSB7IHJldHVybiBfdGhpcy5kZXNlcmlhbGl6ZUFyZyhhcmcpOyB9KSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIFsyIC8qcmV0dXJuKi8sIF9hLnNlbnQoKV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIHJldHVybiBTcFNuaXBwZXRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNwU25pcHBldFNlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgcmVxdWlyZWRWZXJzaW9uIH0gZnJvbSBcIi4uLy4uL3ZlcnNpb25cIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNwVmVyc2lvbkNoZWNrU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNwVmVyc2lvbkNoZWNrU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBjb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTcFZlcnNpb25DaGVja1NlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgcmVhbFZlcnNpb24gPSB0aGlzLnNwLmdldFBsYXRmb3JtVmVyc2lvbigpO1xyXG4gICAgICAgIGlmICghcmVxdWlyZWRWZXJzaW9uLmluY2x1ZGVzKHJlYWxWZXJzaW9uKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLkRlYnVnLm1lc3NhZ2VCb3goXCJZb3UgbmVlZCB0byBoYXZlIG9uIG9mIHRob3NlIFNreXJpbVBsYXRmb3JtIHZlcnNpb25zIFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShyZXF1aXJlZFZlcnNpb24pLCBcIiB0byBqb2luIHRoaXMgc2VydmVyLiBZb3VyIGN1cnJlbnQgdmVyc2lvbiBpcyBcIikuY29uY2F0KHJlYWxWZXJzaW9uKSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0TWVudU1vZGUoMC41KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIV90aGlzLnNwLlVpLmlzTWVudU9wZW4oJ01lc3NhZ2VCb3hNZW51JykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5xdWl0VG9NYWluTWVudSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFNwVmVyc2lvbkNoZWNrU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTcFZlcnNpb25DaGVja1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgcGxheWVySWQgPSAweDE0O1xyXG4vLyBleCBBbmltRGVidWdTZXJ2aWNlIHBhcnRcclxudmFyIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY3VycmVudEFuaW0gPSBudWxsO1xyXG4gICAgICAgIF90aGlzLnN0b3BBbmltSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmV4aXRBbmltTmFtZSA9IG51bGw7XHJcbiAgICAgICAgX3RoaXMuaW50ZXJydXB0QW5pbU5hbWUgPSBudWxsO1xyXG4gICAgICAgIF90aGlzLnRyeUludm9rZUFuaW1Db3VudCA9IDA7XHJcbiAgICAgICAgX3RoaXMubGFzdE5vdGlmaWNhdGlvbk1vbWVudCA9IDA7XHJcbiAgICAgICAgX3RoaXMudHJ5SW52b2tlQW5pbUNvdW50TWF4ID0gMTAwMDAwMDAwMDtcclxuICAgICAgICBfdGhpcy5leGl0QW5pbUV2ZW50ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIF90aGlzLm9wdGlvbnNDYWNoZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICBfdGhpcy5vcHRpb25DYiA9IHVuZGVmaW5lZDtcclxuICAgICAgICBfdGhpcy51c2VQbGF5ZXJDb250cm9sc0RlbGF5TXMgPSB0cnVlO1xyXG4gICAgICAgIHZhciBoYXNTd2VldFBpZSA9IF90aGlzLmhhc1N3ZWV0UGllKCk7XHJcbiAgICAgICAgaWYgKCFoYXNTd2VldFBpZSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGRpc2FibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBlbmFibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy5zZXR0aW5ncyA9IF90aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImFuaW1EZWJ1Z1wiXTtcclxuICAgICAgICBpZiAoaGFzU3dlZXRQaWUpIHtcclxuICAgICAgICAgICAgdmFyIHNlbGZfMSA9IF90aGlzO1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7IH0sXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGZfMS5vblNlbmRBbmltYXRpb25FdmVudExlYXZlKGN0eCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZl8xLm9uU2VuZEV4aXRBbmltYXRpb25FdmVudExlYXZlKGN0eCk7IC8vIFRyYWNraW5nIHRoZSBzdWNjZXNzZnVsIGxhdW5jaCBvZiB0aGUgZXhpdCBhbmltYXRpb25cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sIHBsYXllcklkLCBwbGF5ZXJJZCk7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJidXR0b25FdmVudFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25CdXR0b25FdmVudChlKTsgfSk7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImN1c3RvbVBhY2tldE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3VzdG9tUGFja2V0TWVzc2FnZTIoZSk7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUub25DdXN0b21QYWNrZXRNZXNzYWdlMiA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgY29udGVudCA9IHt9O1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnRlbnQgPSBKU09OLnBhcnNlKGUubWVzc2FnZS5jb250ZW50SnNvbkR1bXApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJGYWlsZWQgdG8gcGFyc2UgY3VzdG9tIHBhY2tldCBjb250ZW50SnNvbkR1bXA6XCIsIGUubWVzc2FnZS5jb250ZW50SnNvbkR1bXAsIFwiRXJyb3I6XCIsIGVycik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhyb3cgZXJyO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29udGVudFtcImN1c3RvbVBhY2tldFR5cGVcIl0gIT09IFwiaW52b2tlQW5pbVwiKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBjdXN0b20gcGFja2V0IHdpdGggY3VzdG9tUGFja2V0VHlwZSBpbnZva2VBbmltXCIpO1xyXG4gICAgICAgIHZhciBuYW1lID0gY29udGVudFtcImFuaW1FdmVudE5hbWVcIl07XHJcbiAgICAgICAgdmFyIHJlcXVlc3RJZCA9IGNvbnRlbnRbXCJyZXF1ZXN0SWRcIl07XHJcbiAgICAgICAgdmFyIHdlYXBvbkRyYXduQWxsb3dlZCA9IGNvbnRlbnRbXCJ3ZWFwb25EcmF3bkFsbG93ZWRcIl07XHJcbiAgICAgICAgdmFyIGZ1cm5pdHVyZUFsbG93ZWQgPSBjb250ZW50W1wiZnVybml0dXJlQWxsb3dlZFwiXTtcclxuICAgICAgICB2YXIgZXhpdEFuaW1OYW1lID0gY29udGVudFtcImV4aXRBbmltTmFtZVwiXTtcclxuICAgICAgICB2YXIgaW50ZXJydXB0QW5pbU5hbWUgPSBjb250ZW50W1wiaW50ZXJydXB0QW5pbU5hbWVcIl07XHJcbiAgICAgICAgdmFyIHRpbWVNcyA9IGNvbnRlbnRbXCJ0aW1lTXNcIl07XHJcbiAgICAgICAgdmFyIGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQgPSBjb250ZW50W1wiaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZFwiXTtcclxuICAgICAgICB2YXIgcGFyZW50QW5pbUV2ZW50TmFtZSA9IGNvbnRlbnRbXCJwYXJlbnRBbmltRXZlbnROYW1lXCJdO1xyXG4gICAgICAgIHZhciBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgPSBjb250ZW50W1wiZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zXCJdO1xyXG4gICAgICAgIHZhciBwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcyA9IGNvbnRlbnRbXCJwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNc1wiXTtcclxuICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJFeHBlY3RlZCBhbmltRXZlbnROYW1lIHRvIGJlIHN0cmluZ1wiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIHJlcXVlc3RJZCAhPT0gXCJzdHJpbmdcIiAmJiB0eXBlb2YgcmVxdWVzdElkICE9PSBcIm51bWJlclwiICYmIHR5cGVvZiByZXF1ZXN0SWQgIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJFeHBlY3RlZCByZXF1ZXN0SWQgdG8gYmUgc3RyaW5nIG9yIG51bWJlciBvciB1bmRlZmluZWRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJUcnlpbmcgdG8gaW52b2tlIGFuaW1cIiwgbmFtZSwgXCJ3aXRoIHdlYXBvbkRyYXduQWxsb3dlZD1cIiwgd2VhcG9uRHJhd25BbGxvd2VkLCBcIiwgZnVybml0dXJlQWxsb3dlZD1cIiwgZnVybml0dXJlQWxsb3dlZCwgXCIsIGV4aXRBbmltTmFtZT1cIiwgZXhpdEFuaW1OYW1lLCBcIiwgaW50ZXJydXB0QW5pbU5hbWU9XCIsIGludGVycnVwdEFuaW1OYW1lLCBcIiwgdGltZU1zPVwiLCB0aW1lTXMsIFwiLCBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkPVwiLCBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkLCBcIiwgcGFyZW50QW5pbUV2ZW50TmFtZT1cIiwgcGFyZW50QW5pbUV2ZW50TmFtZSwgXCIsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcz1cIiwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zLCBcIiwgcHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXM9XCIsIHByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zKTtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IF90aGlzLnRyeUludm9rZUFuaW0obmFtZSwgeyB3ZWFwb25EcmF3bkFsbG93ZWQ6IHdlYXBvbkRyYXduQWxsb3dlZCwgZnVybml0dXJlQWxsb3dlZDogZnVybml0dXJlQWxsb3dlZCwgZXhpdEFuaW1OYW1lOiBleGl0QW5pbU5hbWUsIGludGVycnVwdEFuaW1OYW1lOiBpbnRlcnJ1cHRBbmltTmFtZSwgdGltZU1zOiB0aW1lTXMsIGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQ6IGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQsIHBhcmVudEFuaW1FdmVudE5hbWU6IHBhcmVudEFuaW1FdmVudE5hbWUsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zLCBwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNczogcHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMgfSk7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21QYWNrZXQsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50SnNvbkR1bXA6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21QYWNrZXRUeXBlOiBcImludm9rZUFuaW1SZXN1bHRcIixcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdCxcclxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0SWQ6IHJlcXVlc3RJZCxcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCIsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRBbmltYXRpb25FdmVudExlYXZlID0gZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIGFuaW1Mb3dlckNhc2UgPSBjdHguYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIGlmIChhbmltTG93ZXJDYXNlLnN0YXJ0c1dpdGgoXCJpZGxlXCIpICYmICFhbmltTG93ZXJDYXNlLnN0YXJ0c1dpdGgoXCJpZGxlZm9yY2VkZWZhdWx0c3RhdGVcIikpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBvbmx5IGZvciBwbGF5ZXIucGxheWlkbGVcclxuICAgICAgICAgICAgICAgIGlmICghX3RoaXMuc3AuVWkuaXNNZW51T3BlbihcIkNvbnNvbGVcIiAvKiBNZW51LkNvbnNvbGUgKi8pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKChfYSA9IF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGdXJuaXR1cmVSZWZlcmVuY2UoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkZvcmNpbmcgdGhpcmQgcGVyc29uIGFuZCBkaXNhYmxpbmcgcGxheWVyIGNvbnRyb2xzXCIpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5mb3JjZVRoaXJkUGVyc29uKCk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmRpc2FibGVQbGF5ZXJDb250cm9scyh0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmN1cnJlbnRBbmltID0geyBuYW1lOiBjdHguYW5pbUV2ZW50TmFtZSwgb3B0aW9uczogbnVsbCwgcHJlZmVySW50ZXJydXB0QW5pbVN0YXRlOiBudWxsIH07XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zdGFydEFudGlFeHBsb2l0UG9sbGluZygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLmV4aXRBbmltID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYSwgX2I7XHJcbiAgICAgICAgLy8gVE9ETygxKTogU2VlIGFub3RoZXIgVE9ETygxKSBpbiB0aGlzIGZpbGVcclxuICAgICAgICBpZiAob3B0aW9ucy5wbGF5RXhpdEFuaW0pIHtcclxuICAgICAgICAgICAgdmFyIHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltKSB7XHJcbiAgICAgICAgICAgICAgICB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVzZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJVc2luZyBpbnRlcnJ1cHQgYW5pbSBhcyBleGl0IGFuaW06IFwiLmNvbmNhdCh0aGlzLmludGVycnVwdEFuaW1OYW1lLCBcIi4gUmVhc29uOiB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSBpcyB0cnVlXCIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoKF9iID0gKF9hID0gdGhpcy5jdXJyZW50QW5pbSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnByZWZlckludGVycnVwdEFuaW1TdGF0ZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnByZWZlcikge1xyXG4gICAgICAgICAgICAgICAgdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51c2VQbGF5ZXJDb250cm9sc0RlbGF5TXMgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiVXNpbmcgaW50ZXJydXB0IGFuaW0gYXMgZXhpdCBhbmltOiBcIi5jb25jYXQodGhpcy5pbnRlcnJ1cHRBbmltTmFtZSwgXCIuIFJlYXNvbjogcHJlZmVySW50ZXJydXB0QW5pbVN0YXRlLnByZWZlciBpcyB0cnVlXCIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgYW5pbUV2ZW50VG9TZW5kID0gdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0gPyAodGhpcy5pbnRlcnJ1cHRBbmltTmFtZSB8fCBcIklkbGVTdG9wXCIpIDogKHRoaXMuZXhpdEFuaW1OYW1lIHx8IFwiSWRsZUZvcmNlRGVmYXVsdFN0YXRlXCIpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLkRlYnVnLnNlbmRBbmltYXRpb25FdmVudCh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCksIGFuaW1FdmVudFRvU2VuZCk7XHJcbiAgICAgICAgICAgIHRoaXMuZXhpdEFuaW1FdmVudCA9IGFuaW1FdmVudFRvU2VuZDtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zQ2FjaGUgPSBvcHRpb25zO1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlbnQgYW5pbWF0aW9uIGV2ZW50OlwiLCBhbmltRXZlbnRUb1NlbmQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbSA9IG51bGw7XHJcbiAgICAgICAgICAgIHZhciBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5U2Vjb25kcyA9ICh0eXBlb2Ygb3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgPT09IFwibnVtYmVyXCJcclxuICAgICAgICAgICAgICAgICYmIG9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zID4gMFxyXG4gICAgICAgICAgICAgICAgJiYgTnVtYmVyLmlzRmluaXRlKG9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zKVxyXG4gICAgICAgICAgICAgICAgJiYgdGhpcy51c2VQbGF5ZXJDb250cm9sc0RlbGF5TXMpXHJcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zIC8gMTAwMFxyXG4gICAgICAgICAgICAgICAgOiAwLjU7XHJcbiAgICAgICAgICAgIHZhciBzdG9wQW5pbURlbGF5U2Vjb25kcyA9IGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlTZWNvbmRzICsgMC41O1xyXG4gICAgICAgICAgICB0aGlzLnN0b3BBbmltSW5Qcm9ncmVzcyA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlTZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZW5hYmxlUGxheWVyQ29udHJvbHModHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdChzdG9wQW5pbURlbGF5U2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zdG9wQW5pbUluUHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25DYikge1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLm9wdGlvbkNiKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMub3B0aW9uQ2IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUub25TZW5kRXhpdEFuaW1hdGlvbkV2ZW50TGVhdmUgPSBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoY3R4LmFuaW1hdGlvblN1Y2NlZWRlZCAmJiB0aGlzLmV4aXRBbmltRXZlbnQgJiYgdGhpcy5vcHRpb25zQ2FjaGUgJiYgY3R4LmFuaW1FdmVudE5hbWUgPT09IHRoaXMuZXhpdEFuaW1FdmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRBbmltID0gbnVsbDtcclxuICAgICAgICAgICAgdmFyIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlTZWNvbmRzID0gKHR5cGVvZiB0aGlzLm9wdGlvbnNDYWNoZS5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgPT09IFwibnVtYmVyXCJcclxuICAgICAgICAgICAgICAgICYmIHRoaXMub3B0aW9uc0NhY2hlLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyA+IDBcclxuICAgICAgICAgICAgICAgICYmIE51bWJlci5pc0Zpbml0ZSh0aGlzLm9wdGlvbnNDYWNoZS5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMpXHJcbiAgICAgICAgICAgICAgICAmJiB0aGlzLnVzZVBsYXllckNvbnRyb2xzRGVsYXlNcylcclxuICAgICAgICAgICAgICAgID8gdGhpcy5vcHRpb25zQ2FjaGUuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zIC8gMTAwMFxyXG4gICAgICAgICAgICAgICAgOiAwLjU7XHJcbiAgICAgICAgICAgIHZhciBzdG9wQW5pbURlbGF5U2Vjb25kcyA9IGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlTZWNvbmRzICsgMC41O1xyXG4gICAgICAgICAgICB0aGlzLnN0b3BBbmltSW5Qcm9ncmVzcyA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9uc0NhY2hlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB0aGlzLmV4aXRBbmltRXZlbnQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRoaXMudXNlUGxheWVyQ29udHJvbHNEZWxheU1zID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheVNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5lbmFibGVQbGF5ZXJDb250cm9scyh0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KHN0b3BBbmltRGVsYXlTZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnN0b3BBbmltSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbkNiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMub3B0aW9uQ2IoKTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcHRpb25DYiA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnNDYWNoZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdGhpcy5leGl0QW5pbUV2ZW50ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25DYikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25DYiA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUuc3RhcnRBbnRpRXhwbG9pdFBvbGxpbmcgPSBmdW5jdGlvbiAobW9kZSkge1xyXG4gICAgICAgIC8vIEZpeGVzIGh0dHBzOi8vZ2l0aHViLmNvbS9za3lyaW0tbXVsdGlwbGF5ZXIvc2t5bXA1LWdhbWVtb2RlL2lzc3Vlcy8yNDBcclxuICAgICAgICAvLyBQLlMuIFRoZXJlIGlzIGEgdmVyeSBzaW1pbGFyIGNvZGUgaW4gc2t5bXA1LWdhbWVtb2RlXHJcbiAgICAgICAgLy8gU2VlIGRpc2FibGVDaGVhdHMudHMsIHNreW1wNS1nYW1lbW9kZSBmb3IgY29tbWVudHNcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmIChtb2RlID09PSB2b2lkIDApIHsgbW9kZSA9IFwiZGVhdGhcIjsgfVxyXG4gICAgICAgIHZhciBfY2FsbE5hdGl2ZSA9IHRoaXMuc3AuY2FsbE5hdGl2ZTtcclxuICAgICAgICB2YXIgY2FtZXJhU3RhdGUgPSAtMTtcclxuICAgICAgICB2YXIgbmVlZHNFeGl0aW5nQW5pbSA9IGZhbHNlO1xyXG4gICAgICAgIHZhciBmID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICBpZiAoaSA+PSAxMCAqIDYwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FtZXJhU3RhdGUgPSBfY2FsbE5hdGl2ZShcIkdhbWVcIiwgXCJnZXRDYW1lcmFTdGF0ZVwiLCB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICBuZWVkc0V4aXRpbmdBbmltID0gX3RoaXMubmVlZHNFeGl0aW5nQW5pbTtcclxuICAgICAgICAgICAgaWYgKCFuZWVkc0V4aXRpbmdBbmltKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZihJbmZpbml0eSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNhbWVyYVN0YXRlID09PSAwKSB7IC8vIDEtc3QgcGVyc29uXHJcbiAgICAgICAgICAgICAgICBfY2FsbE5hdGl2ZShcIkdhbWVcIiwgXCJmb3JjZVRoaXJkUGVyc29uXCIsIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5leGl0QW5pbSh7IHBsYXlFeGl0QW5pbTogdHJ1ZSwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiB1bmRlZmluZWQgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZSA9PT0gXCJkZWF0aFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgKF9hID0gX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRhbWFnZUFjdG9yVmFsdWUoXCJIZWFsdGhcIiwgMTAwMDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGYoSW5maW5pdHkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBmKGkgKyAxKTsgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBmKDApO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5vbkJ1dHRvbkV2ZW50ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX2EsIF9iO1xyXG4gICAgICAgIC8vIFRPRE86IGRlLWhhcmRjb2RlIGNvbnRyb2xzXHJcbiAgICAgICAgaWYgKGUuaXNQcmVzc2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGUuY29kZSA9PT0gNTcgLyogRHhTY2FuQ29kZS5TcGFjZWJhciAqL1xyXG4gICAgICAgICAgICB8fCBlLmNvZGUgPT09IDE3IC8qIER4U2NhbkNvZGUuVyAqL1xyXG4gICAgICAgICAgICB8fCBlLmNvZGUgPT09IDMwIC8qIER4U2NhbkNvZGUuQSAqL1xyXG4gICAgICAgICAgICB8fCBlLmNvZGUgPT09IDMxIC8qIER4U2NhbkNvZGUuUyAqL1xyXG4gICAgICAgICAgICB8fCBlLmNvZGUgPT09IDMyIC8qIER4U2NhbkNvZGUuRCAqLykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5uZWVkc0V4aXRpbmdBbmltKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoKF9hID0gdGhpcy5jdXJyZW50QW5pbSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4aXRBbmltKHsgcGxheUV4aXRBbmltOiB0cnVlLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IHRoaXMuY3VycmVudEFuaW0ub3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4aXRBbmltKHsgcGxheUV4aXRBbmltOiB0cnVlLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IHVuZGVmaW5lZCB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubmVlZHNFeGl0aW5nQW5pbSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGludGVydmFsTXMgPSAoX2IgPSB0aGlzLnNldHRpbmdzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZXhpdEFuaW1Ob3RpZmljYXRpb25JbnRlcnZhbE1zO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpbnRlcnZhbE1zIHx8IChEYXRlLm5vdygpIC0gdGhpcy5sYXN0Tm90aWZpY2F0aW9uTW9tZW50KSA+PSBpbnRlcnZhbE1zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0Tm90aWZpY2F0aW9uTW9tZW50ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNwLkRlYnVnLm5vdGlmaWNhdGlvbihcItCf0YDQvtCx0LXQuywg0YfRgtC+0LHRiyDQstGL0LnRgtC4INC40Lcg0LDQvdC40LzQsNGG0LjQuFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWUuaXNVcCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5zZXR0aW5ncyB8fCAhdGhpcy5zZXR0aW5ncy5hbmltS2V5cykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhbmltRXZlbnQgPSB0aGlzLnNldHRpbmdzLmFuaW1LZXlzW2UuY29kZV07XHJcbiAgICAgICAgaWYgKCFhbmltRXZlbnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlN0YXJ0aW5nIGFuaW1zIGZyb20ga2V5Ym9hcmQgaXMgZGlzYWJsZWQgaW4gdGhpcyB2ZXJzaW9uXCIpO1xyXG4gICAgICAgIC8vIHRoaXMudHJ5SW52b2tlQW5pbShhbmltRXZlbnQsIHtcclxuICAgICAgICAvLyAgICAgd2VhcG9uRHJhd25BbGxvd2VkOiBmYWxzZSxcclxuICAgICAgICAvLyAgICAgZnVybml0dXJlQWxsb3dlZDogZmFsc2UsXHJcbiAgICAgICAgLy8gICAgIGV4aXRBbmltTmFtZTogbnVsbCxcclxuICAgICAgICAvLyAgICAgaW50ZXJydXB0QW5pbU5hbWU6IG51bGwsXHJcbiAgICAgICAgLy8gICAgIHRpbWVNczogMCxcclxuICAgICAgICAvLyAgICAgaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZDogdHJ1ZSxcclxuICAgICAgICAvLyAgICAgcGFyZW50QW5pbUV2ZW50TmFtZTogbnVsbCxcclxuICAgICAgICAvLyAgICAgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiBudWxsLFxyXG4gICAgICAgIC8vICAgICBwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNczogbnVsbCxcclxuICAgICAgICAvLyB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUudHJ5SW52b2tlQW5pbSA9IGZ1bmN0aW9uIChhbmltRXZlbnQsIG9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMudHJ5SW52b2tlQW5pbUNvdW50Kys7XHJcbiAgICAgICAgaWYgKHRoaXMudHJ5SW52b2tlQW5pbUNvdW50ID49IHRoaXMudHJ5SW52b2tlQW5pbUNvdW50TWF4KSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJ5SW52b2tlQW5pbUNvdW50ID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGN1cnJlbnRJbnZva2VBbmltQ291bnQgPSB0aGlzLnRyeUludm9rZUFuaW1Db3VudDtcclxuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZXhpdEFuaW1OYW1lID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXhpdEFuaW1OYW1lID0gb3B0aW9ucy5leGl0QW5pbU5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmV4aXRBbmltTmFtZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5pbnRlcnJ1cHRBbmltTmFtZSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICB0aGlzLmludGVycnVwdEFuaW1OYW1lID0gb3B0aW9ucy5pbnRlcnJ1cHRBbmltTmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW50ZXJydXB0QW5pbU5hbWUgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMudGltZU1zID09PSBcIm51bWJlclwiICYmIG9wdGlvbnMudGltZU1zID4gMCAmJiBOdW1iZXIuaXNGaW5pdGUob3B0aW9ucy50aW1lTXMpKSB7XHJcbiAgICAgICAgICAgIHZhciB0aW1lU2Vjb25kcyA9IG9wdGlvbnMudGltZU1zIC8gMTAwMDtcclxuICAgICAgICAgICAgLy8gVXNpbmcgVXRpbGl0eS53YWl0IG1ha2VzIHNlbnNlIGJlY2F1c2UgaXQgd2FpdHMgZ2FtZSB0aW1lLCBub3Qgc2ltcGx5IHJlYWwgdGltZS5cclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQodGltZVNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKF90aGlzLnRyeUludm9rZUFuaW1Db3VudCAhPT0gY3VycmVudEludm9rZUFuaW1Db3VudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghX3RoaXMubmVlZHNFeGl0aW5nQW5pbSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkID0gdHlwZW9mIG9wdGlvbnMuaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCA9PT0gXCJib29sZWFuXCIgPyBvcHRpb25zLmlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQgOiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuZXhpdEFuaW0oeyBwbGF5RXhpdEFuaW06IGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogb3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcGxheWVyID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIGlmICghcGxheWVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwicGxheWVyX25vdF9mb3VuZFwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwbGF5ZXIuaXNXZWFwb25EcmF3bigpICYmICFvcHRpb25zLndlYXBvbkRyYXduQWxsb3dlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcIndlYXBvbl9kcmF3blwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwbGF5ZXIuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiYkluSnVtcFN0YXRlXCIpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwianVtcF9zdGF0ZVwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnNwLlVpLmlzTWVudU9wZW4oXCJGYXZvcml0ZXNNZW51XCIgLyogTWVudS5GYXZvcml0ZXMgKi8pKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwiZmF2b3JpdGVzX21lbnVfb3BlblwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnNwLlVpLmlzTWVudU9wZW4oXCJDb25zb2xlXCIgLyogTWVudS5Db25zb2xlICovKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcImNvbnNvbGVfbWVudV9vcGVuXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc3RvcEFuaW1JblByb2dyZXNzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwiYnVzeV9zdG9wcGluZ19hbmltXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBsYXllci5nZXRGdXJuaXR1cmVSZWZlcmVuY2UoKSAmJiAhb3B0aW9ucy5mdXJuaXR1cmVBbGxvd2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwicGxheWVyX2luX2Z1cm5pdHVyZVwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwbGF5ZXIuaXNTbmVha2luZygpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwicGxheWVyX3NuZWFraW5nXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBsYXllci5pc1N3aW1taW5nKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJwbGF5ZXJfc3dpbW1pbmdcIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYW5pbUV2ZW50LnRvTG93ZXJDYXNlKCkgPT09IFwiaWRsZWZvcmNlZGVmYXVsdHN0YXRlXCIpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubmVlZHNFeGl0aW5nQW5pbSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leGl0QW5pbSh7IHBsYXlFeGl0QW5pbTogdHJ1ZSwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiB1bmRlZmluZWQgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHZhciBkb0ludm9rZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZm9yY2VUaGlyZFBlcnNvbigpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5kaXNhYmxlUGxheWVyQ29udHJvbHModHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5EZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQoX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSwgYW5pbUV2ZW50KTtcclxuICAgICAgICAgICAgICAgIHZhciBwcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGUgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zID09PSBcIm51bWJlclwiXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgb3B0aW9ucy5wcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcyA+IDBcclxuICAgICAgICAgICAgICAgICAgICAmJiBOdW1iZXIuaXNGaW5pdGUob3B0aW9ucy5wcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcykpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdGVfMSA9IHsgcHJlZmVyOiB0cnVlIH07XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUHJlZmVyIGludGVycnVwdCBhbmltIGFzIGV4aXQgYW5pbSBmb3IgXCIuY29uY2F0KG9wdGlvbnMucHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMsIFwiIG1zXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5zcC5VdGlsaXR5LndhaXQob3B0aW9ucy5wcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcyAvIDEwMDApLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZV8xLnByZWZlciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJQcmVmZXIgaW50ZXJydXB0IGFuaW0gYXMgZXhpdCBhbmltIHN0YXRlIGNoYW5nZWQgdG8gZmFsc2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJlZmVySW50ZXJydXB0QW5pbVN0YXRlID0gc3RhdGVfMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF90aGlzLmN1cnJlbnRBbmltID0geyBuYW1lOiBhbmltRXZlbnQsIG9wdGlvbnM6IG9wdGlvbnMsIHByZWZlckludGVycnVwdEFuaW1TdGF0ZTogcHJlZmVySW50ZXJydXB0QW5pbVN0YXRlIH07XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zdGFydEFudGlFeHBsb2l0UG9sbGluZyhcIm5vX2RlYXRoXCIpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMucGFyZW50QW5pbUV2ZW50TmFtZSA9PT0gXCJzdHJpbmdcIiAmJiB0aGlzLmN1cnJlbnRBbmltTmFtZSA9PT0gb3B0aW9ucy5wYXJlbnRBbmltRXZlbnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBkb0ludm9rZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucy5wYXJlbnRBbmltRXZlbnROYW1lKSAmJiBvcHRpb25zLnBhcmVudEFuaW1FdmVudE5hbWUuaW5jbHVkZXModGhpcy5jdXJyZW50QW5pbU5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICBkb0ludm9rZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMubmVlZHNFeGl0aW5nQW5pbSkge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETyAoMSk6IGNvbnNpZGVyIG5vdCB1c2luZyBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgaGVyZSwgYmVjYXVzZSB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSBkb2Vzbid0IG5lZWQgaXRcclxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uQ2IgPSBkb0ludm9rZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXhpdEFuaW0oeyBwbGF5RXhpdEFuaW06IHRydWUsIHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltOiB0cnVlLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IG9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9JbnZva2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlbnQgYW5pbWF0aW9uIGV2ZW50OiBcIi5jb25jYXQoYW5pbUV2ZW50KSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUuaGFzU3dlZXRQaWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1vZENvdW50ID0gdGhpcy5zcC5HYW1lLmdldE1vZENvdW50KCk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLkdhbWUuZ2V0TW9kTmFtZShpKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdzd2VldHBpZScpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZSwgXCJuZWVkc0V4aXRpbmdBbmltXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEFuaW1OYW1lICE9PSBudWxsO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUsIFwiY3VycmVudEFuaW1OYW1lXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEFuaW0gPyB0aGlzLmN1cnJlbnRBbmltLm5hbWUgOiBudWxsO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnJlcXVlc3RBZGRQZXJrc1RvQWN0b3JzID0gZnVuY3Rpb24gKGFjdG9ySWRzLCBwZXJrSWRzKSB7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWN0b3JzID0gYWN0b3JJZHMubWFwKGZ1bmN0aW9uIChhY3RvcklkKSB7IHJldHVybiBfdGhpcy5zcC5BY3Rvci5mcm9tKF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGFjdG9ySWQpKTsgfSkuZmlsdGVyKGZ1bmN0aW9uIChhY3RvcikgeyByZXR1cm4gYWN0b3IgIT09IG51bGw7IH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIHBlcmtzID0gcGVya0lkcy5tYXAoZnVuY3Rpb24gKHBlcmtJZCkgeyByZXR1cm4gX3RoaXMuc3AuUGVyay5mcm9tKF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHBlcmtJZCkpOyB9KS5maWx0ZXIoZnVuY3Rpb24gKHBlcmspIHsgcmV0dXJuIHBlcmsgIT09IG51bGw7IH0pO1xyXG4gICAgICAgICAgICAgICAgYWN0b3JzLmZvckVhY2goZnVuY3Rpb24gKGFjdG9yKSB7IHJldHVybiBwZXJrcy5mb3JFYWNoKGZ1bmN0aW9uIChwZXJrKSB7IHJldHVybiBhY3RvciA9PT0gbnVsbCB8fCBhY3RvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0b3IuYWRkUGVyayhwZXJrKTsgfSk7IH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmICghX3RoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGRpc2FibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBlbmFibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb250cm9sbGVyLm9uKCdjb250YWluZXJDaGFuZ2VkJywgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ29udGFpbmVyQ2hhbmdlZChlKTsgfSk7XHJcbiAgICAgICAgY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2V0SW52ZW50b3J5TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZXRJbnZlbnRvcnlNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBjb250cm9sbGVyLmVtaXR0ZXIub24oXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3JlYXRlQWN0b3JNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUub25Db250YWluZXJDaGFuZ2VkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlLm9sZENvbnRhaW5lciAmJiBlLm5ld0NvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBpZiAoZS5uZXdDb250YWluZXIuZ2V0Rm9ybUlEKCkgPT09IDB4MTQgJiYgZS5udW1JdGVtcyA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUGxheWVySW52ZW50b3J5Q2hhbmdlZCh7XHJcbiAgICAgICAgICAgICAgICAgICAgYmFzZUlkOiBlLmJhc2VPYmouZ2V0Rm9ybUlEKCksXHJcbiAgICAgICAgICAgICAgICAgICAgY291bnQ6IGUubnVtSXRlbXMsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUub25TZXRJbnZlbnRvcnlNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGVudHJpZXMgPSBlLm1lc3NhZ2UuaW52ZW50b3J5LmVudHJpZXM7XHJcbiAgICAgICAgaWYgKGVudHJpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgU2V0SW52ZW50b3J5TWVzc2FnZSB3aXRoIGVtcHR5IGludmVudG9yeVwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGVudHJpZXMuZm9yRWFjaChmdW5jdGlvbiAoZW50cnkpIHsgcmV0dXJuIF90aGlzLmhhbmRsZVBsYXllckludmVudG9yeUNoYW5nZWQoZW50cnkpOyB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUub25DcmVhdGVBY3Rvck1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hLCBfYjtcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghZS5tZXNzYWdlLmlzTWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZW50cmllcyA9IChfYiA9IChfYSA9IGUubWVzc2FnZS5wcm9wcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmludmVudG9yeSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmVudHJpZXM7XHJcbiAgICAgICAgaWYgKGVudHJpZXMgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIENyZWF0ZUFjdG9yTWVzc2FnZSB3aXRob3V0IGludmVudG9yeVwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZW50cmllcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBDcmVhdGVBY3Rvck1lc3NhZ2Ugd2l0aCBlbXB0eSBpbnZlbnRvcnlcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBlbnRyaWVzLmZvckVhY2goZnVuY3Rpb24gKGVudHJ5KSB7IHJldHVybiBfdGhpcy5oYW5kbGVQbGF5ZXJJbnZlbnRvcnlDaGFuZ2VkKGVudHJ5KTsgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLmhhbmRsZVBsYXllckludmVudG9yeUNoYW5nZWQgPSBmdW5jdGlvbiAoZW50cnkpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBpdGVtID0gdGhpcy5zcC5HYW1lLmdldEZvcm1FeChlbnRyeS5iYXNlSWQpO1xyXG4gICAgICAgIGlmICghaXRlbSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlbnRyeS5jb3VudCA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHBlcmtJZHMgPSB0aGlzLmdldFBlcmtJZHNCeUtleXdvcmQoaXRlbSk7XHJcbiAgICAgICAgaWYgKHBlcmtJZHMpIHtcclxuICAgICAgICAgICAgdmFyIHBsYXllcklkID0gMHgxNDtcclxuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QWRkUGVya3NUb0FjdG9ycyhbcGxheWVySWRdLCBwZXJrSWRzKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLmdldFBlcmtJZHNCeUtleXdvcmQgPSBmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIHRoaXMuZ2V0S2V5d29yZFBlcmtNYXAoKS5mb3JFYWNoKGZ1bmN0aW9uICh2LCBrKSB7XHJcbiAgICAgICAgICAgIHZhciBrZXlXb3JkID0gX3RoaXMuc3AuS2V5d29yZC5nZXRLZXl3b3JkKGspO1xyXG4gICAgICAgICAgICBpZiAoaXRlbS5oYXNLZXl3b3JkKGtleVdvcmQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID4gMCA/IHJlc3VsdCA6IG51bGw7XHJcbiAgICB9O1xyXG4gICAgLy8gVE9ETzogbW92ZSB0aGlzIHRvIGNvbmZpZ1xyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLmdldEtleXdvcmRQZXJrTWFwID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgTWFwKFtcclxuICAgICAgICAgICAgLy8g0KHRgtGA0LXQu9C10YZcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQm93MVwiLCAweDEwMzZGMF0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0JvdzJcIiwgMHg1OEY2MV0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0JvdzNcIiwgMHgxMDVGMTldLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCb3c0XCIsIDB4NThGNjNdLFxyXG4gICAgICAgICAgICAvLyDQo9Cx0LjQudGG0LBcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrU25lYWsxXCIsIDB4NTgyMTBdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtTbmVhazJcIiwgMHgxMDVGMjNdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtTbmVhazNcIiwgMHg1ODIwOF0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya1NuZWFrNFwiLCAweDU4MjExXSxcclxuICAgICAgICAgICAgLy8g0J/QtdGF0L7RgtC40L3QtdGGXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0FybW9yTGlnaHQxXCIsIDB4MTA1RjIyXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQXJtb3JMaWdodDJcIiwgMHg1MUIxQ10sXHJcbiAgICAgICAgICAgIC8vINCX0LDRh9Cw0YDQvtCy0LDRgtC10LvRjFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtFbmNoYW50MlwiLCAweDEwOEE0NF0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0VuY2hhbnQxXCIsIDB4NThGN0NdLFxyXG4gICAgICAgICAgICAvLyDQm9Cw0YLQvdC40LpcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQXJtb3JIZWF2eTFcIiwgMHhCQ0QyQl0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0FybW9ySGVhdnkyXCIsIDB4NThGNkRdLFxyXG4gICAgICAgICAgICAvLyDQqdC40YLQvtC90L7RgdC10YZcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQmxvY2sxXCIsIDB4NThGNjddLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCbG9jazJcIiwgMHgxMDYyNTNdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCbG9jazNcIiwgMHg1OEY2QV0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0Jsb2NrNFwiLCAweDU4RjY5XSxcclxuICAgICAgICAgICAgLy8g0JzQtdGH0L3QuNC6LCDQutC70LjQvdC+0LosINGA0YPQsdCw0LrQsCwg0LrRgNGD0YjQuNGC0LXQu9GMLCDQvNC+0L3QsNGFLCDQutC+0L/QtdC50YnQuNC6LCDRgdGC0YDQsNC20L3QuNC6ICjQtNCy0YPRgNGD0YfQvdC+0LUg0L7RgNGD0LbQuNC1KVxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsxSGFuZDJIYW5kMVwiLCAweDU4RjZGXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMkhhbmQyXCIsIDB4Q0I0MDddLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsySGFuZDNcIiwgMHg5NjU5MF0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazJIYW5kNFwiLCAweDUyRDUxXSxcclxuICAgICAgICAgICAgLy8g0JDRgdGB0LDRgdC40L0sINGA0LDQt9Cy0LXQtNGH0LjQuiwg0YjQv9C40L7QvSwg0L/RgNC10LTRiNC10YHRgtCy0LXQvdC90LjQuiwg0YDRi9GG0LDRgNGMLCDRgNCw0LfQsdC+0LnQvdC40LosINCx0LXRgNGB0LXRgNC6LCDQs9GA0L7QvNC40LvQsCAo0L7QtNC90L7RgNGD0YfQvdC+0LUg0L7RgNGD0LbQuNC1KVxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsxSGFuZDJIYW5kMVwiLCAweDU4RjZGXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMUhhbmQyXCIsIDB4Q0I0MDZdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsxSGFuZDNcIiwgMHgxMDYyNTZdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsxSGFuZDRcIiwgMHg1MkQ1MF0sXHJcbiAgICAgICAgXSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLmhhc1N3ZWV0UGllID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtb2RDb3VudCA9IHRoaXMuc3AuR2FtZS5nZXRNb2RDb3VudCgpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kQ291bnQ7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5HYW1lLmdldE1vZE5hbWUoaSkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3dlZXRwaWUnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBjb250cm9sbGVyLmVtaXR0ZXIub24oXCJuaWNrbmFtZUNyZWF0ZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25OaWNrbmFtZUNyZWF0ZShlKTsgfSk7XHJcbiAgICAgICAgY29udHJvbGxlci5lbWl0dGVyLm9uKFwibmlja25hbWVEZXN0cm95XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk5pY2tuYW1lRGVzdHJveShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UucHJvdG90eXBlLm9uTmlja25hbWVDcmVhdGUgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgc3RvcmFnZU5pY2tuYW1lID0gdHlwZW9mIHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdID09PSAnb2JqZWN0J1xyXG4gICAgICAgICAgICA/IHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdXHJcbiAgICAgICAgICAgIDogbnVsbDtcclxuICAgICAgICBpZiAoc3RvcmFnZU5pY2tuYW1lID09PSBudWxsICYmIGUucmVtb3RlUmVmcklkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdID0gKF9hID0ge30sIF9hW2UucmVtb3RlUmVmcklkXSA9IGUudGV4dElkLCBfYSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKHN0b3JhZ2VOaWNrbmFtZSAhPT0gbnVsbCAmJiBlLnJlbW90ZVJlZnJJZCkge1xyXG4gICAgICAgICAgICBzdG9yYWdlTmlja25hbWVbZS5yZW1vdGVSZWZySWRdID0gZS50ZXh0SWQ7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdID0gc3RvcmFnZU5pY2tuYW1lO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZS5wcm90b3R5cGUub25OaWNrbmFtZURlc3Ryb3kgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBzdG9yYWdlTmlja25hbWUgPSB0eXBlb2YgdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl0gPT09ICdvYmplY3QnXHJcbiAgICAgICAgICAgID8gdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl1cclxuICAgICAgICAgICAgOiBudWxsO1xyXG4gICAgICAgIGlmIChzdG9yYWdlTmlja25hbWUgIT09IG51bGwgJiYgZS5yZW1vdGVSZWZySWQpIHtcclxuICAgICAgICAgICAgZGVsZXRlIHN0b3JhZ2VOaWNrbmFtZVtlLnJlbW90ZVJlZnJJZF07XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdID0gc3RvcmFnZU5pY2tuYW1lO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG4vLyBUT0RPOiBtb3ZlIHRvIHNlcnZpY2VcclxudmFyIHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPSAwO1xyXG52YXIgcGxheWVyTGFzdElzU3ByaW50aW5nVmFsdWUgPSBmYWxzZTtcclxudmFyIGJsb2NrUGxheWVyQ29udHJvbFRpbWVTdGFtcCA9IDA7XHJcbnZhciBpc1BsYXllckNvbnRyb2xEaXNhYmxlZCA9IHRydWU7XHJcbnZhciBwbGF5ZXJBdHRhY2tUaW1lb3V0ID0gMDtcclxudmFyIGFjdGl2ZVRpbWVycyA9IG5ldyBTZXQoKTtcclxuLy8gVE9ETzogbW92ZSB0byBjb25maWdcclxudmFyIHN0YW1pbmFBdHRhY2tNYXAgPSBuZXcgTWFwKFtcclxuICAgIFtcIlN0ZFwiLCA3XSxcclxuICAgIFtcIlBvd2VyXCIsIDM1XSxcclxuICAgIFtcIkp1bXBcIiwgMTVdLFxyXG4gICAgW1wiQm93XCIsIDI1XSxcclxuICAgIFtcIkNyb3NzYm93XCIsIDMwXSxcclxuXSk7XHJcbi8vIFRPRE86IGNvbnNpZGVyIHNwbGl0dGluZyB0aGlzIHNlcnZpY2UgKHNlcGFyYXRlIHN0YW1pbmEgYW5kIHRpbWVyIG1hbmFnZW1lbnQpXHJcbi8vIFRPRE86IHN1YnNjcmliZSBldmVudHMvaG9va3MgaW4gY29uc3RydWN0b3JcclxudmFyIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgaWYgKCFfdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZGlzYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGVuYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc2V0QXR0YWNrU3RhbWluYVJlc3RyaWN0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5yZWdpc3RlckhhbmRsZXJzSWZOZWVkZWQoKTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuc2V0QXR0YWNrU3RhbWluYVJlc3RyaWN0aW9uID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcGxheWVyID0gX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgcGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA9IHBsYXllci5nZXRBY3RvclZhbHVlKFwiU3RhbWluYVwiKTtcclxuICAgICAgICAgICAgcGxheWVyTGFzdElzU3ByaW50aW5nVmFsdWUgPSBwbGF5ZXIuaXNTcHJpbnRpbmcoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9hID0gWydTcHJpbnRTdGFydCddOyBfaSA8IF9hLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9hW19pXTtcclxuICAgICAgICAgICAgdmFyIHNwID0gdGhpcy5zcDtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0U3RhbWluYVZhbHVlIDwgNy41KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9iID0gMCwgX2MgPSBbJ2Jsb2NrU3RhcnQnXTsgX2IgPCBfYy5sZW5ndGg7IF9iKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfY1tfYl07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdElzU3ByaW50aW5nVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2QgPSAwLCBfZSA9IFsnYXR0YWNrU3RhcnQqJywgJ0F0dGFja1N0YXJ0KiddOyBfZCA8IF9lLmxlbmd0aDsgX2QrKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9lW19kXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA8ICgoX2EgPSBzdGFtaW5hQXR0YWNrTWFwLmdldChcIlN0ZFwiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2YgPSAwLCBfZyA9IFsnYXR0YWNrUG93ZXJTdGFydConLCAnQXR0YWNrUG93ZXJTdGFydConXTsgX2YgPCBfZy5sZW5ndGg7IF9mKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfZ1tfZl07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPCAoKF9hID0gc3RhbWluYUF0dGFja01hcC5nZXQoXCJQb3dlclwiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2ggPSAwLCBfaiA9IFsnSnVtcERpcmVjdGlvbmFsU3RhcnQqJywgJ0p1bXBTdGFuZGluZ1N0YXJ0KiddOyBfaCA8IF9qLmxlbmd0aDsgX2grKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9qW19oXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA8ICgoX2EgPSBzdGFtaW5hQXR0YWNrTWFwLmdldChcIkp1bXBcIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9rID0gMCwgX2wgPSBbJ2Jvd0F0dGFja1N0YXJ0KiddOyBfayA8IF9sLmxlbmd0aDsgX2srKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9sW19rXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA8ICgoX2EgPSBzdGFtaW5hQXR0YWNrTWFwLmdldChcIkJvd1wiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX20gPSAwLCBfbyA9IFsnY3Jvc3Nib3dBdHRhY2tTdGFydConXTsgX20gPCBfby5sZW5ndGg7IF9tKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfb1tfbV07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPCAoKF9hID0gc3RhbWluYUF0dGFja01hcC5nZXQoXCJDcm9zc2Jvd1wiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLnJlZ2lzdGVySGFuZGxlcnNJZk5lZWRlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSBbJ2F0dGFja1N0YXJ0KicsICdBdHRhY2tTdGFydConXTsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfYVtfaV07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uIChjdHgpIHsgcmV0dXJuIHNlbGYuYmxvY2tQbGF5ZXJBdHRhY2soY3R4LmFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnbGVmdGhhbmQnKSk7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2IgPSAwLCBfYyA9IFsnYXR0YWNrUG93ZXJTdGFydConLCAnQXR0YWNrUG93ZXJTdGFydConLCAnSnVtcConXTsgX2IgPCBfYy5sZW5ndGg7IF9iKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfY1tfYl07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBwbGF5ZXJBdHRhY2tUaW1lb3V0ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBhY3RpdmVUaW1lcnMuY2xlYXIoKTtcclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKGlzUGxheWVyQ29udHJvbERpc2FibGVkID09PSB0cnVlICYmIERhdGUubm93KCkgLSBibG9ja1BsYXllckNvbnRyb2xUaW1lU3RhbXAgPj0gcGxheWVyQXR0YWNrVGltZW91dCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKS5zZXREb250TW92ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBpc1BsYXllckNvbnRyb2xEaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmJsb2NrUGxheWVyQXR0YWNrID0gZnVuY3Rpb24gKGlzTGVmdEhhbmQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICB2YXIgcGxheWVyID0gX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgaWYgKHBsYXllci5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJiSW5KdW1wU3RhdGVcIikpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgX2IgPSBfdGhpcy5nZXRUaW1pbmdzKChfYSA9IHBsYXllci5nZXRFcXVpcHBlZFdlYXBvbihpc0xlZnRIYW5kKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldFdlYXBvblR5cGUoKSksIGRlbGF5ID0gX2JbMF0sIHRpbWVvdXQgPSBfYlsxXTtcclxuICAgICAgICAgICAgdmFyIHJuZCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgYWN0aXZlVGltZXJzLmFkZChybmQpO1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5VdGlsaXR5LndhaXQoZGVsYXkgLyAxMDAwKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmICghYWN0aXZlVGltZXJzLmRlbGV0ZShybmQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc1BsYXllckNvbnRyb2xEaXNhYmxlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYmxvY2tQbGF5ZXJDb250cm9sVGltZVN0YW1wID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpLnNldERvbnRNb3ZlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBsYXllckF0dGFja1RpbWVvdXQgPSB0aW1lb3V0O1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkgPSBmdW5jdGlvbiAoa2V5LCB3ZWFwb25UaW1pbmdzKSB7XHJcbiAgICAgICAgdmFyIHZhbHVlID0gd2VhcG9uVGltaW5nc1trZXldO1xyXG4gICAgICAgIGlmICh2YWx1ZSAmJiBBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICAgICAgdmFyIGVsZW1lbnQwID0gdmFsdWVbMF07XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudDAgIT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiSW52YWxpZCB0aW1pbmdzIGNvbmZpZyBmb3Igd2VhcG9uIHR5cGVcIiwga2V5LCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gWzAsIDBdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBlbGVtZW50MSA9IHZhbHVlWzFdO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQxICE9PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkludmFsaWQgdGltaW5ncyBjb25maWcgZm9yIHdlYXBvbiB0eXBlXCIsIGtleSwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFswLCAwXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gW2VsZW1lbnQwLCBlbGVtZW50MV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBbMCwgMF07XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmdldFNldHRpbmdzRnJvbUZpbGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJzd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZVwiXTtcclxuICAgICAgICBpZiAoIXN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlIHx8IHR5cGVvZiBzd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSAhPT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIk5vIHN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlIHNldHRpbmdzIGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHdlYXBvblRpbWluZ3MgPSBzd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS53ZWFwb25UaW1pbmdzO1xyXG4gICAgICAgIGlmICghd2VhcG9uVGltaW5ncyB8fCB0eXBlb2Ygd2VhcG9uVGltaW5ncyAhPT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIk5vIHdlYXBvblRpbWluZ3Mgc2V0dGluZ3MgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5ncztcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuZ2V0U2V0dGluZ3NEZWZhdWx0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGZpc3Q6IFswLCAzMF0sXHJcbiAgICAgICAgICAgIHN3b3JkOiBbMCwgMzBdLFxyXG4gICAgICAgICAgICBkYWdnZXI6IFswLCA2MF0sXHJcbiAgICAgICAgICAgIHdhckF4ZTogWzAsIDYwXSxcclxuICAgICAgICAgICAgbWFjZTogWzAsIDY1XSxcclxuICAgICAgICAgICAgZ3JlYXRzd29yZDogWzAsIDY1XSxcclxuICAgICAgICAgICAgLy8gTm90ZTogYm90aCBvZiBCYXR0bGVheGUgYW5kIFdhcmhhbW1lciB3ZWFwb24gdHlwZXMgY29ycmVzcG9uZCB0byBpZD02LlxyXG4gICAgICAgICAgICBiYXR0bGVheGU6IFswLCA3MF0sXHJcbiAgICAgICAgICAgIHdhcmhhbW1lcjogWzAsIDcwXSxcclxuICAgICAgICAgICAgYm93OiBbMCwgNzBdLFxyXG4gICAgICAgICAgICBzdGFmZjogWzAsIDcwXSxcclxuICAgICAgICAgICAgY3Jvc3Nib3c6IFswLCA3MF0sXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuZ2V0VGltaW5nc0Zyb21Db25maWcgPSBmdW5jdGlvbiAod2VhcG9uKSB7XHJcbiAgICAgICAgaWYgKCF3ZWFwb24pIHtcclxuICAgICAgICAgICAgd2VhcG9uID0gMCAvKiBXZWFwb25UeXBlLkZpc3QgKi87XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHNreW1wNS1jbGllbnQtc2V0dGluZ3MudHh0IGlzIHBlcmZlY3RseSBlZGl0YWJsZSBieSB1c2Vycywgc28gd2UgZG9uJ3QgdXNlIGl0IGZvciBub3cuXHJcbiAgICAgICAgLy8gSXQncyB3ZWxsLXRlc3RlZCB0aG91Z2gsIHNvIHdlIGNhbiBlbmFibGUgaXQgb25jZSB3ZSBoYXZlIGEgcHJvdGVjdGlvbiBtZWNoYW5pc20uXHJcbiAgICAgICAgLy8gY29uc3Qgd2VhcG9uVGltaW5ncyA9IHRoaXMuZ2V0U2V0dGluZ3NGcm9tRmlsZSgpO1xyXG4gICAgICAgIHZhciB3ZWFwb25UaW1pbmdzID0gdGhpcy5nZXRTZXR0aW5nc0RlZmF1bHQoKTtcclxuICAgICAgICBpZiAoIXdlYXBvblRpbWluZ3MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB3ZWFwb25UaW1pbmdzUmVzdWx0ID0ge1xyXG4gICAgICAgICAgICBmaXN0OiBbMCwgMF0sXHJcbiAgICAgICAgICAgIHN3b3JkOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIGRhZ2dlcjogWzAsIDBdLFxyXG4gICAgICAgICAgICB3YXJBeGU6IFswLCAwXSxcclxuICAgICAgICAgICAgbWFjZTogWzAsIDBdLFxyXG4gICAgICAgICAgICBncmVhdHN3b3JkOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIGJhdHRsZWF4ZTogWzAsIDBdLFxyXG4gICAgICAgICAgICB3YXJoYW1tZXI6IFswLCAwXSxcclxuICAgICAgICAgICAgYm93OiBbMCwgMF0sXHJcbiAgICAgICAgICAgIHN0YWZmOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIGNyb3NzYm93OiBbMCwgMF0sXHJcbiAgICAgICAgfTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LmZpc3QgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcImZpc3RcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5zd29yZCA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwic3dvcmRcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5kYWdnZXIgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcImRhZ2dlclwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LndhckF4ZSA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwid2FyQXhlXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQubWFjZSA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwibWFjZVwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LmdyZWF0c3dvcmQgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcImdyZWF0c3dvcmRcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5iYXR0bGVheGUgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcImJhdHRsZWF4ZVwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LndhcmhhbW1lciA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwid2FyaGFtbWVyXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuYm93ID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJib3dcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5zdGFmZiA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwic3RhZmZcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5jcm9zc2JvdyA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwiY3Jvc3Nib3dcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgc3dpdGNoICh3ZWFwb24pIHtcclxuICAgICAgICAgICAgY2FzZSAwIC8qIFdlYXBvblR5cGUuRmlzdCAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LmZpc3Q7XHJcbiAgICAgICAgICAgIGNhc2UgMSAvKiBXZWFwb25UeXBlLlN3b3JkICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuc3dvcmQ7XHJcbiAgICAgICAgICAgIGNhc2UgMiAvKiBXZWFwb25UeXBlLkRhZ2dlciAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LmRhZ2dlcjtcclxuICAgICAgICAgICAgY2FzZSAzIC8qIFdlYXBvblR5cGUuV2FyQXhlICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQud2FyQXhlO1xyXG4gICAgICAgICAgICBjYXNlIDQgLyogV2VhcG9uVHlwZS5NYWNlICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQubWFjZTtcclxuICAgICAgICAgICAgY2FzZSA1IC8qIFdlYXBvblR5cGUuR3JlYXRzd29yZCAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LmdyZWF0c3dvcmQ7XHJcbiAgICAgICAgICAgIGNhc2UgNiAvKiBXZWFwb25UeXBlLkJhdHRsZWF4ZSAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LmJhdHRsZWF4ZTtcclxuICAgICAgICAgICAgY2FzZSA2IC8qIFdlYXBvblR5cGUuV2FyaGFtbWVyICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQud2FyaGFtbWVyO1xyXG4gICAgICAgICAgICBjYXNlIDcgLyogV2VhcG9uVHlwZS5Cb3cgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5ib3c7XHJcbiAgICAgICAgICAgIGNhc2UgOCAvKiBXZWFwb25UeXBlLlN0YWZmICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuc3RhZmY7XHJcbiAgICAgICAgICAgIGNhc2UgOSAvKiBXZWFwb25UeXBlLkNyb3NzYm93ICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuY3Jvc3Nib3c7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIk5vIHRpbWluZ3MgZm91bmQgZm9yIHdlYXBvbiB0eXBlXCIsIHdlYXBvbik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmdldFRpbWluZ3MgPSBmdW5jdGlvbiAod2VhcG9uKSB7XHJcbiAgICAgICAgdmFyIHRpbWluZ3NGcm9tQ29uZmlnID0gdGhpcy5nZXRUaW1pbmdzRnJvbUNvbmZpZyh3ZWFwb24pO1xyXG4gICAgICAgIGlmICghd2VhcG9uIHx8ICF0aW1pbmdzRnJvbUNvbmZpZykge1xyXG4gICAgICAgICAgICB3ZWFwb24gPSAwIC8qIFdlYXBvblR5cGUuRmlzdCAqLztcclxuICAgICAgICAgICAgdGltaW5nc0Zyb21Db25maWcgPSB0aGlzLmdldFRpbWluZ3NGcm9tQ29uZmlnKHdlYXBvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGltaW5nc0Zyb21Db25maWcpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJObyB0aW1pbmdzIGZvdW5kIGZvciB3ZWFwb24gdHlwZVwiLCB3ZWFwb24pO1xyXG4gICAgICAgICAgICByZXR1cm4gWzAsIDBdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGltaW5nc0Zyb21Db25maWc7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmhhc1N3ZWV0UGllID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtb2RDb3VudCA9IHRoaXMuc3AuR2FtZS5nZXRNb2RDb3VudCgpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kQ291bnQ7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5HYW1lLmdldE1vZE5hbWUoaSkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3dlZXRwaWUnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgYnJvd3NlciB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tICcuL2NsaWVudExpc3RlbmVyJztcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tICcuLi8uLi9sb2dnaW5nJztcclxuLy8gVE9ETzogbW92ZSB0byBzZXJ2ZXIvZ2FtZW1vZGVcclxudmFyIFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuYWx0YXJzID0gW1xyXG4gICAgICAgICAgICAweDAwMTAwNzgwLCAweDAwMEQ5ODgzLCAweDAwMEQ5ODdCLCAweDAwMEQ5ODgxLCAweDAwMEQ5ODg3LCAweDAwMEZCOTk3LFxyXG4gICAgICAgICAgICAweDAwMEQ5ODg1LCAweDAwMEQ5ODdELCAweDAwMDcxODU0LCAweDA3MTg3NTAwLCAweDAyMDBjODZiLCAweDAwMGQ5ODdmLFxyXG4gICAgICAgICAgICAweDA3MDU4ZDRlLCAweDA3MDU4ZDUzLCAweDA3MEE2OTEyLCAweDA3MDU4ZDUxLCAweDA3MDU4ZDUwLCAweDA3MDU4ZDRmLFxyXG4gICAgICAgICAgICAweDA3MDU4ZDRkLCAweDA3MDU4ZDRjLCAweDA3MDU4ZDRiLCAweDA3MDVlMmZhLCAweDA3MDU4ZDRhLCAweDA3MDU4ZDQ5LFxyXG4gICAgICAgICAgICAweDA3MDVlMzY3LCAweDA3MDU4ZDQ4LCAweDA3MDU4ZDU1LCAweDA3MDU4ZDQ2LCAweDA3MDU4ZDQ3LCAweDA3MDVlMmIwLFxyXG4gICAgICAgICAgICAweDA3MDU4ZDQ1XHJcbiAgICAgICAgXTtcclxuICAgICAgICBpZiAoIV90aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBkaXNhYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZW5hYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwiYWN0aXZhdGVcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQWN0aXZhdGUoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlLnByb3RvdHlwZS5vbkFjdGl2YXRlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLmFsdGFycy5pbmNsdWRlcygoKF9hID0gZXZlbnQudGFyZ2V0LmdldEJhc2VPYmplY3QoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZvcm1JRCgpKSB8fCAtMSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBicm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICAgICAgdmFyIHNyYyA9IFwid2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdpbml0U2tpbGxNZW51JykpXCI7XHJcbiAgICAgICAgYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChzcmMpO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlLnByb3RvdHlwZS5oYXNTd2VldFBpZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbW9kQ291bnQgPSB0aGlzLnNwLkdhbWUuZ2V0TW9kQ291bnQoKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZENvdW50OyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuR2FtZS5nZXRNb2ROYW1lKGkpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3N3ZWV0cGllJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gY29uZmlnXHJcbiAgICAgICAgX3RoaXMuc3RlYWx0aCA9IFsweEJFMTI2LCAweEMwN0M2LCAweEMwN0M3LCAweEMwN0M4LCAweEMwN0M5XTtcclxuICAgICAgICBfdGhpcy5tYWdpYyA9IFsweDU4MjEzLCAweDEwNUYyNCwgMHg1ODIxNF07XHJcbiAgICAgICAgX3RoaXMud2FycmlvciA9IFsweENCNDBELCAweENCNDBGLCAweENCNDE0LCAweENCNDExLCAweENCNDEyLCAweENCNDEwLCAweENCNDBFXTtcclxuICAgICAgICBpZiAoIV90aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBkaXNhYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZW5hYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuYWRkU3RhdGljUGVya3NUb1RoZVBsYXllcigpO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLmFkZFN0YXRpY1BlcmtzVG9UaGVQbGF5ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgcGxheWVyID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIHZhciBhbGxTdGF0aWNQZXJrSWRzID0gdGhpcy5zdGVhbHRoLmNvbmNhdCh0aGlzLm1hZ2ljKS5jb25jYXQodGhpcy53YXJyaW9yKTtcclxuICAgICAgICBhbGxTdGF0aWNQZXJrSWRzLmZvckVhY2goZnVuY3Rpb24gKHBlcmtJZCkge1xyXG4gICAgICAgICAgICBwbGF5ZXIuYWRkUGVyayhfdGhpcy5zcC5QZXJrLmZyb20oX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgocGVya0lkKSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLmhhc1N3ZWV0UGllID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtb2RDb3VudCA9IHRoaXMuc3AuR2FtZS5nZXRNb2RDb3VudCgpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kQ291bnQ7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5HYW1lLmdldE1vZE5hbWUoaSkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3dlZXRwaWUnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuLy8gVE9ETzogbW92ZSB0byB0aGUgc2VydmVyL2dhbWVtb2RlXHJcbnZhciBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNhbnREcm9wS2V5d29yZCA9IFwiU3dlZXRDYW50RHJvcFwiO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZS5wcm90b3R5cGUuY2FuRHJvcE9yUHV0SXRlbSA9IGZ1bmN0aW9uIChpdGVtSWQpIHtcclxuICAgICAgICB2YXIgaXRlbSA9IHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoaXRlbUlkKTtcclxuICAgICAgICBpZiAoaXRlbSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBpZiAoaXRlbS5oYXNLZXl3b3JkKHRoaXMuc3AuS2V5d29yZC5nZXRLZXl3b3JkKHRoaXMuY2FudERyb3BLZXl3b3JkKSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgVGltZVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoVGltZVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBUaW1lU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5sYXN0VGltZVVwZCA9IDA7XHJcbiAgICAgICAgY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBUaW1lU2VydmljZS5wcm90b3R5cGUuZ2V0VGltZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgaG91cnNPZmZzZXRTZXR0aW5nID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJob3Vyc09mZnNldFwiXTtcclxuICAgICAgICB2YXIgaG91cnNPZmZzZXQgPSB0eXBlb2YgaG91cnNPZmZzZXRTZXR0aW5nID09PSBcIm51bWJlclwiID8gaG91cnNPZmZzZXRTZXR0aW5nIDogMDtcclxuICAgICAgICB2YXIgaG91cnNPZmZzZXRNcyA9IGhvdXJzT2Zmc2V0ICogNjAgKiA2MCAqIDEwMDA7XHJcbiAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgaG91cnNPZmZzZXRNcyk7XHJcbiAgICAgICAgdmFyIG5ld0dhbWVIb3VyVmFsdWUgPSAwO1xyXG4gICAgICAgIG5ld0dhbWVIb3VyVmFsdWUgKz0gZC5nZXRVVENIb3VycygpO1xyXG4gICAgICAgIG5ld0dhbWVIb3VyVmFsdWUgKz0gZC5nZXRVVENNaW51dGVzKCkgLyA2MDtcclxuICAgICAgICBuZXdHYW1lSG91clZhbHVlICs9IGQuZ2V0VVRDU2Vjb25kcygpIC8gNjAgLyA2MDtcclxuICAgICAgICBuZXdHYW1lSG91clZhbHVlICs9IGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCkgLyA2MCAvIDYwIC8gMTAwMDtcclxuICAgICAgICByZXR1cm4geyBuZXdHYW1lSG91clZhbHVlOiBuZXdHYW1lSG91clZhbHVlLCBkYXRlOiBkIH07XHJcbiAgICB9O1xyXG4gICAgVGltZVNlcnZpY2UucHJvdG90eXBlLmV2ZXJ5MnNlY29uZHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGdhbWVIb3VySWQgPSAweDM4O1xyXG4gICAgICAgIHZhciBnYW1lTW9udGhJZCA9IDB4MzY7XHJcbiAgICAgICAgdmFyIGdhbWVEYXlJZCA9IDB4Mzc7XHJcbiAgICAgICAgdmFyIGdhbWVZZWFySWQgPSAweDM1O1xyXG4gICAgICAgIHZhciB0aW1lU2NhbGVJZCA9IDB4M2E7XHJcbiAgICAgICAgdmFyIGdhbWVIb3VyID0gdGhpcy5zcC5HbG9iYWxWYXJpYWJsZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZ2FtZUhvdXJJZCkpO1xyXG4gICAgICAgIHZhciBnYW1lRGF5ID0gdGhpcy5zcC5HbG9iYWxWYXJpYWJsZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZ2FtZURheUlkKSk7XHJcbiAgICAgICAgdmFyIGdhbWVNb250aCA9IHRoaXMuc3AuR2xvYmFsVmFyaWFibGUuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGdhbWVNb250aElkKSk7XHJcbiAgICAgICAgdmFyIGdhbWVZZWFyID0gdGhpcy5zcC5HbG9iYWxWYXJpYWJsZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZ2FtZVllYXJJZCkpO1xyXG4gICAgICAgIHZhciB0aW1lU2NhbGUgPSB0aGlzLnNwLkdsb2JhbFZhcmlhYmxlLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeCh0aW1lU2NhbGVJZCkpO1xyXG4gICAgICAgIGlmICghZ2FtZUhvdXIgfHwgIWdhbWVEYXkgfHwgIWdhbWVNb250aCB8fCAhZ2FtZVllYXIgfHwgIXRpbWVTY2FsZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBfYSA9IHRoaXMuZ2V0VGltZSgpLCBuZXdHYW1lSG91clZhbHVlID0gX2EubmV3R2FtZUhvdXJWYWx1ZSwgZGF0ZSA9IF9hLmRhdGU7XHJcbiAgICAgICAgdmFyIGRpZmYgPSBNYXRoLmFicyhnYW1lSG91ci5nZXRWYWx1ZSgpIC0gbmV3R2FtZUhvdXJWYWx1ZSk7XHJcbiAgICAgICAgaWYgKGRpZmYgPj0gMSAvIDYwKSB7XHJcbiAgICAgICAgICAgIGdhbWVIb3VyLnNldFZhbHVlKG5ld0dhbWVIb3VyVmFsdWUpO1xyXG4gICAgICAgICAgICBnYW1lRGF5LnNldFZhbHVlKGRhdGUuZ2V0VVRDRGF0ZSgpKTtcclxuICAgICAgICAgICAgZ2FtZU1vbnRoLnNldFZhbHVlKGRhdGUuZ2V0VVRDTW9udGgoKSk7XHJcbiAgICAgICAgICAgIGdhbWVZZWFyLnNldFZhbHVlKGRhdGUuZ2V0VVRDRnVsbFllYXIoKSAtIDIwMjAgKyAxOTkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aW1lU2NhbGUuc2V0VmFsdWUoZ2FtZUhvdXIuZ2V0VmFsdWUoKSA+IG5ld0dhbWVIb3VyVmFsdWUgPyAwLjYgOiAxLjIpO1xyXG4gICAgfTtcclxuICAgIFRpbWVTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMubGFzdFRpbWVVcGQgPD0gMjAwMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubGFzdFRpbWVVcGQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRoaXMuZXZlcnkyc2Vjb25kcygpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBUaW1lU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBUaW1lU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgUHJvY2Vzc01ldGhvZFR5cGU7XHJcbihmdW5jdGlvbiAoUHJvY2Vzc01ldGhvZFR5cGUpIHtcclxuICAgIFByb2Nlc3NNZXRob2RUeXBlW1widXBkYXRlXCJdID0gXCJ1cGRhdGVcIjtcclxuICAgIFByb2Nlc3NNZXRob2RUeXBlW1widGlja1wiXSA9IFwidGlja1wiO1xyXG59KShQcm9jZXNzTWV0aG9kVHlwZSB8fCAoUHJvY2Vzc01ldGhvZFR5cGUgPSB7fSkpO1xyXG52YXIgVGltZXJzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhUaW1lcnNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gVGltZXJzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy50aW1lcnNBcnIgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICBfdGhpcy5pbnRlcnZhbHNBcnIgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICBfdGhpcy5sYXN0Q2FsbFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIF90aGlzLnByb2Nlc3NNZXRob2RUeXBlU3RvcmFnZUtleSA9IFwidXBkYXRlVHlwZVN0b3JhZ2VLZXlcIjtcclxuICAgICAgICB2YXIgc3RvcmFnZVByb2Nlc3NNZXRob2QgPSBzcC5zdG9yYWdlW190aGlzLnByb2Nlc3NNZXRob2RUeXBlU3RvcmFnZUtleV07XHJcbiAgICAgICAgaWYgKHR5cGVvZiBzdG9yYWdlUHJvY2Vzc01ldGhvZCAhPT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnNldFByb2Nlc3NNZXRob2Qoc3RvcmFnZVByb2Nlc3NNZXRob2QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgX3RoaXMuc2V0UHJvY2Vzc01ldGhvZChQcm9jZXNzTWV0aG9kVHlwZS50aWNrKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcIm1lbnVPcGVuXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk1lbnVPcGVuKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwicHJlTG9hZEdhbWVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25QcmVMb2FkR2FtZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5zZXRUaW1lb3V0ID0gZnVuY3Rpb24gKGhhbmRsZXIsIHRpbWVvdXQpIHtcclxuICAgICAgICB2YXIgYXJncyA9IFtdO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMjsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIGFyZ3NbX2kgLSAyXSA9IGFyZ3VtZW50c1tfaV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0aW1lciA9IHsgaGFuZGxlcjogaGFuZGxlciwgYXJnczogYXJncywgZGVsYXlNczogdGltZW91dCAhPT0gbnVsbCAmJiB0aW1lb3V0ICE9PSB2b2lkIDAgPyB0aW1lb3V0IDogMCwgcGFzc2VkTXM6IDAgfTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudGltZXJzQXJyLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy50aW1lcnNBcnJbaV0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGltZXJzQXJyW2ldID0gdGltZXI7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaSArIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudGltZXJzQXJyLnB1c2godGltZXIpO1xyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLmNsZWFyVGltZW91dCA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgIGlmIChpZCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMudGltZXJzQXJyID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlkIDw9IDAgfHwgaWQgPiB0aGlzLnRpbWVyc0Fyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnRpbWVyc0FycltpZCAtIDFdID0gbnVsbDtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUuc2V0SW50ZXJ2YWwgPSBmdW5jdGlvbiAoaGFuZGxlciwgdGltZW91dCkge1xyXG4gICAgICAgIHZhciBhcmdzID0gW107XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAyOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgYXJnc1tfaSAtIDJdID0gYXJndW1lbnRzW19pXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRpbWVyID0geyBoYW5kbGVyOiBoYW5kbGVyLCBhcmdzOiBhcmdzLCBkZWxheU1zOiB0aW1lb3V0ICE9PSBudWxsICYmIHRpbWVvdXQgIT09IHZvaWQgMCA/IHRpbWVvdXQgOiAwLCBwYXNzZWRNczogMCB9O1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5pbnRlcnZhbHNBcnIubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmludGVydmFsc0FycltpXSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcnZhbHNBcnJbaV0gPSB0aW1lcjtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpICsgMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5pbnRlcnZhbHNBcnIucHVzaCh0aW1lcik7XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUuY2xlYXJJbnRlcnZhbCA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgIGlmIChpZCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW50ZXJ2YWxzQXJyID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlkIDw9IDAgfHwgaWQgPiB0aGlzLmludGVydmFsc0Fyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmludGVydmFsc0FycltpZCAtIDFdID0gbnVsbDtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUuc2V0UHJvY2Vzc01ldGhvZCA9IGZ1bmN0aW9uIChtZXRob2QpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHN3aXRjaCAobWV0aG9kKSB7XHJcbiAgICAgICAgICAgIGNhc2UgUHJvY2Vzc01ldGhvZFR5cGUudGljazpcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVt0aGlzLnByb2Nlc3NNZXRob2RUeXBlU3RvcmFnZUtleV0gPSBQcm9jZXNzTWV0aG9kVHlwZS50aWNrO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVFdmVudEhhbmRsZSA9IHRoaXMuY29udHJvbGxlci5vbihQcm9jZXNzTWV0aG9kVHlwZS50aWNrLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5wcm9jZXNzVGltZXJzKCk7IH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICBjYXNlIFByb2Nlc3NNZXRob2RUeXBlLnVwZGF0ZTpcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVt0aGlzLnByb2Nlc3NNZXRob2RUeXBlU3RvcmFnZUtleV0gPSBQcm9jZXNzTWV0aG9kVHlwZS51cGRhdGU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUV2ZW50SGFuZGxlID0gdGhpcy5jb250cm9sbGVyLm9uKFByb2Nlc3NNZXRob2RUeXBlLnVwZGF0ZSwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMucHJvY2Vzc1RpbWVycygpOyB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5HYW1lLmdldFBsYXllcigpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBGSVhNRShHTS0xMDA4KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvY2Vzc01ldGhvZChQcm9jZXNzTWV0aG9kVHlwZS51cGRhdGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoX2EpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRQcm9jZXNzTWV0aG9kKFByb2Nlc3NNZXRob2RUeXBlLnRpY2spO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5wcm9jZXNzVGltZXJzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBkdCA9IERhdGUubm93KCkgLSB0aGlzLmxhc3RDYWxsVGltZTtcclxuICAgICAgICB0aGlzLmxhc3RDYWxsVGltZSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgLy8gcHJvY2VzcyB0aW1lcnNcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudGltZXJzQXJyLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciB0aW1lciA9IHRoaXMudGltZXJzQXJyW2ldO1xyXG4gICAgICAgICAgICBpZiAodGltZXIpIHtcclxuICAgICAgICAgICAgICAgIHRpbWVyLnBhc3NlZE1zICs9IGR0O1xyXG4gICAgICAgICAgICAgICAgaWYgKHRpbWVyLnBhc3NlZE1zID49IHRpbWVyLmRlbGF5TXMpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVyc0FycltpXSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aW1lci5oYW5kbGVyID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXIuaGFuZGxlci5jYWxsKHRoaXMsIHRpbWVyLmFyZ3MpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZhbCh0aW1lci5oYW5kbGVyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoaSA9PT0gdGhpcy50aW1lcnNBcnIubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGxhc3QgdW51c2VkIGVsZW1lbnRcclxuICAgICAgICAgICAgICAgIHRoaXMudGltZXJzQXJyLmxlbmd0aCAtPSAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHByb2Nlc3MgaW50ZXJ2YWxzXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmludGVydmFsc0Fyci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICB2YXIgaW50ZXJ2YWwgPSB0aGlzLmludGVydmFsc0FycltpXTtcclxuICAgICAgICAgICAgaWYgKGludGVydmFsKSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcnZhbC5wYXNzZWRNcyArPSBkdDtcclxuICAgICAgICAgICAgICAgIGlmIChpbnRlcnZhbC5wYXNzZWRNcyA+PSBpbnRlcnZhbC5kZWxheU1zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwucGFzc2VkTXMgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW50ZXJ2YWwuaGFuZGxlciA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVydmFsLmhhbmRsZXIuY2FsbCh0aGlzLCBpbnRlcnZhbC5hcmdzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2YWwoaW50ZXJ2YWwuaGFuZGxlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGkgPT09IHRoaXMuaW50ZXJ2YWxzQXJyLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBsYXN0IHVudXNlZCBlbGVtZW50XHJcbiAgICAgICAgICAgICAgICB0aGlzLmludGVydmFsc0Fyci5sZW5ndGggLT0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5vbk1lbnVPcGVuID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoZS5uYW1lID09PSBcIk1haW4gTWVudVwiIC8qIE1lbnUuTWFpbiAqLykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy51cGRhdGVFdmVudEhhbmRsZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC51bnN1YnNjcmliZSh0aGlzLnVwZGF0ZUV2ZW50SGFuZGxlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldFByb2Nlc3NNZXRob2QoUHJvY2Vzc01ldGhvZFR5cGUudGljayk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLm9uUHJlTG9hZEdhbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudXBkYXRlRXZlbnRIYW5kbGUpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC51bnN1YnNjcmliZSh0aGlzLnVwZGF0ZUV2ZW50SGFuZGxlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXRQcm9jZXNzTWV0aG9kKFByb2Nlc3NNZXRob2RUeXBlLnVwZGF0ZSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFRpbWVyc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgVGltZXJzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi9yZW1vdGVTZXJ2ZXJcIjtcclxudmFyIFZvaWNlQ2hhdFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoVm9pY2VDaGF0U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFZvaWNlQ2hhdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuaXNJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmlzVGFsa2luZyA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLnB1c2hUb1RhbGtLZXkgPSAweDU2OyAvLyBWIGtleVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVGljaygpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLm9uQ29ubmVjdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBWb2ljZSBjaGF0IGluaXRpYWxpemF0aW9uIGhhbmRsZWQgZWxzZXdoZXJlIGZvciBub3dcclxuICAgICAgICBsb2dUcmFjZShcIlZvaWNlQ2hhdFNlcnZpY2U6IENvbm5lY3RlZFwiKTtcclxuICAgIH07XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5vbkRpc2Nvbm5lY3QgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNUYWxraW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcFRhbGtpbmcoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUub25UaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5pc0luaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQ2hlY2sgcHVzaC10by10YWxrIGtleSBzdGF0ZVxyXG4gICAgICAgIHZhciBrZXlQcmVzc2VkID0gdGhpcy5zcC5JbnB1dC5pc0tleVByZXNzZWQodGhpcy5wdXNoVG9UYWxrS2V5KTtcclxuICAgICAgICBpZiAoa2V5UHJlc3NlZCAmJiAhdGhpcy5pc1RhbGtpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5zdGFydFRhbGtpbmcoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoIWtleVByZXNzZWQgJiYgdGhpcy5pc1RhbGtpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5zdG9wVGFsa2luZygpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBIYW5kbGUgY29udGludW91cyB2b2ljZSBjaGF0IHVwZGF0ZXMgaWYgbmVlZGVkXHJcbiAgICB9O1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUuc3RhcnRUYWxraW5nID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNUYWxraW5nID0gdHJ1ZTtcclxuICAgICAgICAgICAgbG9nVHJhY2UoXCJWb2ljZUNoYXRTZXJ2aWNlOiBTdGFydGVkIHRhbGtpbmdcIik7XHJcbiAgICAgICAgICAgIC8vIEFjdHVhbCB2b2ljZSBjYXB0dXJlIGhhbmRsZWQgYnkgdW5kZXJseWluZyBzeXN0ZW1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKFwiVm9pY2VDaGF0U2VydmljZTogRmFpbGVkIHRvIHN0YXJ0IHRhbGtpbmc6IFwiLmNvbmNhdChlcnJvcikpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5zdG9wVGFsa2luZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmlzVGFsa2luZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICBsb2dUcmFjZShcIlZvaWNlQ2hhdFNlcnZpY2U6IFN0b3BwZWQgdGFsa2luZ1wiKTtcclxuICAgICAgICAgICAgLy8gQWN0dWFsIHZvaWNlIGNhcHR1cmUgc3RvcHBpbmcgaGFuZGxlZCBieSB1bmRlcmx5aW5nIHN5c3RlbVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IoXCJWb2ljZUNoYXRTZXJ2aWNlOiBGYWlsZWQgdG8gc3RvcCB0YWxraW5nOiBcIi5jb25jYXQoZXJyb3IpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy8gSGFuZGxlIGluY29taW5nIHZvaWNlIGNoYXQgZGF0YSBmcm9tIG90aGVyIHBsYXllcnNcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLm9uUmVjZWl2ZVZvaWNlRGF0YSA9IGZ1bmN0aW9uIChzcGVha2VySWQsIGF1ZGlvRGF0YSwgeCwgeSwgeikge1xyXG4gICAgICAgIGlmICghdGhpcy5pc0luaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gVm9pY2UgcGxheWJhY2sgaGFuZGxlZCBieSB1bmRlcmx5aW5nIHN5c3RlbVxyXG4gICAgICAgICAgICBsb2dUcmFjZShcIlZvaWNlQ2hhdFNlcnZpY2U6IFJlY2VpdmVkIHZvaWNlIGRhdGEgZnJvbSBcIi5jb25jYXQoc3BlYWtlcklkLCBcIiBhdCAoXCIpLmNvbmNhdCh4LCBcIiwgXCIpLmNvbmNhdCh5LCBcIiwgXCIpLmNvbmNhdCh6LCBcIilcIikpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IoXCJWb2ljZUNoYXRTZXJ2aWNlOiBGYWlsZWQgdG8gcHJvY2VzcyB2b2ljZSBkYXRhOiBcIi5jb25jYXQoZXJyb3IpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy8gSGFuZGxlIGJpbmFyeSB2b2ljZSBwYWNrZXRzIHJlY2VpdmVkIGZyb20gdGhlIHNlcnZlclxyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUub25QYWNrZXQgPSBmdW5jdGlvbiAodHlwZSwgcmF3Q29udGVudCwgZXJyb3IpIHtcclxuICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IoXCJWb2ljZUNoYXRTZXJ2aWNlOiBQYWNrZXQgZXJyb3I6IFwiLmNvbmNhdChlcnJvcikpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghcmF3Q29udGVudCB8fCByYXdDb250ZW50LmJ5dGVMZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgYmluYXJ5IHZvaWNlIHBhY2tldFxyXG4gICAgICAgIHZhciBkYXRhID0gbmV3IFVpbnQ4QXJyYXkocmF3Q29udGVudCk7XHJcbiAgICAgICAgaWYgKGRhdGFbMF0gPT09IDEzNSkgeyAvLyBCaW5hcnlWb2ljZVBhY2tldElkXHJcbiAgICAgICAgICAgIGlmIChyYXdDb250ZW50LmJ5dGVMZW5ndGggPj0gOSkge1xyXG4gICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBzcGVha2VyIElEICg0IGJ5dGVzKVxyXG4gICAgICAgICAgICAgICAgdmFyIHNwZWFrZXJJZEJ5dGVzID0gZGF0YS5zbGljZSgxLCA1KTtcclxuICAgICAgICAgICAgICAgIHZhciBzcGVha2VySWRfMSA9IG5ldyBEYXRhVmlldyhzcGVha2VySWRCeXRlcy5idWZmZXIpLmdldFVpbnQzMigwLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIC8vIEV4dHJhY3QgZGF0YSBzaXplICg0IGJ5dGVzKVxyXG4gICAgICAgICAgICAgICAgdmFyIGRhdGFTaXplQnl0ZXMgPSBkYXRhLnNsaWNlKDUsIDkpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRhdGFTaXplID0gbmV3IERhdGFWaWV3KGRhdGFTaXplQnl0ZXMuYnVmZmVyKS5nZXRVaW50MzIoMCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmF3Q29udGVudC5ieXRlTGVuZ3RoID09PSA5ICsgZGF0YVNpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYWN0IGF1ZGlvIGRhdGFcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYXVkaW9EYXRhID0gZGF0YS5zbGljZSg5KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBHZXQgc3BlYWtlciBwb3NpdGlvbiBmcm9tIHdvcmxkIG1vZGVsXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW90ZVNlcnZlciA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSZW1vdGVTZXJ2ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB3b3JsZE1vZGVsID0gcmVtb3RlU2VydmVyLmdldFdvcmxkTW9kZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IDAsIHkgPSAwLCB6ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIHRoZSBzcGVha2VyIGluIHRoZSB3b3JsZCBtb2RlbCB0byBnZXQgcG9zaXRpb25cclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3BlYWtlckZvcm0gPSB3b3JsZE1vZGVsLmZvcm1zLmZpbmQoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIGYgJiYgZi5yZWZySWQgPT09IHNwZWFrZXJJZF8xOyB9KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3BlYWtlckZvcm0gJiYgc3BlYWtlckZvcm0ubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeCA9IHNwZWFrZXJGb3JtLm1vdmVtZW50LnBvc1swXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeSA9IHNwZWFrZXJGb3JtLm1vdmVtZW50LnBvc1sxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeiA9IHNwZWFrZXJGb3JtLm1vdmVtZW50LnBvc1syXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblJlY2VpdmVWb2ljZURhdGEoc3BlYWtlcklkXzEsIGF1ZGlvRGF0YS5idWZmZXIsIHgsIHksIHopO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8vIEdldCBjdXJyZW50IHB1c2gtdG8tdGFsayBrZXlcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLmdldFB1c2hUb1RhbGtLZXkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHVzaFRvVGFsa0tleTtcclxuICAgIH07XHJcbiAgICAvLyBTZXQgcHVzaC10by10YWxrIGtleVxyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUuc2V0UHVzaFRvVGFsa0tleSA9IGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICBpZiAodGhpcy5pc1RhbGtpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5zdG9wVGFsa2luZygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnB1c2hUb1RhbGtLZXkgPSBrZXk7XHJcbiAgICB9O1xyXG4gICAgLy8gQ2hlY2sgaWYgY3VycmVudGx5IHRhbGtpbmdcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLmdldElzVGFsa2luZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pc1RhbGtpbmc7XHJcbiAgICB9O1xyXG4gICAgLy8gQ2hlY2sgaWYgdm9pY2UgY2hhdCBpcyBpbml0aWFsaXplZFxyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUuZ2V0SXNJbml0aWFsaXplZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pc0luaXRpYWxpemVkO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBWb2ljZUNoYXRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFZvaWNlQ2hhdFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tIFwiLi4vLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeFwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBXb3JsZENsZWFuZXJTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFdvcmxkQ2xlYW5lclNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBXb3JsZENsZWFuZXJTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnByb3RlY3Rpb24gPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJnYW1lTG9hZFwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbkdhbWVMb2FkKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFdvcmxkQ2xlYW5lclNlcnZpY2UucHJvdG90eXBlLm1vZFdjUHJvdGVjdGlvbiA9IGZ1bmN0aW9uIChhY3RvcklkLCBtb2QpIHtcclxuICAgICAgICB2YXIgY3VycmVudFByb3RlY3Rpb24gPSB0aGlzLnByb3RlY3Rpb24uZ2V0KGFjdG9ySWQpO1xyXG4gICAgICAgIHRoaXMucHJvdGVjdGlvbi5zZXQoYWN0b3JJZCwgY3VycmVudFByb3RlY3Rpb24gPyBjdXJyZW50UHJvdGVjdGlvbiArIG1vZCA6IG1vZCk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRDbGVhbmVyU2VydmljZS5wcm90b3R5cGUuZ2V0V2NQcm90ZWN0aW9uID0gZnVuY3Rpb24gKGFjdG9ySWQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wcm90ZWN0aW9uLmdldChhY3RvcklkKSB8fCAwO1xyXG4gICAgfTtcclxuICAgIFdvcmxkQ2xlYW5lclNlcnZpY2UucHJvdG90eXBlLm9uR2FtZUxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHBsYXllciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBpZiAoIXBsYXllcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5pdGlhbFBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhwbGF5ZXIpO1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbENlbGxPcldvcmxkID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwocGxheWVyKTtcclxuICAgIH07XHJcbiAgICBXb3JsZENsZWFuZXJTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnByb2Nlc3NPbmVBY3RvcigpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkQ2xlYW5lclNlcnZpY2UucHJvdG90eXBlLnByb2Nlc3NPbmVBY3RvciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgcGMgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgaWYgKHBjID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFjdG9yID0gdGhpcy5zcC5HYW1lLmZpbmRSYW5kb21BY3RvcihwYy5nZXRQb3NpdGlvblgoKSwgcGMuZ2V0UG9zaXRpb25ZKCksIHBjLmdldFBvc2l0aW9uWigpLCA4MTkyKTtcclxuICAgICAgICBpZiAoYWN0b3IgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYWN0b3JJZCA9IGFjdG9yLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIHZhciBjdXJyZW50UHJvdGVjdGlvbiA9IHRoaXMucHJvdGVjdGlvbi5nZXQoYWN0b3JJZCkgfHwgMDtcclxuICAgICAgICBpZiAoY3VycmVudFByb3RlY3Rpb24gPiAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFjdG9ySWQgPT09IDB4MTQgfHwgYWN0b3IuaXNEaXNhYmxlZCgpIHx8IGFjdG9yLmlzRGVsZXRlZCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuaXNBY3RvckluRGlhbG9ndWUoYWN0b3IpKSB7XHJcbiAgICAgICAgICAgIC8vIERlbGV0aW5nIGFjdG9yIGluIGRpYWxvZ3VlIGNyYXNoZXMgU2t5cmltXHJcbiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9za3lyaW0tbXVsdGlwbGF5ZXIvaXNzdWUtdHJhY2tlci9pc3N1ZXMvMTNcclxuICAgICAgICAgICAgYWN0b3Iuc2V0UG9zaXRpb24oMCwgMCwgMCk7XHJcbiAgICAgICAgICAgIGFjdG9yLmRpc2FibGVOb1dhaXQodHJ1ZSk7IC8vIFNlZW1zIHRvIG5vdCBjcmFzaFxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEtlZXAgdmFuaWxhIHByZS1wbGFjZWQgYm9kaWVzLCBidXQgZGVsZXRlIHBsYXllciBib2RpZXNcclxuICAgICAgICBpZiAoYWN0b3IuaXNEZWFkKCkgJiYgYWN0b3JJZCA8IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgYWN0b3IuYmxvY2tBY3RpdmF0aW9uKHRydWUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MoYWN0b3IpO1xyXG4gICAgICAgIHZhciBjZWxsT3JXb3JsZCA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsKGFjdG9yKTtcclxuICAgICAgICB2YXIgY2hpY2tlblJhY2UgPSAweGE5MTlkO1xyXG4gICAgICAgIC8vIFdlIGRpc2NvdmVyZWQgYW5vbWFseSBjaGlja2VucyB0aGF0IGZhaWwgdG8gRGlzYWJsZSBpZiB3ZSBsb2FkIGdhbWUgbmVhciB0byB0aGVtXHJcbiAgICAgICAgLy8gUmVmczogMTA2QzIyLCAxMDZDMjNcclxuICAgICAgICBpZiAoYWN0b3JJZCA8IDB4ZmYwMDAwMDAgJiYgKChfYSA9IGFjdG9yLmdldFJhY2UoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZvcm1JRCgpKSA9PT0gY2hpY2tlblJhY2UpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdGlhbFBvcyAmJiBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZU5vWihwb3MsIHRoaXMuaW5pdGlhbFBvcykgPCA0MDk2KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbE9yV29ybGQgPT09IHRoaXMuaW5pdGlhbENlbGxPcldvcmxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNBY3RvckluRGlhbG9ndWUoYWN0b3IpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJEZWxldGluZyBjaGlja2VuIGFub21hbHlcIiwgYWN0b3JJZC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdG9yLmtpbGxTaWxlbnQobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0b3IuYmxvY2tBY3RpdmF0aW9uKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdG9yLmRpc2FibGVOb1dhaXQoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdG9yLnNldEFscGhhKDAsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgYWN0b3IuZGlzYWJsZShmYWxzZSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IF90aGlzLnNwLkFjdG9yLmZyb20oX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgoYWN0b3JJZCkpO1xyXG4gICAgICAgICAgICBpZiAoIWFjIHx8IF90aGlzLmlzQWN0b3JJbkRpYWxvZ3VlKGFjKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGFjLmRlbGV0ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFdvcmxkQ2xlYW5lclNlcnZpY2UucHJvdG90eXBlLmlzQWN0b3JJbkRpYWxvZ3VlID0gZnVuY3Rpb24gKGFjKSB7XHJcbiAgICAgICAgcmV0dXJuIGFjLmlzSW5EaWFsb2d1ZVdpdGhQbGF5ZXIoKSB8fCBhYy5nZXREaWFsb2d1ZVRhcmdldCgpICE9PSBudWxsO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBXb3JsZENsZWFuZXJTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFdvcmxkQ2xlYW5lclNlcnZpY2UgfTtcclxuIiwiaW1wb3J0IHsgRXZlbnRFbWl0dGVyRmFjdG9yeSB9IGZyb20gXCIuL2V2ZW50cy9ldmVudHNcIjtcclxuaW1wb3J0ICogYXMgc3AgZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbnZhciBTcEFwaUludGVyYWN0b3IgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBTcEFwaUludGVyYWN0b3IoKSB7XHJcbiAgICB9XHJcbiAgICBTcEFwaUludGVyYWN0b3Iuc2V0dXAgPSBmdW5jdGlvbiAobGlzdGVuZXJzKSB7XHJcbiAgICAgICAgbGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGxpc3RlbmVyKSB7IHJldHVybiBTcEFwaUludGVyYWN0b3IucmVnaXN0ZXJMaXN0ZW5lckZvckxvb2t1cChsaXN0ZW5lci5jb25zdHJ1Y3RvciwgbGlzdGVuZXIpOyB9KTtcclxuICAgIH07XHJcbiAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChTcEFwaUludGVyYWN0b3IuY29udHJvbGxlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gU3BBcGlJbnRlcmFjdG9yLmNvbnRyb2xsZXI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFNwQXBpSW50ZXJhY3Rvci5jb250cm9sbGVyID0ge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiBoYW5kbGUgZXJyb3JzIGluIGV2ZW50IGhhbmRsZXJzLiB3aWxsIG91dHB1dCB0byBnYW1lIGNvbnNvbGUgYnkgZGVmYXVsdFxyXG4gICAgICAgICAgICBvbjogc3Aub24sXHJcbiAgICAgICAgICAgIG9uY2U6IHNwLm9uY2UsXHJcbiAgICAgICAgICAgIGVtaXR0ZXI6IEV2ZW50RW1pdHRlckZhY3RvcnkubWFrZUV2ZW50RW1pdHRlcigpLFxyXG4gICAgICAgICAgICBsb29rdXBMaXN0ZW5lcjogZnVuY3Rpb24gKGNvbnN0cnVjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIgPSBTcEFwaUludGVyYWN0b3IubGlzdGVuZXJzRm9yTG9va3VwQnlOYW1lLmdldChjb25zdHJ1Y3Rvcik7XHJcbiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImxpc3RlbmVyIG5vdCBmb3VuZCBmb3IgbmFtZSAnXCIuY29uY2F0KGNvbnN0cnVjdG9yLm5hbWUsIFwiJ1wiKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIShsaXN0ZW5lciBpbnN0YW5jZW9mIGNvbnN0cnVjdG9yKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImxpc3RlbmVyIGNsYXNzIG1pc21hdGNoIGZvciBuYW1lICdcIi5jb25jYXQoY29uc3RydWN0b3IubmFtZSwgXCInXCIpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBTcEFwaUludGVyYWN0b3IuY29udHJvbGxlcjtcclxuICAgIH07XHJcbiAgICBTcEFwaUludGVyYWN0b3IucmVnaXN0ZXJMaXN0ZW5lckZvckxvb2t1cCA9IGZ1bmN0aW9uIChjb25zdHJ1Y3RvciwgbGlzdGVuZXIpIHtcclxuICAgICAgICBpZiAoU3BBcGlJbnRlcmFjdG9yLmxpc3RlbmVyc0Zvckxvb2t1cEJ5TmFtZS5oYXMoY29uc3RydWN0b3IpKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImxpc3RlbmVyIHJlLXJlZ2lzdHJhdGlvbiBmb3IgbmFtZSAnXCIuY29uY2F0KGNvbnN0cnVjdG9yLCBcIidcIikpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBTcEFwaUludGVyYWN0b3IubGlzdGVuZXJzRm9yTG9va3VwQnlOYW1lLnNldChjb25zdHJ1Y3RvciwgbGlzdGVuZXIpO1xyXG4gICAgfTtcclxuICAgIFNwQXBpSW50ZXJhY3Rvci5saXN0ZW5lcnNGb3JMb29rdXBCeU5hbWUgPSBuZXcgTWFwKCk7XHJcbiAgICByZXR1cm4gU3BBcGlJbnRlcmFjdG9yO1xyXG59KCkpO1xyXG5leHBvcnQgeyBTcEFwaUludGVyYWN0b3IgfTtcclxuIiwiZXhwb3J0IHZhciBnZXRBY3RvclZhbHVlcyA9IGZ1bmN0aW9uIChhYykge1xyXG4gICAgaWYgKCFhYykge1xyXG4gICAgICAgIHJldHVybiB7IGhlYWx0aDogMCwgc3RhbWluYTogMCwgbWFnaWNrYTogMCB9O1xyXG4gICAgfVxyXG4gICAgdmFyIGhlYWx0aFBlcmNlbnRhZ2UgPSAoYWMuaXNEZWFkKCkpID8gMCA6IGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKFwiaGVhbHRoXCIpO1xyXG4gICAgdmFyIHN0YW1pbmFQZXJjZW50YWdlID0gYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoXCJzdGFtaW5hXCIpO1xyXG4gICAgdmFyIG1hZ2lja2FQZXJjZW50YWdlID0gYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoXCJtYWdpY2thXCIpO1xyXG4gICAgdmFyIHJlc3VsdEFjdG9yVmFsdWUgPSB7XHJcbiAgICAgICAgaGVhbHRoOiBoZWFsdGhQZXJjZW50YWdlLFxyXG4gICAgICAgIHN0YW1pbmE6IHN0YW1pbmFQZXJjZW50YWdlLFxyXG4gICAgICAgIG1hZ2lja2E6IG1hZ2lja2FQZXJjZW50YWdlLFxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN1bHRBY3RvclZhbHVlO1xyXG59O1xyXG5leHBvcnQgdmFyIGdldE1heGltdW1BY3RvclZhbHVlID0gZnVuY3Rpb24gKGFjLCBhdk5hbWUpIHtcclxuICAgIHZhciBjdXJyZW50UGVyY2VudGFnZSA9IGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKGF2TmFtZSk7XHJcbiAgICByZXR1cm4gY3VycmVudFBlcmNlbnRhZ2UgPT09IDAgP1xyXG4gICAgICAgIGFjLmdldEJhc2VBY3RvclZhbHVlKGF2TmFtZSkgOlxyXG4gICAgICAgIE1hdGguY2VpbChhYy5nZXRBY3RvclZhbHVlKGF2TmFtZSkgLyBjdXJyZW50UGVyY2VudGFnZSk7XHJcbn07XHJcbmV4cG9ydCB2YXIgc2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UgPSBmdW5jdGlvbiAoYWMsIGF2TmFtZSwgcGVyY2VudGFnZSkge1xyXG4gICAgLy8gQWN0b3IgdmFsdWUgcGVyY2VudGFnZSBmb3IgaGVhbHRoIG1heSBiZSBiZWxvdyB6ZXJvICgtMS44IGZvciBleGFtcGxlLCBpdCBtZWFucyB1IGhhdmUgLTE4MCUgaGVhbHRoKVxyXG4gICAgdmFyIGN1cnJlbnRQZXJjZW50YWdlID0gYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoYXZOYW1lKTtcclxuICAgIGlmIChjdXJyZW50UGVyY2VudGFnZSA9PT0gcGVyY2VudGFnZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciBjdXJyZW50TWF4VmFsdWUgPSBnZXRNYXhpbXVtQWN0b3JWYWx1ZShhYywgYXZOYW1lKTtcclxuICAgIHZhciBkZWx0YVBlcmNlbnRhZ2UgPSBwZXJjZW50YWdlIC0gY3VycmVudFBlcmNlbnRhZ2U7XHJcbiAgICBpZiAoZGVsdGFQZXJjZW50YWdlID4gMCkge1xyXG4gICAgICAgIGFjLnJlc3RvcmVBY3RvclZhbHVlKGF2TmFtZSwgZGVsdGFQZXJjZW50YWdlICogY3VycmVudE1heFZhbHVlKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKGRlbHRhUGVyY2VudGFnZSA8IDApIHtcclxuICAgICAgICBhYy5kYW1hZ2VBY3RvclZhbHVlKGF2TmFtZSwgZGVsdGFQZXJjZW50YWdlICogY3VycmVudE1heFZhbHVlKTtcclxuICAgIH1cclxufTtcclxuIiwiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uICovXHJcbmltcG9ydCB7IERlYnVnLCBob29rcywgQWN0b3IsIHByaW50Q29uc29sZSwgVXRpbGl0eSwgR2FtZSwgc3RvcmFnZSwgXHJcbi8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbnNldENvbGxpc2lvbiB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBhcHBseVdlYXBEcmF3biB9IGZyb20gXCIuL21vdmVtZW50QXBwbHlcIjtcclxuZXhwb3J0IHZhciBBbmltYXRpb25FdmVudE5hbWU7XHJcbihmdW5jdGlvbiAoQW5pbWF0aW9uRXZlbnROYW1lKSB7XHJcbiAgICBBbmltYXRpb25FdmVudE5hbWVbXCJSYWdkb2xsXCJdID0gXCJSYWdkb2xsXCI7XHJcbiAgICBBbmltYXRpb25FdmVudE5hbWVbXCJHZXRVcEJlZ2luXCJdID0gXCJHZXRVcEJlZ2luXCI7XHJcbn0pKEFuaW1hdGlvbkV2ZW50TmFtZSB8fCAoQW5pbWF0aW9uRXZlbnROYW1lID0ge30pKTtcclxuO1xyXG52YXIgYWxsb3dlZElkbGVzID0gbmV3IEFycmF5KCk7XHJcbnZhciByZWZzV2l0aERlZmF1bHRBbmltc0Rpc2FibGVkID0gbmV3IFNldCgpO1xyXG52YXIgYWxsb3dlZEFuaW1zID0gbmV3IFNldCgpO1xyXG52YXIgYWN0b3JTaXRBbmltc0xvd2VyQ2FzZSA9IFtcclxuICAgICdpZGxlc3Rvb2xlbnRlcnBsYXllcicsXHJcbiAgICAnaWRsZXN0b29sZW50ZXInLFxyXG4gICAgJ2lkbGVzdG9vbGVudGVyaW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlycmlnaHRlbnRlcicsXHJcbiAgICAnaWRsZWNoYWlybGVmdGVudGVyJyxcclxuICAgICdpZGxlY2hhaXJmcm9udGVudGVyJyxcclxuICAgICdpZGxlY2hhaXJlbnRlcmluc3RhbnQnLFxyXG4gICAgJ2lkbGVqYXJsY2hhaXJlbnRlcicsXHJcbiAgICAnaWRsZWphcmxjaGFpcmVudGVyaW5zdGFudCcsXHJcbiAgICAnaWRsZXNub3dlbGZwcmluY2VjaGFpcmRpYWxvZ3VlJyxcclxuICAgICdpZGxlc25vd2VsZnByaW5jZWNoYWlyZW50ZXInLFxyXG4gICAgJ2lkbGVzbm93ZWxmcHJpbmNlY2hhaXJlbnRlcmluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkZW50ZXJpbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJjaGlsZGZyb250ZW50ZXInLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkbGVmdGVudGVyJyxcclxuICAgICdpZGxlY2hhaXJjaGlsZHJpZ2h0ZW50ZXInLFxyXG5dO1xyXG52YXIgYWN0b3JHZXRVcEFuaW1zTG93ZXJDYXNlID0gW1xyXG4gICAgJ2lkbGVzdG9vbGJhY2tleGl0JyxcclxuICAgICdpZGxlY2hhaXJyaWdodGV4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcnJpZ2h0cXVpY2tleGl0JyxcclxuICAgICdpZGxlY2hhaXJsZWZ0ZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlybGVmdHF1aWNrZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlyZnJvbnRleGl0JyxcclxuICAgICdpZGxlY2hhaXJmcm9udHF1aWNrZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRmcm9udGV4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkbGVmdGV4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkcmlnaHRleGl0J1xyXG5dO1xyXG4vLyBJdCdzIGNyaXRpY2FsIGZvciB2YWx1ZXMgdG8gYmUgdGhlIGNvcnJlY3QgY2FzZSwgbm90IGp1c3QgbG93ZXJjYXNlLCBvdGhlcndpc2UgJ2FsbG93ZWRJZGxlcycgY2hlY2sgd2lsbCBicmVha1xyXG4vLyBXZSBkb24ndCB3YW50IHRvIG1vZGlmeSB0aGUgY2hlY2sgaXRzZWxmLCBiZWNhdXNlIGl0J2xsIGJlIHNsb3dlclxyXG52YXIgYW5pbU92ZXJyaWRlc0xvd2VyQ2FzZSA9IHtcclxuICAgICdpZGxlY2hhaXJib29rX29uZXBhZ2UnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJzaG91bGRlcmZsZXgnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJ3cml0ZSc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcmFybXNjcm9zc2VkdmFyMSc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2NoYWlyZWF0aW5nc3RhcnRfdmFtcGlyZW1lYXQnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdjaGFpcnJlYWRpbmdzdGFydCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2NoYWlydmFtcGlyZWVhdGluZ3N0YXJ0JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnY2hhaXJkcmlua2luZ3N0YXJ0JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnY2hhaXJlYXRpbmdzdGFydCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgLy8gVGhlIG9ubHkgdHJpcGxlIGFuaW1hdGlvbiB3ZSBrbm93IGZvciBub3cuIE9uZSBiYXNlIGFuaW0gdG8gc2l0LCB0aGVuIHR3byB0byBlYXRcclxuICAgICdjaGFpcmVhdGluZ3NvdXBzdGFydCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGVlYXRzb3VwJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAvLyBObyBuZWVkIHRvIHJlLXBsYXkgdGhlIGFuaW1hdGlvbiwgdXNlIGluc3RhbnQgdmFyaWFudCBmb3Igc3Bhd25pbmcgYWN0b3JzXHJcbiAgICAvLyBUaGlzIGlzIG5vdCBlc3NlbnRpYWwsIGJ1dCBtYWtlcyB0aGUgc3luYyBmZWVsIG1vcmUgc21vb3RoLiBUaGUgbGlzdCBpcyBub3QgY29tcGxldGUuXHJcbiAgICAnaWRsZWNoYWlycmlnaHRlbnRlcic6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcmxlZnRlbnRlcic6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcmZyb250ZW50ZXInOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgIC8vIFVudGVzdGVkIHlldCBsb29rcyBjb3JyZWN0XHJcbiAgICAnaWRsZXNub3dlbGZwcmluY2VmaXJlYW5kZm9yZ2V0JzogJ0lkbGVTbm93RWxmUHJpbmNlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGV0YWJsZW11Z2VudGVyJzogJ0lkbGVUYWJsZUVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZXRhYmxlZHJpbmtlbnRlcic6ICdJZGxlVGFibGVFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGV0YWJsZWRyaW5rYW5kbXVnZW50ZXInOiAnSWRsZVRhYmxlRW50ZXJJbnN0YW50J1xyXG59O1xyXG4vLyB1bmNsYXNzaWZpZWQ6XHJcbi8vIElkbGVDaGFpckVudGVySW5zdGFudFxyXG4vLyBJZGxlQ2hhaXJFbnRlclN0YXJ0XHJcbi8vIElkbGVDaGFpckVudGVyU3RvcFxyXG4vLyBJZGxlQ2hhaXJFbnRlclRvU2l0XHJcbi8vIElkbGVDaGFpckV4aXRTdGFydFxyXG4vLyBJZGxlQ2hhaXJFeGl0VG9TdGFuZFxyXG4vLyBJZGxlQ2hhaXJTaXR0aW5nXHJcbi8vIElkbGVMZWZ0Q2hhaXJFbnRlclN0YXJ0XHJcbi8vIENoYWlySWRsZVxyXG4vLyBJZGxlUmlnaHRDaGFpckVudGVyU3RhcnRcclxuLy8gSWRsZUxlZnRDaGFpckVudGVyU3RhcnRcclxudmFyIGlzSWRsZSA9IGZ1bmN0aW9uIChhbmltRXZlbnROYW1lKSB7XHJcbiAgICB2YXIgYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZSA9IGFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIHJldHVybiAoYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZSA9PT0gXCJtb3Rpb25kcml2ZW5pZGxlXCIgfHxcclxuICAgICAgICAoYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZS5zdGFydHNXaXRoKFwiaWRsZVwiKSAmJlxyXG4gICAgICAgICAgICBhbmltRXZlbnROYW1lTG93ZXJDYXNlICE9PSBcImlkbGVzdG9wXCIgJiZcclxuICAgICAgICAgICAgYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZSAhPT0gXCJpZGxlZm9yY2VkZWZhdWx0c3RhdGVcIikpO1xyXG59O1xyXG5leHBvcnQgdmFyIGFwcGx5QW5pbWF0aW9uID0gZnVuY3Rpb24gKHJlZnIsIGFuaW0sIHN0YXRlKSB7XHJcbiAgICBpZiAoc3RhdGUubGFzdE51bUNoYW5nZXMgPT09IGFuaW0ubnVtQ2hhbmdlcykge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHN0YXRlLmxhc3ROdW1DaGFuZ2VzID0gYW5pbS5udW1DaGFuZ2VzO1xyXG4gICAgaWYgKHN0YXRlLnVzZUFuaW1PdmVycmlkZXMpIHtcclxuICAgICAgICB2YXIgYW5pbU92ZXJyaWRlID0gYW5pbU92ZXJyaWRlc0xvd2VyQ2FzZVthbmltLmFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKV07XHJcbiAgICAgICAgaWYgKGFuaW1PdmVycmlkZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGFuaW0uYW5pbUV2ZW50TmFtZSA9IGFuaW1PdmVycmlkZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZSA9IGFuaW0uYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKGlzSWRsZShhbmltLmFuaW1FdmVudE5hbWUpKSB7XHJcbiAgICAgICAgYWxsb3dlZElkbGVzLnB1c2goW3JlZnIuZ2V0Rm9ybUlEKCksIGFuaW0uYW5pbUV2ZW50TmFtZV0pO1xyXG4gICAgfVxyXG4gICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgIGlmIChhbmltLmFuaW1FdmVudE5hbWUgPT09IFwiU2t5bXBGYWtlRXF1aXBcIikge1xyXG4gICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICBhcHBseVdlYXBEcmF3bihhYywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChhbmltLmFuaW1FdmVudE5hbWUgPT09IFwiU2t5bXBGYWtlVW5lcXVpcFwiKSB7XHJcbiAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgIGFwcGx5V2VhcERyYXduKGFjLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChhbmltLmFuaW1FdmVudE5hbWUgPT09IFwiUmFnZG9sbFwiKSB7XHJcbiAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgIGlmIChzdG9yYWdlW1wiYW5pbWF0aW9uRnVuYzFTZXRcIl0gPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2VbXCJhbmltYXRpb25GdW5jMVwiXShhYyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhYy5wdXNoQWN0b3JBd2F5KGFjLCAwKTtcclxuICAgICAgICAgICAgICAgIGFjLnNldEFjdG9yVmFsdWUoXCJWYXJpYWJsZTEwXCIsIC0xMDAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAocmVmc1dpdGhEZWZhdWx0QW5pbXNEaXNhYmxlZC5oYXMocmVmci5nZXRGb3JtSUQoKSkpIHtcclxuICAgICAgICBpZiAoYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZS5pbmNsdWRlcyhcImF0dGFja1wiKSkge1xyXG4gICAgICAgICAgICBhbGxvd2VkQW5pbXMuYWRkKHJlZnIuZ2V0Rm9ybUlEKCkgKyBcIjpcIiArIGFuaW0uYW5pbUV2ZW50TmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KHJlZnIsIGFuaW0uYW5pbUV2ZW50TmFtZSk7XHJcbiAgICBpZiAoYW5pbS5hbmltRXZlbnROYW1lID09PSBcIkdldFVwQmVnaW5cIikge1xyXG4gICAgICAgIHZhciByZWZySWRfMSA9IHJlZnIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgVXRpbGl0eS53YWl0KDEpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZF8xKSk7XHJcbiAgICAgICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICAgICAgYWMuc2V0QWN0b3JWYWx1ZShcIlZhcmlhYmxlMTBcIiwgMTAwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmIChhY3RvclNpdEFuaW1zTG93ZXJDYXNlLmZpbmQoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHggPT09IGFuaW1FdmVudE5hbWVMb3dlckNhc2U7IH0pICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBzZXRDb2xsaXNpb24ocmVmci5nZXRGb3JtSUQoKSwgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgaWYgKGFjdG9yR2V0VXBBbmltc0xvd2VyQ2FzZS5maW5kKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4ID09PSBhbmltRXZlbnROYW1lTG93ZXJDYXNlOyB9KSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgc2V0Q29sbGlzaW9uKHJlZnIuZ2V0Rm9ybUlEKCksIHRydWUpO1xyXG4gICAgfVxyXG59O1xyXG5leHBvcnQgdmFyIHNldERlZmF1bHRBbmltc0Rpc2FibGVkID0gZnVuY3Rpb24gKHJlZnJJZCwgZGlzYWJsZWQpIHtcclxuICAgIGlmIChkaXNhYmxlZCkge1xyXG4gICAgICAgIHJlZnNXaXRoRGVmYXVsdEFuaW1zRGlzYWJsZWQuYWRkKHJlZnJJZCk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZWZzV2l0aERlZmF1bHRBbmltc0Rpc2FibGVkLmRlbGV0ZShyZWZySWQpO1xyXG4gICAgfVxyXG59O1xyXG52YXIgQW5pbWF0aW9uU291cmNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gQW5pbWF0aW9uU291cmNlKHJlZnIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMucmVmcklkID0gMDtcclxuICAgICAgICB0aGlzLm51bUNoYW5nZXMgPSAwO1xyXG4gICAgICAgIHRoaXMuYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgdGhpcy53ZWFwTm9uRHJhd25CbG9ja2VyID0gMDtcclxuICAgICAgICB0aGlzLndlYXBEcmF3bkJsb2NrZXIgPSAwO1xyXG4gICAgICAgIHRoaXMuc25lYWtCbG9ja2VyID0gbnVsbDtcclxuICAgICAgICB0aGlzLnJlZnJJZCA9IHJlZnIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY3R4LnNlbGZJZCAhPT0gX3RoaXMucmVmcklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCFjdHguYW5pbWF0aW9uU3VjY2VlZGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCwgc2VlIGNhcnJ5QW5pbVN5c3RlbS50cyBpbiBnYW1lbW9kZVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIENhc2Utc2Vuc2V0aXZlIGNoZWNrIGhlcmUgZm9yIGJldHRlciBwZXJmb3JtYW5jZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdHguYW5pbUV2ZW50TmFtZSAhPT0gXCJPZmZzZXRDYXJyeUJhc2tldFN0YXJ0XCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF90aGlzLm9uU2VuZEFuaW1hdGlvbkV2ZW50KGN0eC5hbmltRXZlbnROYW1lKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIEFuaW1hdGlvblNvdXJjZS5wcm90b3R5cGUuZmlsdGVyTW92ZW1lbnQgPSBmdW5jdGlvbiAobW92KSB7XHJcbiAgICAgICAgaWYgKHRoaXMud2VhcERyYXduQmxvY2tlciA+PSBEYXRlLm5vdygpKSB7XHJcbiAgICAgICAgICAgIG1vdi5pc1dlYXBEcmF3biA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLndlYXBOb25EcmF3bkJsb2NrZXIgPj0gRGF0ZS5ub3coKSkge1xyXG4gICAgICAgICAgICBtb3YuaXNXZWFwRHJhd24gPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc25lYWtCbG9ja2VyID09PSBtb3YuaXNTbmVha2luZykge1xyXG4gICAgICAgICAgICB0aGlzLnNuZWFrQmxvY2tlciA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKHRoaXMuc25lYWtCbG9ja2VyID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIG1vdi5pc1NuZWFraW5nID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAodGhpcy5zbmVha0Jsb2NrZXIgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIG1vdi5pc1NuZWFraW5nID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBtb3Y7XHJcbiAgICB9O1xyXG4gICAgQW5pbWF0aW9uU291cmNlLnByb3RvdHlwZS5nZXRBbmltYXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF9hID0gdGhpcywgbnVtQ2hhbmdlcyA9IF9hLm51bUNoYW5nZXMsIGFuaW1FdmVudE5hbWUgPSBfYS5hbmltRXZlbnROYW1lO1xyXG4gICAgICAgIHJldHVybiB7IG51bUNoYW5nZXM6IG51bUNoYW5nZXMsIGFuaW1FdmVudE5hbWU6IGFuaW1FdmVudE5hbWUgfTtcclxuICAgIH07XHJcbiAgICBBbmltYXRpb25Tb3VyY2UucHJvdG90eXBlLm9uU2VuZEFuaW1hdGlvbkV2ZW50ID0gZnVuY3Rpb24gKGFuaW1FdmVudE5hbWUpIHtcclxuICAgICAgICBpZiAoaWdub3JlZEFuaW1zLmhhcyhhbmltRXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBsb3dlciA9IGFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB2YXIgaXNUb3JjaEV2ZW50ID0gbG93ZXIuaW5jbHVkZXMoXCJ0b3JjaFwiKTtcclxuICAgICAgICBpZiAoYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFwidW5lcXVpcFwiKSAmJiAhaXNUb3JjaEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMud2VhcE5vbkRyYXduQmxvY2tlciA9IERhdGUubm93KCkgKyAzMDA7XHJcbiAgICAgICAgICAgIGFuaW1FdmVudE5hbWUgPSBcIlNreW1wRmFrZVVuZXF1aXBcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFwiZXF1aXBcIikgJiYgIWlzVG9yY2hFdmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLndlYXBEcmF3bkJsb2NrZXIgPSBEYXRlLm5vdygpICsgMzAwO1xyXG4gICAgICAgICAgICBhbmltRXZlbnROYW1lID0gXCJTa3ltcEZha2VFcXVpcFwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYW5pbUV2ZW50TmFtZSA9PT0gXCJTbmVha1N0YXJ0XCIpIHtcclxuICAgICAgICAgICAgdGhpcy5zbmVha0Jsb2NrZXIgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhbmltRXZlbnROYW1lID09PSBcIlNuZWFrU3RvcFwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc25lYWtCbG9ja2VyID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5udW1DaGFuZ2VzKys7XHJcbiAgICAgICAgdGhpcy5hbmltRXZlbnROYW1lID0gYW5pbUV2ZW50TmFtZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQW5pbWF0aW9uU291cmNlO1xyXG59KCkpO1xyXG5leHBvcnQgeyBBbmltYXRpb25Tb3VyY2UgfTtcclxudmFyIGlnbm9yZWRBbmltcyA9IG5ldyBTZXQoW1xyXG4gICAgXCJtb3ZlU3RhcnRcIixcclxuICAgIFwibW92ZVN0b3BcIixcclxuICAgIFwidHVyblN0b3BcIixcclxuICAgIFwiQ3ljbGljQ3Jvc3NCbGVuZFwiLFxyXG4gICAgXCJDeWNsaWNGcmVlemVcIixcclxuICAgIFwiVHVybkxlZnRcIixcclxuICAgIFwiVHVyblJpZ2h0XCIsXHJcbl0pO1xyXG5leHBvcnQgdmFyIHNldHVwSG9va3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICBpZiAocmVmc1dpdGhEZWZhdWx0QW5pbXNEaXNhYmxlZC5oYXMoY3R4LnNlbGZJZCkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChjdHguYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFwiYXR0YWNrXCIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFuaW1LZXkgPSBjdHguc2VsZklkICsgXCI6XCIgKyBjdHguYW5pbUV2ZW50TmFtZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYWxsb3dlZEFuaW1zLmhhcyhhbmltS2V5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkQW5pbXMuZGVsZXRlKGFuaW1LZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiYmxvY2sgYW5pbSBcIiArIGN0eC5hbmltRXZlbnROYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBTaG93UmFjZU1lbnUgZm9yY2VzIHRoaXMgYW5pbVxyXG4gICAgICAgICAgICBpZiAoY3R4LmFuaW1FdmVudE5hbWUgPT09IFwiT2Zmc2V0Qm91bmRTdGFuZGluZ1BsYXllckluc3RhbnRcIikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIChjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIERpc2FibGUgaWRsZSBhbmltYXRpb25zIGZvciAweGZmIGFjdG9yc1xyXG4gICAgICAgICAgICBpZiAoY3R4LnNlbGZJZCA8IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaXNJZGxlKGN0eC5hbmltRXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGkgPSBhbGxvd2VkSWRsZXMuZmluZEluZGV4KGZ1bmN0aW9uIChwYWlyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhaXJbMF0gPT09IGN0eC5zZWxmSWQgJiYgcGFpclsxXSA9PT0gY3R4LmFuaW1FdmVudE5hbWU7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGkgPT09IC0xID8gKGN0eC5hbmltRXZlbnROYW1lID0gXCJcIikgOiBhbGxvd2VkSWRsZXMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKCkgeyB9LFxyXG4gICAgfSk7XHJcbn07XHJcbiIsImltcG9ydCB7IEFjdG9yQmFzZSwgR2FtZSwgVEVTTW9kUGxhdGZvcm0sIFJhY2UsIEhlYWRQYXJ0LCBUZXh0dXJlU2V0LCBwcmludENvbnNvbGUsIFZvaWNlVHlwZSwgb25jZSwgVXRpbGl0eSwgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuZXhwb3J0IHZhciBnZXRBcHBlYXJhbmNlID0gZnVuY3Rpb24gKGFjdG9yKSB7XHJcbiAgICB2YXIgYmFzZSA9IEFjdG9yQmFzZS5mcm9tKGFjdG9yLmdldEJhc2VPYmplY3QoKSk7XHJcbiAgICB2YXIgaGFpckNvbG9yID0gYmFzZS5nZXRIYWlyQ29sb3IoKTtcclxuICAgIHZhciBza2luQ29sb3IgPSBURVNNb2RQbGF0Zm9ybS5nZXRTa2luQ29sb3IoYmFzZSk7XHJcbiAgICB2YXIgbmV3QXBwZWFyYW5jZSA9IHtcclxuICAgICAgICBpc0ZlbWFsZTogYmFzZS5nZXRTZXgoKSA9PT0gMSxcclxuICAgICAgICByYWNlSWQ6IGJhc2UuZ2V0UmFjZSgpID8gYmFzZS5nZXRSYWNlKCkuZ2V0Rm9ybUlEKCkgOiAwLFxyXG4gICAgICAgIHdlaWdodDogYmFzZS5nZXRXZWlnaHQoKSxcclxuICAgICAgICBoYWlyQ29sb3I6IGhhaXJDb2xvciA/IGhhaXJDb2xvci5nZXRDb2xvcigpIDogMCxcclxuICAgICAgICBoZWFkcGFydElkczogW10sXHJcbiAgICAgICAgaGVhZFRleHR1cmVTZXRJZDogYmFzZS5nZXRGYWNlVGV4dHVyZVNldCgpXHJcbiAgICAgICAgICAgID8gYmFzZS5nZXRGYWNlVGV4dHVyZVNldCgpLmdldEZvcm1JRCgpXHJcbiAgICAgICAgICAgIDogMCxcclxuICAgICAgICBvcHRpb25zOiBuZXcgQXJyYXkoMTkpLFxyXG4gICAgICAgIHByZXNldHM6IG5ldyBBcnJheSg0KSxcclxuICAgICAgICB0aW50czogW10sXHJcbiAgICAgICAgc2tpbkNvbG9yOiBza2luQ29sb3IgPyBza2luQ29sb3IuZ2V0Q29sb3IoKSA6IDAsXHJcbiAgICAgICAgbmFtZTogYWN0b3IuZ2V0QmFzZU9iamVjdCgpLmdldE5hbWUoKSxcclxuICAgIH07XHJcbiAgICB2YXIgbnVtSGVhZHBhcnRzID0gYmFzZS5nZXROdW1IZWFkUGFydHMoKTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtSGVhZHBhcnRzOyArK2kpIHtcclxuICAgICAgICB2YXIgcGFydCA9IGJhc2UuZ2V0TnRoSGVhZFBhcnQoaSk7XHJcbiAgICAgICAgaWYgKHBhcnQpIHtcclxuICAgICAgICAgICAgbmV3QXBwZWFyYW5jZS5oZWFkcGFydElkcy5wdXNoKHBhcnQuZ2V0Rm9ybUlEKCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3QXBwZWFyYW5jZS5vcHRpb25zLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgbmV3QXBwZWFyYW5jZS5vcHRpb25zW2ldID0gYmFzZS5nZXRGYWNlTW9ycGgoaSk7XHJcbiAgICB9XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0FwcGVhcmFuY2UucHJlc2V0cy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIG5ld0FwcGVhcmFuY2UucHJlc2V0c1tpXSA9IGJhc2UuZ2V0RmFjZVByZXNldChpKTtcclxuICAgIH1cclxuICAgIHZhciBudW1UaW50cyA9IEdhbWUuZ2V0UGxheWVyKCkuZ2V0Rm9ybUlEKCkgPT09IGFjdG9yLmdldEZvcm1JRCgpXHJcbiAgICAgICAgPyBHYW1lLmdldE51bVRpbnRNYXNrcygpXHJcbiAgICAgICAgOiAwO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1UaW50czsgKytpKSB7XHJcbiAgICAgICAgdmFyIHRpbnQgPSB7XHJcbiAgICAgICAgICAgIHRleHR1cmVQYXRoOiBHYW1lLmdldE50aFRpbnRNYXNrVGV4dHVyZVBhdGgoaSksXHJcbiAgICAgICAgICAgIHR5cGU6IEdhbWUuZ2V0TnRoVGludE1hc2tUeXBlKGkpLFxyXG4gICAgICAgICAgICBhcmdiOiBHYW1lLmdldE50aFRpbnRNYXNrQ29sb3IoaSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICBuZXdBcHBlYXJhbmNlLnRpbnRzLnB1c2godGludCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3QXBwZWFyYW5jZTtcclxufTtcclxudmFyIGlzVmlzaWJsZSA9IGZ1bmN0aW9uIChhcmdiKSB7IHJldHVybiBhcmdiID4gMHgwMGZmZmZmZiB8fCBhcmdiIDwgMDsgfTtcclxuZXhwb3J0IHZhciBhcHBseVRpbnRzID0gZnVuY3Rpb24gKGFjdG9yLCBhcHBlYXJhbmNlKSB7XHJcbiAgICBpZiAoIWFwcGVhcmFuY2UpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJudWxsIGFwcGVhcmFuY2UgaGFzIGJlZW4gcGFzc2VkIHRvIGFwcGx5VGludHNcIik7XHJcbiAgICB9XHJcbiAgICB2YXIgdGludHMgPSBhcHBlYXJhbmNlLnRpbnRzLmZpbHRlcihmdW5jdGlvbiAodCkgeyByZXR1cm4gaXNWaXNpYmxlKHQuYXJnYik7IH0pO1xyXG4gICAgdmFyIHJhY2VXYXJQYWludFJlZ2V4ID0gLy4qSGVhZC4rV2FyUGFpbnQuKi87XHJcbiAgICB2YXIgdW5pV2FyUGFpbnRSZWdleCA9IC8uKkhlYWRXYXJQYWludC4qLztcclxuICAgIHZhciByYWNlU3BlY2lmaWNXYXJQYWludCA9IHRpbnRzLmZpbHRlcihmdW5jdGlvbiAodCkgeyByZXR1cm4gaXNWaXNpYmxlKHQuYXJnYikgJiYgdC50ZXh0dXJlUGF0aC5tYXRjaChyYWNlV2FyUGFpbnRSZWdleCk7IH0pLmxlbmd0aDsgLy8gTWFsZUhlYWROb3JkV2FyUGFpbnRcclxuICAgIHZhciB1bmlXYXJQYWludCA9IHRpbnRzLmZpbHRlcihmdW5jdGlvbiAodCkgeyByZXR1cm4gaXNWaXNpYmxlKHQuYXJnYikgJiYgdC50ZXh0dXJlUGF0aC5tYXRjaCh1bmlXYXJQYWludFJlZ2V4KTsgfSkubGVuZ3RoOyAvLyBNYWxlSGVhZFdhclBhaW50XHJcbiAgICBpZiAocmFjZVNwZWNpZmljV2FyUGFpbnQgKyB1bmlXYXJQYWludCA+IDEpIHtcclxuICAgICAgICAvLyBJZiB2aXNpYmxlIHdhciBwYWludHMgb2YgdGhlc2UgdHdvIHR5cGVzIHByZXNlbnQsIHRoZW4gU2t5cmltIGNyYXNoZXNcclxuICAgICAgICBwcmludENvbnNvbGUoXCJiYWQgd2FycGFpbnQhXCIsIHJhY2VTcGVjaWZpY1dhclBhaW50LCB1bmlXYXJQYWludCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgVEVTTW9kUGxhdGZvcm0uY2xlYXJUaW50TWFza3MoYWN0b3IpO1xyXG4gICAgdGludHMuZm9yRWFjaChmdW5jdGlvbiAodGludCkge1xyXG4gICAgICAgIFRFU01vZFBsYXRmb3JtLnB1c2hUaW50TWFzayhhY3RvciwgdGludC50eXBlLCB0aW50LmFyZ2IsIHRpbnQudGV4dHVyZVBhdGgpO1xyXG4gICAgfSk7XHJcbiAgICB2YXIgcGxheWVyQmFzZUlkID0gR2FtZS5nZXRQbGF5ZXIoKS5nZXRCYXNlT2JqZWN0KCkuZ2V0Rm9ybUlEKCk7XHJcbiAgICBpZiAoYWN0b3IpXHJcbiAgICAgICAgVEVTTW9kUGxhdGZvcm0uc2V0Rm9ybUlkVW5zYWZlKGFjdG9yLmdldEJhc2VPYmplY3QoKSwgcGxheWVyQmFzZUlkKTtcclxufTtcclxuZXhwb3J0IHZhciBzaWxlbnRWb2ljZVR5cGVJZCA9IDB4MDAwMmY3YzM7XHJcbnZhciBhcHBseUFwcGVhcmFuY2VDb21tb24gPSBmdW5jdGlvbiAoYXBwZWFyYW5jZSwgbnBjKSB7XHJcbiAgICB2YXIgcmFjZSA9IFJhY2UuZnJvbShHYW1lLmdldEZvcm1FeChhcHBlYXJhbmNlLnJhY2VJZCkpO1xyXG4gICAgdmFyIGhlYWRwYXJ0cyA9IGFwcGVhcmFuY2UuaGVhZHBhcnRJZHNcclxuICAgICAgICAubWFwKGZ1bmN0aW9uIChpZCkgeyByZXR1cm4gSGVhZFBhcnQuZnJvbShHYW1lLmdldEZvcm1FeChpZCkpOyB9KVxyXG4gICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGhlYWRwYXJ0KSB7IHJldHVybiAhIWhlYWRwYXJ0OyB9KTtcclxuICAgIFRFU01vZFBsYXRmb3JtLnNldE5wY1NleChucGMsIGFwcGVhcmFuY2UuaXNGZW1hbGUgPyAxIDogMCk7XHJcbiAgICBpZiAocmFjZSkge1xyXG4gICAgICAgIFRFU01vZFBsYXRmb3JtLnNldE5wY1JhY2UobnBjLCByYWNlKTtcclxuICAgIH1cclxuICAgIG5wYy5zZXRXZWlnaHQoYXBwZWFyYW5jZS53ZWlnaHQpO1xyXG4gICAgVEVTTW9kUGxhdGZvcm0uc2V0TnBjU2tpbkNvbG9yKG5wYywgYXBwZWFyYW5jZS5za2luQ29sb3IpO1xyXG4gICAgVEVTTW9kUGxhdGZvcm0uc2V0TnBjSGFpckNvbG9yKG5wYywgYXBwZWFyYW5jZS5oYWlyQ29sb3IpO1xyXG4gICAgVEVTTW9kUGxhdGZvcm0ucmVzaXplSGVhZHBhcnRzQXJyYXkobnBjLCBoZWFkcGFydHMubGVuZ3RoKTtcclxuICAgIGhlYWRwYXJ0cy5mb3JFYWNoKGZ1bmN0aW9uICh2LCBpKSB7IHJldHVybiBucGMuc2V0TnRoSGVhZFBhcnQodiwgaSk7IH0pO1xyXG4gICAgbnBjLnNldEZhY2VUZXh0dXJlU2V0KFRleHR1cmVTZXQuZnJvbShHYW1lLmdldEZvcm1FeChhcHBlYXJhbmNlLmhlYWRUZXh0dXJlU2V0SWQpKSk7IC8vIHNldEZhY2VUZXh0dXJlU2V0IHN1cHBvcnRzIG51bGwgYXJndW1lbnRcclxuICAgIG5wYy5zZXRWb2ljZVR5cGUoVm9pY2VUeXBlLmZyb20oR2FtZS5nZXRGb3JtRXgoc2lsZW50Vm9pY2VUeXBlSWQpKSk7XHJcbiAgICBhcHBlYXJhbmNlLm9wdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAodiwgaSkgeyByZXR1cm4gbnBjLnNldEZhY2VNb3JwaCh2LCBpKTsgfSk7XHJcbiAgICBhcHBlYXJhbmNlLnByZXNldHMuZm9yRWFjaChmdW5jdGlvbiAodiwgaSkgeyByZXR1cm4gbnBjLnNldEZhY2VQcmVzZXQodiwgaSk7IH0pO1xyXG4gICAgaWYgKGFwcGVhcmFuY2UubmFtZSkge1xyXG4gICAgICAgIG5wYy5zZXROYW1lKGFwcGVhcmFuY2UubmFtZSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICAvLyBmb3IgdW5kZWZpbmVkIG9yIGVtcHR5IG5hbWVcclxuICAgICAgICBucGMuc2V0TmFtZShcIiBcIik7XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCB2YXIgYXBwbHlBcHBlYXJhbmNlID0gZnVuY3Rpb24gKGFwcGVhcmFuY2UpIHtcclxuICAgIHZhciBucGMgPSBURVNNb2RQbGF0Zm9ybS5jcmVhdGVOcGMoKTtcclxuICAgIGlmICghbnBjKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiY3JlYXRlTnBjIHJldHVybmVkIG51bGxcIik7XHJcbiAgICB9XHJcbiAgICBhcHBseUFwcGVhcmFuY2VDb21tb24oYXBwZWFyYW5jZSwgbnBjKTtcclxuICAgIHJldHVybiBucGM7XHJcbn07XHJcbmV4cG9ydCB2YXIgYXBwbHlBcHBlYXJhbmNlVG9QbGF5ZXIgPSBmdW5jdGlvbiAoYXBwZWFyYW5jZSkge1xyXG4gICAgYXBwbHlBcHBlYXJhbmNlQ29tbW9uKGFwcGVhcmFuY2UsIEFjdG9yQmFzZS5mcm9tKEdhbWUuZ2V0UGxheWVyKCkuZ2V0QmFzZU9iamVjdCgpKSk7XHJcbiAgICBhcHBseVRpbnRzKG51bGwsIGFwcGVhcmFuY2UpO1xyXG4gICAgR2FtZS5nZXRQbGF5ZXIoKS5xdWV1ZU5pTm9kZVVwZGF0ZSgpO1xyXG4gICAgVXRpbGl0eS53YWl0KDAuMDYyNSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgb25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgKF9hID0gR2FtZS5nZXRQbGF5ZXIoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnN0YXJ0RGVmZXJyZWRLaWxsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufTtcclxuIiwiaW1wb3J0IHsgQWN0b3IsIEFtbW8sIEdhbWUsIFNwZWxsLCBVaSwgc2V0SW52ZW50b3J5LCB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuaW1wb3J0IHsgZ2V0SW52ZW50b3J5IH0gZnJvbSAnLi9pbnZlbnRvcnknO1xyXG5leHBvcnQgdmFyIGdldEVxdWlwZWRTcGVsbCA9IGZ1bmN0aW9uIChyZWZyLCBzcGVsbFR5cGUpIHtcclxuICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICBpZiAoIWFjdG9yKSB7XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbiAgICBzd2l0Y2ggKHNwZWxsVHlwZSkge1xyXG4gICAgICAgIGNhc2UgMCAvKiBTcGVsbFR5cGUuTGVmdCAqLzoge1xyXG4gICAgICAgICAgICB2YXIgc3BlbGwgPSBhY3Rvci5nZXRFcXVpcHBlZFNwZWxsKDAgLyogU3BlbGxUeXBlLkxlZnQgKi8pO1xyXG4gICAgICAgICAgICByZXR1cm4gc3BlbGwgPyBzcGVsbC5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgMSAvKiBTcGVsbFR5cGUuUmlnaHQgKi86IHtcclxuICAgICAgICAgICAgdmFyIHNwZWxsID0gYWN0b3IuZ2V0RXF1aXBwZWRTcGVsbCgxIC8qIFNwZWxsVHlwZS5SaWdodCAqLyk7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGVsbCA/IHNwZWxsLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAyIC8qIFNwZWxsVHlwZS5Wb2ljZSAqLzoge1xyXG4gICAgICAgICAgICB2YXIgc3BlbGwgPSBhY3Rvci5nZXRFcXVpcHBlZFNwZWxsKDIgLyogU3BlbGxUeXBlLlZvaWNlICovKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwZWxsID8gc3BlbGwuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlIDMgLyogU3BlbGxUeXBlLkluc3RhbnQgKi86IHtcclxuICAgICAgICAgICAgdmFyIHNwZWxsID0gYWN0b3IuZ2V0RXF1aXBwZWRTcGVsbCgzIC8qIFNwZWxsVHlwZS5JbnN0YW50ICovKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwZWxsID8gc3BlbGwuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxudmFyIGZpbHRlcldvcm4gPSBmdW5jdGlvbiAoaW52KSB7XHJcbiAgICByZXR1cm4geyBlbnRyaWVzOiBpbnYuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHgud29ybiB8fCB4Lndvcm5MZWZ0OyB9KSB9O1xyXG59O1xyXG52YXIgcmVtb3ZlVW5uZWNlc3NhcnlFeHRyYSA9IGZ1bmN0aW9uIChpbnYsIGlnbm9yZUFtbW8pIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgZW50cmllczogaW52LmVudHJpZXMubWFwKGZ1bmN0aW9uICh4KSB7XHJcbiAgICAgICAgICAgIHZhciByID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh4KSk7XHJcbiAgICAgICAgICAgIHIuY2hhcmdlUGVyY2VudCA9IHIubWF4Q2hhcmdlO1xyXG4gICAgICAgICAgICBpZiAoaWdub3JlQW1tbykge1xyXG4gICAgICAgICAgICAgICAgci5jb3VudCA9IEFtbW8uZnJvbShHYW1lLmdldEZvcm1FeCh4LmJhc2VJZCkpID8gci5jb3VudCA6IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByLmNvdW50ID0gQW1tby5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHguYmFzZUlkKSkgPyAxMDAwIDogMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkZWxldGUgci5uYW1lO1xyXG4gICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICB9KSxcclxuICAgIH07XHJcbn07XHJcbmV4cG9ydCB2YXIgZ2V0RXF1aXBtZW50ID0gZnVuY3Rpb24gKGFjLCBudW1DaGFuZ2VzKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGludjogZ2V0SW52ZW50b3J5KGFjKSxcclxuICAgICAgICBsZWZ0U3BlbGw6IGdldEVxdWlwZWRTcGVsbChhYywgMCAvKiBTcGVsbFR5cGUuTGVmdCAqLyksXHJcbiAgICAgICAgcmlnaHRTcGVsbDogZ2V0RXF1aXBlZFNwZWxsKGFjLCAxIC8qIFNwZWxsVHlwZS5SaWdodCAqLyksXHJcbiAgICAgICAgdm9pY2VTcGVsbDogZ2V0RXF1aXBlZFNwZWxsKGFjLCAyIC8qIFNwZWxsVHlwZS5Wb2ljZSAqLyksXHJcbiAgICAgICAgaW5zdGFudFNwZWxsOiBnZXRFcXVpcGVkU3BlbGwoYWMsIDMgLyogU3BlbGxUeXBlLkluc3RhbnQgKi8pLFxyXG4gICAgICAgIG51bUNoYW5nZXM6IG51bUNoYW5nZXMsXHJcbiAgICB9O1xyXG59O1xyXG5leHBvcnQgdmFyIHN5bmNTcGVsbEVxdWlwbWVudCA9IGZ1bmN0aW9uIChhYywgc3BlbGxCYXNlSWQsIHNwZWxsVHlwZSkge1xyXG4gICAgaWYgKHNwZWxsQmFzZUlkICE9PSB1bmRlZmluZWQgJiYgc3BlbGxCYXNlSWQgPiAwKSB7XHJcbiAgICAgICAgYWMuZXF1aXBTcGVsbChTcGVsbC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHNwZWxsQmFzZUlkKSksIHNwZWxsVHlwZSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICB2YXIgZXF1aXBlZFNwZWxsID0gYWMuZ2V0RXF1aXBwZWRTcGVsbChzcGVsbFR5cGUpO1xyXG4gICAgICAgIGlmIChlcXVpcGVkU3BlbGwpIHtcclxuICAgICAgICAgICAgYWMudW5lcXVpcFNwZWxsKGVxdWlwZWRTcGVsbCwgc3BlbGxUeXBlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCB2YXIgYXBwbHlFcXVpcG1lbnQgPSBmdW5jdGlvbiAoYWMsIGVxKSB7XHJcbiAgICBhYy5yZW1vdmVBbGxJdGVtcyhudWxsLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICBhYy51bmVxdWlwQWxsKCk7XHJcbiAgICBhYy5yZW1vdmVBbGxJdGVtcyhudWxsLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICB2YXIgbmV3SW52ZW50b3J5ID0gcmVtb3ZlVW5uZWNlc3NhcnlFeHRyYShmaWx0ZXJXb3JuKGVxLmludiksIGFjLmdldEZvcm1JRCgpID09PSAweDE0KTtcclxuICAgIHNldEludmVudG9yeShhYy5nZXRGb3JtSUQoKSwgbmV3SW52ZW50b3J5KTtcclxuICAgIHN5bmNTcGVsbEVxdWlwbWVudChhYywgZXEubGVmdFNwZWxsLCAwIC8qIFNwZWxsVHlwZS5MZWZ0ICovKTtcclxuICAgIHN5bmNTcGVsbEVxdWlwbWVudChhYywgZXEucmlnaHRTcGVsbCwgMSAvKiBTcGVsbFR5cGUuUmlnaHQgKi8pO1xyXG4gICAgc3luY1NwZWxsRXF1aXBtZW50KGFjLCBlcS52b2ljZVNwZWxsLCAyIC8qIFNwZWxsVHlwZS5Wb2ljZSAqLyk7XHJcbiAgICBzeW5jU3BlbGxFcXVpcG1lbnQoYWMsIGVxLmluc3RhbnRTcGVsbCwgMyAvKiBTcGVsbFR5cGUuSW5zdGFudCAqLyk7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxufTtcclxuZXhwb3J0IHZhciBpc0JhZE1lbnVTaG93biA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiAoVWkuaXNNZW51T3BlbignSW52ZW50b3J5TWVudScpIHx8XHJcbiAgICAgICAgVWkuaXNNZW51T3BlbignRmF2b3JpdGVzTWVudScpIHx8XHJcbiAgICAgICAgVWkuaXNNZW51T3BlbignTWFnaWNNZW51JykgfHxcclxuICAgICAgICBVaS5pc01lbnVPcGVuKCdDb250YWluZXJNZW51JykgfHxcclxuICAgICAgICBVaS5pc01lbnVPcGVuKCdDcmFmdGluZyBNZW51JykgLy8gQWN0dWFsbHkgSSBkb24ndCB0aGluayBpdCBjYXVzZXMgY3Jhc2hlc1xyXG4gICAgKTtcclxufTtcclxuIiwiaW1wb3J0IHsgZ2V0RXh0cmFDb250YWluZXJDaGFuZ2VzLCBnZXRDb250YWluZXIsIE9iamVjdFJlZmVyZW5jZSwgVEVTTW9kUGxhdGZvcm0sIEdhbWUsIHN0b3JhZ2UsIEVuY2hhbnRtZW50LCBQb3Rpb24sIEFjdG9yLCBBbW1vLCBwcmludENvbnNvbGUsIEZvcm0sIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbi8vICdsb3hzd29yZCAoTGVnZW5kYXJ5KScgPT4gJ2xveHN3b3JkJ1xyXG52YXIgZ2V0UmVhbE5hbWUgPSBmdW5jdGlvbiAocykge1xyXG4gICAgaWYgKCFzKSB7XHJcbiAgICAgICAgcmV0dXJuIHM7XHJcbiAgICB9XHJcbiAgICB2YXIgYXJyID0gcy5zcGxpdChcIiBcIik7XHJcbiAgICBpZiAoYXJyLmxlbmd0aCAmJiBhcnJbYXJyLmxlbmd0aCAtIDFdLm1hdGNoKC9eXFwoLipcXCkkLykpIHtcclxuICAgICAgICBhcnIucG9wKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJyLmpvaW4oXCIgXCIpO1xyXG59O1xyXG4vLyAnYWFhYWFhYWFhYWFhYWFhYScgPT4gJ2FhYS4uLidcclxudmFyIGNyb3BOYW1lID0gZnVuY3Rpb24gKHMpIHtcclxuICAgIGlmICghcykge1xyXG4gICAgICAgIHJldHVybiBzO1xyXG4gICAgfVxyXG4gICAgdmFyIG1heCA9IDEyODtcclxuICAgIHJldHVybiBzLmxlbmd0aCA+PSBtYXhcclxuICAgICAgICA/IHNcclxuICAgICAgICAgICAgLnNwbGl0KFwiXCIpXHJcbiAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKHgsIGkpIHsgcmV0dXJuIGkgPCBtYXg7IH0pXHJcbiAgICAgICAgICAgIC5qb2luKFwiXCIpXHJcbiAgICAgICAgICAgIC5jb25jYXQoXCIuLi5cIilcclxuICAgICAgICA6IHM7XHJcbn07XHJcbnZhciBjaGVja0lmTmFtZUlzR2VuZXJhdGVkQnlHYW1lID0gZnVuY3Rpb24gKGFTdHIsIGJTdHIsIGZvcm1OYW1lKSB7XHJcbiAgICBpZiAoIWFTdHIubGVuZ3RoICYmIGJTdHIuc3RhcnRzV2l0aChmb3JtTmFtZSkpIHtcclxuICAgICAgICB2YXIgYkVuZGluZyA9IGJTdHIuc3Vic3RyKGZvcm1OYW1lLmxlbmd0aCk7XHJcbiAgICAgICAgaWYgKGJFbmRpbmcubWF0Y2goL15cXHNcXCguKlxcKSQvKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn07XHJcbnZhciBuYW1lc0VxdWFsID0gZnVuY3Rpb24gKGEsIGIpIHtcclxuICAgIHZhciBhU3RyID0gYS5uYW1lIHx8IFwiXCI7XHJcbiAgICB2YXIgYlN0ciA9IGIubmFtZSB8fCBcIlwiO1xyXG4gICAgaWYgKGNyb3BOYW1lKGdldFJlYWxOYW1lKGFTdHIpKSA9PT0gY3JvcE5hbWUoZ2V0UmVhbE5hbWUoYlN0cikpKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBpZiAoYS5iYXNlSWQgPT09IGIuYmFzZUlkKSB7XHJcbiAgICAgICAgdmFyIGZvcm0gPSBHYW1lLmdldEZvcm1FeChhLmJhc2VJZCk7XHJcbiAgICAgICAgaWYgKGZvcm0pIHtcclxuICAgICAgICAgICAgdmFyIGZvcm1OYW1lID0gZm9ybS5nZXROYW1lKCk7XHJcbiAgICAgICAgICAgIGlmIChjaGVja0lmTmFtZUlzR2VuZXJhdGVkQnlHYW1lKGFTdHIsIGJTdHIsIGZvcm1OYW1lKSB8fFxyXG4gICAgICAgICAgICAgICAgY2hlY2tJZk5hbWVJc0dlbmVyYXRlZEJ5R2FtZShiU3RyLCBhU3RyLCBmb3JtTmFtZSkpXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn07XHJcbnZhciBleHRyYXNFcXVhbCA9IGZ1bmN0aW9uIChhLCBiLCBpZ25vcmVXb3JuKSB7XHJcbiAgICBpZiAoaWdub3JlV29ybiA9PT0gdm9pZCAwKSB7IGlnbm9yZVdvcm4gPSBmYWxzZTsgfVxyXG4gICAgcmV0dXJuIChhLmhlYWx0aCA9PT0gYi5oZWFsdGggJiZcclxuICAgICAgICBhLmVuY2hhbnRtZW50SWQgPT09IGIuZW5jaGFudG1lbnRJZCAmJlxyXG4gICAgICAgIGEubWF4Q2hhcmdlID09PSBiLm1heENoYXJnZSAmJlxyXG4gICAgICAgICEhYS5yZW1vdmVFbmNoYW50bWVudE9uVW5lcXVpcCA9PT0gISFiLnJlbW92ZUVuY2hhbnRtZW50T25VbmVxdWlwICYmXHJcbiAgICAgICAgYS5jaGFyZ2VQZXJjZW50ID09PSBiLmNoYXJnZVBlcmNlbnQgJiZcclxuICAgICAgICAvL25hbWVzRXF1YWwoYSwgYikgJiZcclxuICAgICAgICBhLnNvdWwgPT09IGIuc291bCAmJlxyXG4gICAgICAgIGEucG9pc29uSWQgPT09IGIucG9pc29uSWQgJiZcclxuICAgICAgICBhLnBvaXNvbkNvdW50ID09PSBiLnBvaXNvbkNvdW50ICYmXHJcbiAgICAgICAgKCghIWEud29ybiA9PT0gISFiLndvcm4gJiYgISFhLndvcm5MZWZ0ID09PSAhIWIud29ybkxlZnQpIHx8IGlnbm9yZVdvcm4pKTtcclxufTtcclxuZXhwb3J0IHZhciBoYXNFeHRyYXMgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgcmV0dXJuICFleHRyYXNFcXVhbChlLCB7IGJhc2VJZDogMCwgY291bnQ6IDAgfSk7XHJcbn07XHJcbnZhciBleHRyYWN0RXh0cmFEYXRhID0gZnVuY3Rpb24gKHJlZnIsIGV4dHJhTGlzdCwgb3V0KSB7XHJcbiAgICAvLyBJIHNlZSB0aGF0IEV4dHJhV29ybiBpcyBub3QgZW1pdHRlZCBmb3IgMHhGRiBhY3RvcnMgd2hlbiBhcnJvd3MgYXJlIGVxdWlwcGVkLiBGaXhpbmdcclxuICAgIHZhciBpdGVtID0gR2FtZS5nZXRGb3JtRXgob3V0LmJhc2VJZCk7XHJcbiAgICBpZiAoQW1tby5mcm9tKGl0ZW0pKSB7XHJcbiAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICBpZiAoYWN0b3IgJiYgYWN0b3IuaXNFcXVpcHBlZChpdGVtKSkge1xyXG4gICAgICAgICAgICBvdXQud29ybiA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgKGV4dHJhTGlzdCB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbiAoZXh0cmEpIHtcclxuICAgICAgICBzd2l0Y2ggKGV4dHJhLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBcIkhlYWx0aFwiOlxyXG4gICAgICAgICAgICAgICAgb3V0LmhlYWx0aCA9IE1hdGgucm91bmQoZXh0cmEuaGVhbHRoICogMTApIC8gMTA7XHJcbiAgICAgICAgICAgICAgICAvLyBURVNNb2RQbGF0Zm9ybTo6QWRkSXRlbUV4IG1ha2VzIGFsbCBpdGVtcyBhdCBsZWFzdCAxLjAxIGhlYWx0aFxyXG4gICAgICAgICAgICAgICAgaWYgKG91dC5oZWFsdGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3V0LmhlYWx0aDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiQ291bnRcIjpcclxuICAgICAgICAgICAgICAgIG91dC5jb3VudCA9IGV4dHJhLmNvdW50O1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJFbmNoYW50bWVudFwiOlxyXG4gICAgICAgICAgICAgICAgb3V0LmVuY2hhbnRtZW50SWQgPSBleHRyYS5lbmNoYW50bWVudElkO1xyXG4gICAgICAgICAgICAgICAgb3V0Lm1heENoYXJnZSA9IGV4dHJhLm1heENoYXJnZTtcclxuICAgICAgICAgICAgICAgIG91dC5yZW1vdmVFbmNoYW50bWVudE9uVW5lcXVpcCA9IGV4dHJhLnJlbW92ZU9uVW5lcXVpcDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiQ2hhcmdlXCI6XHJcbiAgICAgICAgICAgICAgICBvdXQuY2hhcmdlUGVyY2VudCA9IGV4dHJhLmNoYXJnZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiUG9pc29uXCI6XHJcbiAgICAgICAgICAgICAgICBvdXQucG9pc29uSWQgPSBleHRyYS5wb2lzb25JZDtcclxuICAgICAgICAgICAgICAgIG91dC5wb2lzb25Db3VudCA9IGV4dHJhLmNvdW50O1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJTb3VsXCI6XHJcbiAgICAgICAgICAgICAgICBvdXQuc291bCA9IGV4dHJhLnNvdWw7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIlRleHREaXNwbGF5RGF0YVwiOlxyXG4gICAgICAgICAgICAgICAgb3V0Lm5hbWUgPSBleHRyYS5uYW1lO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJXb3JuXCI6XHJcbiAgICAgICAgICAgICAgICBvdXQud29ybiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIldvcm5MZWZ0XCI6XHJcbiAgICAgICAgICAgICAgICBvdXQud29ybkxlZnQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcbnZhciBzcXVhc2ggPSBmdW5jdGlvbiAoaW52KSB7XHJcbiAgICB2YXIgcmVzID0gbmV3IEFycmF5KCk7XHJcbiAgICBpbnYuZW50cmllcy5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIHNhbWUgPSByZXMuZmluZChmdW5jdGlvbiAoeCkgeyByZXR1cm4gZS5iYXNlSWQgPT09IHguYmFzZUlkICYmIGV4dHJhc0VxdWFsKHgsIGUpOyB9KTtcclxuICAgICAgICBpZiAoc2FtZSkge1xyXG4gICAgICAgICAgICBzYW1lLmNvdW50ICs9IGUuY291bnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXMucHVzaChKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGUpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4geyBlbnRyaWVzOiByZXMuZmlsdGVyKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmNvdW50ICE9PSAwOyB9KSB9O1xyXG59O1xyXG52YXIgZ2V0RXh0cmFDb250YWluZXJDaGFuZ2VzQXNJbnZlbnRvcnkgPSBmdW5jdGlvbiAocmVmcikge1xyXG4gICAgdmFyIGV4dHJhQ29udGFpbmVyQ2hhbmdlcyA9IGdldEV4dHJhQ29udGFpbmVyQ2hhbmdlcyhyZWZyLmdldEZvcm1JRCgpKTtcclxuICAgIHZhciBlbnRyaWVzID0gbmV3IEFycmF5KCk7XHJcbiAgICAoZXh0cmFDb250YWluZXJDaGFuZ2VzIHx8IFtdKS5mb3JFYWNoKGZ1bmN0aW9uIChjaGFuZ2VzRW50cnkpIHtcclxuICAgICAgICB2YXIgZW50cnkgPSB7XHJcbiAgICAgICAgICAgIGJhc2VJZDogY2hhbmdlc0VudHJ5LmJhc2VJZCxcclxuICAgICAgICAgICAgY291bnQ6IGNoYW5nZXNFbnRyeS5jb3VudERlbHRhLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgKGNoYW5nZXNFbnRyeS5leHRlbmREYXRhTGlzdCB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbiAoZXh0cmFMaXN0KSB7XHJcbiAgICAgICAgICAgIHZhciBlID0ge1xyXG4gICAgICAgICAgICAgICAgYmFzZUlkOiBlbnRyeS5iYXNlSWQsXHJcbiAgICAgICAgICAgICAgICBjb3VudDogMSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgZXh0cmFjdEV4dHJhRGF0YShyZWZyLCBleHRyYUxpc3QsIGUpO1xyXG4gICAgICAgICAgICBlbnRyaWVzLnB1c2goZSk7XHJcbiAgICAgICAgICAgIGVudHJ5LmNvdW50IC09IGUuY291bnQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGVudHJ5LmNvdW50ICE9PSAwKSB7XHJcbiAgICAgICAgICAgIGVudHJpZXMucHVzaChlbnRyeSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICB2YXIgcmVzID0geyBlbnRyaWVzOiBlbnRyaWVzIH07XHJcbiAgICByZXMgPSBzcXVhc2gocmVzKTtcclxuICAgIHJldHVybiByZXM7XHJcbn07XHJcbnZhciBnZXRCYXNlQ29udGFpbmVyQXNJbnZlbnRvcnkgPSBmdW5jdGlvbiAocmVmcikge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBlbnRyaWVzOiBnZXRDb250YWluZXIocmVmci5nZXRCYXNlT2JqZWN0KCkuZ2V0Rm9ybUlEKCkpLFxyXG4gICAgfTtcclxufTtcclxuZXhwb3J0IHZhciBzdW1JbnZlbnRvcmllcyA9IGZ1bmN0aW9uIChsaHMsIHJocykge1xyXG4gICAgdmFyIGxlZnRFbnRyaWVzV2l0aEV4dHJhcyA9IGxocy5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoZSkgeyByZXR1cm4gaGFzRXh0cmFzKGUpOyB9KTtcclxuICAgIHZhciByaWdodEVudHJpZXNXaXRoRXh0cmFzID0gcmhzLmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uIChlKSB7IHJldHVybiBoYXNFeHRyYXMoZSk7IH0pO1xyXG4gICAgdmFyIGxlZnRFbnRyaWVzU2ltcGxlID0gbGhzLmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uIChlKSB7IHJldHVybiAhaGFzRXh0cmFzKGUpOyB9KTtcclxuICAgIHZhciByaWdodEVudHJpZXNTaW1wbGUgPSByaHMuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuICFoYXNFeHRyYXMoZSk7IH0pO1xyXG4gICAgbGVmdEVudHJpZXNTaW1wbGUuZm9yRWFjaChmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBtYXRjaGluZyA9IHJpZ2h0RW50cmllc1NpbXBsZS5maW5kKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmJhc2VJZCA9PT0gZS5iYXNlSWQ7IH0pO1xyXG4gICAgICAgIGlmIChtYXRjaGluZykge1xyXG4gICAgICAgICAgICBlLmNvdW50ICs9IG1hdGNoaW5nLmNvdW50O1xyXG4gICAgICAgICAgICBtYXRjaGluZy5jb3VudCA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGVudHJpZXM6IGxlZnRFbnRyaWVzV2l0aEV4dHJhc1xyXG4gICAgICAgICAgICAuY29uY2F0KHJpZ2h0RW50cmllc1dpdGhFeHRyYXMpXHJcbiAgICAgICAgICAgIC5jb25jYXQobGVmdEVudHJpZXNTaW1wbGUpXHJcbiAgICAgICAgICAgIC5jb25jYXQocmlnaHRFbnRyaWVzU2ltcGxlKVxyXG4gICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChlKSB7IHJldHVybiBlLmNvdW50ICE9PSAwOyB9KSxcclxuICAgIH07XHJcbn07XHJcbmV4cG9ydCB2YXIgcmVtb3ZlU2ltcGxlSXRlbXNBc01hbnlBc1Bvc3NpYmxlID0gZnVuY3Rpb24gKGludiwgYmFzZUlkLCBjb3VudCkge1xyXG4gICAgdmFyIHJlcyA9IHsgZW50cmllczogW10gfTtcclxuICAgIHJlcy5lbnRyaWVzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShpbnYuZW50cmllcykpO1xyXG4gICAgdmFyIGVudHJ5ID0gcmVzLmVudHJpZXMuZmluZChmdW5jdGlvbiAoZSkgeyByZXR1cm4gIWhhc0V4dHJhcyhlKSAmJiBlLmJhc2VJZCA9PT0gYmFzZUlkOyB9KTtcclxuICAgIGlmIChlbnRyeSkge1xyXG4gICAgICAgIGVudHJ5LmNvdW50IC09IGNvdW50O1xyXG4gICAgfVxyXG4gICAgcmVzLmVudHJpZXMgPSByZXMuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGUuY291bnQgPiAwOyB9KTtcclxuICAgIHJldHVybiByZXM7XHJcbn07XHJcbmV4cG9ydCB2YXIgZ2V0RGlmZiA9IGZ1bmN0aW9uIChsaHMsIHJocywgaWdub3JlV29ybikge1xyXG4gICAgdmFyIGxoc0NvcHkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGxocykpO1xyXG4gICAgdmFyIHJoc0NvcHkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJocykpO1xyXG4gICAgcmhzQ29weS5lbnRyaWVzLmZvckVhY2goZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgc2FtZUZyb21MZWZ0ID0gbGhzQ29weS5lbnRyaWVzLmZpbmQoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguYmFzZUlkID09PSBlLmJhc2VJZCAmJiBleHRyYXNFcXVhbCh4LCBlLCBpZ25vcmVXb3JuKTsgfSk7XHJcbiAgICAgICAgaWYgKHNhbWVGcm9tTGVmdCkge1xyXG4gICAgICAgICAgICBzYW1lRnJvbUxlZnQuY291bnQgLT0gZS5jb3VudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxoc0NvcHkuZW50cmllcy5wdXNoKGUpO1xyXG4gICAgICAgICAgICBsaHNDb3B5LmVudHJpZXNbbGhzQ29weS5lbnRyaWVzLmxlbmd0aCAtIDFdLmNvdW50ICo9IC0xO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHsgZW50cmllczogbGhzQ29weS5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5jb3VudCAhPT0gMDsgfSkgfTtcclxufTtcclxuZXhwb3J0IHZhciBnZXRJbnZlbnRvcnkgPSBmdW5jdGlvbiAocmVmcikge1xyXG4gICAgcmV0dXJuIHNxdWFzaChzdW1JbnZlbnRvcmllcyhnZXRCYXNlQ29udGFpbmVyQXNJbnZlbnRvcnkocmVmciksIGdldEV4dHJhQ29udGFpbmVyQ2hhbmdlc0FzSW52ZW50b3J5KHJlZnIpKSk7XHJcbn07XHJcbnZhciBiYXNlc1Jlc2V0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKHN0b3JhZ2VbXCJiYXNlc1Jlc2V0RXhpc3RzXCJdICE9PSB0cnVlKSB7XHJcbiAgICAgICAgc3RvcmFnZVtcImJhc2VzUmVzZXRFeGlzdHNcIl0gPSB0cnVlO1xyXG4gICAgICAgIHN0b3JhZ2VbXCJiYXNlc1Jlc2V0XCJdID0gbmV3IFNldCgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0b3JhZ2VbXCJiYXNlc1Jlc2V0XCJdO1xyXG59O1xyXG52YXIgcmVzZXRCYXNlID0gZnVuY3Rpb24gKHJlZnIpIHtcclxuICAgIHZhciBiYXNlID0gcmVmci5nZXRCYXNlT2JqZWN0KCk7XHJcbiAgICB2YXIgYmFzZUlkID0gYmFzZSA/IGJhc2UuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgaWYgKCFiYXNlc1Jlc2V0KCkuaGFzKGJhc2VJZCkpIHtcclxuICAgICAgICBiYXNlc1Jlc2V0KCkuYWRkKGJhc2VJZCk7XHJcbiAgICAgICAgVEVTTW9kUGxhdGZvcm0ucmVzZXRDb250YWluZXIoYmFzZSk7XHJcbiAgICAgICAgcmVmci5yZW1vdmVBbGxJdGVtcyhudWxsLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCB2YXIgYXBwbHlJbnZlbnRvcnkgPSBmdW5jdGlvbiAocmVmciwgbmV3SW52ZW50b3J5LCBlbmFibGVDcmFzaFByb3RlY3Rpb24sIGlnbm9yZVdvcm4pIHtcclxuICAgIGlmIChpZ25vcmVXb3JuID09PSB2b2lkIDApIHsgaWdub3JlV29ybiA9IGZhbHNlOyB9XHJcbiAgICByZXNldEJhc2UocmVmcik7XHJcbiAgICB2YXIgZGlmZiA9IGdldERpZmYobmV3SW52ZW50b3J5LCBnZXRJbnZlbnRvcnkocmVmciksIGlnbm9yZVdvcm4pLmVudHJpZXM7XHJcbiAgICB2YXIgcmVzID0gdHJ1ZTtcclxuICAgIGRpZmYuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gKGEuY291bnQgPCBiLmNvdW50ID8gLTEgOiAxKTsgfSk7XHJcbiAgICBkaWZmLmZvckVhY2goZnVuY3Rpb24gKGUsIGkpIHtcclxuICAgICAgICBpZiAoaSA+IDAgJiYgZW5hYmxlQ3Jhc2hQcm90ZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIHJlcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhYnNDb3VudCA9IE1hdGguYWJzKGUuY291bnQpO1xyXG4gICAgICAgIHZhciBxdWV1ZU5pTm9kZVVwZGF0ZU5lZWRlZCA9IGZhbHNlO1xyXG4gICAgICAgIHZhciB3b3JuID0gISFlLndvcm47XHJcbiAgICAgICAgdmFyIHdvcm5MZWZ0ID0gISFlLndvcm5MZWZ0O1xyXG4gICAgICAgIHZhciBvbmVTdGVwQ291bnQgPSBlLmNvdW50IC8gYWJzQ291bnQ7XHJcbiAgICAgICAgdmFyIGYgPSBHYW1lLmdldEZvcm1FeChlLmJhc2VJZCk7XHJcbiAgICAgICAgaWYgKCFmKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmludENvbnNvbGUoXCJCYWQgZm9ybSBJRCBcIi5jb25jYXQoZS5iYXNlSWQudG9TdHJpbmcoMTYpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0eXBlID0gZi5nZXRUeXBlKCk7XHJcbiAgICAgICAgLy8gRm9yIG1pc2MgaXRlbXMsIHBvdGlvbnMgYW5kIGluZ3JlZGllbnRzIHdlIGRvbid0IHdhbnQgdG8gc3BsaXQgdGhlbSBpbnRvIG11bHRpcGxlIGl0ZW1zXHJcbiAgICAgICAgLy8gVGhpcyB3YXMgbWFkZSB0byBmaXggYSBwZXJmb3JtYW5jZSBpc3N1ZSB3aXRoIHVzZXJzIGhhdmluZyAxMDAwMCsgb2YgbWlzYyBpdGVtcyAoaS5lLiBnb2xkKVxyXG4gICAgICAgIGlmICh0eXBlID09PSAzMiAvKiBGb3JtVHlwZS5NaXNjICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDQ2IC8qIEZvcm1UeXBlLlBvdGlvbiAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAzMCAvKiBGb3JtVHlwZS5JbmdyZWRpZW50ICovKSB7XHJcbiAgICAgICAgICAgIGFic0NvdW50ID0gMTtcclxuICAgICAgICAgICAgb25lU3RlcENvdW50ID0gZS5jb3VudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChhYnNDb3VudCA+IDEwMDApIHtcclxuICAgICAgICAgICAgICAgIGFic0NvdW50ID0gMTtcclxuICAgICAgICAgICAgICAgIG9uZVN0ZXBDb3VudCA9IDE7XHJcbiAgICAgICAgICAgICAgICAvLyBBbHNvIGZvciBhcnJvd3Mgd2l0aCBzdHJhbmdlIGNvdW50XHJcbiAgICAgICAgICAgICAgICBpZiAod29ybiAmJiBlLmNvdW50IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFic0NvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZS5jb3VudCA+IDEgJiYgQW1tby5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGUuYmFzZUlkKSkpIHtcclxuICAgICAgICAgICAgICAgIGFic0NvdW50ID0gMTtcclxuICAgICAgICAgICAgICAgIG9uZVN0ZXBDb3VudCA9IGUuY291bnQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoZS5jb3VudCA+IDYwMDAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gV2h5IHdvdWxkIGFjdG9yIGhhdmUgNjBrIGFycm93cz9cclxuICAgICAgICAgICAgICAgICAgICBlLmNvdW50ID0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBpXzEgPSAwOyBpXzEgPCBhYnNDb3VudDsgKytpXzEpIHtcclxuICAgICAgICAgICAgaWYgKHdvcm4gfHwgd29ybkxlZnQpIHtcclxuICAgICAgICAgICAgICAgIFRFU01vZFBsYXRmb3JtLnB1c2hXb3JuU3RhdGUoISF3b3JuLCAhIXdvcm5MZWZ0KTtcclxuICAgICAgICAgICAgICAgIHF1ZXVlTmlOb2RlVXBkYXRlTmVlZGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgYWRkSXRlbUV4QXJncyA9IHZvaWQgMDtcclxuICAgICAgICAgICAgYWRkSXRlbUV4QXJncyA9IFtcclxuICAgICAgICAgICAgICAgIHJlZnIsXHJcbiAgICAgICAgICAgICAgICBmLFxyXG4gICAgICAgICAgICAgICAgb25lU3RlcENvdW50LFxyXG4gICAgICAgICAgICAgICAgZS5oZWFsdGggPyBlLmhlYWx0aCA6IDEsXHJcbiAgICAgICAgICAgICAgICBlLmVuY2hhbnRtZW50SWRcclxuICAgICAgICAgICAgICAgICAgICA/IEVuY2hhbnRtZW50LmZyb20oR2FtZS5nZXRGb3JtRXgoZS5lbmNoYW50bWVudElkKSlcclxuICAgICAgICAgICAgICAgICAgICA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBlLm1heENoYXJnZSA/IGUubWF4Q2hhcmdlIDogMCxcclxuICAgICAgICAgICAgICAgICEhZS5yZW1vdmVFbmNoYW50bWVudE9uVW5lcXVpcCxcclxuICAgICAgICAgICAgICAgIGUuY2hhcmdlUGVyY2VudCA/IGUuY2hhcmdlUGVyY2VudCA6IDAsXHJcbiAgICAgICAgICAgICAgICBlLm5hbWUgPyBjcm9wTmFtZShlLm5hbWUpIDogZi5nZXROYW1lKCksXHJcbiAgICAgICAgICAgICAgICBlLnNvdWwgPyBlLnNvdWwgOiAwLFxyXG4gICAgICAgICAgICAgICAgZS5wb2lzb25JZCA/IFBvdGlvbi5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGUucG9pc29uSWQpKSA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBlLnBvaXNvbkNvdW50ID8gZS5wb2lzb25Db3VudCA6IDBcclxuICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgdmFyIGFyZ3NUb1ByaW50ID0gYWRkSXRlbUV4QXJncy5tYXAoZnVuY3Rpb24gKGFyZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIE9iamVjdFJlZmVyZW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcIk9iamVjdFJlZmVyZW5jZShcIi5jb25jYXQoYXJnLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSwgXCIpXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRm9ybSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcIkZvcm0oXCIuY29uY2F0KGFyZy5nZXRGb3JtSUQoKS50b1N0cmluZygxNiksIFwiKVwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcmcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiVEVTTW9kUGxhdGZvcm0uYWRkSXRlbUV4KFwiLmNvbmNhdChhcmdzVG9QcmludC5qb2luKFwiLCBcIiksIFwiKVwiKSk7XHJcbiAgICAgICAgICAgIFRFU01vZFBsYXRmb3JtLmFkZEl0ZW1FeC5hcHBseShURVNNb2RQbGF0Zm9ybSwgYWRkSXRlbUV4QXJncyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChxdWV1ZU5pTm9kZVVwZGF0ZU5lZWRlZCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgICAgIGFjLnF1ZXVlTmlOb2RlVXBkYXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiByZXM7XHJcbn07XHJcbiIsImltcG9ydCB7IEFjdG9yLCBHYW1lLCBURVNNb2RQbGF0Zm9ybSwgRGVidWcgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgUmVzcGF3bk5lZWRlZEVycm9yIH0gZnJvbSBcIi4uL2xpYi9lcnJvcnNcIjtcclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tIFwiLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeFwiO1xyXG5pbXBvcnQgeyBTcEFwaUludGVyYWN0b3IgfSBmcm9tIFwiLi4vc2VydmljZXMvc3BBcGlJbnRlcmFjdG9yXCI7XHJcbnZhciBzcXIgPSBmdW5jdGlvbiAoeCkgeyByZXR1cm4geCAqIHg7IH07XHJcbmV4cG9ydCB2YXIgYXBwbHlNb3ZlbWVudCA9IGZ1bmN0aW9uIChyZWZyLCBtLCBpc015Q2xvbmUpIHtcclxuICAgIGlmICh0ZWxlcG9ydElmTmVlZChyZWZyLCBtKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIFogYXhpcyBpc24ndCB1c2VmdWwgaGVyZVxyXG4gICAgdmFyIGFjWCA9IHJlZnIuZ2V0UG9zaXRpb25YKCk7XHJcbiAgICB2YXIgYWNZID0gcmVmci5nZXRQb3NpdGlvblkoKTtcclxuICAgIHZhciBsYWdVbml0c05vWiA9IE1hdGgucm91bmQoTWF0aC5zcXJ0KHNxcihtLnBvc1swXSAtIGFjWCkgKyBzcXIobS5wb3NbMV0gLSBhY1kpKSk7XHJcbiAgICBpZiAoaXNNeUNsb25lID09PSB0cnVlKSB7XHJcbiAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmVtaXR0ZXIuZW1pdChcIm5ld0xvY2FsTGFnVmFsdWVDYWxjdWxhdGVkXCIsIHsgbGFnVW5pdHNOb1o6IGxhZ1VuaXRzTm9aIH0pO1xyXG4gICAgfVxyXG4gICAgdHJhbnNsYXRlVG8ocmVmciwgbSk7XHJcbiAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgaWYgKCFhYykge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciBsb29rQXQgPSBudWxsO1xyXG4gICAgaWYgKG0ubG9va0F0KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbG9va0F0ID0gR2FtZS5maW5kQ2xvc2VzdEFjdG9yKG0ubG9va0F0WzBdLCBtLmxvb2tBdFsxXSwgbS5sb29rQXRbMl0sIDEyOCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGxvb2tBdCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGxvb2tBdCkge1xyXG4gICAgICAgIGFjLnNldEhlYWRUcmFja2luZyh0cnVlKTtcclxuICAgICAgICBhYy5zZXRMb29rQXQobG9va0F0LCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBhYy5zZXRIZWFkVHJhY2tpbmcoZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgLy8gYWMuc3RvcENvbWJhdCgpO1xyXG4gICAgYWMuYmxvY2tBY3RpdmF0aW9uKHRydWUpO1xyXG4gICAga2VlcE9mZnNldEZyb21BY3RvcihhYywgbSk7XHJcbiAgICBhcHBseVNwcmludGluZyhhYywgbS5ydW5Nb2RlID09PSBcIlNwcmludGluZ1wiKTtcclxuICAgIGFwcGx5QmxvY2tpbmcoYWMsIG0pO1xyXG4gICAgYXBwbHlTbmVha2luZyhhYywgbS5pc1NuZWFraW5nKTtcclxuICAgIGFwcGx5V2VhcERyYXduKGFjLCBtLmlzV2VhcERyYXduKTtcclxuICAgIGFwcGx5SGVhbHRoUGVyY2VudGFnZShhYywgbS5oZWFsdGhQZXJjZW50YWdlKTtcclxuICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5lbWl0dGVyLmVtaXQoXCJhcHBseURlYXRoU3RhdGVFdmVudFwiLCB7IGFjdG9yOiBhYywgaXNEZWFkOiBtLmlzRGVhZCB9KTtcclxufTtcclxudmFyIGtlZXBPZmZzZXRGcm9tQWN0b3IgPSBmdW5jdGlvbiAoYWMsIG0pIHtcclxuICAgIHZhciBvZmZzZXRBbmdsZSA9IG0ucm90WzJdIC0gYWMuZ2V0QW5nbGVaKCk7XHJcbiAgICBpZiAoTWF0aC5hYnMob2Zmc2V0QW5nbGUpIDwgNSkge1xyXG4gICAgICAgIG9mZnNldEFuZ2xlID0gMDtcclxuICAgIH1cclxuICAgIGlmIChtLnJ1bk1vZGUgPT09IFwiU3RhbmRpbmdcIikge1xyXG4gICAgICAgIHJldHVybiBhYy5rZWVwT2Zmc2V0RnJvbUFjdG9yKGFjLCAwLCAwLCAwLCAwLCAwLCBvZmZzZXRBbmdsZSwgMSwgMSk7XHJcbiAgICB9XHJcbiAgICB2YXIgb2Zmc2V0ID0gW1xyXG4gICAgICAgIDMgKiBNYXRoLnNpbigobS5kaXJlY3Rpb24gLyAxODApICogTWF0aC5QSSksXHJcbiAgICAgICAgMyAqIE1hdGguY29zKChtLmRpcmVjdGlvbiAvIDE4MCkgKiBNYXRoLlBJKSxcclxuICAgICAgICBnZXRPZmZzZXRaKG0ucnVuTW9kZSksXHJcbiAgICBdO1xyXG4gICAgYWMua2VlcE9mZnNldEZyb21BY3RvcihhYywgb2Zmc2V0WzBdLCBvZmZzZXRbMV0sIG9mZnNldFsyXSwgMCwgMCwgb2Zmc2V0QW5nbGUsIG0ucnVuTW9kZSA9PT0gXCJXYWxraW5nXCIgPyAyMDQ4IDogMSwgMSk7XHJcbn07XHJcbnZhciBnZXRPZmZzZXRaID0gZnVuY3Rpb24gKHJ1bk1vZGUpIHtcclxuICAgIHN3aXRjaCAocnVuTW9kZSkge1xyXG4gICAgICAgIGNhc2UgXCJXYWxraW5nXCI6XHJcbiAgICAgICAgICAgIHJldHVybiAtNTEyO1xyXG4gICAgICAgIGNhc2UgXCJSdW5uaW5nXCI6XHJcbiAgICAgICAgICAgIHJldHVybiAtMTAyNDtcclxuICAgIH1cclxuICAgIHJldHVybiAwO1xyXG59O1xyXG52YXIgYXBwbHlTcHJpbnRpbmcgPSBmdW5jdGlvbiAoYWMsIGlzU3ByaW50aW5nKSB7XHJcbiAgICBpZiAoYWMuaXNTcHJpbnRpbmcoKSAhPSBpc1NwcmludGluZykge1xyXG4gICAgICAgIERlYnVnLnNlbmRBbmltYXRpb25FdmVudChhYywgaXNTcHJpbnRpbmcgPyBcIlNwcmludFN0YXJ0XCIgOiBcIlNwcmludFN0b3BcIik7XHJcbiAgICB9XHJcbn07XHJcbnZhciBhcHBseUJsb2NraW5nID0gZnVuY3Rpb24gKGFjLCBtKSB7XHJcbiAgICBpZiAoYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNCbG9ja2luZ1wiKSAhPSBtLmlzQmxvY2tpbmcpIHtcclxuICAgICAgICBEZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQoYWMsIG0uaXNCbG9ja2luZyA/IFwiQmxvY2tTdGFydFwiIDogXCJCbG9ja1N0b3BcIik7XHJcbiAgICAgICAgRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KGFjLCBtLmlzU25lYWtpbmcgPyBcIlNuZWFrU3RhcnRcIiA6IFwiU25lYWtTdG9wXCIpO1xyXG4gICAgfVxyXG59O1xyXG52YXIgYXBwbHlTbmVha2luZyA9IGZ1bmN0aW9uIChhYywgaXNTbmVha2luZykge1xyXG4gICAgdmFyIGN1cnJlbnRJc1NuZWFraW5nID0gYWMuaXNTbmVha2luZygpIHx8IGFjLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzU25lYWtpbmdcIik7XHJcbiAgICBpZiAoY3VycmVudElzU25lYWtpbmcgIT0gaXNTbmVha2luZykge1xyXG4gICAgICAgIERlYnVnLnNlbmRBbmltYXRpb25FdmVudChhYywgaXNTbmVha2luZyA/IFwiU25lYWtTdGFydFwiIDogXCJTbmVha1N0b3BcIik7XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCB2YXIgYXBwbHlXZWFwRHJhd24gPSBmdW5jdGlvbiAoYWMsIGlzV2VhcERyYXduKSB7XHJcbiAgICBpZiAoYWMuaXNXZWFwb25EcmF3bigpICE9PSBpc1dlYXBEcmF3bikge1xyXG4gICAgICAgIFRFU01vZFBsYXRmb3JtLnNldFdlYXBvbkRyYXduTW9kZShhYywgaXNXZWFwRHJhd24gPyAxIDogMCk7XHJcbiAgICB9XHJcbn07XHJcbnZhciBhcHBseUhlYWx0aFBlcmNlbnRhZ2UgPSBmdW5jdGlvbiAoYWMsIGhlYWx0aFBlcmNlbnRhZ2UpIHtcclxuICAgIHZhciBjdXJyZW50UGVyY2VudGFnZSA9IGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKCdoZWFsdGgnKTtcclxuICAgIGlmIChjdXJyZW50UGVyY2VudGFnZSA9PT0gaGVhbHRoUGVyY2VudGFnZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciBjdXJyZW50TWF4ID0gYWMuZ2V0QmFzZUFjdG9yVmFsdWUoJ2hlYWx0aCcpO1xyXG4gICAgdmFyIGRlbHRhUGVyY2VudGFnZSA9IGhlYWx0aFBlcmNlbnRhZ2UgLSBjdXJyZW50UGVyY2VudGFnZTtcclxuICAgIHZhciBrID0gMC4yNTtcclxuICAgIGlmIChkZWx0YVBlcmNlbnRhZ2UgPiAwKSB7XHJcbiAgICAgICAgYWMucmVzdG9yZUFjdG9yVmFsdWUoJ2hlYWx0aCcsIGRlbHRhUGVyY2VudGFnZSAqIGN1cnJlbnRNYXggKiBrKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKGRlbHRhUGVyY2VudGFnZSA8IDApIHtcclxuICAgICAgICBhYy5kYW1hZ2VBY3RvclZhbHVlKCdoZWFsdGgnLCBkZWx0YVBlcmNlbnRhZ2UgKiBjdXJyZW50TWF4ICogayk7XHJcbiAgICB9XHJcbn07XHJcbi8vIFVzZSBnbG9iYWwgdGVtcCB2YXIgdG8gYXZvaWQgYWxsb2NhdGlvbiBvZiBhbiBhcnJheSBvbiBlYWNoIHRyYW5zbGF0ZVRvXHJcbnZhciBnVGVtcFRhcmdldFBvcyA9IFswLCAwLCAwXTtcclxudmFyIHRyYW5zbGF0ZVRvID0gZnVuY3Rpb24gKHJlZnIsIG0pIHtcclxuICAgIHZhciBfYTtcclxuICAgIHZhciB0aW1lID0gMC4yO1xyXG4gICAgaWYgKG0uaXNJbkp1bXBTdGF0ZSB8fCBtLnJ1bk1vZGUgIT09IFwiU3RhbmRpbmdcIikge1xyXG4gICAgICAgIHRpbWUgPSAwLjI7XHJcbiAgICB9XHJcbiAgICAvLyBMb2NhbCBsYWcgY29tcGVuc2F0aW9uXHJcbiAgICAvLyBUT0RPOiBSZW1vdmUgXCJ8fCAwXCIgaGFjayAoYWRkZWQgdG8gc3VwcG9ydCBvbGQgTXBDbGllbnRQbHVnaW4pXHJcbiAgICB2YXIgZGlzdGFuY2VBZGQgPSAobS5zcGVlZCB8fCAwKSAqIHRpbWU7XHJcbiAgICB2YXIgZGlyZWN0aW9uID0gbS5yb3RbMl0gKyBtLmRpcmVjdGlvbjtcclxuICAgIGdUZW1wVGFyZ2V0UG9zWzBdID0gbS5wb3NbMF07XHJcbiAgICBnVGVtcFRhcmdldFBvc1sxXSA9IG0ucG9zWzFdO1xyXG4gICAgZ1RlbXBUYXJnZXRQb3NbMl0gPSBtLnBvc1syXTtcclxuICAgIC8vIFdlIGRvIG5vdCB3YW50IHRvIGFkZCBwb3MgaW4gY2FzZSBvZiBzdGFuZGluZy1qdW1waW5nXHJcbiAgICBpZiAobS5ydW5Nb2RlICE9PSBcIlN0YW5kaW5nXCIpIHtcclxuICAgICAgICBnVGVtcFRhcmdldFBvc1swXSArPSBNYXRoLnNpbihkaXJlY3Rpb24gLyAxODAgKiBNYXRoLlBJKSAqIGRpc3RhbmNlQWRkO1xyXG4gICAgICAgIGdUZW1wVGFyZ2V0UG9zWzFdICs9IE1hdGguY29zKGRpcmVjdGlvbiAvIDE4MCAqIE1hdGguUEkpICogZGlzdGFuY2VBZGQ7XHJcbiAgICB9XHJcbiAgICB2YXIgcmVmclJlYWxQb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MocmVmcik7XHJcbiAgICB2YXIgZGlzdGFuY2UgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZShyZWZyUmVhbFBvcywgZ1RlbXBUYXJnZXRQb3MpO1xyXG4gICAgdmFyIHNwZWVkID0gZGlzdGFuY2UgLyB0aW1lO1xyXG4gICAgdmFyIGFuZ2xlRGlmZiA9IE1hdGguYWJzKG0ucm90WzJdIC0gcmVmci5nZXRBbmdsZVooKSk7XHJcbiAgICBpZiAobS5ydW5Nb2RlICE9PSBcIlN0YW5kaW5nXCIgfHxcclxuICAgICAgICBtLmlzSW5KdW1wU3RhdGUgfHxcclxuICAgICAgICBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZU5vWihyZWZyUmVhbFBvcywgZ1RlbXBUYXJnZXRQb3MpID4gOCB8fFxyXG4gICAgICAgIGFuZ2xlRGlmZiA+IDgwIHx8XHJcbiAgICAgICAgKChfYSA9IEFjdG9yLmZyb20ocmVmcikpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRTaXRTdGF0ZSgpKSA9PT0gMykge1xyXG4gICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgaWYgKGFjdG9yICYmIGFjdG9yLmdldEFjdG9yVmFsdWUoXCJWYXJpYWJsZTEwXCIpIDwgLTk5OSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghYWN0b3IgfHwgIWFjdG9yLmlzRGVhZCgpKSB7XHJcbiAgICAgICAgICAgIHJlZnIudHJhbnNsYXRlVG8oZ1RlbXBUYXJnZXRQb3NbMF0sIGdUZW1wVGFyZ2V0UG9zWzFdLCBnVGVtcFRhcmdldFBvc1syXSwgbS5yb3RbMF0sIG0ucm90WzFdLCBtLnJvdFsyXSwgc3BlZWQsIDApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxudmFyIHRlbGVwb3J0SWZOZWVkID0gZnVuY3Rpb24gKHJlZnIsIG0pIHtcclxuICAgIGlmIChpc0luRGlmZmVyZW50V29ybGRPckNlbGwocmVmciwgbS53b3JsZE9yQ2VsbCkgfHxcclxuICAgICAgICAoIXJlZnIuaXMzRExvYWRlZCgpICYmIGlzSW5EaWZmZXJlbnRFeHRlcmlvckNlbGwocmVmciwgbS5wb3MpKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBSZXNwYXduTmVlZGVkRXJyb3IoXCJuZWVkcyB0byBiZSByZXNwYXduZWRcIik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn07XHJcbnZhciBjZWxsV2lkdGggPSA0MDk2O1xyXG52YXIgaXNJbkRpZmZlcmVudEV4dGVyaW9yQ2VsbCA9IGZ1bmN0aW9uIChyZWZyLCBwb3MpIHtcclxuICAgIHZhciBjdXJyZW50UG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKHJlZnIpO1xyXG4gICAgdmFyIHBsYXllclBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhHYW1lLmdldFBsYXllcigpKTtcclxuICAgIHZhciB0YXJnZXREaXN0YW5jZVRvUGxheWVyID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2UocGxheWVyUG9zLCBwb3MpO1xyXG4gICAgdmFyIGN1cnJlbnREaXN0YW5jZVRvUGxheWVyID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2UocGxheWVyUG9zLCBjdXJyZW50UG9zKTtcclxuICAgIHJldHVybiBjdXJyZW50RGlzdGFuY2VUb1BsYXllciA+IGNlbGxXaWR0aCAmJiB0YXJnZXREaXN0YW5jZVRvUGxheWVyIDw9IGNlbGxXaWR0aDtcclxufTtcclxudmFyIGlzSW5EaWZmZXJlbnRXb3JsZE9yQ2VsbCA9IGZ1bmN0aW9uIChyZWZyLCB3b3JsZE9yQ2VsbCkge1xyXG4gICAgcmV0dXJuIHdvcmxkT3JDZWxsICE9PSBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbChyZWZyKTtcclxufTtcclxuIiwiaW1wb3J0IHsgQWN0b3IsIFRFU01vZFBsYXRmb3JtIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSAnLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeCc7XHJcbnZhciBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IoKSB7XHJcbiAgICB9XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3Iuc2F2ZVBvc2l0aW9uID0gZnVuY3Rpb24gKHBvcywgd29ybGRPckNlbGwpIHtcclxuICAgICAgICB0aGlzLmxhc3RQY1BvcyA9IHBvcztcclxuICAgICAgICB0aGlzLmxhc3RQY1Bvc0NoZWNrID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmxhc3RQY1dvcmxkT3JDZWxsID0gd29ybGRPckNlbGw7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLmdldFNwZWVkID0gZnVuY3Rpb24gKGN1cnJlbnRQb3MsIHdvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgaWYgKHRoaXMubGFzdFBjUG9zQ2hlY2sgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdGltZURlbHRhU2VjID0gKERhdGUubm93KCkgLSB0aGlzLmxhc3RQY1Bvc0NoZWNrKSAvIDEwMDA7XHJcbiAgICAgICAgaWYgKHRpbWVEZWx0YVNlYyA+IDUpXHJcbiAgICAgICAgICAgIHJldHVybiAwOyAvLyBUb28gaW5hY2N1cmF0ZVxyXG4gICAgICAgIGlmICh0aW1lRGVsdGFTZWMgPT09IDApXHJcbiAgICAgICAgICAgIHJldHVybiAwOyAvLyBEaXZpc2lvbiBieSB6ZXJvXHJcbiAgICAgICAgaWYgKHdvcmxkT3JDZWxsICE9PSB0aGlzLmxhc3RQY1dvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZGlzdGFuY2UgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZShjdXJyZW50UG9zLCB0aGlzLmxhc3RQY1Bvcyk7XHJcbiAgICAgICAgcmV0dXJuIGRpc3RhbmNlIC8gdGltZURlbHRhU2VjO1xyXG4gICAgfTtcclxuICAgIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5sYXN0UGNQb3MgPSBbMCwgMCwgMF07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IubGFzdFBjUG9zQ2hlY2sgPSAtMTtcclxuICAgIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5sYXN0UGNXb3JsZE9yQ2VsbCA9IDA7XHJcbiAgICByZXR1cm4gUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yO1xyXG59KCkpO1xyXG5leHBvcnQgdmFyIGdldE1vdmVtZW50ID0gZnVuY3Rpb24gKHJlZnIsIGZvcm0pIHtcclxuICAgIHZhciBfYTtcclxuICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAvLyBJdCBpcyBydW5uaW5nIGZvciBPYmplY3RSZWZlcmVuY2VzIGJlY2F1c2UgU3RhbmRpbmdcclxuICAgIC8vIERvZXNuJ3QgbGVhZCB0byB0cmFuc2xhdGVUbyBjYWxsXHJcbiAgICB2YXIgcnVuTW9kZSA9IGFjID8gZ2V0UnVuTW9kZShhYykgOiBcIlJ1bm5pbmdcIjtcclxuICAgIHZhciBoZWFsdGhQZXJjZW50YWdlID0gYWMgJiYgYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoXCJoZWFsdGhcIik7XHJcbiAgICBpZiAoYWMgJiYgYWMuaXNEZWFkKCkpIHtcclxuICAgICAgICBoZWFsdGhQZXJjZW50YWdlID0gMDtcclxuICAgIH1cclxuICAgIHZhciBsb29rQXQgPSB1bmRlZmluZWQ7XHJcbiAgICBpZiAocmVmci5nZXRGb3JtSUQoKSAhPT0gMHgxNCkge1xyXG4gICAgICAgIHZhciBjb21iYXRUYXJnZXQgPSBhYyA9PT0gbnVsbCB8fCBhYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWMuZ2V0Q29tYmF0VGFyZ2V0KCk7XHJcbiAgICAgICAgaWYgKGNvbWJhdFRhcmdldCkge1xyXG4gICAgICAgICAgICBsb29rQXQgPSBbXHJcbiAgICAgICAgICAgICAgICBjb21iYXRUYXJnZXQuZ2V0UG9zaXRpb25YKCksXHJcbiAgICAgICAgICAgICAgICBjb21iYXRUYXJnZXQuZ2V0UG9zaXRpb25ZKCksXHJcbiAgICAgICAgICAgICAgICBjb21iYXRUYXJnZXQuZ2V0UG9zaXRpb25aKCksXHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdmFyIHBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhyZWZyKTtcclxuICAgIHZhciBzcGVlZDtcclxuICAgIGlmIChyZWZyLmdldEZvcm1JRCgpICE9PSAweDE0KSB7XHJcbiAgICAgICAgc3BlZWQgPSByZWZyLmdldEFuaW1hdGlvblZhcmlhYmxlRmxvYXQoXCJTcGVlZFNhbXBsZWRcIik7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICAvLyBSZWFsIHBsYXllcnMgb2Z0ZW4gcnVuIGludG8gdGhlIHdhbGwuXHJcbiAgICAgICAgLy8gV2UgbmVlZCB0byBoYXZlIHplcm8gc3BlZWQgaW4gdGhpcyBjYXNlLiBTcGVlZFNhbXBsZWQgZG9lc24ndCBoZWxwXHJcbiAgICAgICAgdmFyIHcgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbChyZWZyKTtcclxuICAgICAgICBzcGVlZCA9IFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5nZXRTcGVlZChwb3MsIHcpO1xyXG4gICAgICAgIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5zYXZlUG9zaXRpb24ocG9zLCB3KTtcclxuICAgICAgICAvLyBJdCdzIHVucmVhbGlzdGljIHNwZWVkLiBJdCBzdGlsbCBtYXkgaGFwcGVuIGR1ZSB0byB0ZWxlcG9ydHNcclxuICAgICAgICBpZiAoc3BlZWQgPiAyMDAwKSB7XHJcbiAgICAgICAgICAgIHNwZWVkID0gMDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgd29ybGRPckNlbGwgPSByZWZyLmdldFdvcmxkU3BhY2UoKSB8fCByZWZyLmdldFBhcmVudENlbGwoKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgd29ybGRPckNlbGw6ICh3b3JsZE9yQ2VsbCA9PT0gbnVsbCB8fCB3b3JsZE9yQ2VsbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogd29ybGRPckNlbGwuZ2V0Rm9ybUlEKCkpIHx8IDAsXHJcbiAgICAgICAgcG9zOiBwb3MsXHJcbiAgICAgICAgcm90OiBbcmVmci5nZXRBbmdsZVgoKSwgcmVmci5nZXRBbmdsZVkoKSwgcmVmci5nZXRBbmdsZVooKV0sXHJcbiAgICAgICAgcnVuTW9kZTogcnVuTW9kZSxcclxuICAgICAgICBkaXJlY3Rpb246IHJ1bk1vZGUgIT09IFwiU3RhbmRpbmdcIlxyXG4gICAgICAgICAgICA/IDM2MCAqIHJlZnIuZ2V0QW5pbWF0aW9uVmFyaWFibGVGbG9hdChcIkRpcmVjdGlvblwiKVxyXG4gICAgICAgICAgICA6IDAsXHJcbiAgICAgICAgaXNJbkp1bXBTdGF0ZTogISEoYWMgJiYgYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiYkluSnVtcFN0YXRlXCIpKSxcclxuICAgICAgICBpc1NuZWFraW5nOiAhIShhYyAmJiBpc1NuZWFraW5nKGFjKSksXHJcbiAgICAgICAgaXNCbG9ja2luZzogISEoYWMgJiYgYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNCbG9ja2luZ1wiKSksXHJcbiAgICAgICAgaXNXZWFwRHJhd246ICEhKGFjICYmIGFjLmlzV2VhcG9uRHJhd24oKSksXHJcbiAgICAgICAgaXNEZWFkOiAoKF9hID0gZm9ybSA9PT0gbnVsbCB8fCBmb3JtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmb3JtLmlzRGVhZCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogZmFsc2UpIHx8ICEhKGFjICYmIGFjLmlzRGVhZCgpKSxcclxuICAgICAgICBoZWFsdGhQZXJjZW50YWdlOiBoZWFsdGhQZXJjZW50YWdlIHx8IDAsXHJcbiAgICAgICAgbG9va0F0OiBsb29rQXQsXHJcbiAgICAgICAgc3BlZWQ6IHNwZWVkXHJcbiAgICB9O1xyXG59O1xyXG52YXIgaXNTbmVha2luZyA9IGZ1bmN0aW9uIChhYykge1xyXG4gICAgcmV0dXJuIGFjLmlzU25lYWtpbmcoKSB8fCBhYy5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc1NuZWFraW5nXCIpO1xyXG59O1xyXG52YXIgZ2V0UnVuTW9kZSA9IGZ1bmN0aW9uIChhYykge1xyXG4gICAgaWYgKGFjLmlzU3ByaW50aW5nKCkpIHtcclxuICAgICAgICByZXR1cm4gXCJTcHJpbnRpbmdcIjtcclxuICAgIH1cclxuICAgIHZhciBzcGVlZCA9IGFjLmdldEFuaW1hdGlvblZhcmlhYmxlRmxvYXQoXCJTcGVlZFNhbXBsZWRcIik7XHJcbiAgICBpZiAoIXNwZWVkKSB7XHJcbiAgICAgICAgcmV0dXJuIFwiU3RhbmRpbmdcIjtcclxuICAgIH1cclxuICAgIHZhciBmdXJuaXR1cmUgPSBhYy5nZXRGdXJuaXR1cmVSZWZlcmVuY2UoKTtcclxuICAgIGlmIChmdXJuaXR1cmUgIT09IG51bGwpXHJcbiAgICAgICAgcmV0dXJuIFwiU3RhbmRpbmdcIjsgLy8gVE9ETzogU2l0dGluZz9cclxuICAgIHZhciBpc1J1bm5pbmcgPSB0cnVlO1xyXG4gICAgaWYgKGFjLmdldEZvcm1JRCgpID09IDB4MTQpIHtcclxuICAgICAgICBpZiAoIVRFU01vZFBsYXRmb3JtLmlzUGxheWVyUnVubmluZ0VuYWJsZWQoKSB8fCBzcGVlZCA8IDE1MClcclxuICAgICAgICAgICAgaXNSdW5uaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBpZiAoIWFjLmlzUnVubmluZygpIHx8IHNwZWVkIDwgMTUwKSB7XHJcbiAgICAgICAgICAgIGlzUnVubmluZyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChhYy5nZXRBbmltYXRpb25WYXJpYWJsZUZsb2F0KFwiSXNCbG9ja2luZ1wiKSkge1xyXG4gICAgICAgIGlzUnVubmluZyA9IGlzU25lYWtpbmcoYWMpO1xyXG4gICAgfVxyXG4gICAgdmFyIGNhcnJ5V2VpZ2h0ID0gYWMuZ2V0QWN0b3JWYWx1ZShcIkNhcnJ5V2VpZ2h0XCIpO1xyXG4gICAgdmFyIHRvdGFsSXRlbVdlaWdodCA9IGFjLmdldFRvdGFsSXRlbVdlaWdodCgpO1xyXG4gICAgaWYgKGNhcnJ5V2VpZ2h0IDwgdG90YWxJdGVtV2VpZ2h0KSB7XHJcbiAgICAgICAgaXNSdW5uaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaXNSdW5uaW5nID8gXCJSdW5uaW5nXCIgOiBcIldhbGtpbmdcIjtcclxufTtcclxuIiwiaW1wb3J0IHsgR2FtZSwgU3BlbGwsIHByaW50Q29uc29sZSB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuZXhwb3J0IHZhciByZW1vdmVBbGxTcGVsbHMgPSBmdW5jdGlvbiAoYWN0b3IpIHtcclxuICAgIHZhciBzcGVsbFRvUmVtb3ZlID0gbmV3IEFycmF5KCk7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjdG9yLmdldFNwZWxsQ291bnQoKTsgaSsrKSB7XHJcbiAgICAgICAgdmFyIHNwZWxsID0gYWN0b3IuZ2V0TnRoU3BlbGwoaSk7XHJcbiAgICAgICAgaWYgKHNwZWxsKSB7XHJcbiAgICAgICAgICAgIHNwZWxsVG9SZW1vdmUucHVzaChzcGVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZm9yICh2YXIgX2kgPSAwLCBzcGVsbFRvUmVtb3ZlXzEgPSBzcGVsbFRvUmVtb3ZlOyBfaSA8IHNwZWxsVG9SZW1vdmVfMS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICB2YXIgc3BlbGwgPSBzcGVsbFRvUmVtb3ZlXzFbX2ldO1xyXG4gICAgICAgIHZhciByZW1vdmVSZXN1bHQgPSBhY3Rvci5yZW1vdmVTcGVsbChzcGVsbCk7XHJcbiAgICAgICAgcHJpbnRDb25zb2xlKFwicmVtb3ZlUmVzdWx0OiBcIi5jb25jYXQocmVtb3ZlUmVzdWx0LCBcIiwgc3BlbGxJZFRvUmVtb3ZlOiBcIikuY29uY2F0KHNwZWxsXHJcbiAgICAgICAgICAgIC5nZXRGb3JtSUQoKVxyXG4gICAgICAgICAgICAudG9TdHJpbmcoMTYpLCBcIiwgc3BlbGxOYW1lOiBcIikuY29uY2F0KHNwZWxsLmdldE5hbWUoKSkpO1xyXG4gICAgfVxyXG59O1xyXG5leHBvcnQgdmFyIGxlYXJuU3BlbGxzID0gZnVuY3Rpb24gKGFjdG9yLCBzcGVsbHNJZHMpIHtcclxuICAgIGZvciAodmFyIF9pID0gMCwgc3BlbGxzSWRzXzEgPSBzcGVsbHNJZHM7IF9pIDwgc3BlbGxzSWRzXzEubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgdmFyIHNwZWxsSWQgPSBzcGVsbHNJZHNfMVtfaV07XHJcbiAgICAgICAgdmFyIHNwZWxsID0gU3BlbGwuZnJvbShHYW1lLmdldEZvcm1FeChzcGVsbElkKSk7XHJcbiAgICAgICAgaWYgKHNwZWxsKSB7XHJcbiAgICAgICAgICAgIHZhciBhZGRSZXN1bHQgPSBhY3Rvci5hZGRTcGVsbChzcGVsbCwgZmFsc2UpO1xyXG4gICAgICAgICAgICBwcmludENvbnNvbGUoXCJhZGRSZXN1bHQ6IFwiLmNvbmNhdChhZGRSZXN1bHQsIFwiLCBzcGVsbElkVG9MZWFybjogXCIpLmNvbmNhdChzcGVsbFxyXG4gICAgICAgICAgICAgICAgLmdldEZvcm1JRCgpXHJcbiAgICAgICAgICAgICAgICAudG9TdHJpbmcoMTYpLCBcIiwgc3BlbGxOYW1lOiBcIikuY29uY2F0KHNwZWxsLmdldE5hbWUoKSkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuIiwiaW1wb3J0IHsgVXRpbGl0eSwgRGVidWcsIGdldFBsYXRmb3JtVmVyc2lvbiwgb24sIEdhbWUsIFVpIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5leHBvcnQgdmFyIHJlcXVpcmVkVmVyc2lvbiA9ICcyLjkuMCc7XHJcbnZhciByZWFsVmVyc2lvbiA9IHR5cGVvZiBnZXRQbGF0Zm9ybVZlcnNpb24gPT09ICdmdW5jdGlvbicgPyBnZXRQbGF0Zm9ybVZlcnNpb24oKSA6ICd1bmtub3duJztcclxuLy8gVE9ETzogbm8gb25lIGFjdHVhbGx5IGNhbGxzIHRoaXMgZnVuY3Rpb24uIG1ha2UgYSBzZXJ2aWNlXHJcbmV4cG9ydCB2YXIgdmVyaWZ5VmVyc2lvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICghcmVxdWlyZWRWZXJzaW9uLmluY2x1ZGVzKHJlYWxWZXJzaW9uKSkge1xyXG4gICAgICAgIERlYnVnLm1lc3NhZ2VCb3goXCJZb3UgbmVlZCB0byBoYXZlIG9uIG9mIHRob3NlIFNreXJpbVBsYXRmb3JtIHZlcnNpb25zIFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShyZXF1aXJlZFZlcnNpb24pLCBcIiB0byBqb2luIHRoaXMgc2VydmVyLiBZb3VyIGN1cnJlbnQgdmVyc2lvbiBpcyBcIikuY29uY2F0KHJlYWxWZXJzaW9uKSk7XHJcbiAgICAgICAgVXRpbGl0eS53YWl0TWVudU1vZGUoMC41KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgb24oJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmICghVWkuaXNNZW51T3BlbignTWVzc2FnZUJveE1lbnUnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIEdhbWUucXVpdFRvTWFpbk1lbnUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcbiIsImltcG9ydCB7IEFjdG9yLCBBY3RvckJhc2UsIGNyZWF0ZVRleHQsIGRlc3Ryb3lUZXh0LCBHYW1lLCBLZXl3b3JkLCBOZXRJbW1lcnNlLCBPYmplY3RSZWZlcmVuY2UsIG9uY2UsIHByaW50Q29uc29sZSwgc2V0VGV4dFBvcywgc2V0VGV4dFNpemUsIHNldFRleHRTdHJpbmcsIHN0b3JhZ2UsIFRFU01vZFBsYXRmb3JtLCBVdGlsaXR5LCB3b3JsZFBvaW50VG9TY3JlZW5Qb2ludCB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBzZXREZWZhdWx0QW5pbXNEaXNhYmxlZCwgYXBwbHlBbmltYXRpb24gfSBmcm9tIFwiLi4vc3luYy9hbmltYXRpb25cIjtcclxuaW1wb3J0IHsgYXBwbHlBcHBlYXJhbmNlIH0gZnJvbSBcIi4uL3N5bmMvYXBwZWFyYW5jZVwiO1xyXG5pbXBvcnQgeyBpc0JhZE1lbnVTaG93biwgYXBwbHlFcXVpcG1lbnQgfSBmcm9tIFwiLi4vc3luYy9lcXVpcG1lbnRcIjtcclxuaW1wb3J0IHsgUmVzcGF3bk5lZWRlZEVycm9yIH0gZnJvbSBcIi4uL2xpYi9lcnJvcnNcIjtcclxuaW1wb3J0IHsgYXBwbHlNb3ZlbWVudCB9IGZyb20gXCIuLi9zeW5jL21vdmVtZW50QXBwbHlcIjtcclxuaW1wb3J0IHsgU3Bhd25Qcm9jZXNzIH0gZnJvbSBcIi4vc3Bhd25Qcm9jZXNzXCI7XHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSBcIi4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXhcIjtcclxuaW1wb3J0IHsgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlciB9IGZyb20gXCIuL3BsYXllckNoYXJhY3RlckRhdGFIb2xkZXJcIjtcclxuaW1wb3J0IHsgZ2V0TW92ZW1lbnQgfSBmcm9tIFwiLi4vc3luYy9tb3ZlbWVudEdldFwiO1xyXG5pbXBvcnQgeyBsYXN0VHJ5SG9zdCwgdHJ5SG9zdCB9IGZyb20gXCIuL2hvc3RBdHRlbXB0c1wiO1xyXG5pbXBvcnQgeyBNb2RlbEFwcGx5VXRpbHMgfSBmcm9tIFwiLi9tb2RlbEFwcGx5VXRpbHNcIjtcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQgfSBmcm9tIFwiLi93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IFNwQXBpSW50ZXJhY3RvciB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zcEFwaUludGVyYWN0b3JcIjtcclxuaW1wb3J0IHsgV29ybGRDbGVhbmVyU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zZXJ2aWNlcy93b3JsZENsZWFuZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEdhbWVtb2RlVXBkYXRlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zZXJ2aWNlcy9nYW1lbW9kZVVwZGF0ZVNlcnZpY2VcIjtcclxudmFyIF9zY3JlZW5SZXNvbHV0aW9uO1xyXG5leHBvcnQgdmFyIGdldFNjcmVlblJlc29sdXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIV9zY3JlZW5SZXNvbHV0aW9uKSB7XHJcbiAgICAgICAgX3NjcmVlblJlc29sdXRpb24gPSB7XHJcbiAgICAgICAgICAgIHdpZHRoOiBVdGlsaXR5LmdldElOSUludChcImlTaXplIFc6RGlzcGxheVwiKSxcclxuICAgICAgICAgICAgaGVpZ2h0OiBVdGlsaXR5LmdldElOSUludChcImlTaXplIEg6RGlzcGxheVwiKSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIF9zY3JlZW5SZXNvbHV0aW9uO1xyXG59O1xyXG52YXIgRm9ybVZpZXcgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBGb3JtVmlldyhyZW1vdGVSZWZySWQpIHtcclxuICAgICAgICB0aGlzLnJlbW90ZVJlZnJJZCA9IHJlbW90ZVJlZnJJZDtcclxuICAgICAgICB0aGlzLmxhc3RIYXJ2ZXN0ZWRBcHBseSA9IDA7XHJcbiAgICAgICAgdGhpcy5sYXN0T3BlbkFwcGx5ID0gMDtcclxuICAgICAgICB0aGlzLmlzU2V0Tm9kZVRleHR1cmVTZXRBcHBsaWVkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5pc1NldE5vZGVTY2FsZUFwcGxpZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnJlZnJJZCA9IDA7XHJcbiAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuYW5pbVN0YXRlID0gdGhpcy5nZXREZWZhdWx0QW5pbVN0YXRlKCk7XHJcbiAgICAgICAgdGhpcy5tb3ZTdGF0ZSA9IHtcclxuICAgICAgICAgICAgbGFzdE51bUNoYW5nZXM6IDAsXHJcbiAgICAgICAgICAgIGxhc3RBcHBseTogMCxcclxuICAgICAgICAgICAgbGFzdFJlaG9zdDogMCxcclxuICAgICAgICAgICAgZXZlckFwcGxpZWQ6IGZhbHNlLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5hcHBlYXJhbmNlU3RhdGUgPSB0aGlzLmdldERlZmF1bHRBcHBlYXJhbmNlU3RhdGUoKTtcclxuICAgICAgICB0aGlzLmVxU3RhdGUgPSB0aGlzLmdldERlZmF1bHRFcXVpcFN0YXRlKCk7XHJcbiAgICAgICAgdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQgPSAwO1xyXG4gICAgICAgIHRoaXMubGV2ZWxlZEJhc2VJZCA9IDA7XHJcbiAgICAgICAgdGhpcy5pc09uU2NyZWVuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5sYXN0UGNXb3JsZE9yQ2VsbCA9IDA7XHJcbiAgICAgICAgdGhpcy5sYXN0V29ybGRPckNlbGwgPSAwO1xyXG4gICAgICAgIHRoaXMuc3Bhd25Nb21lbnQgPSAwO1xyXG4gICAgICAgIHRoaXMud2FzSG9zdGVkQnlPdGhlciA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLnN0YXRlID0ge307XHJcbiAgICAgICAgdGhpcy5sb2NhbEltbW9ydGFsID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy50ZXh0TmFtZUlkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHRoaXMudm9pY2VJbmRpY2F0b3JJZCA9IHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAobW9kZWwpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2g7XHJcbiAgICAgICAgLy8gT3RoZXIgcGxheWVycyBtdXRhdGUgaW50byBQQyBjbG9uZXMgd2hlbiBtb3ZpbmcgdG8gYW5vdGhlciBsb2NhdGlvblxyXG4gICAgICAgIGlmIChtb2RlbC5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMubGFzdFdvcmxkT3JDZWxsKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0V29ybGRPckNlbGwgPSBtb2RlbC5tb3ZlbWVudC53b3JsZE9yQ2VsbDtcclxuICAgICAgICAgICAgaWYgKHRoaXMubGFzdFdvcmxkT3JDZWxsICE9PSBtb2RlbC5tb3ZlbWVudC53b3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiWzFdIHdvcmxkT3JDZWxsIGNoYW5nZWQsIGRlc3Ryb3lpbmcgRm9ybVZpZXcgXCIuY29uY2F0KHRoaXMubGFzdFdvcmxkT3JDZWxsLnRvU3RyaW5nKDE2KSwgXCIgPT4gXCIpLmNvbmNhdChtb2RlbC5tb3ZlbWVudC53b3JsZE9yQ2VsbC50b1N0cmluZygxNikpKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubGFzdFdvcmxkT3JDZWxsID0gbW9kZWwubW92ZW1lbnQud29ybGRPckNlbGw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcklkID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkID0gMDtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBEb24ndCBzcGF3biBkZWFkIGFjdG9ycyBpZiBub3QgYWxyZWFkeVxyXG4gICAgICAgIGlmIChtb2RlbC5pc0RlYWQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMucmVmcklkID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gUGxheWVycyB3aXRoIGRpZmZlcmVudCB3b3JsZE9yQ2VsbCBzaG91bGQgYmUgaW52aXNpYmxlXHJcbiAgICAgICAgaWYgKG1vZGVsLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgIHZhciB3b3JsZE9yQ2VsbCA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsKEdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgICAgICBpZiAod29ybGRPckNlbGwgIT09IDAgJiZcclxuICAgICAgICAgICAgICAgIG1vZGVsLm1vdmVtZW50LndvcmxkT3JDZWxsICE9PSB3b3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQXBwbHkgYXBwZWFyYW5jZSBiZWZvcmUgYmFzZSBmb3JtIHNlbGVjdGlvbiB0byBwcmV2ZW50IGRvdWJsZS1zcGF3blxyXG4gICAgICAgIGlmIChtb2RlbC5hcHBlYXJhbmNlIHx8ICghbW9kZWwuYXBwZWFyYW5jZSAmJiB0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlKSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UgfHxcclxuICAgICAgICAgICAgICAgIG1vZGVsLm51bUFwcGVhcmFuY2VDaGFuZ2VzICE9PSB0aGlzLmFwcGVhcmFuY2VTdGF0ZS5sYXN0TnVtQ2hhbmdlcykge1xyXG4gICAgICAgICAgICAgICAgLy8gQm90aCBub24tbnVsbFxyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGVsLmFwcGVhcmFuY2UgJiYgdGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbEFwcGVhcmFuY2VDb3B5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShtb2RlbC5hcHBlYXJhbmNlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlQXBwZWFyYW5jZUNvcHkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UpKTtcclxuICAgICAgICAgICAgICAgICAgICBtb2RlbEFwcGVhcmFuY2VDb3B5Lm5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlQXBwZWFyYW5jZUNvcHkubmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVxdWFsV2l0aG91dE5hbWVzID0gSlNPTi5zdHJpbmdpZnkobW9kZWxBcHBlYXJhbmNlQ29weSkgPT09IEpTT04uc3RyaW5naWZ5KHN0YXRlQXBwZWFyYW5jZUNvcHkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcXVhbFdpdGhvdXROYW1lcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGFuZ2UgbmFtZSBpbnBsYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWZyXzEgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeCh0aGlzLnJlZnJJZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAoX2EgPSByZWZyXzEgPT09IG51bGwgfHwgcmVmcl8xID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZWZyXzEuZ2V0QmFzZU9iamVjdCgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0TmFtZShtb2RlbC5hcHBlYXJhbmNlLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyXzEgPT09IG51bGwgfHwgcmVmcl8xID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZWZyXzEuc2V0RGlzcGxheU5hbWUobW9kZWwuYXBwZWFyYW5jZS5uYW1lLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9wcmludENvbnNvbGUoXCJBcHBlYXJhbmNlIHVwZGF0ZWQsIGNoYW5naW5nIG5hbWUgaW5wbGFjZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHJlLWFwcGx5IGFwcGVhcmFuY2Ugb24gdGhlIG5leHQgZ2V0QXBwZWFyYW5jZUJhc2VkQmFzZSBjYWxsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9wcmludENvbnNvbGUoXCJBcHBlYXJhbmNlIHVwZGF0ZWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2UgcmUtYXBwbHkgYXBwZWFyYW5jZSBvbiB0aGUgbmV4dCBnZXRBcHBlYXJhbmNlQmFzZWRCYXNlIGNhbGxcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9wcmludENvbnNvbGUoXCJBcHBlYXJhbmNlIHVwZGF0ZWRcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlID0gbW9kZWwuYXBwZWFyYW5jZSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlU3RhdGUubGFzdE51bUNoYW5nZXMgPSBtb2RlbC5udW1BcHBlYXJhbmNlQ2hhbmdlcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcmVmSWQgPSBtb2RlbC5yZWZySWQgJiYgbW9kZWwucmVmcklkIDwgMHhmZjAwMDAwMCA/IG1vZGVsLnJlZnJJZCA6IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAocmVmSWQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMucmVmcklkICE9PSByZWZJZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJJZCA9IG1vZGVsLnJlZnJJZDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlZnJfMiA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHRoaXMucmVmcklkKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmcl8yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJhc2UgPSByZWZyXzIuZ2V0QmFzZU9iamVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChiYXNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdFJlZmVyZW5jZUV4LmRlYWxXaXRoUmVmKHJlZnJfMiwgYmFzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB2YXIgdGVtcGxhdGVDaGFpbiA9IG1vZGVsLnRlbXBsYXRlQ2hhaW47XHJcbiAgICAgICAgICAgIC8vIFRoZXJlIGlzIG5vIHBsYWNlIGZvciByYW5kb20vbGV2ZWxpbmcgaW4gMS1zaXplZCBjaGFpblxyXG4gICAgICAgICAgICAvLyBKdXN0IHNwYXduIGFuIE5QQywgZG8gbm90IGdlbmVyYXRlIGEgdGVtcG9yYXJ5IFRFU05QQyBmb3JtXHJcbiAgICAgICAgICAgIGlmICgodGVtcGxhdGVDaGFpbiA9PT0gbnVsbCB8fCB0ZW1wbGF0ZUNoYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0ZW1wbGF0ZUNoYWluLmxlbmd0aCkgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlQ2hhaW4gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gVE9ETzogZ2V0TGV2ZWxlZEJhc2UgY3Jhc2hlcyB0b28gb2Z0ZW4gQVRNXHJcbiAgICAgICAgICAgIHZhciBiYXNlID0gbnVsbDsgLy9HYW1lLmdldEZvcm1FeCh0aGlzLmdldExldmVsZWRCYXNlKHRlbXBsYXRlQ2hhaW4pKTtcclxuICAgICAgICAgICAgaWYgKGJhc2UgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGJhc2UgPSBHYW1lLmdldEZvcm1FeChtb2RlbC5iYXNlSWQgfHwgTmFOKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYmFzZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgYmFzZSA9IEdhbWUuZ2V0Rm9ybUV4KHRoaXMuZ2V0QXBwZWFyYW5jZUJhc2VkQmFzZSgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoYmFzZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciByZWZyXzMgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeCh0aGlzLnJlZnJJZCkpO1xyXG4gICAgICAgICAgICB2YXIgcmVzcGF3blJlcXVpcmVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmICghcmVmcl8zKSB7XHJcbiAgICAgICAgICAgICAgICByZXNwYXduUmVxdWlyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCFyZWZyXzMuZ2V0QmFzZU9iamVjdCgpKSB7XHJcbiAgICAgICAgICAgICAgICByZXNwYXduUmVxdWlyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHJlZnJfMy5nZXRCYXNlT2JqZWN0KCkuZ2V0Rm9ybUlEKCkgIT09IGJhc2UuZ2V0Rm9ybUlEKCkpIHtcclxuICAgICAgICAgICAgICAgIHJlc3Bhd25SZXF1aXJlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlc3Bhd25SZXF1aXJlZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGxheWVyXzEgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwYXduTWV0aG9kT3JpZ2luYWwgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3Bhd246IGZ1bmN0aW9uIChiYXNlRm9ybSwgX3NwYXduUG9zaXRpb24sIF9zcGF3blJvdGF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGF5ZXJfMS5wbGFjZUF0TWUoYmFzZUZvcm0sIDEsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlclNwYXduUHJvY2VzczogZnVuY3Rpb24gKHNwYXduaW5nUmVmciwgc3Bhd25Qb3NpdGlvbiwgYXBwZWFyYW5jZSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFNwYXduUHJvY2VzcyhhcHBlYXJhbmNlLCBzcGF3blBvc2l0aW9uLCBzcGF3bmluZ1JlZnIuZ2V0Rm9ybUlEKCksIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwYXduTWV0aG9kU3R1YiA9IHtcclxuICAgICAgICAgICAgICAgICAgICBzcGF3bjogZnVuY3Rpb24gKGJhc2VGb3JtLCBzcGF3blBvc2l0aW9uLCBzcGF3blJvdGF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmID0gc3RvcmFnZVtcImZvcm1WaWV3RnVuYzFcIl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSBmKGJhc2VGb3JtLCBzcGF3blBvc2l0aW9uLCBzcGF3blJvdGF0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZjtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHRyaWdnZXJTcGF3blByb2Nlc3M6IGZ1bmN0aW9uIChzcGF3bmluZ1JlZnIsIHNwYXduUG9zaXRpb24sIGFwcGVhcmFuY2UsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmID0gc3RvcmFnZVtcImZvcm1WaWV3RnVuYzJcIl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGYoc3Bhd25pbmdSZWZyLCBzcGF3blBvc2l0aW9uLCBhcHBlYXJhbmNlLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHZhciBzcGF3blVzaW5nU3R1Yk1ldGhvZCA9IGJhc2UuZ2V0VHlwZSgpID09PSA0MyAvKiBGb3JtVHlwZS5OUEMgKi9cclxuICAgICAgICAgICAgICAgICAgICAmJiAhdGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZVxyXG4gICAgICAgICAgICAgICAgICAgICYmIHN0b3JhZ2VbXCJmb3JtVmlld0Z1bmMxU2V0XCJdID09PSB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgc3RvcmFnZVtcImZvcm1WaWV3RnVuYzJTZXRcIl0gPT09IHRydWU7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3Bhd25NZXRob2QgPSBzcGF3blVzaW5nU3R1Yk1ldGhvZCA/IHNwYXduTWV0aG9kU3R1YiA6IHNwYXduTWV0aG9kT3JpZ2luYWw7XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZWwubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyXzMgPSBzcGF3bk1ldGhvZC5zcGF3bihiYXNlLCBtb2RlbC5tb3ZlbWVudC5wb3MsIG1vZGVsLm1vdmVtZW50LnJvdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJtb2RlbC5tb3ZlbWVudCB3YXMgXCIgKyBtb2RlbC5tb3ZlbWVudCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0ge307XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy53YXNIb3N0ZWRCeU90aGVyO1xyXG4gICAgICAgICAgICAgICAgaWYgKGJhc2UuZ2V0VHlwZSgpICE9PSA0MyAvKiBGb3JtVHlwZS5OUEMgKi8pIHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyXzMgPT09IG51bGwgfHwgcmVmcl8zID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZWZyXzMuc2V0QW5nbGUoKChfYiA9IG1vZGVsLm1vdmVtZW50KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iucm90WzBdKSB8fCAwLCAoKF9jID0gbW9kZWwubW92ZW1lbnQpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5yb3RbMV0pIHx8IDAsICgoX2QgPSBtb2RlbC5tb3ZlbWVudCkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLnJvdFsyXSkgfHwgMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmFjZSA9IChfZiA9IChfZSA9IEFjdG9yLmZyb20ocmVmcl8zKSkgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLmdldFJhY2UoKSkgPT09IG51bGwgfHwgX2YgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9mLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkcmF1Z3JSYWNlID0gMHhkNTM7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZhbG1lclJhY2UgPSAweDEzMWY0O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGF1cnVzUmFjZSA9IDB4MTMxZWI7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZyb3N0Yml0ZVNwaWRlclJhY2VHaWFudCA9IDB4NGU1MDc7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZyb3N0Yml0ZVNwaWRlclJhY2VMYXJnZSA9IDB4NTM0Nzc7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGR3YXJ2ZW5DZW50dXJpb25SYWNlID0gMHgxMzFmMTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZHdhcnZlblNwaGVyZVJhY2UgPSAweDEzMWYyO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkd2FydmVuU3BpZGVyUmFjZSA9IDB4MTMxZjM7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwcmlnZ2FuUmFjZSA9IDB4MjAxM2I3NztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3ByaWdnYW5SYWNlMiA9IDB4ZjM5MDM7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwcmlnZ2FuUmFjZTMgPSAweDEzMjA0O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcHJpZ2dhblJhY2U0ID0gMHg0MDFiNjQ0O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcHJpZ2dhblJhY2U1ID0gMHg5YWE0NDtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgd29sZlJhY2UgPSAweDEzMjBhO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHBvdGVudGlhbCBtYXN0ZXJhbWJ1c2hzY3JpcHRcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmFjZSA9PT0gZHJhdWdyUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBmYWxtZXJSYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGNoYXVydXNSYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGZyb3N0Yml0ZVNwaWRlclJhY2VHaWFudFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBmcm9zdGJpdGVTcGlkZXJSYWNlTGFyZ2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gZHdhcnZlbkNlbnR1cmlvblJhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gZHdhcnZlblNwaGVyZVJhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gZHdhcnZlblNwaWRlclJhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gc3ByaWdnYW5SYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IHNwcmlnZ2FuUmFjZTJcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gc3ByaWdnYW5SYWNlM1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBzcHJpZ2dhblJhY2U0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IHNwcmlnZ2FuUmFjZTVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gd29sZlJhY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgKF9nID0gQWN0b3IuZnJvbShyZWZyXzMpKSA9PT0gbnVsbCB8fCBfZyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2cuc2V0QWN0b3JWYWx1ZShcIkFnZ3Jlc3Npb25cIiwgMik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnJfMyAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5sb29rdXBMaXN0ZW5lcihXb3JsZENsZWFuZXJTZXJ2aWNlKS5tb2RXY1Byb3RlY3Rpb24ocmVmcl8zLmdldEZvcm1JRCgpLCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IHJlc2V0IGFsbCBzdGF0ZXM/XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVxU3RhdGUgPSB0aGlzLmdldERlZmF1bHRFcXVpcFN0YXRlKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFuaW1TdGF0ZSA9IHRoaXMuZ2V0RGVmYXVsdEFuaW1TdGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwYXduUG9zID0gdm9pZCAwO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGVsLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25Qb3MgPSBtb2RlbC5tb3ZlbWVudC5wb3M7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gcHJpbnRDb25zb2xlKFwiU3Bhd24gTlBDIGF0IG1vdmVtZW50LnBvc1wiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwYXduUG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKEdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlNwYXduIE5QQyBhdCBwbGF5ZXIgcG9zXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnJfMykge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwYXduTWV0aG9kLnRyaWdnZXJTcGF3blByb2Nlc3MocmVmcl8zLCBzcGF3blBvcywgbW9kZWwuYXBwZWFyYW5jZSB8fCBudWxsLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlYWR5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc3Bhd25Nb21lbnQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiVW5hYmxlIHRvIHRyaWdnZXJTcGF3blByb2Nlc3MgZm9yIG51bGwgcmVmclwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbC5hcHBlYXJhbmNlICYmIG1vZGVsLmFwcGVhcmFuY2UubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnJfMyA9PT0gbnVsbCB8fCByZWZyXzMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnJfMy5zZXREaXNwbGF5TmFtZShcIlwiICsgbW9kZWwuYXBwZWFyYW5jZS5uYW1lLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIChfaCA9IEFjdG9yLmZyb20ocmVmcl8zKSkgPT09IG51bGwgfHwgX2ggPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9oLnNldEFjdG9yVmFsdWUoXCJhdHRhY2tEYW1hZ2VNdWx0XCIsIDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVmcklkID0gcmVmcl8zLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMucmVhZHkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHRoaXMucmVmcklkKSk7XHJcbiAgICAgICAgaWYgKHJlZnIpIHtcclxuICAgICAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgaWYgKGFjdG9yICYmICF0aGlzLmxvY2FsSW1tb3J0YWwpIHtcclxuICAgICAgICAgICAgICAgIGFjdG9yLnN0YXJ0RGVmZXJyZWRLaWxsKCk7XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5zZXRBY3RvclZhbHVlKFwiaGVhbHRoXCIsIDEwMDAwMDApO1xyXG4gICAgICAgICAgICAgICAgYWN0b3Iuc2V0QWN0b3JWYWx1ZShcIm1hZ2lja2FcIiwgMTAwMDAwMCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsSW1tb3J0YWwgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbHlBbGwocmVmciwgbW9kZWwpO1xyXG4gICAgICAgICAgICB2YXIgZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlID0gU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmxvb2t1cExpc3RlbmVyKEdhbWVtb2RlVXBkYXRlU2VydmljZSk7XHJcbiAgICAgICAgICAgIGdhbWVtb2RlVXBkYXRlU2VydmljZS51cGRhdGVOZWlnaGJvcihyZWZyLCBtb2RlbCwgdGhpcy5zdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuaXNPblNjcmVlbiA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuc3Bhd25Nb21lbnQgPSAwO1xyXG4gICAgICAgIHZhciByZWZySWQgPSB0aGlzLnJlZnJJZDtcclxuICAgICAgICBvbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHJlZnJJZCA+PSAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyLmRlbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmxvb2t1cExpc3RlbmVyKFdvcmxkQ2xlYW5lclNlcnZpY2UpLm1vZFdjUHJvdGVjdGlvbihyZWZySWQsIC0xKTtcclxuICAgICAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgICAgICAgICBURVNNb2RQbGF0Zm9ybS5zZXRXZWFwb25EcmF3bk1vZGUoYWMsIC0xKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMubG9jYWxJbW1vcnRhbCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlTmlja25hbWUoKTtcclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuYXBwbHlBbGwgPSBmdW5jdGlvbiAocmVmciwgbW9kZWwpIHtcclxuICAgICAgICB2YXIgX2EsIF9iLCBfYztcclxuICAgICAgICB2YXIgZm9yY2VkV2VhcERyYXduID0gbnVsbDtcclxuICAgICAgICBpZiAoUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRDcm9zc2hhaXJSZWZJZCgpID09PSB0aGlzLnJlZnJJZCkge1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RIYXJ2ZXN0ZWRBcHBseSA9IDA7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdE9wZW5BcHBseSA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RIYXJ2ZXN0ZWRBcHBseSA+IDY2Nikge1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RIYXJ2ZXN0ZWRBcHBseSA9IG5vdztcclxuICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0hhcnZlc3RlZChyZWZyLCAhIW1vZGVsLmlzSGFydmVzdGVkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5vdyAtIHRoaXMubGFzdE9wZW5BcHBseSA+IDEzMykge1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RPcGVuQXBwbHkgPSBub3c7XHJcbiAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNPcGVuKHJlZnIsICEhbW9kZWwuaXNPcGVuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzU2V0Tm9kZVNjYWxlQXBwbGllZCkge1xyXG4gICAgICAgICAgICB0aGlzLmlzU2V0Tm9kZVNjYWxlQXBwbGllZCA9IHRydWU7XHJcbiAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsTm9kZVNjYWxlKHJlZnIsIG1vZGVsLnNldE5vZGVTY2FsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5pc1NldE5vZGVUZXh0dXJlU2V0QXBwbGllZCkge1xyXG4gICAgICAgICAgICB0aGlzLmlzU2V0Tm9kZVRleHR1cmVTZXRBcHBsaWVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxOb2RlVGV4dHVyZVNldChyZWZyLCBtb2RlbC5zZXROb2RlVGV4dHVyZVNldCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbC5pbnZlbnRvcnkgJiZcclxuICAgICAgICAgICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRDcm9zc2hhaXJSZWZJZCgpID09IHRoaXMucmVmcklkICYmXHJcbiAgICAgICAgICAgICFpc0JhZE1lbnVTaG93bigpKSB7XHJcbiAgICAgICAgICAgIC8vIERvIG5vdCBsZXQgYWN0b3JzIGJyZWFraW5nIHRoZWlyIGVxdWlwbWVudCB2aWEgaW52ZW50b3J5IGFwcGx5XHJcbiAgICAgICAgICAgIC8vIEhvd2V2ZXIsIGFjdHVhbGx5LCBhY3RvcnMgZG8gbm90IGhhdmUgaW52ZW50b3J5IGluIHRoZWlyIG1vZGVsc1xyXG4gICAgICAgICAgICAvLyBFeGNlcHQgeW91ciBjbG9uZS5cclxuICAgICAgICAgICAgaWYgKCFBY3Rvci5mcm9tKHJlZnIpKSB7XHJcbiAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbEludmVudG9yeShyZWZyLCBtb2RlbC5pbnZlbnRvcnkpO1xyXG4gICAgICAgICAgICAgICAgbW9kZWwuaW52ZW50b3J5ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbC5hbmltYXRpb24pIHtcclxuICAgICAgICAgICAgaWYgKG1vZGVsLmFuaW1hdGlvbi5hbmltRXZlbnROYW1lID09PSBcIlNreW1wRmFrZVVuZXF1aXBcIikge1xyXG4gICAgICAgICAgICAgICAgZm9yY2VkV2VhcERyYXduID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAobW9kZWwuYW5pbWF0aW9uLmFuaW1FdmVudE5hbWUgPT09IFwiU2t5bXBGYWtlRXF1aXBcIikge1xyXG4gICAgICAgICAgICAgICAgZm9yY2VkV2VhcERyYXduID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBUT0RPOiBtYWtlIGhvc3Qgc2VydmljZVxyXG4gICAgICAgIHZhciBob3N0ZWQgPSBzdG9yYWdlWydob3N0ZWQnXTtcclxuICAgICAgICB2YXIgYWxyZWFkeUhvc3RlZCA9IGZhbHNlO1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvc3RlZCkpIHtcclxuICAgICAgICAgICAgdmFyIHJlbW90ZUlkID0gbG9jYWxJZFRvUmVtb3RlSWQodGhpcy5yZWZySWQpO1xyXG4gICAgICAgICAgICBpZiAoaG9zdGVkLmluY2x1ZGVzKHJlbW90ZUlkKSB8fCBob3N0ZWQuaW5jbHVkZXMocmVtb3RlSWQgKyAweDEwMDAwMDAwMCkpIHtcclxuICAgICAgICAgICAgICAgIGFscmVhZHlIb3N0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldERlZmF1bHRBbmltc0Rpc2FibGVkKHRoaXMucmVmcklkLCBhbHJlYWR5SG9zdGVkID8gZmFsc2UgOiB0cnVlKTtcclxuICAgICAgICBpZiAoYWxyZWFkeUhvc3RlZCkge1xyXG4gICAgICAgICAgICAoX2EgPSBBY3Rvci5mcm9tKHJlZnIpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xlYXJLZWVwT2Zmc2V0RnJvbUFjdG9yKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbC5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tb3ZTdGF0ZS5sYXN0QXBwbHkgJiZcclxuICAgICAgICAgICAgICAgIERhdGUubm93KCkgLSB0aGlzLm1vdlN0YXRlLmxhc3RBcHBseSA+IDE1MDApIHtcclxuICAgICAgICAgICAgICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5tb3ZTdGF0ZS5sYXN0UmVob3N0ID4gMTAwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW92U3RhdGUubGFzdFJlaG9zdCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW90ZUlkID0gdGhpcy5yZW1vdGVSZWZySWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjICYmIGFjLmlzM0RMb2FkZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyeUhvc3RJZk5lZWQoYWMsIHJlbW90ZUlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwidHJ5SG9zdElmTmVlZCAtIHJlYXNvbjogbm90IHNlZWluZyBtb3ZlbWVudCBmb3IgbG9uZyB0aW1lXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoK21vZGVsLm51bU1vdmVtZW50Q2hhbmdlcyAhPT1cclxuICAgICAgICAgICAgICAgIHRoaXMubW92U3RhdGUubGFzdE51bUNoYW5nZXMgfHxcclxuICAgICAgICAgICAgICAgIERhdGUubm93KCkgLSB0aGlzLm1vdlN0YXRlLmxhc3RBcHBseSA+IDIwMDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubW92U3RhdGUubGFzdEFwcGx5ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbC5pc0hvc3RlZEJ5T3RoZXIgfHwgIXRoaXMubW92U3RhdGUuZXZlckFwcGxpZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYmFja3VwID0gbW9kZWwubW92ZW1lbnQuaXNXZWFwRHJhd247XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcmNlZFdlYXBEcmF3biA9PT0gdHJ1ZSB8fCBmb3JjZWRXZWFwRHJhd24gPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsLm1vdmVtZW50LmlzV2VhcERyYXduID0gZm9yY2VkV2VhcERyYXduO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBseU1vdmVtZW50KHJlZnIsIG1vZGVsLm1vdmVtZW50LCAhIW1vZGVsLmlzTXlDbG9uZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgUmVzcGF3bk5lZWRlZEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RXb3JsZE9yQ2VsbCA9IG1vZGVsLm1vdmVtZW50LndvcmxkT3JDZWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZnJJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIG1vZGVsLm1vdmVtZW50LmlzV2VhcERyYXduID0gYmFja3VwO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW92U3RhdGUubGFzdE51bUNoYW5nZXMgPSArbW9kZWwubnVtTW92ZW1lbnRDaGFuZ2VzO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW92U3RhdGUuZXZlckFwcGxpZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW90ZUlkID0gdGhpcy5yZW1vdGVSZWZySWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjICYmIHJlbW90ZUlkICYmIGFjLmlzM0RMb2FkZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhYy5jbGVhcktlZXBPZmZzZXRGcm9tQWN0b3IoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogbWFrZSBob3N0IHNlcnZpY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhvc3RlZF8xID0gc3RvcmFnZVsnaG9zdGVkJ107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbHJlYWR5SG9zdGVkXzEgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaG9zdGVkXzEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVtb3RlSWRfMSA9IGxvY2FsSWRUb1JlbW90ZUlkKGFjLmdldEZvcm1JRCgpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChob3N0ZWRfMS5pbmNsdWRlcyhyZW1vdGVJZF8xKSB8fCBob3N0ZWRfMS5pbmNsdWRlcyhyZW1vdGVJZF8xICsgMHgxMDAwMDAwMDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxyZWFkeUhvc3RlZF8xID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFscmVhZHlIb3N0ZWRfMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHJ5SG9zdElmTmVlZChhYywgcmVtb3RlSWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHJldmlvdXNseSwgd2UgZGlkIHRoaXMgY2xlYW51cCBvbiBlYWNoIHVwZGF0ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBJIGd1ZXNzIGl0J3MgdG9vIGV4cGVuc2l2ZSBhbmQgY2FuIHBvc3NpYmx5IGh1cnQgRlBTXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVEVTTW9kUGxhdGZvcm0uc2V0V2VhcG9uRHJhd25Nb2RlKGFjLCAtMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHJlZnIuaXMzRExvYWRlZCgpKSB7XHJcbiAgICAgICAgICAgIGlmIChtb2RlbC5hbmltYXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGFwcGx5QW5pbWF0aW9uKHJlZnIsIG1vZGVsLmFuaW1hdGlvbiwgdGhpcy5hbmltU3RhdGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIFVzZSB0aGVtIG9ubHkgb25jZSwgZm9yIHNwYXduaW5nIGFjdG9ycyB3aXRoIGNvcnJlY3QgYW5pbWF0aW9uc1xyXG4gICAgICAgICAgICB0aGlzLmFuaW1TdGF0ZS51c2VBbmltT3ZlcnJpZGVzID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbC5hcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgIGlmIChhY3RvciAmJiAhUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5pc0luSnVtcFN0YXRlKCkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldFdvcmxkT3JDZWxsKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXN0UGNXb3JsZE9yQ2VsbCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldFdvcmxkT3JDZWxsKCkgIT09IHRoaXMubGFzdFBjV29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVkcmF3IHRpbnRzIGlmIFBDIHdvcmxkL2NlbGwgY2hhbmdlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlzT25TY3JlZW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0UGNXb3JsZE9yQ2VsbCA9IFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0V29ybGRPckNlbGwoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBoZWFkUG9zID0gW1xyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2UuZ2V0Tm9kZVdvcmxkUG9zaXRpb25YKGFjdG9yLCBcIk5QQyBIZWFkIFtIZWFkXVwiLCBmYWxzZSksXHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5nZXROb2RlV29ybGRQb3NpdGlvblkoYWN0b3IsIFwiTlBDIEhlYWQgW0hlYWRdXCIsIGZhbHNlKSxcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLmdldE5vZGVXb3JsZFBvc2l0aW9uWihhY3RvciwgXCJOUEMgSGVhZCBbSGVhZF1cIiwgZmFsc2UpLFxyXG4gICAgICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgICAgIHZhciBzY3JlZW5Qb2ludCA9IHdvcmxkUG9pbnRUb1NjcmVlblBvaW50KGhlYWRQb3MpWzBdO1xyXG4gICAgICAgICAgICAgICAgdmFyIGlzT25TY3JlZW4gPSBzY3JlZW5Qb2ludFswXSA+IDAgJiZcclxuICAgICAgICAgICAgICAgICAgICBzY3JlZW5Qb2ludFsxXSA+IDAgJiZcclxuICAgICAgICAgICAgICAgICAgICBzY3JlZW5Qb2ludFsyXSA+IDAgJiZcclxuICAgICAgICAgICAgICAgICAgICBzY3JlZW5Qb2ludFswXSA8IDEgJiZcclxuICAgICAgICAgICAgICAgICAgICBzY3JlZW5Qb2ludFsxXSA8IDEgJiZcclxuICAgICAgICAgICAgICAgICAgICBzY3JlZW5Qb2ludFsyXSA8IDE7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNPblNjcmVlbiAhPSB0aGlzLmlzT25TY3JlZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzT25TY3JlZW4gPSBpc09uU2NyZWVuO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc09uU2NyZWVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdG9yLnF1ZXVlTmlOb2RlVXBkYXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEdhbWUuZ2V0UGxheWVyKCkucXVldWVOaU5vZGVVcGRhdGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsLmVxdWlwbWVudCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lcVN0YXRlLmxhc3ROdW1DaGFuZ2VzICE9PSBtb2RlbC5lcXVpcG1lbnQubnVtQ2hhbmdlcykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgICAgIC8vIElmIHdlIGRvIG5vdCBibG9jayBpbnZlbnRvcnkgaGVyZSwgd2Ugd2lsbCBiZSBhYmxlIHRvIHJlcHJvZHVjZSB0aGUgYnVnOlxyXG4gICAgICAgICAgICAgICAgLy8gMS4gUGxhY2UgfjkwIGJvdHMgYW5kIGZvcmNlIHRoZW0gdG8gcmVlcXVpcCBpcm9uIHN3b3JkcyB0byB0aGUgbGVmdCBoYW5kIChyYXRlIHNob3VsZCBiZSB+NTBtcylcclxuICAgICAgICAgICAgICAgIC8vIDIuIE9wZW4geW91ciBpbnZlbnRvcnkgYW5kIHJlZXF1aXAgZGlmZmVyZW50IGl0ZW1zIGZhc3RcclxuICAgICAgICAgICAgICAgIC8vIDMuIEFmdGVyIDEtMiBtaW51dGVzIGNsb3NlIHlvdXIgaW52ZW50b3J5IGFuZCBzZWUgdGhhdCBIVUQgZGlzYXBwZWFyZWRcclxuICAgICAgICAgICAgICAgIGlmIChhYyAmJlxyXG4gICAgICAgICAgICAgICAgICAgICFpc0JhZE1lbnVTaG93bigpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgRGF0ZS5ub3coKSAtIHRoaXMuZXFTdGF0ZS5sYXN0RXFNb21lbnQgPiA1MDAgJiZcclxuICAgICAgICAgICAgICAgICAgICBEYXRlLm5vdygpIC0gdGhpcy5zcGF3bk1vbWVudCA+IC0xICYmXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGF3bk1vbWVudCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvL2lmICh0aGlzLnNwYXduTW9tZW50ID4gMCAmJiBEYXRlLm5vdygpIC0gdGhpcy5zcGF3bk1vbWVudCA+IDUwMDApIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwbHlFcXVpcG1lbnQoYWMsIG1vZGVsLmVxdWlwbWVudCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lcVN0YXRlLmxhc3ROdW1DaGFuZ2VzID0gbW9kZWwuZXF1aXBtZW50Lm51bUNoYW5nZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXFTdGF0ZS5sYXN0RXFNb21lbnQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vY29uc3QgcmVzOiBib29sZWFuID0gYXBwbHlFcXVpcG1lbnQoYWMsIG1vZGVsLmVxdWlwbWVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9pZiAocmVzKSB0aGlzLmVxU3RhdGUubGFzdE51bUNoYW5nZXMgPSBtb2RlbC5lcXVpcG1lbnQubnVtQ2hhbmdlcztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoRm9ybVZpZXcuaXNEaXNwbGF5aW5nTmlja25hbWVzICYmIHRoaXMucmVmcklkICYmICgoX2IgPSBtb2RlbC5hcHBlYXJhbmNlKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubmFtZSkpIHtcclxuICAgICAgICAgICAgdmFyIGhlYWRQYXJ0ID0gXCJOUEMgSGVhZCBbSGVhZF1cIjtcclxuICAgICAgICAgICAgdmFyIG1heE5pY2tuYW1lRHJhd0Rpc3RhbmNlID0gMTAwMDtcclxuICAgICAgICAgICAgdmFyIHBsYXllckFjdG9yID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgdmFyIGlzVmlzaWJsZUJ5UGxheWVyID0gISgoX2MgPSBtb2RlbC5tb3ZlbWVudCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmlzU25lYWtpbmcpXHJcbiAgICAgICAgICAgICAgICAmJiBwbGF5ZXJBY3Rvci5nZXREaXN0YW5jZShyZWZyKSA8PSBtYXhOaWNrbmFtZURyYXdEaXN0YW5jZVxyXG4gICAgICAgICAgICAgICAgJiYgcGxheWVyQWN0b3IuaGFzTE9TKHJlZnIpXHJcbiAgICAgICAgICAgICAgICAmJiAhdGhpcy5pc1N3ZWV0SGlkZVBlcnNvbihyZWZyKTtcclxuICAgICAgICAgICAgaWYgKGlzVmlzaWJsZUJ5UGxheWVyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaGVhZFNjcmVlblBvcyA9IHdvcmxkUG9pbnRUb1NjcmVlblBvaW50KFtcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLmdldE5vZGVXb3JsZFBvc2l0aW9uWChyZWZyLCBoZWFkUGFydCwgZmFsc2UpLFxyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2UuZ2V0Tm9kZVdvcmxkUG9zaXRpb25ZKHJlZnIsIGhlYWRQYXJ0LCBmYWxzZSksXHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5nZXROb2RlV29ybGRQb3NpdGlvbloocmVmciwgaGVhZFBhcnQsIGZhbHNlKSArIDMyXHJcbiAgICAgICAgICAgICAgICBdKVswXTtcclxuICAgICAgICAgICAgICAgIHZhciByZXNvbHV0aW9uID0gZ2V0U2NyZWVuUmVzb2x1dGlvbigpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRleHRYUG9zID0gTWF0aC5yb3VuZChoZWFkU2NyZWVuUG9zWzBdICogcmVzb2x1dGlvbi53aWR0aCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGV4dFlQb3MgPSBNYXRoLnJvdW5kKCgxIC0gaGVhZFNjcmVlblBvc1sxXSkgKiByZXNvbHV0aW9uLmhlaWdodCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNUYWxraW5nVGV4dCA9IChtb2RlbCA9PT0gbnVsbCB8fCBtb2RlbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbW9kZWwuaXNUYWxraW5nKSA/IFwiU3BlYWtpbmdcIiA6IFwiXCI7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudGV4dE5hbWVJZCAmJiBoZWFkU2NyZWVuUG9zWzJdID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dE5hbWVJZCA9IGNyZWF0ZVRleHQodGV4dFhQb3MsIHRleHRZUG9zLCByZWZyLmdldERpc3BsYXlOYW1lKCksIFsxLCAxLCAxLCAwLjhdKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLnRleHROYW1lSWQsIDAuNSk7XHJcbiAgICAgICAgICAgICAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmVtaXR0ZXIuZW1pdChcIm5pY2tuYW1lQ3JlYXRlXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlUmVmcklkOiB0aGlzLmdldFJlbW90ZVJlZnJJZCgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0SWQ6IHRoaXMudGV4dE5hbWVJZFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRlbGV0ZU5pY2tuYW1lID0gaGVhZFNjcmVlblBvc1syXSA8IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGV0ZU5pY2tuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTmlja25hbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudGV4dE5hbWVJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUZXh0UG9zKHRoaXMudGV4dE5hbWVJZCwgdGV4dFhQb3MsIHRleHRZUG9zKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudm9pY2VJbmRpY2F0b3JJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudm9pY2VJbmRpY2F0b3JJZCA9IGNyZWF0ZVRleHQodGV4dFhQb3MsIHRleHRZUG9zIC0gMzUsIFwiXCIsIFsxLCAwLjg1LCAwLjIsIDAuOF0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFRleHRTaXplKHRoaXMudm9pY2VJbmRpY2F0b3JJZCwgMC40KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZvaWNlSW5kaWNhdG9ySWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGV4dFN0cmluZyh0aGlzLnZvaWNlSW5kaWNhdG9ySWQsIGhlYWRTY3JlZW5Qb3NbMl0gPj0gMCA/IGlzVGFsa2luZ1RleHQgOiBcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGV4dFBvcyh0aGlzLnZvaWNlSW5kaWNhdG9ySWQsIHRleHRYUG9zLCB0ZXh0WVBvcyAtIDM1KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU5pY2tuYW1lKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlTmlja25hbWUoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmlzU3dlZXRIaWRlUGVyc29uID0gZnVuY3Rpb24gKHJlZnIpIHtcclxuICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgIGlmICghYWN0b3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIga2V5d29yZCA9IEtleXdvcmQuZ2V0S2V5d29yZCgnU3dlZXRIaWRlUGVyc29uJyk7XHJcbiAgICAgICAgcmV0dXJuIGFjdG9yLndvcm5IYXNLZXl3b3JkKGtleXdvcmQpO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5yZW1vdmVOaWNrbmFtZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy50ZXh0TmFtZUlkKSB7XHJcbiAgICAgICAgICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5lbWl0dGVyLmVtaXQoXCJuaWNrbmFtZURlc3Ryb3lcIiwge1xyXG4gICAgICAgICAgICAgICAgcmVtb3RlUmVmcklkOiB0aGlzLmdldFJlbW90ZVJlZnJJZCgpLFxyXG4gICAgICAgICAgICAgICAgdGV4dElkOiB0aGlzLnRleHROYW1lSWRcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGRlc3Ryb3lUZXh0KHRoaXMudGV4dE5hbWVJZCk7XHJcbiAgICAgICAgICAgIHRoaXMudGV4dE5hbWVJZCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMudm9pY2VJbmRpY2F0b3JJZCkge1xyXG4gICAgICAgICAgICBkZXN0cm95VGV4dCh0aGlzLnZvaWNlSW5kaWNhdG9ySWQpO1xyXG4gICAgICAgICAgICB0aGlzLnZvaWNlSW5kaWNhdG9ySWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXRBcHBlYXJhbmNlQmFzZWRCYXNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBiYXNlID0gQWN0b3JCYXNlLmZyb20oR2FtZS5nZXRGb3JtRXgodGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQpKTtcclxuICAgICAgICBpZiAoIWJhc2UgJiYgdGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCA9IGFwcGx5QXBwZWFyYW5jZSh0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlKS5nZXRGb3JtSUQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXRMZXZlbGVkQmFzZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZUNoYWluKSB7XHJcbiAgICAgICAgaWYgKHRlbXBsYXRlQ2hhaW4gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHN0ciA9IHRlbXBsYXRlQ2hhaW4uam9pbignLCcpO1xyXG4gICAgICAgIGlmICh0aGlzLmxldmVsZWRCYXNlSWQgPT09IDApIHtcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICB2YXIgbGV2ZWxlZEJhc2UgPSBURVNNb2RQbGF0Zm9ybS5ldmFsdWF0ZUxldmVsZWROcGMoc3RyKTtcclxuICAgICAgICAgICAgaWYgKCFsZXZlbGVkQmFzZSkge1xyXG4gICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiRmFpbGVkIHRvIGV2YWx1YXRlIGxldmVsZWQgbnBjXCIsIHN0cik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5sZXZlbGVkQmFzZUlkID0gKGxldmVsZWRCYXNlID09PSBudWxsIHx8IGxldmVsZWRCYXNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsZXZlbGVkQmFzZS5nZXRGb3JtSUQoKSkgfHwgMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubGV2ZWxlZEJhc2VJZDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0RGVmYXVsdEVxdWlwU3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgbGFzdE51bUNoYW5nZXM6IDAsIGxhc3RFcU1vbWVudDogMCB9O1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXREZWZhdWx0QXBwZWFyYW5jZVN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7IGxhc3ROdW1DaGFuZ2VzOiAwLCBhcHBlYXJhbmNlOiBudWxsIH07XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldERlZmF1bHRBbmltU3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgbGFzdE51bUNoYW5nZXM6IDAsIHVzZUFuaW1PdmVycmlkZXM6IHRydWUgfTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUudHJ5SG9zdElmTmVlZCA9IGZ1bmN0aW9uIChhYywgcmVtb3RlSWQpIHtcclxuICAgICAgICB2YXIgbGFzdCA9IGxhc3RUcnlIb3N0W3JlbW90ZUlkXTtcclxuICAgICAgICBpZiAoIWxhc3QgfHwgRGF0ZS5ub3coKSAtIGxhc3QgPj0gMTAwMCkge1xyXG4gICAgICAgICAgICBsYXN0VHJ5SG9zdFtyZW1vdGVJZF0gPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICBpZiAoZ2V0TW92ZW1lbnQoYWMpLndvcmxkT3JDZWxsID09PVxyXG4gICAgICAgICAgICAgICAgZ2V0TW92ZW1lbnQoR2FtZS5nZXRQbGF5ZXIoKSkud29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgICAgIHRyeUhvc3QocmVtb3RlSWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXRMb2NhbFJlZnJJZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZWZySWQ7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldFJlbW90ZVJlZnJJZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZW1vdGVSZWZySWQ7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcuaXNEaXNwbGF5aW5nTmlja25hbWVzID0gdHJ1ZTtcclxuICAgIHJldHVybiBGb3JtVmlldztcclxufSgpKTtcclxuZXhwb3J0IHsgRm9ybVZpZXcgfTtcclxuIiwiaW1wb3J0IHsgRm9ybVZpZXcgfSBmcm9tIFwiLi9mb3JtVmlld1wiO1xyXG5pbXBvcnQgeyBTcEFwaUludGVyYWN0b3IgfSBmcm9tIFwiLi4vc2VydmljZXMvc3BBcGlJbnRlcmFjdG9yXCI7XHJcbmltcG9ydCB7IEdhbWVtb2RlVXBkYXRlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zZXJ2aWNlcy9nYW1lbW9kZVVwZGF0ZVNlcnZpY2VcIjtcclxudmFyIEZvcm1WaWV3QXJyYXkgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBGb3JtVmlld0FycmF5KCkge1xyXG4gICAgICAgIHRoaXMuZm9ybVZpZXdzID0gbmV3IEFycmF5KCk7XHJcbiAgICB9XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS51cGRhdGVGb3JtID0gZnVuY3Rpb24gKGZvcm0sIGkpIHtcclxuICAgICAgICB2YXIgdmlldyA9IHRoaXMuZm9ybVZpZXdzW2ldO1xyXG4gICAgICAgIGlmICghdmlldykge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1WaWV3c1tpXSA9IG5ldyBGb3JtVmlldyhmb3JtLnJlZnJJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB2aWV3LnVwZGF0ZShmb3JtKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUuZGVzdHJveUZvcm0gPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIHZhciBmb3JtVmlldyA9IHRoaXMuZm9ybVZpZXdzW2ldO1xyXG4gICAgICAgIGlmIChmb3JtVmlldyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybVZpZXcuZGVzdHJveSgpO1xyXG4gICAgICAgIHRoaXMuZm9ybVZpZXdzW2ldID0gdW5kZWZpbmVkO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uIChuZXdTaXplKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybVZpZXdzLmxlbmd0aCA+IG5ld1NpemUpIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JtVmlld3Muc2xpY2UobmV3U2l6ZSkuZm9yRWFjaChmdW5jdGlvbiAodikgeyByZXR1cm4gdiAmJiB2LmRlc3Ryb3koKTsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZm9ybVZpZXdzLmxlbmd0aCA9IG5ld1NpemU7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUudXBkYXRlQWxsID0gZnVuY3Rpb24gKG1vZGVsLCBzaG93TWUsIGlzQ2xvbmVWaWV3KSB7XHJcbiAgICAgICAgdmFyIGdhbWVtb2RlVXBkYXRlU2VydmljZSA9IFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5sb29rdXBMaXN0ZW5lcihHYW1lbW9kZVVwZGF0ZVNlcnZpY2UpO1xyXG4gICAgICAgIGdhbWVtb2RlVXBkYXRlU2VydmljZS5zZXRGb3JtVmlld0FycmF5KHRoaXMpO1xyXG4gICAgICAgIHZhciBmb3JtcyA9IG1vZGVsLmZvcm1zO1xyXG4gICAgICAgIHZhciBuID0gZm9ybXMubGVuZ3RoO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBmb3JtID0gZm9ybXNbaV07XHJcbiAgICAgICAgICAgIGlmICghZm9ybSB8fCAobW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9PT0gaSAmJiAhc2hvd01lKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95Rm9ybShpKTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciByZWFsUG9zID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB2YXIgb2Zmc2V0ID0gbW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9PT0gaSB8fCBpc0Nsb25lVmlldztcclxuICAgICAgICAgICAgaWYgKG9mZnNldCAmJiBmb3JtLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZWFsUG9zID0gZm9ybS5tb3ZlbWVudC5wb3M7XHJcbiAgICAgICAgICAgICAgICBmb3JtLm1vdmVtZW50LnBvcyA9IFtcclxuICAgICAgICAgICAgICAgICAgICByZWFsUG9zWzBdICsgMTI4LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlYWxQb3NbMV0gKyAxMjgsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVhbFBvc1syXSxcclxuICAgICAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGlzQ2xvbmVWaWV3KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IHVzaW5nIHRoZSBzYW1lIHJlZnIgYnkgbm9ybWFsIGFuZCBjbG9uZSB2aWV3c1xyXG4gICAgICAgICAgICAgICAgaWYgKCFmb3JtLnJlZnJJZCB8fCBmb3JtLnJlZnJJZCA+PSAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJhY2t1cCA9IGZvcm0uaXNIb3N0ZWRCeU90aGVyO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvcm0uaXNIb3N0ZWRCeU90aGVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBFeHBsYWluIHdoeSBkbyBub3QgR2FtZW1vZGVBcGlTdXBwb3J0LnNldEkoaSk7IGhlcmVcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZvcm0oZm9ybSwgaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9ybS5pc0hvc3RlZEJ5T3RoZXIgPSBiYWNrdXA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBnYW1lbW9kZVVwZGF0ZVNlcnZpY2Uuc2V0SShpKTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRm9ybShmb3JtLCBpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAob2Zmc2V0ICYmIGZvcm0ubW92ZW1lbnQgJiYgcmVhbFBvcykge1xyXG4gICAgICAgICAgICAgICAgZm9ybS5tb3ZlbWVudC5wb3MgPSByZWFsUG9zO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLnN5bmNGb3JtVmlldyA9IGZ1bmN0aW9uIChtb2RlbCwgc2hvd01lKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RlbC5mb3Jtcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAoIW1vZGVsLmZvcm1zW2ldIHx8IChtb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID09PSBpICYmICFzaG93TWUpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3lGb3JtKGkpO1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUuZ2V0UmVtb3RlUmVmcklkID0gZnVuY3Rpb24gKGNsaWVudHNpZGVSZWZySWQpIHtcclxuICAgICAgICBpZiAoY2xpZW50c2lkZVJlZnJJZCA8IDB4ZmYwMDAwMDApXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZnVuY3Rpb24gaXMgb25seSBmb3IgMHhmZiBmb3Jtc1wiKTtcclxuICAgICAgICB2YXIgZm9ybVZpZXcgPSB0aGlzLmZvcm1WaWV3cy5maW5kKGZ1bmN0aW9uIChmb3JtVmlldykge1xyXG4gICAgICAgICAgICByZXR1cm4gZm9ybVZpZXcgJiYgZm9ybVZpZXcuZ2V0TG9jYWxSZWZySWQoKSA9PT0gY2xpZW50c2lkZVJlZnJJZDtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZm9ybVZpZXcgPyBmb3JtVmlldy5nZXRSZW1vdGVSZWZySWQoKSA6IDA7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUuZ2V0TG9jYWxSZWZySWQgPSBmdW5jdGlvbiAocmVtb3RlUmVmcklkKSB7XHJcbiAgICAgICAgaWYgKHJlbW90ZVJlZnJJZCA8IDB4ZmYwMDAwMDApXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZnVuY3Rpb24gaXMgb25seSBmb3IgMHhmZiBmb3Jtc1wiKTtcclxuICAgICAgICB2YXIgZm9ybVZpZXcgPSB0aGlzLmZvcm1WaWV3cy5maW5kKGZ1bmN0aW9uIChmb3JtVmlldykge1xyXG4gICAgICAgICAgICByZXR1cm4gZm9ybVZpZXcgJiYgZm9ybVZpZXcuZ2V0UmVtb3RlUmVmcklkKCkgPT09IHJlbW90ZVJlZnJJZDtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZm9ybVZpZXcgPyBmb3JtVmlldy5nZXRMb2NhbFJlZnJJZCgpIDogMDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5nZXROdGhGb3JtVmlldyA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybVZpZXdzW2ldO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLmdldEZvcm1WaWV3c0FycmF5TGVuZ3RoID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZvcm1WaWV3cy5sZW5ndGg7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEZvcm1WaWV3QXJyYXk7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IEZvcm1WaWV3QXJyYXkgfTtcclxuIiwiaW1wb3J0IHsgc3RvcmFnZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5zdG9yYWdlW1wiaG9zdEF0dGVtcHRzXCJdID0gW107XHJcbmV4cG9ydCB2YXIgdHJ5SG9zdCA9IGZ1bmN0aW9uICh0YXJnZXRSZW1vdGVJZCkge1xyXG4gICAgc3RvcmFnZVtcImhvc3RBdHRlbXB0c1wiXS5wdXNoKHRhcmdldFJlbW90ZUlkKTtcclxufTtcclxuZXhwb3J0IHZhciBuZXh0SG9zdEF0dGVtcHQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgYXJyID0gc3RvcmFnZVtcImhvc3RBdHRlbXB0c1wiXTtcclxuICAgIGlmIChhcnIubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIHJldHVybiBhcnIuc2hpZnQoKTtcclxufTtcclxuZXhwb3J0IHZhciBsYXN0VHJ5SG9zdCA9IHt9O1xyXG4iLCJpbXBvcnQgeyBPYmplY3RSZWZlcmVuY2UsIEdhbWUsIFRleHR1cmVTZXQsIE5ldEltbWVyc2UgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgYXBwbHlJbnZlbnRvcnkgfSBmcm9tIFwiLi4vc3luYy9pbnZlbnRvcnlcIjtcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uL2xvZ2dpbmdcIjtcclxuLy8gRm9yIDB4ZmYwMDAwMDArIHVzZWQgZnJvbSBGb3JtVmlld1xyXG4vLyBGb3Igb2JqZWN0cyBmcm9tIG1hc3RlciBmaWxlcyB1c2VkIGRpcmVjdGx5IGZyb20gcmVtb3RlU2VydmVyLnRzXHJcbnZhciBNb2RlbEFwcGx5VXRpbHMgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBNb2RlbEFwcGx5VXRpbHMoKSB7XHJcbiAgICB9XHJcbiAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbEludmVudG9yeSA9IGZ1bmN0aW9uIChyZWZyLCBpbnZlbnRvcnkpIHtcclxuICAgICAgICBhcHBseUludmVudG9yeShyZWZyLCBpbnZlbnRvcnksIGZhbHNlLCB0cnVlKTtcclxuICAgIH07XHJcbiAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzT3BlbiA9IGZ1bmN0aW9uIChyZWZyLCBpc09wZW4pIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgcmVmci5zZXRPcGVuKGlzT3Blbik7XHJcbiAgICAgICAgLy8gU2VlIGFsc28gb2JqZWN0UmVmZXJlbmNlRXgudHNcclxuICAgICAgICB2YXIgY2F2ZUdTZWNyZXREb29yMDEgPSAweDZmNzAzO1xyXG4gICAgICAgIC8vIFRPRE86IGFkZCBtb3JlIGFjdGl2YXRvcnMgdG8gc3VwcG9ydCBtb3JlIGNlbGxzXHJcbiAgICAgICAgdmFyIHBhcmVudEFjdGl2YXRvcklkID0gMHg0NjBjYTtcclxuICAgICAgICBpZiAoKChfYSA9IHJlZnIuZ2V0QmFzZU9iamVjdCgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Rm9ybUlEKCkpID09PSBjYXZlR1NlY3JldERvb3IwMSkge1xyXG4gICAgICAgICAgICB2YXIgb3Blbk9yT3BlbmluZyA9IFsxLCAyXS5pbmNsdWRlcyhyZWZyLmdldE9wZW5TdGF0ZSgpKTtcclxuICAgICAgICAgICAgaWYgKG9wZW5Pck9wZW5pbmcpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNPcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmci5hY3RpdmF0ZShPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm0ocGFyZW50QWN0aXZhdG9ySWQpKSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghb3Blbk9yT3BlbmluZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzT3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnIuYWN0aXZhdGUoT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtKHBhcmVudEFjdGl2YXRvcklkKSksIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzRGlzYWJsZWQgPSBmdW5jdGlvbiAocmVmciwgZGlzYWJsZWQpIHtcclxuICAgICAgICB2YXIgd2FzRGlzYWJsZWQgPSByZWZyLmlzRGlzYWJsZWQoKTtcclxuICAgICAgICBpZiAod2FzRGlzYWJsZWQgPT0gZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgcmVmci5kaXNhYmxlKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJlZnIuZW5hYmxlKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzSGFydmVzdGVkID0gZnVuY3Rpb24gKHJlZnIsIGlzSGFydmVzdGVkKSB7XHJcbiAgICAgICAgdmFyIGJhc2UgPSByZWZyLmdldEJhc2VPYmplY3QoKTtcclxuICAgICAgICBpZiAoYmFzZSkge1xyXG4gICAgICAgICAgICB2YXIgdCA9IGJhc2UuZ2V0VHlwZSgpO1xyXG4gICAgICAgICAgICBpZiAodCA9PSAzOCAvKiBGb3JtVHlwZS5UcmVlICovIHx8IHQgPT0gMzkgLyogRm9ybVR5cGUuRmxvcmEgKi8pIHtcclxuICAgICAgICAgICAgICAgIHZhciB3YXNIYXJ2ZXN0ZWQgPSByZWZyLmlzSGFydmVzdGVkKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNIYXJ2ZXN0ZWQgIT0gd2FzSGFydmVzdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFjID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNIYXJ2ZXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAyMDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYyA9IEdhbWUuZmluZFJhbmRvbUFjdG9yKHJlZnIuZ2V0UG9zaXRpb25YKCksIHJlZnIuZ2V0UG9zaXRpb25ZKCksIHJlZnIuZ2V0UG9zaXRpb25aKCksIDEwMDAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhYyAmJiBhYy5nZXRGb3JtSUQoKSAhPT0gMHgxNCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0hhcnZlc3RlZCAmJiBhYyAmJiBhYy5nZXRGb3JtSUQoKSAhPT0gMHgxNCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyLmFjdGl2YXRlKGFjLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuc2V0SGFydmVzdGVkKGlzSGFydmVzdGVkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkXzEgPSByZWZyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyLmRpc2FibGUoZmFsc2UpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3RvcmVkUmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGlkXzEpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN0b3JlZFJlZnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN0b3JlZFJlZnIuZW5hYmxlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHdhc0hhcnZlc3RlZCA9IHJlZnIuaXNEaXNhYmxlZCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzSGFydmVzdGVkICE9IHdhc0hhcnZlc3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0hhcnZlc3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWRfMiA9IHJlZnIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuZGlzYWJsZShmYWxzZSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdG9yZWRSZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgoaWRfMikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3RvcmVkUmVmciAmJiAhcmVzdG9yZWRSZWZyLmlzRGlzYWJsZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3RvcmVkUmVmci5kZWxldGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWxldGlvbiB0YWtlcyB0aW1lLCBzbyBpbiBwcmFjdGljZSB0aGlzIHdvdWxkIGJlIGNhbGxlZCBhIGxvdCBvZiB0aW1lc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuZW5hYmxlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbE5vZGVUZXh0dXJlU2V0ID0gZnVuY3Rpb24gKHJlZnIsIHNldE5vZGVUZXh0dXJlU2V0KSB7XHJcbiAgICAgICAgaWYgKHNldE5vZGVUZXh0dXJlU2V0KSB7XHJcbiAgICAgICAgICAgIHNldE5vZGVUZXh0dXJlU2V0LmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBmaXJzdFBlcnNvbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRleHR1cmVTZXQgPSBUZXh0dXJlU2V0LmZyb20oR2FtZS5nZXRGb3JtRXgoZWxlbWVudC50ZXh0dXJlU2V0SWQpKTtcclxuICAgICAgICAgICAgICAgIGlmICh0ZXh0dXJlU2V0ICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5zZXROb2RlVGV4dHVyZVNldChyZWZyLCBlbGVtZW50Lm5vZGVOYW1lLCB0ZXh0dXJlU2V0LCBmaXJzdFBlcnNvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoXCJNb2RlbEFwcGx5VXRpbHNcIiwgcmVmci5nZXRGb3JtSUQoKS50b1N0cmluZygxNiksIFwiQXBwbGllZCB0ZXh0dXJlIHNldFwiLCBlbGVtZW50LnRleHR1cmVTZXRJZC50b1N0cmluZygxNiksIFwidG9cIiwgZWxlbWVudC5ub2RlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihcIk1vZGVsQXBwbHlVdGlsc1wiLCByZWZyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSwgXCJGYWlsZWQgdG8gYXBwbHkgdGV4dHVyZSBzZXRcIiwgZWxlbWVudC50ZXh0dXJlU2V0SWQudG9TdHJpbmcoMTYpLCBcInRvXCIsIGVsZW1lbnQubm9kZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxOb2RlU2NhbGUgPSBmdW5jdGlvbiAocmVmciwgc2V0Tm9kZVNjYWxlKSB7XHJcbiAgICAgICAgaWYgKHNldE5vZGVTY2FsZSkge1xyXG4gICAgICAgICAgICBzZXROb2RlU2NhbGUuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZpcnN0UGVyc29uID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLnNldE5vZGVTY2FsZShyZWZyLCBlbGVtZW50Lm5vZGVOYW1lLCBlbGVtZW50LnNjYWxlLCBmaXJzdFBlcnNvbik7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShcIk1vZGVsQXBwbHlVdGlsc1wiLCByZWZyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSwgXCJBcHBsaWVkIG5vZGUgc2NhbGVcIiwgZWxlbWVudC5zY2FsZSwgXCJ0b1wiLCBlbGVtZW50Lm5vZGVOYW1lKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBNb2RlbEFwcGx5VXRpbHM7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IE1vZGVsQXBwbHlVdGlscyB9O1xyXG4iLCJpbXBvcnQgeyBHYW1lIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSBcIi4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXhcIjtcclxudmFyIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyKCkge1xyXG4gICAgfVxyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci51cGRhdGVEYXRhID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgcGxheWVyID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBpZiAoIXBsYXllcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5KdW1wU3RhdGUgPSBwbGF5ZXIuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiYkluSnVtcFN0YXRlXCIpO1xyXG4gICAgICAgIHRoaXMud29ybGRPckNlbGwgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbChwbGF5ZXIpO1xyXG4gICAgICAgIHRoaXMuY3Jvc3NoYWlyUmVmSWQgPSAoKF9hID0gR2FtZS5nZXRDdXJyZW50Q3Jvc3NoYWlyUmVmKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGb3JtSUQoKSkgfHwgMDtcclxuICAgIH07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmlzSW5KdW1wU3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5KdW1wU3RhdGU7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRXb3JsZE9yQ2VsbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JsZE9yQ2VsbDtcclxuICAgIH07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldENyb3NzaGFpclJlZklkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNyb3NzaGFpclJlZklkO1xyXG4gICAgfTtcclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuaW5KdW1wU3RhdGUgPSBmYWxzZTtcclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIud29ybGRPckNlbGwgPSAwO1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5jcm9zc2hhaXJSZWZJZCA9IDA7XHJcbiAgICByZXR1cm4gUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlcjtcclxufSgpKTtcclxuZXhwb3J0IHsgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlciB9O1xyXG4iLCJpbXBvcnQgeyBPYmplY3RSZWZlcmVuY2UsIEdhbWUsIEFjdG9yIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGFwcGx5VGludHMgfSBmcm9tIFwiLi4vc3luYy9hcHBlYXJhbmNlXCI7XHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSBcIi4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXhcIjtcclxudmFyIFNwYXduUHJvY2VzcyA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIFNwYXduUHJvY2VzcyhhcHBlYXJhbmNlLCBwb3MsIHJlZnJJZCwgY2FsbGJhY2spIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjaztcclxuICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgIGlmICghcmVmciB8fCByZWZyLmdldEZvcm1JRCgpICE9PSByZWZySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZWZyLnNldFBvc2l0aW9uLmFwcGx5KHJlZnIsIHBvcykudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5lbmFibGUoYXBwZWFyYW5jZSwgcmVmcklkKTsgfSk7XHJcbiAgICB9XHJcbiAgICBTcGF3blByb2Nlc3MucHJvdG90eXBlLmVuYWJsZSA9IGZ1bmN0aW9uIChhcHBlYXJhbmNlLCByZWZySWQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgaWYgKCFyZWZyIHx8IHJlZnIuZ2V0Rm9ybUlEKCkgIT09IHJlZnJJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgaWYgKGFjICYmIGFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgYXBwbHlUaW50cyhhYywgYXBwZWFyYW5jZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlZnIuZW5hYmxlKGZhbHNlKS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLnJlc3VycmVjdChyZWZySWQpOyB9KTtcclxuICAgIH07XHJcbiAgICBTcGF3blByb2Nlc3MucHJvdG90eXBlLnJlc3VycmVjdCA9IGZ1bmN0aW9uIChyZWZySWQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgaWYgKCFyZWZyIHx8IHJlZnIuZ2V0Rm9ybUlEKCkgIT09IHJlZnJJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhYy5yZXN1cnJlY3QoKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLmNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBPYmplY3RSZWZlcmVuY2VFeC5kZWFsV2l0aFJlZihyZWZyLCByZWZyLmdldEJhc2VPYmplY3QoKSk7XHJcbiAgICAgICAgcmV0dXJuIHJlZnIuc2V0TW90aW9uVHlwZSg0IC8qIE1vdGlvblR5cGUuS2V5ZnJhbWVkICovLCB0cnVlKS50aGVuKHRoaXMuY2FsbGJhY2spO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTcGF3blByb2Nlc3M7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IFNwYXduUHJvY2VzcyB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgRm9ybVZpZXdBcnJheSB9IGZyb20gJy4vZm9ybVZpZXdBcnJheSc7XHJcbmltcG9ydCB7IFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIgfSBmcm9tICcuL3BsYXllckNoYXJhY3RlckRhdGFIb2xkZXInO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gJy4uL3NlcnZpY2VzL3NlcnZpY2VzL2NsaWVudExpc3RlbmVyJztcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBTaW5nbGVQbGF5ZXJTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NlcnZpY2VzL3NpbmdsZVBsYXllclNlcnZpY2VcIjtcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NlcnZpY2VzL3JlbW90ZVNlcnZlclwiO1xyXG52YXIgV29ybGRWaWV3ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFdvcmxkVmlldywgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFdvcmxkVmlldyhzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBjb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLnN0YXRlID0gX3RoaXMubWFrZUVtcHR5U3RhdGUoKTtcclxuICAgICAgICB2YXIgb2xkVmlldyA9IF90aGlzLnNwLnN0b3JhZ2VbXCJ2aWV3XCJdO1xyXG4gICAgICAgIC8vIGNhbid0IHVzZSBpbnN0YW5jZW9mIGhlcmUgYmVjYXVzZSBlYWNoIGhvdCByZWxvYWQgY3JlYXRlcyBhIG5ldyBjbGFzc1xyXG4gICAgICAgIF90aGlzLm9sZFZpZXcgPSB0eXBlb2Ygb2xkVmlldyA9PT0gXCJvYmplY3RcIiA/IG9sZFZpZXcgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVtcInZpZXdcIl0gPSBfdGhpcztcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLmdldFJlbW90ZVJlZnJJZCA9IGZ1bmN0aW9uIChjbGllbnRzaWRlUmVmcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZm9ybVZpZXdzLmdldFJlbW90ZVJlZnJJZChjbGllbnRzaWRlUmVmcklkKTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLmdldExvY2FsUmVmcklkID0gZnVuY3Rpb24gKHJlbW90ZVJlZnJJZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmZvcm1WaWV3cy5nZXRMb2NhbFJlZnJJZChyZW1vdGVSZWZySWQpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUuc3luY0Zvcm1BcnJheSA9IGZ1bmN0aW9uIChtb2RlbCkge1xyXG4gICAgICAgIHZhciBzZXR0aW5ncyA9IHRoaXMuc3Auc2V0dGluZ3M7XHJcbiAgICAgICAgdmFyIHNob3dNZSA9IHNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3Nob3ctbWUnXTtcclxuICAgICAgICB0aGlzLnN0YXRlLmZvcm1WaWV3cy5zeW5jRm9ybVZpZXcobW9kZWwsICEhc2hvd01lKTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5mb3JtVmlld3MucmVzaXplKDApO1xyXG4gICAgICAgIHRoaXMuc3RhdGUuY2xvbmVGb3JtVmlld3MucmVzaXplKDApOyAvLyBSZWNlbnJseSBhZGRlZCwgbm90IHRlc3RlZCBpZiBpdCdzIG5lZWRlZFxyXG4gICAgICAgIHRoaXMuc3RhdGUgPSB0aGlzLm1ha2VFbXB0eVN0YXRlKCk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5nZXRGb3JtVmlld3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZm9ybVZpZXdzO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5yZXNldEFsbEZvcm1WaWV3c0lmUGxheWVyQ2hhbmdlZFdvcmxkKCk7XHJcbiAgICAgICAgdmFyIHNpbmdsZVBsYXllclNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2luZ2xlUGxheWVyU2VydmljZSk7XHJcbiAgICAgICAgaWYgKCFzaW5nbGVQbGF5ZXJTZXJ2aWNlLmlzU2luZ2xlUGxheWVyKSB7XHJcbiAgICAgICAgICAgIHZhciBtb2RlbFNvdXJjZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSZW1vdGVTZXJ2ZXIpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVdvcmxkKG1vZGVsU291cmNlLmdldFdvcmxkTW9kZWwoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy5vbGRWaWV3KSB7XHJcbiAgICAgICAgICAgIHRoaXMub2xkVmlldy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIHRoaXMub2xkVmlldyA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1ByZXZpb3VzIFZpZXcgZGVzdHJveWVkJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMud2FpdEdhbWVUaW1lQW5kQWxsb3dGb3JtVmlld1VwZGF0ZSgxLjApO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUucmVzZXRBbGxGb3JtVmlld3NJZlBsYXllckNoYW5nZWRXb3JsZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgc3RhdGUgPSB0aGlzLnN0YXRlO1xyXG4gICAgICAgIHZhciBwYyA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICB2YXIgcGNXb3JsZE9yQ2VsbCA9IChwYy5nZXRXb3JsZFNwYWNlKCkgfHwgcGMuZ2V0UGFyZW50Q2VsbCgpKS5nZXRGb3JtSUQoKTtcclxuICAgICAgICBpZiAoc3RhdGUucGNXb3JsZE9yQ2VsbCAhPT0gcGNXb3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICBpZiAoc3RhdGUucGNXb3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1Jlc2V0IGFsbCBmb3JtIHZpZXdzJyk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5mb3JtVmlld3MucmVzaXplKDApO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuY2xvbmVGb3JtVmlld3MucmVzaXplKDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHN0YXRlLnBjV29ybGRPckNlbGwgPSBwY1dvcmxkT3JDZWxsO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvLyBXb3JrIGFyb3VuZCBzaG93UmFjZU1lbnUgaXNzdWVcclxuICAgIC8vIERlZmF1bHQgbm9yZCBpbiBSYWNlIE1lbnUgd2lsbCBoYXZlIHZlcnkgdWdseSBmYWNlXHJcbiAgICAvLyBJZiBvdGhlciBwbGF5ZXJzIGFyZSBzcGF3bmluZyB3aGVuIHdlIHNob3cgdGhpcyBtZW51XHJcbiAgICAvLyBUT0RPOiBzZXBhcmF0ZSBsaXN0ZW5lclxyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS53YWl0R2FtZVRpbWVBbmRBbGxvd0Zvcm1WaWV3VXBkYXRlID0gZnVuY3Rpb24gKHNlY29uZHMpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIC8vIFdhaXQgMXMgZ2FtZSB0aW1lICh0aW1lIHNwZW50IGluIFJhY2UgTWVudSBpc24ndCBjb3VudGVkKVxyXG4gICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KHNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBfdGhpcy5zdGF0ZS5hbGxvd1VwZGF0ZSA9IHRydWU7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCAnVXBkYXRlIGlzIG5vdyBhbGxvd2VkJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5zZXRGb3JtVmlld1VwZGF0ZUFsbG93ZWQgPSBmdW5jdGlvbiAoYWxsb3dlZCkge1xyXG4gICAgICAgIHRoaXMuc3RhdGUuYWxsb3dVcGRhdGUgPSBhbGxvd2VkO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsICdVcGRhdGUgaXMgbm93JywgYWxsb3dlZCA/ICdhbGxvd2VkJyA6ICdkaXNhbGxvd2VkJyk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS51cGRhdGVXb3JsZCA9IGZ1bmN0aW9uIChtb2RlbCkge1xyXG4gICAgICAgIHZhciBzZXR0aW5ncyA9IHRoaXMuc3Auc2V0dGluZ3M7XHJcbiAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5zdGF0ZTtcclxuICAgICAgICBpZiAoIXN0YXRlLmFsbG93VXBkYXRlKSB7XHJcbiAgICAgICAgICAgIG1vZGVsID0ge1xyXG4gICAgICAgICAgICAgICAgZm9ybXM6IFtdLFxyXG4gICAgICAgICAgICAgICAgcGxheWVyQ2hhcmFjdGVyRm9ybUlkeDogbW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCxcclxuICAgICAgICAgICAgICAgIHBsYXllckNoYXJhY3RlclJlZnJJZDogbW9kZWwucGxheWVyQ2hhcmFjdGVyUmVmcklkXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBza2lwVXBkYXRlcyA9IHNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3NraXBVcGRhdGVzJ107XHJcbiAgICAgICAgLy8gc2tpcCA1MCUgb2YgdXBkYXRlcyBpZiBzcGVjaWZpZWQgaW4gdGhlIHNldHRpbmdzXHJcbiAgICAgICAgc3RhdGUuY291bnRlciA9ICFzdGF0ZS5jb3VudGVyO1xyXG4gICAgICAgIGlmIChzdGF0ZS5jb3VudGVyICYmIHNraXBVcGRhdGVzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RhdGUuZm9ybVZpZXdzLnJlc2l6ZShtb2RlbC5mb3Jtcy5sZW5ndGgpO1xyXG4gICAgICAgIHZhciBzaG93TWUgPSBzZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzaG93LW1lJ107XHJcbiAgICAgICAgdmFyIHNob3dDbG9uZXMgPSBzZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzaG93LWNsb25lcyddO1xyXG4gICAgICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIudXBkYXRlRGF0YSgpO1xyXG4gICAgICAgIHN0YXRlLmZvcm1WaWV3cy51cGRhdGVBbGwobW9kZWwsICEhc2hvd01lLCBmYWxzZSk7XHJcbiAgICAgICAgaWYgKHNob3dDbG9uZXMpIHtcclxuICAgICAgICAgICAgc3RhdGUuY2xvbmVGb3JtVmlld3MudXBkYXRlQWxsKG1vZGVsLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBzdGF0ZS5jbG9uZUZvcm1WaWV3cy5yZXNpemUoMCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUubWFrZUVtcHR5U3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZm9ybVZpZXdzOiBuZXcgRm9ybVZpZXdBcnJheSgpLFxyXG4gICAgICAgICAgICBjbG9uZUZvcm1WaWV3czogbmV3IEZvcm1WaWV3QXJyYXkoKSxcclxuICAgICAgICAgICAgYWxsb3dVcGRhdGU6IGZhbHNlLFxyXG4gICAgICAgICAgICBwY1dvcmxkT3JDZWxsOiAwLFxyXG4gICAgICAgICAgICBjb3VudGVyOiBmYWxzZSxcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIHJldHVybiBXb3JsZFZpZXc7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgV29ybGRWaWV3IH07XHJcbiIsImltcG9ydCB7IEdhbWUsIE9iamVjdFJlZmVyZW5jZSwgc3RvcmFnZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBTcEFwaUludGVyYWN0b3IgfSBmcm9tICcuLi9zZXJ2aWNlcy9zcEFwaUludGVyYWN0b3InO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi4vc2VydmljZXMvc2VydmljZXMvcmVtb3RlU2VydmVyXCI7XHJcbmV4cG9ydCB2YXIgZ2V0Vmlld0Zyb21TdG9yYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHJlcyA9IHN0b3JhZ2VbXCJ2aWV3XCJdO1xyXG4gICAgLy8gY2FuJ3QgdXNlIGluc3RhbmNlb2YgaGVyZSBiZWNhdXNlIGVhY2ggaG90IHJlbG9hZCBjcmVhdGVzIGEgbmV3IGNsYXNzXHJcbiAgICBpZiAodHlwZW9mIHJlcyA9PT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG59O1xyXG5leHBvcnQgdmFyIGxvY2FsSWRUb1JlbW90ZUlkID0gZnVuY3Rpb24gKGxvY2FsRm9ybUlkLCBuZXdDYXN0KSB7XHJcbiAgICBpZiAobmV3Q2FzdCA9PT0gdm9pZCAwKSB7IG5ld0Nhc3QgPSBmYWxzZTsgfVxyXG4gICAgaWYgKG5ld0Nhc3QgJiYgbG9jYWxGb3JtSWQgPT0gMHgxNCkge1xyXG4gICAgICAgIHJldHVybiBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkubG9va3VwTGlzdGVuZXIoUmVtb3RlU2VydmVyKS5nZXRNeVJlbW90ZVJlZnJJZCgpO1xyXG4gICAgfVxyXG4gICAgaWYgKGxvY2FsRm9ybUlkID49IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICB2YXIgdmlldyA9IGdldFZpZXdGcm9tU3RvcmFnZSgpO1xyXG4gICAgICAgIGlmICghdmlldykge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9jYWxGb3JtSWQgPSB2aWV3LmdldFJlbW90ZVJlZnJJZChsb2NhbEZvcm1JZCk7XHJcbiAgICAgICAgaWYgKCFsb2NhbEZvcm1JZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gc2VydmVyc2lkZSBpZHMgYXJlIDY0Yml0XHJcbiAgICAgICAgaWYgKGxvY2FsRm9ybUlkID49IDB4MTAwMDAwMDAwKSB7XHJcbiAgICAgICAgICAgIGxvY2FsRm9ybUlkIC09IDB4MTAwMDAwMDAwO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBsb2NhbEZvcm1JZDtcclxufTtcclxuZXhwb3J0IHZhciByZW1vdGVJZFRvTG9jYWxJZCA9IGZ1bmN0aW9uIChyZW1vdGVGb3JtSWQpIHtcclxuICAgIGlmIChyZW1vdGVGb3JtSWQgPj0gMHhmZjAwMDAwMCkge1xyXG4gICAgICAgIHZhciB2aWV3ID0gZ2V0Vmlld0Zyb21TdG9yYWdlKCk7XHJcbiAgICAgICAgaWYgKCF2aWV3KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZW1vdGVGb3JtSWQgPSB2aWV3LmdldExvY2FsUmVmcklkKHJlbW90ZUZvcm1JZCk7XHJcbiAgICAgICAgaWYgKCFyZW1vdGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlbW90ZUZvcm1JZDtcclxufTtcclxuZXhwb3J0IHZhciBnZXRPYmplY3RSZWZlcmVuY2UgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgdmFyIHZpZXcgPSBnZXRWaWV3RnJvbVN0b3JhZ2UoKTtcclxuICAgIGlmICh2aWV3KSB7XHJcbiAgICAgICAgdmFyIGZvcm1WaWV3ID0gdmlldy5nZXRGb3JtVmlld3MoKS5nZXROdGhGb3JtVmlldyhpKTtcclxuICAgICAgICBpZiAoZm9ybVZpZXcpIHtcclxuICAgICAgICAgICAgdmFyIHJlZnJJZCA9IGZvcm1WaWV3LmdldExvY2FsUmVmcklkKCk7XHJcbiAgICAgICAgICAgIGlmIChyZWZySWQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnIgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVmcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59O1xyXG4iLCJtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoXCJjcnlwdG9cIik7IiwibW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKFwiZnNcIik7IiwibW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKFwiaW5zcGVjdG9yXCIpOyIsIm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShcIm5vZGU6Y3J5cHRvXCIpOyIsIm1vZHVsZS5leHBvcnRzID0gc2t5cmltUGxhdGZvcm07IiwiaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICcuL2luZGV4LmpzJ1xuXG5leHBvcnQgeyBFdmVudEVtaXR0ZXIgfVxuZXhwb3J0IGRlZmF1bHQgRXZlbnRFbWl0dGVyXG4iLCIvLyBUaGUgbW9kdWxlIGNhY2hlXG52YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307XG5cbi8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG5mdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuXHR2YXIgY2FjaGVkTW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXTtcblx0aWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0cmV0dXJuIGNhY2hlZE1vZHVsZS5leHBvcnRzO1xuXHR9XG5cdC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpXG5cdHZhciBtb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdID0ge1xuXHRcdC8vIG5vIG1vZHVsZS5pZCBuZWVkZWRcblx0XHQvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZFxuXHRcdGV4cG9ydHM6IHt9XG5cdH07XG5cblx0Ly8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uXG5cdF9fd2VicGFja19tb2R1bGVzX19bbW9kdWxlSWRdKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pO1xuXG5cdC8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlXG5cdHJldHVybiBtb2R1bGUuZXhwb3J0cztcbn1cblxuIiwiLy8gZ2V0RGVmYXVsdEV4cG9ydCBmdW5jdGlvbiBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG5vbi1oYXJtb255IG1vZHVsZXNcbl9fd2VicGFja19yZXF1aXJlX18ubiA9IChtb2R1bGUpID0+IHtcblx0dmFyIGdldHRlciA9IG1vZHVsZSAmJiBtb2R1bGUuX19lc01vZHVsZSA/XG5cdFx0KCkgPT4gKG1vZHVsZVsnZGVmYXVsdCddKSA6XG5cdFx0KCkgPT4gKG1vZHVsZSk7XG5cdF9fd2VicGFja19yZXF1aXJlX18uZChnZXR0ZXIsIHsgYTogZ2V0dGVyIH0pO1xuXHRyZXR1cm4gZ2V0dGVyO1xufTsiLCIvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9ucyBmb3IgaGFybW9ueSBleHBvcnRzXG5fX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSAoZXhwb3J0cywgZGVmaW5pdGlvbikgPT4ge1xuXHRmb3IodmFyIGtleSBpbiBkZWZpbml0aW9uKSB7XG5cdFx0aWYoX193ZWJwYWNrX3JlcXVpcmVfXy5vKGRlZmluaXRpb24sIGtleSkgJiYgIV9fd2VicGFja19yZXF1aXJlX18ubyhleHBvcnRzLCBrZXkpKSB7XG5cdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywga2V5LCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZGVmaW5pdGlvbltrZXldIH0pO1xuXHRcdH1cblx0fVxufTsiLCJfX3dlYnBhY2tfcmVxdWlyZV9fLm8gPSAob2JqLCBwcm9wKSA9PiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIiwiLy8gZGVmaW5lIF9fZXNNb2R1bGUgb24gZXhwb3J0c1xuX193ZWJwYWNrX3JlcXVpcmVfXy5yID0gKGV4cG9ydHMpID0+IHtcblx0aWYodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgJiYgU3ltYm9sLnRvU3RyaW5nVGFnKSB7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogJ01vZHVsZScgfSk7XG5cdH1cblx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgeyB2YWx1ZTogdHJ1ZSB9KTtcbn07IiwiaW1wb3J0IHsgR2FtZSwgVXRpbGl0eSwgb25jZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBTa3ltcENsaWVudCB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3NreW1wQ2xpZW50XCI7XHJcbmltcG9ydCAqIGFzIHNwIGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zZXJ2aWNlcy9ibG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlJztcclxuaW1wb3J0IHsgRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2VydmljZXMvZW5mb3JjZUxpbWl0YXRpb25zU2VydmljZSc7XHJcbmltcG9ydCB7IExvYWRHYW1lU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2VydmljZXMvbG9hZEdhbWVTZXJ2aWNlJztcclxuaW1wb3J0IHsgU2VuZElucHV0c1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3NlcnZpY2VzL3NlbmRJbnB1dHNTZXJ2aWNlJztcclxuaW1wb3J0IHsgU2luZ2xlUGxheWVyU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2VydmljZXMvc2luZ2xlUGxheWVyU2VydmljZSc7XHJcbmltcG9ydCB7IFNwQXBpSW50ZXJhY3RvciB9IGZyb20gJy4vc2VydmljZXMvc3BBcGlJbnRlcmFjdG9yJztcclxuaW1wb3J0IHsgVGltZVNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy90aW1lU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTcFZlcnNpb25DaGVja1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zcFZlcnNpb25DaGVja1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgQ29uc29sZUNvbW1hbmRzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2NvbnNvbGVDb21tYW5kc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgTGFzdEludlNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9sYXN0SW52U2VydmljZVwiO1xyXG5pbXBvcnQgeyBBY3RpdmF0aW9uU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2FjdGl2YXRpb25TZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENyYWZ0U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2NyYWZ0U2VydmljZVwiO1xyXG5pbXBvcnQgeyBEcm9wSXRlbVNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9kcm9wSXRlbVNlcnZpY2VcIjtcclxuaW1wb3J0IHsgSGl0U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2hpdFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgUmFnZG9sbFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9yYWdkb2xsU2VydmljZVwiO1xyXG5pbXBvcnQgeyBEZWF0aFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9kZWF0aFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQ29udGFpbmVyc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9jb250YWluZXJzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBOZXR3b3JraW5nU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL25ldHdvcmtpbmdTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3JlbW90ZVNlcnZlclwiO1xyXG5pbXBvcnQgeyBTcFNuaXBwZXRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3BTbmlwcGV0U2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Rpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IERpc2FibGVGYXN0VHJhdmVsU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Rpc2FibGVGYXN0VHJhdmVsU2VydmljZVwiO1xyXG5pbXBvcnQgeyBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9kaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZVwiO1xyXG5pbXBvcnQgeyBXb3JsZENsZWFuZXJTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvd29ybGRDbGVhbmVyU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9sb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEJyb3dzZXJTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvYnJvd3NlclNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9hdXRoU2VydmljZVwiO1xyXG5pbXBvcnQgeyBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvY2hhcmFjdGVyU2VsZWN0U2VydmljZVwiO1xyXG5pbXBvcnQgeyBOZXRJbmZvU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL25ldEluZm9TZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEFuaW1EZWJ1Z1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9hbmltRGVidWdTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFRpbWVyc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy90aW1lcnNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFBsYXllckJvd1Nob3RTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvcGxheWVyQm93U2hvdFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9nYW1lbW9kZUV2ZW50U291cmNlU2VydmljZVwiO1xyXG5pbXBvcnQgeyBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9nYW1lbW9kZVVwZGF0ZVNlcnZpY2VcIjtcclxuaW1wb3J0IHsgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZnJvbnRIb3RSZWxvYWRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEJsb2NrZWRBbmltYXRpb25zU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Jsb2NrZWRBbmltYXRpb25zU2VydmljZVwiO1xyXG5pbXBvcnQgeyBWb2ljZUNoYXRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvdm9pY2VDaGF0U2VydmljZVwiO1xyXG5pbXBvcnQgeyBXb3JsZFZpZXcgfSBmcm9tIFwiLi92aWV3L3dvcmxkVmlld1wiO1xyXG5pbXBvcnQgeyBLZXlib2FyZEV2ZW50c1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9rZXlib2FyZEV2ZW50c1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgTWFnaWNTeW5jU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL21hZ2ljU3luY1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgUHJvZmlsaW5nU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3Byb2ZpbGluZ1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc2V0dGluZ3NTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2VcIjtcclxub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICBVdGlsaXR5LnNldElOSUJvb2woXCJiQWx3YXlzQWN0aXZlOkdlbmVyYWxcIiwgdHJ1ZSk7XHJcbiAgICBHYW1lLnNldEdhbWVTZXR0aW5nSW50KFwiaURlYXRoRHJvcFdlYXBvbkNoYW5jZVwiLCAwKTtcclxufSk7XHJcbnZhciBtYWluID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICB2YXIgY29udHJvbGxlciA9IFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKTtcclxuICAgICAgICB2YXIgbGlzdGVuZXJzID0gW1xyXG4gICAgICAgICAgICBuZXcgQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBMb2FkR2FtZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU2luZ2xlUGxheWVyU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNlbmRJbnB1dHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNreW1wQ2xpZW50KHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFRpbWVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNwVmVyc2lvbkNoZWNrU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IExhc3RJbnZTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEFjdGl2YXRpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IENyYWZ0U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBEcm9wSXRlbVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgSGl0U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBSYWdkb2xsU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBEZWF0aFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQ29udGFpbmVyc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgTmV0d29ya2luZ1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgUmVtb3RlU2VydmVyKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNwU25pcHBldFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU2V0dGluZ3NTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IERpc2FibGVGYXN0VHJhdmVsU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgV29ybGRDbGVhbmVyU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEJyb3dzZXJTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEF1dGhTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IENoYXJhY3RlclNlbGVjdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgTmV0SW5mb1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQW5pbURlYnVnU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBUaW1lcnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFBsYXllckJvd1Nob3RTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEdhbWVtb2RlVXBkYXRlU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBGcm9udEhvdFJlbG9hZFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFZvaWNlQ2hhdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgV29ybGRWaWV3KHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEtleWJvYXJkRXZlbnRzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBNYWdpY1N5bmNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFByb2ZpbGluZ1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICBdO1xyXG4gICAgICAgIFNwQXBpSW50ZXJhY3Rvci5zZXR1cChsaXN0ZW5lcnMpO1xyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAvLyBUT0RPOiBoYW5kbGUgc2V0dXAgZmFpbHVyZS4gd2lsbCBvdXRwdXQgdG8gZ2FtZSBjb25zb2xlIGJ5IGRlZmF1bHRcclxuICAgICAgICB0aHJvdyBlO1xyXG4gICAgfVxyXG59O1xyXG4vLyBbMTguMDguMjAyM11cclxuLy8gSSBzYXcgXCJhdHRlbXB0IHRvIGNhbGwgaG9va3MuYWRkIHdoaWxlIGluIGhvb2sgY29udGV4dFwiIGVycm9yXHJcbi8vIEknbSBub3Qgc3VyZSBpZiBpdCdzIGEgQysrIGJ1ZyBpbiBTa3lyaW1QbGF0Zm9ybSBvciBhbiBhcnRpZmFjdCBvZiB3ZWJwYWNrK2hvdHJlbG9hZFxyXG4vLyBCdXQgbGV0J3MgZm9yIG5vdyBlbnN1cmUgdGhhdCBcIm1haW5cIiBleGVjdXRlcyBpbnNpZGUgdGljayBjb250ZXh0XHJcbm9uY2UoXCJ0aWNrXCIsIG1haW4pO1xyXG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=