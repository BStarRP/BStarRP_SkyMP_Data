/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./node_modules/eventemitter3/index.js":
/*!*********************************************!*\
  !*** ./node_modules/eventemitter3/index.js ***!
  \*********************************************/
/***/ ((module) => {



var has = Object.prototype.hasOwnProperty
  , prefix = '~';

/**
 * Constructor to create a storage for our `EE` objects.
 * An `Events` instance is a plain object whose properties are event names.
 *
 * @constructor
 * @private
 */
function Events() {}

//
// We try to not inherit from `Object.prototype`. In some engines creating an
// instance in this way is faster than calling `Object.create(null)` directly.
// If `Object.create(null)` is not supported we prefix the event names with a
// character to make sure that the built-in object properties are not
// overridden or used as an attack vector.
//
if (Object.create) {
  Events.prototype = Object.create(null);

  //
  // This hack is needed because the `__proto__` property is still inherited in
  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.
  //
  if (!new Events().__proto__) prefix = false;
}

/**
 * Representation of a single event listener.
 *
 * @param {Function} fn The listener function.
 * @param {*} context The context to invoke the listener with.
 * @param {Boolean} [once=false] Specify if the listener is a one-time listener.
 * @constructor
 * @private
 */
function EE(fn, context, once) {
  this.fn = fn;
  this.context = context;
  this.once = once || false;
}

/**
 * Add a listener for a given event.
 *
 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} context The context to invoke the listener with.
 * @param {Boolean} once Specify if the listener is a one-time listener.
 * @returns {EventEmitter}
 * @private
 */
function addListener(emitter, event, fn, context, once) {
  if (typeof fn !== 'function') {
    throw new TypeError('The listener must be a function');
  }

  var listener = new EE(fn, context || emitter, once)
    , evt = prefix ? prefix + event : event;

  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;
  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);
  else emitter._events[evt] = [emitter._events[evt], listener];

  return emitter;
}

/**
 * Clear event by name.
 *
 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
 * @param {(String|Symbol)} evt The Event name.
 * @private
 */
function clearEvent(emitter, evt) {
  if (--emitter._eventsCount === 0) emitter._events = new Events();
  else delete emitter._events[evt];
}

/**
 * Minimal `EventEmitter` interface that is molded against the Node.js
 * `EventEmitter` interface.
 *
 * @constructor
 * @public
 */
function EventEmitter() {
  this._events = new Events();
  this._eventsCount = 0;
}

/**
 * Return an array listing the events for which the emitter has registered
 * listeners.
 *
 * @returns {Array}
 * @public
 */
EventEmitter.prototype.eventNames = function eventNames() {
  var names = []
    , events
    , name;

  if (this._eventsCount === 0) return names;

  for (name in (events = this._events)) {
    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);
  }

  if (Object.getOwnPropertySymbols) {
    return names.concat(Object.getOwnPropertySymbols(events));
  }

  return names;
};

/**
 * Return the listeners registered for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Array} The registered listeners.
 * @public
 */
EventEmitter.prototype.listeners = function listeners(event) {
  var evt = prefix ? prefix + event : event
    , handlers = this._events[evt];

  if (!handlers) return [];
  if (handlers.fn) return [handlers.fn];

  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {
    ee[i] = handlers[i].fn;
  }

  return ee;
};

/**
 * Return the number of listeners listening to a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Number} The number of listeners.
 * @public
 */
EventEmitter.prototype.listenerCount = function listenerCount(event) {
  var evt = prefix ? prefix + event : event
    , listeners = this._events[evt];

  if (!listeners) return 0;
  if (listeners.fn) return 1;
  return listeners.length;
};

/**
 * Calls each of the listeners registered for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Boolean} `true` if the event had listeners, else `false`.
 * @public
 */
EventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {
  var evt = prefix ? prefix + event : event;

  if (!this._events[evt]) return false;

  var listeners = this._events[evt]
    , len = arguments.length
    , args
    , i;

  if (listeners.fn) {
    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);

    switch (len) {
      case 1: return listeners.fn.call(listeners.context), true;
      case 2: return listeners.fn.call(listeners.context, a1), true;
      case 3: return listeners.fn.call(listeners.context, a1, a2), true;
      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;
      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;
      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;
    }

    for (i = 1, args = new Array(len -1); i < len; i++) {
      args[i - 1] = arguments[i];
    }

    listeners.fn.apply(listeners.context, args);
  } else {
    var length = listeners.length
      , j;

    for (i = 0; i < length; i++) {
      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);

      switch (len) {
        case 1: listeners[i].fn.call(listeners[i].context); break;
        case 2: listeners[i].fn.call(listeners[i].context, a1); break;
        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;
        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;
        default:
          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {
            args[j - 1] = arguments[j];
          }

          listeners[i].fn.apply(listeners[i].context, args);
      }
    }
  }

  return true;
};

/**
 * Add a listener for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} [context=this] The context to invoke the listener with.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.on = function on(event, fn, context) {
  return addListener(this, event, fn, context, false);
};

/**
 * Add a one-time listener for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} [context=this] The context to invoke the listener with.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.once = function once(event, fn, context) {
  return addListener(this, event, fn, context, true);
};

/**
 * Remove the listeners of a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn Only remove the listeners that match this function.
 * @param {*} context Only remove the listeners that have this context.
 * @param {Boolean} once Only remove one-time listeners.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {
  var evt = prefix ? prefix + event : event;

  if (!this._events[evt]) return this;
  if (!fn) {
    clearEvent(this, evt);
    return this;
  }

  var listeners = this._events[evt];

  if (listeners.fn) {
    if (
      listeners.fn === fn &&
      (!once || listeners.once) &&
      (!context || listeners.context === context)
    ) {
      clearEvent(this, evt);
    }
  } else {
    for (var i = 0, events = [], length = listeners.length; i < length; i++) {
      if (
        listeners[i].fn !== fn ||
        (once && !listeners[i].once) ||
        (context && listeners[i].context !== context)
      ) {
        events.push(listeners[i]);
      }
    }

    //
    // Reset the array, or remove it completely if we have no more listeners.
    //
    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;
    else clearEvent(this, evt);
  }

  return this;
};

/**
 * Remove all listeners, or those of the specified event.
 *
 * @param {(String|Symbol)} [event] The event name.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {
  var evt;

  if (event) {
    evt = prefix ? prefix + event : event;
    if (this._events[evt]) clearEvent(this, evt);
  } else {
    this._events = new Events();
    this._eventsCount = 0;
  }

  return this;
};

//
// Alias methods names because people roll like that.
//
EventEmitter.prototype.off = EventEmitter.prototype.removeListener;
EventEmitter.prototype.addListener = EventEmitter.prototype.on;

//
// Expose the prefix.
//
EventEmitter.prefixed = prefix;

//
// Allow `EventEmitter` to be imported as module namespace.
//
EventEmitter.EventEmitter = EventEmitter;

//
// Expose the module.
//
if (true) {
  module.exports = EventEmitter;
}


/***/ }),

/***/ "./src/extensions/formTypeEx.ts":
/*!**************************************!*\
  !*** ./src/extensions/formTypeEx.ts ***!
  \**************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormTypeEx: () => (/* binding */ FormTypeEx)
/* harmony export */ });
var FormTypeEx = /** @class */ (function () {
    function FormTypeEx() {
    }
    FormTypeEx.isItem = function (type) {
        return type === 42 /* FormType.Ammo */ ||
            type === 26 /* FormType.Armor */ ||
            type === 27 /* FormType.Book */ ||
            type === 30 /* FormType.Ingredient */ ||
            type === 31 /* FormType.Light */ ||
            type === 46 /* FormType.Potion */ ||
            type === 23 /* FormType.ScrollItem */ ||
            type === 52 /* FormType.SoulGem */ ||
            type === 41 /* FormType.Weapon */ ||
            type === 32 /* FormType.Misc */;
    };
    return FormTypeEx;
}());



/***/ }),

/***/ "./src/extensions/objectReferenceEx.ts":
/*!*********************************************!*\
  !*** ./src/extensions/objectReferenceEx.ts ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ObjectReferenceEx: () => (/* binding */ ObjectReferenceEx)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _formTypeEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./formTypeEx */ "./src/extensions/formTypeEx.ts");


var ObjectReferenceEx = /** @class */ (function () {
    function ObjectReferenceEx() {
    }
    ObjectReferenceEx.getWorldOrCell = function (self) {
        var world = self.getWorldSpace();
        if (world) {
            return world.getFormID();
        }
        var cell = self.getParentCell();
        if (cell) {
            return cell.getFormID();
        }
        return 0;
    };
    ObjectReferenceEx.getPos = function (self) {
        return [self.getPositionX(), self.getPositionY(), self.getPositionZ()];
    };
    ;
    ObjectReferenceEx.getDistance = function (a, b) {
        var deltaX = a[0] - b[0];
        var deltaY = a[1] - b[1];
        var deltaZ = a[2] - b[2];
        return Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
    };
    ;
    ObjectReferenceEx.getDistanceNoZ = function (a, b) {
        var deltaX = a[0] - b[0];
        var deltaY = a[1] - b[1];
        return Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    };
    ;
    ObjectReferenceEx.dealWithRef = function (self, base) {
        var _a, _b;
        var t = base.getType();
        var isItem = _formTypeEx__WEBPACK_IMPORTED_MODULE_1__.FormTypeEx.isItem(t);
        // BlackFallsBarrow02, door isn't opening via SetOpen so we're hacking it.
        // Not blocking activation & asking parent to activate until will be in the correct state
        // See also modelApplyUtils.ts
        var caveGSecretDoor01 = 0x6f703;
        // You can also block for t === FormType.Flora || t === FormType.Tree, but I don't think it's necessary.
        if (t === 40 /* FormType.Furniture */
            || t === 24 /* FormType.Activator */
            || t === 28 /* FormType.Container */
            || isItem
            || t === 43 /* FormType.NPC */
            || (t === 29 /* FormType.Door */ && ((_a = self.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) !== caveGSecretDoor01)) {
            self.blockActivation(true);
        }
        else {
            self.blockActivation(false);
        }
        if (self.isLocked()) {
            self.lock(false, false);
        }
        if (isItem) {
            self.setMotionType(4 /* MotionType.Keyframed */, false);
        }
        // https://github.com/skyrim-multiplayer/issue-tracker/issues/36
        if (t === 39 /* FormType.Flora */ && ((_b = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Flora.from(base)) === null || _b === void 0 ? void 0 : _b.getIngredient())) {
            self.setMotionType(4 /* MotionType.Keyframed */, false);
        }
    };
    return ObjectReferenceEx;
}());



/***/ }),

/***/ "./src/features/authModel.ts":
/*!***********************************!*\
  !*** ./src/features/authModel.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   authGameDataStorageKey: () => (/* binding */ authGameDataStorageKey)
/* harmony export */ });
;
;
;
var authGameDataStorageKey = "authGameData";


/***/ }),

/***/ "./src/lib/errors.ts":
/*!***************************!*\
  !*** ./src/lib/errors.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NeverError: () => (/* binding */ NeverError),
/* harmony export */   RespawnNeededError: () => (/* binding */ RespawnNeededError)
/* harmony export */ });
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var RespawnNeededError = /** @class */ (function (_super) {
    __extends(RespawnNeededError, _super);
    function RespawnNeededError(message) {
        var _this = _super.call(this, message) || this;
        Object.setPrototypeOf(_this, RespawnNeededError.prototype);
        return _this;
    }
    return RespawnNeededError;
}(Error));

var NeverError = /** @class */ (function (_super) {
    __extends(NeverError, _super);
    function NeverError(message) {
        var _this = _super.call(this, "NeverError: ".concat(JSON.stringify(message))) || this;
        Object.setPrototypeOf(_this, NeverError.prototype);
        return _this;
    }
    return NeverError;
}(Error));



/***/ }),

/***/ "./src/lib/idManager.ts":
/*!******************************!*\
  !*** ./src/lib/idManager.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   IdManager: () => (/* binding */ IdManager)
/* harmony export */ });
var IdManager = /** @class */ (function () {
    function IdManager() {
        this.idByValue = new Array();
        this.valueById = new Array();
        this.minimumUnusedId = 0;
    }
    IdManager.prototype.allocateIdFor = function (value) {
        if (this.idByValue.length <= value) {
            this.idByValue.length = value + 1;
        }
        this.idByValue[value] = this.minimumUnusedId;
        if (this.valueById.length <= this.minimumUnusedId) {
            this.valueById.length = this.minimumUnusedId + 1;
        }
        this.valueById[this.minimumUnusedId] = value;
        var res = this.minimumUnusedId;
        this.minimumUnusedId++;
        while (this.valueById.length > this.minimumUnusedId &&
            typeof this.valueById[this.minimumUnusedId] === "number") {
            this.minimumUnusedId++;
        }
        return res;
    };
    IdManager.prototype.freeIdFor = function (value) {
        var id = this.idByValue[value];
        if (id < this.minimumUnusedId) {
            this.minimumUnusedId = id;
        }
        this.idByValue[value] = undefined;
        this.valueById[id] = undefined;
        return;
    };
    IdManager.prototype.getId = function (value) {
        var r = this.idByValue[value];
        return typeof r === "number" ? r : -1;
    };
    IdManager.prototype.getValueById = function (id) {
        return this.valueById[id];
    };
    return IdManager;
}());



/***/ }),

/***/ "./src/lib/nameof.ts":
/*!***************************!*\
  !*** ./src/lib/nameof.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   nameof: () => (/* binding */ nameof)
/* harmony export */ });
function nameof(key) {
    return key;
}


/***/ }),

/***/ "./src/logging.ts":
/*!************************!*\
  !*** ./src/logging.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   logError: () => (/* binding */ logError),
/* harmony export */   logTrace: () => (/* binding */ logTrace)
/* harmony export */ });
/* harmony import */ var _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @skyrim-platform/skyrim-platform */ "skyrimPlatform");
/* harmony import */ var _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__);
var __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};

// TODO: redirect this to spdlog
function logError(service) {
    var rest = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        rest[_i - 1] = arguments[_i];
    }
    var restProcessed = rest.map(function (item) {
        if (item instanceof Error) {
            return item.stack || item.message;
        }
        return item;
    });
    _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__.printConsole.apply(void 0, __spreadArray(["Error in ".concat(typeof service !== "string" ? service.constructor.name : service, ":")], restProcessed, false));
}
// TODO: redirect this to spdlog
function logTrace(service) {
    var rest = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        rest[_i - 1] = arguments[_i];
    }
    var restProcessed = rest.map(function (item) {
        if (item instanceof Error) {
            return item.stack || item.message;
        }
        return item;
    });
    _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__.printConsole.apply(void 0, __spreadArray(["Trace in ".concat(typeof service !== "string" ? service.constructor.name : service, ":")], restProcessed, false));
}


/***/ }),

/***/ "./src/messages.ts":
/*!*************************!*\
  !*** ./src/messages.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   MsgType: () => (/* binding */ MsgType)
/* harmony export */ });
var MsgType;
(function (MsgType) {
    MsgType[MsgType["CustomPacket"] = 1] = "CustomPacket";
    MsgType[MsgType["UpdateMovement"] = 2] = "UpdateMovement";
    MsgType[MsgType["UpdateAnimation"] = 3] = "UpdateAnimation";
    MsgType[MsgType["UpdateAppearance"] = 4] = "UpdateAppearance";
    MsgType[MsgType["UpdateEquipment"] = 5] = "UpdateEquipment";
    MsgType[MsgType["Activate"] = 6] = "Activate";
    MsgType[MsgType["UpdateProperty"] = 7] = "UpdateProperty";
    MsgType[MsgType["PutItem"] = 8] = "PutItem";
    MsgType[MsgType["TakeItem"] = 9] = "TakeItem";
    MsgType[MsgType["FinishSpSnippet"] = 10] = "FinishSpSnippet";
    MsgType[MsgType["OnEquip"] = 11] = "OnEquip";
    MsgType[MsgType["ConsoleCommand"] = 12] = "ConsoleCommand";
    MsgType[MsgType["CraftItem"] = 13] = "CraftItem";
    MsgType[MsgType["Host"] = 14] = "Host";
    MsgType[MsgType["CustomEvent"] = 15] = "CustomEvent";
    MsgType[MsgType["ChangeValues"] = 16] = "ChangeValues";
    MsgType[MsgType["OnHit"] = 17] = "OnHit";
    MsgType[MsgType["DeathStateContainer"] = 18] = "DeathStateContainer";
    MsgType[MsgType["DropItem"] = 19] = "DropItem";
    MsgType[MsgType["Teleport"] = 20] = "Teleport";
    MsgType[MsgType["OpenContainer"] = 21] = "OpenContainer";
    MsgType[MsgType["PlayerBowShot"] = 22] = "PlayerBowShot";
    MsgType[MsgType["SpellCast"] = 23] = "SpellCast";
    MsgType[MsgType["UpdateAnimVariables"] = 24] = "UpdateAnimVariables";
    // ex-strings
    MsgType[MsgType["DestroyActor"] = 25] = "DestroyActor";
    MsgType[MsgType["HostStart"] = 26] = "HostStart";
    MsgType[MsgType["HostStop"] = 27] = "HostStop";
    MsgType[MsgType["SetInventory"] = 28] = "SetInventory";
    MsgType[MsgType["SetRaceMenuOpen"] = 29] = "SetRaceMenuOpen";
    MsgType[MsgType["SpSnippet"] = 30] = "SpSnippet";
    MsgType[MsgType["Teleport2"] = 31] = "Teleport2";
    MsgType[MsgType["UpdateGamemodeData"] = 32] = "UpdateGamemodeData";
    MsgType[MsgType["CreateActor"] = 33] = "CreateActor";
    MsgType[MsgType["VoiceChatMessage"] = 34] = "VoiceChatMessage";
    MsgType[MsgType["UpdateVoiceChatMessage"] = 35] = "UpdateVoiceChatMessage";
})(MsgType || (MsgType = {}));


/***/ }),

/***/ "./src/services/events/events.ts":
/*!***************************************!*\
  !*** ./src/services/events/events.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EventEmitterFactory: () => (/* binding */ EventEmitterFactory)
/* harmony export */ });
/* harmony import */ var eventemitter3__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! eventemitter3 */ "./node_modules/eventemitter3/index.mjs");

var EventEmitterFactory = /** @class */ (function () {
    function EventEmitterFactory() {
    }
    EventEmitterFactory.makeEventEmitter = function () {
        return (new eventemitter3__WEBPACK_IMPORTED_MODULE_0__.EventEmitter());
    };
    return EventEmitterFactory;
}());



/***/ }),

/***/ "./src/services/services/activationService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/activationService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ActivationService: () => (/* binding */ ActivationService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _lastInvService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// TODO: refactor this out



var ActivationService = /** @class */ (function (_super) {
    __extends(ActivationService, _super);
    function ActivationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("activate", function (e) { return _this.onActivate(e); });
        return _this;
    }
    ActivationService.prototype.onActivate = function (e) {
        var lastInvService = this.controller.lookupListener(_lastInvService__WEBPACK_IMPORTED_MODULE_4__.LastInvService);
        lastInvService.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_2__.getInventory)(this.sp.Game.getPlayer());
        var caster = e.caster ? e.caster.getFormID() : 0;
        var target = e.target ? e.target.getFormID() : 0;
        if (!target || !caster) {
            return;
        }
        // Actors never have non-ff ids locally in skymp
        if (caster !== 0x14 && caster < 0xff000000) {
            return;
        }
        target = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__.localIdToRemoteId)(target);
        if (!target) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logError)(this, 'localIdToRemoteId returned 0 (target) in on(\'activate\')');
            return;
        }
        caster = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__.localIdToRemoteId)(caster);
        if (!caster) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logError)(this, 'localIdToRemoteId returned 0 (caster) in on(\'activate\')');
            return;
        }
        var openState = e.target.getOpenState();
        if (openState === 2 /* OpenState.Opening */ || openState === 4 /* OpenState.Closing */) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Ignoring activation of door because it's already opening or closing");
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.Activate,
                data: { caster: caster, target: target, isSecondActivation: false }
            },
            reliability: "reliable"
        });
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Sent activation for caster=", caster.toString(16), "and target=", target.toString(16));
    };
    return ActivationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/animDebugService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/animDebugService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnimDebugService: () => (/* binding */ AnimDebugService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__);
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};



var playerId = 0x14;
var AnimDebugService = /** @class */ (function (_super) {
    __extends(AnimDebugService, _super);
    function AnimDebugService(sp, controller) {
        var _this = this;
        var _a;
        _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.settings = _this.sp.settings["skymp5-client"]["animDebug"];
        // clear previous texts in case of hotreload
        if (_this.sp.storage[AnimQueueCollection.Name] && _this.sp.storage[AnimQueueCollection.Name].clearSPText) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Destroying old AnimQueueCollection");
            try {
                _this.sp.storage[AnimQueueCollection.Name].clearSPText();
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Failed to destroy old AnimQueueCollection:", e);
            }
        }
        var self = _this;
        _this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) { },
            leave: function (ctx) {
                self.onSendAnimationEventLeave(ctx);
            }
        }, playerId, playerId);
        if (!_this.settings || !_this.settings.isActive) {
            return _this;
        }
        if ((_a = _this.settings.textOutput) === null || _a === void 0 ? void 0 : _a.isActive) {
            _this.queue = new AnimQueueCollection(_this.sp, _this.settings);
            _this.sp.storage[AnimQueueCollection.name] = _this.queue;
        }
        return _this;
    }
    AnimDebugService.prototype.onSendAnimationEventLeave = function (ctx) {
        if (this.queue === undefined) {
            return;
        }
        this.queue.push(ctx.animEventName, ctx.animationSucceeded ? animationSucceededTextColor : animationNotSucceededTextColor);
    };
    return AnimDebugService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

var animationSucceededTextColor = [255, 255, 255, 1];
var animationNotSucceededTextColor = [255, 0, 0, 1];
var AnimQueueCollection = /** @class */ (function () {
    function AnimQueueCollection(sp, settings) {
        var _a, _b, _c, _d, _e, _f;
        this.sp = sp;
        var arrayLength = (_b = (_a = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _a === void 0 ? void 0 : _a.itemCount) !== null && _b !== void 0 ? _b : 5;
        var startPos = (_d = (_c = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _c === void 0 ? void 0 : _c.startPos) !== null && _d !== void 0 ? _d : { x: 650, y: 600 };
        ;
        var yPosDelta = (_f = (_e = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _e === void 0 ? void 0 : _e.yPosDelta) !== null && _f !== void 0 ? _f : 32;
        var y = startPos.y;
        this.list = new Array(arrayLength);
        for (var idx = 0; idx < arrayLength; ++idx) {
            this.list[idx] = { name: "", textId: sp.createText(startPos.x, y, "", animationSucceededTextColor), color: animationSucceededTextColor };
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__.setTextSize)(this.list[idx].textId, 0.5);
            y += yPosDelta;
        }
    }
    AnimQueueCollection.prototype.clearSPText = function () {
        var _this = this;
        if (this.list.length === 0) {
            return;
        }
        this.list.forEach(function (item) { return _this.sp.destroyText(item.textId); });
    };
    AnimQueueCollection.prototype.push = function (animName, color) {
        var prevItem = null;
        for (var idx = this.list.length - 1; idx >= 0; --idx) {
            var item = this.list[idx];
            prevItem = __assign({}, item);
            item.name = animName;
            item.color = color;
            this.sp.setTextString(item.textId, item.name);
            this.sp.setTextColor(item.textId, item.color);
            animName = prevItem.name;
            color = prevItem.color;
        }
    };
    AnimQueueCollection.Name = "AnimQueueCollection";
    return AnimQueueCollection;
}());


/***/ }),

/***/ "./src/services/services/authService.ts":
/*!**********************************************!*\
  !*** ./src/services/services/authService.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AuthService: () => (/* binding */ AuthService)
/* harmony export */ });
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! crypto */ "crypto");
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _timersService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _characterSelectService__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./characterSelectService */ "./src/services/services/characterSelectService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();









// Define as module-level variables instead of global declarations
var window = global.window || globalThis.window || {};
// Constants used on both client and browser side (see browsersideWidgetSetter)
var events = {
    openDiscordOauth: 'openDiscordOauth',
    authAttempt: 'authAttemptEvent',
    openGithub: 'openGithub',
    openPatreon: 'openPatreon',
    clearAuthData: 'clearAuthData',
    updateRequired: 'updateRequired',
    backToLogin: 'backToLogin',
    joinDiscord: 'joinDiscord',
    hideBrowser: 'hideBrowser',
};
// Vaiables used on both client and browser side (see browsersideWidgetSetter)
var browserState = {
    comment: '',
    failCount: 9000,
    loginFailedReason: '',
};
var authData = null;
var AuthService = /** @class */ (function (_super) {
    __extends(AuthService, _super);
    function AuthService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.deniedWidgetSetter = function () {
            var widget = {
                type: "form",
                id: 2,
                caption: "Update Available",
                elements: [
                    {
                        type: "text",
                        text: "hooray! update released",
                        tags: []
                    },
                    {
                        type: "text",
                        text: "download now at",
                        tags: []
                    },
                    {
                        type: "text",
                        text: "skymp.net",
                        tags: []
                    },
                    {
                        type: "button",
                        text: "open skymp.net",
                        tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                        click: function () { return window.skyrimPlatform.sendMessage(events.updateRequired); },
                        hint: "Go to download page",
                    }
                ]
            };
            window.skyrimPlatform.widgets.set([widget]);
            // Make sure gamemode will not be able to update widgets anymore
            window.skyrimPlatform.widgets = null;
        };
        _this.loginFailedWidgetSetter = function () {
            var splitParts = browserState.loginFailedReason.split('\n');
            var textElements = splitParts.map(function (part) { return ({
                type: "text",
                text: part,
                tags: [],
            }); });
            var widget = {
                type: "form",
                id: 2,
                caption: "Error",
                elements: new Array()
            };
            textElements.forEach(function (element) { return widget.elements.push(element); });
            if (browserState.loginFailedReason === 'please join the discord server') {
                widget.elements.push({
                    type: "button",
                    text: "Join Server",
                    tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.joinDiscord); },
                    hint: null
                });
            }
            widget.elements.push({
                type: "button",
                text: "Back",
                tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                click: function () { return window.skyrimPlatform.sendMessage(events.backToLogin); },
                hint: undefined
            });
            if (window.skyrimPlatform && window.skyrimPlatform.widgets) {
                window.skyrimPlatform.widgets.set([widget]);
            }
        };
        _this.loginWidgetSetter = function () {
            // Note: isConnecting is injected via getText() wrapper
            // @ts-ignore - isConnecting is provided by FunctionInfo.getText()
            var connecting = isConnecting;
            var authDataUsername = authData ? (authData.discordUsername
                ? authData.discordUsername
                : "id: ".concat(authData.masterApiId)) : "not authorized";
            var buttonText = authData ? "Change Account" : "Login via Discord";
            var elements = [
                {
                    type: "text",
                    text: authDataUsername,
                    tags: [],
                }
            ];
            // Only show buttons if not connecting
            if (!connecting) {
                elements.push({
                    type: "button",
                    text: buttonText,
                    tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.openDiscordOauth); },
                    hint: "You can login or change account",
                });
                elements.push({
                    type: "button",
                    text: "Connect",
                    tags: ["BUTTON_STYLE_FRAME", "ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.authAttempt); },
                    hint: "Connect to game server",
                });
            }
            // Always show status text
            elements.push({
                type: "text",
                text: browserState.comment,
                tags: [],
            });
            var loginWidget = {
                type: "form",
                id: 1,
                caption: "Authentication",
                elements: elements
            };
            window.skyrimPlatform.widgets.set([loginWidget]);
        };
        _this.browsersideWidgetSetter = function () {
            var loginWidget = {
                type: "form",
                id: 1,
                caption: "Authentication",
                elements: [
                    {
                        type: "text",
                        text: (authData ? (authData.discordUsername
                            ? "".concat(authData.discordUsername)
                            : "id: ".concat(authData.masterApiId)) : "not authorized"),
                        tags: [],
                    },
                    {
                        type: "button",
                        text: authData ? "Change Account" : "Login via Discord",
                        tags: [],
                        click: function () { return window.skyrimPlatform.sendMessage(events.openDiscordOauth); },
                        hint: "You can login or change account",
                    },
                    {
                        type: "button",
                        text: "Connect",
                        tags: ["BUTTON_STYLE_FRAME", "ELEMENT_STYLE_MARGIN_EXTENDED"],
                        click: function () { return window.skyrimPlatform.sendMessage(events.authAttempt); },
                        hint: "Connect to game server",
                    },
                    {
                        type: "text",
                        text: browserState.comment,
                        tags: [],
                    },
                ]
            };
            window.skyrimPlatform.widgets.set([loginWidget]);
        };
        _this._isListenBrowserMessage = false;
        _this.trigger = {
            authNeededFired: false,
            browserWindowLoadedFired: false,
            get conditionMet() {
                return this.authNeededFired && this.browserWindowLoadedFired;
            }
        };
        _this.discordAuthState = crypto__WEBPACK_IMPORTED_MODULE_0__.randomBytes(32).toString('hex');
        _this.authDialogOpen = false;
        _this.loggingStartMoment = 0;
        _this.authAttemptProgressIndicator = false;
        _this.authAttemptProgressIndicatorCounter = 0;
        _this.lastSlowCounter = -1;
        _this.playerEverSawActualGameplay = false;
        _this.githubUrl = "https://github.com/BStarRP/skymp";
        _this.patreonUrl = "https://www.patreon.com/c/bruinstar";
        _this.discordUrl = "https://discord.gg/bstarrp";
        _this.pluginAuthDataName = "auth-data-no-load";
        _this.controller.emitter.on("authNeeded", function (e) { return _this.onAuthNeeded(e); });
        _this.controller.emitter.on("browserWindowLoaded", function (e) { return _this.onBrowserWindowLoaded(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.emitter.on("connectionAccepted", function () { return _this.handleConnectionAccepted(); });
        _this.controller.emitter.on("connectionDenied", function (e) { return _this.handleConnectionDenied(e); });
        _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage(e); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    AuthService.prototype.onAuthNeeded = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received authNeeded event");
        this.setListenBrowserMessage(true, 'authNeeded received');
        // Try to read auth data from disk first
        authData = this.readAuthDataFromDisk();
        // If no auth file exists, check for offline mode settings
        if (!authData) {
            var settingsGameData = this.sp.settings["skymp5-client"]["gameData"];
            var hasOfflineSettings = Number.isInteger(settingsGameData === null || settingsGameData === void 0 ? void 0 : settingsGameData.profileId);
            if (hasOfflineSettings) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "No auth file found, using offline mode from settings with profileId:", settingsGameData.profileId);
                this.controller.emitter.emit("authAttempt", {
                    authGameData: {
                        local: {
                            profileId: settingsGameData.profileId,
                            accessToken: settingsGameData.accessToken
                        }
                    }
                });
                return;
            }
        }
        // Auth file exists or no offline settings - show login menu
        if (authData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth file found, showing login menu with existing auth data");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "No auth file and no offline settings, showing login menu");
        }
        this.setListenBrowserMessage(true, 'regular auth needed');
        // Show browser and load the UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        // Try to load the UI explicitly
        try {
            this.sp.browser.loadUrl("file:///Data/Platform/UI/index.html");
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Attempted to load UI from file:///Data/Platform/UI/index.html");
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Failed to load UI:", e);
        }
        // Set trigger flag and wait for browser to load
        this.trigger.authNeededFired = true;
        this.onBrowserWindowLoadedAndOnlineAuthNeeded();
    };
    AuthService.prototype.onBrowserWindowLoadedShowStartWindow = function (data) {
        var _a;
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        authData = data;
        (_a = this.sp.browser) === null || _a === void 0 ? void 0 : _a.executeJavaScript("window?.useMenuStore?.getState().onStart(".concat(JSON.stringify(data), ")"));
    };
    AuthService.prototype.onBrowserWindowLoaded = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received browserWindowLoaded event");
        this.trigger.browserWindowLoadedFired = true;
        this.onBrowserWindowLoadedAndOnlineAuthNeeded();
    };
    AuthService.prototype.onCreateActorMessage = function (e) {
        if (e.message.isMe) {
            if (this.authDialogOpen) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received createActorMessage for self, resetting widgets");
                this.sp.browser.executeJavaScript('window.skyrimPlatform.widgets.set([]);');
                this.authDialogOpen = false;
            }
            else {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received createActorMessage for self, but auth dialog was not open so not resetting widgets");
            }
        }
        this.loggingStartMoment = 0;
        this.authAttemptProgressIndicator = false;
    };
    AuthService.prototype.onCustomPacketMessage = function (event) {
        var msg = event.message;
        var msgContent = {};
        try {
            msgContent = JSON.parse(msg.contentJsonDump);
        }
        catch (e) {
            if (e instanceof SyntaxError) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "onCustomPacketMessage failed to parse JSON", e.message, "json:", msg.contentJsonDump);
                return;
            }
            else {
                throw e;
            }
        }
        switch (msgContent["customPacketType"]) {
            // case 'loginRequired':
            //   logTrace(this, 'loginRequired received');
            //   this.loginWithSkympIoCredentials();
            //   break;
            case 'loginFailedNotLoggedViaDiscord':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedNotLoggedViaDiscord received');
                browserState.loginFailedReason = 'please login via discord';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedNotLoggedViaDiscord received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedNotInTheDiscordServer':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedNotInTheDiscordServer received');
                browserState.loginFailedReason = 'please join the discord server';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedNotInTheDiscordServer received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedBanned':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedBanned received');
                browserState.loginFailedReason = 'you are banned';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedBanned received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedIpMismatch':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedIpMismatch received');
                browserState.loginFailedReason = 'what was that?';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedIpMismatch received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
        }
    };
    AuthService.prototype.onBrowserWindowLoadedAndOnlineAuthNeeded = function () {
        var _this = this;
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "isListenBrowserMessage was false for some reason, aborting auth");
            return;
        }
        if (!this.trigger.conditionMet) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserWindowLoadedAndOnlineAuthNeeded waiting for both triggers to load");
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Showing widgets and starting loop");
        // Make sure auth data is loaded
        if (!authData) {
            authData = this.readAuthDataFromDisk();
        }
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        // Delay initial state injection to ensure React is mounted
        var timersService = this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService);
        timersService.setTimeout(function () {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, 'Sending initial auth state to React UI');
            _this.refreshWidgets();
        }, 500);
        // Start Discord OAuth login state checking loop
        this.checkLoginState();
    };
    AuthService.prototype.onBrowserMessage = function (e) {
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserMessage: isListenBrowserMessage was false, ignoring message", JSON.stringify(e.arguments));
            return;
        }
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserMessage:", JSON.stringify(e.arguments));
        var eventKey = e.arguments[0];
        switch (eventKey) {
            case events.openDiscordOauth:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "openDiscordOauth event received, opening browser");
                browserState.comment = 'opening browser...';
                this.refreshWidgets();
                var settingsService_1 = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
                var discordAuthBaseUrl = this.sp.settings["skymp5-client"]["discord-auth-url"] || "http://localhost:".concat(this.getServerPort());
                var discordAuthUrl = "".concat(discordAuthBaseUrl, "/api/users/login-discord?state=").concat(this.discordAuthState);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Loading Discord OAuth URL:", discordAuthUrl);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "win32 object:", this.sp.win32);
                try {
                    this.sp.win32.loadUrl(discordAuthUrl);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "win32.loadUrl called successfully");
                }
                catch (error) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Failed to call win32.loadUrl:", error);
                }
                // Launch checkLoginState loop
                this.checkLoginState();
                break;
            case events.authAttempt:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "authAttempt event received (Connect button clicked)");
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Current authData:", authData);
                if (authData === null) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "authData is null, cannot connect");
                    browserState.comment = 'please login first';
                    this.refreshWidgets();
                    break;
                }
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Emitting authAttempt event with authData:", JSON.stringify(authData));
                // Emit authAttempt event to trigger connection
                this.controller.emitter.emit("authAttempt", { authGameData: { remote: authData } });
                this.authAttemptProgressIndicator = true;
                break;
            case events.clearAuthData:
                // Doesn't seem to be used - launcher manages auth data
                break;
            case events.openGithub:
                this.sp.win32.loadUrl(this.githubUrl);
                break;
            case events.openPatreon:
                this.sp.win32.loadUrl(this.patreonUrl);
                break;
            case events.updateRequired:
                this.sp.win32.loadUrl("https://skymp.net/UpdInstall");
                break;
            case events.backToLogin:
                // Check if user manually went back from character select
                var characterSelectService = this.controller.lookupListener(_characterSelectService__WEBPACK_IMPORTED_MODULE_8__.CharacterSelectService);
                if (characterSelectService && characterSelectService.resetAuthState) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'User manually went back from character select, resetting auth state');
                    // Reset flag
                    characterSelectService.resetAuthState = false;
                    // Clear progress indicator to prevent auto-connect
                    this.authAttemptProgressIndicator = false;
                    // Clear logging start moment
                    this.loggingStartMoment = 0;
                    // Clear any error messages
                    browserState.loginFailedReason = '';
                    browserState.comment = '';
                }
                // Reload auth data from disk so user sees their previous account info
                authData = this.readAuthDataFromDisk();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Reloaded auth data after Back button pressed:', authData ? 'found' : 'not found');
                // Refresh the React UI with updated auth state
                this.refreshWidgets();
                break;
            case events.joinDiscord:
                this.sp.win32.loadUrl(this.discordUrl);
                break;
            case 'requestAuthState':
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'React UI requesting auth state, sending current state');
                this.refreshWidgets();
                break;
            default:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Unknown event key", eventKey);
                break;
        }
    };
    AuthService.prototype.createPlaySession = function (token, callback) {
        var client = new this.sp.HttpClient("http://localhost:".concat(this.getServerPort()));
        var route = "/api/users/me/play/main";
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Creating play session ".concat(route));
        client.post(route, {
            body: '{}',
            contentType: 'application/json',
            headers: {
                'authorization': "Bearer ".concat(token),
            },
            // @ts-ignore
        }, function (res) {
            if (res.status != 200) {
                callback('', 'status code ' + res.status);
            }
            else {
                // TODO: handle JSON.parse failure?
                callback(JSON.parse(res.body).session, '');
            }
        });
    };
    AuthService.prototype.checkLoginState = function () {
        var _this = this;
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "checkLoginState: isListenBrowserMessage was false, aborting check");
            return;
        }
        var timersService = this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService);
        // Social engineering protection, don't show the full state
        var halfDiscordAuthState = this.discordAuthState.slice(0, 16);
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Checking login state", halfDiscordAuthState, '...');
        new this.sp.HttpClient("http://localhost:".concat(this.getServerPort()))
            .get("/api/users/login-discord/status?state=" + this.discordAuthState, undefined, 
        // @ts-ignore
        function (response) {
            switch (response.status) {
                case 200:
                    var _a = JSON.parse(response.body), token = _a.token, masterApiId_1 = _a.masterApiId, discordUsername_1 = _a.discordUsername, discordDiscriminator_1 = _a.discordDiscriminator, discordAvatar_1 = _a.discordAvatar;
                    browserState.failCount = 0;
                    _this.createPlaySession(token, function (playSession, error) {
                        if (error) {
                            browserState.failCount = 0;
                            browserState.comment = (error);
                            timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
                            _this.refreshWidgets();
                            return;
                        }
                        authData = {
                            session: playSession,
                            masterApiId: masterApiId_1,
                            discordUsername: discordUsername_1,
                            discordDiscriminator: discordDiscriminator_1,
                            discordAvatar: discordAvatar_1,
                        };
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Discord auth successful, authData set:", JSON.stringify(authData));
                        browserState.comment = 'connected successfully';
                        _this.refreshWidgets();
                    });
                    break;
                case 401: // Unauthorized
                    browserState.failCount = 0;
                    browserState.comment = ''; //(`Still waiting...`);
                    timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
                    break;
                case 403: // Forbidden
                case 404: // Not found
                    browserState.failCount = 9000;
                    browserState.comment = ("Fail: ".concat(response.body));
                    break;
                default:
                    ++browserState.failCount;
                    browserState.comment = "Server returned ".concat(response.status.toString() || "???", " \"").concat(response.body || response.error, "\"");
                    timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
            }
        });
    };
    ;
    AuthService.prototype.refreshWidgets = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'refreshAuthUI called');
        // Inject auth state into window for React UI
        var authState = {
            authData: authData,
            comment: browserState.comment,
            loginFailedReason: browserState.loginFailedReason,
            isConnecting: this.authAttemptProgressIndicator
        };
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.auth = ".concat(JSON.stringify(authState), ";\n      window.dispatchEvent(new CustomEvent('skymp:authUpdate', { detail: ").concat(JSON.stringify(authState), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
        this.authDialogOpen = true;
    };
    ;
    AuthService.prototype.readAuthDataFromDisk = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Reading", this.pluginAuthDataName, "from disk");
        try {
            // @ts-expect-error (TODO: Remove in 2.10.0)
            var data = this.sp.getPluginSourceCode(this.pluginAuthDataName, "PluginsNoLoad");
            if (!data) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Read empty", this.pluginAuthDataName, "returning null");
                return null;
            }
            return JSON.parse(data.slice(2)) || null;
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Error reading", this.pluginAuthDataName, "from disk:", e, ", falling back to null");
            return null;
        }
    };
    AuthService.prototype.writeAuthDataToDisk = function (data) {
        // Auth data writing is handled by the launcher, client only reads
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth data writing disabled - launcher manages auth data");
    };
    ;
    AuthService.prototype.handleConnectionDenied = function (e) {
        var _this = this;
        this.authAttemptProgressIndicator = false;
        if (e.error.toLowerCase().includes("invalid password")) {
            this.controller.once("tick", function () {
                _this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
            });
            browserState.loginFailedReason = 'invalid password';
            this.refreshWidgets();
            this.sp.browser.setVisible(true);
            this.sp.browser.setFocused(true);
            this.controller.once("update", function () {
                _this.sp.Game.disablePlayerControls(true, true, true, true, true, true, true, true, 0);
            });
            this.setListenBrowserMessage(true, 'connectionDenied event received');
        }
    };
    AuthService.prototype.handleConnectionAccepted = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "handleConnectionAccepted called");
        // Keep browser message listener active so user can still interact with auth menu
        // this.setListenBrowserMessage(false, 'connectionAccepted event received');
        this.loggingStartMoment = Date.now();
        var authData = this.sp.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_1__.authGameDataStorageKey];
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth data from storage:", JSON.stringify(authData));
        if (authData === null || authData === void 0 ? void 0 : authData.local) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Logging in offline mode, profileId =", authData.local.profileId);
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_6__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: 'loginWithSkympIo',
                    gameData: {
                        profileId: authData.local.profileId,
                    },
                }),
            };
            this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable"
            });
            return;
        }
        if (authData === null || authData === void 0 ? void 0 : authData.remote) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Logging in as a master API user');
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_6__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: 'loginWithSkympIo',
                    gameData: {
                        session: authData.remote.session,
                        masterApiId: authData.remote.masterApiId,
                        discordUsername: authData.remote.discordUsername,
                        discordDiscriminator: authData.remote.discordDiscriminator,
                        discordAvatar: authData.remote.discordAvatar,
                    },
                }),
            };
            this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable"
            });
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, 'Not found authentication method');
    };
    ;
    AuthService.prototype.onTick = function () {
        // TODO: Should be no hardcoded/magic-number limit
        // TODO: Busy waiting is bad. Should be replaced with some kind of event
        var maxLoggingDelay = 15000;
        if (this.loggingStartMoment && Date.now() - this.loggingStartMoment > maxLoggingDelay) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Max logging delay reached received');
            if (this.playerEverSawActualGameplay) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Player saw actual gameplay, reconnecting');
                this.loggingStartMoment = 0;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).reconnect();
                // TODO: should we prompt user to relogin?
            }
            else {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Player never saw actual gameplay, showing login dialog');
                this.loggingStartMoment = 0;
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                browserState.comment = "";
                browserState.loginFailedReason = 'technical difficulties\nplease try again\nor contact us on discord';
                this.refreshWidgets();
                authData = null;
                // Note: Auth data cleanup handled by launcher
            }
        }
        if (this.authAttemptProgressIndicator) {
            this.authAttemptProgressIndicatorCounter++;
            if (this.authAttemptProgressIndicatorCounter === 1000000) {
                this.authAttemptProgressIndicatorCounter = 0;
            }
            var slowCounter = Math.floor(this.authAttemptProgressIndicatorCounter / 15);
            var newSlowCounter = Math.floor(slowCounter / 1); // Only changes every ~15 ticks
            // Only refresh widgets when the dot pattern changes
            if (newSlowCounter !== this.lastSlowCounter) {
                this.lastSlowCounter = newSlowCounter;
                var dot = slowCounter % 3 === 0 ? '.' : slowCounter % 3 === 1 ? '..' : '...';
                browserState.comment = "connecting" + dot;
                this.refreshWidgets();
            }
        }
    };
    AuthService.prototype.onceUpdate = function () {
        this.playerEverSawActualGameplay = true;
    };
    AuthService.prototype.isListenBrowserMessage = function () {
        return this._isListenBrowserMessage;
    };
    AuthService.prototype.setListenBrowserMessage = function (value, reason) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "setListenBrowserMessage:", value, "reason:", reason);
        this._isListenBrowserMessage = value;
    };
    AuthService.prototype.getServerPort = function () {
        // Use the same port that the UI server uses (typically 3000 for dev, port+1 for custom ports)
        // This matches the pattern in ui.ts
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
        var serverPort = settingsService.getServerPort();
        return serverPort === 7777 ? 3000 : serverPort + 1;
    };
    return AuthService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/blockPapyrusEventsService.ts":
/*!************************************************************!*\
  !*** ./src/services/services/blockPapyrusEventsService.ts ***!
  \************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BlockPapyrusEventsService: () => (/* binding */ BlockPapyrusEventsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var BlockPapyrusEventsService = /** @class */ (function (_super) {
    __extends(BlockPapyrusEventsService, _super);
    function BlockPapyrusEventsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("tick", function () { return _this.onceTick(); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    BlockPapyrusEventsService.prototype.onceTick = function () {
        // @ts-ignore
        this.sp.blockPapyrusEvents(true);
    };
    BlockPapyrusEventsService.prototype.onceUpdate = function () {
        this.sp.TESModPlatform.blockPapyrusEvents(true);
    };
    return BlockPapyrusEventsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/blockedAnimationsService.ts":
/*!***********************************************************!*\
  !*** ./src/services/services/blockedAnimationsService.ts ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BlockedAnimationsService: () => (/* binding */ BlockedAnimationsService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var BlockedAnimationsService = /** @class */ (function (_super) {
    __extends(BlockedAnimationsService, _super);
    function BlockedAnimationsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var blockedAnims = [];
        var self = _this;
        blockedAnims.forEach(function (blockedAnim) {
            _this.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(self, "blocking animation event", ctx.animEventName);
                    ctx.animEventName = "";
                },
                leave: function () { }
            }, 0x14, 0x14, blockedAnim);
        });
        return _this;
    }
    return BlockedAnimationsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/browserService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/browserService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BrowserService: () => (/* binding */ BrowserService)
/* harmony export */ });
/* harmony import */ var _view_formView__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/formView */ "./src/view/formView.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: send event instead of direct dependency on FormView class



var unfocusEventString = "window.dispatchEvent(new CustomEvent('skymp5-client:browserUnfocused', {}))";
var focusEventString = "window.dispatchEvent(new CustomEvent('skymp5-client:browserFocused', {}))";
var BrowserService = /** @class */ (function (_super) {
    __extends(BrowserService, _super);
    function BrowserService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.badMenusOpen = new Set();
        _this.badMenus = [
            "BarterMenu" /* Menu.Barter */,
            "Book Menu" /* Menu.Book */,
            "ContainerMenu" /* Menu.Container */,
            "Crafting Menu" /* Menu.Crafting */,
            "GiftMenu" /* Menu.Gift */,
            "InventoryMenu" /* Menu.Inventory */,
            "Journal Menu" /* Menu.Journal */,
            "Lockpicking Menu" /* Menu.Lockpicking */,
            "Loading Menu" /* Menu.Loading */,
            "MapMenu" /* Menu.Map */,
            "RaceSex Menu" /* Menu.RaceSex */,
            "StatsMenu" /* Menu.Stats */,
            "TweenMenu" /* Menu.Tween */,
            //Menu.Console,
            //Menu.Main,
        ];
        _this.sp.browser.setVisible(false);
        _this.controller.emitter.on("queryKeyCodeBindings", function (e) { return _this.onQueryKeyCodeBindings(e); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.on("menuOpen", function (e) { return _this.onMenuOpen(e); });
        _this.controller.on("menuClose", function (e) { return _this.onMenuClose(e); });
        return _this;
    }
    // TODO: keycodes should be configurable
    BrowserService.prototype.onQueryKeyCodeBindings = function (e) {
        if (e.isDown([59 /* DxScanCode.F1 */])) {
            _view_formView__WEBPACK_IMPORTED_MODULE_0__.FormView.isDisplayingNicknames = !_view_formView__WEBPACK_IMPORTED_MODULE_0__.FormView.isDisplayingNicknames;
        }
        if (e.isDown([60 /* DxScanCode.F2 */])) {
            this.sp.browser.setVisible(!this.sp.browser.isVisible());
        }
        if (this.badMenusOpen.size === 0 && e.isDown([64 /* DxScanCode.F6 */])) {
            var newState = !this.sp.browser.isFocused();
            this.sp.browser.setFocused(newState);
            if (newState) {
                this.sp.browser.executeJavaScript(focusEventString);
            }
            else {
                this.sp.browser.executeJavaScript(unfocusEventString);
            }
        }
        if (this.badMenusOpen.size === 0 && e.isDown([28 /* DxScanCode.Enter */])) {
            this.sp.browser.setFocused(true);
            this.sp.browser.executeJavaScript(focusEventString);
        }
        if (e.isDown([1 /* DxScanCode.Escape */])) {
            if (this.sp.browser.isFocused()) {
                this.sp.browser.setFocused(false);
                this.sp.browser.executeJavaScript(unfocusEventString);
            }
        }
    };
    BrowserService.prototype.onceUpdate = function () {
        this.sp.browser.setVisible(true);
    };
    BrowserService.prototype.onBrowserMessage = function (e) {
        var onFrontLoadedEventKey = "front-loaded";
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received browser message:", JSON.stringify(e.arguments));
        if (e.arguments[0] === onFrontLoadedEventKey) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received front-loaded message, emitting browserWindowLoaded event");
            this.controller.emitter.emit("browserWindowLoaded", {});
        }
    };
    BrowserService.prototype.onMenuOpen = function (e) {
        if (this.isBadMenu(e.name)) {
            this.sp.browser.setVisible(false);
            this.badMenusOpen.add(e.name);
        }
        else if (e.name === "HUD Menu" /* Menu.HUD */) {
            this.sp.browser.setVisible(true);
        }
    };
    BrowserService.prototype.onMenuClose = function (e) {
        if (this.badMenusOpen.delete(e.name)) {
            if (this.badMenusOpen.size === 0) {
                this.sp.browser.setVisible(true);
            }
        }
        if (e.name === "HUD Menu" /* Menu.HUD */) {
            this.sp.browser.setVisible(false);
        }
    };
    BrowserService.prototype.isBadMenu = function (menu) {
        return this.badMenus.includes(menu);
    };
    return BrowserService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/characterSelectService.ts":
/*!*********************************************************!*\
  !*** ./src/services/services/characterSelectService.ts ***!
  \*********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CharacterSelectService: () => (/* binding */ CharacterSelectService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




// Events used on both client and browser side
var events = {
    selectCharacter: 'characterSelect_select',
    createCharacter: 'characterSelect_create',
    deleteCharacter: 'characterSelect_delete',
    backToLogin: 'characterSelect_back',
};
var CharacterSelectService = /** @class */ (function (_super) {
    __extends(CharacterSelectService, _super);
    function CharacterSelectService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.characterSelectActive = false;
        _this.resetAuthState = false;
        _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage(e); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        // Listen for loginSuccess event from AuthService
        _this.controller.emitter.on("loginSuccess", function (e) { return _this.onLoginSuccess(e); });
        return _this;
    }
    CharacterSelectService.prototype.onLoginSuccess = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Received loginSuccess event, user authenticated");
        // The server will send character list automatically after login
        // No need to request it here
    };
    CharacterSelectService.prototype.onCustomPacketMessage = function (event) {
        try {
            var content = JSON.parse(event.message.contentJsonDump);
            switch (content.customPacketType) {
                case "characterList":
                    this.handleCharacterList(content);
                    break;
                case "characterError":
                    this.handleCharacterError(content.message || "Unknown error occurred");
                    break;
            }
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)(this, "Error parsing custom packet: ".concat(e));
        }
    };
    CharacterSelectService.prototype.handleCharacterList = function (data) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Received character list: ".concat(data.characters.length, " characters, ").concat(data.maxSlots, " max slots"));
        this.characterSelectActive = true;
        // Inject data into window for custom UI access (following skyrim-roleplay pattern)
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.characterSelect = ".concat(JSON.stringify(data), ";\n      window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: ").concat(JSON.stringify(data), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
        // Show browser for character selection UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
    };
    CharacterSelectService.prototype.handleCharacterError = function (message) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)(this, "Character error: ".concat(message));
        // Inject error into window for custom UI access
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.characterSelectError = ".concat(JSON.stringify(message), ";\n      window.dispatchEvent(new CustomEvent('skymp:characterError', { detail: ").concat(JSON.stringify({ message: message }), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
    };
    CharacterSelectService.prototype.onCreateActorMessage = function (e) {
        // Hide character select screen when player spawns in world
        if (this.characterSelectActive) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Player spawned, hiding character select screen");
            var clearScript = "\n        if (window.skymp) {\n          window.skymp.characterSelect = null;\n          window.skymp.characterSelectError = null;\n        }\n        window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: null }));\n      ";
            this.sp.browser.executeJavaScript(clearScript);
            this.characterSelectActive = false;
        }
    };
    CharacterSelectService.prototype.onBrowserMessage = function (e) {
        var eventKey = e.arguments[0];
        var eventData = e.arguments[1];
        switch (eventKey) {
            case events.selectCharacter:
                this.sendSelectCharacter(eventData);
                break;
            case events.createCharacter:
                this.sendCreateCharacter();
                break;
            case events.deleteCharacter:
                this.sendDeleteCharacter(eventData);
                break;
            case events.backToLogin:
                this.handleBackToLogin();
                break;
        }
    };
    CharacterSelectService.prototype.sendSelectCharacter = function (visibleId) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Selecting character visibleId=".concat(visibleId));
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'selectCharacter',
                visibleId: visibleId,
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.sendCreateCharacter = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Creating new character");
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'createCharacter',
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.sendDeleteCharacter = function (visibleId) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Deleting character visibleId=".concat(visibleId));
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'deleteCharacter',
                visibleId: visibleId,
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.handleBackToLogin = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Back to login - returning to fresh auth screen");
        // Set flag to prevent auto-reconnect in authService
        this.resetAuthState = true;
        // Clear character select data
        var clearScript = "\n      if (window.skymp) {\n        window.skymp.characterSelect = null;\n        window.skymp.characterSelectError = null;\n      }\n      window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: null }));\n    ";
        this.sp.browser.executeJavaScript(clearScript);
        this.characterSelectActive = false;
        // Close connection and ensure browser stays visible for auth screen
        this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_3__.NetworkingService).close();
        // Keep browser visible for auth UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
    };
    return CharacterSelectService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/clientListener.ts":
/*!*************************************************!*\
  !*** ./src/services/services/clientListener.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ClientListener: () => (/* binding */ ClientListener)
/* harmony export */ });
;
var ClientListener = /** @class */ (function () {
    function ClientListener() {
        // Don't let TypeScript treat this class as empty
        this._nonEmptyClassMark = '';
    }
    return ClientListener;
}());



/***/ }),

/***/ "./src/services/services/consoleCommandsService.ts":
/*!*********************************************************!*\
  !*** ./src/services/services/consoleCommandsService.ts ***!
  \*********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ConsoleCommandsService: () => (/* binding */ ConsoleCommandsService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: refactor this out


var CmdArgument;
(function (CmdArgument) {
    CmdArgument[CmdArgument["ObjectReference"] = 0] = "ObjectReference";
    CmdArgument[CmdArgument["BaseForm"] = 1] = "BaseForm";
    CmdArgument[CmdArgument["Int"] = 2] = "Int";
    CmdArgument[CmdArgument["String"] = 3] = "String";
})(CmdArgument || (CmdArgument = {}));
var ConsoleCommandsService = /** @class */ (function (_super) {
    __extends(ConsoleCommandsService, _super);
    function ConsoleCommandsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.immuneSchema = ["mp"];
        _this.nonVanilaCommands = ["mp"];
        _this.schemas = ConsoleCommandsService.createSchemas();
        _this.setupMpCommand();
        _this.setupVanilaCommands();
        return _this;
    }
    ConsoleCommandsService.createSchemas = function () {
        var schemas = new Map();
        schemas.set("additem", [CmdArgument.ObjectReference, CmdArgument.BaseForm, CmdArgument.Int]);
        schemas.set("equipitem", [CmdArgument.ObjectReference, CmdArgument.BaseForm]);
        schemas.set("placeatme", [CmdArgument.ObjectReference, CmdArgument.BaseForm]);
        schemas.set("disable", [CmdArgument.ObjectReference]);
        schemas.set("mp", [CmdArgument.ObjectReference, CmdArgument.String]);
        return schemas;
    };
    ConsoleCommandsService.prototype.setupMpCommand = function () {
        var command = this.sp.findConsoleCommand(" ConfigureUM") || this.sp.findConsoleCommand("test");
        if (command === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "command was null in setupMpCommand");
            return;
        }
        command.shortName = "mp";
        command.execute = this.getCommandExecutor("mp");
    };
    ConsoleCommandsService.prototype.setupVanilaCommands = function () {
        var _this = this;
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "Setting up vanila commands");
        this.schemas.forEach(function (_, commandName) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Setting up command", commandName);
            var command = _this.sp.findConsoleCommand(commandName);
            if (command === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "command", commandName, "was null in setupVanilaCommands");
                return;
            }
            if (_this.nonVanilaCommands.includes(commandName)) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "command", commandName, " is non-vanila command");
                return;
            }
            command.execute = _this.getCommandExecutor(commandName);
        });
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "Vanila commands set up");
    };
    ConsoleCommandsService.prototype.getCommandExecutor = function (commandName) {
        var _this = this;
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            // TODO: handle possible exceptions in this function
            var schema = _this.schemas.get(commandName);
            if (schema === undefined) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Schema not found for command", commandName);
                return false;
            }
            if (args.length !== schema.length && !_this.immuneSchema.includes(commandName)) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Mismatch found in the schema of", commandName, "command");
                return false;
            }
            for (var i = 0; i < args.length; ++i) {
                switch (schema[i]) {
                    case CmdArgument.ObjectReference:
                        args[i] = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(parseInt("".concat(args[i])));
                        break;
                }
            }
            for (var i = 0; i < args.length; ++i) {
                if (typeof args[i] !== "string" && typeof args[i] !== "number") {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Bad argument type in command", commandName, "argument index", i);
                    return false;
                }
            }
            _this.controller.emitter.emit("sendMessage", {
                message: {
                    t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.ConsoleCommand,
                    data: {
                        commandName: commandName,
                        args: args
                    }
                },
                reliability: "reliable"
            });
            // Meant to be shown to user, not for logging
            _this.sp.printConsole("sent");
            return false;
        };
    };
    return ConsoleCommandsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_3__.ClientListener));



/***/ }),

/***/ "./src/services/services/containersService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/containersService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ContainersService: () => (/* binding */ ContainersService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _lastInvService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};








var ContainersService = /** @class */ (function (_super) {
    __extends(ContainersService, _super);
    function ContainersService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    ContainersService.prototype.onContainerChanged = function (e) {
        var _this = this;
        var sweetCantDropService = this.controller.lookupListener(_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_6__.SweetTaffySweetCantDropService);
        if (e.oldContainer && e.newContainer) {
            if (e.oldContainer.getFormID() === 0x14 ||
                e.newContainer.getFormID() === 0x14) {
                var lastInvService_1 = this.controller.lookupListener(_lastInvService__WEBPACK_IMPORTED_MODULE_5__.LastInvService);
                if (!lastInvService_1.lastInv) {
                    lastInvService_1.lastInv = (0,_remoteServer__WEBPACK_IMPORTED_MODULE_3__.getPcInventory)();
                }
                if (lastInvService_1.lastInv) {
                    var newInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.getInventory)(this.sp.Game.getPlayer());
                    // It seems that 'ignoreWorn = false' fixes this:
                    // https://github.com/skyrim-multiplayer/issue-tracker/issues/43
                    // For some reason excess diff is produced when 'ignoreWorn = true'
                    // I thought that it would be vice versa but that's how it works
                    var ignoreWorn = false;
                    var diff = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.getDiff)(lastInvService_1.lastInv, newInv, ignoreWorn);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('diff:');
                    for (var i = 0; i < diff.entries.length; ++i) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("[".concat(i, "] ").concat(JSON.stringify(diff.entries[i])));
                    }
                    var msgs = diff.entries
                        .filter(function (entry) {
                        // TODO: review this condition, seems to be incorrect
                        return entry.count > 0
                            ? sweetCantDropService.canDropOrPutItem(entry.baseId)
                            : true;
                    })
                        .filter(function (entry) { return entry.count !== 0; })
                        .map(function (entry) {
                        var _a;
                        var entryCopy = JSON.parse(JSON.stringify(entry));
                        var msg = __assign(__assign({}, entryCopy), { t: entry.count > 0 ? _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PutItem : _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.TakeItem, target: e.oldContainer.getFormID() === 0x14
                                ? (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__.localIdToRemoteId)(e.newContainer.getFormID())
                                : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__.localIdToRemoteId)(e.oldContainer.getFormID()) });
                        msg.count = Math.abs(msg.count);
                        if (((_a = _this.sp.Game.getFormEx(entry.baseId)) === null || _a === void 0 ? void 0 : _a.getName()) === msg.name) {
                            delete msg.name;
                        }
                        return msg;
                    });
                    msgs.forEach(function (msg) { return _this.controller.emitter.emit("sendMessage", {
                        message: msg,
                        reliability: "reliable"
                    }); });
                    // Prevent emitting 1,2,3,4,5 changes when taking/putting 5 potions one by one
                    // This code makes it 1,1,1,1,1 but works only for extra-less items
                    // At the moment of writing this I think it's not needed for items with extras
                    diff.entries.forEach(function (entry) {
                        if (lastInvService_1.lastInv && !(0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.hasExtras)(entry)) {
                            var put = entry.count > 0;
                            var take = entry.count < 0;
                            if (put) {
                                lastInvService_1.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.removeSimpleItemsAsManyAsPossible)(lastInvService_1.lastInv, entry.baseId, entry.count);
                            }
                            else if (take) {
                                var add = { entries: [entry] };
                                add.entries[0].count *= -1;
                                lastInvService_1.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.sumInventories)(lastInvService_1.lastInv, add);
                            }
                        }
                    });
                }
            }
        }
    };
    return ContainersService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/craftService.ts":
/*!***********************************************!*\
  !*** ./src/services/services/craftService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CraftService: () => (/* binding */ CraftService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out




var CraftService = /** @class */ (function (_super) {
    __extends(CraftService, _super);
    function CraftService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.furnitureStreak = new Map();
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    CraftService.prototype.onContainerChanged = function (e) {
        var oldContainerId = e.oldContainer ? e.oldContainer.getFormID() : 0;
        var newContainerId = e.newContainer ? e.newContainer.getFormID() : 0;
        var baseObjId = e.baseObj ? e.baseObj.getFormID() : 0;
        if (oldContainerId !== 0x14 && newContainerId !== 0x14) {
            return;
        }
        var furnitureRef = this.sp.Game.getPlayer().getFurnitureReference();
        if (!furnitureRef) {
            return;
        }
        var furnitureId = furnitureRef.getFormID();
        if (oldContainerId === 0x14 && newContainerId === 0) {
            var craftInputObjects = this.furnitureStreak.get(furnitureId);
            if (!craftInputObjects) {
                craftInputObjects = { entries: [] };
            }
            craftInputObjects.entries.push({
                baseId: baseObjId,
                count: e.numItems,
            });
            this.furnitureStreak.set(furnitureId, craftInputObjects);
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Adding baseObjId", baseObjId.toString(16), "numItems", e.numItems, "to craft");
        }
        else if (oldContainerId === 0 && newContainerId === 0x14) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Finishing craft');
            var craftInputObjects = this.furnitureStreak.get(furnitureId);
            if (craftInputObjects && craftInputObjects.entries.length) {
                this.furnitureStreak.delete(furnitureId);
                var workbench = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(furnitureId);
                if (!workbench) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "localIdToRemoteId returned 0 for furnitureId", furnitureId);
                    return;
                }
                var resultObjectId = baseObjId;
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Sending craft workbench", workbench, "resultObjectId", resultObjectId, "craftInputObjects", JSON.stringify(craftInputObjects.entries));
                this.controller.emitter.emit("sendMessage", {
                    message: {
                        t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CraftItem,
                        data: { workbench: workbench, craftInputObjects: craftInputObjects, resultObjectId: resultObjectId },
                    },
                    reliability: "reliable"
                });
            }
        }
    };
    return CraftService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/deathService.ts":
/*!***********************************************!*\
  !*** ./src/services/services/deathService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DeathService: () => (/* binding */ DeathService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _ragdollService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./ragdollService */ "./src/services/services/ragdollService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var DeathService = /** @class */ (function (_super) {
    __extends(DeathService, _super);
    function DeathService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.applyDeathState = function (actor, isDead) {
            if (actor.isDead() === isDead && _this.isPlayer(actor) === false) {
                return;
            }
            if (isDead === true) {
                _this.killActor(actor, null);
            }
            else {
                _this.resurrectActor(actor);
            }
        };
        _this.killActor = function (actor, killer) {
            if (killer === void 0) { killer = null; }
            if (_this.isPlayer(actor) === true) {
                _this.playerDead = true;
                _this.busyForOtherReasonsCounter++;
                _this.sp.Utility.wait(7.5).then(function () { return _this.busyForOtherReasonsCounter--; });
                _this.allowedPlayerAnimations = [];
                actor.setDontMove(true);
                _this.killWithPush(actor);
            }
            else {
                actor.endDeferredKill();
                actor.kill(killer);
            }
        };
        _this.resurrectActor = function (actor) {
            if (_this.isPlayer(actor) === true) {
                _this.playerDead = false;
                _this.busyForOtherReasonsCounter++;
                _this.sp.Utility.wait(7.5).then(function () { return _this.busyForOtherReasonsCounter--; });
                _this.allowedPlayerAnimations = null;
                actor.setDontMove(false);
                _this.ressurectWithPushKill(actor);
            }
            else {
                throw new _lib_errors__WEBPACK_IMPORTED_MODULE_2__.RespawnNeededError("needs to be respawned");
            }
        };
        _this.killWithPush = function (actor) {
            var _a;
            (_a = _this.allowedPlayerAnimations) === null || _a === void 0 ? void 0 : _a.push(_sync_animation__WEBPACK_IMPORTED_MODULE_3__.AnimationEventName.Ragdoll);
            actor.pushActorAway(actor, 0);
        };
        _this.ressurectWithPushKill = function (act) {
            var formId = act.getFormID();
            var ragdollService = _this.controller.lookupListener(_ragdollService__WEBPACK_IMPORTED_MODULE_4__.RagdollService);
            ragdollService.safeRemoveRagdollFromWorld(act, function () {
                var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(_this.sp.Game.getFormEx(formId));
                if (!actor) {
                    return;
                }
                // TODO: should use actor variable instead of getPlayer?
                // TODO: use different iGetUpType if ressurecting under water
                _this.sp.Game.getPlayer().setAnimationVariableInt("iGetUpType", 1);
                _this.sp.Debug.sendAnimationEvent(actor, _sync_animation__WEBPACK_IMPORTED_MODULE_3__.AnimationEventName.GetUpBegin);
            });
        };
        _this.isPlayer = function (actor) {
            return actor.getFormID() === _this.playerActorId;
        };
        // Null to allow all animations. Empty array to disallow all
        _this.allowedPlayerAnimations = null;
        _this.playerActorId = 0x14;
        _this.playerDead = false;
        _this.busyForOtherReasonsCounter = 0;
        controller.once("update", function () { return _this.onceUpdate(); });
        controller.emitter.on("applyDeathStateEvent", function (e) { return _this.onApplyDeathState(e); });
        _this.hookDisableKillMoves();
        _this.hookDisableStagger();
        _this.hookDisableBlockedAnims();
        return _this;
    }
    DeathService.prototype.isBusy = function () {
        return this.playerDead || this.busyForOtherReasonsCounter > 0;
    };
    DeathService.prototype.onceUpdate = function () {
        var player = this.sp.Game.getPlayer();
        player === null || player === void 0 ? void 0 : player.startDeferredKill();
    };
    DeathService.prototype.onApplyDeathState = function (e) {
        this.applyDeathState(e.actor, e.isDead);
    };
    DeathService.prototype.hookDisableKillMoves = function () {
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                ctx.animEventName = "";
            },
            leave: function () { },
        }, 0xff000000, 0xffffffff, "KillMove*");
    };
    DeathService.prototype.hookDisableStagger = function () {
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                ctx.animEventName = "";
            },
            leave: function () { },
        }, 0xff000000, 0xffffffff, "staggerStart");
    };
    DeathService.prototype.hookDisableBlockedAnims = function () {
        var _this = this;
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                if (_this.allowedPlayerAnimations === null) {
                    return;
                }
                if (!_this.allowedPlayerAnimations.includes(ctx.animEventName)) {
                    ctx.animEventName = "";
                }
            },
            leave: function () { },
        }, this.playerActorId, this.playerActorId);
    };
    return DeathService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableDifficultySelectionService.ts":
/*!********************************************************************!*\
  !*** ./src/services/services/disableDifficultySelectionService.ts ***!
  \********************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableDifficultySelectionService: () => (/* binding */ DisableDifficultySelectionService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var DisableDifficultySelectionService = /** @class */ (function (_super) {
    __extends(DisableDifficultySelectionService, _super);
    function DisableDifficultySelectionService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.difficulty = 5;
        _this.counter = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    DisableDifficultySelectionService.prototype.onUpdate = function () {
        this.counter++;
        if (this.counter >= 60) {
            this.counter = 0;
            this.sp.Utility.setINIInt("iDifficulty:GamePlay", this.difficulty);
        }
    };
    return DisableDifficultySelectionService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableFastTravelService.ts":
/*!***********************************************************!*\
  !*** ./src/services/services/disableFastTravelService.ts ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableFastTravelService: () => (/* binding */ DisableFastTravelService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var DisableFastTravelService = /** @class */ (function (_super) {
    __extends(DisableFastTravelService, _super);
    function DisableFastTravelService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    DisableFastTravelService.prototype.onUpdate = function () {
        this.sp.Game.enableFastTravel(false);
    };
    return DisableFastTravelService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableSkillAdvanceService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/disableSkillAdvanceService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableSkillAdvanceService: () => (/* binding */ DisableSkillAdvanceService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var DisableSkillAdvanceService = /** @class */ (function (_super) {
    __extends(DisableSkillAdvanceService, _super);
    function DisableSkillAdvanceService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    DisableSkillAdvanceService.prototype.onceUpdate = function () {
        // turn off player level exp
        this.sp.Game.setGameSettingFloat("fXPPerSkillRank", 0);
        // turn off skill exp
        this.turnOffSkillLocalExp(18 /* ActorValue.Alteration */);
        this.turnOffSkillLocalExp(19 /* ActorValue.Conjuration */);
        this.turnOffSkillLocalExp(20 /* ActorValue.Destruction */);
        this.turnOffSkillLocalExp(21 /* ActorValue.Illusion */);
        this.turnOffSkillLocalExp(22 /* ActorValue.Restoration */);
        this.turnOffSkillLocalExp(23 /* ActorValue.Enchanting */);
        this.turnOffSkillLocalExp(6 /* ActorValue.OneHanded */);
        this.turnOffSkillLocalExp(7 /* ActorValue.TwoHanded */);
        this.turnOffSkillLocalExp(8 /* ActorValue.Archery */);
        this.turnOffSkillLocalExp(9 /* ActorValue.Block */);
        this.turnOffSkillLocalExp(10 /* ActorValue.Smithing */);
        this.turnOffSkillLocalExp(11 /* ActorValue.HeavyArmor */);
        this.turnOffSkillLocalExp(12 /* ActorValue.LightArmor */);
        this.turnOffSkillLocalExp(13 /* ActorValue.Pickpocket */);
        this.turnOffSkillLocalExp(14 /* ActorValue.Lockpicking */);
        this.turnOffSkillLocalExp(15 /* ActorValue.Sneak */);
        this.turnOffSkillLocalExp(16 /* ActorValue.Alchemy */);
        this.turnOffSkillLocalExp(17 /* ActorValue.Speech */);
    };
    DisableSkillAdvanceService.prototype.turnOffSkillLocalExp = function (av) {
        var avi = this.sp.ActorValueInfo.getActorValueInfoByID(av);
        if (avi === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Not found ActorValueInfo for actor value", av);
            return;
        }
        avi.setSkillUseMult(0);
        avi.setSkillOffsetMult(0);
    };
    ;
    return DisableSkillAdvanceService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/dropItemService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/dropItemService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DropItemService: () => (/* binding */ DropItemService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _worldCleanerService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var DropItemService = /** @class */ (function (_super) {
    __extends(DropItemService, _super);
    function DropItemService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    DropItemService.prototype.onContainerChanged = function (e) {
        var _this = this;
        var _a;
        var sweetCantDropService = this.controller.lookupListener(_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_2__.SweetTaffySweetCantDropService);
        var pl = this.sp.Game.getPlayer();
        var isPlayer = pl && e.oldContainer && pl.getFormID() === e.oldContainer.getFormID();
        var noContainer = e.newContainer === null || e.newContainer === undefined;
        var isReference = e.reference !== null;
        if (e.newContainer && e.newContainer.getFormID() === pl.getFormID())
            return;
        if (!this.sp.Ui.isMenuOpen("InventoryMenu"))
            return;
        if (isPlayer &&
            isReference &&
            noContainer &&
            sweetCantDropService.canDropOrPutItem(e.baseObj.getFormID())) {
            var radius = 2000;
            var baseId = e.baseObj.getFormID();
            var player = this.sp.Game.getPlayer();
            var set = new Set();
            for (var i = 0; i < 200; i++) {
                var refrId = (_a = this.sp.Game.findRandomReferenceOfType(this.sp.Game.getFormEx(baseId), player.getPositionX(), player.getPositionY(), player.getPositionZ(), radius)) === null || _a === void 0 ? void 0 : _a.getFormID();
                if (refrId) {
                    set.add(refrId);
                }
                else {
                    break;
                }
            }
            var numFound_1 = 0;
            var worldCleanerService_1 = this.controller.lookupListener(_worldCleanerService__WEBPACK_IMPORTED_MODULE_3__.WorldCleanerService);
            set.forEach(function (refrId) {
                var ref = _this.sp.ObjectReference.from(_this.sp.Game.getFormEx(refrId));
                if (ref !== null && ref.isDeleted() === false) {
                    var refrId_1 = ref.getFormID();
                    if (worldCleanerService_1.getWcProtection(refrId_1) === 0) {
                        ref.delete();
                        ++numFound_1;
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Found and deleted reference " + refrId_1.toString(16));
                    }
                    else {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Found reference " + refrId_1.toString(16) + " but it's protected");
                    }
                }
            });
            if (!numFound_1) {
                return (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Ignoring item drop as false positive");
            }
            var t = _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.DropItem;
            var count = e.numItems;
            this.controller.emitter.emit("sendMessage", {
                message: {
                    t: t,
                    baseId: baseId,
                    count: count,
                },
                reliability: "reliable"
            });
        }
    };
    return DropItemService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/enforceLimitationsService.ts":
/*!************************************************************!*\
  !*** ./src/services/services/enforceLimitationsService.ts ***!
  \************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EnforceLimitationsService: () => (/* binding */ EnforceLimitationsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var EnforceLimitationsService = /** @class */ (function (_super) {
    __extends(EnforceLimitationsService, _super);
    function EnforceLimitationsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.once("update", function () { return _this.onceUpdate(); });
        controller.emitter.on("gameLoad", function (e) { return _this.onGameLoad(e); });
        return _this;
    }
    EnforceLimitationsService.prototype.onceUpdate = function () {
        this.sp.Game.setInChargen(true, true, false);
    };
    EnforceLimitationsService.prototype.onGameLoad = function (event) {
        this.sp.Game.setInChargen(true, true, false);
    };
    return EnforceLimitationsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/frontHotReloadService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/frontHotReloadService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FrontHotReloadService: () => (/* binding */ FrontHotReloadService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var FrontHotReloadService = /** @class */ (function (_super) {
    __extends(FrontHotReloadService, _super);
    function FrontHotReloadService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var enable = !!_this.sp.settings["skymp5-client"]["enable-front-hotreload"];
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "enable-front-hotreload is", enable);
        if (!enable) {
            return _this;
        }
        // TODO: refactor out very similar code in skympClient.ts
        var authGameData = _this.sp.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_1__.authGameDataStorageKey];
        var storageHasValidAuthGameData = (authGameData === null || authGameData === void 0 ? void 0 : authGameData.local) || (authGameData === null || authGameData === void 0 ? void 0 : authGameData.remote);
        if (storageHasValidAuthGameData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Recovered AuthGameData from storage, starting FrontHotReloadService");
            _this.connectToFrontHotReload();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Unable to recover AuthGameData from storage, waiting for auth");
            _this.controller.emitter.on("authAttempt", function (e) { return _this.onAuthAttempt(e); });
        }
        return _this;
    }
    FrontHotReloadService.prototype.onAuthAttempt = function (e) {
        this.connectToFrontHotReload();
    };
    FrontHotReloadService.prototype.connectToFrontHotReload = function () {
        var _this = this;
        this.controller.once("update", function () {
            var url = "localhost:1234";
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Loading url", url);
            _this.sp.browser.loadUrl(url);
        });
    };
    return FrontHotReloadService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/gamemodeEventSourceService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/gamemodeEventSourceService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   GamemodeEventSourceService: () => (/* binding */ GamemodeEventSourceService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// The reason we use global skyrimPlatform is that this.sp may be limited, and gamemode api needs unlimited access to skyrimPlatform
// Sligthly different types



var GamemodeEventSourceService = /** @class */ (function (_super) {
    __extends(GamemodeEventSourceService, _super);
    function GamemodeEventSourceService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.setupEventSource = function (ctx) {
            _this.controller.once('update', function () {
                try {
                    ctx._fn(ctx);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "'eventSources", ctx._eventName, "- Added");
                }
                catch (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", ctx._eventName, "-", e);
                }
            });
        };
        if (Array.isArray(_this.sp.storage['eventSourceContexts'])) {
            _this.sp.storage['eventSourceContexts'] = _this.sp.storage['eventSourceContexts'].filter(function (ctx) { return !ctx._expired; });
            _this.sp.storage['eventSourceContexts'].forEach(function (ctx) {
                _this.setupEventSource(ctx);
            });
        }
        _this.controller.emitter.on("updateGamemodeDataMessage", function (e) { return _this.onUpdateGamemodeDataMessage(e); });
        return _this;
    }
    GamemodeEventSourceService.prototype.onUpdateGamemodeDataMessage = function (event) {
        var _this = this;
        if (this.sp.settings["skymp5-client"]["disable-gamemode-updates"]) {
            if (this.sp.storage['GamemodeEventSourceService_sawEventSources'] === true) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings");
                return;
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings - processing first update only");
            this.sp.storage['GamemodeEventSourceService_sawEventSources'] = true;
        }
        if (!Array.isArray(this.sp.storage['eventSourceContexts'])) {
            this.sp.storage['eventSourceContexts'] = [];
        }
        else {
            this.sp.storage['eventSourceContexts'].forEach(function (ctx) {
                ctx.sendEvent = function () { };
                ctx._expired = true;
            });
        }
        var eventSourcesRecord = {};
        event.message.eventSources.forEach(function (pair) { return eventSourcesRecord[pair.name] = pair.content; });
        var eventNames = Object.keys(eventSourcesRecord);
        var blockedEventSources = this.sp.settings["skymp5-client"]["blockedEventSources"];
        if (Array.isArray(blockedEventSources)) {
            blockedEventSources.forEach(function (blockedEventSource) {
                eventNames = eventNames.filter(function (eventName) { return eventName !== blockedEventSource; });
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "'eventSources", blockedEventSource, "- Blocked by the client");
            });
        }
        var serverJsVerificationService = this.controller.lookupListener(_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__.ServerJsVerificationService);
        eventNames.forEach(function (eventName) {
            var result = serverJsVerificationService.verifyServerJs(eventSourcesRecord[eventName]);
            if (result.src === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", eventName, 'Verification failed:', result.error);
                return;
            }
            try {
                var fn = new Function('ctx', result.src);
                var ctx = {
                    refr: undefined,
                    value: undefined,
                    _model: undefined,
                    _view: undefined,
                    i: -1,
                    get: function (_propName) {
                        throw new Error("ctx.get can't be used in event source");
                    },
                    respawn: function () {
                        throw new Error("ctx.respawn can't be used in event source");
                    },
                    sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
                    sendEvent: function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        var message = {
                            t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CustomEvent,
                            argsJsonDumps: args.map(function (arg) { return JSON.stringify(arg); }),
                            eventName: eventName
                        };
                        _this.controller.emitter.emit("sendMessage", {
                            message: message,
                            reliability: "reliable"
                        });
                    },
                    getFormIdInServerFormat: function (clientsideFormId) {
                        return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(clientsideFormId);
                    },
                    getFormIdInClientFormat: function (serversideFormId) {
                        return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.remoteIdToLocalId)(serversideFormId);
                    },
                    _fn: fn,
                    _eventName: eventName,
                    state: {},
                };
                _this.sp.storage['eventSourceContexts'].push(ctx);
                _this.setupEventSource(ctx);
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", eventName, "-", e);
            }
        });
    };
    return GamemodeEventSourceService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/gamemodeUpdateService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/gamemodeUpdateService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   GamemodeUpdateService: () => (/* binding */ GamemodeUpdateService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: refactor

// The reason we use global skyrimPlatform is that this.sp may be limited, and gamemode api needs unlimited access to skyrimPlatform
// Sligthly different types



var GamemodeUpdateService = /** @class */ (function (_super) {
    __extends(GamemodeUpdateService, _super);
    function GamemodeUpdateService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("updateGamemodeDataMessage", function (e) { return _this.onUpdateGamemodeDataMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.updateOwnerCtx = {
            sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
            refr: undefined,
            value: undefined,
            _model: undefined,
            getFormIdInServerFormat: function (clientsideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(clientsideFormId);
            },
            getFormIdInClientFormat: function (serversideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(serversideFormId);
            },
            get: function (propName) {
                return this._model[propName];
            },
            state: {},
            _view: undefined,
            i: -1,
            respawn: function () { throw new Error("ctx.respawn is not available for updateOwner"); }
        };
        _this.updateNeighborCtx = {
            refr: undefined,
            value: undefined,
            _model: undefined,
            sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
            state: undefined,
            _view: undefined,
            i: -1,
            getFormIdInServerFormat: function (clientsideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(clientsideFormId);
            },
            getFormIdInClientFormat: function (serversideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(serversideFormId);
            },
            get: function (propName) {
                return this._model[propName];
            },
            respawn: function () {
                this._view.destroyForm(this.i);
            }
        };
        _this.updateNeighborFunctionsKeys = [];
        _this.updateNeighborFunctions = {};
        return _this;
    }
    GamemodeUpdateService.prototype.setFormViewArray = function (formViewArray) {
        this.updateNeighborCtx._view = formViewArray;
    };
    GamemodeUpdateService.prototype.setI = function (i) {
        this.updateNeighborCtx.i = i;
    };
    GamemodeUpdateService.prototype.updateNeighbor = function (refr, model, state) {
        for (var _i = 0, _a = this.updateNeighborFunctionsKeys; _i < _a.length; _i++) {
            var key = _a[_i];
            var v = model[key];
            // According to docs:
            // In `updateOwner`/`updateNeighbor` equals to a value of a currently processed property.
            // Can't be `undefined` here, since updates are not received for `undefined` property values.
            // In other contexts is always `undefined`.
            if (v !== undefined) {
                this.updateNeighborCtx.refr = refr;
                this.updateNeighborCtx.value = v;
                this.updateNeighborCtx._model = model;
                this.updateNeighborCtx.state = state;
                var f = this.updateNeighborFunctions[key];
                // Actually, 'f' should always be a valid function, but who knows
                try {
                    if (f) {
                        f(this.updateNeighborCtx);
                    }
                }
                catch (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "updateNeighbor", key, '-', e);
                }
            }
        }
    };
    GamemodeUpdateService.prototype.onUpdateGamemodeDataMessage = function (event) {
        if (this.sp.settings["skymp5-client"]["disable-gamemode-updates"]) {
            if (this.sp.storage['GamemodeUpdateService_sawUpdateFunctions'] === true) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings");
                return;
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings - processing first update only");
            this.sp.storage['GamemodeUpdateService_sawUpdateFunctions'] = true;
        }
        this.sp.storage['updateNeighborFunctions'] = undefined;
        this.sp.storage['updateOwnerFunctions'] = undefined;
        this.updateGamemodeUpdateFunctions('updateNeighborFunctions', event.message.updateNeighborFunctions);
        this.updateGamemodeUpdateFunctions('updateOwnerFunctions', event.message.updateOwnerFunctions);
    };
    GamemodeUpdateService.prototype.onCreateActorMessage = function (event) {
        var _this = this;
        if (!event.message.isMe) {
            return;
        }
        // Otherwise worldModel.playerCharacterFormIdx may be unassigned
        this.controller.once("tick", function () {
            var remoteServer = _this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_1__.RemoteServer);
            var worldModel = remoteServer.getWorldModel();
            var myFormModel = worldModel.forms[worldModel.playerCharacterFormIdx];
            if (!myFormModel) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "Unable to find formModel with index", worldModel.playerCharacterFormIdx);
                return;
            }
            _this.setOwnerModel(myFormModel);
        });
    };
    GamemodeUpdateService.prototype.onTick = function () {
        var keys = this.sp.storage["updateNeighborFunctions_keys"];
        if (keys && Array.isArray(keys)) {
            this.updateNeighborFunctionsKeys = keys;
        }
        else {
            this.updateNeighborFunctionsKeys = [];
        }
        // TODO: Shouldn't we check storage value before assignment?
        this.updateNeighborFunctions = this.sp.storage["updateNeighborFunctions"];
    };
    GamemodeUpdateService.prototype.onUpdate = function () {
        var playerRef = this.sp.ObjectReference.from(this.sp.Game.getPlayer());
        var keys = this.sp.storage["updateOwnerFunctions_keys"];
        if (!keys || !Array.isArray(keys)) {
            keys = [];
        }
        var funcs = this.sp.storage["updateOwnerFunctions"];
        if (this.sp.storage["ownerModelSet"] !== true) {
            return;
        }
        var ownerModel = this.sp.storage["ownerModel"];
        for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {
            var propName = keys_1[_i];
            var f = funcs[propName];
            // Actually, must always be a valid funciton, but who knows
            if (!f) {
                continue;
            }
            this.updateOwnerCtx._model = ownerModel;
            if (!this.updateOwnerCtx._model) {
                continue;
            }
            this.updateOwnerCtx.value = this.updateOwnerCtx._model[propName];
            if (this.updateOwnerCtx.value === undefined) {
                continue;
            }
            this.updateOwnerCtx.refr = playerRef;
            this.updateOwnerCtx._model = ownerModel;
            try {
                if (f) {
                    f(this.updateOwnerCtx);
                }
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "updateOwner", propName, '-', e);
            }
        }
    };
    GamemodeUpdateService.prototype.setOwnerModel = function (ownerModel) {
        this.sp.storage["ownerModel"] = ownerModel;
        this.sp.storage["ownerModelSet"] = true;
    };
    ;
    GamemodeUpdateService.prototype.updateGamemodeUpdateFunctions = function (storageVar, functionSources) {
        var serverJsVerificationService = this.controller.lookupListener(_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__.ServerJsVerificationService);
        var functionSourcesRecord = {};
        functionSources.forEach(function (pair) { return functionSourcesRecord[pair.name] = pair.content; });
        this.sp.storage[storageVar] = functionSourcesRecord;
        for (var _i = 0, _a = Object.keys(functionSourcesRecord); _i < _a.length; _i++) {
            var propName = _a[_i];
            var result = serverJsVerificationService.verifyServerJs(this.sp.storage[storageVar][propName]);
            if (result.src === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, storageVar, propName, 'Verification failed:', result.error);
                delete this.sp.storage[storageVar][propName];
                continue;
            }
            try {
                this.sp.storage[storageVar][propName] = new Function('ctx', result.src);
                var emptyFunction = functionSourcesRecord[propName] === '';
                if (emptyFunction) {
                    delete this.sp.storage[storageVar][propName];
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, storageVar, propName, 'Added empty');
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, storageVar, propName, 'Added');
                }
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, storageVar, propName, e);
            }
        }
        this.sp.storage["".concat(storageVar, "_keys")] = Object.keys(this.sp.storage[storageVar]);
    };
    return GamemodeUpdateService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/hitService.ts":
/*!*********************************************!*\
  !*** ./src/services/services/hitService.ts ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   HitService: () => (/* binding */ HitService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out




var HitService = /** @class */ (function (_super) {
    __extends(HitService, _super);
    function HitService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.recentMagicHits = new Map();
        controller.on('hit', function (e) { return _this.onHit(e); });
        return _this;
    }
    HitService.prototype.onHit = function (e) {
        // TODO: add more logging in case of 'return'
        // TODO: allow non-weapon sources
        var aggressor = e.aggressor.getFormID();
        if (aggressor < 0xff000000 && aggressor !== 0x14)
            return; // all skymp npcs are FF+
        if (aggressor >= 0xff000000) {
            // TODO: make host service
            var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.storage['hosted'];
            var alreadyHosted = false;
            if (Array.isArray(hosted)) {
                var remoteId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(aggressor);
                if (hosted.includes(remoteId) || hosted.includes(remoteId + 0x100000000)) {
                    alreadyHosted = true;
                }
            }
            if (!alreadyHosted) {
                return;
            }
        }
        var base = e.target.getBaseObject();
        var type = base === null || base === void 0 ? void 0 : base.getType();
        if (type === 34 /* FormType.Static */ || type === 36 /* FormType.MovableStatic */) {
            return;
        }
        var isWeapon = this.sp.Weapon.from(e.source);
        var isSpell = !isWeapon && this.sp.Spell.from(e.source);
        var isScroll = !isWeapon && !isSpell && this.sp.Scroll.from(e.source);
        if (!isWeapon && !isSpell && !isScroll) {
            return;
        }
        // prevent double hit that happens for some reason with magic projectiles
        if (isSpell || isScroll) {
            var aggressorId = e.aggressor.getFormID();
            var now = Date.now();
            var lastHitTime = this.recentMagicHits.get(aggressorId);
            if (lastHitTime && now - lastHitTime < 100) {
                return;
            }
            this.recentMagicHits.set(aggressorId, now);
        }
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.OnHit, data: this.getHitData(e) },
            reliability: "reliable"
        });
    };
    HitService.prototype.getHitData = function (e) {
        var hitData = {
            aggressor: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.aggressor.getFormID()),
            isBashAttack: e.isBashAttack,
            isHitBlocked: e.isHitBlocked,
            isPowerAttack: e.isPowerAttack,
            isSneakAttack: e.isSneakAttack,
            projectile: e.projectile ? e.projectile.getFormID() : 0,
            source: e.source ? e.source.getFormID() : 0,
            target: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.target.getFormID())
        };
        return hitData;
    };
    return HitService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/keyboardEventsService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/keyboardEventsService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   KeyboardEventsService: () => (/* binding */ KeyboardEventsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var KeyboardEventsService = /** @class */ (function (_super) {
    __extends(KeyboardEventsService, _super);
    function KeyboardEventsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastNumKeys = 0;
        controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    KeyboardEventsService.prototype.onUpdate = function () {
        var _this = this;
        var numKeys = this.sp.Input.getNumKeysPressed();
        if (this.lastNumKeys !== numKeys) {
            this.lastNumKeys = numKeys;
            this.controller.emitter.emit("queryKeyCodeBindings", {
                isDown: function (binding) {
                    if (binding.every(function (key) { return _this.sp.Input.isKeyPressed(key); })) {
                        return true;
                    }
                    return false;
                }
            });
        }
    };
    return KeyboardEventsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/lastInvService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/lastInvService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LastInvService: () => (/* binding */ LastInvService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var LastInvService = /** @class */ (function (_super) {
    __extends(LastInvService, _super);
    function LastInvService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        return _this;
    }
    Object.defineProperty(LastInvService.prototype, "lastInv", {
        get: function () {
            return this._lastInv;
        },
        set: function (newValue) {
            this._lastInv = newValue;
        },
        enumerable: false,
        configurable: true
    });
    return LastInvService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/loadGameService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/loadGameService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LoadGameService: () => (/* binding */ LoadGameService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var LoadGameService = /** @class */ (function (_super) {
    __extends(LoadGameService, _super);
    function LoadGameService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this._isCausedBySkyrimPlatform = false;
        _this.controller.on("loadGame", function () { return _this.onLoadGame(); });
        return _this;
    }
    LoadGameService.prototype.loadGame = function (pos, rot, worldOrCell, changeFormNpc, loadOrder, time) {
        try {
            // @ts-ignore
            this.sp.loadGame(pos, rot, worldOrCell, changeFormNpc, loadOrder, time);
        }
        catch (e) {
            // Hotfix non-vanilla headparts bug
            // @ts-ignore
            this.sp.loadGame(pos, rot, worldOrCell, undefined, loadOrder, time);
        }
        this._isCausedBySkyrimPlatform = true;
    };
    LoadGameService.prototype.onLoadGame = function () {
        var _this = this;
        try {
            var gameLoadEvent = {
                isCausedBySkyrimPlatform: this._isCausedBySkyrimPlatform
            };
            this.controller.emitter.emit("gameLoad", gameLoadEvent);
        }
        catch (e) {
            this.controller.once("tick", function () {
                _this._isCausedBySkyrimPlatform = false;
            });
            throw e;
        }
        this.controller.once("tick", function () {
            _this._isCausedBySkyrimPlatform = false;
        });
    };
    return LoadGameService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/loadOrderVerificationService.ts":
/*!***************************************************************!*\
  !*** ./src/services/services/loadOrderVerificationService.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LoadOrderVerificationService: () => (/* binding */ LoadOrderVerificationService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _view_formView__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../view/formView */ "./src/view/formView.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var STATE_KEY = 'loadOrderCheckState';
;
var LoadOrderVerificationService = /** @class */ (function (_super) {
    __extends(LoadOrderVerificationService, _super);
    function LoadOrderVerificationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    LoadOrderVerificationService.prototype.onceUpdate = function () {
        this.verifyLoadOrder();
    };
    LoadOrderVerificationService.prototype.verifyLoadOrder = function () {
        var _this = this;
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_4__.SettingsService);
        this.resetText();
        var clientMods = this.getClientMods();
        this.printModOrder('Client load order:', clientMods);
        return settingsService.getServerMods()
            .then(function (serverMods) {
            _this.printModOrder('Server load order:', serverMods);
            if (clientMods.length < serverMods.length) {
                throw new Error("Missing some server mods. Server has ".concat(serverMods.length, ", we have ").concat(clientMods.length));
            }
            if (clientMods.length > serverMods.length) {
                _this.updateText('LOAD ORDER WARNING: you have more mods than server!\n(or could not receive server mod list)\nCheck console for details.', [255, 255, 0, 1], 5);
            }
            var fail = [];
            for (var i = 0; i < serverMods.length; ++i) {
                // Need case-insensitive check for 1.6+
                if (clientMods[i].filename.toLowerCase() !== serverMods[i].filename.toLowerCase() ||
                    clientMods[i].size !== serverMods[i].size ||
                    clientMods[i].crc32 !== serverMods[i].crc32) {
                    fail.push(i);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("".concat(i, "-th mod (numbered from 0) does not match."));
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Server has ".concat(JSON.stringify(serverMods[i])));
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("We have ".concat(JSON.stringify(clientMods[i])));
                }
            }
            if (fail.length !== 0) {
                throw new Error('Load order check failed! Indices: ' + JSON.stringify(fail));
            }
        })
            .catch(function (err) {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(err);
            if (_this.sp.settings['skymp5-client']['ignoreLoadOrderMismatch']) {
                _this.updateText('LOAD ORDER ERROR!\nHowever, ignoring it because of ignoreLoadOrderMismatch being set.' +
                    '\nExpect EVERYTHING BREAK, unless you know what you are doing.\nCheck console for details.' +
                    '\nThis message will disappear after 30 seconds.', [255, 0, 0, 1], 30);
                return;
            }
            _this.updateText('LOAD ORDER ERROR!\nCheck console for details.', [255, 0, 0, 1]);
        });
    };
    ;
    LoadOrderVerificationService.prototype.getState = function () {
        if (typeof this.sp.storage[STATE_KEY] !== 'object') {
            return {};
        }
        return this.sp.storage[STATE_KEY];
    };
    ;
    LoadOrderVerificationService.prototype.setState = function (replacement) {
        var oldState = this.sp.storage[STATE_KEY] = this.getState();
        for (var _i = 0, _a = Object.entries(replacement); _i < _a.length; _i++) {
            var _b = _a[_i], k = _b[0], v = _b[1];
            oldState[k] = v;
        }
    };
    ;
    LoadOrderVerificationService.prototype.resetText = function () {
        var statusTextId = this.getState().statusTextId;
        if (statusTextId) {
            this.sp.destroyText(statusTextId);
            statusTextId = undefined;
            this.setState({ statusTextId: statusTextId });
        }
    };
    ;
    LoadOrderVerificationService.prototype.updateText = function (text, color, clearDelay) {
        var _this = this;
        var _a = (0,_view_formView__WEBPACK_IMPORTED_MODULE_1__.getScreenResolution)(), width = _a.width, height = _a.height;
        this.resetText();
        var statusTextId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(width / 2, height / 2, text, color);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(statusTextId, 0.5);
        this.setState({ statusTextId: statusTextId });
        if (clearDelay) {
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(clearDelay).then(function () { return _this.resetText(); });
        }
    };
    LoadOrderVerificationService.prototype.enumerateClientMods = function (getCount, getAt) {
        var result = [];
        for (var i = 0; i < getCount(); ++i) {
            var filename = getAt(i);
            var _a = this.getFileInfoSafe(filename), crc32 = _a.crc32, size = _a.size;
            result.push({ filename: filename, crc32: crc32, size: size });
        }
        return result;
    };
    LoadOrderVerificationService.prototype.getClientMods = function () {
        return this.enumerateClientMods(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getModCount, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getModName);
    };
    ;
    LoadOrderVerificationService.prototype.printModOrder = function (header, order) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(header);
        for (var _i = 0, _a = Object.entries(order); _i < _a.length; _i++) {
            var _b = _a[_i], i = _b[0], mod = _b[1];
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("#".concat(i, " ").concat(JSON.stringify(mod)));
        }
    };
    ;
    LoadOrderVerificationService.prototype.getFileInfoSafe = function (filename) {
        try {
            return this.sp.getFileInfo(filename);
        }
        catch (e) {
            var message = e.message;
            if (typeof message === "string" && message.includes('is not a valid argument')) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Failed to get file info for", filename);
                return { crc32: 0, size: 0 };
            }
            else {
                throw e;
            }
        }
    };
    return LoadOrderVerificationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/magicSyncService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/magicSyncService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   MagicSyncService: () => (/* binding */ MagicSyncService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out

// @ts-expect-error (TODO: Remove in 2.10.0)



var MagicSyncService = /** @class */ (function (_super) {
    __extends(MagicSyncService, _super);
    function MagicSyncService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.playerId = 0x14;
        _this.sendUpdateAnimationVariablesRateMs = 500;
        _this.lastSpellCastEventMsg = null;
        _this.lastSendUpdateAnimationVariables = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.on("spellCast", function (e) { return _this.onSpellCast(e); });
        var self = _this;
        _this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) { },
            leave: function (ctx) {
                self.onSendAnimationEventLeave(ctx);
            }
        }, _this.playerId, _this.playerId);
        return _this;
    }
    MagicSyncService.prototype.onUpdate = function () {
        var _this = this;
        if (this.isAnyMagicStuffEquiped() === false) {
            return;
        }
        if (Date.now() - this.lastSendUpdateAnimationVariables <= this.sendUpdateAnimationVariablesRateMs) {
            return;
        }
        this.lastSendUpdateAnimationVariables = Date.now();
        this.controller.once('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.Game.getPlayer();
            if (!ac) {
                return;
            }
            var animVariables = _this.getAnimationVariablesFromActorConverted(ac.getFormID());
            _this.controller.emitter.emit("sendMessage", {
                message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.UpdateAnimVariables, data: _this.getUpdateAnimVariablesEventData(ac, animVariables) },
                reliability: "reliable"
            });
        });
    };
    MagicSyncService.prototype.onSpellCast = function (event) {
        var isInterruptCast = false;
        var msg = this.getSpellCastEventData(event, isInterruptCast);
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.SpellCast, data: msg },
            reliability: "reliable"
        });
        this.lastSpellCastEventMsg = msg;
    };
    MagicSyncService.prototype.onSendAnimationEventLeave = function (ctx) {
        var _this = this;
        if (!this.lastSpellCastEventMsg || !this.isInteraptSpellCastAnim(ctx.animEventName)) {
            return;
        }
        this.controller.once('update', function () {
            if (!_this.lastSpellCastEventMsg || _this.lastSpellCastEventMsg.interruptCast) {
                return;
            }
            var msg = _this.lastSpellCastEventMsg;
            msg.interruptCast = true;
            msg.actorAnimationVariables = _this.getAnimationVariablesFromActorConverted((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.remoteIdToLocalId)(_this.lastSpellCastEventMsg.caster));
            _this.controller.emitter.emit("sendMessage", {
                message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.SpellCast, data: msg },
                reliability: "reliable"
            });
        });
    };
    MagicSyncService.prototype.getSpellCastEventData = function (e, isInterruptCast) {
        var spellCastData = {
            caster: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.caster.getFormID(), true),
            // @ts-expect-error (TODO: Remove in 2.10.0)
            target: e.target ? (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.target.getFormID(), true) : 0,
            spell: e.spell ? e.spell.getFormID() : 0,
            interruptCast: isInterruptCast,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            isDualCasting: e.isDualCasting,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            castingSource: e.castingSource,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            aimAngle: e.aimAngle,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            aimHeading: e.aimHeading,
            actorAnimationVariables: this.getAnimationVariablesFromActorConverted(e.caster.getFormID()),
        };
        return spellCastData;
    };
    MagicSyncService.prototype.getAnimationVariablesFromActorConverted = function (actorId) {
        var animVars = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.getAnimationVariablesFromActor)(actorId);
        var booleans = animVars.booleans;
        var floats = animVars.floats;
        var integers = animVars.integers;
        return {
            booleans: Array.from(new Uint8Array(booleans)),
            floats: Array.from(new Uint8Array(floats)),
            integers: Array.from(new Uint8Array(integers)),
        };
    };
    MagicSyncService.prototype.getUpdateAnimVariablesEventData = function (ac, animVariables) {
        var animVarsData = {
            actorRemoteId: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(ac.getFormID(), true),
            actorAnimationVariables: animVariables,
        };
        return animVarsData;
    };
    MagicSyncService.prototype.isInteraptSpellCastAnim = function (animEventName) {
        var eventName = animEventName.toLowerCase();
        return eventName === "mlh_equipped_event" || eventName === "mrh_equipped_event";
    };
    ;
    MagicSyncService.prototype.isSpellCastAnim = function (animEventName) {
        var eventName = animEventName.toLowerCase();
        var isSpellCastAnimForLeftHand = eventName === "mlh_spellaimedconcentrationstart" || eventName === "mlh_spellaimedstart" || eventName === "mlh_spellready_event" ||
            eventName === "mlh_spellrelease_event" || eventName === "mlh_equipped_event";
        var isSpellCastAnimForRightHand = eventName === "mrh_spellaimedconcentrationstart" || eventName === "mrh_spellaimedstart" || eventName === "mrh_spellready_event" ||
            eventName === "mrh_spellrelease_event" || eventName === "mrh_equipped_event";
        return isSpellCastAnimForLeftHand || isSpellCastAnimForRightHand;
    };
    ;
    MagicSyncService.prototype.isAnyMagicStuffEquiped = function () {
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.Game.getPlayer();
        if (!ac) {
            return false;
        }
        if (ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Left) || ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Right)) {
            return true;
        }
        if (ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Voise) || ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Instant)) {
            return true;
        }
        var leftHandEquipmentType = ac.getEquippedItemType(1 /* SlotType.Left */);
        var rightHandEquipmentType = ac.getEquippedItemType(2 /* SlotType.Right */);
        // TODO: Spell => SpellOrScroll, since Spell is now a deprecated name (TODO: Remove in 2.10.0)
        if (leftHandEquipmentType === 9 /* EquippedItemType.Spell */ || leftHandEquipmentType === 8 /* EquippedItemType.Staff */ ||
            rightHandEquipmentType === 9 /* EquippedItemType.Spell */ || rightHandEquipmentType === 8 /* EquippedItemType.Staff */) {
            return true;
        }
        return false;
    };
    return MagicSyncService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/netInfoService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/netInfoService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NetInfoService: () => (/* binding */ NetInfoService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var NetInfoService = /** @class */ (function (_super) {
    __extends(NetInfoService, _super);
    function NetInfoService(sp, controller) {
        var _this = this;
        var _a;
        _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.receivedPacketCount = 0;
        _this.sentPacketCount = 0;
        _this.localLagUnits = 0;
        _this.delayMs = 1000;
        _this.lastDt = 0;
        _this.dt = 0;
        _this.greenARGB = [0, 128, 0, 1];
        _this.redARGB = [255, 0, 0, 1];
        // clear previous texts in case of hotreload
        if (_this.sp.storage[NetInfoTexts.Name] && _this.sp.storage[NetInfoTexts.Name].clear) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Destroying old NetInfoTexts");
            try {
                (_a = _this.sp.storage[NetInfoTexts.Name]) === null || _a === void 0 ? void 0 : _a.clear();
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(_this, "Failed to destroy old NetInfoTexts:", e);
            }
        }
        if (!_this.isEnabled()) {
            return _this;
        }
        _this.textIds = new NetInfoTexts(_this.sp);
        _this.sp.storage[NetInfoTexts.Name] = _this.textIds;
        _this.lastDt = Date.now();
        _this.controller.emitter.on("sendMessage", function (e) { return _this.onSendMessage(e); });
        _this.controller.emitter.on("sendMessageWithRefrId", function (e) { return _this.onSendMessageWithRefrId(e); });
        _this.controller.emitter.on("anyMessage", function (e) { return _this.onAnyMessage(e); });
        _this.controller.emitter.on("newLocalLagValueCalculated", function (e) { return _this.onNewLocalLagValueCalculated(e); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    NetInfoService.prototype.onSendMessage = function (e) {
        this.addSentPacketCount(1);
    };
    NetInfoService.prototype.onSendMessageWithRefrId = function (e) {
        this.addSentPacketCount(1);
    };
    NetInfoService.prototype.onAnyMessage = function (e) {
        this.addReceivedPacketCount(1);
    };
    NetInfoService.prototype.onNewLocalLagValueCalculated = function (e) {
        this.setLocalLagUnits(e.lagUnitsNoZ);
    };
    NetInfoService.prototype.onUpdate = function () {
        if (this.textIds === undefined) {
            return;
        }
        this.dt += Date.now() - this.lastDt;
        this.lastDt = Date.now();
        var isConnected = this.sp.mpClientPlugin.isConnected();
        this.sp.setTextString(this.textIds.connectionStateTextId, "".concat(isConnected ? "ON" : "OFF"));
        this.sp.setTextColor(this.textIds.connectionStateTextId, isConnected ? this.greenARGB : this.redARGB);
        // https://www.creationkit.com/index.php?title=Unit
        var units = this.getLocalLagUnits();
        var unitsInMeter = 70.0218818381;
        var meters = Math.round(units / unitsInMeter * 10) / 10;
        this.sp.setTextString(this.textIds.localPositionLagAmountTextId, "".concat(units, " units (~").concat(meters, " m)"));
        if (this.delayMs > this.dt) {
            return;
        }
        this.sp.setTextString(this.textIds.receivedPacketAmountTextId, "".concat(Math.round(this.getAndClearReceivedPacketCount())));
        this.sp.setTextString(this.textIds.sentPacketAmountTextId, "".concat(Math.round(this.getAndClearSentPacketCount())));
        this.dt = 0;
    };
    NetInfoService.prototype.addReceivedPacketCount = function (count) {
        this.receivedPacketCount += count;
    };
    NetInfoService.prototype.getAndClearReceivedPacketCount = function () {
        var value = this.receivedPacketCount;
        this.receivedPacketCount = 0;
        return value;
    };
    NetInfoService.prototype.addSentPacketCount = function (count) {
        this.sentPacketCount += count;
    };
    NetInfoService.prototype.getAndClearSentPacketCount = function () {
        var value = this.sentPacketCount;
        this.sentPacketCount = 0;
        return value;
    };
    NetInfoService.prototype.setLocalLagUnits = function (distance) {
        this.localLagUnits = distance;
    };
    NetInfoService.prototype.getLocalLagUnits = function () {
        return this.localLagUnits;
    };
    NetInfoService.prototype.isEnabled = function () {
        return !!this.sp.settings["skymp5-client"]["show-net-info"];
    };
    return NetInfoService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));

var NetInfoTexts = /** @class */ (function () {
    function NetInfoTexts(sp, connectionStaticTextId, connectionStateTextId, receivedPacketStaticTextId, receivedPacketAmountTextId, sentPacketStaticTextId, sentPacketAmountTextId, localPositionLagStaticTextId, localPositionLagAmountTextId) {
        if (connectionStaticTextId === void 0) { connectionStaticTextId = sp.createText(100, 350, "connection:", [255, 255, 255, 1]); }
        if (connectionStateTextId === void 0) { connectionStateTextId = sp.createText(220, 350, "", [255, 255, 255, 1]); }
        if (receivedPacketStaticTextId === void 0) { receivedPacketStaticTextId = sp.createText(120, 390, "incoming (p/s):", [255, 255, 255, 1]); }
        if (receivedPacketAmountTextId === void 0) { receivedPacketAmountTextId = sp.createText(250, 390, "", [255, 255, 255, 1]); }
        if (sentPacketStaticTextId === void 0) { sentPacketStaticTextId = sp.createText(120, 430, "outgoing (p/s):", [255, 255, 255, 1]); }
        if (sentPacketAmountTextId === void 0) { sentPacketAmountTextId = sp.createText(250, 430, "", [255, 255, 255, 1]); }
        if (localPositionLagStaticTextId === void 0) { localPositionLagStaticTextId = sp.createText(90, 470, "local lag:", [255, 255, 255, 1]); }
        if (localPositionLagAmountTextId === void 0) { localPositionLagAmountTextId = sp.createText(250, 470, "", [255, 255, 255, 1]); }
        this.sp = sp;
        this.connectionStaticTextId = connectionStaticTextId;
        this.connectionStateTextId = connectionStateTextId;
        this.receivedPacketStaticTextId = receivedPacketStaticTextId;
        this.receivedPacketAmountTextId = receivedPacketAmountTextId;
        this.sentPacketStaticTextId = sentPacketStaticTextId;
        this.sentPacketAmountTextId = sentPacketAmountTextId;
        this.localPositionLagStaticTextId = localPositionLagStaticTextId;
        this.localPositionLagAmountTextId = localPositionLagAmountTextId;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.connectionStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.connectionStateTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.receivedPacketStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.receivedPacketAmountTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.sentPacketStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.sentPacketAmountTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.localPositionLagStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.localPositionLagAmountTextId, 0.5);
    }
    NetInfoTexts.prototype.clear = function () {
        this.sp.destroyText(this.connectionStaticTextId);
        this.sp.destroyText(this.connectionStateTextId);
        this.sp.destroyText(this.receivedPacketStaticTextId);
        this.sp.destroyText(this.receivedPacketAmountTextId);
        this.sp.destroyText(this.sentPacketStaticTextId);
        this.sp.destroyText(this.sentPacketAmountTextId);
        this.sp.destroyText(this.localPositionLagStaticTextId);
        this.sp.destroyText(this.localPositionLagAmountTextId);
    };
    NetInfoTexts.Name = "netInfoTexts";
    return NetInfoTexts;
}());


/***/ }),

/***/ "./src/services/services/networkingService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/networkingService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NetworkingService: () => (/* binding */ NetworkingService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var NetworkingService = /** @class */ (function (_super) {
    __extends(NetworkingService, _super);
    function NetworkingService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.emitter.on("sendMessage", function (e) { return _this.onSendMessage(e); });
        _this.controller.emitter.on("sendRawMessage", function (e) { return _this.onSendRawMessage(e); });
        _this.controller.emitter.on("sendMessageWithRefrId", function (e) { return _this.onSendMessageWithRefrId(e); });
        return _this;
    }
    NetworkingService.prototype.onSendMessage = function (e) {
        this.sp.mpClientPlugin.send(JSON.stringify(e.message), this.isReliable(e.reliability));
    };
    NetworkingService.prototype.onSendRawMessage = function (e) {
        // @ts-expect-error
        this.sp.mpClientPlugin.sendRaw(e.rawMessage, e.rawMessage.byteLength, this.isReliable(e.reliability));
    };
    NetworkingService.prototype.onSendMessageWithRefrId = function (e) {
        var refrId = e.message._refrId;
        var remoteServer = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_4__.RemoteServer);
        var idxInModel = refrId
            ? remoteServer.getWorldModel().forms.findIndex(function (f) { return f && f.refrId === refrId; })
            : remoteServer.getWorldModel().playerCharacterFormIdx;
        // fixes "can't get property idx of null or undefined"
        if (!remoteServer.getWorldModel().forms[idxInModel]) {
            return;
        }
        // @ts-ignore
        e.message.idx = remoteServer.getWorldModel().forms[idxInModel].idx;
        delete e.message._refrId;
        this.sp.mpClientPlugin.send(JSON.stringify(e.message), this.isReliable(e.reliability));
    };
    NetworkingService.prototype.connect = function (hostName, port) {
        this.serverAddress = { hostName: hostName, port: port };
        this.createClientSafe();
    };
    NetworkingService.prototype.reconnect = function () {
        this.createClientSafe();
    };
    NetworkingService.prototype.close = function () {
        this.sp.mpClientPlugin.destroyClient();
    };
    NetworkingService.prototype.isConnected = function () {
        return this.sp.mpClientPlugin.isConnected();
    };
    NetworkingService.prototype.onTick = function () {
        var _this = this;
        this.sp.mpClientPlugin.tick(function (packetType, rawContent, error) {
            switch (packetType) {
                case "connectionAccepted":
                    _this.controller.emitter.emit("connectionAccepted", {});
                    break;
                case "connectionDenied":
                    _this.controller.emitter.emit("connectionDenied", { error: error });
                    _this.reconnect();
                    break;
                case "connectionFailed":
                    _this.controller.emitter.emit("connectionFailed", {});
                    _this.reconnect();
                    break;
                case "disconnect":
                    _this.controller.emitter.emit("connectionDisconnect", {});
                    _this.reconnect();
                    break;
                case "message":
                    // TODO: in theory can be empty jsonContent and non-empty error
                    var msgAny = void 0;
                    if (rawContent === null) {
                        msgAny = {};
                        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "null rawContent");
                    }
                    else if ((new Uint8Array(rawContent)[0]) === 0x7b) {
                        // assume json
                        msgAny = JSON.parse(_this.sp.decodeUtf8(rawContent));
                    }
                    else {
                        // assume raw
                        var event = { rawContent: rawContent };
                        return _this.controller.emitter.emit("anyRawMessage", event);
                    }
                    if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.OpenContainer) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("openContainerMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateMovement) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateMovementMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimation) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAnimationMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateEquipment) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateEquipmentMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.ChangeValues) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("changeValuesMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SpellCast) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("spellCastMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimVariables) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAnimVariablesMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAppearance) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAppearanceMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Teleport) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("teleportMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateProperty) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updatePropertyMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.DeathStateContainer) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("deathStateContainerMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CreateActor) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("createActorMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CustomPacket) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("customPacketMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.DestroyActor) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("destroyActorMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.HostStart) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("hostStartMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.HostStop) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("hostStopMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SetInventory) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("setInventoryMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SetRaceMenuOpen) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("setRaceMenuOpenMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SpSnippet) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("spSnippetMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateGamemodeData) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateGamemodeDataMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Teleport2) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("teleportMessage2", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else {
                        // throw new NeverError(msgAny);
                        throw new Error("Unhandled MsgType " + msgAny.t);
                    }
                    break;
            }
        });
    };
    NetworkingService.prototype.createClientSafe = function () {
        var _a = this.serverAddress, hostName = _a.hostName, port = _a.port;
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "createClientSafe " + hostName + ":" + port);
        if (this.serverAddress.hostName !== "" && this.serverAddress.port !== 0) {
            this.sp.mpClientPlugin.createClient(hostName, port);
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "createClientSafe failed");
        }
    };
    Object.defineProperty(NetworkingService.prototype, "serverAddress", {
        get: function () {
            var res = this.sp.storage["serverAddress"];
            if (typeof res === "object") {
                var result = res;
                if (typeof result.hostName === "string" && typeof result.port === "number") {
                    return result;
                }
            }
            return { hostName: "", port: 0 };
        },
        set: function (newValue) {
            this.sp.storage["serverAddress"] = newValue;
        },
        enumerable: false,
        configurable: true
    });
    NetworkingService.prototype.isReliable = function (reliability) {
        switch (reliability) {
            case "reliable":
                return true;
            case "unreliable":
                return false;
            default:
                throw new _lib_errors__WEBPACK_IMPORTED_MODULE_1__.NeverError(reliability);
        }
    };
    return NetworkingService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_3__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/playerBowShotService.ts":
/*!*******************************************************!*\
  !*** ./src/services/services/playerBowShotService.ts ***!
  \*******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PlayerBowShotService: () => (/* binding */ PlayerBowShotService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var PlayerBowShotService = /** @class */ (function (_super) {
    __extends(PlayerBowShotService, _super);
    function PlayerBowShotService(sp, controller) {
        var _this_1 = _super.call(this) || this;
        _this_1.sp = sp;
        _this_1.controller = controller;
        _this_1.score = 0;
        _this_1.inventoryUnblockMoment = 0;
        _this_1.controller.emitter.on("queryBlockSetInventoryEvent", function (e) { return _this_1.onQueryBlockSetInventoryEvent(e); });
        _this_1.controller.on("playerBowShot", function (e) { return _this_1.onPlayerBowShot(e); });
        var _this = _this_1;
        var eventPatterns = ["attackRelease", "crossbowAttackStart"];
        eventPatterns.forEach(function (eventPattern) {
            _this_1.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) {
                },
                leave: function (ctx) {
                    if (!ctx.animationSucceeded) {
                        return;
                    }
                    if (ctx.animEventName === "crossbowAttackStart") {
                        _this.score = 1;
                    }
                    else if (ctx.animEventName === "attackRelease") {
                        if (_this.score === 1) {
                            _this.controller.once("update", function () { _this.onPlayerCrossbowShot(); });
                            _this.score = 0;
                        }
                    }
                    else {
                        _this.score = 0;
                    }
                }
            }, 0x14, 0x14, eventPattern);
        });
        return _this_1;
    }
    PlayerBowShotService.prototype.onQueryBlockSetInventoryEvent = function (e) {
        if (Date.now() < this.inventoryUnblockMoment) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Blocked inventory operation");
            e.block();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Not blocked inventory operation");
        }
    };
    PlayerBowShotService.prototype.onPlayerBowShot = function (e) {
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PlayerBowShot,
                weaponId: e.weapon.getFormID(),
                ammoId: e.ammo.getFormID(),
                power: e.power,
                isSunGazing: e.isSunGazing || false
            },
            reliability: "unreliable"
        });
    };
    PlayerBowShotService.prototype.onPlayerCrossbowShot = function () {
        var actor = this.sp.Game.getPlayer();
        if (actor === null) {
            return;
        }
        var crossbow = actor.getEquippedWeapon(false);
        if (crossbow === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Couldn't get equipped weapon");
            return;
        }
        var weaponType = crossbow.getWeaponType();
        if (weaponType !== 9 /* WeaponType.Crossbow */) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Expected weapon to be crossbow, but got WeaponType", weaponType);
            return;
        }
        var equippedAmmoEntries = (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.getEquipment)(actor, 0).inv.entries.filter(function (entry) { return entry.worn && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(entry.baseId)); });
        if (equippedAmmoEntries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Ammo not found");
            return;
        }
        if (equippedAmmoEntries.length > 1) {
            var equippedAmmoIds = equippedAmmoEntries.map(function (entry) { return entry.baseId; });
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Found more than 1 ammos:", equippedAmmoIds);
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PlayerBowShot,
                weaponId: crossbow.getFormID(),
                ammoId: equippedAmmoEntries[0].baseId,
                isSunGazing: false,
                power: 1.0
            },
            reliability: "unreliable"
        });
        // Fixes race condition when the server removes an item faster than local crossbow does that: -1 total
        // Then crossbow removes one more item: -2 total
        // The item is being added back: -1 total (which is correct but looks ugly in process)
        this.inventoryUnblockMoment = Date.now() + 5 * 1000;
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Sent crossbow shot");
    };
    return PlayerBowShotService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/profilingService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/profilingService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ProfilingService: () => (/* binding */ ProfilingService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var inspector__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! inspector */ "inspector");
/* harmony import */ var inspector__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(inspector__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! fs */ "fs");
/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_3__);
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};




var ProfilingService = /** @class */ (function (_super) {
    __extends(ProfilingService, _super);
    function ProfilingService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var settings = sp.settings["skymp5-client"];
        if (!settings["enableProfiling"]) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "ProfilingService: disabled");
            return _this;
        }
        var profilingDurationMs = _this.getInteger(settings["profilingDurationMs"]) || 10000;
        var session = new inspector__WEBPACK_IMPORTED_MODULE_2__.Session();
        session.connect();
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "ProfilingService: start");
        _this.startProfiling(session, profilingDurationMs);
        return _this;
    }
    ProfilingService.prototype.startProfiling = function (session, profilingDurationMs) {
        return __awaiter(this, void 0, void 0, function () {
            var profile, fileNameSuffix;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, new Promise(function (resolve, reject) {
                            session.post('Profiler.enable', function (err) {
                                if (err) {
                                    reject(err);
                                }
                                else {
                                    resolve(undefined);
                                }
                            });
                        })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, new Promise(function (resolve, reject) {
                                session.post('Profiler.start', function (err) {
                                    if (err) {
                                        reject(err);
                                    }
                                    else {
                                        resolve(undefined);
                                    }
                                });
                            })];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, new Promise(function (resolve) {
                                setTimeout(resolve, profilingDurationMs);
                            })];
                    case 3:
                        _a.sent();
                        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "ProfilingService: stop");
                        return [4 /*yield*/, new Promise(function (resolve, reject) {
                                session.post('Profiler.stop', function (err, res) {
                                    if (err) {
                                        reject(err);
                                    }
                                    else {
                                        resolve(res);
                                    }
                                });
                            })];
                    case 4:
                        profile = (_a.sent()).profile;
                        fileNameSuffix = Math.random().toString().replace(".0", "");
                        fs__WEBPACK_IMPORTED_MODULE_3__.writeFileSync("./profile".concat(fileNameSuffix, ".cpuprofile"), JSON.stringify(profile));
                        return [2 /*return*/];
                }
            });
        });
    };
    ProfilingService.prototype.getInteger = function (value) {
        if (typeof value === 'number') {
            if (Number.isInteger(value)) {
                return value;
            }
        }
        return undefined;
    };
    return ProfilingService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/ragdollService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/ragdollService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   RagdollService: () => (/* binding */ RagdollService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var RagdollService = /** @class */ (function (_super) {
    __extends(RagdollService, _super);
    function RagdollService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        // TODO: think about tracking ragdoll state of player
        _this.safeRemoveRagdollFromWorld = function (actor, afterRemoveCallback) {
            _this.setLocalDamageMult(0);
            actor.forceRemoveRagdollFromWorld().then(function () {
                _this.controller.once("update", function () {
                    _this.setLocalDamageMult(_this.defaultLocalDamageMult);
                    afterRemoveCallback();
                });
            });
        };
        _this.defaultLocalDamageMult = 1;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    RagdollService.prototype.onceUpdate = function () {
        this.setLocalDamageMult(this.defaultLocalDamageMult);
    };
    RagdollService.prototype.setLocalDamageMult = function (damageMult) {
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCE", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCH", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCL", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCN", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCVE", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCVH", damageMult);
    };
    return RagdollService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/remoteServer.ts":
/*!***********************************************!*\
  !*** ./src/services/services/remoteServer.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   RemoteServer: () => (/* binding */ RemoteServer),
/* harmony export */   getPcInventory: () => (/* binding */ getPcInventory)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _lib_idManager__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../lib/idManager */ "./src/lib/idManager.ts");
/* harmony import */ var _lib_nameof__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../lib/nameof */ "./src/lib/nameof.ts");
/* harmony import */ var _sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../sync/actorvalues */ "./src/sync/actorvalues.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _sync_spell__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../../sync/spell */ "./src/sync/spell.ts");
/* harmony import */ var _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ../../view/modelApplyUtils */ "./src/view/modelApplyUtils.ts");
/* harmony import */ var _loadGameService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./loadGameService */ "./src/services/services/loadGameService.ts");
/* harmony import */ var _ragdollService__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./ragdollService */ "./src/services/services/ragdollService.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _timeService__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./timeService */ "./src/services/services/timeService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _voiceChatService__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./voiceChatService */ "./src/services/services/voiceChatService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
// @ts-expect-error (TODO: Remove in 2.10.0)



/* eslint-disable @typescript-eslint/no-empty-function */













// TODO: refactor worldViewMisc into service





var getPcInventory = function () {
    var res = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['pcInv'];
    if (typeof res === 'object' && res['entries']) {
        return res;
    }
    return undefined;
};
var setPcInventory = function (inv) {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['pcInv'] = inv;
};
var pcInvLastApply = 0;
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.on)('update', function () {
    if ((0,_sync_equipment__WEBPACK_IMPORTED_MODULE_7__.isBadMenuShown)()) {
        return;
    }
    if (Date.now() - pcInvLastApply > 5000) {
        pcInvLastApply = Date.now();
        var pcInv = getPcInventory();
        if (pcInv) {
            (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_8__.applyInventory)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), pcInv, false, true);
        }
    }
});
var unequipIronHelmet = function () {
    var ironHelment = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Armor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(0x00012e4d));
    var pl = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
    if (pl) {
        pl.unequipItem(ironHelment, false, true);
    }
};
var RemoteServer = /** @class */ (function (_super) {
    __extends(RemoteServer, _super);
    function RemoteServer(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.numSetInventory = 0;
        _this.controller.emitter.on("hostStartMessage", function (e) { return _this.onHostStartMessage(e); });
        _this.controller.emitter.on("hostStopMessage", function (e) { return _this.onHostStopMessage(e); });
        _this.controller.emitter.on("setInventoryMessage", function (e) { return _this.onSetInventoryMessage(e); });
        _this.controller.emitter.on("openContainerMessage", function (e) { return _this.onOpenContainerMessage(e); });
        _this.controller.emitter.on("updateMovementMessage", function (e) { return _this.onUpdateMovementMessage(e); });
        _this.controller.emitter.on("updateAnimationMessage", function (e) { return _this.onUpdateAnimationMessage(e); });
        _this.controller.emitter.on("updateEquipmentMessage", function (e) { return _this.onUpdateEquipmentMessage(e); });
        _this.controller.emitter.on("changeValuesMessage", function (e) { return _this.onChangeValuesMessage(e); });
        _this.controller.emitter.on("updateAppearanceMessage", function (e) { return _this.onUpdateAppearanceMessage(e); });
        _this.controller.emitter.on("teleportMessage", function (e) { return _this.onTeleportMessage(e); });
        _this.controller.emitter.on("teleportMessage2", function (e) { return _this.onTeleportMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.emitter.on("destroyActorMessage", function (e) { return _this.onDestroyActorMessage(e); });
        _this.controller.emitter.on("setRaceMenuOpenMessage", function (e) { return _this.onSetRaceMenuOpenMessage(e); });
        _this.controller.emitter.on("updatePropertyMessage", function (e) { return _this.onUpdatePropertyMessage(e); });
        _this.controller.emitter.on("deathStateContainerMessage", function (e) { return _this.onDeathStateContainerMessage(e); });
        _this.controller.emitter.on("connectionAccepted", function () { return _this.handleConnectionAccepted(); });
        _this.controller.emitter.on("spellCastMessage", function (e) { return _this.onSpellCastMessage(e); });
        _this.controller.emitter.on("updateAnimVariablesMessage", function (e) { return _this.onUpdateAnimVariablesMessage(e); });
        _this.controller.emitter.on("voiceChatMessage", function (e) { return _this.onVoiceChatMessage(e); });
        _this.controller.emitter.on("updateVoiceChatMessage", function (e) { return _this.onUpdateVoiceChatMessage(e); });
        return _this;
    }
    RemoteServer.prototype.onHostStartMessage = function (event) {
        var msg = event.message;
        var target = msg.target;
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        if (typeof hosted !== typeof []) {
            // if you try to switch to Set please checkout .concat usage.
            // concat compiles but doesn't work as expected
            hosted = new Array();
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'] = hosted;
        }
        if (!hosted.includes(target)) {
            hosted.push(target);
        }
    };
    RemoteServer.prototype.onHostStopMessage = function (event) {
        var msg = event.message;
        var target = msg.target;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, 'hostStop ' + target.toString(16));
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        if (typeof hosted === typeof []) {
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'] = hosted.filter(function (x) { return x !== target; });
        }
    };
    RemoteServer.prototype.onSetInventoryMessage = function (event) {
        var _this = this;
        this.numSetInventory++;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            setPcInventory(msg.inventory);
            var blocked = false;
            _this.controller.emitter.emit('queryBlockSetInventoryEvent', {
                block: function () { return blocked = true; }
            });
            if (!blocked) {
                pcInvLastApply = 0;
            }
        });
    };
    RemoteServer.prototype.onOpenContainerMessage = function (event) {
        var _this = this;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return __awaiter(_this, void 0, void 0, function () {
            var remoteId, localId, refr, baseObject, baseType, functionChecker, factName, delaySeconds;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                    case 1:
                        _a.sent(); // Give a chance to update inventory
                        remoteId = event.message.target;
                        localId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(remoteId);
                        refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(localId));
                        if (refr === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, 'onOpenContainerMessage - refr not found', 'remoteId', remoteId.toString(16), 'localId', localId.toString(16));
                            return [2 /*return*/];
                        }
                        refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), true);
                        baseObject = refr.getBaseObject();
                        baseType = baseObject === null || baseObject === void 0 ? void 0 : baseObject.getType();
                        functionChecker = null;
                        factName = "";
                        delaySeconds = -1.0;
                        if (baseType === 28 /* FormType.Container */) {
                            functionChecker = function () { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen("ContainerMenu"); };
                            factName = "'ContainerMenu open'";
                            delaySeconds = 0.0;
                        }
                        else if (baseType === 40 /* FormType.Furniture */) {
                            functionChecker = function () { var _a; return !!((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.getFurnitureReference()); };
                            factName = "'getFurnitureReference not null'";
                            delaySeconds = 1.0;
                        }
                        if (functionChecker === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - not a container or furniture", baseType);
                            return [2 /*return*/];
                        }
                        // In SkyMP containers have 2-nd, closing activation under the hood.
                        // This differs from Skyrim's behavior, where it's just one activation.
                        (function () { return __awaiter(_this, void 0, void 0, function () {
                            var message;
                            var _this = this;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting for", factName, "to be true");
                                        _a.label = 1;
                                    case 1:
                                        if (!!functionChecker()) return [3 /*break*/, 3];
                                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                                    case 2:
                                        _a.sent();
                                        return [3 /*break*/, 1];
                                    case 3:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting for", factName, "to be false");
                                        _a.label = 4;
                                    case 4:
                                        if (!functionChecker()) return [3 /*break*/, 6];
                                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                                    case 5:
                                        _a.sent();
                                        return [3 /*break*/, 4];
                                    case 6:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - menu closed", factName);
                                        message = {
                                            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.Activate,
                                            data: {
                                                caster: 0x14, target: event.message.target, isSecondActivation: true
                                            }
                                        };
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting", delaySeconds, "seconds before sending ActivateMessage");
                                        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.waitMenuMode(delaySeconds).then(function () {
                                            _this.controller.emitter.emit("sendMessage", {
                                                message: message,
                                                reliability: "reliable"
                                            });
                                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "onOpenContainerMesage - sent ActivateMessage", message);
                                        });
                                        return [2 /*return*/];
                                }
                            });
                        }); })();
                        return [2 /*return*/];
                }
            });
        }); });
    };
    RemoteServer.prototype.onTeleportMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var id = ("idx" in msg && typeof msg.idx === "number") ? _this.getIdManager().getId(msg.idx) : _this.getMyActorIndex();
            var refr = id === _this.getMyActorIndex() ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer() : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getObjectReference)(id);
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "Teleporting id", id, "refrId", refr === null || refr === void 0 ? void 0 : refr.getFormID().toString(16), "...", msg.pos, 'cell/world is', msg.worldOrCell.toString(16));
            var ragdollService = _this.controller.lookupListener(_ragdollService__WEBPACK_IMPORTED_MODULE_12__.RagdollService);
            var refrId = refr === null || refr === void 0 ? void 0 : refr.getFormID();
            var removeRagdollCallback = function () {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.moveRefrToPosition(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId || 0)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Cell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.worldOrCell)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.WorldSpace.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.worldOrCell)), msg.pos[0], msg.pos[1], msg.pos[2], msg.rot[0], msg.rot[1], msg.rot[2]);
            };
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor /*&& actor.getFormID() === 0x14*/) {
                ragdollService.safeRemoveRagdollFromWorld(actor, removeRagdollCallback);
            }
            else {
                removeRagdollCallback();
            }
        });
    };
    RemoteServer.prototype.onCreateActorMessage = function (event) {
        var _this = this;
        var _a;
        var msg = event.message;
        if (this.skipFormViewCreation(msg)) {
            var refrId_1 = msg.refrId;
            this.onceLoad(refrId_1, function (refr) {
                var _a;
                if (refr) {
                    _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.dealWithRef(refr, refr.getBaseObject());
                    if (msg.props) {
                        if (msg.props.inventory) {
                            _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelInventory(refr, msg.props.inventory);
                        }
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsOpen(refr, !!msg.props['isOpen']);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsHarvested(refr, !!msg.props['isHarvested']);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelNodeScale(refr, msg.props.setNodeScale);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelNodeTextureSet(refr, msg.props.setNodeTextureSet);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsDisabled(refr, !!msg.props['disabled']);
                        // TODO: move to a separate module
                        var animation_1 = msg.props.lastAnimation;
                        if (typeof animation_1 === "string") {
                            var refrid_1 = refr.getFormID();
                            (function () { return __awaiter(_this, void 0, void 0, function () {
                                var i_1, res2;
                                var _a;
                                return __generator(this, function (_b) {
                                    switch (_b.label) {
                                        case 0:
                                            i_1 = 0;
                                            _b.label = 1;
                                        case 1:
                                            if (!(i_1 < 5)) return [3 /*break*/, 4];
                                            res2 = (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrid_1))) === null || _a === void 0 ? void 0 : _a.playAnimation(animation_1);
                                            if (res2) {
                                                return [3 /*break*/, 4];
                                            }
                                            return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(2)];
                                        case 2:
                                            _b.sent();
                                            _b.label = 3;
                                        case 3:
                                            i_1++;
                                            return [3 /*break*/, 1];
                                        case 4: return [2 /*return*/];
                                    }
                                });
                            }); })();
                        }
                        var displayName = msg.props.displayName;
                        // keep in sync with spSnippetService.ts
                        if (typeof displayName === "string") {
                            var replaceValue = (_a = refr.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getName();
                            if (replaceValue !== undefined) {
                                displayName = displayName.replace(/%original_name%/g, replaceValue);
                            }
                            else {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, "Couldn't get a replaceValue for SetDisplayName, refr.getFormID() was", refr.getFormID().toString(16));
                            }
                            refr.setDisplayName(displayName, true);
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "calling setDisplayName", displayName, "for", refr.getFormID().toString(16));
                        }
                    }
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed to apply model to', refrId_1.toString(16));
                }
            });
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Create actor");
        var i = this.getIdManager().allocateIdFor(msg.idx);
        if (this.worldModel.forms.length <= i) {
            this.worldModel.forms.length = i + 1;
        }
        var movement = undefined;
        // TODO: better check if it is an npc (not an object reference)
        if (msg.refrId !== undefined && msg.refrId >= 0xff000000) {
            movement = {
                pos: msg.transform.pos,
                rot: msg.transform.rot,
                worldOrCell: msg.transform.worldOrCell,
                runMode: 'Standing',
                direction: 0,
                isInJumpState: false,
                isSneaking: false,
                isBlocking: false,
                isWeapDrawn: false,
                isDead: false,
                healthPercentage: 1.0,
                speed: 0,
            };
        }
        var form = {
            idx: msg.idx,
            movement: movement,
            numMovementChanges: 0,
            numAppearanceChanges: 0,
            baseId: msg.baseId,
            refrId: msg.refrId,
            isMyClone: msg.isMe,
        };
        this.worldModel.forms[i] = form;
        if (msg.appearance) {
            form.appearance = msg.appearance;
        }
        if (msg.equipment) {
            form.equipment = msg.equipment;
        }
        if (msg.isDead) {
            form.isDead = msg.isDead;
        }
        if (msg.animation) {
            form.animation = msg.animation;
        }
        if (msg.props) {
            for (var propName in msg.props) {
                form[propName] = msg.props[propName];
            }
        }
        msg.customPropsJsonDumps.forEach(function (element) {
            var _a;
            var parsed;
            try {
                parsed = JSON.parse(element.propValueJsonDump);
            }
            catch (e) {
                if (e instanceof SyntaxError) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, "createActor", (_a = msg.refrId) === null || _a === void 0 ? void 0 : _a.toString(16), "failed to parse custom prop", element.propName, element.propValueJsonDump, e.message);
                }
                else {
                    throw e;
                }
            }
            form[element.propName] = parsed;
        });
        if (msg.isMe) {
            this.worldModel.playerCharacterFormIdx = i;
            this.worldModel.playerCharacterRefrId = msg.refrId || 0;
        }
        // TODO: move to a separate module
        if (msg.props && !msg.props.isHostedByOther) {
        }
        if (msg.props && msg.props.isRaceMenuOpen && msg.isMe) {
            this.onSetRaceMenuOpenMessage({ message: { t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.SetRaceMenuOpen, open: true } });
        }
        var numSetInventory = this.numSetInventory;
        var applyPcInv = function () {
            if (msg.equipment) {
                (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_7__.applyEquipment)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), msg.equipment);
            }
            if (numSetInventory !== _this.numSetInventory) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, 'Skipping inventory apply due to newer setInventory message');
                return;
            }
            if (msg.props && msg.props.inventory) {
                _this.onSetInventoryMessage({
                    message: {
                        t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.SetInventory,
                        inventory: msg.props.inventory
                    }
                });
            }
        };
        if (msg.isMe && msg.props && msg.props.learnedSpells) {
            var learnedSpells_1 = msg.props.learnedSpells;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(function () {
                    var player = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                    if (player) {
                        (0,_sync_spell__WEBPACK_IMPORTED_MODULE_9__.removeAllSpells)(player);
                        (0,_sync_spell__WEBPACK_IMPORTED_MODULE_9__.learnSpells)(player, learnedSpells_1);
                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "player learnedSpells:", JSON.stringify(learnedSpells_1));
                    }
                });
            });
        }
        if (msg.isMe) {
            if ((_a = msg.props) === null || _a === void 0 ? void 0 : _a.isDead) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
                    _this.controller.emitter.emit("applyDeathStateEvent", {
                        actor: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(),
                        isDead: true
                    });
                });
            }
        }
        if (msg.isMe) {
            var spawnTask_1 = { running: false };
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                // Use MoveRefrToPosition to spawn if possible (not in main menu)
                // In case of connection lost this is essential
                if (!spawnTask_1.running) {
                    spawnTask_1.running = true;
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, 'Using moveRefrToPosition to spawn player');
                    (function () { return __awaiter(_this, void 0, void 0, function () {
                        var pl, pos, sqr, distance;
                        return __generator(this, function (_a) {
                            switch (_a.label) {
                                case 0:
                                    if (false) {}
                                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, 'Spawning...');
                                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.moveRefrToPosition(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Cell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.transform.worldOrCell)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.WorldSpace.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.transform.worldOrCell)), msg.transform.pos[0], msg.transform.pos[1], msg.transform.pos[2], msg.transform.rot[0], msg.transform.rot[1], msg.transform.rot[2]);
                                    return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1)];
                                case 1:
                                    _a.sent();
                                    pl = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                                    if (!pl) {
                                        return [3 /*break*/, 2];
                                    }
                                    pos = [
                                        pl.getPositionX(),
                                        pl.getPositionY(),
                                        pl.getPositionZ(),
                                    ];
                                    sqr = function (x) { return x * x; };
                                    distance = Math.sqrt(sqr(pos[0] - msg.transform.pos[0]) +
                                        sqr(pos[1] - msg.transform.pos[1]));
                                    if (distance < 256) {
                                        return [3 /*break*/, 2];
                                    }
                                    return [3 /*break*/, 0];
                                case 2: return [2 /*return*/];
                            }
                        });
                    }); })();
                    // Unfortunatelly it requires two calls to work
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(applyPcInv);
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1.3).then(applyPcInv);
                    // Note: appearance part was copy-pasted
                    if (msg.appearance) {
                        (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(msg.appearance);
                    }
                }
                if (msg.props) {
                    var baseActorValues_1 = new Map([
                        ['healRate', msg.props.healRate],
                        ['healRateMult', msg.props.healRateMult],
                        ['health', msg.props.health],
                        ['magickaRate', msg.props.magickaRate],
                        ['magickaRateMult', msg.props.magickaRateMult],
                        ['magicka', msg.props.magicka],
                        ['staminaRate', msg.props.staminaRate],
                        ['staminaRateMult', msg.props.staminaRateMult],
                        ['stamina', msg.props.stamina],
                        ['healthPercentage', msg.props.healthPercentage],
                        ['staminaPercentage', msg.props.staminaPercentage],
                        ['magickaPercentage', msg.props.magickaPercentage],
                    ]);
                    var player_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                    if (player_1) {
                        baseActorValues_1.forEach(function (value, key) {
                            if (typeof value === 'number') {
                                if (key.includes('Percentage')) {
                                    var subKey = key.replace('Percentage', '');
                                    var subValue = baseActorValues_1.get(subKey);
                                    if (typeof subValue === 'number') {
                                        (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(player_1, subKey, value);
                                    }
                                }
                                else {
                                    player_1.setActorValue(key, value);
                                }
                            }
                        });
                    }
                }
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('tick', function () {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('tick', function () {
                    if (!spawnTask_1.running) {
                        spawnTask_1.running = true;
                        var loadOrder = new Array();
                        for (var i_2 = 0; i_2 < _this.sp.Game.getModCount(); ++i_2) {
                            loadOrder.push(_this.sp.Game.getModName(i_2));
                        }
                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "loading game in world/cell", msg.transform.worldOrCell.toString(16));
                        var loadGameService = _this.controller.lookupListener(_loadGameService__WEBPACK_IMPORTED_MODULE_11__.LoadGameService);
                        loadGameService.loadGame(msg.transform.pos, msg.transform.rot, msg.transform.worldOrCell, msg.appearance
                            ? {
                                name: msg.appearance.name,
                                raceId: msg.appearance.raceId,
                                // TODO: In types, isFemale is under face, but in the reality SP expects it here. Fix required.
                                // @ts-expect-error
                                isFemale: msg.appearance.isFemale,
                                face: {
                                    hairColor: msg.appearance.hairColor,
                                    bodySkinColor: msg.appearance.skinColor,
                                    headTextureSetId: msg.appearance.headTextureSetId,
                                    headPartIds: msg.appearance.headpartIds,
                                    presets: msg.appearance.presets
                                },
                            }
                            : undefined, loadOrder, { minutes: 0, seconds: 0, hours: _this.controller.lookupListener(_timeService__WEBPACK_IMPORTED_MODULE_16__.TimeService).getTime().newGameHourValue });
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                            applyPcInv();
                            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.3).then(applyPcInv);
                            // Note: appearance part was copy-pasted
                            if (msg.appearance) {
                                (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(msg.appearance);
                            }
                        });
                    }
                });
            });
        }
    };
    RemoteServer.prototype.onDestroyActorMessage = function (event) {
        var _a;
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        this.worldModel.forms[i] = undefined;
        (_a = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getViewFromStorage)()) === null || _a === void 0 ? void 0 : _a.syncFormArray(this.worldModel);
        // Shrink to fit
        while (1) {
            var length = this.worldModel.forms.length;
            if (!length) {
                break;
            }
            if (this.worldModel.forms[length - 1]) {
                break;
            }
            this.worldModel.forms.length = length - 1;
        }
        if (this.worldModel.playerCharacterFormIdx === i) {
            this.worldModel.playerCharacterFormIdx = -1;
            this.worldModel.playerCharacterRefrId = 0;
            // TODO: move to a separate module
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.quitToMainMenu(); });
        }
        this.getIdManager().freeIdFor(msg.idx);
    };
    RemoteServer.prototype.onUpdateMovementMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateMovementMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.movement = msg.data;
        if (!form.numMovementChanges) {
            form.numMovementChanges = 0;
        }
        form.numMovementChanges++;
    };
    RemoteServer.prototype.onUpdateAnimationMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateAnimationMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.animation = msg.data;
    };
    RemoteServer.prototype.onUpdateAppearanceMessage = function (event) {
        var _this = this;
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateAppearanceMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.appearance = msg.data || undefined;
        if (!form.numAppearanceChanges) {
            form.numAppearanceChanges = 0;
        }
        form.numAppearanceChanges++;
        var newAppearance = msg.data;
        if (i === this.getMyActorIndex() && newAppearance) {
            this.controller.once("update", function () {
                (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(newAppearance);
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "Applied appearance to the player");
            });
        }
    };
    RemoteServer.prototype.onUpdateEquipmentMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateEquipmentMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.equipment = msg.data;
    };
    RemoteServer.prototype.onUpdatePropertyMessage = function (event) {
        var _this = this;
        var msg = event.message;
        var msgData = this.extractUpdatePropertyMessageData(msg);
        if (this.skipFormViewCreation(msg)) {
            var refrId_2 = msg.refrId;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId_2));
                if (!refr) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'UpdateProperty: refr not found');
                    return;
                }
                if (msg.propName === 'inventory') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelInventory(refr, msgData);
                }
                else if (msg.propName === 'isOpen') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsOpen(refr, !!msgData);
                }
                else if (msg.propName === 'isHarvested') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsHarvested(refr, !!msgData);
                }
                else if (msg.propName === 'disabled') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsDisabled(refr, !!msgData);
                }
            });
            return;
        }
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        form[msg.propName] = msgData;
    };
    RemoteServer.prototype.onDeathStateContainerMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Received death state:", JSON.stringify(msg.tIsDead));
        var id = this.getIdManager().getId(msg.tIsDead.idx);
        var form = this.worldModel.forms[id];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Form with idx", msg.tIsDead.idx, "not found");
            return;
        }
        if (msg.tIsDead.propName !== (0,_lib_nameof__WEBPACK_IMPORTED_MODULE_4__.nameof)('isDead')) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Invalid propName", msg.tIsDead.propName);
            return;
        }
        var msgData = this.extractUpdatePropertyMessageData(msg.tIsDead);
        if (typeof msgData !== 'boolean') {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Invalid data", msgData);
            return;
        }
        if (msg.tChangeValues) {
            this.onChangeValuesMessage({ message: msg.tChangeValues });
        }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return _this.onUpdatePropertyMessage({ message: msg.tIsDead }); });
        if (msg.tTeleport) {
            this.onTeleportMessage({ message: msg.tTeleport });
        }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var _a;
            var actor = id === _this.getWorldModel().playerCharacterFormIdx
                ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()
                : skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)((_a = form.refrId) !== null && _a !== void 0 ? _a : 0)));
            if (actor) {
                try {
                    _this.controller.emitter.emit("applyDeathStateEvent", {
                        actor: actor,
                        isDead: msgData
                    });
                }
                catch (e) {
                    if (e instanceof _lib_errors__WEBPACK_IMPORTED_MODULE_13__.RespawnNeededError) {
                        actor.disableNoWait(false);
                        actor.delete();
                    }
                    else {
                        throw e;
                    }
                }
            }
        });
    };
    RemoteServer.prototype.handleConnectionAccepted = function () {
        this.worldModel.forms = [];
        this.worldModel.playerCharacterFormIdx = -1;
        this.worldModel.playerCharacterRefrId = 0;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Handle connection accepted");
    };
    RemoteServer.prototype.onChangeValuesMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var id = _this.getIdManager().getId(msg.idx);
            var refr = id === _this.getMyActorIndex() ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer() : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getObjectReference)(id);
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (!ac) {
                return;
            }
            var _a = msg.data, health = _a.health, stamina = _a.stamina, magicka = _a.magicka;
            if (typeof health === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'health', health);
            }
            if (typeof stamina === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'stamina', stamina);
            }
            if (typeof magicka === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'magicka', magicka);
            }
        });
    };
    RemoteServer.prototype.onSetRaceMenuOpenMessage = function (event) {
        var msg = event.message;
        if (msg.open) {
            // wait 0.3s cause we can see visual bugs when teleporting
            // and showing this menu at the same time in onConnect
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.3).then(function () {
                    unequipIronHelmet();
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.showRaceMenu();
                });
            });
        }
        else {
            // TODO: Implement closeMenu in SkyrimPlatform
        }
    };
    /** Packet handlers end **/
    RemoteServer.prototype.getWorldModel = function () {
        return this.worldModel;
    };
    RemoteServer.prototype.getMyActorIndex = function () {
        return this.worldModel.playerCharacterFormIdx;
    };
    RemoteServer.prototype.getMyRemoteRefrId = function () {
        return this.worldModel.playerCharacterRefrId;
    };
    RemoteServer.prototype.getIdManager = function () {
        return this.idManager_;
    };
    Object.defineProperty(RemoteServer.prototype, "worldModel", {
        get: function () {
            if (typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"] === "function") {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"] = { forms: [], playerCharacterFormIdx: -1, playerCharacterRefrId: 0 };
            }
            return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"];
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(RemoteServer.prototype, "idManager_", {
        get: function () {
            if (typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"] === "function") {
                // Note: full IdManager object preserved across hot-reloads, including methods.
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"] = new _lib_idManager__WEBPACK_IMPORTED_MODULE_3__.IdManager();
            }
            return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"];
        },
        enumerable: false,
        configurable: true
    });
    RemoteServer.prototype.onceLoad = function (refrId, callback, maxAttempts) {
        var _this = this;
        if (maxAttempts === void 0) { maxAttempts = 120; }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
            if (refr) {
                callback(refr);
            }
            else {
                maxAttempts--;
                if (maxAttempts > 0) {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return _this.onceLoad(refrId, callback, maxAttempts); });
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed to load object reference ' + refrId.toString(16));
                }
            }
        });
    };
    ;
    RemoteServer.prototype.skipFormViewCreation = function (msg) {
        // Optimization added in #1186, however it doesn't work for doors for some reason
        return msg.refrId && msg.refrId < 0xff000000 && msg.baseRecordType !== 'DOOR';
    };
    ;
    RemoteServer.prototype.extractUpdatePropertyMessageData = function (updatePropertyMessage) {
        var msgData = updatePropertyMessage.data;
        if (updatePropertyMessage.dataDump !== undefined) {
            try {
                msgData = JSON.parse(updatePropertyMessage.dataDump);
            }
            catch (e) {
                if (e instanceof SyntaxError) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, 'extractUpdatePropertyMessageData - Failed to parse dataDump', updatePropertyMessage.dataDump);
                    return;
                }
                else {
                    throw e;
                }
            }
        }
        return msgData;
    };
    RemoteServer.prototype.onSpellCastMessage = function (event) {
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.caster)));
            if (!ac) {
                return;
            }
            var actorAnimationVariables = {
                booleans: new Uint8Array(msg.data.actorAnimationVariables.booleans),
                floats: new Uint8Array(msg.data.actorAnimationVariables.floats),
                integers: new Uint8Array(msg.data.actorAnimationVariables.integers)
            };
            if (msg.data.interruptCast) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.interruptCast)(ac.getFormID(), msg.data.castingSource, actorAnimationVariables);
                return;
            }
            var spell = ac.getEquippedSpell(msg.data.castingSource);
            if (spell) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.castSpellImmediate)(ac.getFormID(), msg.data.castingSource, spell.getFormID(), (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.target), msg.data.aimAngle, msg.data.aimHeading, actorAnimationVariables);
            }
        });
    };
    RemoteServer.prototype.onUpdateAnimVariablesMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.actorRemoteId)));
            if (!ac) {
                return;
            }
            var actorAnimationVariables = {
                booleans: new Uint8Array(msg.data.actorAnimationVariables.booleans),
                floats: new Uint8Array(msg.data.actorAnimationVariables.floats),
                integers: new Uint8Array(msg.data.actorAnimationVariables.integers)
            };
            var isApplyed = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.applyAnimationVariablesToActor)(ac.getFormID(), actorAnimationVariables);
            if (!isApplyed) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed apply AnimationVariables to actor with id: ' + ac.getFormID().toString(16));
            }
        });
    };
    RemoteServer.prototype.onVoiceChatMessage = function (event) {
        var msg = event.message;
        // Update form model with isTalking state
        var speakerForm = this.worldModel.forms.find(function (f) { return f && f.refrId === msg.data.speakerId; });
        if (speakerForm) {
            speakerForm.isTalking = msg.data.isTalking;
        }
        // Forward to VoiceChatService for processing
        var voiceChatService = this.controller.lookupListener(_voiceChatService__WEBPACK_IMPORTED_MODULE_18__.VoiceChatService);
        if (voiceChatService) {
            var audioData = new Uint8Array(msg.data.audioData);
            voiceChatService.onReceiveVoiceData(msg.data.speakerId, audioData.buffer, 0, 0, 0);
        }
    };
    RemoteServer.prototype.onUpdateVoiceChatMessage = function (event) {
        var msg = event.message;
        // Update form model with isTalking state
        var speakerForm = this.worldModel.forms.find(function (f) { return f && f.refrId === msg.data.speakerId; });
        if (speakerForm) {
            speakerForm.isTalking = msg.data.isTalking;
        }
        // Forward to VoiceChatService with 3D position data
        var voiceChatService = this.controller.lookupListener(_voiceChatService__WEBPACK_IMPORTED_MODULE_18__.VoiceChatService);
        if (voiceChatService) {
            var audioData = new Uint8Array(msg.data.audioData);
            voiceChatService.onReceiveVoiceData(msg.data.speakerId, audioData.buffer, msg.data.position[0], // x
            msg.data.position[1], // y
            msg.data.position[2] // z
            );
        }
    };
    return RemoteServer;
}(_clientListener__WEBPACK_IMPORTED_MODULE_14__.ClientListener));



/***/ }),

/***/ "./src/services/services/sendInputsService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/sendInputsService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SendInputsService: () => (/* binding */ SendInputsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _singlePlayerService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_movementGet__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/movementGet */ "./src/sync/movementGet.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_actorvalues__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../sync/actorvalues */ "./src/sync/actorvalues.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _view_hostAttempts__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../../view/hostAttempts */ "./src/view/hostAttempts.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _deathService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./deathService */ "./src/services/services/deathService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




// TODO: refactor this out









var playerFormId = 0x14;
// TODO: split this service into EquipmentService, MovementService, AnimationService, ActorValueService, HostAttemptsService
var SendInputsService = /** @class */ (function (_super) {
    __extends(SendInputsService, _super);
    function SendInputsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastSendMovementMoment = new Map();
        _this.playerAnimSource = new Map(); // TODO: make service
        _this.lastAnimationSent = new Map();
        _this.actorValuesNeedUpdate = false;
        _this.isRaceSexMenuShown = false;
        _this.equipmentChanged = false;
        _this.numEquipmentChanges = 0;
        _this.prevValues = { health: 0, stamina: 0, magicka: 0 };
        _this.prevActorValuesUpdateTime = 0;
        _this.prevCastingDetectedTime = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.on("equip", function (e) { return _this.onEquip(e); });
        _this.controller.on("unequip", function (e) { return _this.onUnequip(e); });
        _this.controller.on("loadGame", function () { return _this.onLoadGame(); });
        return _this;
    }
    SendInputsService.prototype.onUpdate = function () {
        if (!this.singlePlayerService.isSinglePlayer) {
            this.sendInputs();
            var player = this.sp.Game.getPlayer();
            var isPlayerCasting = player.getAnimationVariableBool("IsCastingRight")
                || player.getAnimationVariableBool("IsCastingLeft")
                || player.getAnimationVariableBool("IsCastingDual");
            if (isPlayerCasting) {
                this.prevCastingDetectedTime = Date.now();
            }
        }
    };
    SendInputsService.prototype.onEquip = function (event) {
        if (!event.actor || !event.baseObj) {
            return;
        }
        if (event.actor.getFormID() !== playerFormId) {
            return;
        }
        var type = event.baseObj.getType();
        if (type !== 27 /* FormType.Book */ && type !== 46 /* FormType.Potion */ && type !== 30 /* FormType.Ingredient */) {
            // Trigger UpdateEquipment only for equips that are not spell tomes, potions, ingredients
            this.equipmentChanged = true;
        }
        // Send OnEquip for any equips including spell tomes, potions, ingredients
        // Otherwise, the server won't trigger spell learn, potion drink, ingredient eat and Papyrus scripts
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.OnEquip, baseId: event.baseObj.getFormID() },
            reliability: "unreliable"
        });
    };
    SendInputsService.prototype.onUnequip = function (event) {
        if (!event.actor || !event.baseObj) {
            return;
        }
        if (event.actor.getFormID() === playerFormId) {
            this.equipmentChanged = true;
        }
    };
    SendInputsService.prototype.onLoadGame = function () {
        var _this = this;
        // Currently only armor is equipped after relogging (see remoteServer.ts)
        // This hack forces sending /equipment without weapons/ back to the server
        this.sp.Utility.wait(3).then(function () { return (_this.equipmentChanged = true); });
    };
    SendInputsService.prototype.sendInputs = function () {
        var _this = this;
        var hosted = typeof this.sp.storage['hosted'] === typeof [] ? this.sp.storage['hosted'] : [];
        var targets = [undefined].concat(hosted);
        var modelSource = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_10__.RemoteServer);
        var world = modelSource.getWorldModel();
        targets.forEach(function (target) {
            var targetFormModel = target ? _this.getForm(target, world) : _this.getForm(undefined, world);
            _this.sendMovement(target, targetFormModel);
            _this.sendAnimation(target);
            _this.sendAppearance(target);
            _this.sendEquipment(target);
            _this.sendActorValuePercentage(target, targetFormModel);
        });
        this.sendHostAttempts();
    };
    SendInputsService.prototype.sendMovement = function (_refrId, form) {
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        var refrIdStr = "".concat(_refrId);
        var sendMovementRateMs = 130;
        var now = Date.now();
        var last = this.lastSendMovementMoment.get(refrIdStr);
        if (!last || now - last > sendMovementRateMs) {
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateMovement,
                data: (0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_3__.getMovement)(owner, form),
                _refrId: _refrId
            };
            this.controller.emitter.emit("sendMessageWithRefrId", {
                message: message,
                reliability: "unreliable"
            });
            this.lastSendMovementMoment.set(refrIdStr, now);
        }
    };
    SendInputsService.prototype.sendActorValuePercentage = function (_refrId, form) {
        var _a;
        var canSend = form && ((_a = form.isDead) !== null && _a !== void 0 ? _a : false) === false;
        if (!canSend) {
            return;
        }
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        var av = (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_7__.getActorValues)(this.sp.Game.getPlayer());
        var currentTime = Date.now();
        if (this.actorValuesNeedUpdate === false &&
            this.prevValues.health === av.health &&
            this.prevValues.stamina === av.stamina &&
            this.prevValues.magicka === av.magicka) {
            return;
        }
        if (currentTime - this.prevActorValuesUpdateTime < 2000 &&
            this.actorValuesNeedUpdate === false) {
            return;
        }
        // Delaying actor values update due to casting
        // TODO: use partial updates for actor values once server finally supports it
        // i.e. keep sending health and stamina during casting, but delay magicka update
        if (currentTime - this.prevCastingDetectedTime < 500 &&
            av.health > 0 // don't delay death actor value update
        ) {
            return;
        }
        var deathService = this.controller.lookupListener(_deathService__WEBPACK_IMPORTED_MODULE_11__.DeathService);
        if (deathService.isBusy()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_12__.logTrace)(this, "Not sending actor values, death service is busy");
            return;
        }
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.ChangeValues,
            data: av,
            _refrId: _refrId
        };
        this.controller.emitter.emit("sendMessageWithRefrId", {
            message: message,
            reliability: "unreliable"
        });
        this.actorValuesNeedUpdate = false;
        this.prevValues = av;
        this.prevActorValuesUpdateTime = currentTime;
    };
    SendInputsService.prototype.sendAnimation = function (_refrId) {
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        // Extermly important that it's a local id since AnimationSource depends on it
        var refrIdStr = owner.getFormID().toString(16);
        var animSource = this.playerAnimSource.get(refrIdStr);
        if (!animSource) {
            animSource = new _sync_animation__WEBPACK_IMPORTED_MODULE_5__.AnimationSource(owner);
            this.playerAnimSource.set(refrIdStr, animSource);
        }
        var anim = animSource.getAnimation();
        var lastAnimationSent = this.lastAnimationSent.get(refrIdStr);
        if (!lastAnimationSent ||
            anim.numChanges !== lastAnimationSent.numChanges) {
            // Drink potion anim from this mod https://www.nexusmods.com/skyrimspecialedition/mods/97660
            if (anim.animEventName !== '' && !anim.animEventName.startsWith("DrinkPotion_")) {
                this.lastAnimationSent.set(refrIdStr, anim);
                this.updateActorValuesAfterAnimation(anim.animEventName);
                var message = {
                    t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimation,
                    data: anim,
                    _refrId: _refrId
                };
                this.controller.emitter.emit("sendMessageWithRefrId", {
                    message: message,
                    reliability: "unreliable"
                });
            }
        }
    };
    SendInputsService.prototype.sendAppearance = function (_refrId) {
        if (_refrId) {
            return;
        }
        var shown = this.sp.Ui.isMenuOpen('RaceSex Menu');
        if (shown != this.isRaceSexMenuShown) {
            this.isRaceSexMenuShown = shown;
            if (!shown) {
                this.sp.printConsole('Exited from race menu');
                var appearance = (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.getAppearance)(this.sp.Game.getPlayer());
                // TODO: log appearance contents to debug appearance issues?
                var message = {
                    t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAppearance,
                    data: appearance,
                    _refrId: _refrId
                };
                this.controller.emitter.emit("sendMessageWithRefrId", {
                    message: message,
                    reliability: "reliable"
                });
            }
        }
    };
    SendInputsService.prototype.sendEquipment = function (_refrId) {
        if (_refrId) {
            return;
        }
        if (this.equipmentChanged) {
            this.equipmentChanged = false;
            ++this.numEquipmentChanges;
            var eq = (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_8__.getEquipment)(this.sp.Game.getPlayer(), this.numEquipmentChanges);
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateEquipment,
                data: eq,
                _refrId: _refrId
            };
            this.controller.emitter.emit("sendMessageWithRefrId", {
                message: message,
                reliability: "reliable"
            });
        }
    };
    SendInputsService.prototype.sendHostAttempts = function () {
        var remoteId = (0,_view_hostAttempts__WEBPACK_IMPORTED_MODULE_9__.nextHostAttempt)();
        if (!remoteId) {
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Host,
                remoteId: remoteId
            },
            reliability: "unreliable"
        });
    };
    SendInputsService.prototype.getInputOwner = function (_refrId) {
        return _refrId
            ? this.sp.Actor.from(this.sp.Game.getFormEx(_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_4__.remoteIdToLocalId(_refrId)))
            : this.sp.Game.getPlayer();
    };
    SendInputsService.prototype.getForm = function (refrId, world) {
        var form = refrId
            ? world === null || world === void 0 ? void 0 : world.forms.find(function (f) { return (f === null || f === void 0 ? void 0 : f.refrId) === refrId; })
            : world.forms[world.playerCharacterFormIdx];
        return form;
    };
    SendInputsService.prototype.updateActorValuesAfterAnimation = function (animName) {
        if (animName === 'JumpLand' ||
            animName === 'JumpLandDirectional' ||
            animName === 'DeathAnim') {
            this.actorValuesNeedUpdate = true;
        }
    };
    Object.defineProperty(SendInputsService.prototype, "singlePlayerService", {
        get: function () {
            return this.controller.lookupListener(_singlePlayerService__WEBPACK_IMPORTED_MODULE_1__.SinglePlayerService);
        },
        enumerable: false,
        configurable: true
    });
    return SendInputsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/serverJsVerificationService.ts":
/*!**************************************************************!*\
  !*** ./src/services/services/serverJsVerificationService.ts ***!
  \**************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ServerJsVerificationService: () => (/* binding */ ServerJsVerificationService)
/* harmony export */ });
/* harmony import */ var node_crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! node:crypto */ "node:crypto");
/* harmony import */ var node_crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(node_crypto__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var ServerJsVerificationService = /** @class */ (function (_super) {
    __extends(ServerJsVerificationService, _super);
    function ServerJsVerificationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        return _this;
    }
    ServerJsVerificationService.prototype.verifyServerJs = function (src) {
        if (!src) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Empty server JS, skipping verification');
            return { src: src, error: null };
        }
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_2__.SettingsService);
        var getTargetPeerResult = settingsService.getTargetPeer();
        if (!getTargetPeerResult.targetPeerCached) {
            return { src: null, error: 'target peer not ready' };
        }
        var publicKeys = getTargetPeerResult.targetPeerCached.publicKeys;
        if (!publicKeys) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'No public keys configured, skipping server JS verification');
            return { src: src, error: null };
        }
        var lastLineStart = src.lastIndexOf('\n') + 1;
        var sigPrefix = '// skymp:sig:y:';
        if (lastLineStart === 0 || !src.substring(lastLineStart).startsWith(sigPrefix)) {
            return { src: null, error: 'no signature found' };
        }
        var _a = src.substring(lastLineStart + sigPrefix.length).split(':'), keyId = _a[0], sig = _a[1];
        if (!this.isAlphaNumeric(keyId)) {
            return { src: null, error: 'malformed key id' };
        }
        var key = publicKeys[keyId];
        if (!key) {
            return { src: null, error: 'unknown key' };
        }
        var toVerify = this.toArrayBufferView(src.substring(0, lastLineStart - 1), 'utf8');
        if (!(0,node_crypto__WEBPACK_IMPORTED_MODULE_0__.verify)(null, toVerify, key, this.toArrayBufferView(sig, 'base64'))) {
            return { src: null, error: 'bad signature' };
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Server JS verified with key ".concat(keyId));
        return { src: src, error: null };
    };
    ServerJsVerificationService.prototype.isAlphaNumeric = function (str) {
        for (var i = 0; i < str.length; ++i) {
            var code = str.charCodeAt(i);
            if (!((97 <= code && code <= 122) ||
                (65 <= code && code <= 90) ||
                (48 <= code && code <= 57))) {
                return false;
            }
        }
        return true;
    };
    ServerJsVerificationService.prototype.toArrayBufferView = function (str, enc) {
        var buf = Buffer.from(str, enc);
        return new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);
    };
    return ServerJsVerificationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/settingsService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/settingsService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SettingsService: () => (/* binding */ SettingsService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _authService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./authService */ "./src/services/services/authService.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _timersService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};





var SettingsService = /** @class */ (function (_super) {
    __extends(SettingsService, _super);
    function SettingsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.targetPeerCache = null;
        return _this;
    }
    SettingsService.prototype.getServerMasterKey = function () {
        var masterKey = this.sp.settings["skymp5-client"]["server-master-key"];
        if (!masterKey) {
            masterKey = this.sp.settings["skymp5-client"]["master-key"];
        }
        if (!masterKey) {
            masterKey = this.sp.settings["skymp5-client"]["server-ip"] + ":" + this.sp.settings["skymp5-client"]["server-port"];
        }
        return masterKey;
    };
    SettingsService.prototype.getMasterUrl = function () {
        return this.normalizeUrl(this.sp.settings["skymp5-client"]["master"] || "https://gateway.skymp.net");
    };
    SettingsService.prototype.makeMasterApiClient = function () {
        var masterApiBaseUrl = this.getMasterUrl();
        return new skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.HttpClient(masterApiBaseUrl);
    };
    SettingsService.prototype.getTargetPeer = function (callback) {
        var _this = this;
        if (this.targetPeerCache) {
            callback === null || callback === void 0 ? void 0 : callback(this.targetPeerCache);
            return { targetPeerCached: this.targetPeerCache };
        }
        this.getTargetPeerImpl(function (targetPeer) {
            _this.targetPeerCache = targetPeer;
            callback === null || callback === void 0 ? void 0 : callback(targetPeer);
        });
        return { targetPeerCached: null };
    };
    // have to use callbacks here: promises don't work in the main menu
    SettingsService.prototype.getTargetPeerImpl = function (callback) {
        var _this = this;
        var masterApiClient = this.makeMasterApiClient();
        var masterKey = this.getServerMasterKey();
        var serverInfoRequestTimeoutMs = 5000;
        var defaultPeer = {
            host: this.sp.settings['skymp5-client']['server-ip'],
            port: this.sp.settings['skymp5-client']['server-port'],
            publicKeys: this.sp.settings['skymp5-client']['server-public-keys'],
        };
        var resolved = false;
        var states = {
            start: function () {
                var _a;
                try {
                    if (_this.sp.settings['skymp5-client']['server-info-ignore']) {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, 'Skipping serverinfo request due to server-info-ignore in config');
                        states.resolve(defaultPeer);
                        return;
                    }
                    _this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService).setTimeout(function () { return states.reject(new Error('getTargetPeer: serverinfo request timed out')); }, serverInfoRequestTimeoutMs);
                    var headers = {};
                    var session = (_a = _this.controller.lookupListener(_authService__WEBPACK_IMPORTED_MODULE_1__.AuthService).readAuthDataFromDisk()) === null || _a === void 0 ? void 0 : _a.session;
                    if (session) {
                        headers['X-Session'] = session;
                    }
                    masterApiClient.get("/api/servers/".concat(masterKey, "/serverinfo"), { headers: headers }, states.handleResponse);
                }
                catch (e) {
                    states.reject(e);
                }
            },
            handleResponse: function (res) {
                try {
                    if (res.status !== 200) {
                        throw new Error("status ".concat(res.status));
                    }
                    states.resolve(JSON.parse(res.body));
                }
                catch (e) {
                    states.reject(e);
                }
            },
            resolve: function (targetPeer) {
                if (resolved) {
                    return;
                }
                resolved = true;
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Resolved target peer", targetPeer);
                var enrichedTargetPeer = __assign({}, targetPeer);
                enrichedTargetPeer.publicKeys = __assign(__assign({}, defaultPeer.publicKeys), targetPeer.publicKeys);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Enriched target peer", enrichedTargetPeer);
                callback(enrichedTargetPeer);
            },
            reject: function (err) {
                if (resolved) {
                    return;
                }
                resolved = true;
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Server info request failed, falling back to", defaultPeer, "; error:", err);
                callback(defaultPeer);
            },
        };
        states.start();
    };
    SettingsService.prototype.getServerMods = function () {
        return __awaiter(this, void 0, void 0, function () {
            var masterApiClient, masterKey, attempt, res, manifest, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        masterApiClient = this.makeMasterApiClient();
                        masterKey = this.getServerMasterKey();
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(masterKey);
                        attempt = 0;
                        _a.label = 1;
                    case 1:
                        if (!(attempt < 5)) return [3 /*break*/, 7];
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 4, , 6]);
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Trying to get server mods, attempt ".concat(attempt));
                        return [4 /*yield*/, masterApiClient.get("/api/servers/".concat(masterKey, "/manifest.json"))];
                    case 3:
                        res = _a.sent();
                        if (res.status != 200) {
                            throw new Error("status code ".concat(res.status, ", error ").concat(res.error));
                        }
                        manifest = JSON.parse(res.body);
                        if (manifest.versionMajor !== 1) {
                            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("server manifest version is ".concat(manifest.versionMajor, ", we expect 1"));
                            return [2 /*return*/, []];
                        }
                        return [2 /*return*/, manifest.mods];
                    case 4:
                        e_1 = _a.sent();
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Request/parse error: ".concat(e_1));
                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1 + Math.random())];
                    case 5:
                        _a.sent();
                        return [3 /*break*/, 6];
                    case 6:
                        ++attempt;
                        return [3 /*break*/, 1];
                    case 7: return [2 /*return*/, []];
                }
            });
        });
    };
    ;
    SettingsService.prototype.getServerPort = function () {
        // Return the server port from settings
        return this.sp.settings['skymp5-client']['server-port'] || 7777;
    };
    SettingsService.prototype.normalizeUrl = function (url) {
        if (url.endsWith('/')) {
            return url.slice(0, url.length - 1);
        }
        return url;
    };
    ;
    return SettingsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/singlePlayerService.ts":
/*!******************************************************!*\
  !*** ./src/services/services/singlePlayerService.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SinglePlayerService: () => (/* binding */ SinglePlayerService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SinglePlayerService = /** @class */ (function (_super) {
    __extends(SinglePlayerService, _super);
    function SinglePlayerService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this._isSinglePlayer = false;
        _this.controller.emitter.on("gameLoad", function (e) { return _this.onGameLoad(e); });
        return _this;
    }
    Object.defineProperty(SinglePlayerService.prototype, "isSinglePlayer", {
        get: function () {
            return this._isSinglePlayer;
        },
        enumerable: false,
        configurable: true
    });
    SinglePlayerService.prototype.onGameLoad = function (event) {
        if (!event.isCausedBySkyrimPlatform && !this._isSinglePlayer) {
            this.sp.Debug.messageBox('Save has been loaded in multiplayer, switching to the single-player mode');
            this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).close();
            this._isSinglePlayer = true;
            this.sp.Game.setInChargen(false, false, false);
        }
    };
    return SinglePlayerService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/skympClient.ts":
/*!**********************************************!*\
  !*** ./src/services/services/skympClient.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SkympClient: () => (/* binding */ SkympClient)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();







(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('Hello Multiplayer!');
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('settings:', skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.settings['skymp5-client']);
var SkympClient = /** @class */ (function (_super) {
    __extends(SkympClient, _super);
    function SkympClient(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("connectionFailed", function (e) { return _this.onConnectionFailed(e); });
        _this.controller.emitter.on("connectionDenied", function (e) { return _this.onConnectionDenied(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onActorCreateMessage(e); });
        // TODO: refactor out very similar code in frontHotReloadService.ts
        var authGameData = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_3__.authGameDataStorageKey];
        var storageHasValidAuthGameData = (authGameData === null || authGameData === void 0 ? void 0 : authGameData.local) || (authGameData === null || authGameData === void 0 ? void 0 : authGameData.remote);
        if (storageHasValidAuthGameData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(_this, "Recovered AuthGameData from storage, starting client");
            _this.startClient();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(_this, "Unable to recover AuthGameData from storage, requesting auth");
            // Next tick because we're in constructor of the service, AuthService may not be listening events yet
            _this.controller.once("tick", function () {
                _this.controller.emitter.emit("authNeeded", {});
            });
            _this.controller.emitter.on("authAttempt", function (e) { return _this.onAuthAttempt(e); });
        }
        return _this;
    }
    SkympClient.prototype.onAuthAttempt = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Caught auth event");
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_3__.authGameDataStorageKey] = e.authGameData;
        this.startClient();
        // TODO: remove this when you will be able to see errors without console
        // this.sp.browser.setFocused(false);
    };
    SkympClient.prototype.onActorCreateMessage = function (e) {
        if (e.message.isMe) {
            this.sp.browser.setFocused(false);
        }
    };
    SkympClient.prototype.onConnectionFailed = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Connection failed");
    };
    SkympClient.prototype.onConnectionDenied = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Connection denied: " + e.error);
    };
    SkympClient.prototype.startClient = function () {
        var _this = this;
        // once("tick", ...) is needed to ensure networking service initialized
        this.controller.once("tick", function () { return _this.establishConnectionConditional(); });
        this.ctor();
    };
    SkympClient.prototype.ctor = function () {
        // TODO: refactor into service
        (0,_sync_animation__WEBPACK_IMPORTED_MODULE_2__.setupHooks)();
        this.sp.printConsole('SkympClient ctor');
    };
    SkympClient.prototype.establishConnectionConditional = function () {
        var _this = this;
        var isConnected = this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).isConnected();
        if (isConnected) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, 'Reconnect is not required');
            return;
        }
        this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_6__.SettingsService).getTargetPeer(function (_a) {
            var host = _a.host, port = _a.port;
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage.targetIp = host;
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage.targetPort = port;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Connecting to ".concat(host, ":").concat(port));
            _this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).connect(host, port);
        });
    };
    return SkympClient;
}(_clientListener__WEBPACK_IMPORTED_MODULE_4__.ClientListener));



/***/ }),

/***/ "./src/services/services/spSnippetService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/spSnippetService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpSnippetService: () => (/* binding */ SpSnippetService)
/* harmony export */ });
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _view_worldView__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../view/worldView */ "./src/view/worldView.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};


// TODO: refactor worldViewMisc into service



var SpSnippetService = /** @class */ (function (_super) {
    __extends(SpSnippetService, _super);
    function SpSnippetService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("spSnippetMessage", function (e) { return _this.onSpSnippetMessage(e); });
        _this.spAny = sp;
        return _this;
    }
    SpSnippetService.prototype.onSpSnippetMessage = function (event) {
        var _this = this;
        var msg = event.message;
        this.controller.once('update', function () { return __awaiter(_this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                this.run(msg)
                    .then(function (res) {
                    var isNoResultSnippet = msg.snippetIdx === 0xffffffff;
                    if (isNoResultSnippet) {
                        return;
                    }
                    if (res === undefined) {
                        res = null;
                    }
                    if (res !== null
                        && typeof res !== "number"
                        && typeof res !== "string"
                        && typeof res !== "boolean") {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(_this, "Unsupported SpSnippet result type '".concat(typeof res, "'"));
                        return;
                    }
                    var message = res === null ? {
                        t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.FinishSpSnippet,
                        snippetIdx: msg.snippetIdx
                    }
                        : {
                            t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.FinishSpSnippet,
                            returnValue: res,
                            snippetIdx: msg.snippetIdx,
                        };
                    _this.controller.emitter.emit("sendMessage", {
                        message: message,
                        reliability: "reliable"
                    });
                })
                    .catch(function (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(_this, 'SpSnippet ' + msg.class + ' ' + msg.function + ' failed ' + e);
                });
                return [2 /*return*/];
            });
        }); });
    };
    SpSnippetService.prototype.run = function (snippet) {
        var _a;
        return __awaiter(this, void 0, void 0, function () {
            var functionLowerCase, classLowerCase, newName, selfId, self, replaceValue, worldView_1, form, sign, count, soundId, sound, name, name;
            var _this = this;
            return __generator(this, function (_b) {
                functionLowerCase = snippet.function.toLowerCase();
                classLowerCase = snippet.class.toLowerCase();
                // keep in sync with remoteServer.ts
                if (classLowerCase === "objectreference") {
                    if (functionLowerCase === "setdisplayname") {
                        newName = snippet.arguments[0];
                        if (typeof newName === "string") {
                            selfId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(snippet.selfId);
                            self = this.sp.ObjectReference.from(this.sp.Game.getFormEx(selfId));
                            replaceValue = (_a = self === null || self === void 0 ? void 0 : self.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getName();
                            if (replaceValue !== undefined) {
                                newName = newName.replace(/%original_name%/g, replaceValue);
                                snippet.arguments[0] = newName;
                            }
                            else {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Couldn't get a replaceValue for SetDisplayName, snippet.selfId was", snippet.selfId.toString(16));
                            }
                        }
                        else {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Encountered SetDisplayName with non-string argument", newName);
                        }
                    }
                }
                if (classLowerCase === "game") {
                    if (functionLowerCase === "showracemenu" || functionLowerCase === "showlimitedracemenu") {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "showracemenu called");
                        worldView_1 = this.controller.lookupListener(_view_worldView__WEBPACK_IMPORTED_MODULE_4__.WorldView);
                        worldView_1.setFormViewUpdateAllowed(false);
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Waiting 1.0s before calling showracemenu");
                        this.sp.Utility.wait(1.0).then(function () {
                            _this.runStatic(snippet);
                            worldView_1.waitGameTimeAndAllowFormViewUpdate(1.0);
                        });
                        return [2 /*return*/];
                    }
                }
                if (classLowerCase === "skymphacks") {
                    if (functionLowerCase === "additem" || functionLowerCase === "removeitem") {
                        form = this.sp.Form.from(this.deserializeArg(snippet.arguments[0]));
                        if (form === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Unable to find form with id " + snippet.arguments[0].formId.toString(16));
                            return [2 /*return*/];
                        }
                        sign = snippet.function === "AddItem" ? "+" : "-";
                        count = snippet.arguments[1];
                        soundId = 0x334ab;
                        if (form.getFormID() !== 0xf) {
                            soundId = 0x14115;
                        }
                        sound = this.sp.Sound.from(this.sp.Game.getFormEx(soundId));
                        if (sound !== null) {
                            name = form.getName();
                            if (name.trim() === "") {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Sound will not be played because item has no name");
                            }
                            else {
                                sound.play(this.sp.Game.getPlayer());
                            }
                        }
                        else {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Unable to find sound with id " + soundId.toString(16));
                        }
                        if (count <= 0) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Positive count expected, got " + count.toString());
                        }
                        else {
                            name = form.getName();
                            if (name.trim() === "") {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Notification will not be shown because item has no name");
                            }
                            else {
                                this.sp.Debug.notification(sign + " " + name + " (" + count + ")");
                            }
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, sign + " " + name + " (" + count + ")");
                        }
                    }
                    else
                        throw new Error("Unknown SkympHack - " + snippet.function);
                    return [2 /*return*/];
                }
                return [2 /*return*/, snippet.selfId ? this.runMethod(snippet) : this.runStatic(snippet)];
            });
        });
    };
    ;
    SpSnippetService.prototype.deserializeArg = function (arg) {
        if (typeof arg === "object") {
            var formId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(arg.formId);
            var form = this.sp.Game.getFormEx(formId);
            var cl = this.spAny[arg.type];
            if (!cl) {
                var matchingKey = Object.keys(this.spAny).find(function (key) {
                    return key.toLowerCase() === arg.type.toLowerCase();
                });
                if (matchingKey) {
                    cl = this.spAny[matchingKey];
                }
            }
            if (!cl) {
                throw new Error("deserializeArg - Class ".concat(arg.type, " not found"));
            }
            var gameObject = cl.from(form);
            return gameObject;
        }
        return arg;
    };
    ;
    SpSnippetService.prototype.runMethod = function (snippet) {
        return __awaiter(this, void 0, void 0, function () {
            var selfId, self, cl, matchingKey, selfCasted, f;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        selfId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(snippet.selfId);
                        self = this.sp.Game.getFormEx(selfId);
                        if (!self)
                            throw new Error("Unable to find form with id ".concat(selfId.toString(16)));
                        cl = this.spAny[snippet.class];
                        if (!cl) {
                            matchingKey = Object.keys(this.spAny).find(function (key) {
                                return key.toLowerCase() === snippet.class.toLowerCase();
                            });
                            if (matchingKey) {
                                cl = this.spAny[matchingKey];
                            }
                        }
                        if (!cl) {
                            throw new Error("runMethod - Class ".concat(snippet.class, " not found, found"));
                        }
                        selfCasted = cl.from(self);
                        if (!selfCasted)
                            throw new Error("Form ".concat(selfId.toString(16), " is not instance of ").concat(snippet.class, ", form type is ").concat(self.getType()));
                        f = selfCasted[snippet.function];
                        return [4 /*yield*/, f.apply(selfCasted, snippet.arguments.map(function (arg) { return _this.deserializeArg(arg); }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ;
    SpSnippetService.prototype.runStatic = function (snippet) {
        return __awaiter(this, void 0, void 0, function () {
            var papyrusClass;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        papyrusClass = this.spAny[snippet.class];
                        return [4 /*yield*/, papyrusClass[snippet.function].apply(papyrusClass, snippet.arguments.map(function (arg) { return _this.deserializeArg(arg); }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ;
    return SpSnippetService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/spVersionCheckService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/spVersionCheckService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpVersionCheckService: () => (/* binding */ SpVersionCheckService)
/* harmony export */ });
/* harmony import */ var _version__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../version */ "./src/version.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SpVersionCheckService = /** @class */ (function (_super) {
    __extends(SpVersionCheckService, _super);
    function SpVersionCheckService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SpVersionCheckService.prototype.onceUpdate = function () {
        var _this = this;
        var realVersion = this.sp.getPlatformVersion();
        if (!_version__WEBPACK_IMPORTED_MODULE_0__.requiredVersion.includes(realVersion)) {
            this.sp.Debug.messageBox("You need to have on of those SkyrimPlatform versions ".concat(JSON.stringify(_version__WEBPACK_IMPORTED_MODULE_0__.requiredVersion), " to join this server. Your current version is ").concat(realVersion));
            this.sp.Utility.waitMenuMode(0.5).then(function () {
                _this.controller.on('update', function () {
                    if (!_this.sp.Ui.isMenuOpen('MessageBoxMenu')) {
                        _this.sp.Game.quitToMainMenu();
                    }
                });
            });
        }
    };
    return SpVersionCheckService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetCameraEnforcementService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetCameraEnforcementService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetCameraEnforcementService: () => (/* binding */ SweetCameraEnforcementService)
/* harmony export */ });
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var playerId = 0x14;
// ex AnimDebugService part
var SweetCameraEnforcementService = /** @class */ (function (_super) {
    __extends(SweetCameraEnforcementService, _super);
    function SweetCameraEnforcementService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.currentAnim = null;
        _this.stopAnimInProgress = false;
        _this.exitAnimName = null;
        _this.interruptAnimName = null;
        _this.tryInvokeAnimCount = 0;
        _this.lastNotificationMoment = 0;
        _this.tryInvokeAnimCountMax = 1000000000;
        _this.exitAnimEvent = undefined;
        _this.optionsCache = undefined;
        _this.optionCb = undefined;
        _this.usePlayerControlsDelayMs = true;
        var hasSweetPie = _this.hasSweetPie();
        if (!hasSweetPie) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.settings = _this.sp.settings["skymp5-client"]["animDebug"];
        if (hasSweetPie) {
            var self_1 = _this;
            _this.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) { },
                leave: function (ctx) {
                    self_1.onSendAnimationEventLeave(ctx);
                    self_1.onSendExitAnimationEventLeave(ctx); // Tracking the successful launch of the exit animation
                },
            }, playerId, playerId);
            _this.controller.on("buttonEvent", function (e) { return _this.onButtonEvent(e); });
            _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage2(e); });
        }
        return _this;
    }
    SweetCameraEnforcementService.prototype.onCustomPacketMessage2 = function (e) {
        var _this = this;
        var content = {};
        try {
            content = JSON.parse(e.message.contentJsonDump);
        }
        catch (err) {
            if (err instanceof SyntaxError) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Failed to parse custom packet contentJsonDump:", e.message.contentJsonDump, "Error:", err);
                return;
            }
            throw err;
        }
        if (content["customPacketType"] !== "invokeAnim") {
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received custom packet with customPacketType invokeAnim");
        var name = content["animEventName"];
        var requestId = content["requestId"];
        var weaponDrawnAllowed = content["weaponDrawnAllowed"];
        var furnitureAllowed = content["furnitureAllowed"];
        var exitAnimName = content["exitAnimName"];
        var interruptAnimName = content["interruptAnimName"];
        var timeMs = content["timeMs"];
        var isPlayExitAnimAfterwardsEnabled = content["isPlayExitAnimAfterwardsEnabled"];
        var parentAnimEventName = content["parentAnimEventName"];
        var enablePlayerControlsDelayMs = content["enablePlayerControlsDelayMs"];
        var preferInterruptAnimAsExitAnimTimeMs = content["preferInterruptAnimAsExitAnimTimeMs"];
        if (typeof name !== "string") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Expected animEventName to be string");
            return;
        }
        if (typeof requestId !== "string" && typeof requestId !== "number" && typeof requestId !== "undefined") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Expected requestId to be string or number or undefined");
            return;
        }
        this.controller.once("update", function () {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Trying to invoke anim", name, "with weaponDrawnAllowed=", weaponDrawnAllowed, ", furnitureAllowed=", furnitureAllowed, ", exitAnimName=", exitAnimName, ", interruptAnimName=", interruptAnimName, ", timeMs=", timeMs, ", isPlayExitAnimAfterwardsEnabled=", isPlayExitAnimAfterwardsEnabled, ", parentAnimEventName=", parentAnimEventName, ", enablePlayerControlsDelayMs=", enablePlayerControlsDelayMs, ", preferInterruptAnimAsExitAnimTimeMs=", preferInterruptAnimAsExitAnimTimeMs);
            var result = _this.tryInvokeAnim(name, { weaponDrawnAllowed: weaponDrawnAllowed, furnitureAllowed: furnitureAllowed, exitAnimName: exitAnimName, interruptAnimName: interruptAnimName, timeMs: timeMs, isPlayExitAnimAfterwardsEnabled: isPlayExitAnimAfterwardsEnabled, parentAnimEventName: parentAnimEventName, enablePlayerControlsDelayMs: enablePlayerControlsDelayMs, preferInterruptAnimAsExitAnimTimeMs: preferInterruptAnimAsExitAnimTimeMs });
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: "invokeAnimResult",
                    result: result,
                    requestId: requestId,
                })
            };
            _this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable",
            });
        });
    };
    SweetCameraEnforcementService.prototype.onSendAnimationEventLeave = function (ctx) {
        var _this = this;
        var animLowerCase = ctx.animEventName.toLowerCase();
        if (animLowerCase.startsWith("idle") && !animLowerCase.startsWith("idleforcedefaultstate")) {
            this.controller.once("update", function () {
                var _a;
                // This is only for player.playidle
                if (!_this.sp.Ui.isMenuOpen("Console" /* Menu.Console */)) {
                    return;
                }
                if ((_a = _this.sp.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.getFurnitureReference()) {
                    return;
                }
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Forcing third person and disabling player controls");
                _this.sp.Game.forceThirdPerson();
                _this.sp.Game.disablePlayerControls(true, false, true, false, false, false, false, false, 0);
                _this.currentAnim = { name: ctx.animEventName, options: null, preferInterruptAnimState: null };
                _this.startAntiExploitPolling();
            });
        }
    };
    SweetCameraEnforcementService.prototype.exitAnim = function (options) {
        var _this = this;
        var _a, _b;
        // TODO(1): See another TODO(1) in this file
        if (options.playExitAnim) {
            var useInterruptAnimAsExitAnim = false;
            if (options.useInterruptAnimAsExitAnim) {
                useInterruptAnimAsExitAnim = true;
                this.usePlayerControlsDelayMs = false;
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Using interrupt anim as exit anim: ".concat(this.interruptAnimName, ". Reason: useInterruptAnimAsExitAnim is true"));
            }
            if ((_b = (_a = this.currentAnim) === null || _a === void 0 ? void 0 : _a.preferInterruptAnimState) === null || _b === void 0 ? void 0 : _b.prefer) {
                useInterruptAnimAsExitAnim = true;
                this.usePlayerControlsDelayMs = false;
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Using interrupt anim as exit anim: ".concat(this.interruptAnimName, ". Reason: preferInterruptAnimState.prefer is true"));
            }
            var animEventToSend = useInterruptAnimAsExitAnim ? (this.interruptAnimName || "IdleStop") : (this.exitAnimName || "IdleForceDefaultState");
            this.sp.Debug.sendAnimationEvent(this.sp.Game.getPlayer(), animEventToSend);
            this.exitAnimEvent = animEventToSend;
            this.optionsCache = options;
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Sent animation event:", animEventToSend);
        }
        else {
            this.currentAnim = null;
            var enablePlayerControlsDelaySeconds = (typeof options.enablePlayerControlsDelayMs === "number"
                && options.enablePlayerControlsDelayMs > 0
                && Number.isFinite(options.enablePlayerControlsDelayMs)
                && this.usePlayerControlsDelayMs)
                ? options.enablePlayerControlsDelayMs / 1000
                : 0.5;
            var stopAnimDelaySeconds = enablePlayerControlsDelaySeconds + 0.5;
            this.stopAnimInProgress = true;
            this.sp.Utility.wait(enablePlayerControlsDelaySeconds).then(function () {
                _this.sp.Game.enablePlayerControls(true, false, true, false, false, false, false, false, 0);
            });
            this.sp.Utility.wait(stopAnimDelaySeconds).then(function () {
                _this.stopAnimInProgress = false;
                if (_this.optionCb) {
                    _this.optionCb();
                    _this.optionCb = undefined;
                }
            });
        }
    };
    SweetCameraEnforcementService.prototype.onSendExitAnimationEventLeave = function (ctx) {
        var _this = this;
        if (ctx.animationSucceeded && this.exitAnimEvent && this.optionsCache && ctx.animEventName === this.exitAnimEvent) {
            this.currentAnim = null;
            var enablePlayerControlsDelaySeconds = (typeof this.optionsCache.enablePlayerControlsDelayMs === "number"
                && this.optionsCache.enablePlayerControlsDelayMs > 0
                && Number.isFinite(this.optionsCache.enablePlayerControlsDelayMs)
                && this.usePlayerControlsDelayMs)
                ? this.optionsCache.enablePlayerControlsDelayMs / 1000
                : 0.5;
            var stopAnimDelaySeconds = enablePlayerControlsDelaySeconds + 0.5;
            this.stopAnimInProgress = true;
            this.optionsCache = undefined;
            this.exitAnimEvent = undefined;
            this.usePlayerControlsDelayMs = true;
            this.sp.Utility.wait(enablePlayerControlsDelaySeconds).then(function () {
                _this.sp.Game.enablePlayerControls(true, false, true, false, false, false, false, false, 0);
            });
            this.sp.Utility.wait(stopAnimDelaySeconds).then(function () {
                _this.stopAnimInProgress = false;
                if (_this.optionCb) {
                    _this.optionCb();
                    _this.optionCb = undefined;
                }
            });
        }
        else {
            this.optionsCache = undefined;
            this.exitAnimEvent = undefined;
            if (this.optionCb) {
                this.optionCb = undefined;
            }
        }
    };
    SweetCameraEnforcementService.prototype.startAntiExploitPolling = function (mode) {
        // Fixes https://github.com/skyrim-multiplayer/skymp5-gamemode/issues/240
        // P.S. There is a very similar code in skymp5-gamemode
        // See disableCheats.ts, skymp5-gamemode for comments
        var _this = this;
        if (mode === void 0) { mode = "death"; }
        var _callNative = this.sp.callNative;
        var cameraState = -1;
        var needsExitingAnim = false;
        var f = function (i) {
            var _a;
            if (i >= 10 * 60) {
                return;
            }
            cameraState = _callNative("Game", "getCameraState", undefined);
            needsExitingAnim = _this.needsExitingAnim;
            if (!needsExitingAnim) {
                return f(Infinity);
            }
            if (cameraState === 0) { // 1-st person
                _callNative("Game", "forceThirdPerson", undefined);
                _this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
                if (mode === "death") {
                    (_a = _this.sp.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.damageActorValue("Health", 10000);
                }
                return f(Infinity);
            }
            _this.controller.once("update", function () { return f(i + 1); });
        };
        f(0);
    };
    SweetCameraEnforcementService.prototype.onButtonEvent = function (e) {
        var _a, _b;
        // TODO: de-hardcode controls
        if (e.isPressed) {
            return;
        }
        if (e.code === 57 /* DxScanCode.Spacebar */
            || e.code === 17 /* DxScanCode.W */
            || e.code === 30 /* DxScanCode.A */
            || e.code === 31 /* DxScanCode.S */
            || e.code === 32 /* DxScanCode.D */) {
            if (this.needsExitingAnim) {
                if ((_a = this.currentAnim) === null || _a === void 0 ? void 0 : _a.options) {
                    this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: this.currentAnim.options.enablePlayerControlsDelayMs });
                }
                else {
                    this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
                }
            }
        }
        else {
            if (this.needsExitingAnim) {
                var intervalMs = (_b = this.settings) === null || _b === void 0 ? void 0 : _b.exitAnimNotificationIntervalMs;
                if (!intervalMs || (Date.now() - this.lastNotificationMoment) >= intervalMs) {
                    this.lastNotificationMoment = Date.now();
                    this.sp.Debug.notification(",    ");
                }
            }
        }
        if (!e.isUp) {
            return;
        }
        if (!this.settings || !this.settings.animKeys) {
            return;
        }
        var animEvent = this.settings.animKeys[e.code];
        if (!animEvent) {
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Starting anims from keyboard is disabled in this version");
        // this.tryInvokeAnim(animEvent, {
        //     weaponDrawnAllowed: false,
        //     furnitureAllowed: false,
        //     exitAnimName: null,
        //     interruptAnimName: null,
        //     timeMs: 0,
        //     isPlayExitAnimAfterwardsEnabled: true,
        //     parentAnimEventName: null,
        //     enablePlayerControlsDelayMs: null,
        //     preferInterruptAnimAsExitAnimTimeMs: null,
        // });
    };
    SweetCameraEnforcementService.prototype.tryInvokeAnim = function (animEvent, options) {
        var _this = this;
        this.tryInvokeAnimCount++;
        if (this.tryInvokeAnimCount >= this.tryInvokeAnimCountMax) {
            this.tryInvokeAnimCount = 0;
        }
        var currentInvokeAnimCount = this.tryInvokeAnimCount;
        if (typeof options.exitAnimName === "string") {
            this.exitAnimName = options.exitAnimName;
        }
        else {
            this.exitAnimName = null;
        }
        if (typeof options.interruptAnimName === "string") {
            this.interruptAnimName = options.interruptAnimName;
        }
        else {
            this.interruptAnimName = null;
        }
        if (typeof options.timeMs === "number" && options.timeMs > 0 && Number.isFinite(options.timeMs)) {
            var timeSeconds = options.timeMs / 1000;
            // Using Utility.wait makes sense because it waits game time, not simply real time.
            this.sp.Utility.wait(timeSeconds).then(function () {
                if (_this.tryInvokeAnimCount !== currentInvokeAnimCount) {
                    return;
                }
                if (!_this.needsExitingAnim) {
                    return;
                }
                var isPlayExitAnimAfterwardsEnabled = typeof options.isPlayExitAnimAfterwardsEnabled === "boolean" ? options.isPlayExitAnimAfterwardsEnabled : true;
                _this.exitAnim({ playExitAnim: isPlayExitAnimAfterwardsEnabled, enablePlayerControlsDelayMs: options.enablePlayerControlsDelayMs });
            });
        }
        var player = this.sp.Game.getPlayer();
        if (!player) {
            return { success: false, reason: "player_not_found" };
        }
        if (player.isWeaponDrawn() && !options.weaponDrawnAllowed) {
            return { success: false, reason: "weapon_drawn" };
        }
        if (player.getAnimationVariableBool("bInJumpState")) {
            return { success: false, reason: "jump_state" };
        }
        if (this.sp.Ui.isMenuOpen("FavoritesMenu" /* Menu.Favorites */)) {
            return { success: false, reason: "favorites_menu_open" };
        }
        if (this.sp.Ui.isMenuOpen("Console" /* Menu.Console */)) {
            return { success: false, reason: "console_menu_open" };
        }
        if (this.stopAnimInProgress) {
            return { success: false, reason: "busy_stopping_anim" };
        }
        if (player.getFurnitureReference() && !options.furnitureAllowed) {
            return { success: false, reason: "player_in_furniture" };
        }
        if (player.isSneaking()) {
            return { success: false, reason: "player_sneaking" };
        }
        if (player.isSwimming()) {
            return { success: false, reason: "player_swimming" };
        }
        if (animEvent.toLowerCase() === "idleforcedefaultstate") {
            if (this.needsExitingAnim) {
                this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
            }
        }
        else {
            var doInvoke = function () {
                _this.sp.Game.forceThirdPerson();
                _this.sp.Game.disablePlayerControls(true, false, true, false, false, false, false, false, 0);
                _this.sp.Debug.sendAnimationEvent(_this.sp.Game.getPlayer(), animEvent);
                var preferInterruptAnimState = null;
                if (typeof options.preferInterruptAnimAsExitAnimTimeMs === "number"
                    && options.preferInterruptAnimAsExitAnimTimeMs > 0
                    && Number.isFinite(options.preferInterruptAnimAsExitAnimTimeMs)) {
                    var state_1 = { prefer: true };
                    (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Prefer interrupt anim as exit anim for ".concat(options.preferInterruptAnimAsExitAnimTimeMs, " ms"));
                    _this.sp.Utility.wait(options.preferInterruptAnimAsExitAnimTimeMs / 1000).then(function () {
                        state_1.prefer = false;
                        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Prefer interrupt anim as exit anim state changed to false");
                    });
                    preferInterruptAnimState = state_1;
                }
                _this.currentAnim = { name: animEvent, options: options, preferInterruptAnimState: preferInterruptAnimState };
                _this.startAntiExploitPolling("no_death");
            };
            if (typeof options.parentAnimEventName === "string" && this.currentAnimName === options.parentAnimEventName) {
                doInvoke();
            }
            else if (Array.isArray(options.parentAnimEventName) && options.parentAnimEventName.includes(this.currentAnimName)) {
                doInvoke();
            }
            else if (this.needsExitingAnim) {
                // TODO (1): consider not using enablePlayerControlsDelayMs here, because useInterruptAnimAsExitAnim doesn't need it
                this.optionCb = doInvoke;
                this.exitAnim({ playExitAnim: true, useInterruptAnimAsExitAnim: true, enablePlayerControlsDelayMs: options.enablePlayerControlsDelayMs });
            }
            else {
                doInvoke();
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Sent animation event: ".concat(animEvent));
        }
        return { success: true };
    };
    SweetCameraEnforcementService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    Object.defineProperty(SweetCameraEnforcementService.prototype, "needsExitingAnim", {
        get: function () {
            return this.currentAnimName !== null;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(SweetCameraEnforcementService.prototype, "currentAnimName", {
        get: function () {
            return this.currentAnim ? this.currentAnim.name : null;
        },
        enumerable: false,
        configurable: true
    });
    return SweetCameraEnforcementService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyDynamicPerksService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetTaffyDynamicPerksService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyDynamicPerksService: () => (/* binding */ SweetTaffyDynamicPerksService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SweetTaffyDynamicPerksService = /** @class */ (function (_super) {
    __extends(SweetTaffyDynamicPerksService, _super);
    function SweetTaffyDynamicPerksService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.requestAddPerksToActors = function (actorIds, perkIds) {
            _this.controller.once("update", function () {
                var actors = actorIds.map(function (actorId) { return _this.sp.Actor.from(_this.sp.Game.getFormEx(actorId)); }).filter(function (actor) { return actor !== null; });
                var perks = perkIds.map(function (perkId) { return _this.sp.Perk.from(_this.sp.Game.getFormEx(perkId)); }).filter(function (perk) { return perk !== null; });
                actors.forEach(function (actor) { return perks.forEach(function (perk) { return actor === null || actor === void 0 ? void 0 : actor.addPerk(perk); }); });
            });
        };
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features enabled");
        }
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        controller.emitter.on("setInventoryMessage", function (e) { return _this.onSetInventoryMessage(e); });
        controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        return _this;
    }
    SweetTaffyDynamicPerksService.prototype.onContainerChanged = function (e) {
        if (!this.hasSweetPie()) {
            return;
        }
        if (e.oldContainer && e.newContainer) {
            if (e.newContainer.getFormID() === 0x14 && e.numItems > 0) {
                this.handlePlayerInventoryChanged({
                    baseId: e.baseObj.getFormID(),
                    count: e.numItems,
                });
            }
        }
    };
    SweetTaffyDynamicPerksService.prototype.onSetInventoryMessage = function (e) {
        var _this = this;
        if (!this.hasSweetPie()) {
            return;
        }
        var entries = e.message.inventory.entries;
        if (entries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received SetInventoryMessage with empty inventory");
            return;
        }
        this.controller.once("update", function () {
            entries.forEach(function (entry) { return _this.handlePlayerInventoryChanged(entry); });
        });
    };
    SweetTaffyDynamicPerksService.prototype.onCreateActorMessage = function (e) {
        var _this = this;
        var _a, _b;
        if (!this.hasSweetPie()) {
            return;
        }
        if (!e.message.isMe) {
            return;
        }
        var entries = (_b = (_a = e.message.props) === null || _a === void 0 ? void 0 : _a.inventory) === null || _b === void 0 ? void 0 : _b.entries;
        if (entries === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received CreateActorMessage without inventory");
            return;
        }
        if (entries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received CreateActorMessage with empty inventory");
            return;
        }
        this.controller.once("update", function () {
            entries.forEach(function (entry) { return _this.handlePlayerInventoryChanged(entry); });
        });
    };
    SweetTaffyDynamicPerksService.prototype.handlePlayerInventoryChanged = function (entry) {
        if (!this.hasSweetPie()) {
            return;
        }
        var item = this.sp.Game.getFormEx(entry.baseId);
        if (!item) {
            return;
        }
        if (entry.count <= 0) {
            return;
        }
        var perkIds = this.getPerkIdsByKeyword(item);
        if (perkIds) {
            var playerId = 0x14;
            this.requestAddPerksToActors([playerId], perkIds);
        }
    };
    SweetTaffyDynamicPerksService.prototype.getPerkIdsByKeyword = function (item) {
        var _this = this;
        var result = new Array();
        this.getKeywordPerkMap().forEach(function (v, k) {
            var keyWord = _this.sp.Keyword.getKeyword(k);
            if (item.hasKeyword(keyWord)) {
                result.push(v);
            }
        });
        return result.length > 0 ? result : null;
    };
    // TODO: move this to config
    SweetTaffyDynamicPerksService.prototype.getKeywordPerkMap = function () {
        return new Map([
            // 
            ["SweetPerkBow1", 0x1036F0],
            ["SweetPerkBow2", 0x58F61],
            ["SweetPerkBow3", 0x105F19],
            ["SweetPerkBow4", 0x58F63],
            // 
            ["SweetPerkSneak1", 0x58210],
            ["SweetPerkSneak2", 0x105F23],
            ["SweetPerkSneak3", 0x58208],
            ["SweetPerkSneak4", 0x58211],
            // 
            ["SweetPerkArmorLight1", 0x105F22],
            ["SweetPerkArmorLight2", 0x51B1C],
            // 
            ["SweetPerkEnchant2", 0x108A44],
            ["SweetPerkEnchant1", 0x58F7C],
            // 
            ["SweetPerkArmorHeavy1", 0xBCD2B],
            ["SweetPerkArmorHeavy2", 0x58F6D],
            // 
            ["SweetPerkBlock1", 0x58F67],
            ["SweetPerkBlock2", 0x106253],
            ["SweetPerkBlock3", 0x58F6A],
            ["SweetPerkBlock4", 0x58F69],
            // , , , , , ,  ( )
            ["SweetPerk1Hand2Hand1", 0x58F6F],
            ["SweetPerk2Hand2", 0xCB407],
            ["SweetPerk2Hand3", 0x96590],
            ["SweetPerk2Hand4", 0x52D51],
            // , , , , , , ,  ( )
            ["SweetPerk1Hand2Hand1", 0x58F6F],
            ["SweetPerk1Hand2", 0xCB406],
            ["SweetPerk1Hand3", 0x106256],
            ["SweetPerk1Hand4", 0x52D50],
        ]);
    };
    SweetTaffyDynamicPerksService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyDynamicPerksService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyNicknamesService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/sweetTaffyNicknamesService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyNicknamesService: () => (/* binding */ SweetTaffyNicknamesService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var SweetTaffyNicknamesService = /** @class */ (function (_super) {
    __extends(SweetTaffyNicknamesService, _super);
    function SweetTaffyNicknamesService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.emitter.on("nicknameCreate", function (e) { return _this.onNicknameCreate(e); });
        controller.emitter.on("nicknameDestroy", function (e) { return _this.onNicknameDestroy(e); });
        return _this;
    }
    SweetTaffyNicknamesService.prototype.onNicknameCreate = function (e) {
        var _a;
        var storageNickname = typeof this.sp.storage["idTextNickname"] === 'object'
            ? this.sp.storage["idTextNickname"]
            : null;
        if (storageNickname === null && e.remoteRefrId) {
            this.sp.storage["idTextNickname"] = (_a = {}, _a[e.remoteRefrId] = e.textId, _a);
        }
        else if (storageNickname !== null && e.remoteRefrId) {
            storageNickname[e.remoteRefrId] = e.textId;
            this.sp.storage["idTextNickname"] = storageNickname;
        }
    };
    SweetTaffyNicknamesService.prototype.onNicknameDestroy = function (e) {
        var storageNickname = typeof this.sp.storage["idTextNickname"] === 'object'
            ? this.sp.storage["idTextNickname"]
            : null;
        if (storageNickname !== null && e.remoteRefrId) {
            delete storageNickname[e.remoteRefrId];
            this.sp.storage["idTextNickname"] = storageNickname;
        }
    };
    return SweetTaffyNicknamesService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/sweetTaffyPlayerCombatService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetTaffyPlayerCombatService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyPlayerCombatService: () => (/* binding */ SweetTaffyPlayerCombatService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: move to service
var playerLastStaminaValue = 0;
var playerLastIsSprintingValue = false;
var blockPlayerControlTimeStamp = 0;
var isPlayerControlDisabled = true;
var playerAttackTimeout = 0;
var activeTimers = new Set();
// TODO: move to config
var staminaAttackMap = new Map([
    ["Std", 7],
    ["Power", 35],
    ["Jump", 15],
    ["Bow", 25],
    ["Crossbow", 30],
]);
// TODO: consider splitting this service (separate stamina and timer management)
// TODO: subscribe events/hooks in constructor
var SweetTaffyPlayerCombatService = /** @class */ (function (_super) {
    __extends(SweetTaffyPlayerCombatService, _super);
    function SweetTaffyPlayerCombatService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SweetTaffyPlayerCombatService.prototype.onceUpdate = function () {
        this.setAttackStaminaRestriction();
        this.registerHandlersIfNeeded();
    };
    SweetTaffyPlayerCombatService.prototype.setAttackStaminaRestriction = function () {
        var _this = this;
        if (!this.hasSweetPie()) {
            return;
        }
        this.controller.on("update", function () {
            var player = _this.sp.Game.getPlayer();
            playerLastStaminaValue = player.getActorValue("Stamina");
            playerLastIsSprintingValue = player.isSprinting();
        });
        for (var _i = 0, _a = ['SprintStart']; _i < _a.length; _i++) {
            var pattern = _a[_i];
            var sp = this.sp;
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    if (playerLastStaminaValue < 7.5) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _b = 0, _c = ['blockStart']; _b < _c.length; _b++) {
            var pattern = _c[_b];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    if (playerLastIsSprintingValue) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _d = 0, _e = ['attackStart*', 'AttackStart*']; _d < _e.length; _d++) {
            var pattern = _e[_d];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Std")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _f = 0, _g = ['attackPowerStart*', 'AttackPowerStart*']; _f < _g.length; _f++) {
            var pattern = _g[_f];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Power")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _h = 0, _j = ['JumpDirectionalStart*', 'JumpStandingStart*']; _h < _j.length; _h++) {
            var pattern = _j[_h];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Jump")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _k = 0, _l = ['bowAttackStart*']; _k < _l.length; _k++) {
            var pattern = _l[_k];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Bow")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _m = 0, _o = ['crossbowAttackStart*']; _m < _o.length; _m++) {
            var pattern = _o[_m];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Crossbow")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
    };
    SweetTaffyPlayerCombatService.prototype.registerHandlersIfNeeded = function () {
        var _this = this;
        var self = this;
        if (!this.hasSweetPie()) {
            return;
        }
        for (var _i = 0, _a = ['attackStart*', 'AttackStart*']; _i < _a.length; _i++) {
            var pattern = _a[_i];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function () { }),
                leave: (function (ctx) { return self.blockPlayerAttack(ctx.animEventName.toLowerCase().includes('lefthand')); }),
            }, 0x14, 0x14, pattern);
        }
        for (var _b = 0, _c = ['attackPowerStart*', 'AttackPowerStart*', 'Jump*']; _b < _c.length; _b++) {
            var pattern = _c[_b];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function () { }),
                leave: (function () {
                    playerAttackTimeout = 0;
                    activeTimers.clear();
                }),
            }, 0x14, 0x14, pattern);
        }
        this.controller.on("update", function () {
            if (isPlayerControlDisabled === true && Date.now() - blockPlayerControlTimeStamp >= playerAttackTimeout) {
                _this.sp.Game.getPlayer().setDontMove(false);
                isPlayerControlDisabled = false;
            }
        });
    };
    SweetTaffyPlayerCombatService.prototype.blockPlayerAttack = function (isLeftHand) {
        var _this = this;
        this.controller.once("update", function () {
            var _a;
            var player = _this.sp.Game.getPlayer();
            if (player.getAnimationVariableBool("bInJumpState")) {
                return;
            }
            var _b = _this.getTimings((_a = player.getEquippedWeapon(isLeftHand)) === null || _a === void 0 ? void 0 : _a.getWeaponType()), delay = _b[0], timeout = _b[1];
            var rnd = Math.random().toString();
            activeTimers.add(rnd);
            _this.sp.Utility.wait(delay / 1000).then(function () {
                if (!activeTimers.delete(rnd)) {
                    return;
                }
                _this.controller.once("update", function () {
                    isPlayerControlDisabled = true;
                    blockPlayerControlTimeStamp = Date.now();
                    _this.sp.Game.getPlayer().setDontMove(true);
                    playerAttackTimeout = timeout;
                });
            });
        });
    };
    SweetTaffyPlayerCombatService.prototype.getAndValidateTimingsConfigKey = function (key, weaponTimings) {
        var value = weaponTimings[key];
        if (value && Array.isArray(value) && value.length === 2) {
            var element0 = value[0];
            if (typeof element0 !== "number") {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "Invalid timings config for weapon type", key, value);
                return [0, 0];
            }
            var element1 = value[1];
            if (typeof element1 !== "number") {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "Invalid timings config for weapon type", key, value);
                return [0, 0];
            }
            return [element0, element1];
        }
        return [0, 0];
    };
    ;
    SweetTaffyPlayerCombatService.prototype.getSettingsFromFile = function () {
        var sweetTaffyPlayerCombatService = this.sp.settings["skymp5-client"]["sweetTaffyPlayerCombatService"];
        if (!sweetTaffyPlayerCombatService || typeof sweetTaffyPlayerCombatService !== "object") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No sweetTaffyPlayerCombatService settings found");
            return null;
        }
        var weaponTimings = sweetTaffyPlayerCombatService.weaponTimings;
        if (!weaponTimings || typeof weaponTimings !== "object") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No weaponTimings settings found");
            return null;
        }
        return weaponTimings;
    };
    SweetTaffyPlayerCombatService.prototype.getSettingsDefault = function () {
        return {
            fist: [0, 30],
            sword: [0, 30],
            dagger: [0, 60],
            warAxe: [0, 60],
            mace: [0, 65],
            greatsword: [0, 65],
            // Note: both of Battleaxe and Warhammer weapon types correspond to id=6.
            battleaxe: [0, 70],
            warhammer: [0, 70],
            bow: [0, 70],
            staff: [0, 70],
            crossbow: [0, 70],
        };
    };
    SweetTaffyPlayerCombatService.prototype.getTimingsFromConfig = function (weapon) {
        if (!weapon) {
            weapon = 0 /* WeaponType.Fist */;
        }
        // skymp5-client-settings.txt is perfectly editable by users, so we don't use it for now.
        // It's well-tested though, so we can enable it once we have a protection mechanism.
        // const weaponTimings = this.getSettingsFromFile();
        var weaponTimings = this.getSettingsDefault();
        if (!weaponTimings) {
            return null;
        }
        var weaponTimingsResult = {
            fist: [0, 0],
            sword: [0, 0],
            dagger: [0, 0],
            warAxe: [0, 0],
            mace: [0, 0],
            greatsword: [0, 0],
            battleaxe: [0, 0],
            warhammer: [0, 0],
            bow: [0, 0],
            staff: [0, 0],
            crossbow: [0, 0],
        };
        weaponTimingsResult.fist = this.getAndValidateTimingsConfigKey("fist", weaponTimings);
        weaponTimingsResult.sword = this.getAndValidateTimingsConfigKey("sword", weaponTimings);
        weaponTimingsResult.dagger = this.getAndValidateTimingsConfigKey("dagger", weaponTimings);
        weaponTimingsResult.warAxe = this.getAndValidateTimingsConfigKey("warAxe", weaponTimings);
        weaponTimingsResult.mace = this.getAndValidateTimingsConfigKey("mace", weaponTimings);
        weaponTimingsResult.greatsword = this.getAndValidateTimingsConfigKey("greatsword", weaponTimings);
        weaponTimingsResult.battleaxe = this.getAndValidateTimingsConfigKey("battleaxe", weaponTimings);
        weaponTimingsResult.warhammer = this.getAndValidateTimingsConfigKey("warhammer", weaponTimings);
        weaponTimingsResult.bow = this.getAndValidateTimingsConfigKey("bow", weaponTimings);
        weaponTimingsResult.staff = this.getAndValidateTimingsConfigKey("staff", weaponTimings);
        weaponTimingsResult.crossbow = this.getAndValidateTimingsConfigKey("crossbow", weaponTimings);
        switch (weapon) {
            case 0 /* WeaponType.Fist */:
                return weaponTimingsResult.fist;
            case 1 /* WeaponType.Sword */:
                return weaponTimingsResult.sword;
            case 2 /* WeaponType.Dagger */:
                return weaponTimingsResult.dagger;
            case 3 /* WeaponType.WarAxe */:
                return weaponTimingsResult.warAxe;
            case 4 /* WeaponType.Mace */:
                return weaponTimingsResult.mace;
            case 5 /* WeaponType.Greatsword */:
                return weaponTimingsResult.greatsword;
            case 6 /* WeaponType.Battleaxe */:
                return weaponTimingsResult.battleaxe;
            case 6 /* WeaponType.Warhammer */:
                return weaponTimingsResult.warhammer;
            case 7 /* WeaponType.Bow */:
                return weaponTimingsResult.bow;
            case 8 /* WeaponType.Staff */:
                return weaponTimingsResult.staff;
            case 9 /* WeaponType.Crossbow */:
                return weaponTimingsResult.crossbow;
            default:
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No timings found for weapon type", weapon);
                return null;
        }
    };
    SweetTaffyPlayerCombatService.prototype.getTimings = function (weapon) {
        var timingsFromConfig = this.getTimingsFromConfig(weapon);
        if (!weapon || !timingsFromConfig) {
            weapon = 0 /* WeaponType.Fist */;
            timingsFromConfig = this.getTimingsFromConfig(weapon);
        }
        if (!timingsFromConfig) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No timings found for weapon type", weapon);
            return [0, 0];
        }
        return timingsFromConfig;
    };
    ;
    SweetTaffyPlayerCombatService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyPlayerCombatService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffySkillMenuService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/sweetTaffySkillMenuService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffySkillMenuService: () => (/* binding */ SweetTaffySkillMenuService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// TODO: move to server/gamemode
var SweetTaffySkillMenuService = /** @class */ (function (_super) {
    __extends(SweetTaffySkillMenuService, _super);
    function SweetTaffySkillMenuService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.altars = [
            0x00100780, 0x000D9883, 0x000D987B, 0x000D9881, 0x000D9887, 0x000FB997,
            0x000D9885, 0x000D987D, 0x00071854, 0x07187500, 0x0200c86b, 0x000d987f,
            0x07058d4e, 0x07058d53, 0x070A6912, 0x07058d51, 0x07058d50, 0x07058d4f,
            0x07058d4d, 0x07058d4c, 0x07058d4b, 0x0705e2fa, 0x07058d4a, 0x07058d49,
            0x0705e367, 0x07058d48, 0x07058d55, 0x07058d46, 0x07058d47, 0x0705e2b0,
            0x07058d45
        ];
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("activate", function (e) { return _this.onActivate(e); });
        return _this;
    }
    SweetTaffySkillMenuService.prototype.onActivate = function (event) {
        var _a;
        if (!this.hasSweetPie()) {
            return;
        }
        if (!this.altars.includes(((_a = event.target.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) || -1)) {
            return;
        }
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.browser.setFocused(true);
        var src = "window.dispatchEvent(new CustomEvent('initSkillMenu'))";
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.browser.executeJavaScript(src);
    };
    SweetTaffySkillMenuService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffySkillMenuService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyStaticPerksService.ts":
/*!***************************************************************!*\
  !*** ./src/services/services/sweetTaffyStaticPerksService.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyStaticPerksService: () => (/* binding */ SweetTaffyStaticPerksService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SweetTaffyStaticPerksService = /** @class */ (function (_super) {
    __extends(SweetTaffyStaticPerksService, _super);
    function SweetTaffyStaticPerksService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        // TODO: move this to config
        _this.stealth = [0xBE126, 0xC07C6, 0xC07C7, 0xC07C8, 0xC07C9];
        _this.magic = [0x58213, 0x105F24, 0x58214];
        _this.warrior = [0xCB40D, 0xCB40F, 0xCB414, 0xCB411, 0xCB412, 0xCB410, 0xCB40E];
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SweetTaffyStaticPerksService.prototype.onceUpdate = function () {
        if (!this.hasSweetPie()) {
            return;
        }
        this.addStaticPerksToThePlayer();
    };
    SweetTaffyStaticPerksService.prototype.addStaticPerksToThePlayer = function () {
        var _this = this;
        var player = this.sp.Game.getPlayer();
        var allStaticPerkIds = this.stealth.concat(this.magic).concat(this.warrior);
        allStaticPerkIds.forEach(function (perkId) {
            player.addPerk(_this.sp.Perk.from(_this.sp.Game.getFormEx(perkId)));
        });
    };
    SweetTaffyStaticPerksService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyStaticPerksService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffySweetCantDropService.ts":
/*!*****************************************************************!*\
  !*** ./src/services/services/sweetTaffySweetCantDropService.ts ***!
  \*****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffySweetCantDropService: () => (/* binding */ SweetTaffySweetCantDropService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

// TODO: move to the server/gamemode
var SweetTaffySweetCantDropService = /** @class */ (function (_super) {
    __extends(SweetTaffySweetCantDropService, _super);
    function SweetTaffySweetCantDropService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.cantDropKeyword = "SweetCantDrop";
        return _this;
    }
    SweetTaffySweetCantDropService.prototype.canDropOrPutItem = function (itemId) {
        var item = this.sp.Game.getFormEx(itemId);
        if (item !== null) {
            if (item.hasKeyword(this.sp.Keyword.getKeyword(this.cantDropKeyword))) {
                return false;
            }
        }
        return true;
    };
    return SweetTaffySweetCantDropService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/timeService.ts":
/*!**********************************************!*\
  !*** ./src/services/services/timeService.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   TimeService: () => (/* binding */ TimeService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var TimeService = /** @class */ (function (_super) {
    __extends(TimeService, _super);
    function TimeService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastTimeUpd = 0;
        controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    TimeService.prototype.getTime = function () {
        var hoursOffsetSetting = this.sp.settings["skymp5-client"]["hoursOffset"];
        var hoursOffset = typeof hoursOffsetSetting === "number" ? hoursOffsetSetting : 0;
        var hoursOffsetMs = hoursOffset * 60 * 60 * 1000;
        var d = new Date(Date.now() + hoursOffsetMs);
        var newGameHourValue = 0;
        newGameHourValue += d.getUTCHours();
        newGameHourValue += d.getUTCMinutes() / 60;
        newGameHourValue += d.getUTCSeconds() / 60 / 60;
        newGameHourValue += d.getUTCMilliseconds() / 60 / 60 / 1000;
        return { newGameHourValue: newGameHourValue, date: d };
    };
    TimeService.prototype.every2seconds = function () {
        var gameHourId = 0x38;
        var gameMonthId = 0x36;
        var gameDayId = 0x37;
        var gameYearId = 0x35;
        var timeScaleId = 0x3a;
        var gameHour = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameHourId));
        var gameDay = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameDayId));
        var gameMonth = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameMonthId));
        var gameYear = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameYearId));
        var timeScale = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(timeScaleId));
        if (!gameHour || !gameDay || !gameMonth || !gameYear || !timeScale) {
            return;
        }
        var _a = this.getTime(), newGameHourValue = _a.newGameHourValue, date = _a.date;
        var diff = Math.abs(gameHour.getValue() - newGameHourValue);
        if (diff >= 1 / 60) {
            gameHour.setValue(newGameHourValue);
            gameDay.setValue(date.getUTCDate());
            gameMonth.setValue(date.getUTCMonth());
            gameYear.setValue(date.getUTCFullYear() - 2020 + 199);
        }
        timeScale.setValue(gameHour.getValue() > newGameHourValue ? 0.6 : 1.2);
    };
    TimeService.prototype.onUpdate = function () {
        if (Date.now() - this.lastTimeUpd <= 2000) {
            return;
        }
        this.lastTimeUpd = Date.now();
        this.every2seconds();
    };
    return TimeService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/timersService.ts":
/*!************************************************!*\
  !*** ./src/services/services/timersService.ts ***!
  \************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   TimersService: () => (/* binding */ TimersService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var ProcessMethodType;
(function (ProcessMethodType) {
    ProcessMethodType["update"] = "update";
    ProcessMethodType["tick"] = "tick";
})(ProcessMethodType || (ProcessMethodType = {}));
var TimersService = /** @class */ (function (_super) {
    __extends(TimersService, _super);
    function TimersService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.timersArr = new Array();
        _this.intervalsArr = new Array();
        _this.lastCallTime = Date.now();
        _this.processMethodTypeStorageKey = "updateTypeStorageKey";
        var storageProcessMethod = sp.storage[_this.processMethodTypeStorageKey];
        if (typeof storageProcessMethod !== "function") {
            _this.setProcessMethod(storageProcessMethod);
        }
        else {
            _this.setProcessMethod(ProcessMethodType.tick);
        }
        _this.controller.on("menuOpen", function (e) { return _this.onMenuOpen(e); });
        _this.controller.on("preLoadGame", function () { return _this.onPreLoadGame(); });
        return _this;
    }
    TimersService.prototype.setTimeout = function (handler, timeout) {
        var args = [];
        for (var _i = 2; _i < arguments.length; _i++) {
            args[_i - 2] = arguments[_i];
        }
        var timer = { handler: handler, args: args, delayMs: timeout !== null && timeout !== void 0 ? timeout : 0, passedMs: 0 };
        for (var i = 0; i < this.timersArr.length; ++i) {
            if (!this.timersArr[i]) {
                this.timersArr[i] = timer;
                return i + 1;
            }
        }
        return this.timersArr.push(timer);
    };
    TimersService.prototype.clearTimeout = function (id) {
        if (id === undefined) {
            this.timersArr = new Array();
            return;
        }
        if (id <= 0 || id > this.timersArr.length) {
            return;
        }
        this.timersArr[id - 1] = null;
        return;
    };
    TimersService.prototype.setInterval = function (handler, timeout) {
        var args = [];
        for (var _i = 2; _i < arguments.length; _i++) {
            args[_i - 2] = arguments[_i];
        }
        var timer = { handler: handler, args: args, delayMs: timeout !== null && timeout !== void 0 ? timeout : 0, passedMs: 0 };
        for (var i = 0; i < this.intervalsArr.length; ++i) {
            if (!this.intervalsArr[i]) {
                this.intervalsArr[i] = timer;
                return i + 1;
            }
        }
        return this.intervalsArr.push(timer);
    };
    TimersService.prototype.clearInterval = function (id) {
        if (id === undefined) {
            this.intervalsArr = new Array();
            return;
        }
        if (id <= 0 || id > this.intervalsArr.length) {
            return;
        }
        this.intervalsArr[id - 1] = null;
        return;
    };
    TimersService.prototype.setProcessMethod = function (method) {
        var _this = this;
        switch (method) {
            case ProcessMethodType.tick:
                this.sp.storage[this.processMethodTypeStorageKey] = ProcessMethodType.tick;
                this.updateEventHandle = this.controller.on(ProcessMethodType.tick, function () { return _this.processTimers(); });
                return;
            case ProcessMethodType.update:
                this.sp.storage[this.processMethodTypeStorageKey] = ProcessMethodType.update;
                this.updateEventHandle = this.controller.on(ProcessMethodType.update, function () { return _this.processTimers(); });
                return;
            default:
                break;
        }
        try {
            if (this.sp.Game.getPlayer()) {
                // FIXME(GM-1008)
            }
            this.setProcessMethod(ProcessMethodType.update);
        }
        catch (_a) {
            this.setProcessMethod(ProcessMethodType.tick);
        }
    };
    TimersService.prototype.processTimers = function () {
        var dt = Date.now() - this.lastCallTime;
        this.lastCallTime = Date.now();
        // process timers
        for (var i = 0; i < this.timersArr.length; ++i) {
            var timer = this.timersArr[i];
            if (timer) {
                timer.passedMs += dt;
                if (timer.passedMs >= timer.delayMs) {
                    this.timersArr[i] = null;
                    if (typeof timer.handler === "function") {
                        timer.handler.call(this, timer.args);
                    }
                    else {
                        eval(timer.handler);
                    }
                }
            }
            else if (i === this.timersArr.length - 1) {
                // remove last unused element
                this.timersArr.length -= 1;
            }
        }
        // process intervals
        for (var i = 0; i < this.intervalsArr.length; ++i) {
            var interval = this.intervalsArr[i];
            if (interval) {
                interval.passedMs += dt;
                if (interval.passedMs >= interval.delayMs) {
                    interval.passedMs = 0;
                    if (typeof interval.handler === "function") {
                        interval.handler.call(this, interval.args);
                    }
                    else {
                        eval(interval.handler);
                    }
                }
            }
            else if (i === this.intervalsArr.length - 1) {
                // remove last unused element
                this.intervalsArr.length -= 1;
            }
        }
    };
    TimersService.prototype.onMenuOpen = function (e) {
        if (e.name === "Main Menu" /* Menu.Main */) {
            if (this.updateEventHandle) {
                this.sp.unsubscribe(this.updateEventHandle);
            }
            this.setProcessMethod(ProcessMethodType.tick);
        }
    };
    TimersService.prototype.onPreLoadGame = function () {
        if (this.updateEventHandle) {
            this.sp.unsubscribe(this.updateEventHandle);
        }
        this.setProcessMethod(ProcessMethodType.update);
    };
    return TimersService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/voiceChatService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/voiceChatService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   VoiceChatService: () => (/* binding */ VoiceChatService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var VoiceChatService = /** @class */ (function (_super) {
    __extends(VoiceChatService, _super);
    function VoiceChatService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.isInitialized = false;
        _this.isTalking = false;
        _this.pushToTalkKey = 0x56; // V key
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    VoiceChatService.prototype.onConnect = function () {
        // Voice chat initialization handled elsewhere for now
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Connected");
    };
    VoiceChatService.prototype.onDisconnect = function () {
        if (this.isTalking) {
            this.stopTalking();
        }
        this.isInitialized = false;
    };
    VoiceChatService.prototype.onTick = function () {
        if (!this.isInitialized) {
            return;
        }
        // Check push-to-talk key state
        var keyPressed = this.sp.Input.isKeyPressed(this.pushToTalkKey);
        if (keyPressed && !this.isTalking) {
            this.startTalking();
        }
        else if (!keyPressed && this.isTalking) {
            this.stopTalking();
        }
    };
    VoiceChatService.prototype.onUpdate = function () {
        // Handle continuous voice chat updates if needed
    };
    VoiceChatService.prototype.startTalking = function () {
        try {
            this.isTalking = true;
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Started talking");
            // Actual voice capture handled by underlying system
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to start talking: ".concat(error));
        }
    };
    VoiceChatService.prototype.stopTalking = function () {
        try {
            this.isTalking = false;
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Stopped talking");
            // Actual voice capture stopping handled by underlying system
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to stop talking: ".concat(error));
        }
    };
    // Handle incoming voice chat data from other players
    VoiceChatService.prototype.onReceiveVoiceData = function (speakerId, audioData, x, y, z) {
        if (!this.isInitialized) {
            return;
        }
        try {
            // Voice playback handled by underlying system
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Received voice data from ".concat(speakerId, " at (").concat(x, ", ").concat(y, ", ").concat(z, ")"));
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to process voice data: ".concat(error));
        }
    };
    // Handle binary voice packets received from the server
    VoiceChatService.prototype.onPacket = function (type, rawContent, error) {
        if (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Packet error: ".concat(error));
            return;
        }
        if (!rawContent || rawContent.byteLength === 0) {
            return;
        }
        // Check if this is a binary voice packet
        var data = new Uint8Array(rawContent);
        if (data[0] === 135) { // BinaryVoicePacketId
            if (rawContent.byteLength >= 9) {
                // Extract speaker ID (4 bytes)
                var speakerIdBytes = data.slice(1, 5);
                var speakerId_1 = new DataView(speakerIdBytes.buffer).getUint32(0, true);
                // Extract data size (4 bytes)
                var dataSizeBytes = data.slice(5, 9);
                var dataSize = new DataView(dataSizeBytes.buffer).getUint32(0, true);
                if (rawContent.byteLength === 9 + dataSize) {
                    // Extract audio data
                    var audioData = data.slice(9);
                    // Get speaker position from world model
                    var remoteServer = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_2__.RemoteServer);
                    var worldModel = remoteServer.getWorldModel();
                    var x = 0, y = 0, z = 0;
                    // Find the speaker in the world model to get position
                    var speakerForm = worldModel.forms.find(function (f) { return f && f.refrId === speakerId_1; });
                    if (speakerForm && speakerForm.movement) {
                        x = speakerForm.movement.pos[0];
                        y = speakerForm.movement.pos[1];
                        z = speakerForm.movement.pos[2];
                    }
                    this.onReceiveVoiceData(speakerId_1, audioData.buffer, x, y, z);
                }
            }
        }
    };
    // Get current push-to-talk key
    VoiceChatService.prototype.getPushToTalkKey = function () {
        return this.pushToTalkKey;
    };
    // Set push-to-talk key
    VoiceChatService.prototype.setPushToTalkKey = function (key) {
        if (this.isTalking) {
            this.stopTalking();
        }
        this.pushToTalkKey = key;
    };
    // Check if currently talking
    VoiceChatService.prototype.getIsTalking = function () {
        return this.isTalking;
    };
    // Check if voice chat is initialized
    VoiceChatService.prototype.getIsInitialized = function () {
        return this.isInitialized;
    };
    return VoiceChatService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/worldCleanerService.ts":
/*!******************************************************!*\
  !*** ./src/services/services/worldCleanerService.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WorldCleanerService: () => (/* binding */ WorldCleanerService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var WorldCleanerService = /** @class */ (function (_super) {
    __extends(WorldCleanerService, _super);
    function WorldCleanerService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.protection = new Map();
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.emitter.on("gameLoad", function () { return _this.onGameLoad(); });
        return _this;
    }
    WorldCleanerService.prototype.modWcProtection = function (actorId, mod) {
        var currentProtection = this.protection.get(actorId);
        this.protection.set(actorId, currentProtection ? currentProtection + mod : mod);
    };
    WorldCleanerService.prototype.getWcProtection = function (actorId) {
        return this.protection.get(actorId) || 0;
    };
    WorldCleanerService.prototype.onGameLoad = function () {
        var player = this.sp.Game.getPlayer();
        if (!player) {
            return;
        }
        this.initialPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(player);
        this.initialCellOrWorld = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(player);
    };
    WorldCleanerService.prototype.onUpdate = function () {
        this.processOneActor();
    };
    WorldCleanerService.prototype.processOneActor = function () {
        var _this = this;
        var _a;
        var pc = this.sp.Game.getPlayer();
        if (pc === null) {
            return;
        }
        var actor = this.sp.Game.findRandomActor(pc.getPositionX(), pc.getPositionY(), pc.getPositionZ(), 8192);
        if (actor === null) {
            return;
        }
        var actorId = actor.getFormID();
        var currentProtection = this.protection.get(actorId) || 0;
        if (currentProtection > 0) {
            return;
        }
        if (actorId === 0x14 || actor.isDisabled() || actor.isDeleted()) {
            return;
        }
        if (this.isActorInDialogue(actor)) {
            // Deleting actor in dialogue crashes Skyrim
            // https://github.com/skyrim-multiplayer/issue-tracker/issues/13
            actor.setPosition(0, 0, 0);
            actor.disableNoWait(true); // Seems to not crash
            return;
        }
        // Keep vanila pre-placed bodies, but delete player bodies
        if (actor.isDead() && actorId < 0xff000000) {
            actor.blockActivation(true);
            return;
        }
        var pos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(actor);
        var cellOrWorld = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(actor);
        var chickenRace = 0xa919d;
        // We discovered anomaly chickens that fail to Disable if we load game near to them
        // Refs: 106C22, 106C23
        if (actorId < 0xff000000 && ((_a = actor.getRace()) === null || _a === void 0 ? void 0 : _a.getFormID()) === chickenRace) {
            if (this.initialPos && _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getDistanceNoZ(pos, this.initialPos) < 4096) {
                if (cellOrWorld === this.initialCellOrWorld) {
                    if (this.isActorInDialogue(actor)) {
                        return;
                    }
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Deleting chicken anomaly", actorId.toString(16));
                    actor.killSilent(null);
                    actor.blockActivation(true);
                    actor.disableNoWait(false);
                    actor.setAlpha(0, false);
                    return;
                }
            }
        }
        actor.disable(false).then(function () {
            var ac = _this.sp.Actor.from(_this.sp.Game.getFormEx(actorId));
            if (!ac || _this.isActorInDialogue(ac)) {
                return;
            }
            ac.delete();
        });
    };
    WorldCleanerService.prototype.isActorInDialogue = function (ac) {
        return ac.isInDialogueWithPlayer() || ac.getDialogueTarget() !== null;
    };
    return WorldCleanerService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/spApiInteractor.ts":
/*!*****************************************!*\
  !*** ./src/services/spApiInteractor.ts ***!
  \*****************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpApiInteractor: () => (/* binding */ SpApiInteractor)
/* harmony export */ });
/* harmony import */ var _events_events__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./events/events */ "./src/services/events/events.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);


var SpApiInteractor = /** @class */ (function () {
    function SpApiInteractor() {
    }
    SpApiInteractor.setup = function (listeners) {
        listeners.forEach(function (listener) { return SpApiInteractor.registerListenerForLookup(listener.constructor, listener); });
    };
    SpApiInteractor.getControllerInstance = function () {
        if (SpApiInteractor.controller) {
            return SpApiInteractor.controller;
        }
        SpApiInteractor.controller = {
            // TODO: handle errors in event handlers. will output to game console by default
            on: skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.on,
            once: skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.once,
            emitter: _events_events__WEBPACK_IMPORTED_MODULE_0__.EventEmitterFactory.makeEventEmitter(),
            lookupListener: function (constructor) {
                var listener = SpApiInteractor.listenersForLookupByName.get(constructor);
                if (listener === undefined) {
                    throw new Error("listener not found for name '".concat(constructor.name, "'"));
                }
                if (!(listener instanceof constructor)) {
                    throw new Error("listener class mismatch for name '".concat(constructor.name, "'"));
                }
                return listener;
            },
        };
        return SpApiInteractor.controller;
    };
    SpApiInteractor.registerListenerForLookup = function (constructor, listener) {
        if (SpApiInteractor.listenersForLookupByName.has(constructor)) {
            throw new Error("listener re-registration for name '".concat(constructor, "'"));
        }
        SpApiInteractor.listenersForLookupByName.set(constructor, listener);
    };
    SpApiInteractor.listenersForLookupByName = new Map();
    return SpApiInteractor;
}());



/***/ }),

/***/ "./src/sync/actorvalues.ts":
/*!*********************************!*\
  !*** ./src/sync/actorvalues.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getActorValues: () => (/* binding */ getActorValues),
/* harmony export */   getMaximumActorValue: () => (/* binding */ getMaximumActorValue),
/* harmony export */   setActorValuePercentage: () => (/* binding */ setActorValuePercentage)
/* harmony export */ });
var getActorValues = function (ac) {
    if (!ac) {
        return { health: 0, stamina: 0, magicka: 0 };
    }
    var healthPercentage = (ac.isDead()) ? 0 : ac.getActorValuePercentage("health");
    var staminaPercentage = ac.getActorValuePercentage("stamina");
    var magickaPercentage = ac.getActorValuePercentage("magicka");
    var resultActorValue = {
        health: healthPercentage,
        stamina: staminaPercentage,
        magicka: magickaPercentage,
    };
    return resultActorValue;
};
var getMaximumActorValue = function (ac, avName) {
    var currentPercentage = ac.getActorValuePercentage(avName);
    return currentPercentage === 0 ?
        ac.getBaseActorValue(avName) :
        Math.ceil(ac.getActorValue(avName) / currentPercentage);
};
var setActorValuePercentage = function (ac, avName, percentage) {
    // Actor value percentage for health may be below zero (-1.8 for example, it means u have -180% health)
    var currentPercentage = ac.getActorValuePercentage(avName);
    if (currentPercentage === percentage) {
        return;
    }
    var currentMaxValue = getMaximumActorValue(ac, avName);
    var deltaPercentage = percentage - currentPercentage;
    if (deltaPercentage > 0) {
        ac.restoreActorValue(avName, deltaPercentage * currentMaxValue);
    }
    else if (deltaPercentage < 0) {
        ac.damageActorValue(avName, deltaPercentage * currentMaxValue);
    }
};


/***/ }),

/***/ "./src/sync/animation.ts":
/*!*******************************!*\
  !*** ./src/sync/animation.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnimationEventName: () => (/* binding */ AnimationEventName),
/* harmony export */   AnimationSource: () => (/* binding */ AnimationSource),
/* harmony export */   applyAnimation: () => (/* binding */ applyAnimation),
/* harmony export */   setDefaultAnimsDisabled: () => (/* binding */ setDefaultAnimsDisabled),
/* harmony export */   setupHooks: () => (/* binding */ setupHooks)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _movementApply__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./movementApply */ "./src/sync/movementApply.ts");
/* eslint-disable @typescript-eslint/no-empty-function */


var AnimationEventName;
(function (AnimationEventName) {
    AnimationEventName["Ragdoll"] = "Ragdoll";
    AnimationEventName["GetUpBegin"] = "GetUpBegin";
})(AnimationEventName || (AnimationEventName = {}));
;
var allowedIdles = new Array();
var refsWithDefaultAnimsDisabled = new Set();
var allowedAnims = new Set();
var actorSitAnimsLowerCase = [
    'idlestoolenterplayer',
    'idlestoolenter',
    'idlestoolenterinstant',
    'idlechairrightenter',
    'idlechairleftenter',
    'idlechairfrontenter',
    'idlechairenterinstant',
    'idlejarlchairenter',
    'idlejarlchairenterinstant',
    'idlesnowelfprincechairdialogue',
    'idlesnowelfprincechairenter',
    'idlesnowelfprincechairenterinstant',
    'idlechairchildenterinstant',
    'idlechairchildfrontenter',
    'idlechairchildleftenter',
    'idlechairchildrightenter',
];
var actorGetUpAnimsLowerCase = [
    'idlestoolbackexit',
    'idlechairrightexit',
    'idlechairrightquickexit',
    'idlechairleftexit',
    'idlechairleftquickexit',
    'idlechairfrontexit',
    'idlechairfrontquickexit',
    'idlechairchildfrontexit',
    'idlechairchildleftexit',
    'idlechairchildrightexit'
];
// It's critical for values to be the correct case, not just lowercase, otherwise 'allowedIdles' check will break
// We don't want to modify the check itself, because it'll be slower
var animOverridesLowerCase = {
    'idlechairbook_onepage': 'IdleChairEnterInstant',
    'idlechairshoulderflex': 'IdleChairEnterInstant',
    'idlechairwrite': 'IdleChairEnterInstant',
    'idlechairarmscrossedvar1': 'IdleChairEnterInstant',
    'chaireatingstart_vampiremeat': 'IdleChairEnterInstant',
    'chairreadingstart': 'IdleChairEnterInstant',
    'chairvampireeatingstart': 'IdleChairEnterInstant',
    'chairdrinkingstart': 'IdleChairEnterInstant',
    'chaireatingstart': 'IdleChairEnterInstant',
    // The only triple animation we know for now. One base anim to sit, then two to eat
    'chaireatingsoupstart': 'IdleChairEnterInstant',
    'idleeatsoup': 'IdleChairEnterInstant',
    // No need to re-play the animation, use instant variant for spawning actors
    // This is not essential, but makes the sync feel more smooth. The list is not complete.
    'idlechairrightenter': 'IdleChairEnterInstant',
    'idlechairleftenter': 'IdleChairEnterInstant',
    'idlechairfrontenter': 'IdleChairEnterInstant',
    // Untested yet looks correct
    'idlesnowelfprincefireandforget': 'IdleSnowElfPrinceChairEnterInstant',
    'idletablemugenter': 'IdleTableEnterInstant',
    'idletabledrinkenter': 'IdleTableEnterInstant',
    'idletabledrinkandmugenter': 'IdleTableEnterInstant'
};
// unclassified:
// IdleChairEnterInstant
// IdleChairEnterStart
// IdleChairEnterStop
// IdleChairEnterToSit
// IdleChairExitStart
// IdleChairExitToStand
// IdleChairSitting
// IdleLeftChairEnterStart
// ChairIdle
// IdleRightChairEnterStart
// IdleLeftChairEnterStart
var isIdle = function (animEventName) {
    var animEventNameLowerCase = animEventName.toLowerCase();
    return (animEventNameLowerCase === "motiondrivenidle" ||
        (animEventNameLowerCase.startsWith("idle") &&
            animEventNameLowerCase !== "idlestop" &&
            animEventNameLowerCase !== "idleforcedefaultstate"));
};
var applyAnimation = function (refr, anim, state) {
    if (state.lastNumChanges === anim.numChanges) {
        return;
    }
    state.lastNumChanges = anim.numChanges;
    if (state.useAnimOverrides) {
        var animOverride = animOverridesLowerCase[anim.animEventName.toLowerCase()];
        if (animOverride !== undefined) {
            anim.animEventName = animOverride;
        }
    }
    var animEventNameLowerCase = anim.animEventName.toLowerCase();
    if (isIdle(anim.animEventName)) {
        allowedIdles.push([refr.getFormID(), anim.animEventName]);
    }
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (anim.animEventName === "SkympFakeEquip") {
        if (ac) {
            (0,_movementApply__WEBPACK_IMPORTED_MODULE_1__.applyWeapDrawn)(ac, true);
        }
        return;
    }
    if (anim.animEventName === "SkympFakeUnequip") {
        if (ac) {
            (0,_movementApply__WEBPACK_IMPORTED_MODULE_1__.applyWeapDrawn)(ac, false);
        }
        return;
    }
    if (anim.animEventName === "Ragdoll") {
        if (ac) {
            if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["animationFunc1Set"] === true) {
                // @ts-ignore
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["animationFunc1"](ac);
            }
            else {
                ac.pushActorAway(ac, 0);
                ac.setActorValue("Variable10", -1000);
            }
        }
        return;
    }
    if (refsWithDefaultAnimsDisabled.has(refr.getFormID())) {
        if (animEventNameLowerCase.includes("attack")) {
            allowedAnims.add(refr.getFormID() + ":" + anim.animEventName);
        }
    }
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(refr, anim.animEventName);
    if (anim.animEventName === "GetUpBegin") {
        var refrId_1 = refr.getFormID();
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId_1));
            if (ac) {
                ac.setActorValue("Variable10", 1000);
            }
        });
    }
    if (actorSitAnimsLowerCase.find(function (x) { return x === animEventNameLowerCase; }) !== undefined) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setCollision)(refr.getFormID(), false);
    }
    if (actorGetUpAnimsLowerCase.find(function (x) { return x === animEventNameLowerCase; }) !== undefined) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setCollision)(refr.getFormID(), true);
    }
};
var setDefaultAnimsDisabled = function (refrId, disabled) {
    if (disabled) {
        refsWithDefaultAnimsDisabled.add(refrId);
    }
    else {
        refsWithDefaultAnimsDisabled.delete(refrId);
    }
};
var AnimationSource = /** @class */ (function () {
    function AnimationSource(refr) {
        var _this = this;
        this.refrId = 0;
        this.numChanges = 0;
        this.animEventName = "";
        this.weapNonDrawnBlocker = 0;
        this.weapDrawnBlocker = 0;
        this.sneakBlocker = null;
        this.refrId = refr.getFormID();
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.hooks.sendAnimationEvent.add({
            enter: function () { },
            leave: function (ctx) {
                if (ctx.selfId !== _this.refrId) {
                    return;
                }
                if (!ctx.animationSucceeded) {
                    // Workaround, see carryAnimSystem.ts in gamemode
                    // Case-sensetive check here for better performance
                    if (ctx.animEventName !== "OffsetCarryBasketStart") {
                        return;
                    }
                }
                _this.onSendAnimationEvent(ctx.animEventName);
            },
        });
    }
    AnimationSource.prototype.filterMovement = function (mov) {
        if (this.weapDrawnBlocker >= Date.now()) {
            mov.isWeapDrawn = true;
        }
        if (this.weapNonDrawnBlocker >= Date.now()) {
            mov.isWeapDrawn = false;
        }
        if (this.sneakBlocker === mov.isSneaking) {
            this.sneakBlocker = null;
        }
        else if (this.sneakBlocker === true) {
            mov.isSneaking = true;
        }
        else if (this.sneakBlocker === false) {
            mov.isSneaking = false;
        }
        return mov;
    };
    AnimationSource.prototype.getAnimation = function () {
        var _a = this, numChanges = _a.numChanges, animEventName = _a.animEventName;
        return { numChanges: numChanges, animEventName: animEventName };
    };
    AnimationSource.prototype.onSendAnimationEvent = function (animEventName) {
        if (ignoredAnims.has(animEventName)) {
            return;
        }
        var lower = animEventName.toLowerCase();
        var isTorchEvent = lower.includes("torch");
        if (animEventName.toLowerCase().includes("unequip") && !isTorchEvent) {
            this.weapNonDrawnBlocker = Date.now() + 300;
            animEventName = "SkympFakeUnequip";
        }
        else if (animEventName.toLowerCase().includes("equip") && !isTorchEvent) {
            this.weapDrawnBlocker = Date.now() + 300;
            animEventName = "SkympFakeEquip";
        }
        if (animEventName === "SneakStart") {
            this.sneakBlocker = true;
            return;
        }
        if (animEventName === "SneakStop") {
            this.sneakBlocker = false;
            return;
        }
        this.numChanges++;
        this.animEventName = animEventName;
    };
    return AnimationSource;
}());

var ignoredAnims = new Set([
    "moveStart",
    "moveStop",
    "turnStop",
    "CyclicCrossBlend",
    "CyclicFreeze",
    "TurnLeft",
    "TurnRight",
]);
var setupHooks = function () {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.hooks.sendAnimationEvent.add({
        enter: function (ctx) {
            if (refsWithDefaultAnimsDisabled.has(ctx.selfId)) {
                if (ctx.animEventName.toLowerCase().includes("attack")) {
                    var animKey = ctx.selfId + ":" + ctx.animEventName;
                    if (allowedAnims.has(animKey)) {
                        allowedAnims.delete(animKey);
                    }
                    else {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("block anim " + ctx.animEventName);
                        return (ctx.animEventName = "");
                    }
                }
            }
            // ShowRaceMenu forces this anim
            if (ctx.animEventName === "OffsetBoundStandingPlayerInstant") {
                return (ctx.animEventName = "");
            }
            // Disable idle animations for 0xff actors
            if (ctx.selfId < 0xff000000) {
                return;
            }
            if (isIdle(ctx.animEventName)) {
                var i = allowedIdles.findIndex(function (pair) {
                    return pair[0] === ctx.selfId && pair[1] === ctx.animEventName;
                });
                i === -1 ? (ctx.animEventName = "") : allowedIdles.splice(i, 1);
            }
        },
        leave: function () { },
    });
};


/***/ }),

/***/ "./src/sync/appearance.ts":
/*!********************************!*\
  !*** ./src/sync/appearance.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyAppearance: () => (/* binding */ applyAppearance),
/* harmony export */   applyAppearanceToPlayer: () => (/* binding */ applyAppearanceToPlayer),
/* harmony export */   applyTints: () => (/* binding */ applyTints),
/* harmony export */   getAppearance: () => (/* binding */ getAppearance),
/* harmony export */   silentVoiceTypeId: () => (/* binding */ silentVoiceTypeId)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var getAppearance = function (actor) {
    var base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(actor.getBaseObject());
    var hairColor = base.getHairColor();
    var skinColor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.getSkinColor(base);
    var newAppearance = {
        isFemale: base.getSex() === 1,
        raceId: base.getRace() ? base.getRace().getFormID() : 0,
        weight: base.getWeight(),
        hairColor: hairColor ? hairColor.getColor() : 0,
        headpartIds: [],
        headTextureSetId: base.getFaceTextureSet()
            ? base.getFaceTextureSet().getFormID()
            : 0,
        options: new Array(19),
        presets: new Array(4),
        tints: [],
        skinColor: skinColor ? skinColor.getColor() : 0,
        name: actor.getBaseObject().getName(),
    };
    var numHeadparts = base.getNumHeadParts();
    for (var i = 0; i < numHeadparts; ++i) {
        var part = base.getNthHeadPart(i);
        if (part) {
            newAppearance.headpartIds.push(part.getFormID());
        }
    }
    for (var i = 0; i < newAppearance.options.length; ++i) {
        newAppearance.options[i] = base.getFaceMorph(i);
    }
    for (var i = 0; i < newAppearance.presets.length; ++i) {
        newAppearance.presets[i] = base.getFacePreset(i);
    }
    var numTints = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getFormID() === actor.getFormID()
        ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNumTintMasks()
        : 0;
    for (var i = 0; i < numTints; ++i) {
        var tint = {
            texturePath: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskTexturePath(i),
            type: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskType(i),
            argb: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskColor(i),
        };
        newAppearance.tints.push(tint);
    }
    return newAppearance;
};
var isVisible = function (argb) { return argb > 0x00ffffff || argb < 0; };
var applyTints = function (actor, appearance) {
    if (!appearance) {
        throw new Error("null appearance has been passed to applyTints");
    }
    var tints = appearance.tints.filter(function (t) { return isVisible(t.argb); });
    var raceWarPaintRegex = /.*Head.+WarPaint.*/;
    var uniWarPaintRegex = /.*HeadWarPaint.*/;
    var raceSpecificWarPaint = tints.filter(function (t) { return isVisible(t.argb) && t.texturePath.match(raceWarPaintRegex); }).length; // MaleHeadNordWarPaint
    var uniWarPaint = tints.filter(function (t) { return isVisible(t.argb) && t.texturePath.match(uniWarPaintRegex); }).length; // MaleHeadWarPaint
    if (raceSpecificWarPaint + uniWarPaint > 1) {
        // If visible war paints of these two types present, then Skyrim crashes
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("bad warpaint!", raceSpecificWarPaint, uniWarPaint);
        return;
    }
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.clearTintMasks(actor);
    tints.forEach(function (tint) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.pushTintMask(actor, tint.type, tint.argb, tint.texturePath);
    });
    var playerBaseId = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getBaseObject().getFormID();
    if (actor)
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setFormIdUnsafe(actor.getBaseObject(), playerBaseId);
};
var silentVoiceTypeId = 0x0002f7c3;
var applyAppearanceCommon = function (appearance, npc) {
    var race = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Race.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(appearance.raceId));
    var headparts = appearance.headpartIds
        .map(function (id) { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.HeadPart.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id)); })
        .filter(function (headpart) { return !!headpart; });
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcSex(npc, appearance.isFemale ? 1 : 0);
    if (race) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcRace(npc, race);
    }
    npc.setWeight(appearance.weight);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcSkinColor(npc, appearance.skinColor);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcHairColor(npc, appearance.hairColor);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.resizeHeadpartsArray(npc, headparts.length);
    headparts.forEach(function (v, i) { return npc.setNthHeadPart(v, i); });
    npc.setFaceTextureSet(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TextureSet.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(appearance.headTextureSetId))); // setFaceTextureSet supports null argument
    npc.setVoiceType(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.VoiceType.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(silentVoiceTypeId)));
    appearance.options.forEach(function (v, i) { return npc.setFaceMorph(v, i); });
    appearance.presets.forEach(function (v, i) { return npc.setFacePreset(v, i); });
    if (appearance.name) {
        npc.setName(appearance.name);
    }
    else {
        // for undefined or empty name
        npc.setName(" ");
    }
};
var applyAppearance = function (appearance) {
    var npc = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.createNpc();
    if (!npc) {
        throw new Error("createNpc returned null");
    }
    applyAppearanceCommon(appearance, npc);
    return npc;
};
var applyAppearanceToPlayer = function (appearance) {
    applyAppearanceCommon(appearance, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getBaseObject()));
    applyTints(null, appearance);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().queueNiNodeUpdate();
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.0625).then(function () {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
            var _a;
            (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.startDeferredKill();
        });
    });
};


/***/ }),

/***/ "./src/sync/equipment.ts":
/*!*******************************!*\
  !*** ./src/sync/equipment.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyEquipment: () => (/* binding */ applyEquipment),
/* harmony export */   getEquipedSpell: () => (/* binding */ getEquipedSpell),
/* harmony export */   getEquipment: () => (/* binding */ getEquipment),
/* harmony export */   isBadMenuShown: () => (/* binding */ isBadMenuShown),
/* harmony export */   syncSpellEquipment: () => (/* binding */ syncSpellEquipment)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _inventory__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./inventory */ "./src/sync/inventory.ts");


var getEquipedSpell = function (refr, spellType) {
    var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (!actor) {
        return 0;
    }
    switch (spellType) {
        case 0 /* SpellType.Left */: {
            var spell = actor.getEquippedSpell(0 /* SpellType.Left */);
            return spell ? spell.getFormID() : 0;
        }
        case 1 /* SpellType.Right */: {
            var spell = actor.getEquippedSpell(1 /* SpellType.Right */);
            return spell ? spell.getFormID() : 0;
        }
        case 2 /* SpellType.Voice */: {
            var spell = actor.getEquippedSpell(2 /* SpellType.Voice */);
            return spell ? spell.getFormID() : 0;
        }
        case 3 /* SpellType.Instant */: {
            var spell = actor.getEquippedSpell(3 /* SpellType.Instant */);
            return spell ? spell.getFormID() : 0;
        }
        default: {
            return 0;
        }
    }
};
var filterWorn = function (inv) {
    return { entries: inv.entries.filter(function (x) { return x.worn || x.wornLeft; }) };
};
var removeUnnecessaryExtra = function (inv, ignoreAmmo) {
    return {
        entries: inv.entries.map(function (x) {
            var r = JSON.parse(JSON.stringify(x));
            r.chargePercent = r.maxCharge;
            if (ignoreAmmo) {
                r.count = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(x.baseId)) ? r.count : 1;
            }
            else {
                r.count = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(x.baseId)) ? 1000 : 1;
            }
            delete r.name;
            return r;
        }),
    };
};
var getEquipment = function (ac, numChanges) {
    return {
        inv: (0,_inventory__WEBPACK_IMPORTED_MODULE_1__.getInventory)(ac),
        leftSpell: getEquipedSpell(ac, 0 /* SpellType.Left */),
        rightSpell: getEquipedSpell(ac, 1 /* SpellType.Right */),
        voiceSpell: getEquipedSpell(ac, 2 /* SpellType.Voice */),
        instantSpell: getEquipedSpell(ac, 3 /* SpellType.Instant */),
        numChanges: numChanges,
    };
};
var syncSpellEquipment = function (ac, spellBaseId, spellType) {
    if (spellBaseId !== undefined && spellBaseId > 0) {
        ac.equipSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Spell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(spellBaseId)), spellType);
    }
    else {
        var equipedSpell = ac.getEquippedSpell(spellType);
        if (equipedSpell) {
            ac.unequipSpell(equipedSpell, spellType);
        }
    }
};
var applyEquipment = function (ac, eq) {
    ac.removeAllItems(null, false, true);
    ac.unequipAll();
    ac.removeAllItems(null, false, true);
    var newInventory = removeUnnecessaryExtra(filterWorn(eq.inv), ac.getFormID() === 0x14);
    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setInventory)(ac.getFormID(), newInventory);
    syncSpellEquipment(ac, eq.leftSpell, 0 /* SpellType.Left */);
    syncSpellEquipment(ac, eq.rightSpell, 1 /* SpellType.Right */);
    syncSpellEquipment(ac, eq.voiceSpell, 2 /* SpellType.Voice */);
    syncSpellEquipment(ac, eq.instantSpell, 3 /* SpellType.Instant */);
    return true;
};
var isBadMenuShown = function () {
    return (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('InventoryMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('FavoritesMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('MagicMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('ContainerMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('Crafting Menu') // Actually I don't think it causes crashes
    );
};


/***/ }),

/***/ "./src/sync/inventory.ts":
/*!*******************************!*\
  !*** ./src/sync/inventory.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyInventory: () => (/* binding */ applyInventory),
/* harmony export */   getDiff: () => (/* binding */ getDiff),
/* harmony export */   getInventory: () => (/* binding */ getInventory),
/* harmony export */   hasExtras: () => (/* binding */ hasExtras),
/* harmony export */   removeSimpleItemsAsManyAsPossible: () => (/* binding */ removeSimpleItemsAsManyAsPossible),
/* harmony export */   sumInventories: () => (/* binding */ sumInventories)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

// 'loxsword (Legendary)' => 'loxsword'
var getRealName = function (s) {
    if (!s) {
        return s;
    }
    var arr = s.split(" ");
    if (arr.length && arr[arr.length - 1].match(/^\(.*\)$/)) {
        arr.pop();
    }
    return arr.join(" ");
};
// 'aaaaaaaaaaaaaaaa' => 'aaa...'
var cropName = function (s) {
    if (!s) {
        return s;
    }
    var max = 128;
    return s.length >= max
        ? s
            .split("")
            .filter(function (x, i) { return i < max; })
            .join("")
            .concat("...")
        : s;
};
var checkIfNameIsGeneratedByGame = function (aStr, bStr, formName) {
    if (!aStr.length && bStr.startsWith(formName)) {
        var bEnding = bStr.substr(formName.length);
        if (bEnding.match(/^\s\(.*\)$/)) {
            return true;
        }
    }
    return false;
};
var namesEqual = function (a, b) {
    var aStr = a.name || "";
    var bStr = b.name || "";
    if (cropName(getRealName(aStr)) === cropName(getRealName(bStr))) {
        return true;
    }
    if (a.baseId === b.baseId) {
        var form = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(a.baseId);
        if (form) {
            var formName = form.getName();
            if (checkIfNameIsGeneratedByGame(aStr, bStr, formName) ||
                checkIfNameIsGeneratedByGame(bStr, aStr, formName))
                return true;
        }
    }
    return false;
};
var extrasEqual = function (a, b, ignoreWorn) {
    if (ignoreWorn === void 0) { ignoreWorn = false; }
    return (a.health === b.health &&
        a.enchantmentId === b.enchantmentId &&
        a.maxCharge === b.maxCharge &&
        !!a.removeEnchantmentOnUnequip === !!b.removeEnchantmentOnUnequip &&
        a.chargePercent === b.chargePercent &&
        //namesEqual(a, b) &&
        a.soul === b.soul &&
        a.poisonId === b.poisonId &&
        a.poisonCount === b.poisonCount &&
        ((!!a.worn === !!b.worn && !!a.wornLeft === !!b.wornLeft) || ignoreWorn));
};
var hasExtras = function (e) {
    return !extrasEqual(e, { baseId: 0, count: 0 });
};
var extractExtraData = function (refr, extraList, out) {
    // I see that ExtraWorn is not emitted for 0xFF actors when arrows are equipped. Fixing
    var item = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(out.baseId);
    if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(item)) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (actor && actor.isEquipped(item)) {
            out.worn = true;
        }
    }
    (extraList || []).forEach(function (extra) {
        switch (extra.type) {
            case "Health":
                out.health = Math.round(extra.health * 10) / 10;
                // TESModPlatform::AddItemEx makes all items at least 1.01 health
                if (out.health === 1) {
                    delete out.health;
                }
                break;
            case "Count":
                out.count = extra.count;
                break;
            case "Enchantment":
                out.enchantmentId = extra.enchantmentId;
                out.maxCharge = extra.maxCharge;
                out.removeEnchantmentOnUnequip = extra.removeOnUnequip;
                break;
            case "Charge":
                out.chargePercent = extra.charge;
                break;
            case "Poison":
                out.poisonId = extra.poisonId;
                out.poisonCount = extra.count;
                break;
            case "Soul":
                out.soul = extra.soul;
                break;
            case "TextDisplayData":
                out.name = extra.name;
                break;
            case "Worn":
                out.worn = true;
                break;
            case "WornLeft":
                out.wornLeft = true;
                break;
        }
    });
};
var squash = function (inv) {
    var res = new Array();
    inv.entries.forEach(function (e) {
        var same = res.find(function (x) { return e.baseId === x.baseId && extrasEqual(x, e); });
        if (same) {
            same.count += e.count;
        }
        else {
            res.push(JSON.parse(JSON.stringify(e)));
        }
    });
    return { entries: res.filter(function (x) { return x.count !== 0; }) };
};
var getExtraContainerChangesAsInventory = function (refr) {
    var extraContainerChanges = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getExtraContainerChanges)(refr.getFormID());
    var entries = new Array();
    (extraContainerChanges || []).forEach(function (changesEntry) {
        var entry = {
            baseId: changesEntry.baseId,
            count: changesEntry.countDelta,
        };
        (changesEntry.extendDataList || []).forEach(function (extraList) {
            var e = {
                baseId: entry.baseId,
                count: 1,
            };
            extractExtraData(refr, extraList, e);
            entries.push(e);
            entry.count -= e.count;
        });
        if (entry.count !== 0) {
            entries.push(entry);
        }
    });
    var res = { entries: entries };
    res = squash(res);
    return res;
};
var getBaseContainerAsInventory = function (refr) {
    return {
        entries: (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getContainer)(refr.getBaseObject().getFormID()),
    };
};
var sumInventories = function (lhs, rhs) {
    var leftEntriesWithExtras = lhs.entries.filter(function (e) { return hasExtras(e); });
    var rightEntriesWithExtras = rhs.entries.filter(function (e) { return hasExtras(e); });
    var leftEntriesSimple = lhs.entries.filter(function (e) { return !hasExtras(e); });
    var rightEntriesSimple = rhs.entries.filter(function (e) { return !hasExtras(e); });
    leftEntriesSimple.forEach(function (e) {
        var matching = rightEntriesSimple.find(function (x) { return x.baseId === e.baseId; });
        if (matching) {
            e.count += matching.count;
            matching.count = 0;
        }
    });
    return {
        entries: leftEntriesWithExtras
            .concat(rightEntriesWithExtras)
            .concat(leftEntriesSimple)
            .concat(rightEntriesSimple)
            .filter(function (e) { return e.count !== 0; }),
    };
};
var removeSimpleItemsAsManyAsPossible = function (inv, baseId, count) {
    var res = { entries: [] };
    res.entries = JSON.parse(JSON.stringify(inv.entries));
    var entry = res.entries.find(function (e) { return !hasExtras(e) && e.baseId === baseId; });
    if (entry) {
        entry.count -= count;
    }
    res.entries = res.entries.filter(function (e) { return e.count > 0; });
    return res;
};
var getDiff = function (lhs, rhs, ignoreWorn) {
    var lhsCopy = JSON.parse(JSON.stringify(lhs));
    var rhsCopy = JSON.parse(JSON.stringify(rhs));
    rhsCopy.entries.forEach(function (e) {
        var sameFromLeft = lhsCopy.entries.find(function (x) { return x.baseId === e.baseId && extrasEqual(x, e, ignoreWorn); });
        if (sameFromLeft) {
            sameFromLeft.count -= e.count;
        }
        else {
            lhsCopy.entries.push(e);
            lhsCopy.entries[lhsCopy.entries.length - 1].count *= -1;
        }
    });
    return { entries: lhsCopy.entries.filter(function (x) { return x.count !== 0; }) };
};
var getInventory = function (refr) {
    return squash(sumInventories(getBaseContainerAsInventory(refr), getExtraContainerChangesAsInventory(refr)));
};
var basesReset = function () {
    if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesResetExists"] !== true) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesResetExists"] = true;
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesReset"] = new Set();
    }
    return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesReset"];
};
var resetBase = function (refr) {
    var base = refr.getBaseObject();
    var baseId = base ? base.getFormID() : 0;
    if (!basesReset().has(baseId)) {
        basesReset().add(baseId);
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.resetContainer(base);
        refr.removeAllItems(null, false, true);
    }
};
var applyInventory = function (refr, newInventory, enableCrashProtection, ignoreWorn) {
    if (ignoreWorn === void 0) { ignoreWorn = false; }
    resetBase(refr);
    var diff = getDiff(newInventory, getInventory(refr), ignoreWorn).entries;
    var res = true;
    diff.sort(function (a, b) { return (a.count < b.count ? -1 : 1); });
    diff.forEach(function (e, i) {
        if (i > 0 && enableCrashProtection) {
            res = false;
            return;
        }
        var absCount = Math.abs(e.count);
        var queueNiNodeUpdateNeeded = false;
        var worn = !!e.worn;
        var wornLeft = !!e.wornLeft;
        var oneStepCount = e.count / absCount;
        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.baseId);
        if (!f) {
            return (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Bad form ID ".concat(e.baseId.toString(16)));
        }
        var type = f.getType();
        // For misc items, potions and ingredients we don't want to split them into multiple items
        // This was made to fix a performance issue with users having 10000+ of misc items (i.e. gold)
        if (type === 32 /* FormType.Misc */ ||
            type === 46 /* FormType.Potion */ ||
            type === 30 /* FormType.Ingredient */) {
            absCount = 1;
            oneStepCount = e.count;
        }
        else {
            if (absCount > 1000) {
                absCount = 1;
                oneStepCount = 1;
                // Also for arrows with strange count
                if (worn && e.count < 0) {
                    absCount = 0;
                }
            }
            if (e.count > 1 && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.baseId))) {
                absCount = 1;
                oneStepCount = e.count;
                if (e.count > 60000) {
                    // Why would actor have 60k arrows?
                    e.count = 1;
                }
            }
        }
        for (var i_1 = 0; i_1 < absCount; ++i_1) {
            if (worn || wornLeft) {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.pushWornState(!!worn, !!wornLeft);
                queueNiNodeUpdateNeeded = true;
            }
            var addItemExArgs = void 0;
            addItemExArgs = [
                refr,
                f,
                oneStepCount,
                e.health ? e.health : 1,
                e.enchantmentId
                    ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Enchantment.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.enchantmentId))
                    : null,
                e.maxCharge ? e.maxCharge : 0,
                !!e.removeEnchantmentOnUnequip,
                e.chargePercent ? e.chargePercent : 0,
                e.name ? cropName(e.name) : f.getName(),
                e.soul ? e.soul : 0,
                e.poisonId ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Potion.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.poisonId)) : null,
                e.poisonCount ? e.poisonCount : 0
            ];
            var argsToPrint = addItemExArgs.map(function (arg) {
                if (arg instanceof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference) {
                    return "ObjectReference(".concat(arg.getFormID().toString(16), ")");
                }
                else if (arg instanceof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Form) {
                    return "Form(".concat(arg.getFormID().toString(16), ")");
                }
                else {
                    return JSON.stringify(arg);
                }
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("TESModPlatform.addItemEx(".concat(argsToPrint.join(", "), ")"));
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.addItemEx.apply(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform, addItemExArgs);
        }
        if (queueNiNodeUpdateNeeded) {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (ac) {
                ac.queueNiNodeUpdate();
            }
        }
    });
    return res;
};


/***/ }),

/***/ "./src/sync/movementApply.ts":
/*!***********************************!*\
  !*** ./src/sync/movementApply.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyMovement: () => (/* binding */ applyMovement),
/* harmony export */   applyWeapDrawn: () => (/* binding */ applyWeapDrawn)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");




var sqr = function (x) { return x * x; };
var applyMovement = function (refr, m, isMyClone) {
    if (teleportIfNeed(refr, m)) {
        return;
    }
    // Z axis isn't useful here
    var acX = refr.getPositionX();
    var acY = refr.getPositionY();
    var lagUnitsNoZ = Math.round(Math.sqrt(sqr(m.pos[0] - acX) + sqr(m.pos[1] - acY)));
    if (isMyClone === true) {
        _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__.SpApiInteractor.getControllerInstance().emitter.emit("newLocalLagValueCalculated", { lagUnitsNoZ: lagUnitsNoZ });
    }
    translateTo(refr, m);
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (!ac) {
        return;
    }
    var lookAt = null;
    if (m.lookAt) {
        try {
            lookAt = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.findClosestActor(m.lookAt[0], m.lookAt[1], m.lookAt[2], 128);
        }
        catch (e) {
            lookAt = null;
        }
    }
    if (lookAt) {
        ac.setHeadTracking(true);
        ac.setLookAt(lookAt, false);
    }
    else {
        ac.setHeadTracking(false);
    }
    // ac.stopCombat();
    ac.blockActivation(true);
    keepOffsetFromActor(ac, m);
    applySprinting(ac, m.runMode === "Sprinting");
    applyBlocking(ac, m);
    applySneaking(ac, m.isSneaking);
    applyWeapDrawn(ac, m.isWeapDrawn);
    applyHealthPercentage(ac, m.healthPercentage);
    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__.SpApiInteractor.getControllerInstance().emitter.emit("applyDeathStateEvent", { actor: ac, isDead: m.isDead });
};
var keepOffsetFromActor = function (ac, m) {
    var offsetAngle = m.rot[2] - ac.getAngleZ();
    if (Math.abs(offsetAngle) < 5) {
        offsetAngle = 0;
    }
    if (m.runMode === "Standing") {
        return ac.keepOffsetFromActor(ac, 0, 0, 0, 0, 0, offsetAngle, 1, 1);
    }
    var offset = [
        3 * Math.sin((m.direction / 180) * Math.PI),
        3 * Math.cos((m.direction / 180) * Math.PI),
        getOffsetZ(m.runMode),
    ];
    ac.keepOffsetFromActor(ac, offset[0], offset[1], offset[2], 0, 0, offsetAngle, m.runMode === "Walking" ? 2048 : 1, 1);
};
var getOffsetZ = function (runMode) {
    switch (runMode) {
        case "Walking":
            return -512;
        case "Running":
            return -1024;
    }
    return 0;
};
var applySprinting = function (ac, isSprinting) {
    if (ac.isSprinting() != isSprinting) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, isSprinting ? "SprintStart" : "SprintStop");
    }
};
var applyBlocking = function (ac, m) {
    if (ac.getAnimationVariableBool("IsBlocking") != m.isBlocking) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, m.isBlocking ? "BlockStart" : "BlockStop");
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, m.isSneaking ? "SneakStart" : "SneakStop");
    }
};
var applySneaking = function (ac, isSneaking) {
    var currentIsSneaking = ac.isSneaking() || ac.getAnimationVariableBool("IsSneaking");
    if (currentIsSneaking != isSneaking) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, isSneaking ? "SneakStart" : "SneakStop");
    }
};
var applyWeapDrawn = function (ac, isWeapDrawn) {
    if (ac.isWeaponDrawn() !== isWeapDrawn) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, isWeapDrawn ? 1 : 0);
    }
};
var applyHealthPercentage = function (ac, healthPercentage) {
    var currentPercentage = ac.getActorValuePercentage('health');
    if (currentPercentage === healthPercentage) {
        return;
    }
    var currentMax = ac.getBaseActorValue('health');
    var deltaPercentage = healthPercentage - currentPercentage;
    var k = 0.25;
    if (deltaPercentage > 0) {
        ac.restoreActorValue('health', deltaPercentage * currentMax * k);
    }
    else if (deltaPercentage < 0) {
        ac.damageActorValue('health', deltaPercentage * currentMax * k);
    }
};
// Use global temp var to avoid allocation of an array on each translateTo
var gTempTargetPos = [0, 0, 0];
var translateTo = function (refr, m) {
    var _a;
    var time = 0.2;
    if (m.isInJumpState || m.runMode !== "Standing") {
        time = 0.2;
    }
    // Local lag compensation
    // TODO: Remove "|| 0" hack (added to support old MpClientPlugin)
    var distanceAdd = (m.speed || 0) * time;
    var direction = m.rot[2] + m.direction;
    gTempTargetPos[0] = m.pos[0];
    gTempTargetPos[1] = m.pos[1];
    gTempTargetPos[2] = m.pos[2];
    // We do not want to add pos in case of standing-jumping
    if (m.runMode !== "Standing") {
        gTempTargetPos[0] += Math.sin(direction / 180 * Math.PI) * distanceAdd;
        gTempTargetPos[1] += Math.cos(direction / 180 * Math.PI) * distanceAdd;
    }
    var refrRealPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(refr);
    var distance = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(refrRealPos, gTempTargetPos);
    var speed = distance / time;
    var angleDiff = Math.abs(m.rot[2] - refr.getAngleZ());
    if (m.runMode !== "Standing" ||
        m.isInJumpState ||
        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistanceNoZ(refrRealPos, gTempTargetPos) > 8 ||
        angleDiff > 80 ||
        ((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) === null || _a === void 0 ? void 0 : _a.getSitState()) === 3) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (actor && actor.getActorValue("Variable10") < -999) {
            return;
        }
        if (!actor || !actor.isDead()) {
            refr.translateTo(gTempTargetPos[0], gTempTargetPos[1], gTempTargetPos[2], m.rot[0], m.rot[1], m.rot[2], speed, 0);
        }
    }
};
var teleportIfNeed = function (refr, m) {
    if (isInDifferentWorldOrCell(refr, m.worldOrCell) ||
        (!refr.is3DLoaded() && isInDifferentExteriorCell(refr, m.pos))) {
        throw new _lib_errors__WEBPACK_IMPORTED_MODULE_1__.RespawnNeededError("needs to be respawned");
    }
    return false;
};
var cellWidth = 4096;
var isInDifferentExteriorCell = function (refr, pos) {
    var currentPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(refr);
    var playerPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
    var targetDistanceToPlayer = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(playerPos, pos);
    var currentDistanceToPlayer = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(playerPos, currentPos);
    return currentDistanceToPlayer > cellWidth && targetDistanceToPlayer <= cellWidth;
};
var isInDifferentWorldOrCell = function (refr, worldOrCell) {
    return worldOrCell !== _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getWorldOrCell(refr);
};


/***/ }),

/***/ "./src/sync/movementGet.ts":
/*!*********************************!*\
  !*** ./src/sync/movementGet.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getMovement: () => (/* binding */ getMovement)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");


var PlayerCharacterSpeedCalculator = /** @class */ (function () {
    function PlayerCharacterSpeedCalculator() {
    }
    PlayerCharacterSpeedCalculator.savePosition = function (pos, worldOrCell) {
        this.lastPcPos = pos;
        this.lastPcPosCheck = Date.now();
        this.lastPcWorldOrCell = worldOrCell;
    };
    PlayerCharacterSpeedCalculator.getSpeed = function (currentPos, worldOrCell) {
        if (this.lastPcPosCheck === -1) {
            return 0;
        }
        var timeDeltaSec = (Date.now() - this.lastPcPosCheck) / 1000;
        if (timeDeltaSec > 5)
            return 0; // Too inaccurate
        if (timeDeltaSec === 0)
            return 0; // Division by zero
        if (worldOrCell !== this.lastPcWorldOrCell) {
            return 0;
        }
        var distance = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getDistance(currentPos, this.lastPcPos);
        return distance / timeDeltaSec;
    };
    PlayerCharacterSpeedCalculator.lastPcPos = [0, 0, 0];
    PlayerCharacterSpeedCalculator.lastPcPosCheck = -1;
    PlayerCharacterSpeedCalculator.lastPcWorldOrCell = 0;
    return PlayerCharacterSpeedCalculator;
}());
var getMovement = function (refr, form) {
    var _a;
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    // It is running for ObjectReferences because Standing
    // Doesn't lead to translateTo call
    var runMode = ac ? getRunMode(ac) : "Running";
    var healthPercentage = ac && ac.getActorValuePercentage("health");
    if (ac && ac.isDead()) {
        healthPercentage = 0;
    }
    var lookAt = undefined;
    if (refr.getFormID() !== 0x14) {
        var combatTarget = ac === null || ac === void 0 ? void 0 : ac.getCombatTarget();
        if (combatTarget) {
            lookAt = [
                combatTarget.getPositionX(),
                combatTarget.getPositionY(),
                combatTarget.getPositionZ(),
            ];
        }
    }
    var pos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(refr);
    var speed;
    if (refr.getFormID() !== 0x14) {
        speed = refr.getAnimationVariableFloat("SpeedSampled");
    }
    else {
        // Real players often run into the wall.
        // We need to have zero speed in this case. SpeedSampled doesn't help
        var w = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(refr);
        speed = PlayerCharacterSpeedCalculator.getSpeed(pos, w);
        PlayerCharacterSpeedCalculator.savePosition(pos, w);
        // It's unrealistic speed. It still may happen due to teleports
        if (speed > 2000) {
            speed = 0;
        }
    }
    var worldOrCell = refr.getWorldSpace() || refr.getParentCell();
    return {
        worldOrCell: (worldOrCell === null || worldOrCell === void 0 ? void 0 : worldOrCell.getFormID()) || 0,
        pos: pos,
        rot: [refr.getAngleX(), refr.getAngleY(), refr.getAngleZ()],
        runMode: runMode,
        direction: runMode !== "Standing"
            ? 360 * refr.getAnimationVariableFloat("Direction")
            : 0,
        isInJumpState: !!(ac && ac.getAnimationVariableBool("bInJumpState")),
        isSneaking: !!(ac && isSneaking(ac)),
        isBlocking: !!(ac && ac.getAnimationVariableBool("IsBlocking")),
        isWeapDrawn: !!(ac && ac.isWeaponDrawn()),
        isDead: ((_a = form === null || form === void 0 ? void 0 : form.isDead) !== null && _a !== void 0 ? _a : false) || !!(ac && ac.isDead()),
        healthPercentage: healthPercentage || 0,
        lookAt: lookAt,
        speed: speed
    };
};
var isSneaking = function (ac) {
    return ac.isSneaking() || ac.getAnimationVariableBool("IsSneaking");
};
var getRunMode = function (ac) {
    if (ac.isSprinting()) {
        return "Sprinting";
    }
    var speed = ac.getAnimationVariableFloat("SpeedSampled");
    if (!speed) {
        return "Standing";
    }
    var furniture = ac.getFurnitureReference();
    if (furniture !== null)
        return "Standing"; // TODO: Sitting?
    var isRunning = true;
    if (ac.getFormID() == 0x14) {
        if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.isPlayerRunningEnabled() || speed < 150)
            isRunning = false;
    }
    else {
        if (!ac.isRunning() || speed < 150) {
            isRunning = false;
        }
    }
    if (ac.getAnimationVariableFloat("IsBlocking")) {
        isRunning = isSneaking(ac);
    }
    var carryWeight = ac.getActorValue("CarryWeight");
    var totalItemWeight = ac.getTotalItemWeight();
    if (carryWeight < totalItemWeight) {
        isRunning = false;
    }
    return isRunning ? "Running" : "Walking";
};


/***/ }),

/***/ "./src/sync/spell.ts":
/*!***************************!*\
  !*** ./src/sync/spell.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   learnSpells: () => (/* binding */ learnSpells),
/* harmony export */   removeAllSpells: () => (/* binding */ removeAllSpells)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var removeAllSpells = function (actor) {
    var spellToRemove = new Array();
    for (var i = 0; i < actor.getSpellCount(); i++) {
        var spell = actor.getNthSpell(i);
        if (spell) {
            spellToRemove.push(spell);
        }
    }
    for (var _i = 0, spellToRemove_1 = spellToRemove; _i < spellToRemove_1.length; _i++) {
        var spell = spellToRemove_1[_i];
        var removeResult = actor.removeSpell(spell);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("removeResult: ".concat(removeResult, ", spellIdToRemove: ").concat(spell
            .getFormID()
            .toString(16), ", spellName: ").concat(spell.getName()));
    }
};
var learnSpells = function (actor, spellsIds) {
    for (var _i = 0, spellsIds_1 = spellsIds; _i < spellsIds_1.length; _i++) {
        var spellId = spellsIds_1[_i];
        var spell = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Spell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(spellId));
        if (spell) {
            var addResult = actor.addSpell(spell, false);
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("addResult: ".concat(addResult, ", spellIdToLearn: ").concat(spell
                .getFormID()
                .toString(16), ", spellName: ").concat(spell.getName()));
        }
    }
};


/***/ }),

/***/ "./src/version.ts":
/*!************************!*\
  !*** ./src/version.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   requiredVersion: () => (/* binding */ requiredVersion),
/* harmony export */   verifyVersion: () => (/* binding */ verifyVersion)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var requiredVersion = '2.9.0';
var realVersion = typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getPlatformVersion === 'function' ? (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getPlatformVersion)() : 'unknown';
// TODO: no one actually calls this function. make a service
var verifyVersion = function () {
    if (!requiredVersion.includes(realVersion)) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.messageBox("You need to have on of those SkyrimPlatform versions ".concat(JSON.stringify(requiredVersion), " to join this server. Your current version is ").concat(realVersion));
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.waitMenuMode(0.5).then(function () {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.on)('update', function () {
                if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('MessageBoxMenu')) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.quitToMainMenu();
                }
            });
        });
    }
};


/***/ }),

/***/ "./src/view/formView.ts":
/*!******************************!*\
  !*** ./src/view/formView.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormView: () => (/* binding */ FormView),
/* harmony export */   getScreenResolution: () => (/* binding */ getScreenResolution)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _sync_movementApply__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../sync/movementApply */ "./src/sync/movementApply.ts");
/* harmony import */ var _spawnProcess__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./spawnProcess */ "./src/view/spawnProcess.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./playerCharacterDataHolder */ "./src/view/playerCharacterDataHolder.ts");
/* harmony import */ var _sync_movementGet__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../sync/movementGet */ "./src/sync/movementGet.ts");
/* harmony import */ var _hostAttempts__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./hostAttempts */ "./src/view/hostAttempts.ts");
/* harmony import */ var _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./modelApplyUtils */ "./src/view/modelApplyUtils.ts");
/* harmony import */ var _worldViewMisc__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ../services/services/worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");
















var _screenResolution;
var getScreenResolution = function () {
    if (!_screenResolution) {
        _screenResolution = {
            width: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.getINIInt("iSize W:Display"),
            height: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.getINIInt("iSize H:Display"),
        };
    }
    return _screenResolution;
};
var FormView = /** @class */ (function () {
    function FormView(remoteRefrId) {
        this.remoteRefrId = remoteRefrId;
        this.lastHarvestedApply = 0;
        this.lastOpenApply = 0;
        this.isSetNodeTextureSetApplied = false;
        this.isSetNodeScaleApplied = false;
        this.refrId = 0;
        this.ready = false;
        this.animState = this.getDefaultAnimState();
        this.movState = {
            lastNumChanges: 0,
            lastApply: 0,
            lastRehost: 0,
            everApplied: false,
        };
        this.appearanceState = this.getDefaultAppearanceState();
        this.eqState = this.getDefaultEquipState();
        this.appearanceBasedBaseId = 0;
        this.leveledBaseId = 0;
        this.isOnScreen = false;
        this.lastPcWorldOrCell = 0;
        this.lastWorldOrCell = 0;
        this.spawnMoment = 0;
        this.wasHostedByOther = undefined;
        this.state = {};
        this.localImmortal = false;
        this.textNameId = undefined;
        this.voiceIndicatorId = undefined;
    }
    FormView.prototype.update = function (model) {
        var _this = this;
        var _a, _b, _c, _d, _e, _f, _g, _h;
        // Other players mutate into PC clones when moving to another location
        if (model.movement) {
            if (!this.lastWorldOrCell)
                this.lastWorldOrCell = model.movement.worldOrCell;
            if (this.lastWorldOrCell !== model.movement.worldOrCell) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("[1] worldOrCell changed, destroying FormView ".concat(this.lastWorldOrCell.toString(16), " => ").concat(model.movement.worldOrCell.toString(16)));
                this.lastWorldOrCell = model.movement.worldOrCell;
                this.destroy();
                this.refrId = 0;
                this.appearanceBasedBaseId = 0;
                return;
            }
        }
        // Don't spawn dead actors if not already
        if (model.isDead) {
            if (this.refrId === 0) {
                return;
            }
        }
        // Players with different worldOrCell should be invisible
        if (model.movement) {
            var worldOrCell = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.getWorldOrCell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
            if (worldOrCell !== 0 &&
                model.movement.worldOrCell !== worldOrCell) {
                this.destroy();
                this.refrId = 0;
                return;
            }
        }
        // Apply appearance before base form selection to prevent double-spawn
        if (model.appearance || (!model.appearance && this.appearanceState.appearance)) {
            if (!this.appearanceState.appearance ||
                model.numAppearanceChanges !== this.appearanceState.lastNumChanges) {
                // Both non-null
                if (model.appearance && this.appearanceState.appearance) {
                    var modelAppearanceCopy = JSON.parse(JSON.stringify(model.appearance));
                    var stateAppearanceCopy = JSON.parse(JSON.stringify(this.appearanceState.appearance));
                    modelAppearanceCopy.name = "";
                    stateAppearanceCopy.name = "";
                    var equalWithoutNames = JSON.stringify(modelAppearanceCopy) === JSON.stringify(stateAppearanceCopy);
                    if (equalWithoutNames) {
                        // Change name inplace
                        var refr_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
                        (_a = refr_1 === null || refr_1 === void 0 ? void 0 : refr_1.getBaseObject()) === null || _a === void 0 ? void 0 : _a.setName(model.appearance.name);
                        refr_1 === null || refr_1 === void 0 ? void 0 : refr_1.setDisplayName(model.appearance.name, true);
                        //printConsole("Appearance updated, changing name inplace");
                    }
                    else {
                        // Force re-apply appearance on the next getAppearanceBasedBase call
                        this.appearanceBasedBaseId = 0;
                        //printConsole("Appearance updated");
                    }
                }
                else {
                    // Force re-apply appearance on the next getAppearanceBasedBase call
                    this.appearanceBasedBaseId = 0;
                    //printConsole("Appearance updated");
                }
                this.appearanceState.appearance = model.appearance || null;
                this.appearanceState.lastNumChanges = model.numAppearanceChanges;
            }
        }
        var refId = model.refrId && model.refrId < 0xff000000 ? model.refrId : undefined;
        if (refId) {
            if (this.refrId !== refId) {
                this.destroy();
                this.refrId = model.refrId;
                this.ready = true;
                var refr_2 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
                if (refr_2) {
                    var base = refr_2.getBaseObject();
                    if (base) {
                        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.dealWithRef(refr_2, base);
                    }
                }
            }
        }
        else {
            var templateChain = model.templateChain;
            // There is no place for random/leveling in 1-sized chain
            // Just spawn an NPC, do not generate a temporary TESNPC form
            if ((templateChain === null || templateChain === void 0 ? void 0 : templateChain.length) === 1) {
                templateChain = undefined;
            }
            // TODO: getLeveledBase crashes too often ATM
            var base = null; //Game.getFormEx(this.getLeveledBase(templateChain));
            if (base === null) {
                base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(model.baseId || NaN);
            }
            if (base === null) {
                base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.getAppearanceBasedBase());
            }
            if (base === null) {
                return;
            }
            var refr_3 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
            var respawnRequired = false;
            if (!refr_3) {
                respawnRequired = true;
            }
            else if (!refr_3.getBaseObject()) {
                respawnRequired = true;
            }
            else if (refr_3.getBaseObject().getFormID() !== base.getFormID()) {
                respawnRequired = true;
            }
            if (respawnRequired) {
                this.destroy();
                var player_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                var spawnMethodOriginal = {
                    spawn: function (baseForm, _spawnPosition, _spawnRotation) {
                        return player_1.placeAtMe(baseForm, 1, true, true);
                    },
                    triggerSpawnProcess: function (spawningRefr, spawnPosition, appearance, callback) {
                        new _spawnProcess__WEBPACK_IMPORTED_MODULE_6__.SpawnProcess(appearance, spawnPosition, spawningRefr.getFormID(), callback);
                    }
                };
                var spawnMethodStub = {
                    spawn: function (baseForm, spawnPosition, spawnRotation) {
                        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc1"];
                        var ref = f(baseForm, spawnPosition, spawnRotation);
                        return ref;
                    },
                    triggerSpawnProcess: function (spawningRefr, spawnPosition, appearance, callback) {
                        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc2"];
                        f(spawningRefr, spawnPosition, appearance, callback);
                    }
                };
                var spawnUsingStubMethod = base.getType() === 43 /* FormType.NPC */
                    && !this.appearanceState.appearance
                    && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc1Set"] === true
                    && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc2Set"] === true;
                var spawnMethod = spawnUsingStubMethod ? spawnMethodStub : spawnMethodOriginal;
                if (model.movement) {
                    refr_3 = spawnMethod.spawn(base, model.movement.pos, model.movement.rot);
                }
                else {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("model.movement was " + model.movement);
                }
                this.state = {};
                delete this.wasHostedByOther;
                if (base.getType() !== 43 /* FormType.NPC */) {
                    refr_3 === null || refr_3 === void 0 ? void 0 : refr_3.setAngle(((_b = model.movement) === null || _b === void 0 ? void 0 : _b.rot[0]) || 0, ((_c = model.movement) === null || _c === void 0 ? void 0 : _c.rot[1]) || 0, ((_d = model.movement) === null || _d === void 0 ? void 0 : _d.rot[2]) || 0);
                }
                else {
                    var race = (_f = (_e = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _e === void 0 ? void 0 : _e.getRace()) === null || _f === void 0 ? void 0 : _f.getFormID();
                    var draugrRace = 0xd53;
                    var falmerRace = 0x131f4;
                    var chaurusRace = 0x131eb;
                    var frostbiteSpiderRaceGiant = 0x4e507;
                    var frostbiteSpiderRaceLarge = 0x53477;
                    var dwarvenCenturionRace = 0x131f1;
                    var dwarvenSphereRace = 0x131f2;
                    var dwarvenSpiderRace = 0x131f3;
                    var sprigganRace = 0x2013b77;
                    var sprigganRace2 = 0xf3903;
                    var sprigganRace3 = 0x13204;
                    var sprigganRace4 = 0x401b644;
                    var sprigganRace5 = 0x9aa44;
                    var wolfRace = 0x1320a;
                    // potential masterambushscript
                    if (race === draugrRace
                        || race === falmerRace
                        || race === chaurusRace
                        || race === frostbiteSpiderRaceGiant
                        || race === frostbiteSpiderRaceLarge
                        || race === dwarvenCenturionRace
                        || race === dwarvenSphereRace
                        || race === dwarvenSpiderRace
                        || race === sprigganRace
                        || race === sprigganRace2
                        || race === sprigganRace3
                        || race === sprigganRace4
                        || race === sprigganRace5
                        || race === wolfRace) {
                        (_g = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _g === void 0 ? void 0 : _g.setActorValue("Aggression", 2);
                    }
                }
                if (refr_3 !== null) {
                    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__.WorldCleanerService).modWcProtection(refr_3.getFormID(), 1);
                }
                // TODO: reset all states?
                this.eqState = this.getDefaultEquipState();
                this.animState = this.getDefaultAnimState();
                this.ready = false;
                var spawnPos = void 0;
                if (model.movement) {
                    spawnPos = model.movement.pos;
                    // printConsole("Spawn NPC at movement.pos");
                }
                else {
                    spawnPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.getPos(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Spawn NPC at player pos");
                }
                if (refr_3) {
                    spawnMethod.triggerSpawnProcess(refr_3, spawnPos, model.appearance || null, function () {
                        _this.ready = true;
                        _this.spawnMoment = Date.now();
                    });
                }
                else {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Unable to triggerSpawnProcess for null refr");
                }
                if (model.appearance && model.appearance.name) {
                    refr_3 === null || refr_3 === void 0 ? void 0 : refr_3.setDisplayName("" + model.appearance.name, true);
                }
                (_h = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _h === void 0 ? void 0 : _h.setActorValue("attackDamageMult", 0);
            }
            this.refrId = refr_3.getFormID();
        }
        if (!this.ready) {
            return;
        }
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
        if (refr) {
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor && !this.localImmortal) {
                actor.startDeferredKill();
                actor.setActorValue("health", 1000000);
                actor.setActorValue("magicka", 1000000);
                this.localImmortal = true;
            }
            this.applyAll(refr, model);
            var gamemodeUpdateService = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_15__.GamemodeUpdateService);
            gamemodeUpdateService.updateNeighbor(refr, model, this.state);
        }
    };
    FormView.prototype.destroy = function () {
        this.isOnScreen = false;
        this.spawnMoment = 0;
        var refrId = this.refrId;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
            if (refrId >= 0xff000000) {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
                if (refr) {
                    refr.delete();
                }
                _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__.WorldCleanerService).modWcProtection(refrId, -1);
                var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
                if (ac) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, -1);
                }
            }
        });
        this.localImmortal = false;
        this.removeNickname();
    };
    FormView.prototype.applyAll = function (refr, model) {
        var _a, _b, _c;
        var forcedWeapDrawn = null;
        if (_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getCrosshairRefId() === this.refrId) {
            this.lastHarvestedApply = 0;
            this.lastOpenApply = 0;
        }
        var now = Date.now();
        if (now - this.lastHarvestedApply > 666) {
            this.lastHarvestedApply = now;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelIsHarvested(refr, !!model.isHarvested);
        }
        if (now - this.lastOpenApply > 133) {
            this.lastOpenApply = now;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelIsOpen(refr, !!model.isOpen);
        }
        if (!this.isSetNodeScaleApplied) {
            this.isSetNodeScaleApplied = true;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelNodeScale(refr, model.setNodeScale);
        }
        if (!this.isSetNodeTextureSetApplied) {
            this.isSetNodeTextureSetApplied = true;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelNodeTextureSet(refr, model.setNodeTextureSet);
        }
        if (model.inventory &&
            _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getCrosshairRefId() == this.refrId &&
            !(0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.isBadMenuShown)()) {
            // Do not let actors breaking their equipment via inventory apply
            // However, actually, actors do not have inventory in their models
            // Except your clone.
            if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) {
                _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelInventory(refr, model.inventory);
                model.inventory = undefined;
            }
        }
        if (model.animation) {
            if (model.animation.animEventName === "SkympFakeUnequip") {
                forcedWeapDrawn = false;
            }
            else if (model.animation.animEventName === "SkympFakeEquip") {
                forcedWeapDrawn = true;
            }
        }
        // TODO: make host service
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        var alreadyHosted = false;
        if (Array.isArray(hosted)) {
            var remoteId = (0,_worldViewMisc__WEBPACK_IMPORTED_MODULE_12__.localIdToRemoteId)(this.refrId);
            if (hosted.includes(remoteId) || hosted.includes(remoteId + 0x100000000)) {
                alreadyHosted = true;
            }
        }
        (0,_sync_animation__WEBPACK_IMPORTED_MODULE_1__.setDefaultAnimsDisabled)(this.refrId, alreadyHosted ? false : true);
        if (alreadyHosted) {
            (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) === null || _a === void 0 ? void 0 : _a.clearKeepOffsetFromActor();
        }
        if (model.movement) {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (this.movState.lastApply &&
                Date.now() - this.movState.lastApply > 1500) {
                if (Date.now() - this.movState.lastRehost > 1000) {
                    this.movState.lastRehost = Date.now();
                    var remoteId = this.remoteRefrId;
                    if (ac && ac.is3DLoaded()) {
                        this.tryHostIfNeed(ac, remoteId);
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("tryHostIfNeed - reason: not seeing movement for long time");
                    }
                }
            }
            if (+model.numMovementChanges !==
                this.movState.lastNumChanges ||
                Date.now() - this.movState.lastApply > 2000) {
                this.movState.lastApply = Date.now();
                if (model.isHostedByOther || !this.movState.everApplied) {
                    var backup = model.movement.isWeapDrawn;
                    if (forcedWeapDrawn === true || forcedWeapDrawn === false) {
                        model.movement.isWeapDrawn = forcedWeapDrawn;
                    }
                    try {
                        (0,_sync_movementApply__WEBPACK_IMPORTED_MODULE_5__.applyMovement)(refr, model.movement, !!model.isMyClone);
                    }
                    catch (e) {
                        if (e instanceof _lib_errors__WEBPACK_IMPORTED_MODULE_4__.RespawnNeededError) {
                            this.lastWorldOrCell = model.movement.worldOrCell;
                            this.destroy();
                            this.refrId = 0;
                            this.appearanceBasedBaseId = 0;
                            return;
                        }
                        else {
                            throw e;
                        }
                    }
                    model.movement.isWeapDrawn = backup;
                    this.movState.lastNumChanges = +model.numMovementChanges;
                    this.movState.everApplied = true;
                }
                else {
                    var remoteId = this.remoteRefrId;
                    if (ac && remoteId && ac.is3DLoaded()) {
                        ac.clearKeepOffsetFromActor();
                        // TODO: make host service
                        var hosted_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
                        var alreadyHosted_1 = false;
                        if (Array.isArray(hosted_1)) {
                            var remoteId_1 = (0,_worldViewMisc__WEBPACK_IMPORTED_MODULE_12__.localIdToRemoteId)(ac.getFormID());
                            if (hosted_1.includes(remoteId_1) || hosted_1.includes(remoteId_1 + 0x100000000)) {
                                alreadyHosted_1 = true;
                            }
                        }
                        if (!alreadyHosted_1) {
                            if (this.tryHostIfNeed(ac, remoteId)) {
                                // previously, we did this cleanup on each update
                                // but I guess it's too expensive and can possibly hurt FPS
                                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, -1);
                            }
                        }
                    }
                }
            }
        }
        if (refr.is3DLoaded()) {
            if (model.animation) {
                (0,_sync_animation__WEBPACK_IMPORTED_MODULE_1__.applyAnimation)(refr, model.animation, this.animState);
            }
            // Use them only once, for spawning actors with correct animations
            this.animState.useAnimOverrides = false;
        }
        if (model.appearance) {
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor && !_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.isInJumpState()) {
                if (_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell()) {
                    if (this.lastPcWorldOrCell &&
                        _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell() !== this.lastPcWorldOrCell) {
                        // Redraw tints if PC world/cell changed
                        this.isOnScreen = false;
                    }
                    this.lastPcWorldOrCell = _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell();
                }
                var headPos = [
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionX(actor, "NPC Head [Head]", false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionY(actor, "NPC Head [Head]", false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionZ(actor, "NPC Head [Head]", false),
                ];
                var screenPoint = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.worldPointToScreenPoint)(headPos)[0];
                var isOnScreen = screenPoint[0] > 0 &&
                    screenPoint[1] > 0 &&
                    screenPoint[2] > 0 &&
                    screenPoint[0] < 1 &&
                    screenPoint[1] < 1 &&
                    screenPoint[2] < 1;
                if (isOnScreen != this.isOnScreen) {
                    this.isOnScreen = isOnScreen;
                    if (isOnScreen) {
                        actor.queueNiNodeUpdate();
                        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().queueNiNodeUpdate();
                    }
                }
            }
        }
        if (model.equipment) {
            if (this.eqState.lastNumChanges !== model.equipment.numChanges) {
                var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
                // If we do not block inventory here, we will be able to reproduce the bug:
                // 1. Place ~90 bots and force them to reequip iron swords to the left hand (rate should be ~50ms)
                // 2. Open your inventory and reequip different items fast
                // 3. After 1-2 minutes close your inventory and see that HUD disappeared
                if (ac &&
                    !(0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.isBadMenuShown)() &&
                    Date.now() - this.eqState.lastEqMoment > 500 &&
                    Date.now() - this.spawnMoment > -1 &&
                    this.spawnMoment > 0) {
                    //if (this.spawnMoment > 0 && Date.now() - this.spawnMoment > 5000) {
                    if ((0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.applyEquipment)(ac, model.equipment)) {
                        this.eqState.lastNumChanges = model.equipment.numChanges;
                    }
                    this.eqState.lastEqMoment = Date.now();
                    //}
                    //const res: boolean = applyEquipment(ac, model.equipment);
                    //if (res) this.eqState.lastNumChanges = model.equipment.numChanges;
                }
            }
        }
        if (FormView.isDisplayingNicknames && this.refrId && ((_b = model.appearance) === null || _b === void 0 ? void 0 : _b.name)) {
            var headPart = "NPC Head [Head]";
            var maxNicknameDrawDistance = 1000;
            var playerActor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
            var isVisibleByPlayer = !((_c = model.movement) === null || _c === void 0 ? void 0 : _c.isSneaking)
                && playerActor.getDistance(refr) <= maxNicknameDrawDistance
                && playerActor.hasLOS(refr)
                && !this.isSweetHidePerson(refr);
            if (isVisibleByPlayer) {
                var headScreenPos = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.worldPointToScreenPoint)([
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionX(refr, headPart, false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionY(refr, headPart, false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionZ(refr, headPart, false) + 32
                ])[0];
                var resolution = getScreenResolution();
                var textXPos = Math.round(headScreenPos[0] * resolution.width);
                var textYPos = Math.round((1 - headScreenPos[1]) * resolution.height);
                var isTalkingText = (model === null || model === void 0 ? void 0 : model.isTalking) ? "Speaking" : "";
                if (!this.textNameId && headScreenPos[2] > 0) {
                    this.textNameId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(textXPos, textYPos, refr.getDisplayName(), [1, 1, 1, 0.8]);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.textNameId, 0.5);
                    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().emitter.emit("nicknameCreate", {
                        remoteRefrId: this.getRemoteRefrId(),
                        textId: this.textNameId
                    });
                }
                else {
                    var deleteNickname = headScreenPos[2] < 0;
                    if (deleteNickname) {
                        this.removeNickname();
                    }
                    if (this.textNameId) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextPos)(this.textNameId, textXPos, textYPos);
                    }
                }
                if (!this.voiceIndicatorId) {
                    this.voiceIndicatorId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(textXPos, textYPos - 35, "", [1, 0.85, 0.2, 0.8]);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.voiceIndicatorId, 0.4);
                }
                else {
                    if (this.voiceIndicatorId) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextString)(this.voiceIndicatorId, headScreenPos[2] >= 0 ? isTalkingText : "");
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextPos)(this.voiceIndicatorId, textXPos, textYPos - 35);
                    }
                }
            }
            else {
                this.removeNickname();
            }
        }
        else {
            this.removeNickname();
        }
    };
    FormView.prototype.isSweetHidePerson = function (refr) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (!actor) {
            return false;
        }
        var keyword = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Keyword.getKeyword('SweetHidePerson');
        return actor.wornHasKeyword(keyword);
    };
    FormView.prototype.removeNickname = function () {
        if (this.textNameId) {
            _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().emitter.emit("nicknameDestroy", {
                remoteRefrId: this.getRemoteRefrId(),
                textId: this.textNameId
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.destroyText)(this.textNameId);
            this.textNameId = undefined;
        }
        if (this.voiceIndicatorId) {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.destroyText)(this.voiceIndicatorId);
            this.voiceIndicatorId = undefined;
        }
    };
    FormView.prototype.getAppearanceBasedBase = function () {
        var base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.appearanceBasedBaseId));
        if (!base && this.appearanceState.appearance) {
            this.appearanceBasedBaseId = (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_2__.applyAppearance)(this.appearanceState.appearance).getFormID();
        }
        return this.appearanceBasedBaseId;
    };
    FormView.prototype.getLeveledBase = function (templateChain) {
        if (templateChain === undefined) {
            return 0;
        }
        var str = templateChain.join(',');
        if (this.leveledBaseId === 0) {
            // @ts-ignore
            var leveledBase = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.evaluateLeveledNpc(str);
            if (!leveledBase) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Failed to evaluate leveled npc", str);
            }
            this.leveledBaseId = (leveledBase === null || leveledBase === void 0 ? void 0 : leveledBase.getFormID()) || 0;
        }
        return this.leveledBaseId;
    };
    FormView.prototype.getDefaultEquipState = function () {
        return { lastNumChanges: 0, lastEqMoment: 0 };
    };
    ;
    FormView.prototype.getDefaultAppearanceState = function () {
        return { lastNumChanges: 0, appearance: null };
    };
    ;
    FormView.prototype.getDefaultAnimState = function () {
        return { lastNumChanges: 0, useAnimOverrides: true };
    };
    ;
    FormView.prototype.tryHostIfNeed = function (ac, remoteId) {
        var last = _hostAttempts__WEBPACK_IMPORTED_MODULE_10__.lastTryHost[remoteId];
        if (!last || Date.now() - last >= 1000) {
            _hostAttempts__WEBPACK_IMPORTED_MODULE_10__.lastTryHost[remoteId] = Date.now();
            if ((0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_9__.getMovement)(ac).worldOrCell ===
                (0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_9__.getMovement)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()).worldOrCell) {
                (0,_hostAttempts__WEBPACK_IMPORTED_MODULE_10__.tryHost)(remoteId);
                return true;
            }
        }
        return false;
    };
    ;
    FormView.prototype.getLocalRefrId = function () {
        return this.refrId;
    };
    FormView.prototype.getRemoteRefrId = function () {
        return this.remoteRefrId;
    };
    FormView.isDisplayingNicknames = true;
    return FormView;
}());



/***/ }),

/***/ "./src/view/formViewArray.ts":
/*!***********************************!*\
  !*** ./src/view/formViewArray.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormViewArray: () => (/* binding */ FormViewArray)
/* harmony export */ });
/* harmony import */ var _formView__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./formView */ "./src/view/formView.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");



var FormViewArray = /** @class */ (function () {
    function FormViewArray() {
        this.formViews = new Array();
    }
    FormViewArray.prototype.updateForm = function (form, i) {
        var view = this.formViews[i];
        if (!view) {
            this.formViews[i] = new _formView__WEBPACK_IMPORTED_MODULE_0__.FormView(form.refrId);
        }
        else {
            view.update(form);
        }
    };
    FormViewArray.prototype.destroyForm = function (i) {
        var formView = this.formViews[i];
        if (formView === undefined) {
            return;
        }
        formView.destroy();
        this.formViews[i] = undefined;
    };
    FormViewArray.prototype.resize = function (newSize) {
        if (this.formViews.length > newSize) {
            this.formViews.slice(newSize).forEach(function (v) { return v && v.destroy(); });
        }
        this.formViews.length = newSize;
    };
    FormViewArray.prototype.updateAll = function (model, showMe, isCloneView) {
        var gamemodeUpdateService = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_2__.GamemodeUpdateService);
        gamemodeUpdateService.setFormViewArray(this);
        var forms = model.forms;
        var n = forms.length;
        for (var i = 0; i < n; ++i) {
            var form = forms[i];
            if (!form || (model.playerCharacterFormIdx === i && !showMe)) {
                this.destroyForm(i);
                continue;
            }
            var realPos = undefined;
            var offset = model.playerCharacterFormIdx === i || isCloneView;
            if (offset && form.movement) {
                realPos = form.movement.pos;
                form.movement.pos = [
                    realPos[0] + 128,
                    realPos[1] + 128,
                    realPos[2],
                ];
            }
            if (isCloneView) {
                // Prevent using the same refr by normal and clone views
                if (!form.refrId || form.refrId >= 0xff000000) {
                    var backup = form.isHostedByOther;
                    form.isHostedByOther = true;
                    // TODO: Explain why do not GamemodeApiSupport.setI(i); here
                    this.updateForm(form, i);
                    form.isHostedByOther = backup;
                }
            }
            else {
                gamemodeUpdateService.setI(i);
                this.updateForm(form, i);
            }
            if (offset && form.movement && realPos) {
                form.movement.pos = realPos;
            }
        }
    };
    FormViewArray.prototype.syncFormView = function (model, showMe) {
        for (var i = 0; i < model.forms.length; ++i) {
            if (!model.forms[i] || (model.playerCharacterFormIdx === i && !showMe)) {
                this.destroyForm(i);
                continue;
            }
        }
    };
    FormViewArray.prototype.getRemoteRefrId = function (clientsideRefrId) {
        if (clientsideRefrId < 0xff000000)
            throw new Error("This function is only for 0xff forms");
        var formView = this.formViews.find(function (formView) {
            return formView && formView.getLocalRefrId() === clientsideRefrId;
        });
        return formView ? formView.getRemoteRefrId() : 0;
    };
    FormViewArray.prototype.getLocalRefrId = function (remoteRefrId) {
        if (remoteRefrId < 0xff000000)
            throw new Error("This function is only for 0xff forms");
        var formView = this.formViews.find(function (formView) {
            return formView && formView.getRemoteRefrId() === remoteRefrId;
        });
        return formView ? formView.getLocalRefrId() : 0;
    };
    FormViewArray.prototype.getNthFormView = function (i) {
        return this.formViews[i];
    };
    FormViewArray.prototype.getFormViewsArrayLength = function () {
        return this.formViews.length;
    };
    return FormViewArray;
}());



/***/ }),

/***/ "./src/view/hostAttempts.ts":
/*!**********************************!*\
  !*** ./src/view/hostAttempts.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   lastTryHost: () => (/* binding */ lastTryHost),
/* harmony export */   nextHostAttempt: () => (/* binding */ nextHostAttempt),
/* harmony export */   tryHost: () => (/* binding */ tryHost)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"] = [];
var tryHost = function (targetRemoteId) {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"].push(targetRemoteId);
};
var nextHostAttempt = function () {
    var arr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"];
    if (arr.length === 0) {
        return undefined;
    }
    return arr.shift();
};
var lastTryHost = {};


/***/ }),

/***/ "./src/view/modelApplyUtils.ts":
/*!*************************************!*\
  !*** ./src/view/modelApplyUtils.ts ***!
  \*************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ModelApplyUtils: () => (/* binding */ ModelApplyUtils)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../logging */ "./src/logging.ts");



// For 0xff000000+ used from FormView
// For objects from master files used directly from remoteServer.ts
var ModelApplyUtils = /** @class */ (function () {
    function ModelApplyUtils() {
    }
    ModelApplyUtils.applyModelInventory = function (refr, inventory) {
        (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_1__.applyInventory)(refr, inventory, false, true);
    };
    ModelApplyUtils.applyModelIsOpen = function (refr, isOpen) {
        var _a;
        refr.setOpen(isOpen);
        // See also objectReferenceEx.ts
        var caveGSecretDoor01 = 0x6f703;
        // TODO: add more activators to support more cells
        var parentActivatorId = 0x460ca;
        if (((_a = refr.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) === caveGSecretDoor01) {
            var openOrOpening = [1, 2].includes(refr.getOpenState());
            if (openOrOpening) {
                if (!isOpen) {
                    refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getForm(parentActivatorId)), false);
                }
            }
            if (!openOrOpening) {
                if (isOpen) {
                    refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getForm(parentActivatorId)), false);
                }
            }
        }
    };
    ModelApplyUtils.applyModelIsDisabled = function (refr, disabled) {
        var wasDisabled = refr.isDisabled();
        if (wasDisabled == disabled) {
            return;
        }
        if (disabled) {
            refr.disable(false);
        }
        else {
            refr.enable(true);
        }
    };
    ModelApplyUtils.applyModelIsHarvested = function (refr, isHarvested) {
        var base = refr.getBaseObject();
        if (base) {
            var t = base.getType();
            if (t == 38 /* FormType.Tree */ || t == 39 /* FormType.Flora */) {
                var wasHarvested = refr.isHarvested();
                if (isHarvested != wasHarvested) {
                    var ac = null;
                    if (isHarvested) {
                        for (var i = 0; i < 20; ++i) {
                            ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.findRandomActor(refr.getPositionX(), refr.getPositionY(), refr.getPositionZ(), 10000);
                            if (ac && ac.getFormID() !== 0x14) {
                                break;
                            }
                        }
                    }
                    if (isHarvested && ac && ac.getFormID() !== 0x14) {
                        refr.activate(ac, true);
                    }
                    else {
                        refr.setHarvested(isHarvested);
                        var id_1 = refr.getFormID();
                        refr.disable(false).then(function () {
                            var restoredRefr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id_1));
                            if (restoredRefr) {
                                restoredRefr.enable(false);
                            }
                        });
                    }
                }
            }
            else {
                var wasHarvested = refr.isDisabled();
                if (isHarvested != wasHarvested) {
                    if (isHarvested) {
                        var id_2 = refr.getFormID();
                        refr.disable(false).then(function () {
                            var restoredRefr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id_2));
                            if (restoredRefr && !restoredRefr.isDisabled()) {
                                restoredRefr.delete();
                                // Deletion takes time, so in practice this would be called a lot of times
                            }
                        });
                    }
                    else {
                        refr.enable(true);
                    }
                }
            }
        }
    };
    ModelApplyUtils.applyModelNodeTextureSet = function (refr, setNodeTextureSet) {
        if (setNodeTextureSet) {
            setNodeTextureSet.forEach(function (element) {
                var firstPerson = false;
                var textureSet = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TextureSet.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(element.textureSetId));
                if (textureSet !== null) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.setNodeTextureSet(refr, element.nodeName, textureSet, firstPerson);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)("ModelApplyUtils", refr.getFormID().toString(16), "Applied texture set", element.textureSetId.toString(16), "to", element.nodeName);
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)("ModelApplyUtils", refr.getFormID().toString(16), "Failed to apply texture set", element.textureSetId.toString(16), "to", element.nodeName);
                }
            });
        }
    };
    ModelApplyUtils.applyModelNodeScale = function (refr, setNodeScale) {
        if (setNodeScale) {
            setNodeScale.forEach(function (element) {
                var firstPerson = false;
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.setNodeScale(refr, element.nodeName, element.scale, firstPerson);
                (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)("ModelApplyUtils", refr.getFormID().toString(16), "Applied node scale", element.scale, "to", element.nodeName);
            });
        }
    };
    return ModelApplyUtils;
}());



/***/ }),

/***/ "./src/view/playerCharacterDataHolder.ts":
/*!***********************************************!*\
  !*** ./src/view/playerCharacterDataHolder.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PlayerCharacterDataHolder: () => (/* binding */ PlayerCharacterDataHolder)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");


var PlayerCharacterDataHolder = /** @class */ (function () {
    function PlayerCharacterDataHolder() {
    }
    PlayerCharacterDataHolder.updateData = function () {
        var _a;
        var player = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
        if (!player) {
            return;
        }
        this.inJumpState = player.getAnimationVariableBool("bInJumpState");
        this.worldOrCell = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(player);
        this.crosshairRefId = ((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getCurrentCrosshairRef()) === null || _a === void 0 ? void 0 : _a.getFormID()) || 0;
    };
    PlayerCharacterDataHolder.isInJumpState = function () {
        return this.inJumpState;
    };
    PlayerCharacterDataHolder.getWorldOrCell = function () {
        return this.worldOrCell;
    };
    PlayerCharacterDataHolder.getCrosshairRefId = function () {
        return this.crosshairRefId;
    };
    PlayerCharacterDataHolder.inJumpState = false;
    PlayerCharacterDataHolder.worldOrCell = 0;
    PlayerCharacterDataHolder.crosshairRefId = 0;
    return PlayerCharacterDataHolder;
}());



/***/ }),

/***/ "./src/view/spawnProcess.ts":
/*!**********************************!*\
  !*** ./src/view/spawnProcess.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpawnProcess: () => (/* binding */ SpawnProcess)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");



var SpawnProcess = /** @class */ (function () {
    function SpawnProcess(appearance, pos, refrId, callback) {
        var _this = this;
        this.callback = callback;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        refr.setPosition.apply(refr, pos).then(function () { return _this.enable(appearance, refrId); });
    }
    SpawnProcess.prototype.enable = function (appearance, refrId) {
        var _this = this;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (ac && appearance) {
            (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_1__.applyTints)(ac, appearance);
        }
        refr.enable(false).then(function () { return _this.resurrect(refrId); });
    };
    SpawnProcess.prototype.resurrect = function (refrId) {
        var _this = this;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (ac) {
            return ac.resurrect().then(function () {
                _this.callback();
            });
        }
        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.dealWithRef(refr, refr.getBaseObject());
        return refr.setMotionType(4 /* MotionType.Keyframed */, true).then(this.callback);
    };
    return SpawnProcess;
}());



/***/ }),

/***/ "./src/view/worldView.ts":
/*!*******************************!*\
  !*** ./src/view/worldView.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WorldView: () => (/* binding */ WorldView)
/* harmony export */ });
/* harmony import */ var _formViewArray__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./formViewArray */ "./src/view/formViewArray.ts");
/* harmony import */ var _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./playerCharacterDataHolder */ "./src/view/playerCharacterDataHolder.ts");
/* harmony import */ var _services_services_clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../logging */ "./src/logging.ts");
/* harmony import */ var _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../services/services/singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../services/services/remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();






var WorldView = /** @class */ (function (_super) {
    __extends(WorldView, _super);
    function WorldView(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on("update", function () { return _this.onUpdate(); });
        controller.once("update", function () { return _this.onceUpdate(); });
        _this.state = _this.makeEmptyState();
        var oldView = _this.sp.storage["view"];
        // can't use instanceof here because each hot reload creates a new class
        _this.oldView = typeof oldView === "object" ? oldView : undefined;
        _this.sp.storage["view"] = _this;
        return _this;
    }
    WorldView.prototype.getRemoteRefrId = function (clientsideRefrId) {
        return this.state.formViews.getRemoteRefrId(clientsideRefrId);
    };
    WorldView.prototype.getLocalRefrId = function (remoteRefrId) {
        return this.state.formViews.getLocalRefrId(remoteRefrId);
    };
    WorldView.prototype.syncFormArray = function (model) {
        var settings = this.sp.settings;
        var showMe = settings['skymp5-client']['show-me'];
        this.state.formViews.syncFormView(model, !!showMe);
    };
    WorldView.prototype.destroy = function () {
        this.state.formViews.resize(0);
        this.state.cloneFormViews.resize(0); // Recenrly added, not tested if it's needed
        this.state = this.makeEmptyState();
    };
    WorldView.prototype.getFormViews = function () {
        return this.state.formViews;
    };
    WorldView.prototype.onUpdate = function () {
        this.resetAllFormViewsIfPlayerChangedWorld();
        var singlePlayerService = this.controller.lookupListener(_services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_4__.SinglePlayerService);
        if (!singlePlayerService.isSinglePlayer) {
            var modelSource = this.controller.lookupListener(_services_services_remoteServer__WEBPACK_IMPORTED_MODULE_5__.RemoteServer);
            this.updateWorld(modelSource.getWorldModel());
        }
    };
    WorldView.prototype.onceUpdate = function () {
        if (this.oldView) {
            this.oldView.destroy();
            this.oldView = undefined;
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Previous View destroyed');
        }
        this.waitGameTimeAndAllowFormViewUpdate(1.0);
    };
    WorldView.prototype.resetAllFormViewsIfPlayerChangedWorld = function () {
        var state = this.state;
        var pc = this.sp.Game.getPlayer();
        var pcWorldOrCell = (pc.getWorldSpace() || pc.getParentCell()).getFormID();
        if (state.pcWorldOrCell !== pcWorldOrCell) {
            if (state.pcWorldOrCell) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Reset all form views');
                state.formViews.resize(0);
                state.cloneFormViews.resize(0);
            }
            state.pcWorldOrCell = pcWorldOrCell;
        }
    };
    // Work around showRaceMenu issue
    // Default nord in Race Menu will have very ugly face
    // If other players are spawning when we show this menu
    // TODO: separate listener
    WorldView.prototype.waitGameTimeAndAllowFormViewUpdate = function (seconds) {
        var _this = this;
        // Wait 1s game time (time spent in Race Menu isn't counted)
        this.sp.Utility.wait(seconds).then(function () {
            _this.state.allowUpdate = true;
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(_this, 'Update is now allowed');
        });
    };
    WorldView.prototype.setFormViewUpdateAllowed = function (allowed) {
        this.state.allowUpdate = allowed;
        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Update is now', allowed ? 'allowed' : 'disallowed');
    };
    WorldView.prototype.updateWorld = function (model) {
        var settings = this.sp.settings;
        var state = this.state;
        if (!state.allowUpdate) {
            model = {
                forms: [],
                playerCharacterFormIdx: model.playerCharacterFormIdx,
                playerCharacterRefrId: model.playerCharacterRefrId
            };
        }
        var skipUpdates = settings['skymp5-client']['skipUpdates'];
        // skip 50% of updates if specified in the settings
        state.counter = !state.counter;
        if (state.counter && skipUpdates) {
            return;
        }
        state.formViews.resize(model.forms.length);
        var showMe = settings['skymp5-client']['show-me'];
        var showClones = settings['skymp5-client']['show-clones'];
        _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_1__.PlayerCharacterDataHolder.updateData();
        state.formViews.updateAll(model, !!showMe, false);
        if (showClones) {
            state.cloneFormViews.updateAll(model, false, true);
        }
        else {
            state.cloneFormViews.resize(0);
        }
    };
    WorldView.prototype.makeEmptyState = function () {
        return {
            formViews: new _formViewArray__WEBPACK_IMPORTED_MODULE_0__.FormViewArray(),
            cloneFormViews: new _formViewArray__WEBPACK_IMPORTED_MODULE_0__.FormViewArray(),
            allowUpdate: false,
            pcWorldOrCell: 0,
            counter: false,
        };
    };
    return WorldView;
}(_services_services_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/view/worldViewMisc.ts":
/*!***********************************!*\
  !*** ./src/view/worldViewMisc.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getObjectReference: () => (/* binding */ getObjectReference),
/* harmony export */   getViewFromStorage: () => (/* binding */ getViewFromStorage),
/* harmony export */   localIdToRemoteId: () => (/* binding */ localIdToRemoteId),
/* harmony export */   remoteIdToLocalId: () => (/* binding */ remoteIdToLocalId)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/remoteServer */ "./src/services/services/remoteServer.ts");



var getViewFromStorage = function () {
    var res = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["view"];
    // can't use instanceof here because each hot reload creates a new class
    if (typeof res === "object") {
        return res;
    }
    return undefined;
};
var localIdToRemoteId = function (localFormId, newCast) {
    if (newCast === void 0) { newCast = false; }
    if (newCast && localFormId == 0x14) {
        return _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_remoteServer__WEBPACK_IMPORTED_MODULE_2__.RemoteServer).getMyRemoteRefrId();
    }
    if (localFormId >= 0xff000000) {
        var view = getViewFromStorage();
        if (!view) {
            return 0;
        }
        localFormId = view.getRemoteRefrId(localFormId);
        if (!localFormId) {
            return 0;
        }
        // serverside ids are 64bit
        if (localFormId >= 0x100000000) {
            localFormId -= 0x100000000;
        }
    }
    return localFormId;
};
var remoteIdToLocalId = function (remoteFormId) {
    if (remoteFormId >= 0xff000000) {
        var view = getViewFromStorage();
        if (!view) {
            return 0;
        }
        remoteFormId = view.getLocalRefrId(remoteFormId);
        if (!remoteFormId) {
            return 0;
        }
    }
    return remoteFormId;
};
var getObjectReference = function (i) {
    var view = getViewFromStorage();
    if (view) {
        var formView = view.getFormViews().getNthFormView(i);
        if (formView) {
            var refrId = formView.getLocalRefrId();
            if (refrId > 0) {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
                if (refr !== null) {
                    return refr;
                }
            }
        }
    }
    return null;
};


/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "inspector":
/*!****************************!*\
  !*** external "inspector" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("inspector");

/***/ }),

/***/ "node:crypto":
/*!******************************!*\
  !*** external "node:crypto" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:crypto");

/***/ }),

/***/ "skyrimPlatform":
/*!***********************************!*\
  !*** external ["skyrimPlatform"] ***!
  \***********************************/
/***/ ((module) => {

module.exports = skyrimPlatform;

/***/ }),

/***/ "./node_modules/eventemitter3/index.mjs":
/*!**********************************************!*\
  !*** ./node_modules/eventemitter3/index.mjs ***!
  \**********************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EventEmitter: () => (/* reexport default export from named module */ _index_js__WEBPACK_IMPORTED_MODULE_0__),
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony import */ var _index_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index.js */ "./node_modules/eventemitter3/index.js");



/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (_index_js__WEBPACK_IMPORTED_MODULE_0__);


/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/compat get default export */
/******/ 	(() => {
/******/ 		// getDefaultExport function for compatibility with non-harmony modules
/******/ 		__webpack_require__.n = (module) => {
/******/ 			var getter = module && module.__esModule ?
/******/ 				() => (module['default']) :
/******/ 				() => (module);
/******/ 			__webpack_require__.d(getter, { a: getter });
/******/ 			return getter;
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _services_services_skympClient__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./services/services/skympClient */ "./src/services/services/skympClient.ts");
/* harmony import */ var _services_services_blockPapyrusEventsService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./services/services/blockPapyrusEventsService */ "./src/services/services/blockPapyrusEventsService.ts");
/* harmony import */ var _services_services_enforceLimitationsService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./services/services/enforceLimitationsService */ "./src/services/services/enforceLimitationsService.ts");
/* harmony import */ var _services_services_loadGameService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./services/services/loadGameService */ "./src/services/services/loadGameService.ts");
/* harmony import */ var _services_services_sendInputsService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./services/services/sendInputsService */ "./src/services/services/sendInputsService.ts");
/* harmony import */ var _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./services/services/singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_timeService__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./services/services/timeService */ "./src/services/services/timeService.ts");
/* harmony import */ var _services_services_spVersionCheckService__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./services/services/spVersionCheckService */ "./src/services/services/spVersionCheckService.ts");
/* harmony import */ var _services_services_consoleCommandsService__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./services/services/consoleCommandsService */ "./src/services/services/consoleCommandsService.ts");
/* harmony import */ var _services_services_lastInvService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./services/services/lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _services_services_activationService__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./services/services/activationService */ "./src/services/services/activationService.ts");
/* harmony import */ var _services_services_craftService__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./services/services/craftService */ "./src/services/services/craftService.ts");
/* harmony import */ var _services_services_dropItemService__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./services/services/dropItemService */ "./src/services/services/dropItemService.ts");
/* harmony import */ var _services_services_hitService__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ./services/services/hitService */ "./src/services/services/hitService.ts");
/* harmony import */ var _services_services_ragdollService__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./services/services/ragdollService */ "./src/services/services/ragdollService.ts");
/* harmony import */ var _services_services_deathService__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ./services/services/deathService */ "./src/services/services/deathService.ts");
/* harmony import */ var _services_services_containersService__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./services/services/containersService */ "./src/services/services/containersService.ts");
/* harmony import */ var _services_services_networkingService__WEBPACK_IMPORTED_MODULE_19__ = __webpack_require__(/*! ./services/services/networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_20__ = __webpack_require__(/*! ./services/services/remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _services_services_spSnippetService__WEBPACK_IMPORTED_MODULE_21__ = __webpack_require__(/*! ./services/services/spSnippetService */ "./src/services/services/spSnippetService.ts");
/* harmony import */ var _services_services_sweetTaffyDynamicPerksService__WEBPACK_IMPORTED_MODULE_22__ = __webpack_require__(/*! ./services/services/sweetTaffyDynamicPerksService */ "./src/services/services/sweetTaffyDynamicPerksService.ts");
/* harmony import */ var _services_services_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_23__ = __webpack_require__(/*! ./services/services/sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _services_services_sweetTaffyStaticPerksService__WEBPACK_IMPORTED_MODULE_24__ = __webpack_require__(/*! ./services/services/sweetTaffyStaticPerksService */ "./src/services/services/sweetTaffyStaticPerksService.ts");
/* harmony import */ var _services_services_disableSkillAdvanceService__WEBPACK_IMPORTED_MODULE_25__ = __webpack_require__(/*! ./services/services/disableSkillAdvanceService */ "./src/services/services/disableSkillAdvanceService.ts");
/* harmony import */ var _services_services_disableFastTravelService__WEBPACK_IMPORTED_MODULE_26__ = __webpack_require__(/*! ./services/services/disableFastTravelService */ "./src/services/services/disableFastTravelService.ts");
/* harmony import */ var _services_services_disableDifficultySelectionService__WEBPACK_IMPORTED_MODULE_27__ = __webpack_require__(/*! ./services/services/disableDifficultySelectionService */ "./src/services/services/disableDifficultySelectionService.ts");
/* harmony import */ var _services_services_sweetTaffyPlayerCombatService__WEBPACK_IMPORTED_MODULE_28__ = __webpack_require__(/*! ./services/services/sweetTaffyPlayerCombatService */ "./src/services/services/sweetTaffyPlayerCombatService.ts");
/* harmony import */ var _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_29__ = __webpack_require__(/*! ./services/services/worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _services_services_sweetTaffySkillMenuService__WEBPACK_IMPORTED_MODULE_30__ = __webpack_require__(/*! ./services/services/sweetTaffySkillMenuService */ "./src/services/services/sweetTaffySkillMenuService.ts");
/* harmony import */ var _services_services_loadOrderVerificationService__WEBPACK_IMPORTED_MODULE_31__ = __webpack_require__(/*! ./services/services/loadOrderVerificationService */ "./src/services/services/loadOrderVerificationService.ts");
/* harmony import */ var _services_services_browserService__WEBPACK_IMPORTED_MODULE_32__ = __webpack_require__(/*! ./services/services/browserService */ "./src/services/services/browserService.ts");
/* harmony import */ var _services_services_authService__WEBPACK_IMPORTED_MODULE_33__ = __webpack_require__(/*! ./services/services/authService */ "./src/services/services/authService.ts");
/* harmony import */ var _services_services_characterSelectService__WEBPACK_IMPORTED_MODULE_34__ = __webpack_require__(/*! ./services/services/characterSelectService */ "./src/services/services/characterSelectService.ts");
/* harmony import */ var _services_services_netInfoService__WEBPACK_IMPORTED_MODULE_35__ = __webpack_require__(/*! ./services/services/netInfoService */ "./src/services/services/netInfoService.ts");
/* harmony import */ var _services_services_animDebugService__WEBPACK_IMPORTED_MODULE_36__ = __webpack_require__(/*! ./services/services/animDebugService */ "./src/services/services/animDebugService.ts");
/* harmony import */ var _services_services_timersService__WEBPACK_IMPORTED_MODULE_37__ = __webpack_require__(/*! ./services/services/timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _services_services_playerBowShotService__WEBPACK_IMPORTED_MODULE_38__ = __webpack_require__(/*! ./services/services/playerBowShotService */ "./src/services/services/playerBowShotService.ts");
/* harmony import */ var _services_services_gamemodeEventSourceService__WEBPACK_IMPORTED_MODULE_39__ = __webpack_require__(/*! ./services/services/gamemodeEventSourceService */ "./src/services/services/gamemodeEventSourceService.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_40__ = __webpack_require__(/*! ./services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");
/* harmony import */ var _services_services_frontHotReloadService__WEBPACK_IMPORTED_MODULE_41__ = __webpack_require__(/*! ./services/services/frontHotReloadService */ "./src/services/services/frontHotReloadService.ts");
/* harmony import */ var _services_services_blockedAnimationsService__WEBPACK_IMPORTED_MODULE_42__ = __webpack_require__(/*! ./services/services/blockedAnimationsService */ "./src/services/services/blockedAnimationsService.ts");
/* harmony import */ var _services_services_voiceChatService__WEBPACK_IMPORTED_MODULE_43__ = __webpack_require__(/*! ./services/services/voiceChatService */ "./src/services/services/voiceChatService.ts");
/* harmony import */ var _view_worldView__WEBPACK_IMPORTED_MODULE_44__ = __webpack_require__(/*! ./view/worldView */ "./src/view/worldView.ts");
/* harmony import */ var _services_services_keyboardEventsService__WEBPACK_IMPORTED_MODULE_45__ = __webpack_require__(/*! ./services/services/keyboardEventsService */ "./src/services/services/keyboardEventsService.ts");
/* harmony import */ var _services_services_magicSyncService__WEBPACK_IMPORTED_MODULE_46__ = __webpack_require__(/*! ./services/services/magicSyncService */ "./src/services/services/magicSyncService.ts");
/* harmony import */ var _services_services_profilingService__WEBPACK_IMPORTED_MODULE_47__ = __webpack_require__(/*! ./services/services/profilingService */ "./src/services/services/profilingService.ts");
/* harmony import */ var _services_services_settingsService__WEBPACK_IMPORTED_MODULE_48__ = __webpack_require__(/*! ./services/services/settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _services_services_sweetCameraEnforcementService__WEBPACK_IMPORTED_MODULE_49__ = __webpack_require__(/*! ./services/services/sweetCameraEnforcementService */ "./src/services/services/sweetCameraEnforcementService.ts");
/* harmony import */ var _services_services_sweetTaffyNicknamesService__WEBPACK_IMPORTED_MODULE_50__ = __webpack_require__(/*! ./services/services/sweetTaffyNicknamesService */ "./src/services/services/sweetTaffyNicknamesService.ts");
/* harmony import */ var _services_services_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_51__ = __webpack_require__(/*! ./services/services/serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");





















































(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.setINIBool("bAlwaysActive:General", true);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.setGameSettingInt("iDeathDropWeaponChance", 0);
});
var main = function () {
    try {
        var controller = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__.SpApiInteractor.getControllerInstance();
        var listeners = [
            new _services_services_blockPapyrusEventsService__WEBPACK_IMPORTED_MODULE_2__.BlockPapyrusEventsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_loadGameService__WEBPACK_IMPORTED_MODULE_4__.LoadGameService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_6__.SinglePlayerService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_enforceLimitationsService__WEBPACK_IMPORTED_MODULE_3__.EnforceLimitationsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sendInputsService__WEBPACK_IMPORTED_MODULE_5__.SendInputsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_skympClient__WEBPACK_IMPORTED_MODULE_1__.SkympClient(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_timeService__WEBPACK_IMPORTED_MODULE_8__.TimeService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_spVersionCheckService__WEBPACK_IMPORTED_MODULE_9__.SpVersionCheckService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_consoleCommandsService__WEBPACK_IMPORTED_MODULE_10__.ConsoleCommandsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_lastInvService__WEBPACK_IMPORTED_MODULE_11__.LastInvService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_activationService__WEBPACK_IMPORTED_MODULE_12__.ActivationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_craftService__WEBPACK_IMPORTED_MODULE_13__.CraftService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_dropItemService__WEBPACK_IMPORTED_MODULE_14__.DropItemService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_hitService__WEBPACK_IMPORTED_MODULE_15__.HitService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_ragdollService__WEBPACK_IMPORTED_MODULE_16__.RagdollService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_deathService__WEBPACK_IMPORTED_MODULE_17__.DeathService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_containersService__WEBPACK_IMPORTED_MODULE_18__.ContainersService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_networkingService__WEBPACK_IMPORTED_MODULE_19__.NetworkingService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_20__.RemoteServer(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_spSnippetService__WEBPACK_IMPORTED_MODULE_21__.SpSnippetService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_settingsService__WEBPACK_IMPORTED_MODULE_48__.SettingsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyDynamicPerksService__WEBPACK_IMPORTED_MODULE_22__.SweetTaffyDynamicPerksService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyStaticPerksService__WEBPACK_IMPORTED_MODULE_24__.SweetTaffyStaticPerksService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_23__.SweetTaffySweetCantDropService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyPlayerCombatService__WEBPACK_IMPORTED_MODULE_28__.SweetTaffyPlayerCombatService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffySkillMenuService__WEBPACK_IMPORTED_MODULE_30__.SweetTaffySkillMenuService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetCameraEnforcementService__WEBPACK_IMPORTED_MODULE_49__.SweetCameraEnforcementService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableSkillAdvanceService__WEBPACK_IMPORTED_MODULE_25__.DisableSkillAdvanceService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableFastTravelService__WEBPACK_IMPORTED_MODULE_26__.DisableFastTravelService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableDifficultySelectionService__WEBPACK_IMPORTED_MODULE_27__.DisableDifficultySelectionService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_29__.WorldCleanerService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_loadOrderVerificationService__WEBPACK_IMPORTED_MODULE_31__.LoadOrderVerificationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_browserService__WEBPACK_IMPORTED_MODULE_32__.BrowserService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_authService__WEBPACK_IMPORTED_MODULE_33__.AuthService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_characterSelectService__WEBPACK_IMPORTED_MODULE_34__.CharacterSelectService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_netInfoService__WEBPACK_IMPORTED_MODULE_35__.NetInfoService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_animDebugService__WEBPACK_IMPORTED_MODULE_36__.AnimDebugService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_timersService__WEBPACK_IMPORTED_MODULE_37__.TimersService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_playerBowShotService__WEBPACK_IMPORTED_MODULE_38__.PlayerBowShotService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_gamemodeEventSourceService__WEBPACK_IMPORTED_MODULE_39__.GamemodeEventSourceService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_40__.GamemodeUpdateService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_frontHotReloadService__WEBPACK_IMPORTED_MODULE_41__.FrontHotReloadService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_blockedAnimationsService__WEBPACK_IMPORTED_MODULE_42__.BlockedAnimationsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_voiceChatService__WEBPACK_IMPORTED_MODULE_43__.VoiceChatService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _view_worldView__WEBPACK_IMPORTED_MODULE_44__.WorldView(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_keyboardEventsService__WEBPACK_IMPORTED_MODULE_45__.KeyboardEventsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_magicSyncService__WEBPACK_IMPORTED_MODULE_46__.MagicSyncService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_profilingService__WEBPACK_IMPORTED_MODULE_47__.ProfilingService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyNicknamesService__WEBPACK_IMPORTED_MODULE_50__.SweetTaffyNicknamesService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_51__.ServerJsVerificationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
        ];
        _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__.SpApiInteractor.setup(listeners);
    }
    catch (e) {
        // TODO: handle setup failure. will output to game console by default
        throw e;
    }
};
// [18.08.2023]
// I saw "attempt to call hooks.add while in hook context" error
// I'm not sure if it's a C++ bug in SkyrimPlatform or an artifact of webpack+hotreload
// But let's for now ensure that "main" executes inside tick context
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("tick", main);

/******/ })()
;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQ2xDQTtBQUdxQztBQUNZO0FBQzFDO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsQ0FBQyxnREFBZ0Q7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhLGlEQUFLO0FBQ2xCO0FBQ0E7QUFDQSxZQUFZLDhEQUFjO0FBQzFCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLDhEQUFjO0FBQzFCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQkFBZ0IsbURBQU87QUFDdkI7QUFDQSxnQkFBZ0IsbURBQU87QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QUU7QUFDbkMsZ0JBQWdCLGtGQUFnQixDQUFDLDJDQUFFO0FBQ25DLGdCQUFnQixzR0FBMEIsQ0FBQywyQ0FBRTtBQUM3QyxnQkFBZ0Isd0dBQTJCLENBQUMsMkNBQUU7QUFDOUM7QUFDQSxRQUFRLHNFQUFlO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0RBQUkiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXguanMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9leHRlbnNpb25zL2Zvcm1UeXBlRXgudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvZmVhdHVyZXMvYXV0aE1vZGVsLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvbGliL2Vycm9ycy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2xpYi9pZE1hbmFnZXIudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9saWIvbmFtZW9mLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvbG9nZ2luZy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL21lc3NhZ2VzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvZXZlbnRzL2V2ZW50cy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2FjdGl2YXRpb25TZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvYW5pbURlYnVnU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2F1dGhTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvYmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Jsb2NrZWRBbmltYXRpb25zU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Jyb3dzZXJTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvY2hhcmFjdGVyU2VsZWN0U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2NsaWVudExpc3RlbmVyLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvY29uc29sZUNvbW1hbmRzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2NvbnRhaW5lcnNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvY3JhZnRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZGVhdGhTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9kcm9wSXRlbVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9lbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZnJvbnRIb3RSZWxvYWRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZ2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9nYW1lbW9kZVVwZGF0ZVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9oaXRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMva2V5Ym9hcmRFdmVudHNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvbGFzdEludlNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9sb2FkR2FtZVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9sb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvbWFnaWNTeW5jU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL25ldEluZm9TZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvbmV0d29ya2luZ1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9wbGF5ZXJCb3dTaG90U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3Byb2ZpbGluZ1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9yYWdkb2xsU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3JlbW90ZVNlcnZlci50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NlbmRJbnB1dHNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc2V0dGluZ3NTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc2luZ2xlUGxheWVyU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NreW1wQ2xpZW50LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3BTbmlwcGV0U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NwVmVyc2lvbkNoZWNrU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvdGltZVNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy90aW1lcnNTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvdm9pY2VDaGF0U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3dvcmxkQ2xlYW5lclNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zcEFwaUludGVyYWN0b3IudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL2FjdG9ydmFsdWVzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9hbmltYXRpb24udHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL2FwcGVhcmFuY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL2VxdWlwbWVudC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvaW52ZW50b3J5LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9tb3ZlbWVudEFwcGx5LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9tb3ZlbWVudEdldC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvc3BlbGwudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92ZXJzaW9uLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy9mb3JtVmlldy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvZm9ybVZpZXdBcnJheS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvaG9zdEF0dGVtcHRzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy9tb2RlbEFwcGx5VXRpbHMudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L3BsYXllckNoYXJhY3RlckRhdGFIb2xkZXIudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L3NwYXduUHJvY2Vzcy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvd29ybGRWaWV3LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy93b3JsZFZpZXdNaXNjLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvZXh0ZXJuYWwgbm9kZS1jb21tb25qcyBcImNyeXB0b1wiIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvZXh0ZXJuYWwgbm9kZS1jb21tb25qcyBcImZzXCIiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC9leHRlcm5hbCBub2RlLWNvbW1vbmpzIFwiaW5zcGVjdG9yXCIiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC9leHRlcm5hbCBub2RlLWNvbW1vbmpzIFwibm9kZTpjcnlwdG9cIiIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L2V4dGVybmFsIHZhciBbXCJza3lyaW1QbGF0Zm9ybVwiXSIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXgubWpzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC93ZWJwYWNrL3J1bnRpbWUvY29tcGF0IGdldCBkZWZhdWx0IGV4cG9ydCIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L3dlYnBhY2svcnVudGltZS9kZWZpbmUgcHJvcGVydHkgZ2V0dGVycyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L3dlYnBhY2svcnVudGltZS9oYXNPd25Qcm9wZXJ0eSBzaG9ydGhhbmQiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC93ZWJwYWNrL3J1bnRpbWUvbWFrZSBuYW1lc3BhY2Ugb2JqZWN0Iiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgaGFzID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eVxuICAsIHByZWZpeCA9ICd+JztcblxuLyoqXG4gKiBDb25zdHJ1Y3RvciB0byBjcmVhdGUgYSBzdG9yYWdlIGZvciBvdXIgYEVFYCBvYmplY3RzLlxuICogQW4gYEV2ZW50c2AgaW5zdGFuY2UgaXMgYSBwbGFpbiBvYmplY3Qgd2hvc2UgcHJvcGVydGllcyBhcmUgZXZlbnQgbmFtZXMuXG4gKlxuICogQGNvbnN0cnVjdG9yXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBFdmVudHMoKSB7fVxuXG4vL1xuLy8gV2UgdHJ5IHRvIG5vdCBpbmhlcml0IGZyb20gYE9iamVjdC5wcm90b3R5cGVgLiBJbiBzb21lIGVuZ2luZXMgY3JlYXRpbmcgYW5cbi8vIGluc3RhbmNlIGluIHRoaXMgd2F5IGlzIGZhc3RlciB0aGFuIGNhbGxpbmcgYE9iamVjdC5jcmVhdGUobnVsbClgIGRpcmVjdGx5LlxuLy8gSWYgYE9iamVjdC5jcmVhdGUobnVsbClgIGlzIG5vdCBzdXBwb3J0ZWQgd2UgcHJlZml4IHRoZSBldmVudCBuYW1lcyB3aXRoIGFcbi8vIGNoYXJhY3RlciB0byBtYWtlIHN1cmUgdGhhdCB0aGUgYnVpbHQtaW4gb2JqZWN0IHByb3BlcnRpZXMgYXJlIG5vdFxuLy8gb3ZlcnJpZGRlbiBvciB1c2VkIGFzIGFuIGF0dGFjayB2ZWN0b3IuXG4vL1xuaWYgKE9iamVjdC5jcmVhdGUpIHtcbiAgRXZlbnRzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgLy9cbiAgLy8gVGhpcyBoYWNrIGlzIG5lZWRlZCBiZWNhdXNlIHRoZSBgX19wcm90b19fYCBwcm9wZXJ0eSBpcyBzdGlsbCBpbmhlcml0ZWQgaW5cbiAgLy8gc29tZSBvbGQgYnJvd3NlcnMgbGlrZSBBbmRyb2lkIDQsIGlQaG9uZSA1LjEsIE9wZXJhIDExIGFuZCBTYWZhcmkgNS5cbiAgLy9cbiAgaWYgKCFuZXcgRXZlbnRzKCkuX19wcm90b19fKSBwcmVmaXggPSBmYWxzZTtcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRhdGlvbiBvZiBhIHNpbmdsZSBldmVudCBsaXN0ZW5lci5cbiAqXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbGlzdGVuZXIgZnVuY3Rpb24uXG4gKiBAcGFyYW0geyp9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciB3aXRoLlxuICogQHBhcmFtIHtCb29sZWFufSBbb25jZT1mYWxzZV0gU3BlY2lmeSBpZiB0aGUgbGlzdGVuZXIgaXMgYSBvbmUtdGltZSBsaXN0ZW5lci5cbiAqIEBjb25zdHJ1Y3RvclxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gRUUoZm4sIGNvbnRleHQsIG9uY2UpIHtcbiAgdGhpcy5mbiA9IGZuO1xuICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICB0aGlzLm9uY2UgPSBvbmNlIHx8IGZhbHNlO1xufVxuXG4vKipcbiAqIEFkZCBhIGxpc3RlbmVyIGZvciBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7RXZlbnRFbWl0dGVyfSBlbWl0dGVyIFJlZmVyZW5jZSB0byB0aGUgYEV2ZW50RW1pdHRlcmAgaW5zdGFuY2UuXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbGlzdGVuZXIgZnVuY3Rpb24uXG4gKiBAcGFyYW0geyp9IGNvbnRleHQgVGhlIGNvbnRleHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciB3aXRoLlxuICogQHBhcmFtIHtCb29sZWFufSBvbmNlIFNwZWNpZnkgaWYgdGhlIGxpc3RlbmVyIGlzIGEgb25lLXRpbWUgbGlzdGVuZXIuXG4gKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfVxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gYWRkTGlzdGVuZXIoZW1pdHRlciwgZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7XG4gIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7XG4gIH1cblxuICB2YXIgbGlzdGVuZXIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSlcbiAgICAsIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7XG5cbiAgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XSkgZW1pdHRlci5fZXZlbnRzW2V2dF0gPSBsaXN0ZW5lciwgZW1pdHRlci5fZXZlbnRzQ291bnQrKztcbiAgZWxzZSBpZiAoIWVtaXR0ZXIuX2V2ZW50c1tldnRdLmZuKSBlbWl0dGVyLl9ldmVudHNbZXZ0XS5wdXNoKGxpc3RlbmVyKTtcbiAgZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXJdO1xuXG4gIHJldHVybiBlbWl0dGVyO1xufVxuXG4vKipcbiAqIENsZWFyIGV2ZW50IGJ5IG5hbWUuXG4gKlxuICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgUmVmZXJlbmNlIHRvIHRoZSBgRXZlbnRFbWl0dGVyYCBpbnN0YW5jZS5cbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldnQgVGhlIEV2ZW50IG5hbWUuXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBjbGVhckV2ZW50KGVtaXR0ZXIsIGV2dCkge1xuICBpZiAoLS1lbWl0dGVyLl9ldmVudHNDb3VudCA9PT0gMCkgZW1pdHRlci5fZXZlbnRzID0gbmV3IEV2ZW50cygpO1xuICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTtcbn1cblxuLyoqXG4gKiBNaW5pbWFsIGBFdmVudEVtaXR0ZXJgIGludGVyZmFjZSB0aGF0IGlzIG1vbGRlZCBhZ2FpbnN0IHRoZSBOb2RlLmpzXG4gKiBgRXZlbnRFbWl0dGVyYCBpbnRlcmZhY2UuXG4gKlxuICogQGNvbnN0cnVjdG9yXG4gKiBAcHVibGljXG4gKi9cbmZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHtcbiAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpO1xuICB0aGlzLl9ldmVudHNDb3VudCA9IDA7XG59XG5cbi8qKlxuICogUmV0dXJuIGFuIGFycmF5IGxpc3RpbmcgdGhlIGV2ZW50cyBmb3Igd2hpY2ggdGhlIGVtaXR0ZXIgaGFzIHJlZ2lzdGVyZWRcbiAqIGxpc3RlbmVycy5cbiAqXG4gKiBAcmV0dXJucyB7QXJyYXl9XG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7XG4gIHZhciBuYW1lcyA9IFtdXG4gICAgLCBldmVudHNcbiAgICAsIG5hbWU7XG5cbiAgaWYgKHRoaXMuX2V2ZW50c0NvdW50ID09PSAwKSByZXR1cm4gbmFtZXM7XG5cbiAgZm9yIChuYW1lIGluIChldmVudHMgPSB0aGlzLl9ldmVudHMpKSB7XG4gICAgaWYgKGhhcy5jYWxsKGV2ZW50cywgbmFtZSkpIG5hbWVzLnB1c2gocHJlZml4ID8gbmFtZS5zbGljZSgxKSA6IG5hbWUpO1xuICB9XG5cbiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHtcbiAgICByZXR1cm4gbmFtZXMuY29uY2F0KE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZXZlbnRzKSk7XG4gIH1cblxuICByZXR1cm4gbmFtZXM7XG59O1xuXG4vKipcbiAqIFJldHVybiB0aGUgbGlzdGVuZXJzIHJlZ2lzdGVyZWQgZm9yIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHJldHVybnMge0FycmF5fSBUaGUgcmVnaXN0ZXJlZCBsaXN0ZW5lcnMuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50KSB7XG4gIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50XG4gICAgLCBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdO1xuXG4gIGlmICghaGFuZGxlcnMpIHJldHVybiBbXTtcbiAgaWYgKGhhbmRsZXJzLmZuKSByZXR1cm4gW2hhbmRsZXJzLmZuXTtcblxuICBmb3IgKHZhciBpID0gMCwgbCA9IGhhbmRsZXJzLmxlbmd0aCwgZWUgPSBuZXcgQXJyYXkobCk7IGkgPCBsOyBpKyspIHtcbiAgICBlZVtpXSA9IGhhbmRsZXJzW2ldLmZuO1xuICB9XG5cbiAgcmV0dXJuIGVlO1xufTtcblxuLyoqXG4gKiBSZXR1cm4gdGhlIG51bWJlciBvZiBsaXN0ZW5lcnMgbGlzdGVuaW5nIHRvIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHJldHVybnMge051bWJlcn0gVGhlIG51bWJlciBvZiBsaXN0ZW5lcnMuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uIGxpc3RlbmVyQ291bnQoZXZlbnQpIHtcbiAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnRcbiAgICAsIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdO1xuXG4gIGlmICghbGlzdGVuZXJzKSByZXR1cm4gMDtcbiAgaWYgKGxpc3RlbmVycy5mbikgcmV0dXJuIDE7XG4gIHJldHVybiBsaXN0ZW5lcnMubGVuZ3RoO1xufTtcblxuLyoqXG4gKiBDYWxscyBlYWNoIG9mIHRoZSBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBmb3IgYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcmV0dXJucyB7Qm9vbGVhbn0gYHRydWVgIGlmIHRoZSBldmVudCBoYWQgbGlzdGVuZXJzLCBlbHNlIGBmYWxzZWAuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkge1xuICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDtcblxuICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gZmFsc2U7XG5cbiAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdXG4gICAgLCBsZW4gPSBhcmd1bWVudHMubGVuZ3RoXG4gICAgLCBhcmdzXG4gICAgLCBpO1xuXG4gIGlmIChsaXN0ZW5lcnMuZm4pIHtcbiAgICBpZiAobGlzdGVuZXJzLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVycy5mbiwgdW5kZWZpbmVkLCB0cnVlKTtcblxuICAgIHN3aXRjaCAobGVuKSB7XG4gICAgICBjYXNlIDE6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCksIHRydWU7XG4gICAgICBjYXNlIDI6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEpLCB0cnVlO1xuICAgICAgY2FzZSAzOiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiksIHRydWU7XG4gICAgICBjYXNlIDQ6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMyksIHRydWU7XG4gICAgICBjYXNlIDU6IHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMywgYTQpLCB0cnVlO1xuICAgICAgY2FzZSA2OiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0LCBhNSksIHRydWU7XG4gICAgfVxuXG4gICAgZm9yIChpID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLTEpOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldO1xuICAgIH1cblxuICAgIGxpc3RlbmVycy5mbi5hcHBseShsaXN0ZW5lcnMuY29udGV4dCwgYXJncyk7XG4gIH0gZWxzZSB7XG4gICAgdmFyIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGhcbiAgICAgICwgajtcblxuICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnNbaV0uZm4sIHVuZGVmaW5lZCwgdHJ1ZSk7XG5cbiAgICAgIHN3aXRjaCAobGVuKSB7XG4gICAgICAgIGNhc2UgMTogbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQpOyBicmVhaztcbiAgICAgICAgY2FzZSAyOiBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEpOyBicmVhaztcbiAgICAgICAgY2FzZSAzOiBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEsIGEyKTsgYnJlYWs7XG4gICAgICAgIGNhc2UgNDogbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMiwgYTMpOyBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBpZiAoIWFyZ3MpIGZvciAoaiA9IDEsIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0xKTsgaiA8IGxlbjsgaisrKSB7XG4gICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uYXBwbHkobGlzdGVuZXJzW2ldLmNvbnRleHQsIGFyZ3MpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufTtcblxuLyoqXG4gKiBBZGQgYSBsaXN0ZW5lciBmb3IgYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbGlzdGVuZXIgZnVuY3Rpb24uXG4gKiBAcGFyYW0geyp9IFtjb250ZXh0PXRoaXNdIFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC5cbiAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIG9uKGV2ZW50LCBmbiwgY29udGV4dCkge1xuICByZXR1cm4gYWRkTGlzdGVuZXIodGhpcywgZXZlbnQsIGZuLCBjb250ZXh0LCBmYWxzZSk7XG59O1xuXG4vKipcbiAqIEFkZCBhIG9uZS10aW1lIGxpc3RlbmVyIGZvciBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi5cbiAqIEBwYXJhbSB7Kn0gW2NvbnRleHQ9dGhpc10gVGhlIGNvbnRleHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciB3aXRoLlxuICogQHJldHVybnMge0V2ZW50RW1pdHRlcn0gYHRoaXNgLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiBvbmNlKGV2ZW50LCBmbiwgY29udGV4dCkge1xuICByZXR1cm4gYWRkTGlzdGVuZXIodGhpcywgZXZlbnQsIGZuLCBjb250ZXh0LCB0cnVlKTtcbn07XG5cbi8qKlxuICogUmVtb3ZlIHRoZSBsaXN0ZW5lcnMgb2YgYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBPbmx5IHJlbW92ZSB0aGUgbGlzdGVuZXJzIHRoYXQgbWF0Y2ggdGhpcyBmdW5jdGlvbi5cbiAqIEBwYXJhbSB7Kn0gY29udGV4dCBPbmx5IHJlbW92ZSB0aGUgbGlzdGVuZXJzIHRoYXQgaGF2ZSB0aGlzIGNvbnRleHQuXG4gKiBAcGFyYW0ge0Jvb2xlYW59IG9uY2UgT25seSByZW1vdmUgb25lLXRpbWUgbGlzdGVuZXJzLlxuICogQHJldHVybnMge0V2ZW50RW1pdHRlcn0gYHRoaXNgLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7XG4gIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50O1xuXG4gIGlmICghdGhpcy5fZXZlbnRzW2V2dF0pIHJldHVybiB0aGlzO1xuICBpZiAoIWZuKSB7XG4gICAgY2xlYXJFdmVudCh0aGlzLCBldnQpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdO1xuXG4gIGlmIChsaXN0ZW5lcnMuZm4pIHtcbiAgICBpZiAoXG4gICAgICBsaXN0ZW5lcnMuZm4gPT09IGZuICYmXG4gICAgICAoIW9uY2UgfHwgbGlzdGVuZXJzLm9uY2UpICYmXG4gICAgICAoIWNvbnRleHQgfHwgbGlzdGVuZXJzLmNvbnRleHQgPT09IGNvbnRleHQpXG4gICAgKSB7XG4gICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGxpc3RlbmVyc1tpXS5mbiAhPT0gZm4gfHxcbiAgICAgICAgKG9uY2UgJiYgIWxpc3RlbmVyc1tpXS5vbmNlKSB8fFxuICAgICAgICAoY29udGV4dCAmJiBsaXN0ZW5lcnNbaV0uY29udGV4dCAhPT0gY29udGV4dClcbiAgICAgICkge1xuICAgICAgICBldmVudHMucHVzaChsaXN0ZW5lcnNbaV0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgLy8gUmVzZXQgdGhlIGFycmF5LCBvciByZW1vdmUgaXQgY29tcGxldGVseSBpZiB3ZSBoYXZlIG5vIG1vcmUgbGlzdGVuZXJzLlxuICAgIC8vXG4gICAgaWYgKGV2ZW50cy5sZW5ndGgpIHRoaXMuX2V2ZW50c1tldnRdID0gZXZlbnRzLmxlbmd0aCA9PT0gMSA/IGV2ZW50c1swXSA6IGV2ZW50cztcbiAgICBlbHNlIGNsZWFyRXZlbnQodGhpcywgZXZ0KTtcbiAgfVxuXG4gIHJldHVybiB0aGlzO1xufTtcblxuLyoqXG4gKiBSZW1vdmUgYWxsIGxpc3RlbmVycywgb3IgdGhvc2Ugb2YgdGhlIHNwZWNpZmllZCBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gW2V2ZW50XSBUaGUgZXZlbnQgbmFtZS5cbiAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnQpIHtcbiAgdmFyIGV2dDtcblxuICBpZiAoZXZlbnQpIHtcbiAgICBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50O1xuICAgIGlmICh0aGlzLl9ldmVudHNbZXZ0XSkgY2xlYXJFdmVudCh0aGlzLCBldnQpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTtcbiAgICB0aGlzLl9ldmVudHNDb3VudCA9IDA7XG4gIH1cblxuICByZXR1cm4gdGhpcztcbn07XG5cbi8vXG4vLyBBbGlhcyBtZXRob2RzIG5hbWVzIGJlY2F1c2UgcGVvcGxlIHJvbGwgbGlrZSB0aGF0LlxuLy9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUub2ZmID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjtcbkV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uO1xuXG4vL1xuLy8gRXhwb3NlIHRoZSBwcmVmaXguXG4vL1xuRXZlbnRFbWl0dGVyLnByZWZpeGVkID0gcHJlZml4O1xuXG4vL1xuLy8gQWxsb3cgYEV2ZW50RW1pdHRlcmAgdG8gYmUgaW1wb3J0ZWQgYXMgbW9kdWxlIG5hbWVzcGFjZS5cbi8vXG5FdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyO1xuXG4vL1xuLy8gRXhwb3NlIHRoZSBtb2R1bGUuXG4vL1xuaWYgKCd1bmRlZmluZWQnICE9PSB0eXBlb2YgbW9kdWxlKSB7XG4gIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyO1xufVxuIiwidmFyIEZvcm1UeXBlRXggPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBGb3JtVHlwZUV4KCkge1xyXG4gICAgfVxyXG4gICAgRm9ybVR5cGVFeC5pc0l0ZW0gPSBmdW5jdGlvbiAodHlwZSkge1xyXG4gICAgICAgIHJldHVybiB0eXBlID09PSA0MiAvKiBGb3JtVHlwZS5BbW1vICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDI2IC8qIEZvcm1UeXBlLkFybW9yICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDI3IC8qIEZvcm1UeXBlLkJvb2sgKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMzAgLyogRm9ybVR5cGUuSW5ncmVkaWVudCAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAzMSAvKiBGb3JtVHlwZS5MaWdodCAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSA0NiAvKiBGb3JtVHlwZS5Qb3Rpb24gKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMjMgLyogRm9ybVR5cGUuU2Nyb2xsSXRlbSAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSA1MiAvKiBGb3JtVHlwZS5Tb3VsR2VtICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDQxIC8qIEZvcm1UeXBlLldlYXBvbiAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAzMiAvKiBGb3JtVHlwZS5NaXNjICovO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBGb3JtVHlwZUV4O1xyXG59KCkpO1xyXG5leHBvcnQgeyBGb3JtVHlwZUV4IH07XHJcbiIsImltcG9ydCB7IEZsb3JhIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IEZvcm1UeXBlRXggfSBmcm9tIFwiLi9mb3JtVHlwZUV4XCI7XHJcbnZhciBPYmplY3RSZWZlcmVuY2VFeCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIE9iamVjdFJlZmVyZW5jZUV4KCkge1xyXG4gICAgfVxyXG4gICAgT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwgPSBmdW5jdGlvbiAoc2VsZikge1xyXG4gICAgICAgIHZhciB3b3JsZCA9IHNlbGYuZ2V0V29ybGRTcGFjZSgpO1xyXG4gICAgICAgIGlmICh3b3JsZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gd29ybGQuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBjZWxsID0gc2VsZi5nZXRQYXJlbnRDZWxsKCk7XHJcbiAgICAgICAgaWYgKGNlbGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNlbGwuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgfTtcclxuICAgIE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyA9IGZ1bmN0aW9uIChzZWxmKSB7XHJcbiAgICAgICAgcmV0dXJuIFtzZWxmLmdldFBvc2l0aW9uWCgpLCBzZWxmLmdldFBvc2l0aW9uWSgpLCBzZWxmLmdldFBvc2l0aW9uWigpXTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZSA9IGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgdmFyIGRlbHRhWCA9IGFbMF0gLSBiWzBdO1xyXG4gICAgICAgIHZhciBkZWx0YVkgPSBhWzFdIC0gYlsxXTtcclxuICAgICAgICB2YXIgZGVsdGFaID0gYVsyXSAtIGJbMl07XHJcbiAgICAgICAgcmV0dXJuIE1hdGguc3FydChkZWx0YVggKiBkZWx0YVggKyBkZWx0YVkgKiBkZWx0YVkgKyBkZWx0YVogKiBkZWx0YVopO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlTm9aID0gZnVuY3Rpb24gKGEsIGIpIHtcclxuICAgICAgICB2YXIgZGVsdGFYID0gYVswXSAtIGJbMF07XHJcbiAgICAgICAgdmFyIGRlbHRhWSA9IGFbMV0gLSBiWzFdO1xyXG4gICAgICAgIHJldHVybiBNYXRoLnNxcnQoZGVsdGFYICogZGVsdGFYICsgZGVsdGFZICogZGVsdGFZKTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBPYmplY3RSZWZlcmVuY2VFeC5kZWFsV2l0aFJlZiA9IGZ1bmN0aW9uIChzZWxmLCBiYXNlKSB7XHJcbiAgICAgICAgdmFyIF9hLCBfYjtcclxuICAgICAgICB2YXIgdCA9IGJhc2UuZ2V0VHlwZSgpO1xyXG4gICAgICAgIHZhciBpc0l0ZW0gPSBGb3JtVHlwZUV4LmlzSXRlbSh0KTtcclxuICAgICAgICAvLyBCbGFja0ZhbGxzQmFycm93MDIsIGRvb3IgaXNuJ3Qgb3BlbmluZyB2aWEgU2V0T3BlbiBzbyB3ZSdyZSBoYWNraW5nIGl0LlxyXG4gICAgICAgIC8vIE5vdCBibG9ja2luZyBhY3RpdmF0aW9uICYgYXNraW5nIHBhcmVudCB0byBhY3RpdmF0ZSB1bnRpbCB3aWxsIGJlIGluIHRoZSBjb3JyZWN0IHN0YXRlXHJcbiAgICAgICAgLy8gU2VlIGFsc28gbW9kZWxBcHBseVV0aWxzLnRzXHJcbiAgICAgICAgdmFyIGNhdmVHU2VjcmV0RG9vcjAxID0gMHg2ZjcwMztcclxuICAgICAgICAvLyBZb3UgY2FuIGFsc28gYmxvY2sgZm9yIHQgPT09IEZvcm1UeXBlLkZsb3JhIHx8IHQgPT09IEZvcm1UeXBlLlRyZWUsIGJ1dCBJIGRvbid0IHRoaW5rIGl0J3MgbmVjZXNzYXJ5LlxyXG4gICAgICAgIGlmICh0ID09PSA0MCAvKiBGb3JtVHlwZS5GdXJuaXR1cmUgKi9cclxuICAgICAgICAgICAgfHwgdCA9PT0gMjQgLyogRm9ybVR5cGUuQWN0aXZhdG9yICovXHJcbiAgICAgICAgICAgIHx8IHQgPT09IDI4IC8qIEZvcm1UeXBlLkNvbnRhaW5lciAqL1xyXG4gICAgICAgICAgICB8fCBpc0l0ZW1cclxuICAgICAgICAgICAgfHwgdCA9PT0gNDMgLyogRm9ybVR5cGUuTlBDICovXHJcbiAgICAgICAgICAgIHx8ICh0ID09PSAyOSAvKiBGb3JtVHlwZS5Eb29yICovICYmICgoX2EgPSBzZWxmLmdldEJhc2VPYmplY3QoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZvcm1JRCgpKSAhPT0gY2F2ZUdTZWNyZXREb29yMDEpKSB7XHJcbiAgICAgICAgICAgIHNlbGYuYmxvY2tBY3RpdmF0aW9uKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgc2VsZi5ibG9ja0FjdGl2YXRpb24oZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2VsZi5pc0xvY2tlZCgpKSB7XHJcbiAgICAgICAgICAgIHNlbGYubG9jayhmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaXNJdGVtKSB7XHJcbiAgICAgICAgICAgIHNlbGYuc2V0TW90aW9uVHlwZSg0IC8qIE1vdGlvblR5cGUuS2V5ZnJhbWVkICovLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9za3lyaW0tbXVsdGlwbGF5ZXIvaXNzdWUtdHJhY2tlci9pc3N1ZXMvMzZcclxuICAgICAgICBpZiAodCA9PT0gMzkgLyogRm9ybVR5cGUuRmxvcmEgKi8gJiYgKChfYiA9IEZsb3JhLmZyb20oYmFzZSkpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5nZXRJbmdyZWRpZW50KCkpKSB7XHJcbiAgICAgICAgICAgIHNlbGYuc2V0TW90aW9uVHlwZSg0IC8qIE1vdGlvblR5cGUuS2V5ZnJhbWVkICovLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBPYmplY3RSZWZlcmVuY2VFeDtcclxufSgpKTtcclxuZXhwb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfTtcclxuIiwiO1xyXG47XHJcbjtcclxuZXhwb3J0IHZhciBhdXRoR2FtZURhdGFTdG9yYWdlS2V5ID0gXCJhdXRoR2FtZURhdGFcIjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBSZXNwYXduTmVlZGVkRXJyb3IgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoUmVzcGF3bk5lZWRlZEVycm9yLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gUmVzcGF3bk5lZWRlZEVycm9yKG1lc3NhZ2UpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBtZXNzYWdlKSB8fCB0aGlzO1xyXG4gICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihfdGhpcywgUmVzcGF3bk5lZWRlZEVycm9yLnByb3RvdHlwZSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFJlc3Bhd25OZWVkZWRFcnJvcjtcclxufShFcnJvcikpO1xyXG5leHBvcnQgeyBSZXNwYXduTmVlZGVkRXJyb3IgfTtcclxudmFyIE5ldmVyRXJyb3IgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTmV2ZXJFcnJvciwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIE5ldmVyRXJyb3IobWVzc2FnZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIFwiTmV2ZXJFcnJvcjogXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKSkgfHwgdGhpcztcclxuICAgICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoX3RoaXMsIE5ldmVyRXJyb3IucHJvdG90eXBlKTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gTmV2ZXJFcnJvcjtcclxufShFcnJvcikpO1xyXG5leHBvcnQgeyBOZXZlckVycm9yIH07XHJcbiIsInZhciBJZE1hbmFnZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBJZE1hbmFnZXIoKSB7XHJcbiAgICAgICAgdGhpcy5pZEJ5VmFsdWUgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICB0aGlzLnZhbHVlQnlJZCA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIHRoaXMubWluaW11bVVudXNlZElkID0gMDtcclxuICAgIH1cclxuICAgIElkTWFuYWdlci5wcm90b3R5cGUuYWxsb2NhdGVJZEZvciA9IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlkQnlWYWx1ZS5sZW5ndGggPD0gdmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5pZEJ5VmFsdWUubGVuZ3RoID0gdmFsdWUgKyAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlkQnlWYWx1ZVt2YWx1ZV0gPSB0aGlzLm1pbmltdW1VbnVzZWRJZDtcclxuICAgICAgICBpZiAodGhpcy52YWx1ZUJ5SWQubGVuZ3RoIDw9IHRoaXMubWluaW11bVVudXNlZElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmFsdWVCeUlkLmxlbmd0aCA9IHRoaXMubWluaW11bVVudXNlZElkICsgMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy52YWx1ZUJ5SWRbdGhpcy5taW5pbXVtVW51c2VkSWRdID0gdmFsdWU7XHJcbiAgICAgICAgdmFyIHJlcyA9IHRoaXMubWluaW11bVVudXNlZElkO1xyXG4gICAgICAgIHRoaXMubWluaW11bVVudXNlZElkKys7XHJcbiAgICAgICAgd2hpbGUgKHRoaXMudmFsdWVCeUlkLmxlbmd0aCA+IHRoaXMubWluaW11bVVudXNlZElkICYmXHJcbiAgICAgICAgICAgIHR5cGVvZiB0aGlzLnZhbHVlQnlJZFt0aGlzLm1pbmltdW1VbnVzZWRJZF0gPT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgdGhpcy5taW5pbXVtVW51c2VkSWQrKztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH07XHJcbiAgICBJZE1hbmFnZXIucHJvdG90eXBlLmZyZWVJZEZvciA9IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgIHZhciBpZCA9IHRoaXMuaWRCeVZhbHVlW3ZhbHVlXTtcclxuICAgICAgICBpZiAoaWQgPCB0aGlzLm1pbmltdW1VbnVzZWRJZCkge1xyXG4gICAgICAgICAgICB0aGlzLm1pbmltdW1VbnVzZWRJZCA9IGlkO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlkQnlWYWx1ZVt2YWx1ZV0gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy52YWx1ZUJ5SWRbaWRdID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH07XHJcbiAgICBJZE1hbmFnZXIucHJvdG90eXBlLmdldElkID0gZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgdmFyIHIgPSB0aGlzLmlkQnlWYWx1ZVt2YWx1ZV07XHJcbiAgICAgICAgcmV0dXJuIHR5cGVvZiByID09PSBcIm51bWJlclwiID8gciA6IC0xO1xyXG4gICAgfTtcclxuICAgIElkTWFuYWdlci5wcm90b3R5cGUuZ2V0VmFsdWVCeUlkID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVCeUlkW2lkXTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gSWRNYW5hZ2VyO1xyXG59KCkpO1xyXG5leHBvcnQgeyBJZE1hbmFnZXIgfTtcclxuIiwiZXhwb3J0IGZ1bmN0aW9uIG5hbWVvZihrZXkpIHtcclxuICAgIHJldHVybiBrZXk7XHJcbn1cclxuIiwidmFyIF9fc3ByZWFkQXJyYXkgPSAodGhpcyAmJiB0aGlzLl9fc3ByZWFkQXJyYXkpIHx8IGZ1bmN0aW9uICh0bywgZnJvbSwgcGFjaykge1xyXG4gICAgaWYgKHBhY2sgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgZm9yICh2YXIgaSA9IDAsIGwgPSBmcm9tLmxlbmd0aCwgYXI7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICBpZiAoYXIgfHwgIShpIGluIGZyb20pKSB7XHJcbiAgICAgICAgICAgIGlmICghYXIpIGFyID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZnJvbSwgMCwgaSk7XHJcbiAgICAgICAgICAgIGFyW2ldID0gZnJvbVtpXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdG8uY29uY2F0KGFyIHx8IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGZyb20pKTtcclxufTtcclxuaW1wb3J0IHsgcHJpbnRDb25zb2xlIH0gZnJvbSBcIkBza3lyaW0tcGxhdGZvcm0vc2t5cmltLXBsYXRmb3JtXCI7XHJcbi8vIFRPRE86IHJlZGlyZWN0IHRoaXMgdG8gc3BkbG9nXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2dFcnJvcihzZXJ2aWNlKSB7XHJcbiAgICB2YXIgcmVzdCA9IFtdO1xyXG4gICAgZm9yICh2YXIgX2kgPSAxOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICByZXN0W19pIC0gMV0gPSBhcmd1bWVudHNbX2ldO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlc3RQcm9jZXNzZWQgPSByZXN0Lm1hcChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRXJyb3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGl0ZW0uc3RhY2sgfHwgaXRlbS5tZXNzYWdlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaXRlbTtcclxuICAgIH0pO1xyXG4gICAgcHJpbnRDb25zb2xlLmFwcGx5KHZvaWQgMCwgX19zcHJlYWRBcnJheShbXCJFcnJvciBpbiBcIi5jb25jYXQodHlwZW9mIHNlcnZpY2UgIT09IFwic3RyaW5nXCIgPyBzZXJ2aWNlLmNvbnN0cnVjdG9yLm5hbWUgOiBzZXJ2aWNlLCBcIjpcIildLCByZXN0UHJvY2Vzc2VkLCBmYWxzZSkpO1xyXG59XHJcbi8vIFRPRE86IHJlZGlyZWN0IHRoaXMgdG8gc3BkbG9nXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2dUcmFjZShzZXJ2aWNlKSB7XHJcbiAgICB2YXIgcmVzdCA9IFtdO1xyXG4gICAgZm9yICh2YXIgX2kgPSAxOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICByZXN0W19pIC0gMV0gPSBhcmd1bWVudHNbX2ldO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlc3RQcm9jZXNzZWQgPSByZXN0Lm1hcChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRXJyb3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGl0ZW0uc3RhY2sgfHwgaXRlbS5tZXNzYWdlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaXRlbTtcclxuICAgIH0pO1xyXG4gICAgcHJpbnRDb25zb2xlLmFwcGx5KHZvaWQgMCwgX19zcHJlYWRBcnJheShbXCJUcmFjZSBpbiBcIi5jb25jYXQodHlwZW9mIHNlcnZpY2UgIT09IFwic3RyaW5nXCIgPyBzZXJ2aWNlLmNvbnN0cnVjdG9yLm5hbWUgOiBzZXJ2aWNlLCBcIjpcIildLCByZXN0UHJvY2Vzc2VkLCBmYWxzZSkpO1xyXG59XHJcbiIsImV4cG9ydCB2YXIgTXNnVHlwZTtcclxuKGZ1bmN0aW9uIChNc2dUeXBlKSB7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJDdXN0b21QYWNrZXRcIl0gPSAxXSA9IFwiQ3VzdG9tUGFja2V0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVNb3ZlbWVudFwiXSA9IDJdID0gXCJVcGRhdGVNb3ZlbWVudFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlQW5pbWF0aW9uXCJdID0gM10gPSBcIlVwZGF0ZUFuaW1hdGlvblwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlQXBwZWFyYW5jZVwiXSA9IDRdID0gXCJVcGRhdGVBcHBlYXJhbmNlXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVFcXVpcG1lbnRcIl0gPSA1XSA9IFwiVXBkYXRlRXF1aXBtZW50XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJBY3RpdmF0ZVwiXSA9IDZdID0gXCJBY3RpdmF0ZVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlUHJvcGVydHlcIl0gPSA3XSA9IFwiVXBkYXRlUHJvcGVydHlcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlB1dEl0ZW1cIl0gPSA4XSA9IFwiUHV0SXRlbVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVGFrZUl0ZW1cIl0gPSA5XSA9IFwiVGFrZUl0ZW1cIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkZpbmlzaFNwU25pcHBldFwiXSA9IDEwXSA9IFwiRmluaXNoU3BTbmlwcGV0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJPbkVxdWlwXCJdID0gMTFdID0gXCJPbkVxdWlwXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJDb25zb2xlQ29tbWFuZFwiXSA9IDEyXSA9IFwiQ29uc29sZUNvbW1hbmRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkNyYWZ0SXRlbVwiXSA9IDEzXSA9IFwiQ3JhZnRJdGVtXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJIb3N0XCJdID0gMTRdID0gXCJIb3N0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJDdXN0b21FdmVudFwiXSA9IDE1XSA9IFwiQ3VzdG9tRXZlbnRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkNoYW5nZVZhbHVlc1wiXSA9IDE2XSA9IFwiQ2hhbmdlVmFsdWVzXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJPbkhpdFwiXSA9IDE3XSA9IFwiT25IaXRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkRlYXRoU3RhdGVDb250YWluZXJcIl0gPSAxOF0gPSBcIkRlYXRoU3RhdGVDb250YWluZXJcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkRyb3BJdGVtXCJdID0gMTldID0gXCJEcm9wSXRlbVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVGVsZXBvcnRcIl0gPSAyMF0gPSBcIlRlbGVwb3J0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJPcGVuQ29udGFpbmVyXCJdID0gMjFdID0gXCJPcGVuQ29udGFpbmVyXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJQbGF5ZXJCb3dTaG90XCJdID0gMjJdID0gXCJQbGF5ZXJCb3dTaG90XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJTcGVsbENhc3RcIl0gPSAyM10gPSBcIlNwZWxsQ2FzdFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlQW5pbVZhcmlhYmxlc1wiXSA9IDI0XSA9IFwiVXBkYXRlQW5pbVZhcmlhYmxlc1wiO1xyXG4gICAgLy8gZXgtc3RyaW5nc1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiRGVzdHJveUFjdG9yXCJdID0gMjVdID0gXCJEZXN0cm95QWN0b3JcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkhvc3RTdGFydFwiXSA9IDI2XSA9IFwiSG9zdFN0YXJ0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJIb3N0U3RvcFwiXSA9IDI3XSA9IFwiSG9zdFN0b3BcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlNldEludmVudG9yeVwiXSA9IDI4XSA9IFwiU2V0SW52ZW50b3J5XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJTZXRSYWNlTWVudU9wZW5cIl0gPSAyOV0gPSBcIlNldFJhY2VNZW51T3BlblwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiU3BTbmlwcGV0XCJdID0gMzBdID0gXCJTcFNuaXBwZXRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlRlbGVwb3J0MlwiXSA9IDMxXSA9IFwiVGVsZXBvcnQyXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVHYW1lbW9kZURhdGFcIl0gPSAzMl0gPSBcIlVwZGF0ZUdhbWVtb2RlRGF0YVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQ3JlYXRlQWN0b3JcIl0gPSAzM10gPSBcIkNyZWF0ZUFjdG9yXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJWb2ljZUNoYXRNZXNzYWdlXCJdID0gMzRdID0gXCJWb2ljZUNoYXRNZXNzYWdlXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJVcGRhdGVWb2ljZUNoYXRNZXNzYWdlXCJdID0gMzVdID0gXCJVcGRhdGVWb2ljZUNoYXRNZXNzYWdlXCI7XHJcbn0pKE1zZ1R5cGUgfHwgKE1zZ1R5cGUgPSB7fSkpO1xyXG4iLCJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRlbWl0dGVyM1wiO1xyXG52YXIgRXZlbnRFbWl0dGVyRmFjdG9yeSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlckZhY3RvcnkoKSB7XHJcbiAgICB9XHJcbiAgICBFdmVudEVtaXR0ZXJGYWN0b3J5Lm1ha2VFdmVudEVtaXR0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIChuZXcgRXZlbnRFbWl0dGVyKCkpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBFdmVudEVtaXR0ZXJGYWN0b3J5O1xyXG59KCkpO1xyXG5leHBvcnQgeyBFdmVudEVtaXR0ZXJGYWN0b3J5IH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgZ2V0SW52ZW50b3J5IH0gZnJvbSBcIi4uLy4uL3N5bmMvaW52ZW50b3J5XCI7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHRoaXMgb3V0XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBMYXN0SW52U2VydmljZSB9IGZyb20gXCIuL2xhc3RJbnZTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBBY3RpdmF0aW9uU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhBY3RpdmF0aW9uU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEFjdGl2YXRpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJhY3RpdmF0ZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BY3RpdmF0ZShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQWN0aXZhdGlvblNlcnZpY2UucHJvdG90eXBlLm9uQWN0aXZhdGUgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBsYXN0SW52U2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihMYXN0SW52U2VydmljZSk7XHJcbiAgICAgICAgbGFzdEludlNlcnZpY2UubGFzdEludiA9IGdldEludmVudG9yeSh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgIHZhciBjYXN0ZXIgPSBlLmNhc3RlciA/IGUuY2FzdGVyLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQgPyBlLnRhcmdldC5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgaWYgKCF0YXJnZXQgfHwgIWNhc3Rlcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEFjdG9ycyBuZXZlciBoYXZlIG5vbi1mZiBpZHMgbG9jYWxseSBpbiBza3ltcFxyXG4gICAgICAgIGlmIChjYXN0ZXIgIT09IDB4MTQgJiYgY2FzdGVyIDwgMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRhcmdldCA9IGxvY2FsSWRUb1JlbW90ZUlkKHRhcmdldCk7XHJcbiAgICAgICAgaWYgKCF0YXJnZXQpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgJ2xvY2FsSWRUb1JlbW90ZUlkIHJldHVybmVkIDAgKHRhcmdldCkgaW4gb24oXFwnYWN0aXZhdGVcXCcpJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzdGVyID0gbG9jYWxJZFRvUmVtb3RlSWQoY2FzdGVyKTtcclxuICAgICAgICBpZiAoIWNhc3Rlcikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCAnbG9jYWxJZFRvUmVtb3RlSWQgcmV0dXJuZWQgMCAoY2FzdGVyKSBpbiBvbihcXCdhY3RpdmF0ZVxcJyknKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgb3BlblN0YXRlID0gZS50YXJnZXQuZ2V0T3BlblN0YXRlKCk7XHJcbiAgICAgICAgaWYgKG9wZW5TdGF0ZSA9PT0gMiAvKiBPcGVuU3RhdGUuT3BlbmluZyAqLyB8fCBvcGVuU3RhdGUgPT09IDQgLyogT3BlblN0YXRlLkNsb3NpbmcgKi8pIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJJZ25vcmluZyBhY3RpdmF0aW9uIG9mIGRvb3IgYmVjYXVzZSBpdCdzIGFscmVhZHkgb3BlbmluZyBvciBjbG9zaW5nXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQWN0aXZhdGUsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiB7IGNhc3RlcjogY2FzdGVyLCB0YXJnZXQ6IHRhcmdldCwgaXNTZWNvbmRBY3RpdmF0aW9uOiBmYWxzZSB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlbnQgYWN0aXZhdGlvbiBmb3IgY2FzdGVyPVwiLCBjYXN0ZXIudG9TdHJpbmcoMTYpLCBcImFuZCB0YXJnZXQ9XCIsIHRhcmdldC50b1N0cmluZygxNikpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBBY3RpdmF0aW9uU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBBY3RpdmF0aW9uU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgX19hc3NpZ24gPSAodGhpcyAmJiB0aGlzLl9fYXNzaWduKSB8fCBmdW5jdGlvbiAoKSB7XHJcbiAgICBfX2Fzc2lnbiA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24odCkge1xyXG4gICAgICAgIGZvciAodmFyIHMsIGkgPSAxLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG47IGkrKykge1xyXG4gICAgICAgICAgICBzID0gYXJndW1lbnRzW2ldO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwIGluIHMpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocywgcCkpXHJcbiAgICAgICAgICAgICAgICB0W3BdID0gc1twXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHQ7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIF9fYXNzaWduLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbn07XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgc2V0VGV4dFNpemUgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxudmFyIHBsYXllcklkID0gMHgxNDtcclxudmFyIEFuaW1EZWJ1Z1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQW5pbURlYnVnU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEFuaW1EZWJ1Z1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5zZXR0aW5ncyA9IF90aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImFuaW1EZWJ1Z1wiXTtcclxuICAgICAgICAvLyBjbGVhciBwcmV2aW91cyB0ZXh0cyBpbiBjYXNlIG9mIGhvdHJlbG9hZFxyXG4gICAgICAgIGlmIChfdGhpcy5zcC5zdG9yYWdlW0FuaW1RdWV1ZUNvbGxlY3Rpb24uTmFtZV0gJiYgX3RoaXMuc3Auc3RvcmFnZVtBbmltUXVldWVDb2xsZWN0aW9uLk5hbWVdLmNsZWFyU1BUZXh0KSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkRlc3Ryb3lpbmcgb2xkIEFuaW1RdWV1ZUNvbGxlY3Rpb25cIik7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5zdG9yYWdlW0FuaW1RdWV1ZUNvbGxlY3Rpb24uTmFtZV0uY2xlYXJTUFRleHQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiRmFpbGVkIHRvIGRlc3Ryb3kgb2xkIEFuaW1RdWV1ZUNvbGxlY3Rpb246XCIsIGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzZWxmID0gX3RoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7IH0sXHJcbiAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLm9uU2VuZEFuaW1hdGlvbkV2ZW50TGVhdmUoY3R4KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHBsYXllcklkLCBwbGF5ZXJJZCk7XHJcbiAgICAgICAgaWYgKCFfdGhpcy5zZXR0aW5ncyB8fCAhX3RoaXMuc2V0dGluZ3MuaXNBY3RpdmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoKF9hID0gX3RoaXMuc2V0dGluZ3MudGV4dE91dHB1dCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmlzQWN0aXZlKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnF1ZXVlID0gbmV3IEFuaW1RdWV1ZUNvbGxlY3Rpb24oX3RoaXMuc3AsIF90aGlzLnNldHRpbmdzKTtcclxuICAgICAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVtBbmltUXVldWVDb2xsZWN0aW9uLm5hbWVdID0gX3RoaXMucXVldWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEFuaW1EZWJ1Z1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZEFuaW1hdGlvbkV2ZW50TGVhdmUgPSBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgaWYgKHRoaXMucXVldWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucXVldWUucHVzaChjdHguYW5pbUV2ZW50TmFtZSwgY3R4LmFuaW1hdGlvblN1Y2NlZWRlZCA/IGFuaW1hdGlvblN1Y2NlZWRlZFRleHRDb2xvciA6IGFuaW1hdGlvbk5vdFN1Y2NlZWRlZFRleHRDb2xvcik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEFuaW1EZWJ1Z1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQW5pbURlYnVnU2VydmljZSB9O1xyXG52YXIgYW5pbWF0aW9uU3VjY2VlZGVkVGV4dENvbG9yID0gWzI1NSwgMjU1LCAyNTUsIDFdO1xyXG52YXIgYW5pbWF0aW9uTm90U3VjY2VlZGVkVGV4dENvbG9yID0gWzI1NSwgMCwgMCwgMV07XHJcbnZhciBBbmltUXVldWVDb2xsZWN0aW9uID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gQW5pbVF1ZXVlQ29sbGVjdGlvbihzcCwgc2V0dGluZ3MpIHtcclxuICAgICAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZjtcclxuICAgICAgICB0aGlzLnNwID0gc3A7XHJcbiAgICAgICAgdmFyIGFycmF5TGVuZ3RoID0gKF9iID0gKF9hID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLnRleHRPdXRwdXQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pdGVtQ291bnQpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IDU7XHJcbiAgICAgICAgdmFyIHN0YXJ0UG9zID0gKF9kID0gKF9jID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLnRleHRPdXRwdXQpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5zdGFydFBvcykgIT09IG51bGwgJiYgX2QgIT09IHZvaWQgMCA/IF9kIDogeyB4OiA2NTAsIHk6IDYwMCB9O1xyXG4gICAgICAgIDtcclxuICAgICAgICB2YXIgeVBvc0RlbHRhID0gKF9mID0gKF9lID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLnRleHRPdXRwdXQpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS55UG9zRGVsdGEpICE9PSBudWxsICYmIF9mICE9PSB2b2lkIDAgPyBfZiA6IDMyO1xyXG4gICAgICAgIHZhciB5ID0gc3RhcnRQb3MueTtcclxuICAgICAgICB0aGlzLmxpc3QgPSBuZXcgQXJyYXkoYXJyYXlMZW5ndGgpO1xyXG4gICAgICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGFycmF5TGVuZ3RoOyArK2lkeCkge1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RbaWR4XSA9IHsgbmFtZTogXCJcIiwgdGV4dElkOiBzcC5jcmVhdGVUZXh0KHN0YXJ0UG9zLngsIHksIFwiXCIsIGFuaW1hdGlvblN1Y2NlZWRlZFRleHRDb2xvciksIGNvbG9yOiBhbmltYXRpb25TdWNjZWVkZWRUZXh0Q29sb3IgfTtcclxuICAgICAgICAgICAgc2V0VGV4dFNpemUodGhpcy5saXN0W2lkeF0udGV4dElkLCAwLjUpO1xyXG4gICAgICAgICAgICB5ICs9IHlQb3NEZWx0YTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBBbmltUXVldWVDb2xsZWN0aW9uLnByb3RvdHlwZS5jbGVhclNQVGV4dCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICh0aGlzLmxpc3QubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5saXN0LmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsgcmV0dXJuIF90aGlzLnNwLmRlc3Ryb3lUZXh0KGl0ZW0udGV4dElkKTsgfSk7XHJcbiAgICB9O1xyXG4gICAgQW5pbVF1ZXVlQ29sbGVjdGlvbi5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uIChhbmltTmFtZSwgY29sb3IpIHtcclxuICAgICAgICB2YXIgcHJldkl0ZW0gPSBudWxsO1xyXG4gICAgICAgIGZvciAodmFyIGlkeCA9IHRoaXMubGlzdC5sZW5ndGggLSAxOyBpZHggPj0gMDsgLS1pZHgpIHtcclxuICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmxpc3RbaWR4XTtcclxuICAgICAgICAgICAgcHJldkl0ZW0gPSBfX2Fzc2lnbih7fSwgaXRlbSk7XHJcbiAgICAgICAgICAgIGl0ZW0ubmFtZSA9IGFuaW1OYW1lO1xyXG4gICAgICAgICAgICBpdGVtLmNvbG9yID0gY29sb3I7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc2V0VGV4dFN0cmluZyhpdGVtLnRleHRJZCwgaXRlbS5uYW1lKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5zZXRUZXh0Q29sb3IoaXRlbS50ZXh0SWQsIGl0ZW0uY29sb3IpO1xyXG4gICAgICAgICAgICBhbmltTmFtZSA9IHByZXZJdGVtLm5hbWU7XHJcbiAgICAgICAgICAgIGNvbG9yID0gcHJldkl0ZW0uY29sb3I7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEFuaW1RdWV1ZUNvbGxlY3Rpb24uTmFtZSA9IFwiQW5pbVF1ZXVlQ29sbGVjdGlvblwiO1xyXG4gICAgcmV0dXJuIEFuaW1RdWV1ZUNvbGxlY3Rpb247XHJcbn0oKSk7XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xyXG5pbXBvcnQgeyBhdXRoR2FtZURhdGFTdG9yYWdlS2V5IH0gZnJvbSBcIi4uLy4uL2ZlYXR1cmVzL2F1dGhNb2RlbFwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFRpbWVyc1NlcnZpY2UgfSBmcm9tIFwiLi90aW1lcnNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IE5ldHdvcmtpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vbmV0d29ya2luZ1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXR0aW5nc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgQ2hhcmFjdGVyU2VsZWN0U2VydmljZSB9IGZyb20gXCIuL2NoYXJhY3RlclNlbGVjdFNlcnZpY2VcIjtcclxuLy8gRGVmaW5lIGFzIG1vZHVsZS1sZXZlbCB2YXJpYWJsZXMgaW5zdGVhZCBvZiBnbG9iYWwgZGVjbGFyYXRpb25zXHJcbnZhciB3aW5kb3cgPSBnbG9iYWwud2luZG93IHx8IGdsb2JhbFRoaXMud2luZG93IHx8IHt9O1xyXG4vLyBDb25zdGFudHMgdXNlZCBvbiBib3RoIGNsaWVudCBhbmQgYnJvd3NlciBzaWRlIChzZWUgYnJvd3NlcnNpZGVXaWRnZXRTZXR0ZXIpXHJcbnZhciBldmVudHMgPSB7XHJcbiAgICBvcGVuRGlzY29yZE9hdXRoOiAnb3BlbkRpc2NvcmRPYXV0aCcsXHJcbiAgICBhdXRoQXR0ZW1wdDogJ2F1dGhBdHRlbXB0RXZlbnQnLFxyXG4gICAgb3BlbkdpdGh1YjogJ29wZW5HaXRodWInLFxyXG4gICAgb3BlblBhdHJlb246ICdvcGVuUGF0cmVvbicsXHJcbiAgICBjbGVhckF1dGhEYXRhOiAnY2xlYXJBdXRoRGF0YScsXHJcbiAgICB1cGRhdGVSZXF1aXJlZDogJ3VwZGF0ZVJlcXVpcmVkJyxcclxuICAgIGJhY2tUb0xvZ2luOiAnYmFja1RvTG9naW4nLFxyXG4gICAgam9pbkRpc2NvcmQ6ICdqb2luRGlzY29yZCcsXHJcbiAgICBoaWRlQnJvd3NlcjogJ2hpZGVCcm93c2VyJyxcclxufTtcclxuLy8gVmFpYWJsZXMgdXNlZCBvbiBib3RoIGNsaWVudCBhbmQgYnJvd3NlciBzaWRlIChzZWUgYnJvd3NlcnNpZGVXaWRnZXRTZXR0ZXIpXHJcbnZhciBicm93c2VyU3RhdGUgPSB7XHJcbiAgICBjb21tZW50OiAnJyxcclxuICAgIGZhaWxDb3VudDogOTAwMCxcclxuICAgIGxvZ2luRmFpbGVkUmVhc29uOiAnJyxcclxufTtcclxudmFyIGF1dGhEYXRhID0gbnVsbDtcclxudmFyIEF1dGhTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEF1dGhTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQXV0aFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuZGVuaWVkV2lkZ2V0U2V0dGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgd2lkZ2V0ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJmb3JtXCIsXHJcbiAgICAgICAgICAgICAgICBpZDogMixcclxuICAgICAgICAgICAgICAgIGNhcHRpb246IFwiVXBkYXRlIEF2YWlsYWJsZVwiLFxyXG4gICAgICAgICAgICAgICAgZWxlbWVudHM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcImhvb3JheSEgdXBkYXRlIHJlbGVhc2VkXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcImRvd25sb2FkIG5vdyBhdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJza3ltcC5uZXRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW11cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJvcGVuIHNreW1wLm5ldFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXCJFTEVNRU5UX1NUWUxFX01BUkdJTl9FWFRFTkRFRFwiXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMudXBkYXRlUmVxdWlyZWQpOyB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoaW50OiBcIkdvIHRvIGRvd25sb2FkIHBhZ2VcIixcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzLnNldChbd2lkZ2V0XSk7XHJcbiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBnYW1lbW9kZSB3aWxsIG5vdCBiZSBhYmxlIHRvIHVwZGF0ZSB3aWRnZXRzIGFueW1vcmVcclxuICAgICAgICAgICAgd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMgPSBudWxsO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMubG9naW5GYWlsZWRXaWRnZXRTZXR0ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBzcGxpdFBhcnRzID0gYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uLnNwbGl0KCdcXG4nKTtcclxuICAgICAgICAgICAgdmFyIHRleHRFbGVtZW50cyA9IHNwbGl0UGFydHMubWFwKGZ1bmN0aW9uIChwYXJ0KSB7IHJldHVybiAoe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICB0ZXh0OiBwYXJ0LFxyXG4gICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgIH0pOyB9KTtcclxuICAgICAgICAgICAgdmFyIHdpZGdldCA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwiZm9ybVwiLFxyXG4gICAgICAgICAgICAgICAgaWQ6IDIsXHJcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIkVycm9yXCIsXHJcbiAgICAgICAgICAgICAgICBlbGVtZW50czogbmV3IEFycmF5KClcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGV4dEVsZW1lbnRzLmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHsgcmV0dXJuIHdpZGdldC5lbGVtZW50cy5wdXNoKGVsZW1lbnQpOyB9KTtcclxuICAgICAgICAgICAgaWYgKGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9PT0gJ3BsZWFzZSBqb2luIHRoZSBkaXNjb3JkIHNlcnZlcicpIHtcclxuICAgICAgICAgICAgICAgIHdpZGdldC5lbGVtZW50cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IFwiSm9pbiBTZXJ2ZXJcIixcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXCJFTEVNRU5UX1NUWUxFX01BUkdJTl9FWFRFTkRFRFwiXSxcclxuICAgICAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy5qb2luRGlzY29yZCk7IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaGludDogbnVsbFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd2lkZ2V0LmVsZW1lbnRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgIHRleHQ6IFwiQmFja1wiLFxyXG4gICAgICAgICAgICAgICAgdGFnczogW1wiRUxFTUVOVF9TVFlMRV9NQVJHSU5fRVhURU5ERURcIl0sXHJcbiAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy5iYWNrVG9Mb2dpbik7IH0sXHJcbiAgICAgICAgICAgICAgICBoaW50OiB1bmRlZmluZWRcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmICh3aW5kb3cuc2t5cmltUGxhdGZvcm0gJiYgd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMpIHtcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzLnNldChbd2lkZ2V0XSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmxvZ2luV2lkZ2V0U2V0dGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvLyBOb3RlOiBpc0Nvbm5lY3RpbmcgaXMgaW5qZWN0ZWQgdmlhIGdldFRleHQoKSB3cmFwcGVyXHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgLSBpc0Nvbm5lY3RpbmcgaXMgcHJvdmlkZWQgYnkgRnVuY3Rpb25JbmZvLmdldFRleHQoKVxyXG4gICAgICAgICAgICB2YXIgY29ubmVjdGluZyA9IGlzQ29ubmVjdGluZztcclxuICAgICAgICAgICAgdmFyIGF1dGhEYXRhVXNlcm5hbWUgPSBhdXRoRGF0YSA/IChhdXRoRGF0YS5kaXNjb3JkVXNlcm5hbWVcclxuICAgICAgICAgICAgICAgID8gYXV0aERhdGEuZGlzY29yZFVzZXJuYW1lXHJcbiAgICAgICAgICAgICAgICA6IFwiaWQ6IFwiLmNvbmNhdChhdXRoRGF0YS5tYXN0ZXJBcGlJZCkpIDogXCJub3QgYXV0aG9yaXplZFwiO1xyXG4gICAgICAgICAgICB2YXIgYnV0dG9uVGV4dCA9IGF1dGhEYXRhID8gXCJDaGFuZ2UgQWNjb3VudFwiIDogXCJMb2dpbiB2aWEgRGlzY29yZFwiO1xyXG4gICAgICAgICAgICB2YXIgZWxlbWVudHMgPSBbXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogYXV0aERhdGFVc2VybmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgLy8gT25seSBzaG93IGJ1dHRvbnMgaWYgbm90IGNvbm5lY3RpbmdcclxuICAgICAgICAgICAgaWYgKCFjb25uZWN0aW5nKSB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IGJ1dHRvblRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnczogW1wiRUxFTUVOVF9TVFlMRV9NQVJHSU5fRVhURU5ERURcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMub3BlbkRpc2NvcmRPYXV0aCk7IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaGludDogXCJZb3UgY2FuIGxvZ2luIG9yIGNoYW5nZSBhY2NvdW50XCIsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGVsZW1lbnRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJDb25uZWN0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnczogW1wiQlVUVE9OX1NUWUxFX0ZSQU1FXCIsIFwiRUxFTUVOVF9TVFlMRV9NQVJHSU5fRVhURU5ERURcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMuYXV0aEF0dGVtcHQpOyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGhpbnQ6IFwiQ29ubmVjdCB0byBnYW1lIHNlcnZlclwiLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gQWx3YXlzIHNob3cgc3RhdHVzIHRleHRcclxuICAgICAgICAgICAgZWxlbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgIHRleHQ6IGJyb3dzZXJTdGF0ZS5jb21tZW50LFxyXG4gICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB2YXIgbG9naW5XaWRnZXQgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImZvcm1cIixcclxuICAgICAgICAgICAgICAgIGlkOiAxLFxyXG4gICAgICAgICAgICAgICAgY2FwdGlvbjogXCJBdXRoZW50aWNhdGlvblwiLFxyXG4gICAgICAgICAgICAgICAgZWxlbWVudHM6IGVsZW1lbnRzXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzLnNldChbbG9naW5XaWRnZXRdKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmJyb3dzZXJzaWRlV2lkZ2V0U2V0dGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbG9naW5XaWRnZXQgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImZvcm1cIixcclxuICAgICAgICAgICAgICAgIGlkOiAxLFxyXG4gICAgICAgICAgICAgICAgY2FwdGlvbjogXCJBdXRoZW50aWNhdGlvblwiLFxyXG4gICAgICAgICAgICAgICAgZWxlbWVudHM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAoYXV0aERhdGEgPyAoYXV0aERhdGEuZGlzY29yZFVzZXJuYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IFwiXCIuY29uY2F0KGF1dGhEYXRhLmRpc2NvcmRVc2VybmFtZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogXCJpZDogXCIuY29uY2F0KGF1dGhEYXRhLm1hc3RlckFwaUlkKSkgOiBcIm5vdCBhdXRob3JpemVkXCIpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogYXV0aERhdGEgPyBcIkNoYW5nZSBBY2NvdW50XCIgOiBcIkxvZ2luIHZpYSBEaXNjb3JkXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGljazogZnVuY3Rpb24gKCkgeyByZXR1cm4gd2luZG93LnNreXJpbVBsYXRmb3JtLnNlbmRNZXNzYWdlKGV2ZW50cy5vcGVuRGlzY29yZE9hdXRoKTsgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGludDogXCJZb3UgY2FuIGxvZ2luIG9yIGNoYW5nZSBhY2NvdW50XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFwiQ29ubmVjdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXCJCVVRUT05fU1RZTEVfRlJBTUVcIiwgXCJFTEVNRU5UX1NUWUxFX01BUkdJTl9FWFRFTkRFRFwiXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMuYXV0aEF0dGVtcHQpOyB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoaW50OiBcIkNvbm5lY3QgdG8gZ2FtZSBzZXJ2ZXJcIixcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGJyb3dzZXJTdGF0ZS5jb21tZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cy5zZXQoW2xvZ2luV2lkZ2V0XSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5faXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLnRyaWdnZXIgPSB7XHJcbiAgICAgICAgICAgIGF1dGhOZWVkZWRGaXJlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGJyb3dzZXJXaW5kb3dMb2FkZWRGaXJlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGdldCBjb25kaXRpb25NZXQoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hdXRoTmVlZGVkRmlyZWQgJiYgdGhpcy5icm93c2VyV2luZG93TG9hZGVkRmlyZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmRpc2NvcmRBdXRoU3RhdGUgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcclxuICAgICAgICBfdGhpcy5hdXRoRGlhbG9nT3BlbiA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgX3RoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3JDb3VudGVyID0gMDtcclxuICAgICAgICBfdGhpcy5sYXN0U2xvd0NvdW50ZXIgPSAtMTtcclxuICAgICAgICBfdGhpcy5wbGF5ZXJFdmVyU2F3QWN0dWFsR2FtZXBsYXkgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5naXRodWJVcmwgPSBcImh0dHBzOi8vZ2l0aHViLmNvbS9CU3RhclJQL3NreW1wXCI7XHJcbiAgICAgICAgX3RoaXMucGF0cmVvblVybCA9IFwiaHR0cHM6Ly93d3cucGF0cmVvbi5jb20vYy9icnVpbnN0YXJcIjtcclxuICAgICAgICBfdGhpcy5kaXNjb3JkVXJsID0gXCJodHRwczovL2Rpc2NvcmQuZ2cvYnN0YXJycFwiO1xyXG4gICAgICAgIF90aGlzLnBsdWdpbkF1dGhEYXRhTmFtZSA9IFwiYXV0aC1kYXRhLW5vLWxvYWRcIjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJhdXRoTmVlZGVkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkF1dGhOZWVkZWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImJyb3dzZXJXaW5kb3dMb2FkZWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQnJvd3NlcldpbmRvd0xvYWRlZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNyZWF0ZUFjdG9yTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY29ubmVjdGlvbkFjY2VwdGVkXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmhhbmRsZUNvbm5lY3Rpb25BY2NlcHRlZCgpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjb25uZWN0aW9uRGVuaWVkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5oYW5kbGVDb25uZWN0aW9uRGVuaWVkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjdXN0b21QYWNrZXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkN1c3RvbVBhY2tldE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJicm93c2VyTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Ccm93c2VyTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInRpY2tcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25UaWNrKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkF1dGhOZWVkZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgYXV0aE5lZWRlZCBldmVudFwiKTtcclxuICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdhdXRoTmVlZGVkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgLy8gVHJ5IHRvIHJlYWQgYXV0aCBkYXRhIGZyb20gZGlzayBmaXJzdFxyXG4gICAgICAgIGF1dGhEYXRhID0gdGhpcy5yZWFkQXV0aERhdGFGcm9tRGlzaygpO1xyXG4gICAgICAgIC8vIElmIG5vIGF1dGggZmlsZSBleGlzdHMsIGNoZWNrIGZvciBvZmZsaW5lIG1vZGUgc2V0dGluZ3NcclxuICAgICAgICBpZiAoIWF1dGhEYXRhKSB7XHJcbiAgICAgICAgICAgIHZhciBzZXR0aW5nc0dhbWVEYXRhID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJnYW1lRGF0YVwiXTtcclxuICAgICAgICAgICAgdmFyIGhhc09mZmxpbmVTZXR0aW5ncyA9IE51bWJlci5pc0ludGVnZXIoc2V0dGluZ3NHYW1lRGF0YSA9PT0gbnVsbCB8fCBzZXR0aW5nc0dhbWVEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5nc0dhbWVEYXRhLnByb2ZpbGVJZCk7XHJcbiAgICAgICAgICAgIGlmIChoYXNPZmZsaW5lU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTm8gYXV0aCBmaWxlIGZvdW5kLCB1c2luZyBvZmZsaW5lIG1vZGUgZnJvbSBzZXR0aW5ncyB3aXRoIHByb2ZpbGVJZDpcIiwgc2V0dGluZ3NHYW1lRGF0YS5wcm9maWxlSWQpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImF1dGhBdHRlbXB0XCIsIHtcclxuICAgICAgICAgICAgICAgICAgICBhdXRoR2FtZURhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWw6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGVJZDogc2V0dGluZ3NHYW1lRGF0YS5wcm9maWxlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NUb2tlbjogc2V0dGluZ3NHYW1lRGF0YS5hY2Nlc3NUb2tlblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQXV0aCBmaWxlIGV4aXN0cyBvciBubyBvZmZsaW5lIHNldHRpbmdzIC0gc2hvdyBsb2dpbiBtZW51XHJcbiAgICAgICAgaWYgKGF1dGhEYXRhKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQXV0aCBmaWxlIGZvdW5kLCBzaG93aW5nIGxvZ2luIG1lbnUgd2l0aCBleGlzdGluZyBhdXRoIGRhdGFcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIk5vIGF1dGggZmlsZSBhbmQgbm8gb2ZmbGluZSBzZXR0aW5ncywgc2hvd2luZyBsb2dpbiBtZW51XCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdyZWd1bGFyIGF1dGggbmVlZGVkJyk7XHJcbiAgICAgICAgLy8gU2hvdyBicm93c2VyIGFuZCBsb2FkIHRoZSBVSVxyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgICAgIC8vIFRyeSB0byBsb2FkIHRoZSBVSSBleHBsaWNpdGx5XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmxvYWRVcmwoXCJmaWxlOi8vL0RhdGEvUGxhdGZvcm0vVUkvaW5kZXguaHRtbFwiKTtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJBdHRlbXB0ZWQgdG8gbG9hZCBVSSBmcm9tIGZpbGU6Ly8vRGF0YS9QbGF0Zm9ybS9VSS9pbmRleC5odG1sXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkZhaWxlZCB0byBsb2FkIFVJOlwiLCBlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gU2V0IHRyaWdnZXIgZmxhZyBhbmQgd2FpdCBmb3IgYnJvd3NlciB0byBsb2FkXHJcbiAgICAgICAgdGhpcy50cmlnZ2VyLmF1dGhOZWVkZWRGaXJlZCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5vbkJyb3dzZXJXaW5kb3dMb2FkZWRBbmRPbmxpbmVBdXRoTmVlZGVkKCk7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQnJvd3NlcldpbmRvd0xvYWRlZFNob3dTdGFydFdpbmRvdyA9IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgICAgIGF1dGhEYXRhID0gZGF0YTtcclxuICAgICAgICAoX2EgPSB0aGlzLnNwLmJyb3dzZXIpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5leGVjdXRlSmF2YVNjcmlwdChcIndpbmRvdz8udXNlTWVudVN0b3JlPy5nZXRTdGF0ZSgpLm9uU3RhcnQoXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGRhdGEpLCBcIilcIikpO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkJyb3dzZXJXaW5kb3dMb2FkZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgYnJvd3NlcldpbmRvd0xvYWRlZCBldmVudFwiKTtcclxuICAgICAgICB0aGlzLnRyaWdnZXIuYnJvd3NlcldpbmRvd0xvYWRlZEZpcmVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLm9uQnJvd3NlcldpbmRvd0xvYWRlZEFuZE9ubGluZUF1dGhOZWVkZWQoKTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25DcmVhdGVBY3Rvck1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmIChlLm1lc3NhZ2UuaXNNZSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hdXRoRGlhbG9nT3Blbikge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBjcmVhdGVBY3Rvck1lc3NhZ2UgZm9yIHNlbGYsIHJlc2V0dGluZyB3aWRnZXRzXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KCd3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cy5zZXQoW10pOycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoRGlhbG9nT3BlbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBjcmVhdGVBY3Rvck1lc3NhZ2UgZm9yIHNlbGYsIGJ1dCBhdXRoIGRpYWxvZyB3YXMgbm90IG9wZW4gc28gbm90IHJlc2V0dGluZyB3aWRnZXRzXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25DdXN0b21QYWNrZXRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIG1zZ0NvbnRlbnQgPSB7fTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBtc2dDb250ZW50ID0gSlNPTi5wYXJzZShtc2cuY29udGVudEpzb25EdW1wKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvbkN1c3RvbVBhY2tldE1lc3NhZ2UgZmFpbGVkIHRvIHBhcnNlIEpTT05cIiwgZS5tZXNzYWdlLCBcImpzb246XCIsIG1zZy5jb250ZW50SnNvbkR1bXApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBzd2l0Y2ggKG1zZ0NvbnRlbnRbXCJjdXN0b21QYWNrZXRUeXBlXCJdKSB7XHJcbiAgICAgICAgICAgIC8vIGNhc2UgJ2xvZ2luUmVxdWlyZWQnOlxyXG4gICAgICAgICAgICAvLyAgIGxvZ1RyYWNlKHRoaXMsICdsb2dpblJlcXVpcmVkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgIC8vICAgdGhpcy5sb2dpbldpdGhTa3ltcElvQ3JlZGVudGlhbHMoKTtcclxuICAgICAgICAgICAgLy8gICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbG9naW5GYWlsZWROb3RMb2dnZWRWaWFEaXNjb3JkJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ2xvZ2luRmFpbGVkTm90TG9nZ2VkVmlhRGlzY29yZCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJ3BsZWFzZSBsb2dpbiB2aWEgZGlzY29yZCc7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAnbG9naW5GYWlsZWROb3RMb2dnZWRWaWFEaXNjb3JkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbG9naW5GYWlsZWROb3RJblRoZURpc2NvcmRTZXJ2ZXInOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnbG9naW5GYWlsZWROb3RJblRoZURpc2NvcmRTZXJ2ZXIgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICdwbGVhc2Ugam9pbiB0aGUgZGlzY29yZCBzZXJ2ZXInO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnJztcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ2xvZ2luRmFpbGVkTm90SW5UaGVEaXNjb3JkU2VydmVyIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbG9naW5GYWlsZWRCYW5uZWQnOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnbG9naW5GYWlsZWRCYW5uZWQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICd5b3UgYXJlIGJhbm5lZCc7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAnbG9naW5GYWlsZWRCYW5uZWQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdsb2dpbkZhaWxlZElwTWlzbWF0Y2gnOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnbG9naW5GYWlsZWRJcE1pc21hdGNoIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAnd2hhdCB3YXMgdGhhdD8nO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnJztcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ2xvZ2luRmFpbGVkSXBNaXNtYXRjaCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkJyb3dzZXJXaW5kb3dMb2FkZWRBbmRPbmxpbmVBdXRoTmVlZGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzTGlzdGVuQnJvd3Nlck1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJpc0xpc3RlbkJyb3dzZXJNZXNzYWdlIHdhcyBmYWxzZSBmb3Igc29tZSByZWFzb24sIGFib3J0aW5nIGF1dGhcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLnRyaWdnZXIuY29uZGl0aW9uTWV0KSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25Ccm93c2VyV2luZG93TG9hZGVkQW5kT25saW5lQXV0aE5lZWRlZCB3YWl0aW5nIGZvciBib3RoIHRyaWdnZXJzIHRvIGxvYWRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTaG93aW5nIHdpZGdldHMgYW5kIHN0YXJ0aW5nIGxvb3BcIik7XHJcbiAgICAgICAgLy8gTWFrZSBzdXJlIGF1dGggZGF0YSBpcyBsb2FkZWRcclxuICAgICAgICBpZiAoIWF1dGhEYXRhKSB7XHJcbiAgICAgICAgICAgIGF1dGhEYXRhID0gdGhpcy5yZWFkQXV0aERhdGFGcm9tRGlzaygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgICAgICAvLyBEZWxheSBpbml0aWFsIHN0YXRlIGluamVjdGlvbiB0byBlbnN1cmUgUmVhY3QgaXMgbW91bnRlZFxyXG4gICAgICAgIHZhciB0aW1lcnNTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFRpbWVyc1NlcnZpY2UpO1xyXG4gICAgICAgIHRpbWVyc1NlcnZpY2Uuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCAnU2VuZGluZyBpbml0aWFsIGF1dGggc3RhdGUgdG8gUmVhY3QgVUknKTtcclxuICAgICAgICAgICAgX3RoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICB9LCA1MDApO1xyXG4gICAgICAgIC8vIFN0YXJ0IERpc2NvcmQgT0F1dGggbG9naW4gc3RhdGUgY2hlY2tpbmcgbG9vcFxyXG4gICAgICAgIHRoaXMuY2hlY2tMb2dpblN0YXRlKCk7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQnJvd3Nlck1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmICghdGhpcy5pc0xpc3RlbkJyb3dzZXJNZXNzYWdlKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25Ccm93c2VyTWVzc2FnZTogaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSB3YXMgZmFsc2UsIGlnbm9yaW5nIG1lc3NhZ2VcIiwgSlNPTi5zdHJpbmdpZnkoZS5hcmd1bWVudHMpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2V0dGluZ3NTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNldHRpbmdzU2VydmljZSk7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbkJyb3dzZXJNZXNzYWdlOlwiLCBKU09OLnN0cmluZ2lmeShlLmFyZ3VtZW50cykpO1xyXG4gICAgICAgIHZhciBldmVudEtleSA9IGUuYXJndW1lbnRzWzBdO1xyXG4gICAgICAgIHN3aXRjaCAoZXZlbnRLZXkpIHtcclxuICAgICAgICAgICAgY2FzZSBldmVudHMub3BlbkRpc2NvcmRPYXV0aDpcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib3BlbkRpc2NvcmRPYXV0aCBldmVudCByZWNlaXZlZCwgb3BlbmluZyBicm93c2VyXCIpO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnb3BlbmluZyBicm93c2VyLi4uJztcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIHZhciBzZXR0aW5nc1NlcnZpY2VfMSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXR0aW5nc1NlcnZpY2UpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRpc2NvcmRBdXRoQmFzZVVybCA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiZGlzY29yZC1hdXRoLXVybFwiXSB8fCBcImh0dHA6Ly9sb2NhbGhvc3Q6XCIuY29uY2F0KHRoaXMuZ2V0U2VydmVyUG9ydCgpKTtcclxuICAgICAgICAgICAgICAgIHZhciBkaXNjb3JkQXV0aFVybCA9IFwiXCIuY29uY2F0KGRpc2NvcmRBdXRoQmFzZVVybCwgXCIvYXBpL3VzZXJzL2xvZ2luLWRpc2NvcmQ/c3RhdGU9XCIpLmNvbmNhdCh0aGlzLmRpc2NvcmRBdXRoU3RhdGUpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJMb2FkaW5nIERpc2NvcmQgT0F1dGggVVJMOlwiLCBkaXNjb3JkQXV0aFVybCk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIndpbjMyIG9iamVjdDpcIiwgdGhpcy5zcC53aW4zMik7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3Aud2luMzIubG9hZFVybChkaXNjb3JkQXV0aFVybCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJ3aW4zMi5sb2FkVXJsIGNhbGxlZCBzdWNjZXNzZnVsbHlcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkZhaWxlZCB0byBjYWxsIHdpbjMyLmxvYWRVcmw6XCIsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIExhdW5jaCBjaGVja0xvZ2luU3RhdGUgbG9vcFxyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja0xvZ2luU3RhdGUoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5hdXRoQXR0ZW1wdDpcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiYXV0aEF0dGVtcHQgZXZlbnQgcmVjZWl2ZWQgKENvbm5lY3QgYnV0dG9uIGNsaWNrZWQpXCIpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDdXJyZW50IGF1dGhEYXRhOlwiLCBhdXRoRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXV0aERhdGEgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcImF1dGhEYXRhIGlzIG51bGwsIGNhbm5vdCBjb25uZWN0XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJ3BsZWFzZSBsb2dpbiBmaXJzdCc7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJFbWl0dGluZyBhdXRoQXR0ZW1wdCBldmVudCB3aXRoIGF1dGhEYXRhOlwiLCBKU09OLnN0cmluZ2lmeShhdXRoRGF0YSkpO1xyXG4gICAgICAgICAgICAgICAgLy8gRW1pdCBhdXRoQXR0ZW1wdCBldmVudCB0byB0cmlnZ2VyIGNvbm5lY3Rpb25cclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhdXRoQXR0ZW1wdFwiLCB7IGF1dGhHYW1lRGF0YTogeyByZW1vdGU6IGF1dGhEYXRhIH0gfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmNsZWFyQXV0aERhdGE6XHJcbiAgICAgICAgICAgICAgICAvLyBEb2Vzbid0IHNlZW0gdG8gYmUgdXNlZCAtIGxhdW5jaGVyIG1hbmFnZXMgYXV0aCBkYXRhXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMub3BlbkdpdGh1YjpcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Aud2luMzIubG9hZFVybCh0aGlzLmdpdGh1YlVybCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMub3BlblBhdHJlb246XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLndpbjMyLmxvYWRVcmwodGhpcy5wYXRyZW9uVXJsKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy51cGRhdGVSZXF1aXJlZDpcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Aud2luMzIubG9hZFVybChcImh0dHBzOi8vc2t5bXAubmV0L1VwZEluc3RhbGxcIik7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuYmFja1RvTG9naW46XHJcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB1c2VyIG1hbnVhbGx5IHdlbnQgYmFjayBmcm9tIGNoYXJhY3RlciBzZWxlY3RcclxuICAgICAgICAgICAgICAgIHZhciBjaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKENoYXJhY3RlclNlbGVjdFNlcnZpY2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoYXJhY3RlclNlbGVjdFNlcnZpY2UgJiYgY2hhcmFjdGVyU2VsZWN0U2VydmljZS5yZXNldEF1dGhTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdVc2VyIG1hbnVhbGx5IHdlbnQgYmFjayBmcm9tIGNoYXJhY3RlciBzZWxlY3QsIHJlc2V0dGluZyBhdXRoIHN0YXRlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgZmxhZ1xyXG4gICAgICAgICAgICAgICAgICAgIGNoYXJhY3RlclNlbGVjdFNlcnZpY2UucmVzZXRBdXRoU3RhdGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBwcm9ncmVzcyBpbmRpY2F0b3IgdG8gcHJldmVudCBhdXRvLWNvbm5lY3RcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBsb2dnaW5nIHN0YXJ0IG1vbWVudFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBhbnkgZXJyb3IgbWVzc2FnZXNcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gUmVsb2FkIGF1dGggZGF0YSBmcm9tIGRpc2sgc28gdXNlciBzZWVzIHRoZWlyIHByZXZpb3VzIGFjY291bnQgaW5mb1xyXG4gICAgICAgICAgICAgICAgYXV0aERhdGEgPSB0aGlzLnJlYWRBdXRoRGF0YUZyb21EaXNrKCk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUmVsb2FkZWQgYXV0aCBkYXRhIGFmdGVyIEJhY2sgYnV0dG9uIHByZXNzZWQ6JywgYXV0aERhdGEgPyAnZm91bmQnIDogJ25vdCBmb3VuZCcpO1xyXG4gICAgICAgICAgICAgICAgLy8gUmVmcmVzaCB0aGUgUmVhY3QgVUkgd2l0aCB1cGRhdGVkIGF1dGggc3RhdGVcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5qb2luRGlzY29yZDpcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Aud2luMzIubG9hZFVybCh0aGlzLmRpc2NvcmRVcmwpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ3JlcXVlc3RBdXRoU3RhdGUnOlxyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1JlYWN0IFVJIHJlcXVlc3RpbmcgYXV0aCBzdGF0ZSwgc2VuZGluZyBjdXJyZW50IHN0YXRlJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiVW5rbm93biBldmVudCBrZXlcIiwgZXZlbnRLZXkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5jcmVhdGVQbGF5U2Vzc2lvbiA9IGZ1bmN0aW9uICh0b2tlbiwgY2FsbGJhY2spIHtcclxuICAgICAgICB2YXIgY2xpZW50ID0gbmV3IHRoaXMuc3AuSHR0cENsaWVudChcImh0dHA6Ly9sb2NhbGhvc3Q6XCIuY29uY2F0KHRoaXMuZ2V0U2VydmVyUG9ydCgpKSk7XHJcbiAgICAgICAgdmFyIHJvdXRlID0gXCIvYXBpL3VzZXJzL21lL3BsYXkvbWFpblwiO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ3JlYXRpbmcgcGxheSBzZXNzaW9uIFwiLmNvbmNhdChyb3V0ZSkpO1xyXG4gICAgICAgIGNsaWVudC5wb3N0KHJvdXRlLCB7XHJcbiAgICAgICAgICAgIGJvZHk6ICd7fScsXHJcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICdhdXRob3JpemF0aW9uJzogXCJCZWFyZXIgXCIuY29uY2F0KHRva2VuKSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIH0sIGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXMgIT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygnJywgJ3N0YXR1cyBjb2RlICcgKyByZXMuc3RhdHVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IGhhbmRsZSBKU09OLnBhcnNlIGZhaWx1cmU/XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhKU09OLnBhcnNlKHJlcy5ib2R5KS5zZXNzaW9uLCAnJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuY2hlY2tMb2dpblN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzTGlzdGVuQnJvd3Nlck1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJjaGVja0xvZ2luU3RhdGU6IGlzTGlzdGVuQnJvd3Nlck1lc3NhZ2Ugd2FzIGZhbHNlLCBhYm9ydGluZyBjaGVja1wiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdGltZXJzU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihUaW1lcnNTZXJ2aWNlKTtcclxuICAgICAgICAvLyBTb2NpYWwgZW5naW5lZXJpbmcgcHJvdGVjdGlvbiwgZG9uJ3Qgc2hvdyB0aGUgZnVsbCBzdGF0ZVxyXG4gICAgICAgIHZhciBoYWxmRGlzY29yZEF1dGhTdGF0ZSA9IHRoaXMuZGlzY29yZEF1dGhTdGF0ZS5zbGljZSgwLCAxNik7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDaGVja2luZyBsb2dpbiBzdGF0ZVwiLCBoYWxmRGlzY29yZEF1dGhTdGF0ZSwgJy4uLicpO1xyXG4gICAgICAgIG5ldyB0aGlzLnNwLkh0dHBDbGllbnQoXCJodHRwOi8vbG9jYWxob3N0OlwiLmNvbmNhdCh0aGlzLmdldFNlcnZlclBvcnQoKSkpXHJcbiAgICAgICAgICAgIC5nZXQoXCIvYXBpL3VzZXJzL2xvZ2luLWRpc2NvcmQvc3RhdHVzP3N0YXRlPVwiICsgdGhpcy5kaXNjb3JkQXV0aFN0YXRlLCB1bmRlZmluZWQsIFxyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgc3dpdGNoIChyZXNwb25zZS5zdGF0dXMpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgMjAwOlxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBfYSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSksIHRva2VuID0gX2EudG9rZW4sIG1hc3RlckFwaUlkXzEgPSBfYS5tYXN0ZXJBcGlJZCwgZGlzY29yZFVzZXJuYW1lXzEgPSBfYS5kaXNjb3JkVXNlcm5hbWUsIGRpc2NvcmREaXNjcmltaW5hdG9yXzEgPSBfYS5kaXNjb3JkRGlzY3JpbWluYXRvciwgZGlzY29yZEF2YXRhcl8xID0gX2EuZGlzY29yZEF2YXRhcjtcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuZmFpbENvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jcmVhdGVQbGF5U2Vzc2lvbih0b2tlbiwgZnVuY3Rpb24gKHBsYXlTZXNzaW9uLCBlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5mYWlsQ291bnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJzU2VydmljZS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmNoZWNrTG9naW5TdGF0ZSgpOyB9LCBNYXRoLmZsb29yKCgxLjUgKyBNYXRoLnJhbmRvbSgpICogMikgKiAxMDAwKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbjogcGxheVNlc3Npb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXN0ZXJBcGlJZDogbWFzdGVyQXBpSWRfMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvcmRVc2VybmFtZTogZGlzY29yZFVzZXJuYW1lXzEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkRGlzY3JpbWluYXRvcjogZGlzY29yZERpc2NyaW1pbmF0b3JfMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvcmRBdmF0YXI6IGRpc2NvcmRBdmF0YXJfMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRGlzY29yZCBhdXRoIHN1Y2Nlc3NmdWwsIGF1dGhEYXRhIHNldDpcIiwgSlNPTi5zdHJpbmdpZnkoYXV0aERhdGEpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnY29ubmVjdGVkIHN1Y2Nlc3NmdWxseSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDQwMTogLy8gVW5hdXRob3JpemVkXHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmZhaWxDb3VudCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnJzsgLy8oYFN0aWxsIHdhaXRpbmcuLi5gKTtcclxuICAgICAgICAgICAgICAgICAgICB0aW1lcnNTZXJ2aWNlLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuY2hlY2tMb2dpblN0YXRlKCk7IH0sIE1hdGguZmxvb3IoKDEuNSArIE1hdGgucmFuZG9tKCkgKiAyKSAqIDEwMDApKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDAzOiAvLyBGb3JiaWRkZW5cclxuICAgICAgICAgICAgICAgIGNhc2UgNDA0OiAvLyBOb3QgZm91bmRcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuZmFpbENvdW50ID0gOTAwMDtcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9IChcIkZhaWw6IFwiLmNvbmNhdChyZXNwb25zZS5ib2R5KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICsrYnJvd3NlclN0YXRlLmZhaWxDb3VudDtcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9IFwiU2VydmVyIHJldHVybmVkIFwiLmNvbmNhdChyZXNwb25zZS5zdGF0dXMudG9TdHJpbmcoKSB8fCBcIj8/P1wiLCBcIiBcXFwiXCIpLmNvbmNhdChyZXNwb25zZS5ib2R5IHx8IHJlc3BvbnNlLmVycm9yLCBcIlxcXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGltZXJzU2VydmljZS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmNoZWNrTG9naW5TdGF0ZSgpOyB9LCBNYXRoLmZsb29yKCgxLjUgKyBNYXRoLnJhbmRvbSgpICogMikgKiAxMDAwKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUucmVmcmVzaFdpZGdldHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgJ3JlZnJlc2hBdXRoVUkgY2FsbGVkJyk7XHJcbiAgICAgICAgLy8gSW5qZWN0IGF1dGggc3RhdGUgaW50byB3aW5kb3cgZm9yIFJlYWN0IFVJXHJcbiAgICAgICAgdmFyIGF1dGhTdGF0ZSA9IHtcclxuICAgICAgICAgICAgYXV0aERhdGE6IGF1dGhEYXRhLFxyXG4gICAgICAgICAgICBjb21tZW50OiBicm93c2VyU3RhdGUuY29tbWVudCxcclxuICAgICAgICAgICAgbG9naW5GYWlsZWRSZWFzb246IGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbixcclxuICAgICAgICAgICAgaXNDb25uZWN0aW5nOiB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3JcclxuICAgICAgICB9O1xyXG4gICAgICAgIHZhciBpbmplY3RTY3JpcHQgPSBcIlxcbiAgICAgIHdpbmRvdy5za3ltcCA9IHdpbmRvdy5za3ltcCB8fCB7fTtcXG4gICAgICB3aW5kb3cuc2t5bXAuYXV0aCA9IFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShhdXRoU3RhdGUpLCBcIjtcXG4gICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wOmF1dGhVcGRhdGUnLCB7IGRldGFpbDogXCIpLmNvbmNhdChKU09OLnN0cmluZ2lmeShhdXRoU3RhdGUpLCBcIiB9KSk7XFxuICAgIFwiKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoaW5qZWN0U2NyaXB0KTtcclxuICAgICAgICB0aGlzLmF1dGhEaWFsb2dPcGVuID0gdHJ1ZTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUucmVhZEF1dGhEYXRhRnJvbURpc2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWFkaW5nXCIsIHRoaXMucGx1Z2luQXV0aERhdGFOYW1lLCBcImZyb20gZGlza1wiKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuc3AuZ2V0UGx1Z2luU291cmNlQ29kZSh0aGlzLnBsdWdpbkF1dGhEYXRhTmFtZSwgXCJQbHVnaW5zTm9Mb2FkXCIpO1xyXG4gICAgICAgICAgICBpZiAoIWRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVhZCBlbXB0eVwiLCB0aGlzLnBsdWdpbkF1dGhEYXRhTmFtZSwgXCJyZXR1cm5pbmcgbnVsbFwiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEuc2xpY2UoMikpIHx8IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRXJyb3IgcmVhZGluZ1wiLCB0aGlzLnBsdWdpbkF1dGhEYXRhTmFtZSwgXCJmcm9tIGRpc2s6XCIsIGUsIFwiLCBmYWxsaW5nIGJhY2sgdG8gbnVsbFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS53cml0ZUF1dGhEYXRhVG9EaXNrID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAvLyBBdXRoIGRhdGEgd3JpdGluZyBpcyBoYW5kbGVkIGJ5IHRoZSBsYXVuY2hlciwgY2xpZW50IG9ubHkgcmVhZHNcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkF1dGggZGF0YSB3cml0aW5nIGRpc2FibGVkIC0gbGF1bmNoZXIgbWFuYWdlcyBhdXRoIGRhdGFcIik7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLmhhbmRsZUNvbm5lY3Rpb25EZW5pZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKGUuZXJyb3IudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhcImludmFsaWQgcGFzc3dvcmRcIikpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAnaW52YWxpZCBwYXNzd29yZCc7XHJcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmRpc2FibGVQbGF5ZXJDb250cm9scyh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCAwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ2Nvbm5lY3Rpb25EZW5pZWQgZXZlbnQgcmVjZWl2ZWQnKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLmhhbmRsZUNvbm5lY3Rpb25BY2NlcHRlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcImhhbmRsZUNvbm5lY3Rpb25BY2NlcHRlZCBjYWxsZWRcIik7XHJcbiAgICAgICAgLy8gS2VlcCBicm93c2VyIG1lc3NhZ2UgbGlzdGVuZXIgYWN0aXZlIHNvIHVzZXIgY2FuIHN0aWxsIGludGVyYWN0IHdpdGggYXV0aCBtZW51XHJcbiAgICAgICAgLy8gdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZShmYWxzZSwgJ2Nvbm5lY3Rpb25BY2NlcHRlZCBldmVudCByZWNlaXZlZCcpO1xyXG4gICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB2YXIgYXV0aERhdGEgPSB0aGlzLnNwLnN0b3JhZ2VbYXV0aEdhbWVEYXRhU3RvcmFnZUtleV07XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJBdXRoIGRhdGEgZnJvbSBzdG9yYWdlOlwiLCBKU09OLnN0cmluZ2lmeShhdXRoRGF0YSkpO1xyXG4gICAgICAgIGlmIChhdXRoRGF0YSA9PT0gbnVsbCB8fCBhdXRoRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aERhdGEubG9jYWwpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJMb2dnaW5nIGluIG9mZmxpbmUgbW9kZSwgcHJvZmlsZUlkID1cIiwgYXV0aERhdGEubG9jYWwucHJvZmlsZUlkKTtcclxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbVBhY2tldCxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRKc29uRHVtcDogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbVBhY2tldFR5cGU6ICdsb2dpbldpdGhTa3ltcElvJyxcclxuICAgICAgICAgICAgICAgICAgICBnYW1lRGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9maWxlSWQ6IGF1dGhEYXRhLmxvY2FsLnByb2ZpbGVJZCxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYXV0aERhdGEgPT09IG51bGwgfHwgYXV0aERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhEYXRhLnJlbW90ZSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnTG9nZ2luZyBpbiBhcyBhIG1hc3RlciBBUEkgdXNlcicpO1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tUGFja2V0LFxyXG4gICAgICAgICAgICAgICAgY29udGVudEpzb25EdW1wOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tUGFja2V0VHlwZTogJ2xvZ2luV2l0aFNreW1wSW8nLFxyXG4gICAgICAgICAgICAgICAgICAgIGdhbWVEYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb246IGF1dGhEYXRhLnJlbW90ZS5zZXNzaW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXN0ZXJBcGlJZDogYXV0aERhdGEucmVtb3RlLm1hc3RlckFwaUlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkVXNlcm5hbWU6IGF1dGhEYXRhLnJlbW90ZS5kaXNjb3JkVXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvcmREaXNjcmltaW5hdG9yOiBhdXRoRGF0YS5yZW1vdGUuZGlzY29yZERpc2NyaW1pbmF0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2NvcmRBdmF0YXI6IGF1dGhEYXRhLnJlbW90ZS5kaXNjb3JkQXZhdGFyLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvZ0Vycm9yKHRoaXMsICdOb3QgZm91bmQgYXV0aGVudGljYXRpb24gbWV0aG9kJyk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uVGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBUT0RPOiBTaG91bGQgYmUgbm8gaGFyZGNvZGVkL21hZ2ljLW51bWJlciBsaW1pdFxyXG4gICAgICAgIC8vIFRPRE86IEJ1c3kgd2FpdGluZyBpcyBiYWQuIFNob3VsZCBiZSByZXBsYWNlZCB3aXRoIHNvbWUga2luZCBvZiBldmVudFxyXG4gICAgICAgIHZhciBtYXhMb2dnaW5nRGVsYXkgPSAxNTAwMDtcclxuICAgICAgICBpZiAodGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgJiYgRGF0ZS5ub3coKSAtIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID4gbWF4TG9nZ2luZ0RlbGF5KSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdNYXggbG9nZ2luZyBkZWxheSByZWFjaGVkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBsYXllckV2ZXJTYXdBY3R1YWxHYW1lcGxheSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1BsYXllciBzYXcgYWN0dWFsIGdhbWVwbGF5LCByZWNvbm5lY3RpbmcnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkucmVjb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBzaG91bGQgd2UgcHJvbXB0IHVzZXIgdG8gcmVsb2dpbj9cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdQbGF5ZXIgbmV2ZXIgc2F3IGFjdHVhbCBnYW1lcGxheSwgc2hvd2luZyBsb2dpbiBkaWFsb2cnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJ3RlY2huaWNhbCBkaWZmaWN1bHRpZXNcXG5wbGVhc2UgdHJ5IGFnYWluXFxub3IgY29udGFjdCB1cyBvbiBkaXNjb3JkJztcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGF1dGhEYXRhID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIC8vIE5vdGU6IEF1dGggZGF0YSBjbGVhbnVwIGhhbmRsZWQgYnkgbGF1bmNoZXJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvckNvdW50ZXIrKztcclxuICAgICAgICAgICAgaWYgKHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvckNvdW50ZXIgPT09IDEwMDAwMDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvckNvdW50ZXIgPSAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBzbG93Q291bnRlciA9IE1hdGguZmxvb3IodGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yQ291bnRlciAvIDE1KTtcclxuICAgICAgICAgICAgdmFyIG5ld1Nsb3dDb3VudGVyID0gTWF0aC5mbG9vcihzbG93Q291bnRlciAvIDEpOyAvLyBPbmx5IGNoYW5nZXMgZXZlcnkgfjE1IHRpY2tzXHJcbiAgICAgICAgICAgIC8vIE9ubHkgcmVmcmVzaCB3aWRnZXRzIHdoZW4gdGhlIGRvdCBwYXR0ZXJuIGNoYW5nZXNcclxuICAgICAgICAgICAgaWYgKG5ld1Nsb3dDb3VudGVyICE9PSB0aGlzLmxhc3RTbG93Q291bnRlcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0U2xvd0NvdW50ZXIgPSBuZXdTbG93Q291bnRlcjtcclxuICAgICAgICAgICAgICAgIHZhciBkb3QgPSBzbG93Q291bnRlciAlIDMgPT09IDAgPyAnLicgOiBzbG93Q291bnRlciAlIDMgPT09IDEgPyAnLi4nIDogJy4uLic7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9IFwiY29ubmVjdGluZ1wiICsgZG90O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMucGxheWVyRXZlclNhd0FjdHVhbEdhbWVwbGF5ID0gdHJ1ZTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faXNMaXN0ZW5Ccm93c2VyTWVzc2FnZTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UgPSBmdW5jdGlvbiAodmFsdWUsIHJlYXNvbikge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwic2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2U6XCIsIHZhbHVlLCBcInJlYXNvbjpcIiwgcmVhc29uKTtcclxuICAgICAgICB0aGlzLl9pc0xpc3RlbkJyb3dzZXJNZXNzYWdlID0gdmFsdWU7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLmdldFNlcnZlclBvcnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gVXNlIHRoZSBzYW1lIHBvcnQgdGhhdCB0aGUgVUkgc2VydmVyIHVzZXMgKHR5cGljYWxseSAzMDAwIGZvciBkZXYsIHBvcnQrMSBmb3IgY3VzdG9tIHBvcnRzKVxyXG4gICAgICAgIC8vIFRoaXMgbWF0Y2hlcyB0aGUgcGF0dGVybiBpbiB1aS50c1xyXG4gICAgICAgIHZhciBzZXR0aW5nc1NlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2V0dGluZ3NTZXJ2aWNlKTtcclxuICAgICAgICB2YXIgc2VydmVyUG9ydCA9IHNldHRpbmdzU2VydmljZS5nZXRTZXJ2ZXJQb3J0KCk7XHJcbiAgICAgICAgcmV0dXJuIHNlcnZlclBvcnQgPT09IDc3NzcgPyAzMDAwIDogc2VydmVyUG9ydCArIDE7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEF1dGhTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEF1dGhTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVRpY2soKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZS5wcm90b3R5cGUub25jZVRpY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIHRoaXMuc3AuYmxvY2tQYXB5cnVzRXZlbnRzKHRydWUpO1xyXG4gICAgfTtcclxuICAgIEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5URVNNb2RQbGF0Zm9ybS5ibG9ja1BhcHlydXNFdmVudHModHJ1ZSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIEJsb2NrZWRBbmltYXRpb25zU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgdmFyIGJsb2NrZWRBbmltcyA9IFtdO1xyXG4gICAgICAgIHZhciBzZWxmID0gX3RoaXM7XHJcbiAgICAgICAgYmxvY2tlZEFuaW1zLmZvckVhY2goZnVuY3Rpb24gKGJsb2NrZWRBbmltKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShzZWxmLCBcImJsb2NraW5nIGFuaW1hdGlvbiBldmVudFwiLCBjdHguYW5pbUV2ZW50TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoKSB7IH1cclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgYmxvY2tlZEFuaW0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIHJldHVybiBCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbi8vIFRPRE86IHNlbmQgZXZlbnQgaW5zdGVhZCBvZiBkaXJlY3QgZGVwZW5kZW5jeSBvbiBGb3JtVmlldyBjbGFzc1xyXG5pbXBvcnQgeyBGb3JtVmlldyB9IGZyb20gXCIuLi8uLi92aWV3L2Zvcm1WaWV3XCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgdW5mb2N1c0V2ZW50U3RyaW5nID0gXCJ3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wNS1jbGllbnQ6YnJvd3NlclVuZm9jdXNlZCcsIHt9KSlcIjtcclxudmFyIGZvY3VzRXZlbnRTdHJpbmcgPSBcIndpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA1LWNsaWVudDpicm93c2VyRm9jdXNlZCcsIHt9KSlcIjtcclxudmFyIEJyb3dzZXJTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEJyb3dzZXJTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQnJvd3NlclNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuYmFkTWVudXNPcGVuID0gbmV3IFNldCgpO1xyXG4gICAgICAgIF90aGlzLmJhZE1lbnVzID0gW1xyXG4gICAgICAgICAgICBcIkJhcnRlck1lbnVcIiAvKiBNZW51LkJhcnRlciAqLyxcclxuICAgICAgICAgICAgXCJCb29rIE1lbnVcIiAvKiBNZW51LkJvb2sgKi8sXHJcbiAgICAgICAgICAgIFwiQ29udGFpbmVyTWVudVwiIC8qIE1lbnUuQ29udGFpbmVyICovLFxyXG4gICAgICAgICAgICBcIkNyYWZ0aW5nIE1lbnVcIiAvKiBNZW51LkNyYWZ0aW5nICovLFxyXG4gICAgICAgICAgICBcIkdpZnRNZW51XCIgLyogTWVudS5HaWZ0ICovLFxyXG4gICAgICAgICAgICBcIkludmVudG9yeU1lbnVcIiAvKiBNZW51LkludmVudG9yeSAqLyxcclxuICAgICAgICAgICAgXCJKb3VybmFsIE1lbnVcIiAvKiBNZW51LkpvdXJuYWwgKi8sXHJcbiAgICAgICAgICAgIFwiTG9ja3BpY2tpbmcgTWVudVwiIC8qIE1lbnUuTG9ja3BpY2tpbmcgKi8sXHJcbiAgICAgICAgICAgIFwiTG9hZGluZyBNZW51XCIgLyogTWVudS5Mb2FkaW5nICovLFxyXG4gICAgICAgICAgICBcIk1hcE1lbnVcIiAvKiBNZW51Lk1hcCAqLyxcclxuICAgICAgICAgICAgXCJSYWNlU2V4IE1lbnVcIiAvKiBNZW51LlJhY2VTZXggKi8sXHJcbiAgICAgICAgICAgIFwiU3RhdHNNZW51XCIgLyogTWVudS5TdGF0cyAqLyxcclxuICAgICAgICAgICAgXCJUd2Vlbk1lbnVcIiAvKiBNZW51LlR3ZWVuICovLFxyXG4gICAgICAgICAgICAvL01lbnUuQ29uc29sZSxcclxuICAgICAgICAgICAgLy9NZW51Lk1haW4sXHJcbiAgICAgICAgXTtcclxuICAgICAgICBfdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUoZmFsc2UpO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInF1ZXJ5S2V5Q29kZUJpbmRpbmdzXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblF1ZXJ5S2V5Q29kZUJpbmRpbmdzKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwiYnJvd3Nlck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQnJvd3Nlck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJtZW51T3BlblwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25NZW51T3BlbihlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcIm1lbnVDbG9zZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25NZW51Q2xvc2UoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIC8vIFRPRE86IGtleWNvZGVzIHNob3VsZCBiZSBjb25maWd1cmFibGVcclxuICAgIEJyb3dzZXJTZXJ2aWNlLnByb3RvdHlwZS5vblF1ZXJ5S2V5Q29kZUJpbmRpbmdzID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoZS5pc0Rvd24oWzU5IC8qIER4U2NhbkNvZGUuRjEgKi9dKSkge1xyXG4gICAgICAgICAgICBGb3JtVmlldy5pc0Rpc3BsYXlpbmdOaWNrbmFtZXMgPSAhRm9ybVZpZXcuaXNEaXNwbGF5aW5nTmlja25hbWVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZS5pc0Rvd24oWzYwIC8qIER4U2NhbkNvZGUuRjIgKi9dKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSghdGhpcy5zcC5icm93c2VyLmlzVmlzaWJsZSgpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuYmFkTWVudXNPcGVuLnNpemUgPT09IDAgJiYgZS5pc0Rvd24oWzY0IC8qIER4U2NhbkNvZGUuRjYgKi9dKSkge1xyXG4gICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSAhdGhpcy5zcC5icm93c2VyLmlzRm9jdXNlZCgpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZChuZXdTdGF0ZSk7XHJcbiAgICAgICAgICAgIGlmIChuZXdTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGZvY3VzRXZlbnRTdHJpbmcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KHVuZm9jdXNFdmVudFN0cmluZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuYmFkTWVudXNPcGVuLnNpemUgPT09IDAgJiYgZS5pc0Rvd24oWzI4IC8qIER4U2NhbkNvZGUuRW50ZXIgKi9dKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGZvY3VzRXZlbnRTdHJpbmcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZS5pc0Rvd24oWzEgLyogRHhTY2FuQ29kZS5Fc2NhcGUgKi9dKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5icm93c2VyLmlzRm9jdXNlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQodW5mb2N1c0V2ZW50U3RyaW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBCcm93c2VyU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgIH07XHJcbiAgICBCcm93c2VyU2VydmljZS5wcm90b3R5cGUub25Ccm93c2VyTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIG9uRnJvbnRMb2FkZWRFdmVudEtleSA9IFwiZnJvbnQtbG9hZGVkXCI7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBicm93c2VyIG1lc3NhZ2U6XCIsIEpTT04uc3RyaW5naWZ5KGUuYXJndW1lbnRzKSk7XHJcbiAgICAgICAgaWYgKGUuYXJndW1lbnRzWzBdID09PSBvbkZyb250TG9hZGVkRXZlbnRLZXkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBmcm9udC1sb2FkZWQgbWVzc2FnZSwgZW1pdHRpbmcgYnJvd3NlcldpbmRvd0xvYWRlZCBldmVudFwiKTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImJyb3dzZXJXaW5kb3dMb2FkZWRcIiwge30pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBCcm93c2VyU2VydmljZS5wcm90b3R5cGUub25NZW51T3BlbiA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNCYWRNZW51KGUubmFtZSkpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUoZmFsc2UpO1xyXG4gICAgICAgICAgICB0aGlzLmJhZE1lbnVzT3Blbi5hZGQoZS5uYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoZS5uYW1lID09PSBcIkhVRCBNZW51XCIgLyogTWVudS5IVUQgKi8pIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEJyb3dzZXJTZXJ2aWNlLnByb3RvdHlwZS5vbk1lbnVDbG9zZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuYmFkTWVudXNPcGVuLmRlbGV0ZShlLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmJhZE1lbnVzT3Blbi5zaXplID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZS5uYW1lID09PSBcIkhVRCBNZW51XCIgLyogTWVudS5IVUQgKi8pIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBCcm93c2VyU2VydmljZS5wcm90b3R5cGUuaXNCYWRNZW51ID0gZnVuY3Rpb24gKG1lbnUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5iYWRNZW51cy5pbmNsdWRlcyhtZW51KTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQnJvd3NlclNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQnJvd3NlclNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBOZXR3b3JraW5nU2VydmljZSB9IGZyb20gXCIuL25ldHdvcmtpbmdTZXJ2aWNlXCI7XHJcbi8vIEV2ZW50cyB1c2VkIG9uIGJvdGggY2xpZW50IGFuZCBicm93c2VyIHNpZGVcclxudmFyIGV2ZW50cyA9IHtcclxuICAgIHNlbGVjdENoYXJhY3RlcjogJ2NoYXJhY3RlclNlbGVjdF9zZWxlY3QnLFxyXG4gICAgY3JlYXRlQ2hhcmFjdGVyOiAnY2hhcmFjdGVyU2VsZWN0X2NyZWF0ZScsXHJcbiAgICBkZWxldGVDaGFyYWN0ZXI6ICdjaGFyYWN0ZXJTZWxlY3RfZGVsZXRlJyxcclxuICAgIGJhY2tUb0xvZ2luOiAnY2hhcmFjdGVyU2VsZWN0X2JhY2snLFxyXG59O1xyXG52YXIgQ2hhcmFjdGVyU2VsZWN0U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQ2hhcmFjdGVyU2VsZWN0U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jaGFyYWN0ZXJTZWxlY3RBY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5yZXNldEF1dGhTdGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImN1c3RvbVBhY2tldE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3VzdG9tUGFja2V0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImJyb3dzZXJNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkJyb3dzZXJNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ3JlYXRlQWN0b3JNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICAvLyBMaXN0ZW4gZm9yIGxvZ2luU3VjY2VzcyBldmVudCBmcm9tIEF1dGhTZXJ2aWNlXHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwibG9naW5TdWNjZXNzXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkxvZ2luU3VjY2VzcyhlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUub25Mb2dpblN1Y2Nlc3MgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgbG9naW5TdWNjZXNzIGV2ZW50LCB1c2VyIGF1dGhlbnRpY2F0ZWRcIik7XHJcbiAgICAgICAgLy8gVGhlIHNlcnZlciB3aWxsIHNlbmQgY2hhcmFjdGVyIGxpc3QgYXV0b21hdGljYWxseSBhZnRlciBsb2dpblxyXG4gICAgICAgIC8vIE5vIG5lZWQgdG8gcmVxdWVzdCBpdCBoZXJlXHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUub25DdXN0b21QYWNrZXRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSBKU09OLnBhcnNlKGV2ZW50Lm1lc3NhZ2UuY29udGVudEpzb25EdW1wKTtcclxuICAgICAgICAgICAgc3dpdGNoIChjb250ZW50LmN1c3RvbVBhY2tldFR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjaGFyYWN0ZXJMaXN0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVDaGFyYWN0ZXJMaXN0KGNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNoYXJhY3RlckVycm9yXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVDaGFyYWN0ZXJFcnJvcihjb250ZW50Lm1lc3NhZ2UgfHwgXCJVbmtub3duIGVycm9yIG9jY3VycmVkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRXJyb3IgcGFyc2luZyBjdXN0b20gcGFja2V0OiBcIi5jb25jYXQoZSkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5oYW5kbGVDaGFyYWN0ZXJMaXN0ID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGNoYXJhY3RlciBsaXN0OiBcIi5jb25jYXQoZGF0YS5jaGFyYWN0ZXJzLmxlbmd0aCwgXCIgY2hhcmFjdGVycywgXCIpLmNvbmNhdChkYXRhLm1heFNsb3RzLCBcIiBtYXggc2xvdHNcIikpO1xyXG4gICAgICAgIHRoaXMuY2hhcmFjdGVyU2VsZWN0QWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICAvLyBJbmplY3QgZGF0YSBpbnRvIHdpbmRvdyBmb3IgY3VzdG9tIFVJIGFjY2VzcyAoZm9sbG93aW5nIHNreXJpbS1yb2xlcGxheSBwYXR0ZXJuKVxyXG4gICAgICAgIHZhciBpbmplY3RTY3JpcHQgPSBcIlxcbiAgICAgIHdpbmRvdy5za3ltcCA9IHdpbmRvdy5za3ltcCB8fCB7fTtcXG4gICAgICB3aW5kb3cuc2t5bXAuY2hhcmFjdGVyU2VsZWN0ID0gXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGRhdGEpLCBcIjtcXG4gICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wOmNoYXJhY3Rlckxpc3QnLCB7IGRldGFpbDogXCIpLmNvbmNhdChKU09OLnN0cmluZ2lmeShkYXRhKSwgXCIgfSkpO1xcbiAgICBcIik7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGluamVjdFNjcmlwdCk7XHJcbiAgICAgICAgLy8gU2hvdyBicm93c2VyIGZvciBjaGFyYWN0ZXIgc2VsZWN0aW9uIFVJXHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUuaGFuZGxlQ2hhcmFjdGVyRXJyb3IgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xyXG4gICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiQ2hhcmFjdGVyIGVycm9yOiBcIi5jb25jYXQobWVzc2FnZSkpO1xyXG4gICAgICAgIC8vIEluamVjdCBlcnJvciBpbnRvIHdpbmRvdyBmb3IgY3VzdG9tIFVJIGFjY2Vzc1xyXG4gICAgICAgIHZhciBpbmplY3RTY3JpcHQgPSBcIlxcbiAgICAgIHdpbmRvdy5za3ltcCA9IHdpbmRvdy5za3ltcCB8fCB7fTtcXG4gICAgICB3aW5kb3cuc2t5bXAuY2hhcmFjdGVyU2VsZWN0RXJyb3IgPSBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSksIFwiO1xcbiAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA6Y2hhcmFjdGVyRXJyb3InLCB7IGRldGFpbDogXCIpLmNvbmNhdChKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6IG1lc3NhZ2UgfSksIFwiIH0pKTtcXG4gICAgXCIpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChpbmplY3RTY3JpcHQpO1xyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLm9uQ3JlYXRlQWN0b3JNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAvLyBIaWRlIGNoYXJhY3RlciBzZWxlY3Qgc2NyZWVuIHdoZW4gcGxheWVyIHNwYXducyBpbiB3b3JsZFxyXG4gICAgICAgIGlmICh0aGlzLmNoYXJhY3RlclNlbGVjdEFjdGl2ZSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlBsYXllciBzcGF3bmVkLCBoaWRpbmcgY2hhcmFjdGVyIHNlbGVjdCBzY3JlZW5cIik7XHJcbiAgICAgICAgICAgIHZhciBjbGVhclNjcmlwdCA9IFwiXFxuICAgICAgICBpZiAod2luZG93LnNreW1wKSB7XFxuICAgICAgICAgIHdpbmRvdy5za3ltcC5jaGFyYWN0ZXJTZWxlY3QgPSBudWxsO1xcbiAgICAgICAgICB3aW5kb3cuc2t5bXAuY2hhcmFjdGVyU2VsZWN0RXJyb3IgPSBudWxsO1xcbiAgICAgICAgfVxcbiAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDpjaGFyYWN0ZXJMaXN0JywgeyBkZXRhaWw6IG51bGwgfSkpO1xcbiAgICAgIFwiO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoY2xlYXJTY3JpcHQpO1xyXG4gICAgICAgICAgICB0aGlzLmNoYXJhY3RlclNlbGVjdEFjdGl2ZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5vbkJyb3dzZXJNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgZXZlbnRLZXkgPSBlLmFyZ3VtZW50c1swXTtcclxuICAgICAgICB2YXIgZXZlbnREYXRhID0gZS5hcmd1bWVudHNbMV07XHJcbiAgICAgICAgc3dpdGNoIChldmVudEtleSkge1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5zZWxlY3RDaGFyYWN0ZXI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbmRTZWxlY3RDaGFyYWN0ZXIoZXZlbnREYXRhKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5jcmVhdGVDaGFyYWN0ZXI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbmRDcmVhdGVDaGFyYWN0ZXIoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5kZWxldGVDaGFyYWN0ZXI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbmREZWxldGVDaGFyYWN0ZXIoZXZlbnREYXRhKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5iYWNrVG9Mb2dpbjpcclxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQmFja1RvTG9naW4oKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5zZW5kU2VsZWN0Q2hhcmFjdGVyID0gZnVuY3Rpb24gKHZpc2libGVJZCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VsZWN0aW5nIGNoYXJhY3RlciB2aXNpYmxlSWQ9XCIuY29uY2F0KHZpc2libGVJZCkpO1xyXG4gICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbVBhY2tldCxcclxuICAgICAgICAgICAgY29udGVudEpzb25EdW1wOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICBjdXN0b21QYWNrZXRUeXBlOiAnc2VsZWN0Q2hhcmFjdGVyJyxcclxuICAgICAgICAgICAgICAgIHZpc2libGVJZDogdmlzaWJsZUlkLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5zZW5kQ3JlYXRlQ2hhcmFjdGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ3JlYXRpbmcgbmV3IGNoYXJhY3RlclwiKTtcclxuICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21QYWNrZXQsXHJcbiAgICAgICAgICAgIGNvbnRlbnRKc29uRHVtcDogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgY3VzdG9tUGFja2V0VHlwZTogJ2NyZWF0ZUNoYXJhY3RlcicsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLnNlbmREZWxldGVDaGFyYWN0ZXIgPSBmdW5jdGlvbiAodmlzaWJsZUlkKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJEZWxldGluZyBjaGFyYWN0ZXIgdmlzaWJsZUlkPVwiLmNvbmNhdCh2aXNpYmxlSWQpKTtcclxuICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21QYWNrZXQsXHJcbiAgICAgICAgICAgIGNvbnRlbnRKc29uRHVtcDogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgY3VzdG9tUGFja2V0VHlwZTogJ2RlbGV0ZUNoYXJhY3RlcicsXHJcbiAgICAgICAgICAgICAgICB2aXNpYmxlSWQ6IHZpc2libGVJZCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUuaGFuZGxlQmFja1RvTG9naW4gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJCYWNrIHRvIGxvZ2luIC0gcmV0dXJuaW5nIHRvIGZyZXNoIGF1dGggc2NyZWVuXCIpO1xyXG4gICAgICAgIC8vIFNldCBmbGFnIHRvIHByZXZlbnQgYXV0by1yZWNvbm5lY3QgaW4gYXV0aFNlcnZpY2VcclxuICAgICAgICB0aGlzLnJlc2V0QXV0aFN0YXRlID0gdHJ1ZTtcclxuICAgICAgICAvLyBDbGVhciBjaGFyYWN0ZXIgc2VsZWN0IGRhdGFcclxuICAgICAgICB2YXIgY2xlYXJTY3JpcHQgPSBcIlxcbiAgICAgIGlmICh3aW5kb3cuc2t5bXApIHtcXG4gICAgICAgIHdpbmRvdy5za3ltcC5jaGFyYWN0ZXJTZWxlY3QgPSBudWxsO1xcbiAgICAgICAgd2luZG93LnNreW1wLmNoYXJhY3RlclNlbGVjdEVycm9yID0gbnVsbDtcXG4gICAgICB9XFxuICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDpjaGFyYWN0ZXJMaXN0JywgeyBkZXRhaWw6IG51bGwgfSkpO1xcbiAgICBcIjtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoY2xlYXJTY3JpcHQpO1xyXG4gICAgICAgIHRoaXMuY2hhcmFjdGVyU2VsZWN0QWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgLy8gQ2xvc2UgY29ubmVjdGlvbiBhbmQgZW5zdXJlIGJyb3dzZXIgc3RheXMgdmlzaWJsZSBmb3IgYXV0aCBzY3JlZW5cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLmNsb3NlKCk7XHJcbiAgICAgICAgLy8gS2VlcCBicm93c2VyIHZpc2libGUgZm9yIGF1dGggVUlcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQ2hhcmFjdGVyU2VsZWN0U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlIH07XHJcbiIsIjtcclxudmFyIENsaWVudExpc3RlbmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gQ2xpZW50TGlzdGVuZXIoKSB7XHJcbiAgICAgICAgLy8gRG9uJ3QgbGV0IFR5cGVTY3JpcHQgdHJlYXQgdGhpcyBjbGFzcyBhcyBlbXB0eVxyXG4gICAgICAgIHRoaXMuX25vbkVtcHR5Q2xhc3NNYXJrID0gJyc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gQ2xpZW50TGlzdGVuZXI7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IENsaWVudExpc3RlbmVyIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHRoaXMgb3V0XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBDbWRBcmd1bWVudDtcclxuKGZ1bmN0aW9uIChDbWRBcmd1bWVudCkge1xyXG4gICAgQ21kQXJndW1lbnRbQ21kQXJndW1lbnRbXCJPYmplY3RSZWZlcmVuY2VcIl0gPSAwXSA9IFwiT2JqZWN0UmVmZXJlbmNlXCI7XHJcbiAgICBDbWRBcmd1bWVudFtDbWRBcmd1bWVudFtcIkJhc2VGb3JtXCJdID0gMV0gPSBcIkJhc2VGb3JtXCI7XHJcbiAgICBDbWRBcmd1bWVudFtDbWRBcmd1bWVudFtcIkludFwiXSA9IDJdID0gXCJJbnRcIjtcclxuICAgIENtZEFyZ3VtZW50W0NtZEFyZ3VtZW50W1wiU3RyaW5nXCJdID0gM10gPSBcIlN0cmluZ1wiO1xyXG59KShDbWRBcmd1bWVudCB8fCAoQ21kQXJndW1lbnQgPSB7fSkpO1xyXG52YXIgQ29uc29sZUNvbW1hbmRzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhDb25zb2xlQ29tbWFuZHNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQ29uc29sZUNvbW1hbmRzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5pbW11bmVTY2hlbWEgPSBbXCJtcFwiXTtcclxuICAgICAgICBfdGhpcy5ub25WYW5pbGFDb21tYW5kcyA9IFtcIm1wXCJdO1xyXG4gICAgICAgIF90aGlzLnNjaGVtYXMgPSBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlLmNyZWF0ZVNjaGVtYXMoKTtcclxuICAgICAgICBfdGhpcy5zZXR1cE1wQ29tbWFuZCgpO1xyXG4gICAgICAgIF90aGlzLnNldHVwVmFuaWxhQ29tbWFuZHMoKTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlLmNyZWF0ZVNjaGVtYXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHNjaGVtYXMgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgc2NoZW1hcy5zZXQoXCJhZGRpdGVtXCIsIFtDbWRBcmd1bWVudC5PYmplY3RSZWZlcmVuY2UsIENtZEFyZ3VtZW50LkJhc2VGb3JtLCBDbWRBcmd1bWVudC5JbnRdKTtcclxuICAgICAgICBzY2hlbWFzLnNldChcImVxdWlwaXRlbVwiLCBbQ21kQXJndW1lbnQuT2JqZWN0UmVmZXJlbmNlLCBDbWRBcmd1bWVudC5CYXNlRm9ybV0pO1xyXG4gICAgICAgIHNjaGVtYXMuc2V0KFwicGxhY2VhdG1lXCIsIFtDbWRBcmd1bWVudC5PYmplY3RSZWZlcmVuY2UsIENtZEFyZ3VtZW50LkJhc2VGb3JtXSk7XHJcbiAgICAgICAgc2NoZW1hcy5zZXQoXCJkaXNhYmxlXCIsIFtDbWRBcmd1bWVudC5PYmplY3RSZWZlcmVuY2VdKTtcclxuICAgICAgICBzY2hlbWFzLnNldChcIm1wXCIsIFtDbWRBcmd1bWVudC5PYmplY3RSZWZlcmVuY2UsIENtZEFyZ3VtZW50LlN0cmluZ10pO1xyXG4gICAgICAgIHJldHVybiBzY2hlbWFzO1xyXG4gICAgfTtcclxuICAgIENvbnNvbGVDb21tYW5kc1NlcnZpY2UucHJvdG90eXBlLnNldHVwTXBDb21tYW5kID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5zcC5maW5kQ29uc29sZUNvbW1hbmQoXCIgQ29uZmlndXJlVU1cIikgfHwgdGhpcy5zcC5maW5kQ29uc29sZUNvbW1hbmQoXCJ0ZXN0XCIpO1xyXG4gICAgICAgIGlmIChjb21tYW5kID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiY29tbWFuZCB3YXMgbnVsbCBpbiBzZXR1cE1wQ29tbWFuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb21tYW5kLnNob3J0TmFtZSA9IFwibXBcIjtcclxuICAgICAgICBjb21tYW5kLmV4ZWN1dGUgPSB0aGlzLmdldENvbW1hbmRFeGVjdXRvcihcIm1wXCIpO1xyXG4gICAgfTtcclxuICAgIENvbnNvbGVDb21tYW5kc1NlcnZpY2UucHJvdG90eXBlLnNldHVwVmFuaWxhQ29tbWFuZHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNldHRpbmcgdXAgdmFuaWxhIGNvbW1hbmRzXCIpO1xyXG4gICAgICAgIHRoaXMuc2NoZW1hcy5mb3JFYWNoKGZ1bmN0aW9uIChfLCBjb21tYW5kTmFtZSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTZXR0aW5nIHVwIGNvbW1hbmRcIiwgY29tbWFuZE5hbWUpO1xyXG4gICAgICAgICAgICB2YXIgY29tbWFuZCA9IF90aGlzLnNwLmZpbmRDb25zb2xlQ29tbWFuZChjb21tYW5kTmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChjb21tYW5kID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJjb21tYW5kXCIsIGNvbW1hbmROYW1lLCBcIndhcyBudWxsIGluIHNldHVwVmFuaWxhQ29tbWFuZHNcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKF90aGlzLm5vblZhbmlsYUNvbW1hbmRzLmluY2x1ZGVzKGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiY29tbWFuZFwiLCBjb21tYW5kTmFtZSwgXCIgaXMgbm9uLXZhbmlsYSBjb21tYW5kXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZSA9IF90aGlzLmdldENvbW1hbmRFeGVjdXRvcihjb21tYW5kTmFtZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJWYW5pbGEgY29tbWFuZHMgc2V0IHVwXCIpO1xyXG4gICAgfTtcclxuICAgIENvbnNvbGVDb21tYW5kc1NlcnZpY2UucHJvdG90eXBlLmdldENvbW1hbmRFeGVjdXRvciA9IGZ1bmN0aW9uIChjb21tYW5kTmFtZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBUT0RPOiBoYW5kbGUgcG9zc2libGUgZXhjZXB0aW9ucyBpbiB0aGlzIGZ1bmN0aW9uXHJcbiAgICAgICAgICAgIHZhciBzY2hlbWEgPSBfdGhpcy5zY2hlbWFzLmdldChjb21tYW5kTmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChzY2hlbWEgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiU2NoZW1hIG5vdCBmb3VuZCBmb3IgY29tbWFuZFwiLCBjb21tYW5kTmFtZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoICE9PSBzY2hlbWEubGVuZ3RoICYmICFfdGhpcy5pbW11bmVTY2hlbWEuaW5jbHVkZXMoY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJNaXNtYXRjaCBmb3VuZCBpbiB0aGUgc2NoZW1hIG9mXCIsIGNvbW1hbmROYW1lLCBcImNvbW1hbmRcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNjaGVtYVtpXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgQ21kQXJndW1lbnQuT2JqZWN0UmVmZXJlbmNlOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gbG9jYWxJZFRvUmVtb3RlSWQocGFyc2VJbnQoXCJcIi5jb25jYXQoYXJnc1tpXSkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbaV0gIT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIGFyZ3NbaV0gIT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJCYWQgYXJndW1lbnQgdHlwZSBpbiBjb21tYW5kXCIsIGNvbW1hbmROYW1lLCBcImFyZ3VtZW50IGluZGV4XCIsIGkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkNvbnNvbGVDb21tYW5kLFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZE5hbWU6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBhcmdzXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIE1lYW50IHRvIGJlIHNob3duIHRvIHVzZXIsIG5vdCBmb3IgbG9nZ2luZ1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5wcmludENvbnNvbGUoXCJzZW50XCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQ29uc29sZUNvbW1hbmRzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgX19hc3NpZ24gPSAodGhpcyAmJiB0aGlzLl9fYXNzaWduKSB8fCBmdW5jdGlvbiAoKSB7XHJcbiAgICBfX2Fzc2lnbiA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24odCkge1xyXG4gICAgICAgIGZvciAodmFyIHMsIGkgPSAxLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG47IGkrKykge1xyXG4gICAgICAgICAgICBzID0gYXJndW1lbnRzW2ldO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwIGluIHMpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocywgcCkpXHJcbiAgICAgICAgICAgICAgICB0W3BdID0gc1twXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHQ7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIF9fYXNzaWduLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbn07XHJcbmltcG9ydCB7IHByaW50Q29uc29sZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgZ2V0UGNJbnZlbnRvcnkgfSBmcm9tIFwiLi9yZW1vdGVTZXJ2ZXJcIjtcclxuaW1wb3J0IHsgZ2V0SW52ZW50b3J5LCBnZXREaWZmLCBoYXNFeHRyYXMsIHJlbW92ZVNpbXBsZUl0ZW1zQXNNYW55QXNQb3NzaWJsZSwgc3VtSW52ZW50b3JpZXMgfSBmcm9tIFwiLi4vLi4vc3luYy9pbnZlbnRvcnlcIjtcclxuaW1wb3J0IHsgTGFzdEludlNlcnZpY2UgfSBmcm9tIFwiLi9sYXN0SW52U2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UgfSBmcm9tIFwiLi9zd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbnZhciBDb250YWluZXJzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhDb250YWluZXJzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIENvbnRhaW5lcnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oJ2NvbnRhaW5lckNoYW5nZWQnLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Db250YWluZXJDaGFuZ2VkKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBDb250YWluZXJzU2VydmljZS5wcm90b3R5cGUub25Db250YWluZXJDaGFuZ2VkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBzd2VldENhbnREcm9wU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UpO1xyXG4gICAgICAgIGlmIChlLm9sZENvbnRhaW5lciAmJiBlLm5ld0NvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBpZiAoZS5vbGRDb250YWluZXIuZ2V0Rm9ybUlEKCkgPT09IDB4MTQgfHxcclxuICAgICAgICAgICAgICAgIGUubmV3Q29udGFpbmVyLmdldEZvcm1JRCgpID09PSAweDE0KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGFzdEludlNlcnZpY2VfMSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihMYXN0SW52U2VydmljZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWxhc3RJbnZTZXJ2aWNlXzEubGFzdEludikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiA9IGdldFBjSW52ZW50b3J5KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobGFzdEludlNlcnZpY2VfMS5sYXN0SW52KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0ludiA9IGdldEludmVudG9yeSh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEl0IHNlZW1zIHRoYXQgJ2lnbm9yZVdvcm4gPSBmYWxzZScgZml4ZXMgdGhpczpcclxuICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vc2t5cmltLW11bHRpcGxheWVyL2lzc3VlLXRyYWNrZXIvaXNzdWVzLzQzXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIHNvbWUgcmVhc29uIGV4Y2VzcyBkaWZmIGlzIHByb2R1Y2VkIHdoZW4gJ2lnbm9yZVdvcm4gPSB0cnVlJ1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEkgdGhvdWdodCB0aGF0IGl0IHdvdWxkIGJlIHZpY2UgdmVyc2EgYnV0IHRoYXQncyBob3cgaXQgd29ya3NcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaWdub3JlV29ybiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkaWZmID0gZ2V0RGlmZihsYXN0SW52U2VydmljZV8xLmxhc3RJbnYsIG5ld0ludiwgaWdub3JlV29ybik7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKCdkaWZmOicpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlmZi5lbnRyaWVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIltcIi5jb25jYXQoaSwgXCJdIFwiKS5jb25jYXQoSlNPTi5zdHJpbmdpZnkoZGlmZi5lbnRyaWVzW2ldKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB2YXIgbXNncyA9IGRpZmYuZW50cmllc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiByZXZpZXcgdGhpcyBjb25kaXRpb24sIHNlZW1zIHRvIGJlIGluY29ycmVjdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW50cnkuY291bnQgPiAwXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHN3ZWV0Q2FudERyb3BTZXJ2aWNlLmNhbkRyb3BPclB1dEl0ZW0oZW50cnkuYmFzZUlkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7IHJldHVybiBlbnRyeS5jb3VudCAhPT0gMDsgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChmdW5jdGlvbiAoZW50cnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW50cnlDb3B5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlbnRyeSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbXNnID0gX19hc3NpZ24oX19hc3NpZ24oe30sIGVudHJ5Q29weSksIHsgdDogZW50cnkuY291bnQgPiAwID8gTXNnVHlwZS5QdXRJdGVtIDogTXNnVHlwZS5UYWtlSXRlbSwgdGFyZ2V0OiBlLm9sZENvbnRhaW5lci5nZXRGb3JtSUQoKSA9PT0gMHgxNFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gbG9jYWxJZFRvUmVtb3RlSWQoZS5uZXdDb250YWluZXIuZ2V0Rm9ybUlEKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBsb2NhbElkVG9SZW1vdGVJZChlLm9sZENvbnRhaW5lci5nZXRGb3JtSUQoKSkgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1zZy5jb3VudCA9IE1hdGguYWJzKG1zZy5jb3VudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoKF9hID0gX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZW50cnkuYmFzZUlkKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldE5hbWUoKSkgPT09IG1zZy5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbXNnLm5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1zZztcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBtc2dzLmZvckVhY2goZnVuY3Rpb24gKG1zZykgeyByZXR1cm4gX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1zZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgICAgIH0pOyB9KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IGVtaXR0aW5nIDEsMiwzLDQsNSBjaGFuZ2VzIHdoZW4gdGFraW5nL3B1dHRpbmcgNSBwb3Rpb25zIG9uZSBieSBvbmVcclxuICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGNvZGUgbWFrZXMgaXQgMSwxLDEsMSwxIGJ1dCB3b3JrcyBvbmx5IGZvciBleHRyYS1sZXNzIGl0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQXQgdGhlIG1vbWVudCBvZiB3cml0aW5nIHRoaXMgSSB0aGluayBpdCdzIG5vdCBuZWVkZWQgZm9yIGl0ZW1zIHdpdGggZXh0cmFzXHJcbiAgICAgICAgICAgICAgICAgICAgZGlmZi5lbnRyaWVzLmZvckVhY2goZnVuY3Rpb24gKGVudHJ5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0SW52U2VydmljZV8xLmxhc3RJbnYgJiYgIWhhc0V4dHJhcyhlbnRyeSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwdXQgPSBlbnRyeS5jb3VudCA+IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFrZSA9IGVudHJ5LmNvdW50IDwgMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwdXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0SW52U2VydmljZV8xLmxhc3RJbnYgPSByZW1vdmVTaW1wbGVJdGVtc0FzTWFueUFzUG9zc2libGUobGFzdEludlNlcnZpY2VfMS5sYXN0SW52LCBlbnRyeS5iYXNlSWQsIGVudHJ5LmNvdW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRha2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWRkID0geyBlbnRyaWVzOiBbZW50cnldIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkLmVudHJpZXNbMF0uY291bnQgKj0gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEludlNlcnZpY2VfMS5sYXN0SW52ID0gc3VtSW52ZW50b3JpZXMobGFzdEludlNlcnZpY2VfMS5sYXN0SW52LCBhZGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIENvbnRhaW5lcnNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IENvbnRhaW5lcnNTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG4vLyBUT0RPOiByZWZhY3RvciB0aGlzIG91dFxyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBDcmFmdFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQ3JhZnRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQ3JhZnRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmZ1cm5pdHVyZVN0cmVhayA9IG5ldyBNYXAoKTtcclxuICAgICAgICBjb250cm9sbGVyLm9uKCdjb250YWluZXJDaGFuZ2VkJywgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ29udGFpbmVyQ2hhbmdlZChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQ3JhZnRTZXJ2aWNlLnByb3RvdHlwZS5vbkNvbnRhaW5lckNoYW5nZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBvbGRDb250YWluZXJJZCA9IGUub2xkQ29udGFpbmVyID8gZS5vbGRDb250YWluZXIuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIHZhciBuZXdDb250YWluZXJJZCA9IGUubmV3Q29udGFpbmVyID8gZS5uZXdDb250YWluZXIuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIHZhciBiYXNlT2JqSWQgPSBlLmJhc2VPYmogPyBlLmJhc2VPYmouZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIGlmIChvbGRDb250YWluZXJJZCAhPT0gMHgxNCAmJiBuZXdDb250YWluZXJJZCAhPT0gMHgxNCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBmdXJuaXR1cmVSZWYgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkuZ2V0RnVybml0dXJlUmVmZXJlbmNlKCk7XHJcbiAgICAgICAgaWYgKCFmdXJuaXR1cmVSZWYpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZnVybml0dXJlSWQgPSBmdXJuaXR1cmVSZWYuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgaWYgKG9sZENvbnRhaW5lcklkID09PSAweDE0ICYmIG5ld0NvbnRhaW5lcklkID09PSAwKSB7XHJcbiAgICAgICAgICAgIHZhciBjcmFmdElucHV0T2JqZWN0cyA9IHRoaXMuZnVybml0dXJlU3RyZWFrLmdldChmdXJuaXR1cmVJZCk7XHJcbiAgICAgICAgICAgIGlmICghY3JhZnRJbnB1dE9iamVjdHMpIHtcclxuICAgICAgICAgICAgICAgIGNyYWZ0SW5wdXRPYmplY3RzID0geyBlbnRyaWVzOiBbXSB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNyYWZ0SW5wdXRPYmplY3RzLmVudHJpZXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBiYXNlSWQ6IGJhc2VPYmpJZCxcclxuICAgICAgICAgICAgICAgIGNvdW50OiBlLm51bUl0ZW1zLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5mdXJuaXR1cmVTdHJlYWsuc2V0KGZ1cm5pdHVyZUlkLCBjcmFmdElucHV0T2JqZWN0cyk7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQWRkaW5nIGJhc2VPYmpJZFwiLCBiYXNlT2JqSWQudG9TdHJpbmcoMTYpLCBcIm51bUl0ZW1zXCIsIGUubnVtSXRlbXMsIFwidG8gY3JhZnRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKG9sZENvbnRhaW5lcklkID09PSAwICYmIG5ld0NvbnRhaW5lcklkID09PSAweDE0KSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdGaW5pc2hpbmcgY3JhZnQnKTtcclxuICAgICAgICAgICAgdmFyIGNyYWZ0SW5wdXRPYmplY3RzID0gdGhpcy5mdXJuaXR1cmVTdHJlYWsuZ2V0KGZ1cm5pdHVyZUlkKTtcclxuICAgICAgICAgICAgaWYgKGNyYWZ0SW5wdXRPYmplY3RzICYmIGNyYWZ0SW5wdXRPYmplY3RzLmVudHJpZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZ1cm5pdHVyZVN0cmVhay5kZWxldGUoZnVybml0dXJlSWQpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHdvcmtiZW5jaCA9IGxvY2FsSWRUb1JlbW90ZUlkKGZ1cm5pdHVyZUlkKTtcclxuICAgICAgICAgICAgICAgIGlmICghd29ya2JlbmNoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJsb2NhbElkVG9SZW1vdGVJZCByZXR1cm5lZCAwIGZvciBmdXJuaXR1cmVJZFwiLCBmdXJuaXR1cmVJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdE9iamVjdElkID0gYmFzZU9iaklkO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZW5kaW5nIGNyYWZ0IHdvcmtiZW5jaFwiLCB3b3JrYmVuY2gsIFwicmVzdWx0T2JqZWN0SWRcIiwgcmVzdWx0T2JqZWN0SWQsIFwiY3JhZnRJbnB1dE9iamVjdHNcIiwgSlNPTi5zdHJpbmdpZnkoY3JhZnRJbnB1dE9iamVjdHMuZW50cmllcykpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3JhZnRJdGVtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7IHdvcmtiZW5jaDogd29ya2JlbmNoLCBjcmFmdElucHV0T2JqZWN0czogY3JhZnRJbnB1dE9iamVjdHMsIHJlc3VsdE9iamVjdElkOiByZXN1bHRPYmplY3RJZCB9LFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIENyYWZ0U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBDcmFmdFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IEFjdG9yIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgUmVzcGF3bk5lZWRlZEVycm9yIH0gZnJvbSBcIi4uLy4uL2xpYi9lcnJvcnNcIjtcclxuaW1wb3J0IHsgQW5pbWF0aW9uRXZlbnROYW1lIH0gZnJvbSBcIi4uLy4uL3N5bmMvYW5pbWF0aW9uXCI7XHJcbmltcG9ydCB7IFJhZ2RvbGxTZXJ2aWNlIH0gZnJvbSBcIi4vcmFnZG9sbFNlcnZpY2VcIjtcclxudmFyIERlYXRoU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhEZWF0aFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBEZWF0aFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuYXBwbHlEZWF0aFN0YXRlID0gZnVuY3Rpb24gKGFjdG9yLCBpc0RlYWQpIHtcclxuICAgICAgICAgICAgaWYgKGFjdG9yLmlzRGVhZCgpID09PSBpc0RlYWQgJiYgX3RoaXMuaXNQbGF5ZXIoYWN0b3IpID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpc0RlYWQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLmtpbGxBY3RvcihhY3RvciwgbnVsbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5yZXN1cnJlY3RBY3RvcihhY3Rvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmtpbGxBY3RvciA9IGZ1bmN0aW9uIChhY3Rvciwga2lsbGVyKSB7XHJcbiAgICAgICAgICAgIGlmIChraWxsZXIgPT09IHZvaWQgMCkgeyBraWxsZXIgPSBudWxsOyB9XHJcbiAgICAgICAgICAgIGlmIChfdGhpcy5pc1BsYXllcihhY3RvcikgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnBsYXllckRlYWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuYnVzeUZvck90aGVyUmVhc29uc0NvdW50ZXIrKztcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLlV0aWxpdHkud2FpdCg3LjUpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuYnVzeUZvck90aGVyUmVhc29uc0NvdW50ZXItLTsgfSk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5hbGxvd2VkUGxheWVyQW5pbWF0aW9ucyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgYWN0b3Iuc2V0RG9udE1vdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5raWxsV2l0aFB1c2goYWN0b3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWN0b3IuZW5kRGVmZXJyZWRLaWxsKCk7XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5raWxsKGtpbGxlcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLnJlc3VycmVjdEFjdG9yID0gZnVuY3Rpb24gKGFjdG9yKSB7XHJcbiAgICAgICAgICAgIGlmIChfdGhpcy5pc1BsYXllcihhY3RvcikgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnBsYXllckRlYWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmJ1c3lGb3JPdGhlclJlYXNvbnNDb3VudGVyKys7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5VdGlsaXR5LndhaXQoNy41KS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmJ1c3lGb3JPdGhlclJlYXNvbnNDb3VudGVyLS07IH0pO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuYWxsb3dlZFBsYXllckFuaW1hdGlvbnMgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgYWN0b3Iuc2V0RG9udE1vdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMucmVzc3VyZWN0V2l0aFB1c2hLaWxsKGFjdG9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBSZXNwYXduTmVlZGVkRXJyb3IoXCJuZWVkcyB0byBiZSByZXNwYXduZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmtpbGxXaXRoUHVzaCA9IGZ1bmN0aW9uIChhY3Rvcikge1xyXG4gICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgIChfYSA9IF90aGlzLmFsbG93ZWRQbGF5ZXJBbmltYXRpb25zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucHVzaChBbmltYXRpb25FdmVudE5hbWUuUmFnZG9sbCk7XHJcbiAgICAgICAgICAgIGFjdG9yLnB1c2hBY3RvckF3YXkoYWN0b3IsIDApO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMucmVzc3VyZWN0V2l0aFB1c2hLaWxsID0gZnVuY3Rpb24gKGFjdCkge1xyXG4gICAgICAgICAgICB2YXIgZm9ybUlkID0gYWN0LmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICB2YXIgcmFnZG9sbFNlcnZpY2UgPSBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJhZ2RvbGxTZXJ2aWNlKTtcclxuICAgICAgICAgICAgcmFnZG9sbFNlcnZpY2Uuc2FmZVJlbW92ZVJhZ2RvbGxGcm9tV29ybGQoYWN0LCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGZvcm1JZCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IHNob3VsZCB1c2UgYWN0b3IgdmFyaWFibGUgaW5zdGVhZCBvZiBnZXRQbGF5ZXI/XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiB1c2UgZGlmZmVyZW50IGlHZXRVcFR5cGUgaWYgcmVzc3VyZWN0aW5nIHVuZGVyIHdhdGVyXHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpLnNldEFuaW1hdGlvblZhcmlhYmxlSW50KFwiaUdldFVwVHlwZVwiLCAxKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkRlYnVnLnNlbmRBbmltYXRpb25FdmVudChhY3RvciwgQW5pbWF0aW9uRXZlbnROYW1lLkdldFVwQmVnaW4pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmlzUGxheWVyID0gZnVuY3Rpb24gKGFjdG9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhY3Rvci5nZXRGb3JtSUQoKSA9PT0gX3RoaXMucGxheWVyQWN0b3JJZDtcclxuICAgICAgICB9O1xyXG4gICAgICAgIC8vIE51bGwgdG8gYWxsb3cgYWxsIGFuaW1hdGlvbnMuIEVtcHR5IGFycmF5IHRvIGRpc2FsbG93IGFsbFxyXG4gICAgICAgIF90aGlzLmFsbG93ZWRQbGF5ZXJBbmltYXRpb25zID0gbnVsbDtcclxuICAgICAgICBfdGhpcy5wbGF5ZXJBY3RvcklkID0gMHgxNDtcclxuICAgICAgICBfdGhpcy5wbGF5ZXJEZWFkID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuYnVzeUZvck90aGVyUmVhc29uc0NvdW50ZXIgPSAwO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIGNvbnRyb2xsZXIuZW1pdHRlci5vbihcImFwcGx5RGVhdGhTdGF0ZUV2ZW50XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkFwcGx5RGVhdGhTdGF0ZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuaG9va0Rpc2FibGVLaWxsTW92ZXMoKTtcclxuICAgICAgICBfdGhpcy5ob29rRGlzYWJsZVN0YWdnZXIoKTtcclxuICAgICAgICBfdGhpcy5ob29rRGlzYWJsZUJsb2NrZWRBbmltcygpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIERlYXRoU2VydmljZS5wcm90b3R5cGUuaXNCdXN5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnBsYXllckRlYWQgfHwgdGhpcy5idXN5Rm9yT3RoZXJSZWFzb25zQ291bnRlciA+IDA7XHJcbiAgICB9O1xyXG4gICAgRGVhdGhTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgcGxheWVyID09PSBudWxsIHx8IHBsYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGxheWVyLnN0YXJ0RGVmZXJyZWRLaWxsKCk7XHJcbiAgICB9O1xyXG4gICAgRGVhdGhTZXJ2aWNlLnByb3RvdHlwZS5vbkFwcGx5RGVhdGhTdGF0ZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5hcHBseURlYXRoU3RhdGUoZS5hY3RvciwgZS5pc0RlYWQpO1xyXG4gICAgfTtcclxuICAgIERlYXRoU2VydmljZS5wcm90b3R5cGUuaG9va0Rpc2FibGVLaWxsTW92ZXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uICgpIHsgfSxcclxuICAgICAgICB9LCAweGZmMDAwMDAwLCAweGZmZmZmZmZmLCBcIktpbGxNb3ZlKlwiKTtcclxuICAgIH07XHJcbiAgICBEZWF0aFNlcnZpY2UucHJvdG90eXBlLmhvb2tEaXNhYmxlU3RhZ2dlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKCkgeyB9LFxyXG4gICAgICAgIH0sIDB4ZmYwMDAwMDAsIDB4ZmZmZmZmZmYsIFwic3RhZ2dlclN0YXJ0XCIpO1xyXG4gICAgfTtcclxuICAgIERlYXRoU2VydmljZS5wcm90b3R5cGUuaG9va0Rpc2FibGVCbG9ja2VkQW5pbXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKF90aGlzLmFsbG93ZWRQbGF5ZXJBbmltYXRpb25zID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCFfdGhpcy5hbGxvd2VkUGxheWVyQW5pbWF0aW9ucy5pbmNsdWRlcyhjdHguYW5pbUV2ZW50TmFtZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICAgICAgfSwgdGhpcy5wbGF5ZXJBY3RvcklkLCB0aGlzLnBsYXllckFjdG9ySWQpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBEZWF0aFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRGVhdGhTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmRpZmZpY3VsdHkgPSA1O1xyXG4gICAgICAgIF90aGlzLmNvdW50ZXIgPSAwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLmNvdW50ZXIrKztcclxuICAgICAgICBpZiAodGhpcy5jb3VudGVyID49IDYwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY291bnRlciA9IDA7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS5zZXRJTklJbnQoXCJpRGlmZmljdWx0eTpHYW1lUGxheVwiLCB0aGlzLmRpZmZpY3VsdHkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKERpc2FibGVGYXN0VHJhdmVsU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIERpc2FibGVGYXN0VHJhdmVsU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIERpc2FibGVGYXN0VHJhdmVsU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLmVuYWJsZUZhc3RUcmF2ZWwoZmFsc2UpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gdHVybiBvZmYgcGxheWVyIGxldmVsIGV4cFxyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZlhQUGVyU2tpbGxSYW5rXCIsIDApO1xyXG4gICAgICAgIC8vIHR1cm4gb2ZmIHNraWxsIGV4cFxyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTggLyogQWN0b3JWYWx1ZS5BbHRlcmF0aW9uICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDE5IC8qIEFjdG9yVmFsdWUuQ29uanVyYXRpb24gKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMjAgLyogQWN0b3JWYWx1ZS5EZXN0cnVjdGlvbiAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgyMSAvKiBBY3RvclZhbHVlLklsbHVzaW9uICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDIyIC8qIEFjdG9yVmFsdWUuUmVzdG9yYXRpb24gKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMjMgLyogQWN0b3JWYWx1ZS5FbmNoYW50aW5nICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDYgLyogQWN0b3JWYWx1ZS5PbmVIYW5kZWQgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoNyAvKiBBY3RvclZhbHVlLlR3b0hhbmRlZCAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCg4IC8qIEFjdG9yVmFsdWUuQXJjaGVyeSAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCg5IC8qIEFjdG9yVmFsdWUuQmxvY2sgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTAgLyogQWN0b3JWYWx1ZS5TbWl0aGluZyAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxMSAvKiBBY3RvclZhbHVlLkhlYXZ5QXJtb3IgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTIgLyogQWN0b3JWYWx1ZS5MaWdodEFybW9yICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDEzIC8qIEFjdG9yVmFsdWUuUGlja3BvY2tldCAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxNCAvKiBBY3RvclZhbHVlLkxvY2twaWNraW5nICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDE1IC8qIEFjdG9yVmFsdWUuU25lYWsgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTYgLyogQWN0b3JWYWx1ZS5BbGNoZW15ICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDE3IC8qIEFjdG9yVmFsdWUuU3BlZWNoICovKTtcclxuICAgIH07XHJcbiAgICBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZS5wcm90b3R5cGUudHVybk9mZlNraWxsTG9jYWxFeHAgPSBmdW5jdGlvbiAoYXYpIHtcclxuICAgICAgICB2YXIgYXZpID0gdGhpcy5zcC5BY3RvclZhbHVlSW5mby5nZXRBY3RvclZhbHVlSW5mb0J5SUQoYXYpO1xyXG4gICAgICAgIGlmIChhdmkgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJOb3QgZm91bmQgQWN0b3JWYWx1ZUluZm8gZm9yIGFjdG9yIHZhbHVlXCIsIGF2KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhdmkuc2V0U2tpbGxVc2VNdWx0KDApO1xyXG4gICAgICAgIGF2aS5zZXRTa2lsbE9mZnNldE11bHQoMCk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgcmV0dXJuIERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlIH0gZnJvbSBcIi4vc3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFdvcmxkQ2xlYW5lclNlcnZpY2UgfSBmcm9tIFwiLi93b3JsZENsZWFuZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIERyb3BJdGVtU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhEcm9wSXRlbVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBEcm9wSXRlbVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgY29udHJvbGxlci5vbignY29udGFpbmVyQ2hhbmdlZCcsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNvbnRhaW5lckNoYW5nZWQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIERyb3BJdGVtU2VydmljZS5wcm90b3R5cGUub25Db250YWluZXJDaGFuZ2VkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgc3dlZXRDYW50RHJvcFNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlKTtcclxuICAgICAgICB2YXIgcGwgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgdmFyIGlzUGxheWVyID0gcGwgJiYgZS5vbGRDb250YWluZXIgJiYgcGwuZ2V0Rm9ybUlEKCkgPT09IGUub2xkQ29udGFpbmVyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIHZhciBub0NvbnRhaW5lciA9IGUubmV3Q29udGFpbmVyID09PSBudWxsIHx8IGUubmV3Q29udGFpbmVyID09PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdmFyIGlzUmVmZXJlbmNlID0gZS5yZWZlcmVuY2UgIT09IG51bGw7XHJcbiAgICAgICAgaWYgKGUubmV3Q29udGFpbmVyICYmIGUubmV3Q29udGFpbmVyLmdldEZvcm1JRCgpID09PSBwbC5nZXRGb3JtSUQoKSlcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIGlmICghdGhpcy5zcC5VaS5pc01lbnVPcGVuKFwiSW52ZW50b3J5TWVudVwiKSlcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIGlmIChpc1BsYXllciAmJlxyXG4gICAgICAgICAgICBpc1JlZmVyZW5jZSAmJlxyXG4gICAgICAgICAgICBub0NvbnRhaW5lciAmJlxyXG4gICAgICAgICAgICBzd2VldENhbnREcm9wU2VydmljZS5jYW5Ecm9wT3JQdXRJdGVtKGUuYmFzZU9iai5nZXRGb3JtSUQoKSkpIHtcclxuICAgICAgICAgICAgdmFyIHJhZGl1cyA9IDIwMDA7XHJcbiAgICAgICAgICAgIHZhciBiYXNlSWQgPSBlLmJhc2VPYmouZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgIHZhciBzZXQgPSBuZXcgU2V0KCk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMjAwOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciByZWZySWQgPSAoX2EgPSB0aGlzLnNwLkdhbWUuZmluZFJhbmRvbVJlZmVyZW5jZU9mVHlwZSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGJhc2VJZCksIHBsYXllci5nZXRQb3NpdGlvblgoKSwgcGxheWVyLmdldFBvc2l0aW9uWSgpLCBwbGF5ZXIuZ2V0UG9zaXRpb25aKCksIHJhZGl1cykpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZWZySWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXQuYWRkKHJlZnJJZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgbnVtRm91bmRfMSA9IDA7XHJcbiAgICAgICAgICAgIHZhciB3b3JsZENsZWFuZXJTZXJ2aWNlXzEgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoV29ybGRDbGVhbmVyU2VydmljZSk7XHJcbiAgICAgICAgICAgIHNldC5mb3JFYWNoKGZ1bmN0aW9uIChyZWZySWQpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZWYgPSBfdGhpcy5zcC5PYmplY3RSZWZlcmVuY2UuZnJvbShfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZWYgIT09IG51bGwgJiYgcmVmLmlzRGVsZXRlZCgpID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciByZWZySWRfMSA9IHJlZi5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAod29ybGRDbGVhbmVyU2VydmljZV8xLmdldFdjUHJvdGVjdGlvbihyZWZySWRfMSkgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmLmRlbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICArK251bUZvdW5kXzE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkZvdW5kIGFuZCBkZWxldGVkIHJlZmVyZW5jZSBcIiArIHJlZnJJZF8xLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJGb3VuZCByZWZlcmVuY2UgXCIgKyByZWZySWRfMS50b1N0cmluZygxNikgKyBcIiBidXQgaXQncyBwcm90ZWN0ZWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKCFudW1Gb3VuZF8xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbG9nVHJhY2UodGhpcywgXCJJZ25vcmluZyBpdGVtIGRyb3AgYXMgZmFsc2UgcG9zaXRpdmVcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHQgPSBNc2dUeXBlLkRyb3BJdGVtO1xyXG4gICAgICAgICAgICB2YXIgY291bnQgPSBlLm51bUl0ZW1zO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgICAgIHQ6IHQsXHJcbiAgICAgICAgICAgICAgICAgICAgYmFzZUlkOiBiYXNlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgY291bnQ6IGNvdW50LFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBEcm9wSXRlbVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRHJvcEl0ZW1TZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIGNvbnRyb2xsZXIuZW1pdHRlci5vbihcImdhbWVMb2FkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkdhbWVMb2FkKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRJbkNoYXJnZW4odHJ1ZSwgdHJ1ZSwgZmFsc2UpO1xyXG4gICAgfTtcclxuICAgIEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UucHJvdG90eXBlLm9uR2FtZUxvYWQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0SW5DaGFyZ2VuKHRydWUsIHRydWUsIGZhbHNlKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IGF1dGhHYW1lRGF0YVN0b3JhZ2VLZXkgfSBmcm9tIFwiLi4vLi4vZmVhdHVyZXMvYXV0aE1vZGVsXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIEZyb250SG90UmVsb2FkU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhGcm9udEhvdFJlbG9hZFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBGcm9udEhvdFJlbG9hZFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgdmFyIGVuYWJsZSA9ICEhX3RoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiZW5hYmxlLWZyb250LWhvdHJlbG9hZFwiXTtcclxuICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJlbmFibGUtZnJvbnQtaG90cmVsb2FkIGlzXCIsIGVuYWJsZSk7XHJcbiAgICAgICAgaWYgKCFlbmFibGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBUT0RPOiByZWZhY3RvciBvdXQgdmVyeSBzaW1pbGFyIGNvZGUgaW4gc2t5bXBDbGllbnQudHNcclxuICAgICAgICB2YXIgYXV0aEdhbWVEYXRhID0gX3RoaXMuc3Auc3RvcmFnZVthdXRoR2FtZURhdGFTdG9yYWdlS2V5XTtcclxuICAgICAgICB2YXIgc3RvcmFnZUhhc1ZhbGlkQXV0aEdhbWVEYXRhID0gKGF1dGhHYW1lRGF0YSA9PT0gbnVsbCB8fCBhdXRoR2FtZURhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhHYW1lRGF0YS5sb2NhbCkgfHwgKGF1dGhHYW1lRGF0YSA9PT0gbnVsbCB8fCBhdXRoR2FtZURhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhHYW1lRGF0YS5yZW1vdGUpO1xyXG4gICAgICAgIGlmIChzdG9yYWdlSGFzVmFsaWRBdXRoR2FtZURhdGEpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUmVjb3ZlcmVkIEF1dGhHYW1lRGF0YSBmcm9tIHN0b3JhZ2UsIHN0YXJ0aW5nIEZyb250SG90UmVsb2FkU2VydmljZVwiKTtcclxuICAgICAgICAgICAgX3RoaXMuY29ubmVjdFRvRnJvbnRIb3RSZWxvYWQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlVuYWJsZSB0byByZWNvdmVyIEF1dGhHYW1lRGF0YSBmcm9tIHN0b3JhZ2UsIHdhaXRpbmcgZm9yIGF1dGhcIik7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImF1dGhBdHRlbXB0XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkF1dGhBdHRlbXB0KGUpOyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlLnByb3RvdHlwZS5vbkF1dGhBdHRlbXB0ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLmNvbm5lY3RUb0Zyb250SG90UmVsb2FkKCk7XHJcbiAgICB9O1xyXG4gICAgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlLnByb3RvdHlwZS5jb25uZWN0VG9Gcm9udEhvdFJlbG9hZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHVybCA9IFwibG9jYWxob3N0OjEyMzRcIjtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiTG9hZGluZyB1cmxcIiwgdXJsKTtcclxuICAgICAgICAgICAgX3RoaXMuc3AuYnJvd3Nlci5sb2FkVXJsKHVybCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEZyb250SG90UmVsb2FkU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBGcm9udEhvdFJlbG9hZFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkLCByZW1vdGVJZFRvTG9jYWxJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbi8vIFRoZSByZWFzb24gd2UgdXNlIGdsb2JhbCBza3lyaW1QbGF0Zm9ybSBpcyB0aGF0IHRoaXMuc3AgbWF5IGJlIGxpbWl0ZWQsIGFuZCBnYW1lbW9kZSBhcGkgbmVlZHMgdW5saW1pdGVkIGFjY2VzcyB0byBza3lyaW1QbGF0Zm9ybVxyXG4vLyBTbGlndGhseSBkaWZmZXJlbnQgdHlwZXNcclxuaW1wb3J0ICogYXMgc2t5cmltUGxhdGZvcm0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuL3NlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZVwiO1xyXG52YXIgR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5zZXR1cEV2ZW50U291cmNlID0gZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3R4Ll9mbihjdHgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIidldmVudFNvdXJjZXNcIiwgY3R4Ll9ldmVudE5hbWUsIFwiLSBBZGRlZFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiJ2V2ZW50U291cmNlc1wiLCBjdHguX2V2ZW50TmFtZSwgXCItXCIsIGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KF90aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXSkpIHtcclxuICAgICAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddID0gX3RoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddLmZpbHRlcihmdW5jdGlvbiAoY3R4KSB7IHJldHVybiAhY3R4Ll9leHBpcmVkOyB9KTtcclxuICAgICAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddLmZvckVhY2goZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc2V0dXBFdmVudFNvdXJjZShjdHgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZS5wcm90b3R5cGUub25VcGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAodGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJkaXNhYmxlLWdhbWVtb2RlLXVwZGF0ZXNcIl0pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3Auc3RvcmFnZVsnR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2Vfc2F3RXZlbnRTb3VyY2VzJ10gPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiR2FtZW1vZGUgdXBkYXRlcyBhcmUgZGlzYWJsZWQgYnkgc2V0dGluZ3NcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJHYW1lbW9kZSB1cGRhdGVzIGFyZSBkaXNhYmxlZCBieSBzZXR0aW5ncyAtIHByb2Nlc3NpbmcgZmlyc3QgdXBkYXRlIG9ubHlcIik7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVsnR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2Vfc2F3RXZlbnRTb3VyY2VzJ10gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXS5mb3JFYWNoKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIGN0eC5zZW5kRXZlbnQgPSBmdW5jdGlvbiAoKSB7IH07XHJcbiAgICAgICAgICAgICAgICBjdHguX2V4cGlyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGV2ZW50U291cmNlc1JlY29yZCA9IHt9O1xyXG4gICAgICAgIGV2ZW50Lm1lc3NhZ2UuZXZlbnRTb3VyY2VzLmZvckVhY2goZnVuY3Rpb24gKHBhaXIpIHsgcmV0dXJuIGV2ZW50U291cmNlc1JlY29yZFtwYWlyLm5hbWVdID0gcGFpci5jb250ZW50OyB9KTtcclxuICAgICAgICB2YXIgZXZlbnROYW1lcyA9IE9iamVjdC5rZXlzKGV2ZW50U291cmNlc1JlY29yZCk7XHJcbiAgICAgICAgdmFyIGJsb2NrZWRFdmVudFNvdXJjZXMgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImJsb2NrZWRFdmVudFNvdXJjZXNcIl07XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYmxvY2tlZEV2ZW50U291cmNlcykpIHtcclxuICAgICAgICAgICAgYmxvY2tlZEV2ZW50U291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChibG9ja2VkRXZlbnRTb3VyY2UpIHtcclxuICAgICAgICAgICAgICAgIGV2ZW50TmFtZXMgPSBldmVudE5hbWVzLmZpbHRlcihmdW5jdGlvbiAoZXZlbnROYW1lKSB7IHJldHVybiBldmVudE5hbWUgIT09IGJsb2NrZWRFdmVudFNvdXJjZTsgfSk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCInZXZlbnRTb3VyY2VzXCIsIGJsb2NrZWRFdmVudFNvdXJjZSwgXCItIEJsb2NrZWQgYnkgdGhlIGNsaWVudFwiKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICBldmVudE5hbWVzLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50TmFtZSkge1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLnZlcmlmeVNlcnZlckpzKGV2ZW50U291cmNlc1JlY29yZFtldmVudE5hbWVdKTtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdC5zcmMgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIidldmVudFNvdXJjZXNcIiwgZXZlbnROYW1lLCAnVmVyaWZpY2F0aW9uIGZhaWxlZDonLCByZXN1bHQuZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZm4gPSBuZXcgRnVuY3Rpb24oJ2N0eCcsIHJlc3VsdC5zcmMpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGN0eCA9IHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICBfbW9kZWw6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICBfdmlldzogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgICAgIGk6IC0xLFxyXG4gICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKF9wcm9wTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJjdHguZ2V0IGNhbid0IGJlIHVzZWQgaW4gZXZlbnQgc291cmNlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcGF3bjogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJjdHgucmVzcGF3biBjYW4ndCBiZSB1c2VkIGluIGV2ZW50IHNvdXJjZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHNwOiBza3lyaW1QbGF0Zm9ybSxcclxuICAgICAgICAgICAgICAgICAgICBzZW5kRXZlbnQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tRXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzSnNvbkR1bXBzOiBhcmdzLm1hcChmdW5jdGlvbiAoYXJnKSB7IHJldHVybiBKU09OLnN0cmluZ2lmeShhcmcpOyB9KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZTogZXZlbnROYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBnZXRGb3JtSWRJblNlcnZlckZvcm1hdDogZnVuY3Rpb24gKGNsaWVudHNpZGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsSWRUb1JlbW90ZUlkKGNsaWVudHNpZGVGb3JtSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0Rm9ybUlkSW5DbGllbnRGb3JtYXQ6IGZ1bmN0aW9uIChzZXJ2ZXJzaWRlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZW1vdGVJZFRvTG9jYWxJZChzZXJ2ZXJzaWRlRm9ybUlkKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIF9mbjogZm4sXHJcbiAgICAgICAgICAgICAgICAgICAgX2V2ZW50TmFtZTogZXZlbnROYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlOiB7fSxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10ucHVzaChjdHgpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc2V0dXBFdmVudFNvdXJjZShjdHgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCInZXZlbnRTb3VyY2VzXCIsIGV2ZW50TmFtZSwgXCItXCIsIGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4vcmVtb3RlU2VydmVyXCI7XHJcbi8vIFRPRE86IHJlZmFjdG9yXHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkLCByZW1vdGVJZFRvTG9jYWxJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuLy8gVGhlIHJlYXNvbiB3ZSB1c2UgZ2xvYmFsIHNreXJpbVBsYXRmb3JtIGlzIHRoYXQgdGhpcy5zcCBtYXkgYmUgbGltaXRlZCwgYW5kIGdhbWVtb2RlIGFwaSBuZWVkcyB1bmxpbWl0ZWQgYWNjZXNzIHRvIHNreXJpbVBsYXRmb3JtXHJcbi8vIFNsaWd0aGx5IGRpZmZlcmVudCB0eXBlc1xyXG5pbXBvcnQgKiBhcyBza3lyaW1QbGF0Zm9ybSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlXCI7XHJcbnZhciBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gR2FtZW1vZGVVcGRhdGVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNyZWF0ZUFjdG9yTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInRpY2tcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25UaWNrKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMudXBkYXRlT3duZXJDdHggPSB7XHJcbiAgICAgICAgICAgIHNwOiBza3lyaW1QbGF0Zm9ybSxcclxuICAgICAgICAgICAgcmVmcjogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBfbW9kZWw6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgZ2V0Rm9ybUlkSW5TZXJ2ZXJGb3JtYXQ6IGZ1bmN0aW9uIChjbGllbnRzaWRlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxJZFRvUmVtb3RlSWQoY2xpZW50c2lkZUZvcm1JZCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGdldEZvcm1JZEluQ2xpZW50Rm9ybWF0OiBmdW5jdGlvbiAoc2VydmVyc2lkZUZvcm1JZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbW90ZUlkVG9Mb2NhbElkKHNlcnZlcnNpZGVGb3JtSWQpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChwcm9wTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vZGVsW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc3RhdGU6IHt9LFxyXG4gICAgICAgICAgICBfdmlldzogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBpOiAtMSxcclxuICAgICAgICAgICAgcmVzcGF3bjogZnVuY3Rpb24gKCkgeyB0aHJvdyBuZXcgRXJyb3IoXCJjdHgucmVzcGF3biBpcyBub3QgYXZhaWxhYmxlIGZvciB1cGRhdGVPd25lclwiKTsgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMudXBkYXRlTmVpZ2hib3JDdHggPSB7XHJcbiAgICAgICAgICAgIHJlZnI6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgX21vZGVsOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIHNwOiBza3lyaW1QbGF0Zm9ybSxcclxuICAgICAgICAgICAgc3RhdGU6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgaTogLTEsXHJcbiAgICAgICAgICAgIGdldEZvcm1JZEluU2VydmVyRm9ybWF0OiBmdW5jdGlvbiAoY2xpZW50c2lkZUZvcm1JZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsSWRUb1JlbW90ZUlkKGNsaWVudHNpZGVGb3JtSWQpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBnZXRGb3JtSWRJbkNsaWVudEZvcm1hdDogZnVuY3Rpb24gKHNlcnZlcnNpZGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZW1vdGVJZFRvTG9jYWxJZChzZXJ2ZXJzaWRlRm9ybUlkKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAocHJvcE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb2RlbFtwcm9wTmFtZV07XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlc3Bhd246IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3ZpZXcuZGVzdHJveUZvcm0odGhpcy5pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNLZXlzID0gW107XHJcbiAgICAgICAgX3RoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnMgPSB7fTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLnNldEZvcm1WaWV3QXJyYXkgPSBmdW5jdGlvbiAoZm9ybVZpZXdBcnJheSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JDdHguX3ZpZXcgPSBmb3JtVmlld0FycmF5O1xyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUuc2V0SSA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckN0eC5pID0gaTtcclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLnVwZGF0ZU5laWdoYm9yID0gZnVuY3Rpb24gKHJlZnIsIG1vZGVsLCBzdGF0ZSkge1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSB0aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zS2V5czsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIGtleSA9IF9hW19pXTtcclxuICAgICAgICAgICAgdmFyIHYgPSBtb2RlbFtrZXldO1xyXG4gICAgICAgICAgICAvLyBBY2NvcmRpbmcgdG8gZG9jczpcclxuICAgICAgICAgICAgLy8gSW4gYHVwZGF0ZU93bmVyYC9gdXBkYXRlTmVpZ2hib3JgIGVxdWFscyB0byBhIHZhbHVlIG9mIGEgY3VycmVudGx5IHByb2Nlc3NlZCBwcm9wZXJ0eS5cclxuICAgICAgICAgICAgLy8gQ2FuJ3QgYmUgYHVuZGVmaW5lZGAgaGVyZSwgc2luY2UgdXBkYXRlcyBhcmUgbm90IHJlY2VpdmVkIGZvciBgdW5kZWZpbmVkYCBwcm9wZXJ0eSB2YWx1ZXMuXHJcbiAgICAgICAgICAgIC8vIEluIG90aGVyIGNvbnRleHRzIGlzIGFsd2F5cyBgdW5kZWZpbmVkYC5cclxuICAgICAgICAgICAgaWYgKHYgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckN0eC5yZWZyID0gcmVmcjtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JDdHgudmFsdWUgPSB2O1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckN0eC5fbW9kZWwgPSBtb2RlbDtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JDdHguc3RhdGUgPSBzdGF0ZTtcclxuICAgICAgICAgICAgICAgIHZhciBmID0gdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9uc1trZXldO1xyXG4gICAgICAgICAgICAgICAgLy8gQWN0dWFsbHksICdmJyBzaG91bGQgYWx3YXlzIGJlIGEgdmFsaWQgZnVuY3Rpb24sIGJ1dCB3aG8ga25vd3NcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwidXBkYXRlTmVpZ2hib3JcIiwga2V5LCAnLScsIGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUub25VcGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiZGlzYWJsZS1nYW1lbW9kZS11cGRhdGVzXCJdKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLnN0b3JhZ2VbJ0dhbWVtb2RlVXBkYXRlU2VydmljZV9zYXdVcGRhdGVGdW5jdGlvbnMnXSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJHYW1lbW9kZSB1cGRhdGVzIGFyZSBkaXNhYmxlZCBieSBzZXR0aW5nc1wiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkdhbWVtb2RlIHVwZGF0ZXMgYXJlIGRpc2FibGVkIGJ5IHNldHRpbmdzIC0gcHJvY2Vzc2luZyBmaXJzdCB1cGRhdGUgb25seVwiKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlWydHYW1lbW9kZVVwZGF0ZVNlcnZpY2Vfc2F3VXBkYXRlRnVuY3Rpb25zJ10gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbJ3VwZGF0ZU5laWdoYm9yRnVuY3Rpb25zJ10gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5zcC5zdG9yYWdlWyd1cGRhdGVPd25lckZ1bmN0aW9ucyddID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHRoaXMudXBkYXRlR2FtZW1vZGVVcGRhdGVGdW5jdGlvbnMoJ3VwZGF0ZU5laWdoYm9yRnVuY3Rpb25zJywgZXZlbnQubWVzc2FnZS51cGRhdGVOZWlnaGJvckZ1bmN0aW9ucyk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVHYW1lbW9kZVVwZGF0ZUZ1bmN0aW9ucygndXBkYXRlT3duZXJGdW5jdGlvbnMnLCBldmVudC5tZXNzYWdlLnVwZGF0ZU93bmVyRnVuY3Rpb25zKTtcclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLm9uQ3JlYXRlQWN0b3JNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoIWV2ZW50Lm1lc3NhZ2UuaXNNZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIE90aGVyd2lzZSB3b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggbWF5IGJlIHVuYXNzaWduZWRcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVtb3RlU2VydmVyID0gX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSZW1vdGVTZXJ2ZXIpO1xyXG4gICAgICAgICAgICB2YXIgd29ybGRNb2RlbCA9IHJlbW90ZVNlcnZlci5nZXRXb3JsZE1vZGVsKCk7XHJcbiAgICAgICAgICAgIHZhciBteUZvcm1Nb2RlbCA9IHdvcmxkTW9kZWwuZm9ybXNbd29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4XTtcclxuICAgICAgICAgICAgaWYgKCFteUZvcm1Nb2RlbCkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiVW5hYmxlIHRvIGZpbmQgZm9ybU1vZGVsIHdpdGggaW5kZXhcIiwgd29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4KTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBfdGhpcy5zZXRPd25lck1vZGVsKG15Rm9ybU1vZGVsKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLm9uVGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIga2V5cyA9IHRoaXMuc3Auc3RvcmFnZVtcInVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zX2tleXNcIl07XHJcbiAgICAgICAgaWYgKGtleXMgJiYgQXJyYXkuaXNBcnJheShrZXlzKSkge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zS2V5cyA9IGtleXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zS2V5cyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBUT0RPOiBTaG91bGRuJ3Qgd2UgY2hlY2sgc3RvcmFnZSB2YWx1ZSBiZWZvcmUgYXNzaWdubWVudD9cclxuICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zID0gdGhpcy5zcC5zdG9yYWdlW1widXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNcIl07XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgcGxheWVyUmVmID0gdGhpcy5zcC5PYmplY3RSZWZlcmVuY2UuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgIHZhciBrZXlzID0gdGhpcy5zcC5zdG9yYWdlW1widXBkYXRlT3duZXJGdW5jdGlvbnNfa2V5c1wiXTtcclxuICAgICAgICBpZiAoIWtleXMgfHwgIUFycmF5LmlzQXJyYXkoa2V5cykpIHtcclxuICAgICAgICAgICAga2V5cyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZnVuY3MgPSB0aGlzLnNwLnN0b3JhZ2VbXCJ1cGRhdGVPd25lckZ1bmN0aW9uc1wiXTtcclxuICAgICAgICBpZiAodGhpcy5zcC5zdG9yYWdlW1wib3duZXJNb2RlbFNldFwiXSAhPT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBvd25lck1vZGVsID0gdGhpcy5zcC5zdG9yYWdlW1wib3duZXJNb2RlbFwiXTtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIGtleXNfMSA9IGtleXM7IF9pIDwga2V5c18xLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSBrZXlzXzFbX2ldO1xyXG4gICAgICAgICAgICB2YXIgZiA9IGZ1bmNzW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgLy8gQWN0dWFsbHksIG11c3QgYWx3YXlzIGJlIGEgdmFsaWQgZnVuY2l0b24sIGJ1dCB3aG8ga25vd3NcclxuICAgICAgICAgICAgaWYgKCFmKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU93bmVyQ3R4Ll9tb2RlbCA9IG93bmVyTW9kZWw7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy51cGRhdGVPd25lckN0eC5fbW9kZWwpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlT3duZXJDdHgudmFsdWUgPSB0aGlzLnVwZGF0ZU93bmVyQ3R4Ll9tb2RlbFtwcm9wTmFtZV07XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZU93bmVyQ3R4LnZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlT3duZXJDdHgucmVmciA9IHBsYXllclJlZjtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVPd25lckN0eC5fbW9kZWwgPSBvd25lck1vZGVsO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGYpIHtcclxuICAgICAgICAgICAgICAgICAgICBmKHRoaXMudXBkYXRlT3duZXJDdHgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcInVwZGF0ZU93bmVyXCIsIHByb3BOYW1lLCAnLScsIGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUuc2V0T3duZXJNb2RlbCA9IGZ1bmN0aW9uIChvd25lck1vZGVsKSB7XHJcbiAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wib3duZXJNb2RlbFwiXSA9IG93bmVyTW9kZWw7XHJcbiAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wib3duZXJNb2RlbFNldFwiXSA9IHRydWU7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS51cGRhdGVHYW1lbW9kZVVwZGF0ZUZ1bmN0aW9ucyA9IGZ1bmN0aW9uIChzdG9yYWdlVmFyLCBmdW5jdGlvblNvdXJjZXMpIHtcclxuICAgICAgICB2YXIgc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSk7XHJcbiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlc1JlY29yZCA9IHt9O1xyXG4gICAgICAgIGZ1bmN0aW9uU291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChwYWlyKSB7IHJldHVybiBmdW5jdGlvblNvdXJjZXNSZWNvcmRbcGFpci5uYW1lXSA9IHBhaXIuY29udGVudDsgfSk7XHJcbiAgICAgICAgdGhpcy5zcC5zdG9yYWdlW3N0b3JhZ2VWYXJdID0gZnVuY3Rpb25Tb3VyY2VzUmVjb3JkO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSBPYmplY3Qua2V5cyhmdW5jdGlvblNvdXJjZXNSZWNvcmQpOyBfaSA8IF9hLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSBfYVtfaV07XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBzZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UudmVyaWZ5U2VydmVySnModGhpcy5zcC5zdG9yYWdlW3N0b3JhZ2VWYXJdW3Byb3BOYW1lXSk7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQuc3JjID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBzdG9yYWdlVmFyLCBwcm9wTmFtZSwgJ1ZlcmlmaWNhdGlvbiBmYWlsZWQ6JywgcmVzdWx0LmVycm9yKTtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnNwLnN0b3JhZ2Vbc3RvcmFnZVZhcl1bcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVtzdG9yYWdlVmFyXVtwcm9wTmFtZV0gPSBuZXcgRnVuY3Rpb24oJ2N0eCcsIHJlc3VsdC5zcmMpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGVtcHR5RnVuY3Rpb24gPSBmdW5jdGlvblNvdXJjZXNSZWNvcmRbcHJvcE5hbWVdID09PSAnJztcclxuICAgICAgICAgICAgICAgIGlmIChlbXB0eUZ1bmN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc3Auc3RvcmFnZVtzdG9yYWdlVmFyXVtwcm9wTmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgc3RvcmFnZVZhciwgcHJvcE5hbWUsICdBZGRlZCBlbXB0eScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgc3RvcmFnZVZhciwgcHJvcE5hbWUsICdBZGRlZCcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBzdG9yYWdlVmFyLCBwcm9wTmFtZSwgZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wiXCIuY29uY2F0KHN0b3JhZ2VWYXIsIFwiX2tleXNcIildID0gT2JqZWN0LmtleXModGhpcy5zcC5zdG9yYWdlW3N0b3JhZ2VWYXJdKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gR2FtZW1vZGVVcGRhdGVTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEdhbWVtb2RlVXBkYXRlU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG4vLyBUT0RPOiByZWZhY3RvciB0aGlzIG91dFxyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgc3RvcmFnZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxudmFyIEhpdFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoSGl0U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEhpdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMucmVjZW50TWFnaWNIaXRzID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oJ2hpdCcsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkhpdChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgSGl0U2VydmljZS5wcm90b3R5cGUub25IaXQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIC8vIFRPRE86IGFkZCBtb3JlIGxvZ2dpbmcgaW4gY2FzZSBvZiAncmV0dXJuJ1xyXG4gICAgICAgIC8vIFRPRE86IGFsbG93IG5vbi13ZWFwb24gc291cmNlc1xyXG4gICAgICAgIHZhciBhZ2dyZXNzb3IgPSBlLmFnZ3Jlc3Nvci5nZXRGb3JtSUQoKTtcclxuICAgICAgICBpZiAoYWdncmVzc29yIDwgMHhmZjAwMDAwMCAmJiBhZ2dyZXNzb3IgIT09IDB4MTQpXHJcbiAgICAgICAgICAgIHJldHVybjsgLy8gYWxsIHNreW1wIG5wY3MgYXJlIEZGK1xyXG4gICAgICAgIGlmIChhZ2dyZXNzb3IgPj0gMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiBtYWtlIGhvc3Qgc2VydmljZVxyXG4gICAgICAgICAgICB2YXIgaG9zdGVkID0gc3RvcmFnZVsnaG9zdGVkJ107XHJcbiAgICAgICAgICAgIHZhciBhbHJlYWR5SG9zdGVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvc3RlZCkpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZW1vdGVJZCA9IGxvY2FsSWRUb1JlbW90ZUlkKGFnZ3Jlc3Nvcik7XHJcbiAgICAgICAgICAgICAgICBpZiAoaG9zdGVkLmluY2x1ZGVzKHJlbW90ZUlkKSB8fCBob3N0ZWQuaW5jbHVkZXMocmVtb3RlSWQgKyAweDEwMDAwMDAwMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbHJlYWR5SG9zdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWFscmVhZHlIb3N0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYmFzZSA9IGUudGFyZ2V0LmdldEJhc2VPYmplY3QoKTtcclxuICAgICAgICB2YXIgdHlwZSA9IGJhc2UgPT09IG51bGwgfHwgYmFzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYmFzZS5nZXRUeXBlKCk7XHJcbiAgICAgICAgaWYgKHR5cGUgPT09IDM0IC8qIEZvcm1UeXBlLlN0YXRpYyAqLyB8fCB0eXBlID09PSAzNiAvKiBGb3JtVHlwZS5Nb3ZhYmxlU3RhdGljICovKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGlzV2VhcG9uID0gdGhpcy5zcC5XZWFwb24uZnJvbShlLnNvdXJjZSk7XHJcbiAgICAgICAgdmFyIGlzU3BlbGwgPSAhaXNXZWFwb24gJiYgdGhpcy5zcC5TcGVsbC5mcm9tKGUuc291cmNlKTtcclxuICAgICAgICB2YXIgaXNTY3JvbGwgPSAhaXNXZWFwb24gJiYgIWlzU3BlbGwgJiYgdGhpcy5zcC5TY3JvbGwuZnJvbShlLnNvdXJjZSk7XHJcbiAgICAgICAgaWYgKCFpc1dlYXBvbiAmJiAhaXNTcGVsbCAmJiAhaXNTY3JvbGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBwcmV2ZW50IGRvdWJsZSBoaXQgdGhhdCBoYXBwZW5zIGZvciBzb21lIHJlYXNvbiB3aXRoIG1hZ2ljIHByb2plY3RpbGVzXHJcbiAgICAgICAgaWYgKGlzU3BlbGwgfHwgaXNTY3JvbGwpIHtcclxuICAgICAgICAgICAgdmFyIGFnZ3Jlc3NvcklkID0gZS5hZ2dyZXNzb3IuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICB2YXIgbGFzdEhpdFRpbWUgPSB0aGlzLnJlY2VudE1hZ2ljSGl0cy5nZXQoYWdncmVzc29ySWQpO1xyXG4gICAgICAgICAgICBpZiAobGFzdEhpdFRpbWUgJiYgbm93IC0gbGFzdEhpdFRpbWUgPCAxMDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnJlY2VudE1hZ2ljSGl0cy5zZXQoYWdncmVzc29ySWQsIG5vdyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHsgdDogTXNnVHlwZS5PbkhpdCwgZGF0YTogdGhpcy5nZXRIaXREYXRhKGUpIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBIaXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRIaXREYXRhID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgaGl0RGF0YSA9IHtcclxuICAgICAgICAgICAgYWdncmVzc29yOiBsb2NhbElkVG9SZW1vdGVJZChlLmFnZ3Jlc3Nvci5nZXRGb3JtSUQoKSksXHJcbiAgICAgICAgICAgIGlzQmFzaEF0dGFjazogZS5pc0Jhc2hBdHRhY2ssXHJcbiAgICAgICAgICAgIGlzSGl0QmxvY2tlZDogZS5pc0hpdEJsb2NrZWQsXHJcbiAgICAgICAgICAgIGlzUG93ZXJBdHRhY2s6IGUuaXNQb3dlckF0dGFjayxcclxuICAgICAgICAgICAgaXNTbmVha0F0dGFjazogZS5pc1NuZWFrQXR0YWNrLFxyXG4gICAgICAgICAgICBwcm9qZWN0aWxlOiBlLnByb2plY3RpbGUgPyBlLnByb2plY3RpbGUuZ2V0Rm9ybUlEKCkgOiAwLFxyXG4gICAgICAgICAgICBzb3VyY2U6IGUuc291cmNlID8gZS5zb3VyY2UuZ2V0Rm9ybUlEKCkgOiAwLFxyXG4gICAgICAgICAgICB0YXJnZXQ6IGxvY2FsSWRUb1JlbW90ZUlkKGUudGFyZ2V0LmdldEZvcm1JRCgpKVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIGhpdERhdGE7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEhpdFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgSGl0U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgS2V5Ym9hcmRFdmVudHNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEtleWJvYXJkRXZlbnRzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEtleWJvYXJkRXZlbnRzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5sYXN0TnVtS2V5cyA9IDA7XHJcbiAgICAgICAgY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBLZXlib2FyZEV2ZW50c1NlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG51bUtleXMgPSB0aGlzLnNwLklucHV0LmdldE51bUtleXNQcmVzc2VkKCk7XHJcbiAgICAgICAgaWYgKHRoaXMubGFzdE51bUtleXMgIT09IG51bUtleXMpIHtcclxuICAgICAgICAgICAgdGhpcy5sYXN0TnVtS2V5cyA9IG51bUtleXM7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJxdWVyeUtleUNvZGVCaW5kaW5nc1wiLCB7XHJcbiAgICAgICAgICAgICAgICBpc0Rvd246IGZ1bmN0aW9uIChiaW5kaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmcuZXZlcnkoZnVuY3Rpb24gKGtleSkgeyByZXR1cm4gX3RoaXMuc3AuSW5wdXQuaXNLZXlQcmVzc2VkKGtleSk7IH0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gS2V5Ym9hcmRFdmVudHNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEtleWJvYXJkRXZlbnRzU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBMYXN0SW52U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhMYXN0SW52U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIExhc3RJbnZTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShMYXN0SW52U2VydmljZS5wcm90b3R5cGUsIFwibGFzdEludlwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sYXN0SW52O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAobmV3VmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5fbGFzdEludiA9IG5ld1ZhbHVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBMYXN0SW52U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBMYXN0SW52U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgTG9hZEdhbWVTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKExvYWRHYW1lU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIExvYWRHYW1lU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5faXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImxvYWRHYW1lXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uTG9hZEdhbWUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgTG9hZEdhbWVTZXJ2aWNlLnByb3RvdHlwZS5sb2FkR2FtZSA9IGZ1bmN0aW9uIChwb3MsIHJvdCwgd29ybGRPckNlbGwsIGNoYW5nZUZvcm1OcGMsIGxvYWRPcmRlciwgdGltZSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgdGhpcy5zcC5sb2FkR2FtZShwb3MsIHJvdCwgd29ybGRPckNlbGwsIGNoYW5nZUZvcm1OcGMsIGxvYWRPcmRlciwgdGltZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIC8vIEhvdGZpeCBub24tdmFuaWxsYSBoZWFkcGFydHMgYnVnXHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgdGhpcy5zcC5sb2FkR2FtZShwb3MsIHJvdCwgd29ybGRPckNlbGwsIHVuZGVmaW5lZCwgbG9hZE9yZGVyLCB0aW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5faXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtID0gdHJ1ZTtcclxuICAgIH07XHJcbiAgICBMb2FkR2FtZVNlcnZpY2UucHJvdG90eXBlLm9uTG9hZEdhbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB2YXIgZ2FtZUxvYWRFdmVudCA9IHtcclxuICAgICAgICAgICAgICAgIGlzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybTogdGhpcy5faXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJnYW1lTG9hZFwiLCBnYW1lTG9hZEV2ZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLl9pc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm0gPSBmYWxzZTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIF90aGlzLl9pc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm0gPSBmYWxzZTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gTG9hZEdhbWVTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IExvYWRHYW1lU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgR2FtZSwgVXRpbGl0eSwgcHJpbnRDb25zb2xlLCBjcmVhdGVUZXh0LCBzZXRUZXh0U2l6ZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBnZXRTY3JlZW5SZXNvbHV0aW9uIH0gZnJvbSBcIi4uLy4uL3ZpZXcvZm9ybVZpZXdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IFNldHRpbmdzU2VydmljZSB9IGZyb20gXCIuL3NldHRpbmdzU2VydmljZVwiO1xyXG52YXIgU1RBVEVfS0VZID0gJ2xvYWRPcmRlckNoZWNrU3RhdGUnO1xyXG47XHJcbnZhciBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy52ZXJpZnlMb2FkT3JkZXIoKTtcclxuICAgIH07XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS52ZXJpZnlMb2FkT3JkZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgc2V0dGluZ3NTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNldHRpbmdzU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5yZXNldFRleHQoKTtcclxuICAgICAgICB2YXIgY2xpZW50TW9kcyA9IHRoaXMuZ2V0Q2xpZW50TW9kcygpO1xyXG4gICAgICAgIHRoaXMucHJpbnRNb2RPcmRlcignQ2xpZW50IGxvYWQgb3JkZXI6JywgY2xpZW50TW9kcyk7XHJcbiAgICAgICAgcmV0dXJuIHNldHRpbmdzU2VydmljZS5nZXRTZXJ2ZXJNb2RzKClcclxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHNlcnZlck1vZHMpIHtcclxuICAgICAgICAgICAgX3RoaXMucHJpbnRNb2RPcmRlcignU2VydmVyIGxvYWQgb3JkZXI6Jywgc2VydmVyTW9kcyk7XHJcbiAgICAgICAgICAgIGlmIChjbGllbnRNb2RzLmxlbmd0aCA8IHNlcnZlck1vZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNaXNzaW5nIHNvbWUgc2VydmVyIG1vZHMuIFNlcnZlciBoYXMgXCIuY29uY2F0KHNlcnZlck1vZHMubGVuZ3RoLCBcIiwgd2UgaGF2ZSBcIikuY29uY2F0KGNsaWVudE1vZHMubGVuZ3RoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNsaWVudE1vZHMubGVuZ3RoID4gc2VydmVyTW9kcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnVwZGF0ZVRleHQoJ0xPQUQgT1JERVIgV0FSTklORzogeW91IGhhdmUgbW9yZSBtb2RzIHRoYW4gc2VydmVyIVxcbihvciBjb3VsZCBub3QgcmVjZWl2ZSBzZXJ2ZXIgbW9kIGxpc3QpXFxuQ2hlY2sgY29uc29sZSBmb3IgZGV0YWlscy4nLCBbMjU1LCAyNTUsIDAsIDFdLCA1KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgZmFpbCA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlcnZlck1vZHMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICAgIC8vIE5lZWQgY2FzZS1pbnNlbnNpdGl2ZSBjaGVjayBmb3IgMS42K1xyXG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudE1vZHNbaV0uZmlsZW5hbWUudG9Mb3dlckNhc2UoKSAhPT0gc2VydmVyTW9kc1tpXS5maWxlbmFtZS50b0xvd2VyQ2FzZSgpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50TW9kc1tpXS5zaXplICE9PSBzZXJ2ZXJNb2RzW2ldLnNpemUgfHxcclxuICAgICAgICAgICAgICAgICAgICBjbGllbnRNb2RzW2ldLmNyYzMyICE9PSBzZXJ2ZXJNb2RzW2ldLmNyYzMyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmFpbC5wdXNoKGkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlwiLmNvbmNhdChpLCBcIi10aCBtb2QgKG51bWJlcmVkIGZyb20gMCkgZG9lcyBub3QgbWF0Y2guXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJTZXJ2ZXIgaGFzIFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShzZXJ2ZXJNb2RzW2ldKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIldlIGhhdmUgXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGNsaWVudE1vZHNbaV0pKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGZhaWwubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvYWQgb3JkZXIgY2hlY2sgZmFpbGVkISBJbmRpY2VzOiAnICsgSlNPTi5zdHJpbmdpZnkoZmFpbCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgICAgcHJpbnRDb25zb2xlKGVycik7XHJcbiAgICAgICAgICAgIGlmIChfdGhpcy5zcC5zZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydpZ25vcmVMb2FkT3JkZXJNaXNtYXRjaCddKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy51cGRhdGVUZXh0KCdMT0FEIE9SREVSIEVSUk9SIVxcbkhvd2V2ZXIsIGlnbm9yaW5nIGl0IGJlY2F1c2Ugb2YgaWdub3JlTG9hZE9yZGVyTWlzbWF0Y2ggYmVpbmcgc2V0LicgK1xyXG4gICAgICAgICAgICAgICAgICAgICdcXG5FeHBlY3QgRVZFUllUSElORyBCUkVBSywgdW5sZXNzIHlvdSBrbm93IHdoYXQgeW91IGFyZSBkb2luZy5cXG5DaGVjayBjb25zb2xlIGZvciBkZXRhaWxzLicgK1xyXG4gICAgICAgICAgICAgICAgICAgICdcXG5UaGlzIG1lc3NhZ2Ugd2lsbCBkaXNhcHBlYXIgYWZ0ZXIgMzAgc2Vjb25kcy4nLCBbMjU1LCAwLCAwLCAxXSwgMzApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF90aGlzLnVwZGF0ZVRleHQoJ0xPQUQgT1JERVIgRVJST1IhXFxuQ2hlY2sgY29uc29sZSBmb3IgZGV0YWlscy4nLCBbMjU1LCAwLCAwLCAxXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnNwLnN0b3JhZ2VbU1RBVEVfS0VZXSAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5zcC5zdG9yYWdlW1NUQVRFX0tFWV07XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbiAocmVwbGFjZW1lbnQpIHtcclxuICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLnNwLnN0b3JhZ2VbU1RBVEVfS0VZXSA9IHRoaXMuZ2V0U3RhdGUoKTtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9hID0gT2JqZWN0LmVudHJpZXMocmVwbGFjZW1lbnQpOyBfaSA8IF9hLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIgX2IgPSBfYVtfaV0sIGsgPSBfYlswXSwgdiA9IF9iWzFdO1xyXG4gICAgICAgICAgICBvbGRTdGF0ZVtrXSA9IHY7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIDtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnJlc2V0VGV4dCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgc3RhdHVzVGV4dElkID0gdGhpcy5nZXRTdGF0ZSgpLnN0YXR1c1RleHRJZDtcclxuICAgICAgICBpZiAoc3RhdHVzVGV4dElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQoc3RhdHVzVGV4dElkKTtcclxuICAgICAgICAgICAgc3RhdHVzVGV4dElkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgc3RhdHVzVGV4dElkOiBzdGF0dXNUZXh0SWQgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIDtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnVwZGF0ZVRleHQgPSBmdW5jdGlvbiAodGV4dCwgY29sb3IsIGNsZWFyRGVsYXkpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYSA9IGdldFNjcmVlblJlc29sdXRpb24oKSwgd2lkdGggPSBfYS53aWR0aCwgaGVpZ2h0ID0gX2EuaGVpZ2h0O1xyXG4gICAgICAgIHRoaXMucmVzZXRUZXh0KCk7XHJcbiAgICAgICAgdmFyIHN0YXR1c1RleHRJZCA9IGNyZWF0ZVRleHQod2lkdGggLyAyLCBoZWlnaHQgLyAyLCB0ZXh0LCBjb2xvcik7XHJcbiAgICAgICAgc2V0VGV4dFNpemUoc3RhdHVzVGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBzdGF0dXNUZXh0SWQ6IHN0YXR1c1RleHRJZCB9KTtcclxuICAgICAgICBpZiAoY2xlYXJEZWxheSkge1xyXG4gICAgICAgICAgICBVdGlsaXR5LndhaXQoY2xlYXJEZWxheSkudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5yZXNldFRleHQoKTsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLmVudW1lcmF0ZUNsaWVudE1vZHMgPSBmdW5jdGlvbiAoZ2V0Q291bnQsIGdldEF0KSB7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ2V0Q291bnQoKTsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBmaWxlbmFtZSA9IGdldEF0KGkpO1xyXG4gICAgICAgICAgICB2YXIgX2EgPSB0aGlzLmdldEZpbGVJbmZvU2FmZShmaWxlbmFtZSksIGNyYzMyID0gX2EuY3JjMzIsIHNpemUgPSBfYS5zaXplO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh7IGZpbGVuYW1lOiBmaWxlbmFtZSwgY3JjMzI6IGNyYzMyLCBzaXplOiBzaXplIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfTtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLmdldENsaWVudE1vZHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZW51bWVyYXRlQ2xpZW50TW9kcyhHYW1lLmdldE1vZENvdW50LCBHYW1lLmdldE1vZE5hbWUpO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnByaW50TW9kT3JkZXIgPSBmdW5jdGlvbiAoaGVhZGVyLCBvcmRlcikge1xyXG4gICAgICAgIHByaW50Q29uc29sZShoZWFkZXIpO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSBPYmplY3QuZW50cmllcyhvcmRlcik7IF9pIDwgX2EubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBfYiA9IF9hW19pXSwgaSA9IF9iWzBdLCBtb2QgPSBfYlsxXTtcclxuICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiI1wiLmNvbmNhdChpLCBcIiBcIikuY29uY2F0KEpTT04uc3RyaW5naWZ5KG1vZCkpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUuZ2V0RmlsZUluZm9TYWZlID0gZnVuY3Rpb24gKGZpbGVuYW1lKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3AuZ2V0RmlsZUluZm8oZmlsZW5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGUubWVzc2FnZTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlID09PSBcInN0cmluZ1wiICYmIG1lc3NhZ2UuaW5jbHVkZXMoJ2lzIG5vdCBhIHZhbGlkIGFyZ3VtZW50JykpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiRmFpbGVkIHRvIGdldCBmaWxlIGluZm8gZm9yXCIsIGZpbGVuYW1lKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGNyYzMyOiAwLCBzaXplOiAwIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHRoaXMgb3V0XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkLCByZW1vdGVJZFRvTG9jYWxJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuaW1wb3J0IHsgR2FtZSwgZ2V0QW5pbWF0aW9uVmFyaWFibGVzRnJvbUFjdG9yLCBTcGVsbFR5cGUgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSAnLi9jbGllbnRMaXN0ZW5lcic7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxudmFyIE1hZ2ljU3luY1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTWFnaWNTeW5jU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIE1hZ2ljU3luY1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMucGxheWVySWQgPSAweDE0O1xyXG4gICAgICAgIF90aGlzLnNlbmRVcGRhdGVBbmltYXRpb25WYXJpYWJsZXNSYXRlTXMgPSA1MDA7XHJcbiAgICAgICAgX3RoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnID0gbnVsbDtcclxuICAgICAgICBfdGhpcy5sYXN0U2VuZFVwZGF0ZUFuaW1hdGlvblZhcmlhYmxlcyA9IDA7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwic3BlbGxDYXN0XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNwZWxsQ2FzdChlKTsgfSk7XHJcbiAgICAgICAgdmFyIHNlbGYgPSBfdGhpcztcclxuICAgICAgICBfdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHsgfSxcclxuICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYub25TZW5kQW5pbWF0aW9uRXZlbnRMZWF2ZShjdHgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgX3RoaXMucGxheWVySWQsIF90aGlzLnBsYXllcklkKTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICh0aGlzLmlzQW55TWFnaWNTdHVmZkVxdWlwZWQoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMubGFzdFNlbmRVcGRhdGVBbmltYXRpb25WYXJpYWJsZXMgPD0gdGhpcy5zZW5kVXBkYXRlQW5pbWF0aW9uVmFyaWFibGVzUmF0ZU1zKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sYXN0U2VuZFVwZGF0ZUFuaW1hdGlvblZhcmlhYmxlcyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgaWYgKCFhYykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhbmltVmFyaWFibGVzID0gX3RoaXMuZ2V0QW5pbWF0aW9uVmFyaWFibGVzRnJvbUFjdG9yQ29udmVydGVkKGFjLmdldEZvcm1JRCgpKTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiB7IHQ6IE1zZ1R5cGUuVXBkYXRlQW5pbVZhcmlhYmxlcywgZGF0YTogX3RoaXMuZ2V0VXBkYXRlQW5pbVZhcmlhYmxlc0V2ZW50RGF0YShhYywgYW5pbVZhcmlhYmxlcykgfSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUub25TcGVsbENhc3QgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgaXNJbnRlcnJ1cHRDYXN0ID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIG1zZyA9IHRoaXMuZ2V0U3BlbGxDYXN0RXZlbnREYXRhKGV2ZW50LCBpc0ludGVycnVwdENhc3QpO1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHsgdDogTXNnVHlwZS5TcGVsbENhc3QsIGRhdGE6IG1zZyB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2cgPSBtc2c7XHJcbiAgICB9O1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUub25TZW5kQW5pbWF0aW9uRXZlbnRMZWF2ZSA9IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICghdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2cgfHwgIXRoaXMuaXNJbnRlcmFwdFNwZWxsQ2FzdEFuaW0oY3R4LmFuaW1FdmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKCFfdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2cgfHwgX3RoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnLmludGVycnVwdENhc3QpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgbXNnID0gX3RoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnO1xyXG4gICAgICAgICAgICBtc2cuaW50ZXJydXB0Q2FzdCA9IHRydWU7XHJcbiAgICAgICAgICAgIG1zZy5hY3RvckFuaW1hdGlvblZhcmlhYmxlcyA9IF90aGlzLmdldEFuaW1hdGlvblZhcmlhYmxlc0Zyb21BY3RvckNvbnZlcnRlZChyZW1vdGVJZFRvTG9jYWxJZChfdGhpcy5sYXN0U3BlbGxDYXN0RXZlbnRNc2cuY2FzdGVyKSk7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogeyB0OiBNc2dUeXBlLlNwZWxsQ2FzdCwgZGF0YTogbXNnIH0sXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLmdldFNwZWxsQ2FzdEV2ZW50RGF0YSA9IGZ1bmN0aW9uIChlLCBpc0ludGVycnVwdENhc3QpIHtcclxuICAgICAgICB2YXIgc3BlbGxDYXN0RGF0YSA9IHtcclxuICAgICAgICAgICAgY2FzdGVyOiBsb2NhbElkVG9SZW1vdGVJZChlLmNhc3Rlci5nZXRGb3JtSUQoKSwgdHJ1ZSksXHJcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgICAgIHRhcmdldDogZS50YXJnZXQgPyBsb2NhbElkVG9SZW1vdGVJZChlLnRhcmdldC5nZXRGb3JtSUQoKSwgdHJ1ZSkgOiAwLFxyXG4gICAgICAgICAgICBzcGVsbDogZS5zcGVsbCA/IGUuc3BlbGwuZ2V0Rm9ybUlEKCkgOiAwLFxyXG4gICAgICAgICAgICBpbnRlcnJ1cHRDYXN0OiBpc0ludGVycnVwdENhc3QsXHJcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgICAgIGlzRHVhbENhc3Rpbmc6IGUuaXNEdWFsQ2FzdGluZyxcclxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICAgICAgY2FzdGluZ1NvdXJjZTogZS5jYXN0aW5nU291cmNlLFxyXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgICAgICBhaW1BbmdsZTogZS5haW1BbmdsZSxcclxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICAgICAgYWltSGVhZGluZzogZS5haW1IZWFkaW5nLFxyXG4gICAgICAgICAgICBhY3RvckFuaW1hdGlvblZhcmlhYmxlczogdGhpcy5nZXRBbmltYXRpb25WYXJpYWJsZXNGcm9tQWN0b3JDb252ZXJ0ZWQoZS5jYXN0ZXIuZ2V0Rm9ybUlEKCkpLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHNwZWxsQ2FzdERhdGE7XHJcbiAgICB9O1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUuZ2V0QW5pbWF0aW9uVmFyaWFibGVzRnJvbUFjdG9yQ29udmVydGVkID0gZnVuY3Rpb24gKGFjdG9ySWQpIHtcclxuICAgICAgICB2YXIgYW5pbVZhcnMgPSBnZXRBbmltYXRpb25WYXJpYWJsZXNGcm9tQWN0b3IoYWN0b3JJZCk7XHJcbiAgICAgICAgdmFyIGJvb2xlYW5zID0gYW5pbVZhcnMuYm9vbGVhbnM7XHJcbiAgICAgICAgdmFyIGZsb2F0cyA9IGFuaW1WYXJzLmZsb2F0cztcclxuICAgICAgICB2YXIgaW50ZWdlcnMgPSBhbmltVmFycy5pbnRlZ2VycztcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBib29sZWFuczogQXJyYXkuZnJvbShuZXcgVWludDhBcnJheShib29sZWFucykpLFxyXG4gICAgICAgICAgICBmbG9hdHM6IEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoZmxvYXRzKSksXHJcbiAgICAgICAgICAgIGludGVnZXJzOiBBcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGludGVnZXJzKSksXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5nZXRVcGRhdGVBbmltVmFyaWFibGVzRXZlbnREYXRhID0gZnVuY3Rpb24gKGFjLCBhbmltVmFyaWFibGVzKSB7XHJcbiAgICAgICAgdmFyIGFuaW1WYXJzRGF0YSA9IHtcclxuICAgICAgICAgICAgYWN0b3JSZW1vdGVJZDogbG9jYWxJZFRvUmVtb3RlSWQoYWMuZ2V0Rm9ybUlEKCksIHRydWUpLFxyXG4gICAgICAgICAgICBhY3RvckFuaW1hdGlvblZhcmlhYmxlczogYW5pbVZhcmlhYmxlcyxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBhbmltVmFyc0RhdGE7XHJcbiAgICB9O1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUuaXNJbnRlcmFwdFNwZWxsQ2FzdEFuaW0gPSBmdW5jdGlvbiAoYW5pbUV2ZW50TmFtZSkge1xyXG4gICAgICAgIHZhciBldmVudE5hbWUgPSBhbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgcmV0dXJuIGV2ZW50TmFtZSA9PT0gXCJtbGhfZXF1aXBwZWRfZXZlbnRcIiB8fCBldmVudE5hbWUgPT09IFwibXJoX2VxdWlwcGVkX2V2ZW50XCI7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUuaXNTcGVsbENhc3RBbmltID0gZnVuY3Rpb24gKGFuaW1FdmVudE5hbWUpIHtcclxuICAgICAgICB2YXIgZXZlbnROYW1lID0gYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIHZhciBpc1NwZWxsQ2FzdEFuaW1Gb3JMZWZ0SGFuZCA9IGV2ZW50TmFtZSA9PT0gXCJtbGhfc3BlbGxhaW1lZGNvbmNlbnRyYXRpb25zdGFydFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtbGhfc3BlbGxhaW1lZHN0YXJ0XCIgfHwgZXZlbnROYW1lID09PSBcIm1saF9zcGVsbHJlYWR5X2V2ZW50XCIgfHxcclxuICAgICAgICAgICAgZXZlbnROYW1lID09PSBcIm1saF9zcGVsbHJlbGVhc2VfZXZlbnRcIiB8fCBldmVudE5hbWUgPT09IFwibWxoX2VxdWlwcGVkX2V2ZW50XCI7XHJcbiAgICAgICAgdmFyIGlzU3BlbGxDYXN0QW5pbUZvclJpZ2h0SGFuZCA9IGV2ZW50TmFtZSA9PT0gXCJtcmhfc3BlbGxhaW1lZGNvbmNlbnRyYXRpb25zdGFydFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtcmhfc3BlbGxhaW1lZHN0YXJ0XCIgfHwgZXZlbnROYW1lID09PSBcIm1yaF9zcGVsbHJlYWR5X2V2ZW50XCIgfHxcclxuICAgICAgICAgICAgZXZlbnROYW1lID09PSBcIm1yaF9zcGVsbHJlbGVhc2VfZXZlbnRcIiB8fCBldmVudE5hbWUgPT09IFwibXJoX2VxdWlwcGVkX2V2ZW50XCI7XHJcbiAgICAgICAgcmV0dXJuIGlzU3BlbGxDYXN0QW5pbUZvckxlZnRIYW5kIHx8IGlzU3BlbGxDYXN0QW5pbUZvclJpZ2h0SGFuZDtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5pc0FueU1hZ2ljU3R1ZmZFcXVpcGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBhYyA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgaWYgKCFhYykge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhYy5nZXRFcXVpcHBlZFNwZWxsKFNwZWxsVHlwZS5MZWZ0KSB8fCBhYy5nZXRFcXVpcHBlZFNwZWxsKFNwZWxsVHlwZS5SaWdodCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhYy5nZXRFcXVpcHBlZFNwZWxsKFNwZWxsVHlwZS5Wb2lzZSkgfHwgYWMuZ2V0RXF1aXBwZWRTcGVsbChTcGVsbFR5cGUuSW5zdGFudCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBsZWZ0SGFuZEVxdWlwbWVudFR5cGUgPSBhYy5nZXRFcXVpcHBlZEl0ZW1UeXBlKDEgLyogU2xvdFR5cGUuTGVmdCAqLyk7XHJcbiAgICAgICAgdmFyIHJpZ2h0SGFuZEVxdWlwbWVudFR5cGUgPSBhYy5nZXRFcXVpcHBlZEl0ZW1UeXBlKDIgLyogU2xvdFR5cGUuUmlnaHQgKi8pO1xyXG4gICAgICAgIC8vIFRPRE86IFNwZWxsID0+IFNwZWxsT3JTY3JvbGwsIHNpbmNlIFNwZWxsIGlzIG5vdyBhIGRlcHJlY2F0ZWQgbmFtZSAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICBpZiAobGVmdEhhbmRFcXVpcG1lbnRUeXBlID09PSA5IC8qIEVxdWlwcGVkSXRlbVR5cGUuU3BlbGwgKi8gfHwgbGVmdEhhbmRFcXVpcG1lbnRUeXBlID09PSA4IC8qIEVxdWlwcGVkSXRlbVR5cGUuU3RhZmYgKi8gfHxcclxuICAgICAgICAgICAgcmlnaHRIYW5kRXF1aXBtZW50VHlwZSA9PT0gOSAvKiBFcXVpcHBlZEl0ZW1UeXBlLlNwZWxsICovIHx8IHJpZ2h0SGFuZEVxdWlwbWVudFR5cGUgPT09IDggLyogRXF1aXBwZWRJdGVtVHlwZS5TdGFmZiAqLykge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBNYWdpY1N5bmNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IE1hZ2ljU3luY1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IHNldFRleHRTaXplIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIE5ldEluZm9TZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKE5ldEluZm9TZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTmV0SW5mb1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5yZWNlaXZlZFBhY2tldENvdW50ID0gMDtcclxuICAgICAgICBfdGhpcy5zZW50UGFja2V0Q291bnQgPSAwO1xyXG4gICAgICAgIF90aGlzLmxvY2FsTGFnVW5pdHMgPSAwO1xyXG4gICAgICAgIF90aGlzLmRlbGF5TXMgPSAxMDAwO1xyXG4gICAgICAgIF90aGlzLmxhc3REdCA9IDA7XHJcbiAgICAgICAgX3RoaXMuZHQgPSAwO1xyXG4gICAgICAgIF90aGlzLmdyZWVuQVJHQiA9IFswLCAxMjgsIDAsIDFdO1xyXG4gICAgICAgIF90aGlzLnJlZEFSR0IgPSBbMjU1LCAwLCAwLCAxXTtcclxuICAgICAgICAvLyBjbGVhciBwcmV2aW91cyB0ZXh0cyBpbiBjYXNlIG9mIGhvdHJlbG9hZFxyXG4gICAgICAgIGlmIChfdGhpcy5zcC5zdG9yYWdlW05ldEluZm9UZXh0cy5OYW1lXSAmJiBfdGhpcy5zcC5zdG9yYWdlW05ldEluZm9UZXh0cy5OYW1lXS5jbGVhcikge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJEZXN0cm95aW5nIG9sZCBOZXRJbmZvVGV4dHNcIik7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAoX2EgPSBfdGhpcy5zcC5zdG9yYWdlW05ldEluZm9UZXh0cy5OYW1lXSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIkZhaWxlZCB0byBkZXN0cm95IG9sZCBOZXRJbmZvVGV4dHM6XCIsIGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghX3RoaXMuaXNFbmFibGVkKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy50ZXh0SWRzID0gbmV3IE5ldEluZm9UZXh0cyhfdGhpcy5zcCk7XHJcbiAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVtOZXRJbmZvVGV4dHMuTmFtZV0gPSBfdGhpcy50ZXh0SWRzO1xyXG4gICAgICAgIF90aGlzLmxhc3REdCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2VuZE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2VuZE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZW5kTWVzc2FnZVdpdGhSZWZySWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImFueU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQW55TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwibmV3TG9jYWxMYWdWYWx1ZUNhbGN1bGF0ZWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTmV3TG9jYWxMYWdWYWx1ZUNhbGN1bGF0ZWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuYWRkU2VudFBhY2tldENvdW50KDEpO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRNZXNzYWdlV2l0aFJlZnJJZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5hZGRTZW50UGFja2V0Q291bnQoMSk7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLm9uQW55TWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5hZGRSZWNlaXZlZFBhY2tldENvdW50KDEpO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5vbk5ld0xvY2FsTGFnVmFsdWVDYWxjdWxhdGVkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLnNldExvY2FsTGFnVW5pdHMoZS5sYWdVbml0c05vWik7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnRleHRJZHMgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZHQgKz0gRGF0ZS5ub3coKSAtIHRoaXMubGFzdER0O1xyXG4gICAgICAgIHRoaXMubGFzdER0ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB2YXIgaXNDb25uZWN0ZWQgPSB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLmlzQ29ubmVjdGVkKCk7XHJcbiAgICAgICAgdGhpcy5zcC5zZXRUZXh0U3RyaW5nKHRoaXMudGV4dElkcy5jb25uZWN0aW9uU3RhdGVUZXh0SWQsIFwiXCIuY29uY2F0KGlzQ29ubmVjdGVkID8gXCJPTlwiIDogXCJPRkZcIikpO1xyXG4gICAgICAgIHRoaXMuc3Auc2V0VGV4dENvbG9yKHRoaXMudGV4dElkcy5jb25uZWN0aW9uU3RhdGVUZXh0SWQsIGlzQ29ubmVjdGVkID8gdGhpcy5ncmVlbkFSR0IgOiB0aGlzLnJlZEFSR0IpO1xyXG4gICAgICAgIC8vIGh0dHBzOi8vd3d3LmNyZWF0aW9ua2l0LmNvbS9pbmRleC5waHA/dGl0bGU9VW5pdFxyXG4gICAgICAgIHZhciB1bml0cyA9IHRoaXMuZ2V0TG9jYWxMYWdVbml0cygpO1xyXG4gICAgICAgIHZhciB1bml0c0luTWV0ZXIgPSA3MC4wMjE4ODE4MzgxO1xyXG4gICAgICAgIHZhciBtZXRlcnMgPSBNYXRoLnJvdW5kKHVuaXRzIC8gdW5pdHNJbk1ldGVyICogMTApIC8gMTA7XHJcbiAgICAgICAgdGhpcy5zcC5zZXRUZXh0U3RyaW5nKHRoaXMudGV4dElkcy5sb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkLCBcIlwiLmNvbmNhdCh1bml0cywgXCIgdW5pdHMgKH5cIikuY29uY2F0KG1ldGVycywgXCIgbSlcIikpO1xyXG4gICAgICAgIGlmICh0aGlzLmRlbGF5TXMgPiB0aGlzLmR0KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zcC5zZXRUZXh0U3RyaW5nKHRoaXMudGV4dElkcy5yZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCwgXCJcIi5jb25jYXQoTWF0aC5yb3VuZCh0aGlzLmdldEFuZENsZWFyUmVjZWl2ZWRQYWNrZXRDb3VudCgpKSkpO1xyXG4gICAgICAgIHRoaXMuc3Auc2V0VGV4dFN0cmluZyh0aGlzLnRleHRJZHMuc2VudFBhY2tldEFtb3VudFRleHRJZCwgXCJcIi5jb25jYXQoTWF0aC5yb3VuZCh0aGlzLmdldEFuZENsZWFyU2VudFBhY2tldENvdW50KCkpKSk7XHJcbiAgICAgICAgdGhpcy5kdCA9IDA7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLmFkZFJlY2VpdmVkUGFja2V0Q291bnQgPSBmdW5jdGlvbiAoY291bnQpIHtcclxuICAgICAgICB0aGlzLnJlY2VpdmVkUGFja2V0Q291bnQgKz0gY291bnQ7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLmdldEFuZENsZWFyUmVjZWl2ZWRQYWNrZXRDb3VudCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLnJlY2VpdmVkUGFja2V0Q291bnQ7XHJcbiAgICAgICAgdGhpcy5yZWNlaXZlZFBhY2tldENvdW50ID0gMDtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLmFkZFNlbnRQYWNrZXRDb3VudCA9IGZ1bmN0aW9uIChjb3VudCkge1xyXG4gICAgICAgIHRoaXMuc2VudFBhY2tldENvdW50ICs9IGNvdW50O1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5nZXRBbmRDbGVhclNlbnRQYWNrZXRDb3VudCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLnNlbnRQYWNrZXRDb3VudDtcclxuICAgICAgICB0aGlzLnNlbnRQYWNrZXRDb3VudCA9IDA7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5zZXRMb2NhbExhZ1VuaXRzID0gZnVuY3Rpb24gKGRpc3RhbmNlKSB7XHJcbiAgICAgICAgdGhpcy5sb2NhbExhZ1VuaXRzID0gZGlzdGFuY2U7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLmdldExvY2FsTGFnVW5pdHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxMYWdVbml0cztcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuaXNFbmFibGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wic2hvdy1uZXQtaW5mb1wiXTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gTmV0SW5mb1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgTmV0SW5mb1NlcnZpY2UgfTtcclxudmFyIE5ldEluZm9UZXh0cyA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIE5ldEluZm9UZXh0cyhzcCwgY29ubmVjdGlvblN0YXRpY1RleHRJZCwgY29ubmVjdGlvblN0YXRlVGV4dElkLCByZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZCwgcmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQsIHNlbnRQYWNrZXRTdGF0aWNUZXh0SWQsIHNlbnRQYWNrZXRBbW91bnRUZXh0SWQsIGxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQsIGxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQpIHtcclxuICAgICAgICBpZiAoY29ubmVjdGlvblN0YXRpY1RleHRJZCA9PT0gdm9pZCAwKSB7IGNvbm5lY3Rpb25TdGF0aWNUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDEwMCwgMzUwLCBcImNvbm5lY3Rpb246XCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAoY29ubmVjdGlvblN0YXRlVGV4dElkID09PSB2b2lkIDApIHsgY29ubmVjdGlvblN0YXRlVGV4dElkID0gc3AuY3JlYXRlVGV4dCgyMjAsIDM1MCwgXCJcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChyZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZCA9PT0gdm9pZCAwKSB7IHJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkID0gc3AuY3JlYXRlVGV4dCgxMjAsIDM5MCwgXCJpbmNvbWluZyAocC9zKTpcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChyZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCA9PT0gdm9pZCAwKSB7IHJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkID0gc3AuY3JlYXRlVGV4dCgyNTAsIDM5MCwgXCJcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChzZW50UGFja2V0U3RhdGljVGV4dElkID09PSB2b2lkIDApIHsgc2VudFBhY2tldFN0YXRpY1RleHRJZCA9IHNwLmNyZWF0ZVRleHQoMTIwLCA0MzAsIFwib3V0Z29pbmcgKHAvcyk6XCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAoc2VudFBhY2tldEFtb3VudFRleHRJZCA9PT0gdm9pZCAwKSB7IHNlbnRQYWNrZXRBbW91bnRUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDI1MCwgNDMwLCBcIlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKGxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQgPT09IHZvaWQgMCkgeyBsb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkID0gc3AuY3JlYXRlVGV4dCg5MCwgNDcwLCBcImxvY2FsIGxhZzpcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChsb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkID09PSB2b2lkIDApIHsgbG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCA9IHNwLmNyZWF0ZVRleHQoMjUwLCA0NzAsIFwiXCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICB0aGlzLnNwID0gc3A7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uU3RhdGljVGV4dElkID0gY29ubmVjdGlvblN0YXRpY1RleHRJZDtcclxuICAgICAgICB0aGlzLmNvbm5lY3Rpb25TdGF0ZVRleHRJZCA9IGNvbm5lY3Rpb25TdGF0ZVRleHRJZDtcclxuICAgICAgICB0aGlzLnJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkID0gcmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5yZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCA9IHJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkO1xyXG4gICAgICAgIHRoaXMuc2VudFBhY2tldFN0YXRpY1RleHRJZCA9IHNlbnRQYWNrZXRTdGF0aWNUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5zZW50UGFja2V0QW1vdW50VGV4dElkID0gc2VudFBhY2tldEFtb3VudFRleHRJZDtcclxuICAgICAgICB0aGlzLmxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQgPSBsb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkO1xyXG4gICAgICAgIHRoaXMubG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCA9IGxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQ7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5jb25uZWN0aW9uU3RhdGljVGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMuY29ubmVjdGlvblN0YXRlVGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMucmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5yZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLnNlbnRQYWNrZXRTdGF0aWNUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5zZW50UGFja2V0QW1vdW50VGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMubG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLmxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQsIDAuNSk7XHJcbiAgICB9XHJcbiAgICBOZXRJbmZvVGV4dHMucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5jb25uZWN0aW9uU3RhdGljVGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMuY29ubmVjdGlvblN0YXRlVGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMucmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5yZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLnNlbnRQYWNrZXRTdGF0aWNUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5zZW50UGFja2V0QW1vdW50VGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMubG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLmxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQpO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9UZXh0cy5OYW1lID0gXCJuZXRJbmZvVGV4dHNcIjtcclxuICAgIHJldHVybiBOZXRJbmZvVGV4dHM7XHJcbn0oKSk7XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBOZXZlckVycm9yIH0gZnJvbSBcIi4uLy4uL2xpYi9lcnJvcnNcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuL3JlbW90ZVNlcnZlclwiO1xyXG52YXIgTmV0d29ya2luZ1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTmV0d29ya2luZ1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBOZXR3b3JraW5nU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblRpY2soKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2VuZE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2VuZE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNlbmRSYXdNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNlbmRSYXdNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2VuZE1lc3NhZ2VXaXRoUmVmcklkKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUub25TZW5kTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5zcC5tcENsaWVudFBsdWdpbi5zZW5kKEpTT04uc3RyaW5naWZ5KGUubWVzc2FnZSksIHRoaXMuaXNSZWxpYWJsZShlLnJlbGlhYmlsaXR5KSk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZFJhd01lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcclxuICAgICAgICB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLnNlbmRSYXcoZS5yYXdNZXNzYWdlLCBlLnJhd01lc3NhZ2UuYnl0ZUxlbmd0aCwgdGhpcy5pc1JlbGlhYmxlKGUucmVsaWFiaWxpdHkpKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUub25TZW5kTWVzc2FnZVdpdGhSZWZySWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciByZWZySWQgPSBlLm1lc3NhZ2UuX3JlZnJJZDtcclxuICAgICAgICB2YXIgcmVtb3RlU2VydmVyID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJlbW90ZVNlcnZlcik7XHJcbiAgICAgICAgdmFyIGlkeEluTW9kZWwgPSByZWZySWRcclxuICAgICAgICAgICAgPyByZW1vdGVTZXJ2ZXIuZ2V0V29ybGRNb2RlbCgpLmZvcm1zLmZpbmRJbmRleChmdW5jdGlvbiAoZikgeyByZXR1cm4gZiAmJiBmLnJlZnJJZCA9PT0gcmVmcklkOyB9KVxyXG4gICAgICAgICAgICA6IHJlbW90ZVNlcnZlci5nZXRXb3JsZE1vZGVsKCkucGxheWVyQ2hhcmFjdGVyRm9ybUlkeDtcclxuICAgICAgICAvLyBmaXhlcyBcImNhbid0IGdldCBwcm9wZXJ0eSBpZHggb2YgbnVsbCBvciB1bmRlZmluZWRcIlxyXG4gICAgICAgIGlmICghcmVtb3RlU2VydmVyLmdldFdvcmxkTW9kZWwoKS5mb3Jtc1tpZHhJbk1vZGVsXSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBlLm1lc3NhZ2UuaWR4ID0gcmVtb3RlU2VydmVyLmdldFdvcmxkTW9kZWwoKS5mb3Jtc1tpZHhJbk1vZGVsXS5pZHg7XHJcbiAgICAgICAgZGVsZXRlIGUubWVzc2FnZS5fcmVmcklkO1xyXG4gICAgICAgIHRoaXMuc3AubXBDbGllbnRQbHVnaW4uc2VuZChKU09OLnN0cmluZ2lmeShlLm1lc3NhZ2UpLCB0aGlzLmlzUmVsaWFibGUoZS5yZWxpYWJpbGl0eSkpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gKGhvc3ROYW1lLCBwb3J0KSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2ZXJBZGRyZXNzID0geyBob3N0TmFtZTogaG9zdE5hbWUsIHBvcnQ6IHBvcnQgfTtcclxuICAgICAgICB0aGlzLmNyZWF0ZUNsaWVudFNhZmUoKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUucmVjb25uZWN0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlQ2xpZW50U2FmZSgpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5jbG9zZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLmRlc3Ryb3lDbGllbnQoKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUuaXNDb25uZWN0ZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3AubXBDbGllbnRQbHVnaW4uaXNDb25uZWN0ZWQoKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUub25UaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5zcC5tcENsaWVudFBsdWdpbi50aWNrKGZ1bmN0aW9uIChwYWNrZXRUeXBlLCByYXdDb250ZW50LCBlcnJvcikge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHBhY2tldFR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjb25uZWN0aW9uQWNjZXB0ZWRcIjpcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImNvbm5lY3Rpb25BY2NlcHRlZFwiLCB7fSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY29ubmVjdGlvbkRlbmllZFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY29ubmVjdGlvbkRlbmllZFwiLCB7IGVycm9yOiBlcnJvciB9KTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZWNvbm5lY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjb25uZWN0aW9uRmFpbGVkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjb25uZWN0aW9uRmFpbGVkXCIsIHt9KTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZWNvbm5lY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJkaXNjb25uZWN0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjb25uZWN0aW9uRGlzY29ubmVjdFwiLCB7fSk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVjb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwibWVzc2FnZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGluIHRoZW9yeSBjYW4gYmUgZW1wdHkganNvbkNvbnRlbnQgYW5kIG5vbi1lbXB0eSBlcnJvclxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtc2dBbnkgPSB2b2lkIDA7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhd0NvbnRlbnQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbXNnQW55ID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIm51bGwgcmF3Q29udGVudFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoKG5ldyBVaW50OEFycmF5KHJhd0NvbnRlbnQpWzBdKSA9PT0gMHg3Yikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBhc3N1bWUganNvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtc2dBbnkgPSBKU09OLnBhcnNlKF90aGlzLnNwLmRlY29kZVV0ZjgocmF3Q29udGVudCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzdW1lIHJhd1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IHJhd0NvbnRlbnQ6IHJhd0NvbnRlbnQgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55UmF3TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5PcGVuQ29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwib3BlbkNvbnRhaW5lck1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVNb3ZlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZU1vdmVtZW50TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZUFuaW1hdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZUFuaW1hdGlvbk1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVFcXVpcG1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVFcXVpcG1lbnRNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuQ2hhbmdlVmFsdWVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY2hhbmdlVmFsdWVzTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlNwZWxsQ2FzdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNwZWxsQ2FzdE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVBbmltVmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlQW5pbVZhcmlhYmxlc01lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVBcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlQXBwZWFyYW5jZU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5UZWxlcG9ydCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInRlbGVwb3J0TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZVByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlUHJvcGVydHlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuRGVhdGhTdGF0ZUNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuQ3JlYXRlQWN0b3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjcmVhdGVBY3Rvck1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5DdXN0b21QYWNrZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjdXN0b21QYWNrZXRNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuRGVzdHJveUFjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiZGVzdHJveUFjdG9yTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkhvc3RTdGFydCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImhvc3RTdGFydE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5Ib3N0U3RvcCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImhvc3RTdG9wTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlNldEludmVudG9yeSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNldEludmVudG9yeU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5TZXRSYWNlTWVudU9wZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZXRSYWNlTWVudU9wZW5NZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuU3BTbmlwcGV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic3BTbmlwcGV0TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlVwZGF0ZUdhbWVtb2RlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5UZWxlcG9ydDIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ0ZWxlcG9ydE1lc3NhZ2UyXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRocm93IG5ldyBOZXZlckVycm9yKG1zZ0FueSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVuaGFuZGxlZCBNc2dUeXBlIFwiICsgbXNnQW55LnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5jcmVhdGVDbGllbnRTYWZlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfYSA9IHRoaXMuc2VydmVyQWRkcmVzcywgaG9zdE5hbWUgPSBfYS5ob3N0TmFtZSwgcG9ydCA9IF9hLnBvcnQ7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJjcmVhdGVDbGllbnRTYWZlIFwiICsgaG9zdE5hbWUgKyBcIjpcIiArIHBvcnQpO1xyXG4gICAgICAgIGlmICh0aGlzLnNlcnZlckFkZHJlc3MuaG9zdE5hbWUgIT09IFwiXCIgJiYgdGhpcy5zZXJ2ZXJBZGRyZXNzLnBvcnQgIT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5tcENsaWVudFBsdWdpbi5jcmVhdGVDbGllbnQoaG9zdE5hbWUsIHBvcnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJjcmVhdGVDbGllbnRTYWZlIGZhaWxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZSwgXCJzZXJ2ZXJBZGRyZXNzXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuc3Auc3RvcmFnZVtcInNlcnZlckFkZHJlc3NcIl07XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcmVzO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQuaG9zdE5hbWUgPT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIHJlc3VsdC5wb3J0ID09PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4geyBob3N0TmFtZTogXCJcIiwgcG9ydDogMCB9O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAobmV3VmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wic2VydmVyQWRkcmVzc1wiXSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5pc1JlbGlhYmxlID0gZnVuY3Rpb24gKHJlbGlhYmlsaXR5KSB7XHJcbiAgICAgICAgc3dpdGNoIChyZWxpYWJpbGl0eSkge1xyXG4gICAgICAgICAgICBjYXNlIFwicmVsaWFibGVcIjpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICBjYXNlIFwidW5yZWxpYWJsZVwiOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE5ldmVyRXJyb3IocmVsaWFiaWxpdHkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gTmV0d29ya2luZ1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgTmV0d29ya2luZ1NlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQW1tbywgR2FtZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgZ2V0RXF1aXBtZW50IH0gZnJvbSBcIi4uLy4uL3N5bmMvZXF1aXBtZW50XCI7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBQbGF5ZXJCb3dTaG90U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhQbGF5ZXJCb3dTaG90U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFBsYXllckJvd1Nob3RTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzXzEgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzXzEuc3AgPSBzcDtcclxuICAgICAgICBfdGhpc18xLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzXzEuc2NvcmUgPSAwO1xyXG4gICAgICAgIF90aGlzXzEuaW52ZW50b3J5VW5ibG9ja01vbWVudCA9IDA7XHJcbiAgICAgICAgX3RoaXNfMS5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJxdWVyeUJsb2NrU2V0SW52ZW50b3J5RXZlbnRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzXzEub25RdWVyeUJsb2NrU2V0SW52ZW50b3J5RXZlbnQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzXzEuY29udHJvbGxlci5vbihcInBsYXllckJvd1Nob3RcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzXzEub25QbGF5ZXJCb3dTaG90KGUpOyB9KTtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfdGhpc18xO1xyXG4gICAgICAgIHZhciBldmVudFBhdHRlcm5zID0gW1wiYXR0YWNrUmVsZWFzZVwiLCBcImNyb3NzYm93QXR0YWNrU3RhcnRcIl07XHJcbiAgICAgICAgZXZlbnRQYXR0ZXJucy5mb3JFYWNoKGZ1bmN0aW9uIChldmVudFBhdHRlcm4pIHtcclxuICAgICAgICAgICAgX3RoaXNfMS5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWN0eC5hbmltYXRpb25TdWNjZWVkZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3R4LmFuaW1FdmVudE5hbWUgPT09IFwiY3Jvc3Nib3dBdHRhY2tTdGFydFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3JlID0gMTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY3R4LmFuaW1FdmVudE5hbWUgPT09IFwiYXR0YWNrUmVsZWFzZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5zY29yZSA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgX3RoaXMub25QbGF5ZXJDcm9zc2Jvd1Nob3QoKTsgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zY29yZSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3JlID0gMDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIGV2ZW50UGF0dGVybik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzXzE7XHJcbiAgICB9XHJcbiAgICBQbGF5ZXJCb3dTaG90U2VydmljZS5wcm90b3R5cGUub25RdWVyeUJsb2NrU2V0SW52ZW50b3J5RXZlbnQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmIChEYXRlLm5vdygpIDwgdGhpcy5pbnZlbnRvcnlVbmJsb2NrTW9tZW50KSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQmxvY2tlZCBpbnZlbnRvcnkgb3BlcmF0aW9uXCIpO1xyXG4gICAgICAgICAgICBlLmJsb2NrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIk5vdCBibG9ja2VkIGludmVudG9yeSBvcGVyYXRpb25cIik7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFBsYXllckJvd1Nob3RTZXJ2aWNlLnByb3RvdHlwZS5vblBsYXllckJvd1Nob3QgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuUGxheWVyQm93U2hvdCxcclxuICAgICAgICAgICAgICAgIHdlYXBvbklkOiBlLndlYXBvbi5nZXRGb3JtSUQoKSxcclxuICAgICAgICAgICAgICAgIGFtbW9JZDogZS5hbW1vLmdldEZvcm1JRCgpLFxyXG4gICAgICAgICAgICAgICAgcG93ZXI6IGUucG93ZXIsXHJcbiAgICAgICAgICAgICAgICBpc1N1bkdhemluZzogZS5pc1N1bkdhemluZyB8fCBmYWxzZVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBQbGF5ZXJCb3dTaG90U2VydmljZS5wcm90b3R5cGUub25QbGF5ZXJDcm9zc2Jvd1Nob3QgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGFjdG9yID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIGlmIChhY3RvciA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBjcm9zc2JvdyA9IGFjdG9yLmdldEVxdWlwcGVkV2VhcG9uKGZhbHNlKTtcclxuICAgICAgICBpZiAoY3Jvc3Nib3cgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJDb3VsZG4ndCBnZXQgZXF1aXBwZWQgd2VhcG9uXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB3ZWFwb25UeXBlID0gY3Jvc3Nib3cuZ2V0V2VhcG9uVHlwZSgpO1xyXG4gICAgICAgIGlmICh3ZWFwb25UeXBlICE9PSA5IC8qIFdlYXBvblR5cGUuQ3Jvc3Nib3cgKi8pIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJFeHBlY3RlZCB3ZWFwb24gdG8gYmUgY3Jvc3Nib3csIGJ1dCBnb3QgV2VhcG9uVHlwZVwiLCB3ZWFwb25UeXBlKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZXF1aXBwZWRBbW1vRW50cmllcyA9IGdldEVxdWlwbWVudChhY3RvciwgMCkuaW52LmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkgeyByZXR1cm4gZW50cnkud29ybiAmJiBBbW1vLmZyb20oR2FtZS5nZXRGb3JtRXgoZW50cnkuYmFzZUlkKSk7IH0pO1xyXG4gICAgICAgIGlmIChlcXVpcHBlZEFtbW9FbnRyaWVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkFtbW8gbm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlcXVpcHBlZEFtbW9FbnRyaWVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgdmFyIGVxdWlwcGVkQW1tb0lkcyA9IGVxdWlwcGVkQW1tb0VudHJpZXMubWFwKGZ1bmN0aW9uIChlbnRyeSkgeyByZXR1cm4gZW50cnkuYmFzZUlkOyB9KTtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJGb3VuZCBtb3JlIHRoYW4gMSBhbW1vczpcIiwgZXF1aXBwZWRBbW1vSWRzKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlBsYXllckJvd1Nob3QsXHJcbiAgICAgICAgICAgICAgICB3ZWFwb25JZDogY3Jvc3Nib3cuZ2V0Rm9ybUlEKCksXHJcbiAgICAgICAgICAgICAgICBhbW1vSWQ6IGVxdWlwcGVkQW1tb0VudHJpZXNbMF0uYmFzZUlkLFxyXG4gICAgICAgICAgICAgICAgaXNTdW5HYXppbmc6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgcG93ZXI6IDEuMFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBGaXhlcyByYWNlIGNvbmRpdGlvbiB3aGVuIHRoZSBzZXJ2ZXIgcmVtb3ZlcyBhbiBpdGVtIGZhc3RlciB0aGFuIGxvY2FsIGNyb3NzYm93IGRvZXMgdGhhdDogLTEgdG90YWxcclxuICAgICAgICAvLyBUaGVuIGNyb3NzYm93IHJlbW92ZXMgb25lIG1vcmUgaXRlbTogLTIgdG90YWxcclxuICAgICAgICAvLyBUaGUgaXRlbSBpcyBiZWluZyBhZGRlZCBiYWNrOiAtMSB0b3RhbCAod2hpY2ggaXMgY29ycmVjdCBidXQgbG9va3MgdWdseSBpbiBwcm9jZXNzKVxyXG4gICAgICAgIHRoaXMuaW52ZW50b3J5VW5ibG9ja01vbWVudCA9IERhdGUubm93KCkgKyA1ICogMTAwMDtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlbnQgY3Jvc3Nib3cgc2hvdFwiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gUGxheWVyQm93U2hvdFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgUGxheWVyQm93U2hvdFNlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG52YXIgX19nZW5lcmF0b3IgPSAodGhpcyAmJiB0aGlzLl9fZ2VuZXJhdG9yKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgYm9keSkge1xyXG4gICAgdmFyIF8gPSB7IGxhYmVsOiAwLCBzZW50OiBmdW5jdGlvbigpIHsgaWYgKHRbMF0gJiAxKSB0aHJvdyB0WzFdOyByZXR1cm4gdFsxXTsgfSwgdHJ5czogW10sIG9wczogW10gfSwgZiwgeSwgdCwgZztcclxuICAgIHJldHVybiBnID0geyBuZXh0OiB2ZXJiKDApLCBcInRocm93XCI6IHZlcmIoMSksIFwicmV0dXJuXCI6IHZlcmIoMikgfSwgdHlwZW9mIFN5bWJvbCA9PT0gXCJmdW5jdGlvblwiICYmIChnW1N5bWJvbC5pdGVyYXRvcl0gPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0pLCBnO1xyXG4gICAgZnVuY3Rpb24gdmVyYihuKSB7IHJldHVybiBmdW5jdGlvbiAodikgeyByZXR1cm4gc3RlcChbbiwgdl0pOyB9OyB9XHJcbiAgICBmdW5jdGlvbiBzdGVwKG9wKSB7XHJcbiAgICAgICAgaWYgKGYpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBleGVjdXRpbmcuXCIpO1xyXG4gICAgICAgIHdoaWxlIChnICYmIChnID0gMCwgb3BbMF0gJiYgKF8gPSAwKSksIF8pIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChmID0gMSwgeSAmJiAodCA9IG9wWzBdICYgMiA/IHlbXCJyZXR1cm5cIl0gOiBvcFswXSA/IHlbXCJ0aHJvd1wiXSB8fCAoKHQgPSB5W1wicmV0dXJuXCJdKSAmJiB0LmNhbGwoeSksIDApIDogeS5uZXh0KSAmJiAhKHQgPSB0LmNhbGwoeSwgb3BbMV0pKS5kb25lKSByZXR1cm4gdDtcclxuICAgICAgICAgICAgaWYgKHkgPSAwLCB0KSBvcCA9IFtvcFswXSAmIDIsIHQudmFsdWVdO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKG9wWzBdKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDA6IGNhc2UgMTogdCA9IG9wOyBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDogXy5sYWJlbCsrOyByZXR1cm4geyB2YWx1ZTogb3BbMV0sIGRvbmU6IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICBjYXNlIDU6IF8ubGFiZWwrKzsgeSA9IG9wWzFdOyBvcCA9IFswXTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDc6IG9wID0gXy5vcHMucG9wKCk7IF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKHQgPSBfLnRyeXMsIHQgPSB0Lmxlbmd0aCA+IDAgJiYgdFt0Lmxlbmd0aCAtIDFdKSAmJiAob3BbMF0gPT09IDYgfHwgb3BbMF0gPT09IDIpKSB7IF8gPSAwOyBjb250aW51ZTsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gMyAmJiAoIXQgfHwgKG9wWzFdID4gdFswXSAmJiBvcFsxXSA8IHRbM10pKSkgeyBfLmxhYmVsID0gb3BbMV07IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSA2ICYmIF8ubGFiZWwgPCB0WzFdKSB7IF8ubGFiZWwgPSB0WzFdOyB0ID0gb3A7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHQgJiYgXy5sYWJlbCA8IHRbMl0pIHsgXy5sYWJlbCA9IHRbMl07IF8ub3BzLnB1c2gob3ApOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0WzJdKSBfLm9wcy5wb3AoKTtcclxuICAgICAgICAgICAgICAgICAgICBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG9wID0gYm9keS5jYWxsKHRoaXNBcmcsIF8pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgb3AgPSBbNiwgZV07IHkgPSAwOyB9IGZpbmFsbHkgeyBmID0gdCA9IDA7IH1cclxuICAgICAgICBpZiAob3BbMF0gJiA1KSB0aHJvdyBvcFsxXTsgcmV0dXJuIHsgdmFsdWU6IG9wWzBdID8gb3BbMV0gOiB2b2lkIDAsIGRvbmU6IHRydWUgfTtcclxuICAgIH1cclxufTtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFNlc3Npb24gfSBmcm9tICdpbnNwZWN0b3InO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcclxudmFyIFByb2ZpbGluZ1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoUHJvZmlsaW5nU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFByb2ZpbGluZ1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgdmFyIHNldHRpbmdzID0gc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdO1xyXG4gICAgICAgIGlmICghc2V0dGluZ3NbXCJlbmFibGVQcm9maWxpbmdcIl0pIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUHJvZmlsaW5nU2VydmljZTogZGlzYWJsZWRcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBfdGhpcztcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHByb2ZpbGluZ0R1cmF0aW9uTXMgPSBfdGhpcy5nZXRJbnRlZ2VyKHNldHRpbmdzW1wicHJvZmlsaW5nRHVyYXRpb25Nc1wiXSkgfHwgMTAwMDA7XHJcbiAgICAgICAgdmFyIHNlc3Npb24gPSBuZXcgU2Vzc2lvbigpO1xyXG4gICAgICAgIHNlc3Npb24uY29ubmVjdCgpO1xyXG4gICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlByb2ZpbGluZ1NlcnZpY2U6IHN0YXJ0XCIpO1xyXG4gICAgICAgIF90aGlzLnN0YXJ0UHJvZmlsaW5nKHNlc3Npb24sIHByb2ZpbGluZ0R1cmF0aW9uTXMpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFByb2ZpbGluZ1NlcnZpY2UucHJvdG90eXBlLnN0YXJ0UHJvZmlsaW5nID0gZnVuY3Rpb24gKHNlc3Npb24sIHByb2ZpbGluZ0R1cmF0aW9uTXMpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBwcm9maWxlLCBmaWxlTmFtZVN1ZmZpeDtcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDogcmV0dXJuIFs0IC8qeWllbGQqLywgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5wb3N0KCdQcm9maWxlci5lbmFibGUnLCBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5wb3N0KCdQcm9maWxlci5zdGFydCcsIGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIHByb2ZpbGluZ0R1cmF0aW9uTXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlByb2ZpbGluZ1NlcnZpY2U6IHN0b3BcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uLnBvc3QoJ1Byb2ZpbGVyLnN0b3AnLCBmdW5jdGlvbiAoZXJyLCByZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGUgPSAoX2Euc2VudCgpKS5wcm9maWxlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZVN1ZmZpeCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoKS5yZXBsYWNlKFwiLjBcIiwgXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoXCIuL3Byb2ZpbGVcIi5jb25jYXQoZmlsZU5hbWVTdWZmaXgsIFwiLmNwdXByb2ZpbGVcIiksIEpTT04uc3RyaW5naWZ5KHByb2ZpbGUpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBQcm9maWxpbmdTZXJ2aWNlLnByb3RvdHlwZS5nZXRJbnRlZ2VyID0gZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gUHJvZmlsaW5nU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBQcm9maWxpbmdTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBSYWdkb2xsU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhSYWdkb2xsU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFJhZ2RvbGxTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIC8vIFRPRE86IHRoaW5rIGFib3V0IHRyYWNraW5nIHJhZ2RvbGwgc3RhdGUgb2YgcGxheWVyXHJcbiAgICAgICAgX3RoaXMuc2FmZVJlbW92ZVJhZ2RvbGxGcm9tV29ybGQgPSBmdW5jdGlvbiAoYWN0b3IsIGFmdGVyUmVtb3ZlQ2FsbGJhY2spIHtcclxuICAgICAgICAgICAgX3RoaXMuc2V0TG9jYWxEYW1hZ2VNdWx0KDApO1xyXG4gICAgICAgICAgICBhY3Rvci5mb3JjZVJlbW92ZVJhZ2RvbGxGcm9tV29ybGQoKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2V0TG9jYWxEYW1hZ2VNdWx0KF90aGlzLmRlZmF1bHRMb2NhbERhbWFnZU11bHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFmdGVyUmVtb3ZlQ2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmRlZmF1bHRMb2NhbERhbWFnZU11bHQgPSAxO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFJhZ2RvbGxTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc2V0TG9jYWxEYW1hZ2VNdWx0KHRoaXMuZGVmYXVsdExvY2FsRGFtYWdlTXVsdCk7XHJcbiAgICB9O1xyXG4gICAgUmFnZG9sbFNlcnZpY2UucHJvdG90eXBlLnNldExvY2FsRGFtYWdlTXVsdCA9IGZ1bmN0aW9uIChkYW1hZ2VNdWx0KSB7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmRGlmZk11bHRIUFRvUENFXCIsIGRhbWFnZU11bHQpO1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZkRpZmZNdWx0SFBUb1BDSFwiLCBkYW1hZ2VNdWx0KTtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZEaWZmTXVsdEhQVG9QQ0xcIiwgZGFtYWdlTXVsdCk7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmRGlmZk11bHRIUFRvUENOXCIsIGRhbWFnZU11bHQpO1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZkRpZmZNdWx0SFBUb1BDVkVcIiwgZGFtYWdlTXVsdCk7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmRGlmZk11bHRIUFRvUENWSFwiLCBkYW1hZ2VNdWx0KTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gUmFnZG9sbFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgUmFnZG9sbFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxudmFyIF9fZ2VuZXJhdG9yID0gKHRoaXMgJiYgdGhpcy5fX2dlbmVyYXRvcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIGJvZHkpIHtcclxuICAgIHZhciBfID0geyBsYWJlbDogMCwgc2VudDogZnVuY3Rpb24oKSB7IGlmICh0WzBdICYgMSkgdGhyb3cgdFsxXTsgcmV0dXJuIHRbMV07IH0sIHRyeXM6IFtdLCBvcHM6IFtdIH0sIGYsIHksIHQsIGc7XHJcbiAgICByZXR1cm4gZyA9IHsgbmV4dDogdmVyYigwKSwgXCJ0aHJvd1wiOiB2ZXJiKDEpLCBcInJldHVyblwiOiB2ZXJiKDIpIH0sIHR5cGVvZiBTeW1ib2wgPT09IFwiZnVuY3Rpb25cIiAmJiAoZ1tTeW1ib2wuaXRlcmF0b3JdID0gZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KSwgZztcclxuICAgIGZ1bmN0aW9uIHZlcmIobikgeyByZXR1cm4gZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHN0ZXAoW24sIHZdKTsgfTsgfVxyXG4gICAgZnVuY3Rpb24gc3RlcChvcCkge1xyXG4gICAgICAgIGlmIChmKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiR2VuZXJhdG9yIGlzIGFscmVhZHkgZXhlY3V0aW5nLlwiKTtcclxuICAgICAgICB3aGlsZSAoZyAmJiAoZyA9IDAsIG9wWzBdICYmIChfID0gMCkpLCBfKSB0cnkge1xyXG4gICAgICAgICAgICBpZiAoZiA9IDEsIHkgJiYgKHQgPSBvcFswXSAmIDIgPyB5W1wicmV0dXJuXCJdIDogb3BbMF0gPyB5W1widGhyb3dcIl0gfHwgKCh0ID0geVtcInJldHVyblwiXSkgJiYgdC5jYWxsKHkpLCAwKSA6IHkubmV4dCkgJiYgISh0ID0gdC5jYWxsKHksIG9wWzFdKSkuZG9uZSkgcmV0dXJuIHQ7XHJcbiAgICAgICAgICAgIGlmICh5ID0gMCwgdCkgb3AgPSBbb3BbMF0gJiAyLCB0LnZhbHVlXTtcclxuICAgICAgICAgICAgc3dpdGNoIChvcFswXSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAwOiBjYXNlIDE6IHQgPSBvcDsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDQ6IF8ubGFiZWwrKzsgcmV0dXJuIHsgdmFsdWU6IG9wWzFdLCBkb25lOiBmYWxzZSB9O1xyXG4gICAgICAgICAgICAgICAgY2FzZSA1OiBfLmxhYmVsKys7IHkgPSBvcFsxXTsgb3AgPSBbMF07IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA3OiBvcCA9IF8ub3BzLnBvcCgpOyBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISh0ID0gXy50cnlzLCB0ID0gdC5sZW5ndGggPiAwICYmIHRbdC5sZW5ndGggLSAxXSkgJiYgKG9wWzBdID09PSA2IHx8IG9wWzBdID09PSAyKSkgeyBfID0gMDsgY29udGludWU7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDMgJiYgKCF0IHx8IChvcFsxXSA+IHRbMF0gJiYgb3BbMV0gPCB0WzNdKSkpIHsgXy5sYWJlbCA9IG9wWzFdOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gNiAmJiBfLmxhYmVsIDwgdFsxXSkgeyBfLmxhYmVsID0gdFsxXTsgdCA9IG9wOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0ICYmIF8ubGFiZWwgPCB0WzJdKSB7IF8ubGFiZWwgPSB0WzJdOyBfLm9wcy5wdXNoKG9wKTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodFsyXSkgXy5vcHMucG9wKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcCA9IGJvZHkuY2FsbCh0aGlzQXJnLCBfKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7IG9wID0gWzYsIGVdOyB5ID0gMDsgfSBmaW5hbGx5IHsgZiA9IHQgPSAwOyB9XHJcbiAgICAgICAgaWYgKG9wWzBdICYgNSkgdGhyb3cgb3BbMV07IHJldHVybiB7IHZhbHVlOiBvcFswXSA/IG9wWzFdIDogdm9pZCAwLCBkb25lOiB0cnVlIH07XHJcbiAgICB9XHJcbn07XHJcbi8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbmltcG9ydCB7IEFjdG9yLCBpbnRlcnJ1cHRDYXN0LCBjYXN0U3BlbGxJbW1lZGlhdGUsIGFwcGx5QW5pbWF0aW9uVmFyaWFibGVzVG9BY3RvciB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuaW1wb3J0IHsgQXJtb3IsIENlbGwsIEdhbWUsIE9iamVjdFJlZmVyZW5jZSwgVEVTTW9kUGxhdGZvcm0sIFVpLCBVdGlsaXR5LCBXb3JsZFNwYWNlLCBvbiwgLy8gVE9ETzogdXNlIHRoaXMuY29udHJvbGxlci5vbiBpbnN0ZWFkXHJcbm9uY2UsIC8vIFRPRE86IHVzZSB0aGlzLmNvbnRyb2xsZXIub25jZSBpbnN0ZWFkXHJcbnN0b3JhZ2UsIC8vIFRPRE86IHVzZSB0aGlzLnNwLnN0b3JhZ2UgaW5zdGVhZFxyXG4gfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmltcG9ydCAqIGFzIG1lc3NhZ2VzIGZyb20gJy4uLy4uL21lc3NhZ2VzJztcclxuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uICovXHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSAnLi4vLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeCc7XHJcbmltcG9ydCB7IElkTWFuYWdlciB9IGZyb20gJy4uLy4uL2xpYi9pZE1hbmFnZXInO1xyXG5pbXBvcnQgeyBuYW1lb2YgfSBmcm9tICcuLi8uLi9saWIvbmFtZW9mJztcclxuaW1wb3J0IHsgc2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UgfSBmcm9tICcuLi8uLi9zeW5jL2FjdG9ydmFsdWVzJztcclxuaW1wb3J0IHsgYXBwbHlBcHBlYXJhbmNlVG9QbGF5ZXIgfSBmcm9tICcuLi8uLi9zeW5jL2FwcGVhcmFuY2UnO1xyXG5pbXBvcnQgeyBhcHBseUVxdWlwbWVudCwgaXNCYWRNZW51U2hvd24gfSBmcm9tICcuLi8uLi9zeW5jL2VxdWlwbWVudCc7XHJcbmltcG9ydCB7IGFwcGx5SW52ZW50b3J5IH0gZnJvbSAnLi4vLi4vc3luYy9pbnZlbnRvcnknO1xyXG5pbXBvcnQgeyBsZWFyblNwZWxscywgcmVtb3ZlQWxsU3BlbGxzIH0gZnJvbSAnLi4vLi4vc3luYy9zcGVsbCc7XHJcbmltcG9ydCB7IE1vZGVsQXBwbHlVdGlscyB9IGZyb20gJy4uLy4uL3ZpZXcvbW9kZWxBcHBseVV0aWxzJztcclxuaW1wb3J0IHsgTG9hZEdhbWVTZXJ2aWNlIH0gZnJvbSAnLi9sb2FkR2FtZVNlcnZpY2UnO1xyXG5pbXBvcnQgeyBSYWdkb2xsU2VydmljZSB9IGZyb20gJy4vcmFnZG9sbFNlcnZpY2UnO1xyXG5pbXBvcnQgeyBSZXNwYXduTmVlZGVkRXJyb3IgfSBmcm9tICcuLi8uLi9saWIvZXJyb3JzJztcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tICcuL2NsaWVudExpc3RlbmVyJztcclxuLy8gVE9ETzogcmVmYWN0b3Igd29ybGRWaWV3TWlzYyBpbnRvIHNlcnZpY2VcclxuaW1wb3J0IHsgZ2V0T2JqZWN0UmVmZXJlbmNlLCBnZXRWaWV3RnJvbVN0b3JhZ2UsIHJlbW90ZUlkVG9Mb2NhbElkLCB9IGZyb20gJy4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzYyc7XHJcbmltcG9ydCB7IFRpbWVTZXJ2aWNlIH0gZnJvbSAnLi90aW1lU2VydmljZSc7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xyXG5pbXBvcnQgeyBWb2ljZUNoYXRTZXJ2aWNlIH0gZnJvbSAnLi92b2ljZUNoYXRTZXJ2aWNlJztcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gJy4uLy4uL21lc3NhZ2VzJztcclxuZXhwb3J0IHZhciBnZXRQY0ludmVudG9yeSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciByZXMgPSBzdG9yYWdlWydwY0ludiddO1xyXG4gICAgaWYgKHR5cGVvZiByZXMgPT09ICdvYmplY3QnICYmIHJlc1snZW50cmllcyddKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbn07XHJcbnZhciBzZXRQY0ludmVudG9yeSA9IGZ1bmN0aW9uIChpbnYpIHtcclxuICAgIHN0b3JhZ2VbJ3BjSW52J10gPSBpbnY7XHJcbn07XHJcbnZhciBwY0ludkxhc3RBcHBseSA9IDA7XHJcbm9uKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoaXNCYWRNZW51U2hvd24oKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChEYXRlLm5vdygpIC0gcGNJbnZMYXN0QXBwbHkgPiA1MDAwKSB7XHJcbiAgICAgICAgcGNJbnZMYXN0QXBwbHkgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHZhciBwY0ludiA9IGdldFBjSW52ZW50b3J5KCk7XHJcbiAgICAgICAgaWYgKHBjSW52KSB7XHJcbiAgICAgICAgICAgIGFwcGx5SW52ZW50b3J5KEdhbWUuZ2V0UGxheWVyKCksIHBjSW52LCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KTtcclxudmFyIHVuZXF1aXBJcm9uSGVsbWV0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGlyb25IZWxtZW50ID0gQXJtb3IuZnJvbShHYW1lLmdldEZvcm1FeCgweDAwMDEyZTRkKSk7XHJcbiAgICB2YXIgcGwgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgaWYgKHBsKSB7XHJcbiAgICAgICAgcGwudW5lcXVpcEl0ZW0oaXJvbkhlbG1lbnQsIGZhbHNlLCB0cnVlKTtcclxuICAgIH1cclxufTtcclxudmFyIFJlbW90ZVNlcnZlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhSZW1vdGVTZXJ2ZXIsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBSZW1vdGVTZXJ2ZXIoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMubnVtU2V0SW52ZW50b3J5ID0gMDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJob3N0U3RhcnRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkhvc3RTdGFydE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImhvc3RTdG9wTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Ib3N0U3RvcE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNldEludmVudG9yeU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2V0SW52ZW50b3J5TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwib3BlbkNvbnRhaW5lck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uT3BlbkNvbnRhaW5lck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZU1vdmVtZW50TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVNb3ZlbWVudE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZUFuaW1hdGlvbk1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlQW5pbWF0aW9uTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlRXF1aXBtZW50TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVFcXVpcG1lbnRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjaGFuZ2VWYWx1ZXNNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNoYW5nZVZhbHVlc01lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZUFwcGVhcmFuY2VNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZUFwcGVhcmFuY2VNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ0ZWxlcG9ydE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVGVsZXBvcnRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ0ZWxlcG9ydE1lc3NhZ2UyXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblRlbGVwb3J0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNyZWF0ZUFjdG9yTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiZGVzdHJveUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25EZXN0cm95QWN0b3JNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZXRSYWNlTWVudU9wZW5NZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNldFJhY2VNZW51T3Blbk1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZVByb3BlcnR5TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVQcm9wZXJ0eU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjb25uZWN0aW9uQWNjZXB0ZWRcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuaGFuZGxlQ29ubmVjdGlvbkFjY2VwdGVkKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNwZWxsQ2FzdE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU3BlbGxDYXN0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlQW5pbVZhcmlhYmxlc01lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlQW5pbVZhcmlhYmxlc01lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInZvaWNlQ2hhdE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVm9pY2VDaGF0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidXBkYXRlVm9pY2VDaGF0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVWb2ljZUNoYXRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uSG9zdFN0YXJ0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciB0YXJnZXQgPSBtc2cudGFyZ2V0O1xyXG4gICAgICAgIHZhciBob3N0ZWQgPSBzdG9yYWdlWydob3N0ZWQnXTtcclxuICAgICAgICBpZiAodHlwZW9mIGhvc3RlZCAhPT0gdHlwZW9mIFtdKSB7XHJcbiAgICAgICAgICAgIC8vIGlmIHlvdSB0cnkgdG8gc3dpdGNoIHRvIFNldCBwbGVhc2UgY2hlY2tvdXQgLmNvbmNhdCB1c2FnZS5cclxuICAgICAgICAgICAgLy8gY29uY2F0IGNvbXBpbGVzIGJ1dCBkb2Vzbid0IHdvcmsgYXMgZXhwZWN0ZWRcclxuICAgICAgICAgICAgaG9zdGVkID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgIHN0b3JhZ2VbJ2hvc3RlZCddID0gaG9zdGVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWhvc3RlZC5pbmNsdWRlcyh0YXJnZXQpKSB7XHJcbiAgICAgICAgICAgIGhvc3RlZC5wdXNoKHRhcmdldCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25Ib3N0U3RvcE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgdGFyZ2V0ID0gbXNnLnRhcmdldDtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCAnaG9zdFN0b3AgJyArIHRhcmdldC50b1N0cmluZygxNikpO1xyXG4gICAgICAgIHZhciBob3N0ZWQgPSBzdG9yYWdlWydob3N0ZWQnXTtcclxuICAgICAgICBpZiAodHlwZW9mIGhvc3RlZCA9PT0gdHlwZW9mIFtdKSB7XHJcbiAgICAgICAgICAgIHN0b3JhZ2VbJ2hvc3RlZCddID0gaG9zdGVkLmZpbHRlcihmdW5jdGlvbiAoeCkgeyByZXR1cm4geCAhPT0gdGFyZ2V0OyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblNldEludmVudG9yeU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMubnVtU2V0SW52ZW50b3J5Kys7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBzZXRQY0ludmVudG9yeShtc2cuaW52ZW50b3J5KTtcclxuICAgICAgICAgICAgdmFyIGJsb2NrZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoJ3F1ZXJ5QmxvY2tTZXRJbnZlbnRvcnlFdmVudCcsIHtcclxuICAgICAgICAgICAgICAgIGJsb2NrOiBmdW5jdGlvbiAoKSB7IHJldHVybiBibG9ja2VkID0gdHJ1ZTsgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKCFibG9ja2VkKSB7XHJcbiAgICAgICAgICAgICAgICBwY0ludkxhc3RBcHBseSA9IDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uT3BlbkNvbnRhaW5lck1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9fYXdhaXRlcihfdGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlbW90ZUlkLCBsb2NhbElkLCByZWZyLCBiYXNlT2JqZWN0LCBiYXNlVHlwZSwgZnVuY3Rpb25DaGVja2VyLCBmYWN0TmFtZSwgZGVsYXlTZWNvbmRzO1xyXG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gWzQgLyp5aWVsZCovLCBVdGlsaXR5LndhaXQoMC4xKV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7IC8vIEdpdmUgYSBjaGFuY2UgdG8gdXBkYXRlIGludmVudG9yeVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVJZCA9IGV2ZW50Lm1lc3NhZ2UudGFyZ2V0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbElkID0gcmVtb3RlSWRUb0xvY2FsSWQocmVtb3RlSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgobG9jYWxJZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVmciA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgJ29uT3BlbkNvbnRhaW5lck1lc3NhZ2UgLSByZWZyIG5vdCBmb3VuZCcsICdyZW1vdGVJZCcsIHJlbW90ZUlkLnRvU3RyaW5nKDE2KSwgJ2xvY2FsSWQnLCBsb2NhbElkLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5hY3RpdmF0ZShHYW1lLmdldFBsYXllcigpLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmFzZU9iamVjdCA9IHJlZnIuZ2V0QmFzZU9iamVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBiYXNlVHlwZSA9IGJhc2VPYmplY3QgPT09IG51bGwgfHwgYmFzZU9iamVjdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogYmFzZU9iamVjdC5nZXRUeXBlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQ2hlY2tlciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZhY3ROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXlTZWNvbmRzID0gLTEuMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2VUeXBlID09PSAyOCAvKiBGb3JtVHlwZS5Db250YWluZXIgKi8pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQ2hlY2tlciA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIFVpLmlzTWVudU9wZW4oXCJDb250YWluZXJNZW51XCIpOyB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFjdE5hbWUgPSBcIidDb250YWluZXJNZW51IG9wZW4nXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxheVNlY29uZHMgPSAwLjA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmFzZVR5cGUgPT09IDQwIC8qIEZvcm1UeXBlLkZ1cm5pdHVyZSAqLykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb25DaGVja2VyID0gZnVuY3Rpb24gKCkgeyB2YXIgX2E7IHJldHVybiAhISgoX2EgPSBHYW1lLmdldFBsYXllcigpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0RnVybml0dXJlUmVmZXJlbmNlKCkpOyB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFjdE5hbWUgPSBcIidnZXRGdXJuaXR1cmVSZWZlcmVuY2Ugbm90IG51bGwnXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxheVNlY29uZHMgPSAxLjA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZ1bmN0aW9uQ2hlY2tlciA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbk9wZW5Db250YWluZXJNZXNhZ2UgLSBub3QgYSBjb250YWluZXIgb3IgZnVybml0dXJlXCIsIGJhc2VUeXBlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJbiBTa3lNUCBjb250YWluZXJzIGhhdmUgMi1uZCwgY2xvc2luZyBhY3RpdmF0aW9uIHVuZGVyIHRoZSBob29kLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGRpZmZlcnMgZnJvbSBTa3lyaW0ncyBiZWhhdmlvciwgd2hlcmUgaXQncyBqdXN0IG9uZSBhY3RpdmF0aW9uLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgeyByZXR1cm4gX19hd2FpdGVyKF90aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbk9wZW5Db250YWluZXJNZXNhZ2UgLSB3YWl0aW5nIGZvclwiLCBmYWN0TmFtZSwgXCJ0byBiZSB0cnVlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2EubGFiZWwgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISFmdW5jdGlvbkNoZWNrZXIoKSkgcmV0dXJuIFszIC8qYnJlYWsqLywgM107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBVdGlsaXR5LndhaXQoMC4xKV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uT3BlbkNvbnRhaW5lck1lc2FnZSAtIHdhaXRpbmcgZm9yXCIsIGZhY3ROYW1lLCBcInRvIGJlIGZhbHNlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2EubGFiZWwgPSA0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZ1bmN0aW9uQ2hlY2tlcigpKSByZXR1cm4gWzMgLypicmVhayovLCA2XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIFV0aWxpdHkud2FpdCgwLjEpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA1OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgNF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25PcGVuQ29udGFpbmVyTWVzYWdlIC0gbWVudSBjbG9zZWRcIiwgZmFjdE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0OiBtZXNzYWdlcy5Nc2dUeXBlLkFjdGl2YXRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzdGVyOiAweDE0LCB0YXJnZXQ6IGV2ZW50Lm1lc3NhZ2UudGFyZ2V0LCBpc1NlY29uZEFjdGl2YXRpb246IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbk9wZW5Db250YWluZXJNZXNhZ2UgLSB3YWl0aW5nXCIsIGRlbGF5U2Vjb25kcywgXCJzZWNvbmRzIGJlZm9yZSBzZW5kaW5nIEFjdGl2YXRlTWVzc2FnZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxpdHkud2FpdE1lbnVNb2RlKGRlbGF5U2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJvbk9wZW5Db250YWluZXJNZXNhZ2UgLSBzZW50IEFjdGl2YXRlTWVzc2FnZVwiLCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTsgfSkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTsgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblRlbGVwb3J0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgaWQgPSAoXCJpZHhcIiBpbiBtc2cgJiYgdHlwZW9mIG1zZy5pZHggPT09IFwibnVtYmVyXCIpID8gX3RoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCkgOiBfdGhpcy5nZXRNeUFjdG9ySW5kZXgoKTtcclxuICAgICAgICAgICAgdmFyIHJlZnIgPSBpZCA9PT0gX3RoaXMuZ2V0TXlBY3RvckluZGV4KCkgPyBHYW1lLmdldFBsYXllcigpIDogZ2V0T2JqZWN0UmVmZXJlbmNlKGlkKTtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiVGVsZXBvcnRpbmcgaWRcIiwgaWQsIFwicmVmcklkXCIsIHJlZnIgPT09IG51bGwgfHwgcmVmciA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmci5nZXRGb3JtSUQoKS50b1N0cmluZygxNiksIFwiLi4uXCIsIG1zZy5wb3MsICdjZWxsL3dvcmxkIGlzJywgbXNnLndvcmxkT3JDZWxsLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgIHZhciByYWdkb2xsU2VydmljZSA9IF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmFnZG9sbFNlcnZpY2UpO1xyXG4gICAgICAgICAgICB2YXIgcmVmcklkID0gcmVmciA9PT0gbnVsbCB8fCByZWZyID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZWZyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICB2YXIgcmVtb3ZlUmFnZG9sbENhbGxiYWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgVEVTTW9kUGxhdGZvcm0ubW92ZVJlZnJUb1Bvc2l0aW9uKE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCB8fCAwKSksIENlbGwuZnJvbShHYW1lLmdldEZvcm1FeChtc2cud29ybGRPckNlbGwpKSwgV29ybGRTcGFjZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KG1zZy53b3JsZE9yQ2VsbCkpLCBtc2cucG9zWzBdLCBtc2cucG9zWzFdLCBtc2cucG9zWzJdLCBtc2cucm90WzBdLCBtc2cucm90WzFdLCBtc2cucm90WzJdKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgaWYgKGFjdG9yIC8qJiYgYWN0b3IuZ2V0Rm9ybUlEKCkgPT09IDB4MTQqLykge1xyXG4gICAgICAgICAgICAgICAgcmFnZG9sbFNlcnZpY2Uuc2FmZVJlbW92ZVJhZ2RvbGxGcm9tV29ybGQoYWN0b3IsIHJlbW92ZVJhZ2RvbGxDYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVSYWdkb2xsQ2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25DcmVhdGVBY3Rvck1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBpZiAodGhpcy5za2lwRm9ybVZpZXdDcmVhdGlvbihtc2cpKSB7XHJcbiAgICAgICAgICAgIHZhciByZWZySWRfMSA9IG1zZy5yZWZySWQ7XHJcbiAgICAgICAgICAgIHRoaXMub25jZUxvYWQocmVmcklkXzEsIGZ1bmN0aW9uIChyZWZyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmcikge1xyXG4gICAgICAgICAgICAgICAgICAgIE9iamVjdFJlZmVyZW5jZUV4LmRlYWxXaXRoUmVmKHJlZnIsIHJlZnIuZ2V0QmFzZU9iamVjdCgpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobXNnLnByb3BzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtc2cucHJvcHMuaW52ZW50b3J5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbEludmVudG9yeShyZWZyLCBtc2cucHJvcHMuaW52ZW50b3J5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzT3BlbihyZWZyLCAhIW1zZy5wcm9wc1snaXNPcGVuJ10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzSGFydmVzdGVkKHJlZnIsICEhbXNnLnByb3BzWydpc0hhcnZlc3RlZCddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxOb2RlU2NhbGUocmVmciwgbXNnLnByb3BzLnNldE5vZGVTY2FsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsTm9kZVRleHR1cmVTZXQocmVmciwgbXNnLnByb3BzLnNldE5vZGVUZXh0dXJlU2V0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0Rpc2FibGVkKHJlZnIsICEhbXNnLnByb3BzWydkaXNhYmxlZCddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogbW92ZSB0byBhIHNlcGFyYXRlIG1vZHVsZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYW5pbWF0aW9uXzEgPSBtc2cucHJvcHMubGFzdEFuaW1hdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhbmltYXRpb25fMSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZnJpZF8xID0gcmVmci5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7IHJldHVybiBfX2F3YWl0ZXIoX3RoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlfMSwgcmVzMjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9iLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaV8xID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYi5sYWJlbCA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoaV8xIDwgNSkpIHJldHVybiBbMyAvKmJyZWFrKi8sIDRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlczIgPSAoX2EgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZyaWRfMSkpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucGxheUFuaW1hdGlvbihhbmltYXRpb25fMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlczIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgNF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIFV0aWxpdHkud2FpdCgyKV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Iuc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9iLmxhYmVsID0gMztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpXzErKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDogcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsgfSkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBtc2cucHJvcHMuZGlzcGxheU5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGtlZXAgaW4gc3luYyB3aXRoIHNwU25pcHBldFNlcnZpY2UudHNcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkaXNwbGF5TmFtZSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VWYWx1ZSA9IChfYSA9IHJlZnIuZ2V0QmFzZU9iamVjdCgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0TmFtZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2VWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWUgPSBkaXNwbGF5TmFtZS5yZXBsYWNlKC8lb3JpZ2luYWxfbmFtZSUvZywgcmVwbGFjZVZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIkNvdWxkbid0IGdldCBhIHJlcGxhY2VWYWx1ZSBmb3IgU2V0RGlzcGxheU5hbWUsIHJlZnIuZ2V0Rm9ybUlEKCkgd2FzXCIsIHJlZnIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuc2V0RGlzcGxheU5hbWUoZGlzcGxheU5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiY2FsbGluZyBzZXREaXNwbGF5TmFtZVwiLCBkaXNwbGF5TmFtZSwgXCJmb3JcIiwgcmVmci5nZXRGb3JtSUQoKS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsICdGYWlsZWQgdG8gYXBwbHkgbW9kZWwgdG8nLCByZWZySWRfMS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNyZWF0ZSBhY3RvclwiKTtcclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuYWxsb2NhdGVJZEZvcihtc2cuaWR4KTtcclxuICAgICAgICBpZiAodGhpcy53b3JsZE1vZGVsLmZvcm1zLmxlbmd0aCA8PSBpKSB7XHJcbiAgICAgICAgICAgIHRoaXMud29ybGRNb2RlbC5mb3Jtcy5sZW5ndGggPSBpICsgMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG1vdmVtZW50ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIC8vIFRPRE86IGJldHRlciBjaGVjayBpZiBpdCBpcyBhbiBucGMgKG5vdCBhbiBvYmplY3QgcmVmZXJlbmNlKVxyXG4gICAgICAgIGlmIChtc2cucmVmcklkICE9PSB1bmRlZmluZWQgJiYgbXNnLnJlZnJJZCA+PSAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgIG1vdmVtZW50ID0ge1xyXG4gICAgICAgICAgICAgICAgcG9zOiBtc2cudHJhbnNmb3JtLnBvcyxcclxuICAgICAgICAgICAgICAgIHJvdDogbXNnLnRyYW5zZm9ybS5yb3QsXHJcbiAgICAgICAgICAgICAgICB3b3JsZE9yQ2VsbDogbXNnLnRyYW5zZm9ybS53b3JsZE9yQ2VsbCxcclxuICAgICAgICAgICAgICAgIHJ1bk1vZGU6ICdTdGFuZGluZycsXHJcbiAgICAgICAgICAgICAgICBkaXJlY3Rpb246IDAsXHJcbiAgICAgICAgICAgICAgICBpc0luSnVtcFN0YXRlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGlzU25lYWtpbmc6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaXNCbG9ja2luZzogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc1dlYXBEcmF3bjogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc0RlYWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaGVhbHRoUGVyY2VudGFnZTogMS4wLFxyXG4gICAgICAgICAgICAgICAgc3BlZWQ6IDAsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBmb3JtID0ge1xyXG4gICAgICAgICAgICBpZHg6IG1zZy5pZHgsXHJcbiAgICAgICAgICAgIG1vdmVtZW50OiBtb3ZlbWVudCxcclxuICAgICAgICAgICAgbnVtTW92ZW1lbnRDaGFuZ2VzOiAwLFxyXG4gICAgICAgICAgICBudW1BcHBlYXJhbmNlQ2hhbmdlczogMCxcclxuICAgICAgICAgICAgYmFzZUlkOiBtc2cuYmFzZUlkLFxyXG4gICAgICAgICAgICByZWZySWQ6IG1zZy5yZWZySWQsXHJcbiAgICAgICAgICAgIGlzTXlDbG9uZTogbXNnLmlzTWUsXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV0gPSBmb3JtO1xyXG4gICAgICAgIGlmIChtc2cuYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICBmb3JtLmFwcGVhcmFuY2UgPSBtc2cuYXBwZWFyYW5jZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5lcXVpcG1lbnQpIHtcclxuICAgICAgICAgICAgZm9ybS5lcXVpcG1lbnQgPSBtc2cuZXF1aXBtZW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLmlzRGVhZCkge1xyXG4gICAgICAgICAgICBmb3JtLmlzRGVhZCA9IG1zZy5pc0RlYWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cuYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgIGZvcm0uYW5pbWF0aW9uID0gbXNnLmFuaW1hdGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5wcm9wcykge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBtc2cucHJvcHMpIHtcclxuICAgICAgICAgICAgICAgIGZvcm1bcHJvcE5hbWVdID0gbXNnLnByb3BzW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBtc2cuY3VzdG9tUHJvcHNKc29uRHVtcHMuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkge1xyXG4gICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgIHZhciBwYXJzZWQ7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBwYXJzZWQgPSBKU09OLnBhcnNlKGVsZW1lbnQucHJvcFZhbHVlSnNvbkR1bXApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiY3JlYXRlQWN0b3JcIiwgKF9hID0gbXNnLnJlZnJJZCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnRvU3RyaW5nKDE2KSwgXCJmYWlsZWQgdG8gcGFyc2UgY3VzdG9tIHByb3BcIiwgZWxlbWVudC5wcm9wTmFtZSwgZWxlbWVudC5wcm9wVmFsdWVKc29uRHVtcCwgZS5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9ybVtlbGVtZW50LnByb3BOYW1lXSA9IHBhcnNlZDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAobXNnLmlzTWUpIHtcclxuICAgICAgICAgICAgdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPSBpO1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyUmVmcklkID0gbXNnLnJlZnJJZCB8fCAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBUT0RPOiBtb3ZlIHRvIGEgc2VwYXJhdGUgbW9kdWxlXHJcbiAgICAgICAgaWYgKG1zZy5wcm9wcyAmJiAhbXNnLnByb3BzLmlzSG9zdGVkQnlPdGhlcikge1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLnByb3BzICYmIG1zZy5wcm9wcy5pc1JhY2VNZW51T3BlbiAmJiBtc2cuaXNNZSkge1xyXG4gICAgICAgICAgICB0aGlzLm9uU2V0UmFjZU1lbnVPcGVuTWVzc2FnZSh7IG1lc3NhZ2U6IHsgdDogTXNnVHlwZS5TZXRSYWNlTWVudU9wZW4sIG9wZW46IHRydWUgfSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG51bVNldEludmVudG9yeSA9IHRoaXMubnVtU2V0SW52ZW50b3J5O1xyXG4gICAgICAgIHZhciBhcHBseVBjSW52ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAobXNnLmVxdWlwbWVudCkge1xyXG4gICAgICAgICAgICAgICAgYXBwbHlFcXVpcG1lbnQoR2FtZS5nZXRQbGF5ZXIoKSwgbXNnLmVxdWlwbWVudCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG51bVNldEludmVudG9yeSAhPT0gX3RoaXMubnVtU2V0SW52ZW50b3J5KSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgJ1NraXBwaW5nIGludmVudG9yeSBhcHBseSBkdWUgdG8gbmV3ZXIgc2V0SW52ZW50b3J5IG1lc3NhZ2UnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobXNnLnByb3BzICYmIG1zZy5wcm9wcy5pbnZlbnRvcnkpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLm9uU2V0SW52ZW50b3J5TWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlNldEludmVudG9yeSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW52ZW50b3J5OiBtc2cucHJvcHMuaW52ZW50b3J5XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmIChtc2cuaXNNZSAmJiBtc2cucHJvcHMgJiYgbXNnLnByb3BzLmxlYXJuZWRTcGVsbHMpIHtcclxuICAgICAgICAgICAgdmFyIGxlYXJuZWRTcGVsbHNfMSA9IG1zZy5wcm9wcy5sZWFybmVkU3BlbGxzO1xyXG4gICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlsaXR5LndhaXQoMSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBsYXllciA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVBbGxTcGVsbHMocGxheWVyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGVhcm5TcGVsbHMocGxheWVyLCBsZWFybmVkU3BlbGxzXzEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJwbGF5ZXIgbGVhcm5lZFNwZWxsczpcIiwgSlNPTi5zdHJpbmdpZnkobGVhcm5lZFNwZWxsc18xKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLmlzTWUpIHtcclxuICAgICAgICAgICAgaWYgKChfYSA9IG1zZy5wcm9wcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmlzRGVhZCkge1xyXG4gICAgICAgICAgICAgICAgb25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhcHBseURlYXRoU3RhdGVFdmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdG9yOiBHYW1lLmdldFBsYXllcigpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0RlYWQ6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cuaXNNZSkge1xyXG4gICAgICAgICAgICB2YXIgc3Bhd25UYXNrXzEgPSB7IHJ1bm5pbmc6IGZhbHNlIH07XHJcbiAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIC8vIFVzZSBNb3ZlUmVmclRvUG9zaXRpb24gdG8gc3Bhd24gaWYgcG9zc2libGUgKG5vdCBpbiBtYWluIG1lbnUpXHJcbiAgICAgICAgICAgICAgICAvLyBJbiBjYXNlIG9mIGNvbm5lY3Rpb24gbG9zdCB0aGlzIGlzIGVzc2VudGlhbFxyXG4gICAgICAgICAgICAgICAgaWYgKCFzcGF3blRhc2tfMS5ydW5uaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25UYXNrXzEucnVubmluZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsICdVc2luZyBtb3ZlUmVmclRvUG9zaXRpb24gdG8gc3Bhd24gcGxheWVyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9fYXdhaXRlcihfdGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsLCBwb3MsIHNxciwgZGlzdGFuY2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdHJ1ZSkgcmV0dXJuIFszIC8qYnJlYWsqLywgMl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdTcGF3bmluZy4uLicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBURVNNb2RQbGF0Zm9ybS5tb3ZlUmVmclRvUG9zaXRpb24oR2FtZS5nZXRQbGF5ZXIoKSwgQ2VsbC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KG1zZy50cmFuc2Zvcm0ud29ybGRPckNlbGwpKSwgV29ybGRTcGFjZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KG1zZy50cmFuc2Zvcm0ud29ybGRPckNlbGwpKSwgbXNnLnRyYW5zZm9ybS5wb3NbMF0sIG1zZy50cmFuc2Zvcm0ucG9zWzFdLCBtc2cudHJhbnNmb3JtLnBvc1syXSwgbXNnLnRyYW5zZm9ybS5yb3RbMF0sIG1zZy50cmFuc2Zvcm0ucm90WzFdLCBtc2cudHJhbnNmb3JtLnJvdFsyXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIFV0aWxpdHkud2FpdCgxKV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgMl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGwuZ2V0UG9zaXRpb25YKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbC5nZXRQb3NpdGlvblkoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsLmdldFBvc2l0aW9uWigpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcXIgPSBmdW5jdGlvbiAoeCkgeyByZXR1cm4geCAqIHg7IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RhbmNlID0gTWF0aC5zcXJ0KHNxcihwb3NbMF0gLSBtc2cudHJhbnNmb3JtLnBvc1swXSkgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3FyKHBvc1sxXSAtIG1zZy50cmFuc2Zvcm0ucG9zWzFdKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZSA8IDI1Nikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgMl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgMF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pOyB9KSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFVuZm9ydHVuYXRlbGx5IGl0IHJlcXVpcmVzIHR3byBjYWxscyB0byB3b3JrXHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbGl0eS53YWl0KDEpLnRoZW4oYXBwbHlQY0ludik7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbGl0eS53YWl0KDEuMykudGhlbihhcHBseVBjSW52KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBOb3RlOiBhcHBlYXJhbmNlIHBhcnQgd2FzIGNvcHktcGFzdGVkXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1zZy5hcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5QXBwZWFyYW5jZVRvUGxheWVyKG1zZy5hcHBlYXJhbmNlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobXNnLnByb3BzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJhc2VBY3RvclZhbHVlc18xID0gbmV3IE1hcChbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnaGVhbFJhdGUnLCBtc2cucHJvcHMuaGVhbFJhdGVdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ2hlYWxSYXRlTXVsdCcsIG1zZy5wcm9wcy5oZWFsUmF0ZU11bHRdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ2hlYWx0aCcsIG1zZy5wcm9wcy5oZWFsdGhdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ21hZ2lja2FSYXRlJywgbXNnLnByb3BzLm1hZ2lja2FSYXRlXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydtYWdpY2thUmF0ZU11bHQnLCBtc2cucHJvcHMubWFnaWNrYVJhdGVNdWx0XSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydtYWdpY2thJywgbXNnLnByb3BzLm1hZ2lja2FdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ3N0YW1pbmFSYXRlJywgbXNnLnByb3BzLnN0YW1pbmFSYXRlXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydzdGFtaW5hUmF0ZU11bHQnLCBtc2cucHJvcHMuc3RhbWluYVJhdGVNdWx0XSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydzdGFtaW5hJywgbXNnLnByb3BzLnN0YW1pbmFdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ2hlYWx0aFBlcmNlbnRhZ2UnLCBtc2cucHJvcHMuaGVhbHRoUGVyY2VudGFnZV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnc3RhbWluYVBlcmNlbnRhZ2UnLCBtc2cucHJvcHMuc3RhbWluYVBlcmNlbnRhZ2VdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ21hZ2lja2FQZXJjZW50YWdlJywgbXNnLnByb3BzLm1hZ2lja2FQZXJjZW50YWdlXSxcclxuICAgICAgICAgICAgICAgICAgICBdKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGxheWVyXzEgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJfMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBiYXNlQWN0b3JWYWx1ZXNfMS5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuaW5jbHVkZXMoJ1BlcmNlbnRhZ2UnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3ViS2V5ID0ga2V5LnJlcGxhY2UoJ1BlcmNlbnRhZ2UnLCAnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdWJWYWx1ZSA9IGJhc2VBY3RvclZhbHVlc18xLmdldChzdWJLZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHN1YlZhbHVlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UocGxheWVyXzEsIHN1YktleSwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXJfMS5zZXRBY3RvclZhbHVlKGtleSwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgb25jZSgndGljaycsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIG9uY2UoJ3RpY2snLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzcGF3blRhc2tfMS5ydW5uaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYXduVGFza18xLnJ1bm5pbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9hZE9yZGVyID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGlfMiA9IDA7IGlfMiA8IF90aGlzLnNwLkdhbWUuZ2V0TW9kQ291bnQoKTsgKytpXzIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRPcmRlci5wdXNoKF90aGlzLnNwLkdhbWUuZ2V0TW9kTmFtZShpXzIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJsb2FkaW5nIGdhbWUgaW4gd29ybGQvY2VsbFwiLCBtc2cudHJhbnNmb3JtLndvcmxkT3JDZWxsLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2FkR2FtZVNlcnZpY2UgPSBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKExvYWRHYW1lU2VydmljZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRHYW1lU2VydmljZS5sb2FkR2FtZShtc2cudHJhbnNmb3JtLnBvcywgbXNnLnRyYW5zZm9ybS5yb3QsIG1zZy50cmFuc2Zvcm0ud29ybGRPckNlbGwsIG1zZy5hcHBlYXJhbmNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBtc2cuYXBwZWFyYW5jZS5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhY2VJZDogbXNnLmFwcGVhcmFuY2UucmFjZUlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IEluIHR5cGVzLCBpc0ZlbWFsZSBpcyB1bmRlciBmYWNlLCBidXQgaW4gdGhlIHJlYWxpdHkgU1AgZXhwZWN0cyBpdCBoZXJlLiBGaXggcmVxdWlyZWQuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRmVtYWxlOiBtc2cuYXBwZWFyYW5jZS5pc0ZlbWFsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhaXJDb2xvcjogbXNnLmFwcGVhcmFuY2UuaGFpckNvbG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5U2tpbkNvbG9yOiBtc2cuYXBwZWFyYW5jZS5za2luQ29sb3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRUZXh0dXJlU2V0SWQ6IG1zZy5hcHBlYXJhbmNlLmhlYWRUZXh0dXJlU2V0SWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRQYXJ0SWRzOiBtc2cuYXBwZWFyYW5jZS5oZWFkcGFydElkcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2V0czogbXNnLmFwcGVhcmFuY2UucHJlc2V0c1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCwgbG9hZE9yZGVyLCB7IG1pbnV0ZXM6IDAsIHNlY29uZHM6IDAsIGhvdXJzOiBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFRpbWVTZXJ2aWNlKS5nZXRUaW1lKCkubmV3R2FtZUhvdXJWYWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlQY0ludigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbGl0eS53YWl0KDAuMykudGhlbihhcHBseVBjSW52KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdGU6IGFwcGVhcmFuY2UgcGFydCB3YXMgY29weS1wYXN0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtc2cuYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5QXBwZWFyYW5jZVRvUGxheWVyKG1zZy5hcHBlYXJhbmNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uRGVzdHJveUFjdG9yTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIChfYSA9IGdldFZpZXdGcm9tU3RvcmFnZSgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc3luY0Zvcm1BcnJheSh0aGlzLndvcmxkTW9kZWwpO1xyXG4gICAgICAgIC8vIFNocmluayB0byBmaXRcclxuICAgICAgICB3aGlsZSAoMSkge1xyXG4gICAgICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zLmxlbmd0aDtcclxuICAgICAgICAgICAgaWYgKCFsZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLndvcmxkTW9kZWwuZm9ybXNbbGVuZ3RoIC0gMV0pIHtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMud29ybGRNb2RlbC5mb3Jtcy5sZW5ndGggPSBsZW5ndGggLSAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPT09IGkpIHtcclxuICAgICAgICAgICAgdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPSAtMTtcclxuICAgICAgICAgICAgdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlclJlZnJJZCA9IDA7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IG1vdmUgdG8gYSBzZXBhcmF0ZSBtb2R1bGVcclxuICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkgeyByZXR1cm4gR2FtZS5xdWl0VG9NYWluTWVudSgpOyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5nZXRJZE1hbmFnZXIoKS5mcmVlSWRGb3IobXNnLmlkeCk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZU1vdmVtZW50TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICB2YXIgZm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXTtcclxuICAgICAgICBpZiAoZm9ybSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25VcGRhdGVNb3ZlbWVudE1lc3NhZ2UgLSBGb3JtIHdpdGggaWR4XCIsIG1zZy5pZHgsIFwibm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm0ubW92ZW1lbnQgPSBtc2cuZGF0YTtcclxuICAgICAgICBpZiAoIWZvcm0ubnVtTW92ZW1lbnRDaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgIGZvcm0ubnVtTW92ZW1lbnRDaGFuZ2VzID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybS5udW1Nb3ZlbWVudENoYW5nZXMrKztcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlQW5pbWF0aW9uTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICB2YXIgZm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXTtcclxuICAgICAgICBpZiAoZm9ybSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25VcGRhdGVBbmltYXRpb25NZXNzYWdlIC0gRm9ybSB3aXRoIGlkeFwiLCBtc2cuaWR4LCBcIm5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtLmFuaW1hdGlvbiA9IG1zZy5kYXRhO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVBcHBlYXJhbmNlTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgIHZhciBmb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldO1xyXG4gICAgICAgIGlmIChmb3JtID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvblVwZGF0ZUFwcGVhcmFuY2VNZXNzYWdlIC0gRm9ybSB3aXRoIGlkeFwiLCBtc2cuaWR4LCBcIm5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtLmFwcGVhcmFuY2UgPSBtc2cuZGF0YSB8fCB1bmRlZmluZWQ7XHJcbiAgICAgICAgaWYgKCFmb3JtLm51bUFwcGVhcmFuY2VDaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgIGZvcm0ubnVtQXBwZWFyYW5jZUNoYW5nZXMgPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtLm51bUFwcGVhcmFuY2VDaGFuZ2VzKys7XHJcbiAgICAgICAgdmFyIG5ld0FwcGVhcmFuY2UgPSBtc2cuZGF0YTtcclxuICAgICAgICBpZiAoaSA9PT0gdGhpcy5nZXRNeUFjdG9ySW5kZXgoKSAmJiBuZXdBcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGFwcGx5QXBwZWFyYW5jZVRvUGxheWVyKG5ld0FwcGVhcmFuY2UpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiQXBwbGllZCBhcHBlYXJhbmNlIHRvIHRoZSBwbGF5ZXJcIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlRXF1aXBtZW50TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICB2YXIgZm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXTtcclxuICAgICAgICBpZiAoZm9ybSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25VcGRhdGVFcXVpcG1lbnRNZXNzYWdlIC0gRm9ybSB3aXRoIGlkeFwiLCBtc2cuaWR4LCBcIm5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtLmVxdWlwbWVudCA9IG1zZy5kYXRhO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVQcm9wZXJ0eU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBtc2dEYXRhID0gdGhpcy5leHRyYWN0VXBkYXRlUHJvcGVydHlNZXNzYWdlRGF0YShtc2cpO1xyXG4gICAgICAgIGlmICh0aGlzLnNraXBGb3JtVmlld0NyZWF0aW9uKG1zZykpIHtcclxuICAgICAgICAgICAgdmFyIHJlZnJJZF8yID0gbXNnLnJlZnJJZDtcclxuICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWRfMikpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyZWZyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsICdVcGRhdGVQcm9wZXJ0eTogcmVmciBub3QgZm91bmQnKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobXNnLnByb3BOYW1lID09PSAnaW52ZW50b3J5Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSW52ZW50b3J5KHJlZnIsIG1zZ0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnLnByb3BOYW1lID09PSAnaXNPcGVuJykge1xyXG4gICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNPcGVuKHJlZnIsICEhbXNnRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2cucHJvcE5hbWUgPT09ICdpc0hhcnZlc3RlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzSGFydmVzdGVkKHJlZnIsICEhbXNnRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2cucHJvcE5hbWUgPT09ICdkaXNhYmxlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzRGlzYWJsZWQocmVmciwgISFtc2dEYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgIHZhciBmb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldO1xyXG4gICAgICAgIGZvcm1bbXNnLnByb3BOYW1lXSA9IG1zZ0RhdGE7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbkRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGRlYXRoIHN0YXRlOlwiLCBKU09OLnN0cmluZ2lmeShtc2cudElzRGVhZCkpO1xyXG4gICAgICAgIHZhciBpZCA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLnRJc0RlYWQuaWR4KTtcclxuICAgICAgICB2YXIgZm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpZF07XHJcbiAgICAgICAgaWYgKGZvcm0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uRGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2UgLSBGb3JtIHdpdGggaWR4XCIsIG1zZy50SXNEZWFkLmlkeCwgXCJub3QgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy50SXNEZWFkLnByb3BOYW1lICE9PSBuYW1lb2YoJ2lzRGVhZCcpKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25EZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZSAtIEludmFsaWQgcHJvcE5hbWVcIiwgbXNnLnRJc0RlYWQucHJvcE5hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBtc2dEYXRhID0gdGhpcy5leHRyYWN0VXBkYXRlUHJvcGVydHlNZXNzYWdlRGF0YShtc2cudElzRGVhZCk7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBtc2dEYXRhICE9PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvbkRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlIC0gSW52YWxpZCBkYXRhXCIsIG1zZ0RhdGEpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cudENoYW5nZVZhbHVlcykge1xyXG4gICAgICAgICAgICB0aGlzLm9uQ2hhbmdlVmFsdWVzTWVzc2FnZSh7IG1lc3NhZ2U6IG1zZy50Q2hhbmdlVmFsdWVzIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZVByb3BlcnR5TWVzc2FnZSh7IG1lc3NhZ2U6IG1zZy50SXNEZWFkIH0pOyB9KTtcclxuICAgICAgICBpZiAobXNnLnRUZWxlcG9ydCkge1xyXG4gICAgICAgICAgICB0aGlzLm9uVGVsZXBvcnRNZXNzYWdlKHsgbWVzc2FnZTogbXNnLnRUZWxlcG9ydCB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgIHZhciBhY3RvciA9IGlkID09PSBfdGhpcy5nZXRXb3JsZE1vZGVsKCkucGxheWVyQ2hhcmFjdGVyRm9ybUlkeFxyXG4gICAgICAgICAgICAgICAgPyBHYW1lLmdldFBsYXllcigpXHJcbiAgICAgICAgICAgICAgICA6IEFjdG9yLmZyb20oR2FtZS5nZXRGb3JtRXgocmVtb3RlSWRUb0xvY2FsSWQoKF9hID0gZm9ybS5yZWZySWQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDApKSk7XHJcbiAgICAgICAgICAgIGlmIChhY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFwcGx5RGVhdGhTdGF0ZUV2ZW50XCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3I6IGFjdG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0RlYWQ6IG1zZ0RhdGFcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBSZXNwYXduTmVlZGVkRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3IuZGlzYWJsZU5vV2FpdChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdG9yLmRlbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLmhhbmRsZUNvbm5lY3Rpb25BY2NlcHRlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLndvcmxkTW9kZWwuZm9ybXMgPSBbXTtcclxuICAgICAgICB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9IC0xO1xyXG4gICAgICAgIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJSZWZySWQgPSAwO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiSGFuZGxlIGNvbm5lY3Rpb24gYWNjZXB0ZWRcIik7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbkNoYW5nZVZhbHVlc01lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGlkID0gX3RoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgICAgIHZhciByZWZyID0gaWQgPT09IF90aGlzLmdldE15QWN0b3JJbmRleCgpID8gR2FtZS5nZXRQbGF5ZXIoKSA6IGdldE9iamVjdFJlZmVyZW5jZShpZCk7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgIGlmICghYWMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgX2EgPSBtc2cuZGF0YSwgaGVhbHRoID0gX2EuaGVhbHRoLCBzdGFtaW5hID0gX2Euc3RhbWluYSwgbWFnaWNrYSA9IF9hLm1hZ2lja2E7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgaGVhbHRoID09PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRBY3RvclZhbHVlUGVyY2VudGFnZShhYywgJ2hlYWx0aCcsIGhlYWx0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzdGFtaW5hID09PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRBY3RvclZhbHVlUGVyY2VudGFnZShhYywgJ3N0YW1pbmEnLCBzdGFtaW5hKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG1hZ2lja2EgPT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgIHNldEFjdG9yVmFsdWVQZXJjZW50YWdlKGFjLCAnbWFnaWNrYScsIG1hZ2lja2EpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblNldFJhY2VNZW51T3Blbk1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBpZiAobXNnLm9wZW4pIHtcclxuICAgICAgICAgICAgLy8gd2FpdCAwLjNzIGNhdXNlIHdlIGNhbiBzZWUgdmlzdWFsIGJ1Z3Mgd2hlbiB0ZWxlcG9ydGluZ1xyXG4gICAgICAgICAgICAvLyBhbmQgc2hvd2luZyB0aGlzIG1lbnUgYXQgdGhlIHNhbWUgdGltZSBpbiBvbkNvbm5lY3RcclxuICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFV0aWxpdHkud2FpdCgwLjMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVuZXF1aXBJcm9uSGVsbWV0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgR2FtZS5zaG93UmFjZU1lbnUoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IEltcGxlbWVudCBjbG9zZU1lbnUgaW4gU2t5cmltUGxhdGZvcm1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLyoqIFBhY2tldCBoYW5kbGVycyBlbmQgKiovXHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLmdldFdvcmxkTW9kZWwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud29ybGRNb2RlbDtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLmdldE15QWN0b3JJbmRleCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHg7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5nZXRNeVJlbW90ZVJlZnJJZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlclJlZnJJZDtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLmdldElkTWFuYWdlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pZE1hbmFnZXJfO1xyXG4gICAgfTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLCBcIndvcmxkTW9kZWxcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHN0b3JhZ2VbXCJ3b3JsZE1vZGVsXCJdID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2VbXCJ3b3JsZE1vZGVsXCJdID0geyBmb3JtczogW10sIHBsYXllckNoYXJhY3RlckZvcm1JZHg6IC0xLCBwbGF5ZXJDaGFyYWN0ZXJSZWZySWQ6IDAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gc3RvcmFnZVtcIndvcmxkTW9kZWxcIl07XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFJlbW90ZVNlcnZlci5wcm90b3R5cGUsIFwiaWRNYW5hZ2VyX1wiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RvcmFnZVtcImlkTWFuYWdlclwiXSA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBOb3RlOiBmdWxsIElkTWFuYWdlciBvYmplY3QgcHJlc2VydmVkIGFjcm9zcyBob3QtcmVsb2FkcywgaW5jbHVkaW5nIG1ldGhvZHMuXHJcbiAgICAgICAgICAgICAgICBzdG9yYWdlW1wiaWRNYW5hZ2VyXCJdID0gbmV3IElkTWFuYWdlcigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBzdG9yYWdlW1wiaWRNYW5hZ2VyXCJdO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25jZUxvYWQgPSBmdW5jdGlvbiAocmVmcklkLCBjYWxsYmFjaywgbWF4QXR0ZW1wdHMpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmIChtYXhBdHRlbXB0cyA9PT0gdm9pZCAwKSB7IG1heEF0dGVtcHRzID0gMTIwOyB9XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgICAgICBpZiAocmVmcikge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2socmVmcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBtYXhBdHRlbXB0cy0tO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1heEF0dGVtcHRzID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VMb2FkKHJlZnJJZCwgY2FsbGJhY2ssIG1heEF0dGVtcHRzKTsgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgJ0ZhaWxlZCB0byBsb2FkIG9iamVjdCByZWZlcmVuY2UgJyArIHJlZnJJZC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5za2lwRm9ybVZpZXdDcmVhdGlvbiA9IGZ1bmN0aW9uIChtc2cpIHtcclxuICAgICAgICAvLyBPcHRpbWl6YXRpb24gYWRkZWQgaW4gIzExODYsIGhvd2V2ZXIgaXQgZG9lc24ndCB3b3JrIGZvciBkb29ycyBmb3Igc29tZSByZWFzb25cclxuICAgICAgICByZXR1cm4gbXNnLnJlZnJJZCAmJiBtc2cucmVmcklkIDwgMHhmZjAwMDAwMCAmJiBtc2cuYmFzZVJlY29yZFR5cGUgIT09ICdET09SJztcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLmV4dHJhY3RVcGRhdGVQcm9wZXJ0eU1lc3NhZ2VEYXRhID0gZnVuY3Rpb24gKHVwZGF0ZVByb3BlcnR5TWVzc2FnZSkge1xyXG4gICAgICAgIHZhciBtc2dEYXRhID0gdXBkYXRlUHJvcGVydHlNZXNzYWdlLmRhdGE7XHJcbiAgICAgICAgaWYgKHVwZGF0ZVByb3BlcnR5TWVzc2FnZS5kYXRhRHVtcCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBtc2dEYXRhID0gSlNPTi5wYXJzZSh1cGRhdGVQcm9wZXJ0eU1lc3NhZ2UuZGF0YUR1bXApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgJ2V4dHJhY3RVcGRhdGVQcm9wZXJ0eU1lc3NhZ2VEYXRhIC0gRmFpbGVkIHRvIHBhcnNlIGRhdGFEdW1wJywgdXBkYXRlUHJvcGVydHlNZXNzYWdlLmRhdGFEdW1wKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBtc2dEYXRhO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25TcGVsbENhc3RNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlbW90ZUlkVG9Mb2NhbElkKG1zZy5kYXRhLmNhc3RlcikpKTtcclxuICAgICAgICAgICAgaWYgKCFhYykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhY3RvckFuaW1hdGlvblZhcmlhYmxlcyA9IHtcclxuICAgICAgICAgICAgICAgIGJvb2xlYW5zOiBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hY3RvckFuaW1hdGlvblZhcmlhYmxlcy5ib29sZWFucyksXHJcbiAgICAgICAgICAgICAgICBmbG9hdHM6IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzLmZsb2F0cyksXHJcbiAgICAgICAgICAgICAgICBpbnRlZ2VyczogbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMuaW50ZWdlcnMpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGlmIChtc2cuZGF0YS5pbnRlcnJ1cHRDYXN0KSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcnJ1cHRDYXN0KGFjLmdldEZvcm1JRCgpLCBtc2cuZGF0YS5jYXN0aW5nU291cmNlLCBhY3RvckFuaW1hdGlvblZhcmlhYmxlcyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHNwZWxsID0gYWMuZ2V0RXF1aXBwZWRTcGVsbChtc2cuZGF0YS5jYXN0aW5nU291cmNlKTtcclxuICAgICAgICAgICAgaWYgKHNwZWxsKSB7XHJcbiAgICAgICAgICAgICAgICBjYXN0U3BlbGxJbW1lZGlhdGUoYWMuZ2V0Rm9ybUlEKCksIG1zZy5kYXRhLmNhc3RpbmdTb3VyY2UsIHNwZWxsLmdldEZvcm1JRCgpLCByZW1vdGVJZFRvTG9jYWxJZChtc2cuZGF0YS50YXJnZXQpLCBtc2cuZGF0YS5haW1BbmdsZSwgbXNnLmRhdGEuYWltSGVhZGluZywgYWN0b3JBbmltYXRpb25WYXJpYWJsZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZUFuaW1WYXJpYWJsZXNNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20oR2FtZS5nZXRGb3JtRXgocmVtb3RlSWRUb0xvY2FsSWQobXNnLmRhdGEuYWN0b3JSZW1vdGVJZCkpKTtcclxuICAgICAgICAgICAgaWYgKCFhYykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhY3RvckFuaW1hdGlvblZhcmlhYmxlcyA9IHtcclxuICAgICAgICAgICAgICAgIGJvb2xlYW5zOiBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hY3RvckFuaW1hdGlvblZhcmlhYmxlcy5ib29sZWFucyksXHJcbiAgICAgICAgICAgICAgICBmbG9hdHM6IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzLmZsb2F0cyksXHJcbiAgICAgICAgICAgICAgICBpbnRlZ2VyczogbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMuaW50ZWdlcnMpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHZhciBpc0FwcGx5ZWQgPSBhcHBseUFuaW1hdGlvblZhcmlhYmxlc1RvQWN0b3IoYWMuZ2V0Rm9ybUlEKCksIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzKTtcclxuICAgICAgICAgICAgaWYgKCFpc0FwcGx5ZWQpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCAnRmFpbGVkIGFwcGx5IEFuaW1hdGlvblZhcmlhYmxlcyB0byBhY3RvciB3aXRoIGlkOiAnICsgYWMuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25Wb2ljZUNoYXRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgLy8gVXBkYXRlIGZvcm0gbW9kZWwgd2l0aCBpc1RhbGtpbmcgc3RhdGVcclxuICAgICAgICB2YXIgc3BlYWtlckZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXMuZmluZChmdW5jdGlvbiAoZikgeyByZXR1cm4gZiAmJiBmLnJlZnJJZCA9PT0gbXNnLmRhdGEuc3BlYWtlcklkOyB9KTtcclxuICAgICAgICBpZiAoc3BlYWtlckZvcm0pIHtcclxuICAgICAgICAgICAgc3BlYWtlckZvcm0uaXNUYWxraW5nID0gbXNnLmRhdGEuaXNUYWxraW5nO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBGb3J3YXJkIHRvIFZvaWNlQ2hhdFNlcnZpY2UgZm9yIHByb2Nlc3NpbmdcclxuICAgICAgICB2YXIgdm9pY2VDaGF0U2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihWb2ljZUNoYXRTZXJ2aWNlKTtcclxuICAgICAgICBpZiAodm9pY2VDaGF0U2VydmljZSkge1xyXG4gICAgICAgICAgICB2YXIgYXVkaW9EYXRhID0gbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYXVkaW9EYXRhKTtcclxuICAgICAgICAgICAgdm9pY2VDaGF0U2VydmljZS5vblJlY2VpdmVWb2ljZURhdGEobXNnLmRhdGEuc3BlYWtlcklkLCBhdWRpb0RhdGEuYnVmZmVyLCAwLCAwLCAwKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZVZvaWNlQ2hhdE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICAvLyBVcGRhdGUgZm9ybSBtb2RlbCB3aXRoIGlzVGFsa2luZyBzdGF0ZVxyXG4gICAgICAgIHZhciBzcGVha2VyRm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtcy5maW5kKGZ1bmN0aW9uIChmKSB7IHJldHVybiBmICYmIGYucmVmcklkID09PSBtc2cuZGF0YS5zcGVha2VySWQ7IH0pO1xyXG4gICAgICAgIGlmIChzcGVha2VyRm9ybSkge1xyXG4gICAgICAgICAgICBzcGVha2VyRm9ybS5pc1RhbGtpbmcgPSBtc2cuZGF0YS5pc1RhbGtpbmc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEZvcndhcmQgdG8gVm9pY2VDaGF0U2VydmljZSB3aXRoIDNEIHBvc2l0aW9uIGRhdGFcclxuICAgICAgICB2YXIgdm9pY2VDaGF0U2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihWb2ljZUNoYXRTZXJ2aWNlKTtcclxuICAgICAgICBpZiAodm9pY2VDaGF0U2VydmljZSkge1xyXG4gICAgICAgICAgICB2YXIgYXVkaW9EYXRhID0gbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYXVkaW9EYXRhKTtcclxuICAgICAgICAgICAgdm9pY2VDaGF0U2VydmljZS5vblJlY2VpdmVWb2ljZURhdGEobXNnLmRhdGEuc3BlYWtlcklkLCBhdWRpb0RhdGEuYnVmZmVyLCBtc2cuZGF0YS5wb3NpdGlvblswXSwgLy8geFxyXG4gICAgICAgICAgICBtc2cuZGF0YS5wb3NpdGlvblsxXSwgLy8geVxyXG4gICAgICAgICAgICBtc2cuZGF0YS5wb3NpdGlvblsyXSAvLyB6XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBSZW1vdGVTZXJ2ZXI7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgUmVtb3RlU2VydmVyIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFNpbmdsZVBsYXllclNlcnZpY2UgfSBmcm9tIFwiLi9zaW5nbGVQbGF5ZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgZ2V0TW92ZW1lbnQgfSBmcm9tIFwiLi4vLi4vc3luYy9tb3ZlbWVudEdldFwiO1xyXG4vLyBUT0RPOiByZWZhY3RvciB0aGlzIG91dFxyXG5pbXBvcnQgKiBhcyB3b3JsZFZpZXdNaXNjIGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgQW5pbWF0aW9uU291cmNlIH0gZnJvbSBcIi4uLy4uL3N5bmMvYW5pbWF0aW9uXCI7XHJcbmltcG9ydCB7IGdldEFwcGVhcmFuY2UgfSBmcm9tIFwiLi4vLi4vc3luYy9hcHBlYXJhbmNlXCI7XHJcbmltcG9ydCB7IGdldEFjdG9yVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3N5bmMvYWN0b3J2YWx1ZXNcIjtcclxuaW1wb3J0IHsgZ2V0RXF1aXBtZW50IH0gZnJvbSBcIi4uLy4uL3N5bmMvZXF1aXBtZW50XCI7XHJcbmltcG9ydCB7IG5leHRIb3N0QXR0ZW1wdCB9IGZyb20gXCIuLi8uLi92aWV3L2hvc3RBdHRlbXB0c1wiO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi9yZW1vdGVTZXJ2ZXJcIjtcclxuaW1wb3J0IHsgRGVhdGhTZXJ2aWNlIH0gZnJvbSBcIi4vZGVhdGhTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIHBsYXllckZvcm1JZCA9IDB4MTQ7XHJcbi8vIFRPRE86IHNwbGl0IHRoaXMgc2VydmljZSBpbnRvIEVxdWlwbWVudFNlcnZpY2UsIE1vdmVtZW50U2VydmljZSwgQW5pbWF0aW9uU2VydmljZSwgQWN0b3JWYWx1ZVNlcnZpY2UsIEhvc3RBdHRlbXB0c1NlcnZpY2VcclxudmFyIFNlbmRJbnB1dHNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNlbmRJbnB1dHNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU2VuZElucHV0c1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMubGFzdFNlbmRNb3ZlbWVudE1vbWVudCA9IG5ldyBNYXAoKTtcclxuICAgICAgICBfdGhpcy5wbGF5ZXJBbmltU291cmNlID0gbmV3IE1hcCgpOyAvLyBUT0RPOiBtYWtlIHNlcnZpY2VcclxuICAgICAgICBfdGhpcy5sYXN0QW5pbWF0aW9uU2VudCA9IG5ldyBNYXAoKTtcclxuICAgICAgICBfdGhpcy5hY3RvclZhbHVlc05lZWRVcGRhdGUgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5pc1JhY2VTZXhNZW51U2hvd24gPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5lcXVpcG1lbnRDaGFuZ2VkID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMubnVtRXF1aXBtZW50Q2hhbmdlcyA9IDA7XHJcbiAgICAgICAgX3RoaXMucHJldlZhbHVlcyA9IHsgaGVhbHRoOiAwLCBzdGFtaW5hOiAwLCBtYWdpY2thOiAwIH07XHJcbiAgICAgICAgX3RoaXMucHJldkFjdG9yVmFsdWVzVXBkYXRlVGltZSA9IDA7XHJcbiAgICAgICAgX3RoaXMucHJldkNhc3RpbmdEZXRlY3RlZFRpbWUgPSAwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImVxdWlwXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkVxdWlwKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidW5lcXVpcFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VbmVxdWlwKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwibG9hZEdhbWVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25Mb2FkR2FtZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnNpbmdsZVBsYXllclNlcnZpY2UuaXNTaW5nbGVQbGF5ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5zZW5kSW5wdXRzKCk7XHJcbiAgICAgICAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgIHZhciBpc1BsYXllckNhc3RpbmcgPSBwbGF5ZXIuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNDYXN0aW5nUmlnaHRcIilcclxuICAgICAgICAgICAgICAgIHx8IHBsYXllci5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc0Nhc3RpbmdMZWZ0XCIpXHJcbiAgICAgICAgICAgICAgICB8fCBwbGF5ZXIuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNDYXN0aW5nRHVhbFwiKTtcclxuICAgICAgICAgICAgaWYgKGlzUGxheWVyQ2FzdGluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2Q2FzdGluZ0RldGVjdGVkVGltZSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLm9uRXF1aXAgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICBpZiAoIWV2ZW50LmFjdG9yIHx8ICFldmVudC5iYXNlT2JqKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV2ZW50LmFjdG9yLmdldEZvcm1JRCgpICE9PSBwbGF5ZXJGb3JtSWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdHlwZSA9IGV2ZW50LmJhc2VPYmouZ2V0VHlwZSgpO1xyXG4gICAgICAgIGlmICh0eXBlICE9PSAyNyAvKiBGb3JtVHlwZS5Cb29rICovICYmIHR5cGUgIT09IDQ2IC8qIEZvcm1UeXBlLlBvdGlvbiAqLyAmJiB0eXBlICE9PSAzMCAvKiBGb3JtVHlwZS5JbmdyZWRpZW50ICovKSB7XHJcbiAgICAgICAgICAgIC8vIFRyaWdnZXIgVXBkYXRlRXF1aXBtZW50IG9ubHkgZm9yIGVxdWlwcyB0aGF0IGFyZSBub3Qgc3BlbGwgdG9tZXMsIHBvdGlvbnMsIGluZ3JlZGllbnRzXHJcbiAgICAgICAgICAgIHRoaXMuZXF1aXBtZW50Q2hhbmdlZCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFNlbmQgT25FcXVpcCBmb3IgYW55IGVxdWlwcyBpbmNsdWRpbmcgc3BlbGwgdG9tZXMsIHBvdGlvbnMsIGluZ3JlZGllbnRzXHJcbiAgICAgICAgLy8gT3RoZXJ3aXNlLCB0aGUgc2VydmVyIHdvbid0IHRyaWdnZXIgc3BlbGwgbGVhcm4sIHBvdGlvbiBkcmluaywgaW5ncmVkaWVudCBlYXQgYW5kIFBhcHlydXMgc2NyaXB0c1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHsgdDogTXNnVHlwZS5PbkVxdWlwLCBiYXNlSWQ6IGV2ZW50LmJhc2VPYmouZ2V0Rm9ybUlEKCkgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLm9uVW5lcXVpcCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGlmICghZXZlbnQuYWN0b3IgfHwgIWV2ZW50LmJhc2VPYmopIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXZlbnQuYWN0b3IuZ2V0Rm9ybUlEKCkgPT09IHBsYXllckZvcm1JZCkge1xyXG4gICAgICAgICAgICB0aGlzLmVxdWlwbWVudENoYW5nZWQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUub25Mb2FkR2FtZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIC8vIEN1cnJlbnRseSBvbmx5IGFybW9yIGlzIGVxdWlwcGVkIGFmdGVyIHJlbG9nZ2luZyAoc2VlIHJlbW90ZVNlcnZlci50cylcclxuICAgICAgICAvLyBUaGlzIGhhY2sgZm9yY2VzIHNlbmRpbmcgL2VxdWlwbWVudCB3aXRob3V0IHdlYXBvbnMvIGJhY2sgdG8gdGhlIHNlcnZlclxyXG4gICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KDMpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gKF90aGlzLmVxdWlwbWVudENoYW5nZWQgPSB0cnVlKTsgfSk7XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRJbnB1dHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgaG9zdGVkID0gdHlwZW9mIHRoaXMuc3Auc3RvcmFnZVsnaG9zdGVkJ10gPT09IHR5cGVvZiBbXSA/IHRoaXMuc3Auc3RvcmFnZVsnaG9zdGVkJ10gOiBbXTtcclxuICAgICAgICB2YXIgdGFyZ2V0cyA9IFt1bmRlZmluZWRdLmNvbmNhdChob3N0ZWQpO1xyXG4gICAgICAgIHZhciBtb2RlbFNvdXJjZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSZW1vdGVTZXJ2ZXIpO1xyXG4gICAgICAgIHZhciB3b3JsZCA9IG1vZGVsU291cmNlLmdldFdvcmxkTW9kZWwoKTtcclxuICAgICAgICB0YXJnZXRzLmZvckVhY2goZnVuY3Rpb24gKHRhcmdldCkge1xyXG4gICAgICAgICAgICB2YXIgdGFyZ2V0Rm9ybU1vZGVsID0gdGFyZ2V0ID8gX3RoaXMuZ2V0Rm9ybSh0YXJnZXQsIHdvcmxkKSA6IF90aGlzLmdldEZvcm0odW5kZWZpbmVkLCB3b3JsZCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNlbmRNb3ZlbWVudCh0YXJnZXQsIHRhcmdldEZvcm1Nb2RlbCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNlbmRBbmltYXRpb24odGFyZ2V0KTtcclxuICAgICAgICAgICAgX3RoaXMuc2VuZEFwcGVhcmFuY2UodGFyZ2V0KTtcclxuICAgICAgICAgICAgX3RoaXMuc2VuZEVxdWlwbWVudCh0YXJnZXQpO1xyXG4gICAgICAgICAgICBfdGhpcy5zZW5kQWN0b3JWYWx1ZVBlcmNlbnRhZ2UodGFyZ2V0LCB0YXJnZXRGb3JtTW9kZWwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuc2VuZEhvc3RBdHRlbXB0cygpO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kTW92ZW1lbnQgPSBmdW5jdGlvbiAoX3JlZnJJZCwgZm9ybSkge1xyXG4gICAgICAgIHZhciBvd25lciA9IHRoaXMuZ2V0SW5wdXRPd25lcihfcmVmcklkKTtcclxuICAgICAgICBpZiAoIW93bmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHJlZnJJZFN0ciA9IFwiXCIuY29uY2F0KF9yZWZySWQpO1xyXG4gICAgICAgIHZhciBzZW5kTW92ZW1lbnRSYXRlTXMgPSAxMzA7XHJcbiAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdmFyIGxhc3QgPSB0aGlzLmxhc3RTZW5kTW92ZW1lbnRNb21lbnQuZ2V0KHJlZnJJZFN0cik7XHJcbiAgICAgICAgaWYgKCFsYXN0IHx8IG5vdyAtIGxhc3QgPiBzZW5kTW92ZW1lbnRSYXRlTXMpIHtcclxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlVwZGF0ZU1vdmVtZW50LFxyXG4gICAgICAgICAgICAgICAgZGF0YTogZ2V0TW92ZW1lbnQob3duZXIsIGZvcm0pLFxyXG4gICAgICAgICAgICAgICAgX3JlZnJJZDogX3JlZnJJZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdFNlbmRNb3ZlbWVudE1vbWVudC5zZXQocmVmcklkU3RyLCBub3cpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZEFjdG9yVmFsdWVQZXJjZW50YWdlID0gZnVuY3Rpb24gKF9yZWZySWQsIGZvcm0pIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIGNhblNlbmQgPSBmb3JtICYmICgoX2EgPSBmb3JtLmlzRGVhZCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogZmFsc2UpID09PSBmYWxzZTtcclxuICAgICAgICBpZiAoIWNhblNlbmQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgb3duZXIgPSB0aGlzLmdldElucHV0T3duZXIoX3JlZnJJZCk7XHJcbiAgICAgICAgaWYgKCFvd25lcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhdiA9IGdldEFjdG9yVmFsdWVzKHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBpZiAodGhpcy5hY3RvclZhbHVlc05lZWRVcGRhdGUgPT09IGZhbHNlICYmXHJcbiAgICAgICAgICAgIHRoaXMucHJldlZhbHVlcy5oZWFsdGggPT09IGF2LmhlYWx0aCAmJlxyXG4gICAgICAgICAgICB0aGlzLnByZXZWYWx1ZXMuc3RhbWluYSA9PT0gYXYuc3RhbWluYSAmJlxyXG4gICAgICAgICAgICB0aGlzLnByZXZWYWx1ZXMubWFnaWNrYSA9PT0gYXYubWFnaWNrYSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjdXJyZW50VGltZSAtIHRoaXMucHJldkFjdG9yVmFsdWVzVXBkYXRlVGltZSA8IDIwMDAgJiZcclxuICAgICAgICAgICAgdGhpcy5hY3RvclZhbHVlc05lZWRVcGRhdGUgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gRGVsYXlpbmcgYWN0b3IgdmFsdWVzIHVwZGF0ZSBkdWUgdG8gY2FzdGluZ1xyXG4gICAgICAgIC8vIFRPRE86IHVzZSBwYXJ0aWFsIHVwZGF0ZXMgZm9yIGFjdG9yIHZhbHVlcyBvbmNlIHNlcnZlciBmaW5hbGx5IHN1cHBvcnRzIGl0XHJcbiAgICAgICAgLy8gaS5lLiBrZWVwIHNlbmRpbmcgaGVhbHRoIGFuZCBzdGFtaW5hIGR1cmluZyBjYXN0aW5nLCBidXQgZGVsYXkgbWFnaWNrYSB1cGRhdGVcclxuICAgICAgICBpZiAoY3VycmVudFRpbWUgLSB0aGlzLnByZXZDYXN0aW5nRGV0ZWN0ZWRUaW1lIDwgNTAwICYmXHJcbiAgICAgICAgICAgIGF2LmhlYWx0aCA+IDAgLy8gZG9uJ3QgZGVsYXkgZGVhdGggYWN0b3IgdmFsdWUgdXBkYXRlXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGRlYXRoU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihEZWF0aFNlcnZpY2UpO1xyXG4gICAgICAgIGlmIChkZWF0aFNlcnZpY2UuaXNCdXN5KCkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJOb3Qgc2VuZGluZyBhY3RvciB2YWx1ZXMsIGRlYXRoIHNlcnZpY2UgaXMgYnVzeVwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgdDogTXNnVHlwZS5DaGFuZ2VWYWx1ZXMsXHJcbiAgICAgICAgICAgIGRhdGE6IGF2LFxyXG4gICAgICAgICAgICBfcmVmcklkOiBfcmVmcklkXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5hY3RvclZhbHVlc05lZWRVcGRhdGUgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnByZXZWYWx1ZXMgPSBhdjtcclxuICAgICAgICB0aGlzLnByZXZBY3RvclZhbHVlc1VwZGF0ZVRpbWUgPSBjdXJyZW50VGltZTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZEFuaW1hdGlvbiA9IGZ1bmN0aW9uIChfcmVmcklkKSB7XHJcbiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5nZXRJbnB1dE93bmVyKF9yZWZySWQpO1xyXG4gICAgICAgIGlmICghb3duZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBFeHRlcm1seSBpbXBvcnRhbnQgdGhhdCBpdCdzIGEgbG9jYWwgaWQgc2luY2UgQW5pbWF0aW9uU291cmNlIGRlcGVuZHMgb24gaXRcclxuICAgICAgICB2YXIgcmVmcklkU3RyID0gb3duZXIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpO1xyXG4gICAgICAgIHZhciBhbmltU291cmNlID0gdGhpcy5wbGF5ZXJBbmltU291cmNlLmdldChyZWZySWRTdHIpO1xyXG4gICAgICAgIGlmICghYW5pbVNvdXJjZSkge1xyXG4gICAgICAgICAgICBhbmltU291cmNlID0gbmV3IEFuaW1hdGlvblNvdXJjZShvd25lcik7XHJcbiAgICAgICAgICAgIHRoaXMucGxheWVyQW5pbVNvdXJjZS5zZXQocmVmcklkU3RyLCBhbmltU291cmNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFuaW0gPSBhbmltU291cmNlLmdldEFuaW1hdGlvbigpO1xyXG4gICAgICAgIHZhciBsYXN0QW5pbWF0aW9uU2VudCA9IHRoaXMubGFzdEFuaW1hdGlvblNlbnQuZ2V0KHJlZnJJZFN0cik7XHJcbiAgICAgICAgaWYgKCFsYXN0QW5pbWF0aW9uU2VudCB8fFxyXG4gICAgICAgICAgICBhbmltLm51bUNoYW5nZXMgIT09IGxhc3RBbmltYXRpb25TZW50Lm51bUNoYW5nZXMpIHtcclxuICAgICAgICAgICAgLy8gRHJpbmsgcG90aW9uIGFuaW0gZnJvbSB0aGlzIG1vZCBodHRwczovL3d3dy5uZXh1c21vZHMuY29tL3NreXJpbXNwZWNpYWxlZGl0aW9uL21vZHMvOTc2NjBcclxuICAgICAgICAgICAgaWYgKGFuaW0uYW5pbUV2ZW50TmFtZSAhPT0gJycgJiYgIWFuaW0uYW5pbUV2ZW50TmFtZS5zdGFydHNXaXRoKFwiRHJpbmtQb3Rpb25fXCIpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RBbmltYXRpb25TZW50LnNldChyZWZySWRTdHIsIGFuaW0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVBY3RvclZhbHVlc0FmdGVyQW5pbWF0aW9uKGFuaW0uYW5pbUV2ZW50TmFtZSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlVwZGF0ZUFuaW1hdGlvbixcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBhbmltLFxyXG4gICAgICAgICAgICAgICAgICAgIF9yZWZySWQ6IF9yZWZySWRcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRBcHBlYXJhbmNlID0gZnVuY3Rpb24gKF9yZWZySWQpIHtcclxuICAgICAgICBpZiAoX3JlZnJJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzaG93biA9IHRoaXMuc3AuVWkuaXNNZW51T3BlbignUmFjZVNleCBNZW51Jyk7XHJcbiAgICAgICAgaWYgKHNob3duICE9IHRoaXMuaXNSYWNlU2V4TWVudVNob3duKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNSYWNlU2V4TWVudVNob3duID0gc2hvd247XHJcbiAgICAgICAgICAgIGlmICghc2hvd24pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AucHJpbnRDb25zb2xlKCdFeGl0ZWQgZnJvbSByYWNlIG1lbnUnKTtcclxuICAgICAgICAgICAgICAgIHZhciBhcHBlYXJhbmNlID0gZ2V0QXBwZWFyYW5jZSh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogbG9nIGFwcGVhcmFuY2UgY29udGVudHMgdG8gZGVidWcgYXBwZWFyYW5jZSBpc3N1ZXM/XHJcbiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlVwZGF0ZUFwcGVhcmFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogYXBwZWFyYW5jZSxcclxuICAgICAgICAgICAgICAgICAgICBfcmVmcklkOiBfcmVmcklkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZEVxdWlwbWVudCA9IGZ1bmN0aW9uIChfcmVmcklkKSB7XHJcbiAgICAgICAgaWYgKF9yZWZySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5lcXVpcG1lbnRDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXF1aXBtZW50Q2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICArK3RoaXMubnVtRXF1aXBtZW50Q2hhbmdlcztcclxuICAgICAgICAgICAgdmFyIGVxID0gZ2V0RXF1aXBtZW50KHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSwgdGhpcy5udW1FcXVpcG1lbnRDaGFuZ2VzKTtcclxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlVwZGF0ZUVxdWlwbWVudCxcclxuICAgICAgICAgICAgICAgIGRhdGE6IGVxLFxyXG4gICAgICAgICAgICAgICAgX3JlZnJJZDogX3JlZnJJZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZEhvc3RBdHRlbXB0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgcmVtb3RlSWQgPSBuZXh0SG9zdEF0dGVtcHQoKTtcclxuICAgICAgICBpZiAoIXJlbW90ZUlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5Ib3N0LFxyXG4gICAgICAgICAgICAgICAgcmVtb3RlSWQ6IHJlbW90ZUlkXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5nZXRJbnB1dE93bmVyID0gZnVuY3Rpb24gKF9yZWZySWQpIHtcclxuICAgICAgICByZXR1cm4gX3JlZnJJZFxyXG4gICAgICAgICAgICA/IHRoaXMuc3AuQWN0b3IuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHdvcmxkVmlld01pc2MucmVtb3RlSWRUb0xvY2FsSWQoX3JlZnJJZCkpKVxyXG4gICAgICAgICAgICA6IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuZ2V0Rm9ybSA9IGZ1bmN0aW9uIChyZWZySWQsIHdvcmxkKSB7XHJcbiAgICAgICAgdmFyIGZvcm0gPSByZWZySWRcclxuICAgICAgICAgICAgPyB3b3JsZCA9PT0gbnVsbCB8fCB3b3JsZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogd29ybGQuZm9ybXMuZmluZChmdW5jdGlvbiAoZikgeyByZXR1cm4gKGYgPT09IG51bGwgfHwgZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZi5yZWZySWQpID09PSByZWZySWQ7IH0pXHJcbiAgICAgICAgICAgIDogd29ybGQuZm9ybXNbd29ybGQucGxheWVyQ2hhcmFjdGVyRm9ybUlkeF07XHJcbiAgICAgICAgcmV0dXJuIGZvcm07XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnVwZGF0ZUFjdG9yVmFsdWVzQWZ0ZXJBbmltYXRpb24gPSBmdW5jdGlvbiAoYW5pbU5hbWUpIHtcclxuICAgICAgICBpZiAoYW5pbU5hbWUgPT09ICdKdW1wTGFuZCcgfHxcclxuICAgICAgICAgICAgYW5pbU5hbWUgPT09ICdKdW1wTGFuZERpcmVjdGlvbmFsJyB8fFxyXG4gICAgICAgICAgICBhbmltTmFtZSA9PT0gJ0RlYXRoQW5pbScpIHtcclxuICAgICAgICAgICAgdGhpcy5hY3RvclZhbHVlc05lZWRVcGRhdGUgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLCBcInNpbmdsZVBsYXllclNlcnZpY2VcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNpbmdsZVBsYXllclNlcnZpY2UpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBTZW5kSW5wdXRzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTZW5kSW5wdXRzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgdmVyaWZ5IH0gZnJvbSAnbm9kZTpjcnlwdG8nO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gJy4vY2xpZW50TGlzdGVuZXInO1xyXG5pbXBvcnQgeyBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tICcuL3NldHRpbmdzU2VydmljZSc7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSAnLi4vLi4vbG9nZ2luZyc7XHJcbnZhciBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUudmVyaWZ5U2VydmVySnMgPSBmdW5jdGlvbiAoc3JjKSB7XHJcbiAgICAgICAgaWYgKCFzcmMpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ0VtcHR5IHNlcnZlciBKUywgc2tpcHBpbmcgdmVyaWZpY2F0aW9uJyk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogc3JjLCBlcnJvcjogbnVsbCB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2V0dGluZ3NTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNldHRpbmdzU2VydmljZSk7XHJcbiAgICAgICAgdmFyIGdldFRhcmdldFBlZXJSZXN1bHQgPSBzZXR0aW5nc1NlcnZpY2UuZ2V0VGFyZ2V0UGVlcigpO1xyXG4gICAgICAgIGlmICghZ2V0VGFyZ2V0UGVlclJlc3VsdC50YXJnZXRQZWVyQ2FjaGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogbnVsbCwgZXJyb3I6ICd0YXJnZXQgcGVlciBub3QgcmVhZHknIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwdWJsaWNLZXlzID0gZ2V0VGFyZ2V0UGVlclJlc3VsdC50YXJnZXRQZWVyQ2FjaGVkLnB1YmxpY0tleXM7XHJcbiAgICAgICAgaWYgKCFwdWJsaWNLZXlzKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdObyBwdWJsaWMga2V5cyBjb25maWd1cmVkLCBza2lwcGluZyBzZXJ2ZXIgSlMgdmVyaWZpY2F0aW9uJyk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogc3JjLCBlcnJvcjogbnVsbCB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbGFzdExpbmVTdGFydCA9IHNyYy5sYXN0SW5kZXhPZignXFxuJykgKyAxO1xyXG4gICAgICAgIHZhciBzaWdQcmVmaXggPSAnLy8gc2t5bXA6c2lnOnk6JztcclxuICAgICAgICBpZiAobGFzdExpbmVTdGFydCA9PT0gMCB8fCAhc3JjLnN1YnN0cmluZyhsYXN0TGluZVN0YXJ0KS5zdGFydHNXaXRoKHNpZ1ByZWZpeCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBudWxsLCBlcnJvcjogJ25vIHNpZ25hdHVyZSBmb3VuZCcgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIF9hID0gc3JjLnN1YnN0cmluZyhsYXN0TGluZVN0YXJ0ICsgc2lnUHJlZml4Lmxlbmd0aCkuc3BsaXQoJzonKSwga2V5SWQgPSBfYVswXSwgc2lnID0gX2FbMV07XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzQWxwaGFOdW1lcmljKGtleUlkKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IG51bGwsIGVycm9yOiAnbWFsZm9ybWVkIGtleSBpZCcgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGtleSA9IHB1YmxpY0tleXNba2V5SWRdO1xyXG4gICAgICAgIGlmICgha2V5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogbnVsbCwgZXJyb3I6ICd1bmtub3duIGtleScgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRvVmVyaWZ5ID0gdGhpcy50b0FycmF5QnVmZmVyVmlldyhzcmMuc3Vic3RyaW5nKDAsIGxhc3RMaW5lU3RhcnQgLSAxKSwgJ3V0ZjgnKTtcclxuICAgICAgICBpZiAoIXZlcmlmeShudWxsLCB0b1ZlcmlmeSwga2V5LCB0aGlzLnRvQXJyYXlCdWZmZXJWaWV3KHNpZywgJ2Jhc2U2NCcpKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IG51bGwsIGVycm9yOiAnYmFkIHNpZ25hdHVyZScgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZXJ2ZXIgSlMgdmVyaWZpZWQgd2l0aCBrZXkgXCIuY29uY2F0KGtleUlkKSk7XHJcbiAgICAgICAgcmV0dXJuIHsgc3JjOiBzcmMsIGVycm9yOiBudWxsIH07XHJcbiAgICB9O1xyXG4gICAgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5pc0FscGhhTnVtZXJpYyA9IGZ1bmN0aW9uIChzdHIpIHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICB2YXIgY29kZSA9IHN0ci5jaGFyQ29kZUF0KGkpO1xyXG4gICAgICAgICAgICBpZiAoISgoOTcgPD0gY29kZSAmJiBjb2RlIDw9IDEyMikgfHxcclxuICAgICAgICAgICAgICAgICg2NSA8PSBjb2RlICYmIGNvZGUgPD0gOTApIHx8XHJcbiAgICAgICAgICAgICAgICAoNDggPD0gY29kZSAmJiBjb2RlIDw9IDU3KSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH07XHJcbiAgICBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnRvQXJyYXlCdWZmZXJWaWV3ID0gZnVuY3Rpb24gKHN0ciwgZW5jKSB7XHJcbiAgICAgICAgdmFyIGJ1ZiA9IEJ1ZmZlci5mcm9tKHN0ciwgZW5jKTtcclxuICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYnVmLmJ1ZmZlciwgYnVmLmJ5dGVPZmZzZXQsIGJ1Zi5ieXRlTGVuZ3RoKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIF9fYXNzaWduID0gKHRoaXMgJiYgdGhpcy5fX2Fzc2lnbikgfHwgZnVuY3Rpb24gKCkge1xyXG4gICAgX19hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uKHQpIHtcclxuICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHtcclxuICAgICAgICAgICAgcyA9IGFyZ3VtZW50c1tpXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKVxyXG4gICAgICAgICAgICAgICAgdFtwXSA9IHNbcF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0O1xyXG4gICAgfTtcclxuICAgIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbnZhciBfX2dlbmVyYXRvciA9ICh0aGlzICYmIHRoaXMuX19nZW5lcmF0b3IpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBib2R5KSB7XHJcbiAgICB2YXIgXyA9IHsgbGFiZWw6IDAsIHNlbnQ6IGZ1bmN0aW9uKCkgeyBpZiAodFswXSAmIDEpIHRocm93IHRbMV07IHJldHVybiB0WzFdOyB9LCB0cnlzOiBbXSwgb3BzOiBbXSB9LCBmLCB5LCB0LCBnO1xyXG4gICAgcmV0dXJuIGcgPSB7IG5leHQ6IHZlcmIoMCksIFwidGhyb3dcIjogdmVyYigxKSwgXCJyZXR1cm5cIjogdmVyYigyKSB9LCB0eXBlb2YgU3ltYm9sID09PSBcImZ1bmN0aW9uXCIgJiYgKGdbU3ltYm9sLml0ZXJhdG9yXSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSksIGc7XHJcbiAgICBmdW5jdGlvbiB2ZXJiKG4pIHsgcmV0dXJuIGZ1bmN0aW9uICh2KSB7IHJldHVybiBzdGVwKFtuLCB2XSk7IH07IH1cclxuICAgIGZ1bmN0aW9uIHN0ZXAob3ApIHtcclxuICAgICAgICBpZiAoZikgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkdlbmVyYXRvciBpcyBhbHJlYWR5IGV4ZWN1dGluZy5cIik7XHJcbiAgICAgICAgd2hpbGUgKGcgJiYgKGcgPSAwLCBvcFswXSAmJiAoXyA9IDApKSwgXykgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKGYgPSAxLCB5ICYmICh0ID0gb3BbMF0gJiAyID8geVtcInJldHVyblwiXSA6IG9wWzBdID8geVtcInRocm93XCJdIHx8ICgodCA9IHlbXCJyZXR1cm5cIl0pICYmIHQuY2FsbCh5KSwgMCkgOiB5Lm5leHQpICYmICEodCA9IHQuY2FsbCh5LCBvcFsxXSkpLmRvbmUpIHJldHVybiB0O1xyXG4gICAgICAgICAgICBpZiAoeSA9IDAsIHQpIG9wID0gW29wWzBdICYgMiwgdC52YWx1ZV07XHJcbiAgICAgICAgICAgIHN3aXRjaCAob3BbMF0pIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgMDogY2FzZSAxOiB0ID0gb3A7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA0OiBfLmxhYmVsKys7IHJldHVybiB7IHZhbHVlOiBvcFsxXSwgZG9uZTogZmFsc2UgfTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNTogXy5sYWJlbCsrOyB5ID0gb3BbMV07IG9wID0gWzBdOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNzogb3AgPSBfLm9wcy5wb3AoKTsgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEodCA9IF8udHJ5cywgdCA9IHQubGVuZ3RoID4gMCAmJiB0W3QubGVuZ3RoIC0gMV0pICYmIChvcFswXSA9PT0gNiB8fCBvcFswXSA9PT0gMikpIHsgXyA9IDA7IGNvbnRpbnVlOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSAzICYmICghdCB8fCAob3BbMV0gPiB0WzBdICYmIG9wWzFdIDwgdFszXSkpKSB7IF8ubGFiZWwgPSBvcFsxXTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDYgJiYgXy5sYWJlbCA8IHRbMV0pIHsgXy5sYWJlbCA9IHRbMV07IHQgPSBvcDsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodCAmJiBfLmxhYmVsIDwgdFsyXSkgeyBfLmxhYmVsID0gdFsyXTsgXy5vcHMucHVzaChvcCk7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRbMl0pIF8ub3BzLnBvcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgb3AgPSBib2R5LmNhbGwodGhpc0FyZywgXyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkgeyBvcCA9IFs2LCBlXTsgeSA9IDA7IH0gZmluYWxseSB7IGYgPSB0ID0gMDsgfVxyXG4gICAgICAgIGlmIChvcFswXSAmIDUpIHRocm93IG9wWzFdOyByZXR1cm4geyB2YWx1ZTogb3BbMF0gPyBvcFsxXSA6IHZvaWQgMCwgZG9uZTogdHJ1ZSB9O1xyXG4gICAgfVxyXG59O1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBwcmludENvbnNvbGUsIFV0aWxpdHkgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tIFwiLi9hdXRoU2VydmljZVwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFRpbWVyc1NlcnZpY2UgfSBmcm9tIFwiLi90aW1lcnNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIFNldHRpbmdzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTZXR0aW5nc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTZXR0aW5nc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMudGFyZ2V0UGVlckNhY2hlID0gbnVsbDtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLmdldFNlcnZlck1hc3RlcktleSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbWFzdGVyS2V5ID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJzZXJ2ZXItbWFzdGVyLWtleVwiXTtcclxuICAgICAgICBpZiAoIW1hc3RlcktleSkge1xyXG4gICAgICAgICAgICBtYXN0ZXJLZXkgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcIm1hc3Rlci1rZXlcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghbWFzdGVyS2V5KSB7XHJcbiAgICAgICAgICAgIG1hc3RlcktleSA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wic2VydmVyLWlwXCJdICsgXCI6XCIgKyB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcInNlcnZlci1wb3J0XCJdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbWFzdGVyS2V5O1xyXG4gICAgfTtcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUuZ2V0TWFzdGVyVXJsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVVybCh0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcIm1hc3RlclwiXSB8fCBcImh0dHBzOi8vZ2F0ZXdheS5za3ltcC5uZXRcIik7XHJcbiAgICB9O1xyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5tYWtlTWFzdGVyQXBpQ2xpZW50ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtYXN0ZXJBcGlCYXNlVXJsID0gdGhpcy5nZXRNYXN0ZXJVcmwoKTtcclxuICAgICAgICByZXR1cm4gbmV3IEh0dHBDbGllbnQobWFzdGVyQXBpQmFzZVVybCk7XHJcbiAgICB9O1xyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRUYXJnZXRQZWVyID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAodGhpcy50YXJnZXRQZWVyQ2FjaGUpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKHRoaXMudGFyZ2V0UGVlckNhY2hlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgdGFyZ2V0UGVlckNhY2hlZDogdGhpcy50YXJnZXRQZWVyQ2FjaGUgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5nZXRUYXJnZXRQZWVySW1wbChmdW5jdGlvbiAodGFyZ2V0UGVlcikge1xyXG4gICAgICAgICAgICBfdGhpcy50YXJnZXRQZWVyQ2FjaGUgPSB0YXJnZXRQZWVyO1xyXG4gICAgICAgICAgICBjYWxsYmFjayA9PT0gbnVsbCB8fCBjYWxsYmFjayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2FsbGJhY2sodGFyZ2V0UGVlcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHsgdGFyZ2V0UGVlckNhY2hlZDogbnVsbCB9O1xyXG4gICAgfTtcclxuICAgIC8vIGhhdmUgdG8gdXNlIGNhbGxiYWNrcyBoZXJlOiBwcm9taXNlcyBkb24ndCB3b3JrIGluIHRoZSBtYWluIG1lbnVcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUuZ2V0VGFyZ2V0UGVlckltcGwgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtYXN0ZXJBcGlDbGllbnQgPSB0aGlzLm1ha2VNYXN0ZXJBcGlDbGllbnQoKTtcclxuICAgICAgICB2YXIgbWFzdGVyS2V5ID0gdGhpcy5nZXRTZXJ2ZXJNYXN0ZXJLZXkoKTtcclxuICAgICAgICB2YXIgc2VydmVySW5mb1JlcXVlc3RUaW1lb3V0TXMgPSA1MDAwO1xyXG4gICAgICAgIHZhciBkZWZhdWx0UGVlciA9IHtcclxuICAgICAgICAgICAgaG9zdDogdGhpcy5zcC5zZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzZXJ2ZXItaXAnXSxcclxuICAgICAgICAgICAgcG9ydDogdGhpcy5zcC5zZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzZXJ2ZXItcG9ydCddLFxyXG4gICAgICAgICAgICBwdWJsaWNLZXlzOiB0aGlzLnNwLnNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3NlcnZlci1wdWJsaWMta2V5cyddLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdmFyIHJlc29sdmVkID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIHN0YXRlcyA9IHtcclxuICAgICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnNwLnNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3NlcnZlci1pbmZvLWlnbm9yZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCAnU2tpcHBpbmcgc2VydmVyaW5mbyByZXF1ZXN0IGR1ZSB0byBzZXJ2ZXItaW5mby1pZ25vcmUgaW4gY29uZmlnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlcy5yZXNvbHZlKGRlZmF1bHRQZWVyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFRpbWVyc1NlcnZpY2UpLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gc3RhdGVzLnJlamVjdChuZXcgRXJyb3IoJ2dldFRhcmdldFBlZXI6IHNlcnZlcmluZm8gcmVxdWVzdCB0aW1lZCBvdXQnKSk7IH0sIHNlcnZlckluZm9SZXF1ZXN0VGltZW91dE1zKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaGVhZGVycyA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzZXNzaW9uID0gKF9hID0gX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihBdXRoU2VydmljZSkucmVhZEF1dGhEYXRhRnJvbURpc2soKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNlc3Npb247XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1snWC1TZXNzaW9uJ10gPSBzZXNzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBtYXN0ZXJBcGlDbGllbnQuZ2V0KFwiL2FwaS9zZXJ2ZXJzL1wiLmNvbmNhdChtYXN0ZXJLZXksIFwiL3NlcnZlcmluZm9cIiksIHsgaGVhZGVyczogaGVhZGVycyB9LCBzdGF0ZXMuaGFuZGxlUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZXMucmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBoYW5kbGVSZXNwb25zZTogZnVuY3Rpb24gKHJlcykge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInN0YXR1cyBcIi5jb25jYXQocmVzLnN0YXR1cykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZXMucmVzb2x2ZShKU09OLnBhcnNlKHJlcy5ib2R5KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlcy5yZWplY3QoZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uICh0YXJnZXRQZWVyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJSZXNvbHZlZCB0YXJnZXQgcGVlclwiLCB0YXJnZXRQZWVyKTtcclxuICAgICAgICAgICAgICAgIHZhciBlbnJpY2hlZFRhcmdldFBlZXIgPSBfX2Fzc2lnbih7fSwgdGFyZ2V0UGVlcik7XHJcbiAgICAgICAgICAgICAgICBlbnJpY2hlZFRhcmdldFBlZXIucHVibGljS2V5cyA9IF9fYXNzaWduKF9fYXNzaWduKHt9LCBkZWZhdWx0UGVlci5wdWJsaWNLZXlzKSwgdGFyZ2V0UGVlci5wdWJsaWNLZXlzKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkVucmljaGVkIHRhcmdldCBwZWVyXCIsIGVucmljaGVkVGFyZ2V0UGVlcik7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlbnJpY2hlZFRhcmdldFBlZXIpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlNlcnZlciBpbmZvIHJlcXVlc3QgZmFpbGVkLCBmYWxsaW5nIGJhY2sgdG9cIiwgZGVmYXVsdFBlZXIsIFwiOyBlcnJvcjpcIiwgZXJyKTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRlZmF1bHRQZWVyKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHN0YXRlcy5zdGFydCgpO1xyXG4gICAgfTtcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUuZ2V0U2VydmVyTW9kcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBtYXN0ZXJBcGlDbGllbnQsIG1hc3RlcktleSwgYXR0ZW1wdCwgcmVzLCBtYW5pZmVzdCwgZV8xO1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXN0ZXJBcGlDbGllbnQgPSB0aGlzLm1ha2VNYXN0ZXJBcGlDbGllbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFzdGVyS2V5ID0gdGhpcy5nZXRTZXJ2ZXJNYXN0ZXJLZXkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKG1hc3RlcktleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF0dGVtcHQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5sYWJlbCA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShhdHRlbXB0IDwgNSkpIHJldHVybiBbMyAvKmJyZWFrKi8sIDddO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5sYWJlbCA9IDI7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS50cnlzLnB1c2goWzIsIDQsICwgNl0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJUcnlpbmcgdG8gZ2V0IHNlcnZlciBtb2RzLCBhdHRlbXB0IFwiLmNvbmNhdChhdHRlbXB0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIG1hc3RlckFwaUNsaWVudC5nZXQoXCIvYXBpL3NlcnZlcnMvXCIuY29uY2F0KG1hc3RlcktleSwgXCIvbWFuaWZlc3QuanNvblwiKSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1cyAhPSAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInN0YXR1cyBjb2RlIFwiLmNvbmNhdChyZXMuc3RhdHVzLCBcIiwgZXJyb3IgXCIpLmNvbmNhdChyZXMuZXJyb3IpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYW5pZmVzdCA9IEpTT04ucGFyc2UocmVzLmJvZHkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFuaWZlc3QudmVyc2lvbk1ham9yICE9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJzZXJ2ZXIgbWFuaWZlc3QgdmVyc2lvbiBpcyBcIi5jb25jYXQobWFuaWZlc3QudmVyc2lvbk1ham9yLCBcIiwgd2UgZXhwZWN0IDFcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi8sIFtdXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qLywgbWFuaWZlc3QubW9kc107XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlXzEgPSBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlJlcXVlc3QvcGFyc2UgZXJyb3I6IFwiLmNvbmNhdChlXzEpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgVXRpbGl0eS53YWl0KDAuMSArIE1hdGgucmFuZG9tKCkpXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgNl07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA2OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICArK2F0dGVtcHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNzogcmV0dXJuIFsyIC8qcmV0dXJuKi8sIFtdXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRTZXJ2ZXJQb3J0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIFJldHVybiB0aGUgc2VydmVyIHBvcnQgZnJvbSBzZXR0aW5nc1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNwLnNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3NlcnZlci1wb3J0J10gfHwgNzc3NztcclxuICAgIH07XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLm5vcm1hbGl6ZVVybCA9IGZ1bmN0aW9uICh1cmwpIHtcclxuICAgICAgICBpZiAodXJsLmVuZHNXaXRoKCcvJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVybC5zbGljZSgwLCB1cmwubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1cmw7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgcmV0dXJuIFNldHRpbmdzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTZXR0aW5nc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTmV0d29ya2luZ1NlcnZpY2UgfSBmcm9tIFwiLi9uZXR3b3JraW5nU2VydmljZVwiO1xyXG52YXIgU2luZ2xlUGxheWVyU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTaW5nbGVQbGF5ZXJTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU2luZ2xlUGxheWVyU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5faXNTaW5nbGVQbGF5ZXIgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJnYW1lTG9hZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25HYW1lTG9hZChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNpbmdsZVBsYXllclNlcnZpY2UucHJvdG90eXBlLCBcImlzU2luZ2xlUGxheWVyXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2lzU2luZ2xlUGxheWVyO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIFNpbmdsZVBsYXllclNlcnZpY2UucHJvdG90eXBlLm9uR2FtZUxvYWQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICBpZiAoIWV2ZW50LmlzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybSAmJiAhdGhpcy5faXNTaW5nbGVQbGF5ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5EZWJ1Zy5tZXNzYWdlQm94KCdTYXZlIGhhcyBiZWVuIGxvYWRlZCBpbiBtdWx0aXBsYXllciwgc3dpdGNoaW5nIHRvIHRoZSBzaW5nbGUtcGxheWVyIG1vZGUnKTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICB0aGlzLl9pc1NpbmdsZVBsYXllciA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuR2FtZS5zZXRJbkNoYXJnZW4oZmFsc2UsIGZhbHNlLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBTaW5nbGVQbGF5ZXJTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNpbmdsZVBsYXllclNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IHByaW50Q29uc29sZSwgc2V0dGluZ3MsIHN0b3JhZ2UsIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5pbXBvcnQgKiBhcyBuZXR3b3JraW5nIGZyb20gJy4vbmV0d29ya2luZ1NlcnZpY2UnO1xyXG5pbXBvcnQgeyBzZXR1cEhvb2tzIH0gZnJvbSAnLi4vLi4vc3luYy9hbmltYXRpb24nO1xyXG5pbXBvcnQgeyBhdXRoR2FtZURhdGFTdG9yYWdlS2V5IH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvYXV0aE1vZGVsJztcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tICcuL2NsaWVudExpc3RlbmVyJztcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tICcuLi8uLi9sb2dnaW5nJztcclxuaW1wb3J0IHsgU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSAnLi9zZXR0aW5nc1NlcnZpY2UnO1xyXG5wcmludENvbnNvbGUoJ0hlbGxvIE11bHRpcGxheWVyIScpO1xyXG5wcmludENvbnNvbGUoJ3NldHRpbmdzOicsIHNldHRpbmdzWydza3ltcDUtY2xpZW50J10pO1xyXG52YXIgU2t5bXBDbGllbnQgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU2t5bXBDbGllbnQsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTa3ltcENsaWVudChzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjb25uZWN0aW9uRmFpbGVkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNvbm5lY3Rpb25GYWlsZWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNvbm5lY3Rpb25EZW5pZWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ29ubmVjdGlvbkRlbmllZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkFjdG9yQ3JlYXRlTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgLy8gVE9ETzogcmVmYWN0b3Igb3V0IHZlcnkgc2ltaWxhciBjb2RlIGluIGZyb250SG90UmVsb2FkU2VydmljZS50c1xyXG4gICAgICAgIHZhciBhdXRoR2FtZURhdGEgPSBzdG9yYWdlW2F1dGhHYW1lRGF0YVN0b3JhZ2VLZXldO1xyXG4gICAgICAgIHZhciBzdG9yYWdlSGFzVmFsaWRBdXRoR2FtZURhdGEgPSAoYXV0aEdhbWVEYXRhID09PSBudWxsIHx8IGF1dGhHYW1lRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aEdhbWVEYXRhLmxvY2FsKSB8fCAoYXV0aEdhbWVEYXRhID09PSBudWxsIHx8IGF1dGhHYW1lRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aEdhbWVEYXRhLnJlbW90ZSk7XHJcbiAgICAgICAgaWYgKHN0b3JhZ2VIYXNWYWxpZEF1dGhHYW1lRGF0YSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJSZWNvdmVyZWQgQXV0aEdhbWVEYXRhIGZyb20gc3RvcmFnZSwgc3RhcnRpbmcgY2xpZW50XCIpO1xyXG4gICAgICAgICAgICBfdGhpcy5zdGFydENsaWVudCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiVW5hYmxlIHRvIHJlY292ZXIgQXV0aEdhbWVEYXRhIGZyb20gc3RvcmFnZSwgcmVxdWVzdGluZyBhdXRoXCIpO1xyXG4gICAgICAgICAgICAvLyBOZXh0IHRpY2sgYmVjYXVzZSB3ZSdyZSBpbiBjb25zdHJ1Y3RvciBvZiB0aGUgc2VydmljZSwgQXV0aFNlcnZpY2UgbWF5IG5vdCBiZSBsaXN0ZW5pbmcgZXZlbnRzIHlldFxyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYXV0aE5lZWRlZFwiLCB7fSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJhdXRoQXR0ZW1wdFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BdXRoQXR0ZW1wdChlKTsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5vbkF1dGhBdHRlbXB0ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNhdWdodCBhdXRoIGV2ZW50XCIpO1xyXG4gICAgICAgIHN0b3JhZ2VbYXV0aEdhbWVEYXRhU3RvcmFnZUtleV0gPSBlLmF1dGhHYW1lRGF0YTtcclxuICAgICAgICB0aGlzLnN0YXJ0Q2xpZW50KCk7XHJcbiAgICAgICAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgd2hlbiB5b3Ugd2lsbCBiZSBhYmxlIHRvIHNlZSBlcnJvcnMgd2l0aG91dCBjb25zb2xlXHJcbiAgICAgICAgLy8gdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQoZmFsc2UpO1xyXG4gICAgfTtcclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5vbkFjdG9yQ3JlYXRlTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKGUubWVzc2FnZS5pc01lKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLm9uQ29ubmVjdGlvbkZhaWxlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDb25uZWN0aW9uIGZhaWxlZFwiKTtcclxuICAgIH07XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUub25Db25uZWN0aW9uRGVuaWVkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNvbm5lY3Rpb24gZGVuaWVkOiBcIiArIGUuZXJyb3IpO1xyXG4gICAgfTtcclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5zdGFydENsaWVudCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIC8vIG9uY2UoXCJ0aWNrXCIsIC4uLikgaXMgbmVlZGVkIHRvIGVuc3VyZSBuZXR3b3JraW5nIHNlcnZpY2UgaW5pdGlhbGl6ZWRcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuZXN0YWJsaXNoQ29ubmVjdGlvbkNvbmRpdGlvbmFsKCk7IH0pO1xyXG4gICAgICAgIHRoaXMuY3RvcigpO1xyXG4gICAgfTtcclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5jdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIFRPRE86IHJlZmFjdG9yIGludG8gc2VydmljZVxyXG4gICAgICAgIHNldHVwSG9va3MoKTtcclxuICAgICAgICB0aGlzLnNwLnByaW50Q29uc29sZSgnU2t5bXBDbGllbnQgY3RvcicpO1xyXG4gICAgfTtcclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5lc3RhYmxpc2hDb25uZWN0aW9uQ29uZGl0aW9uYWwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgaXNDb25uZWN0ZWQgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIobmV0d29ya2luZy5OZXR3b3JraW5nU2VydmljZSkuaXNDb25uZWN0ZWQoKTtcclxuICAgICAgICBpZiAoaXNDb25uZWN0ZWQpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1JlY29ubmVjdCBpcyBub3QgcmVxdWlyZWQnKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2V0dGluZ3NTZXJ2aWNlKS5nZXRUYXJnZXRQZWVyKGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICB2YXIgaG9zdCA9IF9hLmhvc3QsIHBvcnQgPSBfYS5wb3J0O1xyXG4gICAgICAgICAgICBzdG9yYWdlLnRhcmdldElwID0gaG9zdDtcclxuICAgICAgICAgICAgc3RvcmFnZS50YXJnZXRQb3J0ID0gcG9ydDtcclxuICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiQ29ubmVjdGluZyB0byBcIi5jb25jYXQoaG9zdCwgXCI6XCIpLmNvbmNhdChwb3J0KSk7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIobmV0d29ya2luZy5OZXR3b3JraW5nU2VydmljZSkuY29ubmVjdChob3N0LCBwb3J0KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU2t5bXBDbGllbnQ7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU2t5bXBDbGllbnQgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxudmFyIF9fZ2VuZXJhdG9yID0gKHRoaXMgJiYgdGhpcy5fX2dlbmVyYXRvcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIGJvZHkpIHtcclxuICAgIHZhciBfID0geyBsYWJlbDogMCwgc2VudDogZnVuY3Rpb24oKSB7IGlmICh0WzBdICYgMSkgdGhyb3cgdFsxXTsgcmV0dXJuIHRbMV07IH0sIHRyeXM6IFtdLCBvcHM6IFtdIH0sIGYsIHksIHQsIGc7XHJcbiAgICByZXR1cm4gZyA9IHsgbmV4dDogdmVyYigwKSwgXCJ0aHJvd1wiOiB2ZXJiKDEpLCBcInJldHVyblwiOiB2ZXJiKDIpIH0sIHR5cGVvZiBTeW1ib2wgPT09IFwiZnVuY3Rpb25cIiAmJiAoZ1tTeW1ib2wuaXRlcmF0b3JdID0gZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KSwgZztcclxuICAgIGZ1bmN0aW9uIHZlcmIobikgeyByZXR1cm4gZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHN0ZXAoW24sIHZdKTsgfTsgfVxyXG4gICAgZnVuY3Rpb24gc3RlcChvcCkge1xyXG4gICAgICAgIGlmIChmKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiR2VuZXJhdG9yIGlzIGFscmVhZHkgZXhlY3V0aW5nLlwiKTtcclxuICAgICAgICB3aGlsZSAoZyAmJiAoZyA9IDAsIG9wWzBdICYmIChfID0gMCkpLCBfKSB0cnkge1xyXG4gICAgICAgICAgICBpZiAoZiA9IDEsIHkgJiYgKHQgPSBvcFswXSAmIDIgPyB5W1wicmV0dXJuXCJdIDogb3BbMF0gPyB5W1widGhyb3dcIl0gfHwgKCh0ID0geVtcInJldHVyblwiXSkgJiYgdC5jYWxsKHkpLCAwKSA6IHkubmV4dCkgJiYgISh0ID0gdC5jYWxsKHksIG9wWzFdKSkuZG9uZSkgcmV0dXJuIHQ7XHJcbiAgICAgICAgICAgIGlmICh5ID0gMCwgdCkgb3AgPSBbb3BbMF0gJiAyLCB0LnZhbHVlXTtcclxuICAgICAgICAgICAgc3dpdGNoIChvcFswXSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAwOiBjYXNlIDE6IHQgPSBvcDsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDQ6IF8ubGFiZWwrKzsgcmV0dXJuIHsgdmFsdWU6IG9wWzFdLCBkb25lOiBmYWxzZSB9O1xyXG4gICAgICAgICAgICAgICAgY2FzZSA1OiBfLmxhYmVsKys7IHkgPSBvcFsxXTsgb3AgPSBbMF07IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA3OiBvcCA9IF8ub3BzLnBvcCgpOyBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISh0ID0gXy50cnlzLCB0ID0gdC5sZW5ndGggPiAwICYmIHRbdC5sZW5ndGggLSAxXSkgJiYgKG9wWzBdID09PSA2IHx8IG9wWzBdID09PSAyKSkgeyBfID0gMDsgY29udGludWU7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDMgJiYgKCF0IHx8IChvcFsxXSA+IHRbMF0gJiYgb3BbMV0gPCB0WzNdKSkpIHsgXy5sYWJlbCA9IG9wWzFdOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gNiAmJiBfLmxhYmVsIDwgdFsxXSkgeyBfLmxhYmVsID0gdFsxXTsgdCA9IG9wOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0ICYmIF8ubGFiZWwgPCB0WzJdKSB7IF8ubGFiZWwgPSB0WzJdOyBfLm9wcy5wdXNoKG9wKTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodFsyXSkgXy5vcHMucG9wKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcCA9IGJvZHkuY2FsbCh0aGlzQXJnLCBfKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7IG9wID0gWzYsIGVdOyB5ID0gMDsgfSBmaW5hbGx5IHsgZiA9IHQgPSAwOyB9XHJcbiAgICAgICAgaWYgKG9wWzBdICYgNSkgdGhyb3cgb3BbMV07IHJldHVybiB7IHZhbHVlOiBvcFswXSA/IG9wWzFdIDogdm9pZCAwLCBkb25lOiB0cnVlIH07XHJcbiAgICB9XHJcbn07XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG4vLyBUT0RPOiByZWZhY3RvciB3b3JsZFZpZXdNaXNjIGludG8gc2VydmljZVxyXG5pbXBvcnQgeyByZW1vdGVJZFRvTG9jYWxJZCB9IGZyb20gJy4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzYyc7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IFdvcmxkVmlldyB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld1wiO1xyXG52YXIgU3BTbmlwcGV0U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTcFNuaXBwZXRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3BTbmlwcGV0U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzcFNuaXBwZXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNwU25pcHBldE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLnNwQW55ID0gc3A7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3BTbmlwcGV0U2VydmljZS5wcm90b3R5cGUub25TcFNuaXBwZXRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkgeyByZXR1cm4gX19hd2FpdGVyKF90aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJ1bihtc2cpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpc05vUmVzdWx0U25pcHBldCA9IG1zZy5zbmlwcGV0SWR4ID09PSAweGZmZmZmZmZmO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc05vUmVzdWx0U25pcHBldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXMgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzICE9PSBudWxsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHR5cGVvZiByZXMgIT09IFwibnVtYmVyXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgdHlwZW9mIHJlcyAhPT0gXCJzdHJpbmdcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiB0eXBlb2YgcmVzICE9PSBcImJvb2xlYW5cIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJVbnN1cHBvcnRlZCBTcFNuaXBwZXQgcmVzdWx0IHR5cGUgJ1wiLmNvbmNhdCh0eXBlb2YgcmVzLCBcIidcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gcmVzID09PSBudWxsID8ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkZpbmlzaFNwU25pcHBldCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc25pcHBldElkeDogbXNnLnNuaXBwZXRJZHhcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5GaW5pc2hTcFNuaXBwZXQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZTogcmVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc25pcHBldElkeDogbXNnLnNuaXBwZXRJZHgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsICdTcFNuaXBwZXQgJyArIG1zZy5jbGFzcyArICcgJyArIG1zZy5mdW5jdGlvbiArICcgZmFpbGVkICcgKyBlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTsgfSk7XHJcbiAgICB9O1xyXG4gICAgU3BTbmlwcGV0U2VydmljZS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKHNuaXBwZXQpIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgZnVuY3Rpb25Mb3dlckNhc2UsIGNsYXNzTG93ZXJDYXNlLCBuZXdOYW1lLCBzZWxmSWQsIHNlbGYsIHJlcGxhY2VWYWx1ZSwgd29ybGRWaWV3XzEsIGZvcm0sIHNpZ24sIGNvdW50LCBzb3VuZElkLCBzb3VuZCwgbmFtZSwgbmFtZTtcclxuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYikge1xyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb25Mb3dlckNhc2UgPSBzbmlwcGV0LmZ1bmN0aW9uLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICBjbGFzc0xvd2VyQ2FzZSA9IHNuaXBwZXQuY2xhc3MudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgIC8vIGtlZXAgaW4gc3luYyB3aXRoIHJlbW90ZVNlcnZlci50c1xyXG4gICAgICAgICAgICAgICAgaWYgKGNsYXNzTG93ZXJDYXNlID09PSBcIm9iamVjdHJlZmVyZW5jZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZ1bmN0aW9uTG93ZXJDYXNlID09PSBcInNldGRpc3BsYXluYW1lXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmFtZSA9IHNuaXBwZXQuYXJndW1lbnRzWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld05hbWUgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGZJZCA9IHJlbW90ZUlkVG9Mb2NhbElkKHNuaXBwZXQuc2VsZklkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzLnNwLk9iamVjdFJlZmVyZW5jZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoc2VsZklkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlVmFsdWUgPSAoX2EgPSBzZWxmID09PSBudWxsIHx8IHNlbGYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlbGYuZ2V0QmFzZU9iamVjdCgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0TmFtZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2VWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmFtZSA9IG5ld05hbWUucmVwbGFjZSgvJW9yaWdpbmFsX25hbWUlL2csIHJlcGxhY2VWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc25pcHBldC5hcmd1bWVudHNbMF0gPSBuZXdOYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJDb3VsZG4ndCBnZXQgYSByZXBsYWNlVmFsdWUgZm9yIFNldERpc3BsYXlOYW1lLCBzbmlwcGV0LnNlbGZJZCB3YXNcIiwgc25pcHBldC5zZWxmSWQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRW5jb3VudGVyZWQgU2V0RGlzcGxheU5hbWUgd2l0aCBub24tc3RyaW5nIGFyZ3VtZW50XCIsIG5ld05hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGNsYXNzTG93ZXJDYXNlID09PSBcImdhbWVcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmdW5jdGlvbkxvd2VyQ2FzZSA9PT0gXCJzaG93cmFjZW1lbnVcIiB8fCBmdW5jdGlvbkxvd2VyQ2FzZSA9PT0gXCJzaG93bGltaXRlZHJhY2VtZW51XCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJzaG93cmFjZW1lbnUgY2FsbGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JsZFZpZXdfMSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihXb3JsZFZpZXcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JsZFZpZXdfMS5zZXRGb3JtVmlld1VwZGF0ZUFsbG93ZWQoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIldhaXRpbmcgMS4wcyBiZWZvcmUgY2FsbGluZyBzaG93cmFjZW1lbnVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KDEuMCkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5ydW5TdGF0aWMoc25pcHBldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JsZFZpZXdfMS53YWl0R2FtZVRpbWVBbmRBbGxvd0Zvcm1WaWV3VXBkYXRlKDEuMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGNsYXNzTG93ZXJDYXNlID09PSBcInNreW1waGFja3NcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmdW5jdGlvbkxvd2VyQ2FzZSA9PT0gXCJhZGRpdGVtXCIgfHwgZnVuY3Rpb25Mb3dlckNhc2UgPT09IFwicmVtb3ZlaXRlbVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0gPSB0aGlzLnNwLkZvcm0uZnJvbSh0aGlzLmRlc2VyaWFsaXplQXJnKHNuaXBwZXQuYXJndW1lbnRzWzBdKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3JtID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIlVuYWJsZSB0byBmaW5kIGZvcm0gd2l0aCBpZCBcIiArIHNuaXBwZXQuYXJndW1lbnRzWzBdLmZvcm1JZC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpZ24gPSBzbmlwcGV0LmZ1bmN0aW9uID09PSBcIkFkZEl0ZW1cIiA/IFwiK1wiIDogXCItXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ID0gc25pcHBldC5hcmd1bWVudHNbMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvdW5kSWQgPSAweDMzNGFiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybS5nZXRGb3JtSUQoKSAhPT0gMHhmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VuZElkID0gMHgxNDExNTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VuZCA9IHRoaXMuc3AuU291bmQuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHNvdW5kSWQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNvdW5kICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gZm9ybS5nZXROYW1lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZS50cmltKCkgPT09IFwiXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNvdW5kIHdpbGwgbm90IGJlIHBsYXllZCBiZWNhdXNlIGl0ZW0gaGFzIG5vIG5hbWVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VuZC5wbGF5KHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIlVuYWJsZSB0byBmaW5kIHNvdW5kIHdpdGggaWQgXCIgKyBzb3VuZElkLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50IDw9IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiUG9zaXRpdmUgY291bnQgZXhwZWN0ZWQsIGdvdCBcIiArIGNvdW50LnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IGZvcm0uZ2V0TmFtZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUudHJpbSgpID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJOb3RpZmljYXRpb24gd2lsbCBub3QgYmUgc2hvd24gYmVjYXVzZSBpdGVtIGhhcyBubyBuYW1lXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcC5EZWJ1Zy5ub3RpZmljYXRpb24oc2lnbiArIFwiIFwiICsgbmFtZSArIFwiIChcIiArIGNvdW50ICsgXCIpXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgc2lnbiArIFwiIFwiICsgbmFtZSArIFwiIChcIiArIGNvdW50ICsgXCIpXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5rbm93biBTa3ltcEhhY2sgLSBcIiArIHNuaXBwZXQuZnVuY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovLCBzbmlwcGV0LnNlbGZJZCA/IHRoaXMucnVuTWV0aG9kKHNuaXBwZXQpIDogdGhpcy5ydW5TdGF0aWMoc25pcHBldCldO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBTcFNuaXBwZXRTZXJ2aWNlLnByb3RvdHlwZS5kZXNlcmlhbGl6ZUFyZyA9IGZ1bmN0aW9uIChhcmcpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICB2YXIgZm9ybUlkID0gcmVtb3RlSWRUb0xvY2FsSWQoYXJnLmZvcm1JZCk7XHJcbiAgICAgICAgICAgIHZhciBmb3JtID0gdGhpcy5zcC5HYW1lLmdldEZvcm1FeChmb3JtSWQpO1xyXG4gICAgICAgICAgICB2YXIgY2wgPSB0aGlzLnNwQW55W2FyZy50eXBlXTtcclxuICAgICAgICAgICAgaWYgKCFjbCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoaW5nS2V5ID0gT2JqZWN0LmtleXModGhpcy5zcEFueSkuZmluZChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleS50b0xvd2VyQ2FzZSgpID09PSBhcmcudHlwZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbCA9IHRoaXMuc3BBbnlbbWF0Y2hpbmdLZXldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghY2wpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImRlc2VyaWFsaXplQXJnIC0gQ2xhc3MgXCIuY29uY2F0KGFyZy50eXBlLCBcIiBub3QgZm91bmRcIikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBnYW1lT2JqZWN0ID0gY2wuZnJvbShmb3JtKTtcclxuICAgICAgICAgICAgcmV0dXJuIGdhbWVPYmplY3Q7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBhcmc7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgU3BTbmlwcGV0U2VydmljZS5wcm90b3R5cGUucnVuTWV0aG9kID0gZnVuY3Rpb24gKHNuaXBwZXQpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBzZWxmSWQsIHNlbGYsIGNsLCBtYXRjaGluZ0tleSwgc2VsZkNhc3RlZCwgZjtcclxuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZklkID0gcmVtb3RlSWRUb0xvY2FsSWQoc25pcHBldC5zZWxmSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmID0gdGhpcy5zcC5HYW1lLmdldEZvcm1FeChzZWxmSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGYpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gZmluZCBmb3JtIHdpdGggaWQgXCIuY29uY2F0KHNlbGZJZC50b1N0cmluZygxNikpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2wgPSB0aGlzLnNwQW55W3NuaXBwZXQuY2xhc3NdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGluZ0tleSA9IE9iamVjdC5rZXlzKHRoaXMuc3BBbnkpLmZpbmQoZnVuY3Rpb24gKGtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXkudG9Mb3dlckNhc2UoKSA9PT0gc25pcHBldC5jbGFzcy50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbCA9IHRoaXMuc3BBbnlbbWF0Y2hpbmdLZXldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2wpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInJ1bk1ldGhvZCAtIENsYXNzIFwiLmNvbmNhdChzbmlwcGV0LmNsYXNzLCBcIiBub3QgZm91bmQsIGZvdW5kXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmQ2FzdGVkID0gY2wuZnJvbShzZWxmKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWxmQ2FzdGVkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRm9ybSBcIi5jb25jYXQoc2VsZklkLnRvU3RyaW5nKDE2KSwgXCIgaXMgbm90IGluc3RhbmNlIG9mIFwiKS5jb25jYXQoc25pcHBldC5jbGFzcywgXCIsIGZvcm0gdHlwZSBpcyBcIikuY29uY2F0KHNlbGYuZ2V0VHlwZSgpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBzZWxmQ2FzdGVkW3NuaXBwZXQuZnVuY3Rpb25dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBmLmFwcGx5KHNlbGZDYXN0ZWQsIHNuaXBwZXQuYXJndW1lbnRzLm1hcChmdW5jdGlvbiAoYXJnKSB7IHJldHVybiBfdGhpcy5kZXNlcmlhbGl6ZUFyZyhhcmcpOyB9KSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTogcmV0dXJuIFsyIC8qcmV0dXJuKi8sIF9hLnNlbnQoKV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFNwU25pcHBldFNlcnZpY2UucHJvdG90eXBlLnJ1blN0YXRpYyA9IGZ1bmN0aW9uIChzbmlwcGV0KSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcGFweXJ1c0NsYXNzO1xyXG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXB5cnVzQ2xhc3MgPSB0aGlzLnNwQW55W3NuaXBwZXQuY2xhc3NdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBwYXB5cnVzQ2xhc3Nbc25pcHBldC5mdW5jdGlvbl0uYXBwbHkocGFweXJ1c0NsYXNzLCBzbmlwcGV0LmFyZ3VtZW50cy5tYXAoZnVuY3Rpb24gKGFyZykgeyByZXR1cm4gX3RoaXMuZGVzZXJpYWxpemVBcmcoYXJnKTsgfSkpXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBbMiAvKnJldHVybiovLCBfYS5zZW50KCldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICByZXR1cm4gU3BTbmlwcGV0U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTcFNuaXBwZXRTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IHJlcXVpcmVkVmVyc2lvbiB9IGZyb20gXCIuLi8uLi92ZXJzaW9uXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIFNwVmVyc2lvbkNoZWNrU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTcFZlcnNpb25DaGVja1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTcFZlcnNpb25DaGVja1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHJlYWxWZXJzaW9uID0gdGhpcy5zcC5nZXRQbGF0Zm9ybVZlcnNpb24oKTtcclxuICAgICAgICBpZiAoIXJlcXVpcmVkVmVyc2lvbi5pbmNsdWRlcyhyZWFsVmVyc2lvbikpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5EZWJ1Zy5tZXNzYWdlQm94KFwiWW91IG5lZWQgdG8gaGF2ZSBvbiBvZiB0aG9zZSBTa3lyaW1QbGF0Zm9ybSB2ZXJzaW9ucyBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkocmVxdWlyZWRWZXJzaW9uKSwgXCIgdG8gam9pbiB0aGlzIHNlcnZlci4gWW91ciBjdXJyZW50IHZlcnNpb24gaXMgXCIpLmNvbmNhdChyZWFsVmVyc2lvbikpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdE1lbnVNb2RlKDAuNSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFfdGhpcy5zcC5VaS5pc01lbnVPcGVuKCdNZXNzYWdlQm94TWVudScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUucXVpdFRvTWFpbk1lbnUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBTcFZlcnNpb25DaGVja1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIHBsYXllcklkID0gMHgxNDtcclxuLy8gZXggQW5pbURlYnVnU2VydmljZSBwYXJ0XHJcbnZhciBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmN1cnJlbnRBbmltID0gbnVsbDtcclxuICAgICAgICBfdGhpcy5zdG9wQW5pbUluUHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5leGl0QW5pbU5hbWUgPSBudWxsO1xyXG4gICAgICAgIF90aGlzLmludGVycnVwdEFuaW1OYW1lID0gbnVsbDtcclxuICAgICAgICBfdGhpcy50cnlJbnZva2VBbmltQ291bnQgPSAwO1xyXG4gICAgICAgIF90aGlzLmxhc3ROb3RpZmljYXRpb25Nb21lbnQgPSAwO1xyXG4gICAgICAgIF90aGlzLnRyeUludm9rZUFuaW1Db3VudE1heCA9IDEwMDAwMDAwMDA7XHJcbiAgICAgICAgX3RoaXMuZXhpdEFuaW1FdmVudCA9IHVuZGVmaW5lZDtcclxuICAgICAgICBfdGhpcy5vcHRpb25zQ2FjaGUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgX3RoaXMub3B0aW9uQ2IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgX3RoaXMudXNlUGxheWVyQ29udHJvbHNEZWxheU1zID0gdHJ1ZTtcclxuICAgICAgICB2YXIgaGFzU3dlZXRQaWUgPSBfdGhpcy5oYXNTd2VldFBpZSgpO1xyXG4gICAgICAgIGlmICghaGFzU3dlZXRQaWUpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBkaXNhYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZW5hYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMuc2V0dGluZ3MgPSBfdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJhbmltRGVidWdcIl07XHJcbiAgICAgICAgaWYgKGhhc1N3ZWV0UGllKSB7XHJcbiAgICAgICAgICAgIHZhciBzZWxmXzEgPSBfdGhpcztcclxuICAgICAgICAgICAgX3RoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkgeyB9LFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmXzEub25TZW5kQW5pbWF0aW9uRXZlbnRMZWF2ZShjdHgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGZfMS5vblNlbmRFeGl0QW5pbWF0aW9uRXZlbnRMZWF2ZShjdHgpOyAvLyBUcmFja2luZyB0aGUgc3VjY2Vzc2Z1bCBsYXVuY2ggb2YgdGhlIGV4aXQgYW5pbWF0aW9uXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9LCBwbGF5ZXJJZCwgcGxheWVySWQpO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwiYnV0dG9uRXZlbnRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQnV0dG9uRXZlbnQoZSk7IH0pO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjdXN0b21QYWNrZXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkN1c3RvbVBhY2tldE1lc3NhZ2UyKGUpOyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLm9uQ3VzdG9tUGFja2V0TWVzc2FnZTIgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSB7fTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb250ZW50ID0gSlNPTi5wYXJzZShlLm1lc3NhZ2UuY29udGVudEpzb25EdW1wKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRmFpbGVkIHRvIHBhcnNlIGN1c3RvbSBwYWNrZXQgY29udGVudEpzb25EdW1wOlwiLCBlLm1lc3NhZ2UuY29udGVudEpzb25EdW1wLCBcIkVycm9yOlwiLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvbnRlbnRbXCJjdXN0b21QYWNrZXRUeXBlXCJdICE9PSBcImludm9rZUFuaW1cIikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgY3VzdG9tIHBhY2tldCB3aXRoIGN1c3RvbVBhY2tldFR5cGUgaW52b2tlQW5pbVwiKTtcclxuICAgICAgICB2YXIgbmFtZSA9IGNvbnRlbnRbXCJhbmltRXZlbnROYW1lXCJdO1xyXG4gICAgICAgIHZhciByZXF1ZXN0SWQgPSBjb250ZW50W1wicmVxdWVzdElkXCJdO1xyXG4gICAgICAgIHZhciB3ZWFwb25EcmF3bkFsbG93ZWQgPSBjb250ZW50W1wid2VhcG9uRHJhd25BbGxvd2VkXCJdO1xyXG4gICAgICAgIHZhciBmdXJuaXR1cmVBbGxvd2VkID0gY29udGVudFtcImZ1cm5pdHVyZUFsbG93ZWRcIl07XHJcbiAgICAgICAgdmFyIGV4aXRBbmltTmFtZSA9IGNvbnRlbnRbXCJleGl0QW5pbU5hbWVcIl07XHJcbiAgICAgICAgdmFyIGludGVycnVwdEFuaW1OYW1lID0gY29udGVudFtcImludGVycnVwdEFuaW1OYW1lXCJdO1xyXG4gICAgICAgIHZhciB0aW1lTXMgPSBjb250ZW50W1widGltZU1zXCJdO1xyXG4gICAgICAgIHZhciBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkID0gY29udGVudFtcImlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWRcIl07XHJcbiAgICAgICAgdmFyIHBhcmVudEFuaW1FdmVudE5hbWUgPSBjb250ZW50W1wicGFyZW50QW5pbUV2ZW50TmFtZVwiXTtcclxuICAgICAgICB2YXIgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zID0gY29udGVudFtcImVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNc1wiXTtcclxuICAgICAgICB2YXIgcHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMgPSBjb250ZW50W1wicHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXNcIl07XHJcbiAgICAgICAgaWYgKHR5cGVvZiBuYW1lICE9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRXhwZWN0ZWQgYW5pbUV2ZW50TmFtZSB0byBiZSBzdHJpbmdcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiByZXF1ZXN0SWQgIT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIHJlcXVlc3RJZCAhPT0gXCJudW1iZXJcIiAmJiB0eXBlb2YgcmVxdWVzdElkICE9PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRXhwZWN0ZWQgcmVxdWVzdElkIHRvIGJlIHN0cmluZyBvciBudW1iZXIgb3IgdW5kZWZpbmVkXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiVHJ5aW5nIHRvIGludm9rZSBhbmltXCIsIG5hbWUsIFwid2l0aCB3ZWFwb25EcmF3bkFsbG93ZWQ9XCIsIHdlYXBvbkRyYXduQWxsb3dlZCwgXCIsIGZ1cm5pdHVyZUFsbG93ZWQ9XCIsIGZ1cm5pdHVyZUFsbG93ZWQsIFwiLCBleGl0QW5pbU5hbWU9XCIsIGV4aXRBbmltTmFtZSwgXCIsIGludGVycnVwdEFuaW1OYW1lPVwiLCBpbnRlcnJ1cHRBbmltTmFtZSwgXCIsIHRpbWVNcz1cIiwgdGltZU1zLCBcIiwgaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZD1cIiwgaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCwgXCIsIHBhcmVudEFuaW1FdmVudE5hbWU9XCIsIHBhcmVudEFuaW1FdmVudE5hbWUsIFwiLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM9XCIsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcywgXCIsIHByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zPVwiLCBwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcyk7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBfdGhpcy50cnlJbnZva2VBbmltKG5hbWUsIHsgd2VhcG9uRHJhd25BbGxvd2VkOiB3ZWFwb25EcmF3bkFsbG93ZWQsIGZ1cm5pdHVyZUFsbG93ZWQ6IGZ1cm5pdHVyZUFsbG93ZWQsIGV4aXRBbmltTmFtZTogZXhpdEFuaW1OYW1lLCBpbnRlcnJ1cHRBbmltTmFtZTogaW50ZXJydXB0QW5pbU5hbWUsIHRpbWVNczogdGltZU1zLCBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkOiBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkLCBwYXJlbnRBbmltRXZlbnROYW1lOiBwYXJlbnRBbmltRXZlbnROYW1lLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcywgcHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXM6IHByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zIH0pO1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tUGFja2V0LFxyXG4gICAgICAgICAgICAgICAgY29udGVudEpzb25EdW1wOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tUGFja2V0VHlwZTogXCJpbnZva2VBbmltUmVzdWx0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdElkOiByZXF1ZXN0SWQsXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUub25TZW5kQW5pbWF0aW9uRXZlbnRMZWF2ZSA9IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBhbmltTG93ZXJDYXNlID0gY3R4LmFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICBpZiAoYW5pbUxvd2VyQ2FzZS5zdGFydHNXaXRoKFwiaWRsZVwiKSAmJiAhYW5pbUxvd2VyQ2FzZS5zdGFydHNXaXRoKFwiaWRsZWZvcmNlZGVmYXVsdHN0YXRlXCIpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgb25seSBmb3IgcGxheWVyLnBsYXlpZGxlXHJcbiAgICAgICAgICAgICAgICBpZiAoIV90aGlzLnNwLlVpLmlzTWVudU9wZW4oXCJDb25zb2xlXCIgLyogTWVudS5Db25zb2xlICovKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICgoX2EgPSBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0RnVybml0dXJlUmVmZXJlbmNlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJGb3JjaW5nIHRoaXJkIHBlcnNvbiBhbmQgZGlzYWJsaW5nIHBsYXllciBjb250cm9sc1wiKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZm9yY2VUaGlyZFBlcnNvbigpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5kaXNhYmxlUGxheWVyQ29udHJvbHModHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jdXJyZW50QW5pbSA9IHsgbmFtZTogY3R4LmFuaW1FdmVudE5hbWUsIG9wdGlvbnM6IG51bGwsIHByZWZlckludGVycnVwdEFuaW1TdGF0ZTogbnVsbCB9O1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3RhcnRBbnRpRXhwbG9pdFBvbGxpbmcoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5leGl0QW5pbSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2EsIF9iO1xyXG4gICAgICAgIC8vIFRPRE8oMSk6IFNlZSBhbm90aGVyIFRPRE8oMSkgaW4gdGhpcyBmaWxlXHJcbiAgICAgICAgaWYgKG9wdGlvbnMucGxheUV4aXRBbmltKSB7XHJcbiAgICAgICAgICAgIHZhciB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSA9IGZhbHNlO1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy51c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSkge1xyXG4gICAgICAgICAgICAgICAgdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51c2VQbGF5ZXJDb250cm9sc0RlbGF5TXMgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiVXNpbmcgaW50ZXJydXB0IGFuaW0gYXMgZXhpdCBhbmltOiBcIi5jb25jYXQodGhpcy5pbnRlcnJ1cHRBbmltTmFtZSwgXCIuIFJlYXNvbjogdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0gaXMgdHJ1ZVwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKChfYiA9IChfYSA9IHRoaXMuY3VycmVudEFuaW0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGUpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5wcmVmZXIpIHtcclxuICAgICAgICAgICAgICAgIHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXNlUGxheWVyQ29udHJvbHNEZWxheU1zID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlVzaW5nIGludGVycnVwdCBhbmltIGFzIGV4aXQgYW5pbTogXCIuY29uY2F0KHRoaXMuaW50ZXJydXB0QW5pbU5hbWUsIFwiLiBSZWFzb246IHByZWZlckludGVycnVwdEFuaW1TdGF0ZS5wcmVmZXIgaXMgdHJ1ZVwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGFuaW1FdmVudFRvU2VuZCA9IHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltID8gKHRoaXMuaW50ZXJydXB0QW5pbU5hbWUgfHwgXCJJZGxlU3RvcFwiKSA6ICh0aGlzLmV4aXRBbmltTmFtZSB8fCBcIklkbGVGb3JjZURlZmF1bHRTdGF0ZVwiKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5EZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQodGhpcy5zcC5HYW1lLmdldFBsYXllcigpLCBhbmltRXZlbnRUb1NlbmQpO1xyXG4gICAgICAgICAgICB0aGlzLmV4aXRBbmltRXZlbnQgPSBhbmltRXZlbnRUb1NlbmQ7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9uc0NhY2hlID0gb3B0aW9ucztcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZW50IGFuaW1hdGlvbiBldmVudDpcIiwgYW5pbUV2ZW50VG9TZW5kKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0gPSBudWxsO1xyXG4gICAgICAgICAgICB2YXIgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheVNlY29uZHMgPSAodHlwZW9mIG9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zID09PSBcIm51bWJlclwiXHJcbiAgICAgICAgICAgICAgICAmJiBvcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyA+IDBcclxuICAgICAgICAgICAgICAgICYmIE51bWJlci5pc0Zpbml0ZShvcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcylcclxuICAgICAgICAgICAgICAgICYmIHRoaXMudXNlUGxheWVyQ29udHJvbHNEZWxheU1zKVxyXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyAvIDEwMDBcclxuICAgICAgICAgICAgICAgIDogMC41O1xyXG4gICAgICAgICAgICB2YXIgc3RvcEFuaW1EZWxheVNlY29uZHMgPSBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5U2Vjb25kcyArIDAuNTtcclxuICAgICAgICAgICAgdGhpcy5zdG9wQW5pbUluUHJvZ3Jlc3MgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdChlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5U2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmVuYWJsZVBsYXllckNvbnRyb2xzKHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoc3RvcEFuaW1EZWxheVNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3RvcEFuaW1JblByb2dyZXNzID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9uQ2IpIHtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcHRpb25DYigpO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLm9wdGlvbkNiID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLm9uU2VuZEV4aXRBbmltYXRpb25FdmVudExlYXZlID0gZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKGN0eC5hbmltYXRpb25TdWNjZWVkZWQgJiYgdGhpcy5leGl0QW5pbUV2ZW50ICYmIHRoaXMub3B0aW9uc0NhY2hlICYmIGN0eC5hbmltRXZlbnROYW1lID09PSB0aGlzLmV4aXRBbmltRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbSA9IG51bGw7XHJcbiAgICAgICAgICAgIHZhciBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5U2Vjb25kcyA9ICh0eXBlb2YgdGhpcy5vcHRpb25zQ2FjaGUuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zID09PSBcIm51bWJlclwiXHJcbiAgICAgICAgICAgICAgICAmJiB0aGlzLm9wdGlvbnNDYWNoZS5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgPiAwXHJcbiAgICAgICAgICAgICAgICAmJiBOdW1iZXIuaXNGaW5pdGUodGhpcy5vcHRpb25zQ2FjaGUuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zKVxyXG4gICAgICAgICAgICAgICAgJiYgdGhpcy51c2VQbGF5ZXJDb250cm9sc0RlbGF5TXMpXHJcbiAgICAgICAgICAgICAgICA/IHRoaXMub3B0aW9uc0NhY2hlLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyAvIDEwMDBcclxuICAgICAgICAgICAgICAgIDogMC41O1xyXG4gICAgICAgICAgICB2YXIgc3RvcEFuaW1EZWxheVNlY29uZHMgPSBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5U2Vjb25kcyArIDAuNTtcclxuICAgICAgICAgICAgdGhpcy5zdG9wQW5pbUluUHJvZ3Jlc3MgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnNDYWNoZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdGhpcy5leGl0QW5pbUV2ZW50ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB0aGlzLnVzZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlTZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZW5hYmxlUGxheWVyQ29udHJvbHModHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdChzdG9wQW5pbURlbGF5U2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zdG9wQW5pbUluUHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25DYikge1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLm9wdGlvbkNiKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMub3B0aW9uQ2IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zQ2FjaGUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRoaXMuZXhpdEFuaW1FdmVudCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9uQ2IpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uQ2IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLnN0YXJ0QW50aUV4cGxvaXRQb2xsaW5nID0gZnVuY3Rpb24gKG1vZGUpIHtcclxuICAgICAgICAvLyBGaXhlcyBodHRwczovL2dpdGh1Yi5jb20vc2t5cmltLW11bHRpcGxheWVyL3NreW1wNS1nYW1lbW9kZS9pc3N1ZXMvMjQwXHJcbiAgICAgICAgLy8gUC5TLiBUaGVyZSBpcyBhIHZlcnkgc2ltaWxhciBjb2RlIGluIHNreW1wNS1nYW1lbW9kZVxyXG4gICAgICAgIC8vIFNlZSBkaXNhYmxlQ2hlYXRzLnRzLCBza3ltcDUtZ2FtZW1vZGUgZm9yIGNvbW1lbnRzXHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAobW9kZSA9PT0gdm9pZCAwKSB7IG1vZGUgPSBcImRlYXRoXCI7IH1cclxuICAgICAgICB2YXIgX2NhbGxOYXRpdmUgPSB0aGlzLnNwLmNhbGxOYXRpdmU7XHJcbiAgICAgICAgdmFyIGNhbWVyYVN0YXRlID0gLTE7XHJcbiAgICAgICAgdmFyIG5lZWRzRXhpdGluZ0FuaW0gPSBmYWxzZTtcclxuICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgaWYgKGkgPj0gMTAgKiA2MCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbWVyYVN0YXRlID0gX2NhbGxOYXRpdmUoXCJHYW1lXCIsIFwiZ2V0Q2FtZXJhU3RhdGVcIiwgdW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgbmVlZHNFeGl0aW5nQW5pbSA9IF90aGlzLm5lZWRzRXhpdGluZ0FuaW07XHJcbiAgICAgICAgICAgIGlmICghbmVlZHNFeGl0aW5nQW5pbSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGYoSW5maW5pdHkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChjYW1lcmFTdGF0ZSA9PT0gMCkgeyAvLyAxLXN0IHBlcnNvblxyXG4gICAgICAgICAgICAgICAgX2NhbGxOYXRpdmUoXCJHYW1lXCIsIFwiZm9yY2VUaGlyZFBlcnNvblwiLCB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuZXhpdEFuaW0oeyBwbGF5RXhpdEFuaW06IHRydWUsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogdW5kZWZpbmVkIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGUgPT09IFwiZGVhdGhcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIChfYSA9IF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kYW1hZ2VBY3RvclZhbHVlKFwiSGVhbHRoXCIsIDEwMDAwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBmKEluZmluaXR5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gZihpICsgMSk7IH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgZigwKTtcclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUub25CdXR0b25FdmVudCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF9hLCBfYjtcclxuICAgICAgICAvLyBUT0RPOiBkZS1oYXJkY29kZSBjb250cm9sc1xyXG4gICAgICAgIGlmIChlLmlzUHJlc3NlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlLmNvZGUgPT09IDU3IC8qIER4U2NhbkNvZGUuU3BhY2ViYXIgKi9cclxuICAgICAgICAgICAgfHwgZS5jb2RlID09PSAxNyAvKiBEeFNjYW5Db2RlLlcgKi9cclxuICAgICAgICAgICAgfHwgZS5jb2RlID09PSAzMCAvKiBEeFNjYW5Db2RlLkEgKi9cclxuICAgICAgICAgICAgfHwgZS5jb2RlID09PSAzMSAvKiBEeFNjYW5Db2RlLlMgKi9cclxuICAgICAgICAgICAgfHwgZS5jb2RlID09PSAzMiAvKiBEeFNjYW5Db2RlLkQgKi8pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubmVlZHNFeGl0aW5nQW5pbSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKChfYSA9IHRoaXMuY3VycmVudEFuaW0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGl0QW5pbSh7IHBsYXlFeGl0QW5pbTogdHJ1ZSwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiB0aGlzLmN1cnJlbnRBbmltLm9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGl0QW5pbSh7IHBsYXlFeGl0QW5pbTogdHJ1ZSwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiB1bmRlZmluZWQgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm5lZWRzRXhpdGluZ0FuaW0pIHtcclxuICAgICAgICAgICAgICAgIHZhciBpbnRlcnZhbE1zID0gKF9iID0gdGhpcy5zZXR0aW5ncykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmV4aXRBbmltTm90aWZpY2F0aW9uSW50ZXJ2YWxNcztcclxuICAgICAgICAgICAgICAgIGlmICghaW50ZXJ2YWxNcyB8fCAoRGF0ZS5ub3coKSAtIHRoaXMubGFzdE5vdGlmaWNhdGlvbk1vbWVudCkgPj0gaW50ZXJ2YWxNcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdE5vdGlmaWNhdGlvbk1vbWVudCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcC5EZWJ1Zy5ub3RpZmljYXRpb24oXCLQn9GA0L7QsdC10LssINGH0YLQvtCx0Ysg0LLRi9C50YLQuCDQuNC3INCw0L3QuNC80LDRhtC40LhcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFlLmlzVXApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuc2V0dGluZ3MgfHwgIXRoaXMuc2V0dGluZ3MuYW5pbUtleXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYW5pbUV2ZW50ID0gdGhpcy5zZXR0aW5ncy5hbmltS2V5c1tlLmNvZGVdO1xyXG4gICAgICAgIGlmICghYW5pbUV2ZW50KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTdGFydGluZyBhbmltcyBmcm9tIGtleWJvYXJkIGlzIGRpc2FibGVkIGluIHRoaXMgdmVyc2lvblwiKTtcclxuICAgICAgICAvLyB0aGlzLnRyeUludm9rZUFuaW0oYW5pbUV2ZW50LCB7XHJcbiAgICAgICAgLy8gICAgIHdlYXBvbkRyYXduQWxsb3dlZDogZmFsc2UsXHJcbiAgICAgICAgLy8gICAgIGZ1cm5pdHVyZUFsbG93ZWQ6IGZhbHNlLFxyXG4gICAgICAgIC8vICAgICBleGl0QW5pbU5hbWU6IG51bGwsXHJcbiAgICAgICAgLy8gICAgIGludGVycnVwdEFuaW1OYW1lOiBudWxsLFxyXG4gICAgICAgIC8vICAgICB0aW1lTXM6IDAsXHJcbiAgICAgICAgLy8gICAgIGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQ6IHRydWUsXHJcbiAgICAgICAgLy8gICAgIHBhcmVudEFuaW1FdmVudE5hbWU6IG51bGwsXHJcbiAgICAgICAgLy8gICAgIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogbnVsbCxcclxuICAgICAgICAvLyAgICAgcHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXM6IG51bGwsXHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLnRyeUludm9rZUFuaW0gPSBmdW5jdGlvbiAoYW5pbUV2ZW50LCBvcHRpb25zKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLnRyeUludm9rZUFuaW1Db3VudCsrO1xyXG4gICAgICAgIGlmICh0aGlzLnRyeUludm9rZUFuaW1Db3VudCA+PSB0aGlzLnRyeUludm9rZUFuaW1Db3VudE1heCkge1xyXG4gICAgICAgICAgICB0aGlzLnRyeUludm9rZUFuaW1Db3VudCA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBjdXJyZW50SW52b2tlQW5pbUNvdW50ID0gdGhpcy50cnlJbnZva2VBbmltQ291bnQ7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmV4aXRBbmltTmFtZSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICB0aGlzLmV4aXRBbmltTmFtZSA9IG9wdGlvbnMuZXhpdEFuaW1OYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5leGl0QW5pbU5hbWUgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuaW50ZXJydXB0QW5pbU5hbWUgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnRlcnJ1cHRBbmltTmFtZSA9IG9wdGlvbnMuaW50ZXJydXB0QW5pbU5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmludGVycnVwdEFuaW1OYW1lID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnRpbWVNcyA9PT0gXCJudW1iZXJcIiAmJiBvcHRpb25zLnRpbWVNcyA+IDAgJiYgTnVtYmVyLmlzRmluaXRlKG9wdGlvbnMudGltZU1zKSkge1xyXG4gICAgICAgICAgICB2YXIgdGltZVNlY29uZHMgPSBvcHRpb25zLnRpbWVNcyAvIDEwMDA7XHJcbiAgICAgICAgICAgIC8vIFVzaW5nIFV0aWxpdHkud2FpdCBtYWtlcyBzZW5zZSBiZWNhdXNlIGl0IHdhaXRzIGdhbWUgdGltZSwgbm90IHNpbXBseSByZWFsIHRpbWUuXHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KHRpbWVTZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmIChfdGhpcy50cnlJbnZva2VBbmltQ291bnQgIT09IGN1cnJlbnRJbnZva2VBbmltQ291bnQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIV90aGlzLm5lZWRzRXhpdGluZ0FuaW0pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCA9IHR5cGVvZiBvcHRpb25zLmlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQgPT09IFwiYm9vbGVhblwiID8gb3B0aW9ucy5pc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkIDogdHJ1ZTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmV4aXRBbmltKHsgcGxheUV4aXRBbmltOiBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IG9wdGlvbnMuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHBsYXllciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBpZiAoIXBsYXllcikge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcInBsYXllcl9ub3RfZm91bmRcIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGxheWVyLmlzV2VhcG9uRHJhd24oKSAmJiAhb3B0aW9ucy53ZWFwb25EcmF3bkFsbG93ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJ3ZWFwb25fZHJhd25cIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGxheWVyLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcImJJbkp1bXBTdGF0ZVwiKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcImp1bXBfc3RhdGVcIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zcC5VaS5pc01lbnVPcGVuKFwiRmF2b3JpdGVzTWVudVwiIC8qIE1lbnUuRmF2b3JpdGVzICovKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcImZhdm9yaXRlc19tZW51X29wZW5cIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zcC5VaS5pc01lbnVPcGVuKFwiQ29uc29sZVwiIC8qIE1lbnUuQ29uc29sZSAqLykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJjb25zb2xlX21lbnVfb3BlblwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnN0b3BBbmltSW5Qcm9ncmVzcykge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcImJ1c3lfc3RvcHBpbmdfYW5pbVwiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwbGF5ZXIuZ2V0RnVybml0dXJlUmVmZXJlbmNlKCkgJiYgIW9wdGlvbnMuZnVybml0dXJlQWxsb3dlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcInBsYXllcl9pbl9mdXJuaXR1cmVcIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGxheWVyLmlzU25lYWtpbmcoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcInBsYXllcl9zbmVha2luZ1wiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwbGF5ZXIuaXNTd2ltbWluZygpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwicGxheWVyX3N3aW1taW5nXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFuaW1FdmVudC50b0xvd2VyQ2FzZSgpID09PSBcImlkbGVmb3JjZWRlZmF1bHRzdGF0ZVwiKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm5lZWRzRXhpdGluZ0FuaW0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXhpdEFuaW0oeyBwbGF5RXhpdEFuaW06IHRydWUsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogdW5kZWZpbmVkIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB2YXIgZG9JbnZva2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmZvcmNlVGhpcmRQZXJzb24oKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZGlzYWJsZVBsYXllckNvbnRyb2xzKHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDApO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCksIGFuaW1FdmVudCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJlZmVySW50ZXJydXB0QW5pbVN0YXRlID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5wcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcyA9PT0gXCJudW1iZXJcIlxyXG4gICAgICAgICAgICAgICAgICAgICYmIG9wdGlvbnMucHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMgPiAwXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgTnVtYmVyLmlzRmluaXRlKG9wdGlvbnMucHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlXzEgPSB7IHByZWZlcjogdHJ1ZSB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlByZWZlciBpbnRlcnJ1cHQgYW5pbSBhcyBleGl0IGFuaW0gZm9yIFwiLmNvbmNhdChvcHRpb25zLnByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zLCBcIiBtc1wiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc3AuVXRpbGl0eS53YWl0KG9wdGlvbnMucHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMgLyAxMDAwKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVfMS5wcmVmZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUHJlZmVyIGludGVycnVwdCBhbmltIGFzIGV4aXQgYW5pbSBzdGF0ZSBjaGFuZ2VkIHRvIGZhbHNlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHByZWZlckludGVycnVwdEFuaW1TdGF0ZSA9IHN0YXRlXzE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jdXJyZW50QW5pbSA9IHsgbmFtZTogYW5pbUV2ZW50LCBvcHRpb25zOiBvcHRpb25zLCBwcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGU6IHByZWZlckludGVycnVwdEFuaW1TdGF0ZSB9O1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3RhcnRBbnRpRXhwbG9pdFBvbGxpbmcoXCJub19kZWF0aFwiKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnBhcmVudEFuaW1FdmVudE5hbWUgPT09IFwic3RyaW5nXCIgJiYgdGhpcy5jdXJyZW50QW5pbU5hbWUgPT09IG9wdGlvbnMucGFyZW50QW5pbUV2ZW50TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgZG9JbnZva2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9wdGlvbnMucGFyZW50QW5pbUV2ZW50TmFtZSkgJiYgb3B0aW9ucy5wYXJlbnRBbmltRXZlbnROYW1lLmluY2x1ZGVzKHRoaXMuY3VycmVudEFuaW1OYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgZG9JbnZva2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLm5lZWRzRXhpdGluZ0FuaW0pIHtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE8gKDEpOiBjb25zaWRlciBub3QgdXNpbmcgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zIGhlcmUsIGJlY2F1c2UgdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0gZG9lc24ndCBuZWVkIGl0XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbkNiID0gZG9JbnZva2U7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV4aXRBbmltKHsgcGxheUV4aXRBbmltOiB0cnVlLCB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbTogdHJ1ZSwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiBvcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRvSW52b2tlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZW50IGFuaW1hdGlvbiBldmVudDogXCIuY29uY2F0KGFuaW1FdmVudCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLmhhc1N3ZWV0UGllID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtb2RDb3VudCA9IHRoaXMuc3AuR2FtZS5nZXRNb2RDb3VudCgpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kQ291bnQ7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5HYW1lLmdldE1vZE5hbWUoaSkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3dlZXRwaWUnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUsIFwibmVlZHNFeGl0aW5nQW5pbVwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRBbmltTmFtZSAhPT0gbnVsbDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLCBcImN1cnJlbnRBbmltTmFtZVwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRBbmltID8gdGhpcy5jdXJyZW50QW5pbS5uYW1lIDogbnVsbDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5yZXF1ZXN0QWRkUGVya3NUb0FjdG9ycyA9IGZ1bmN0aW9uIChhY3RvcklkcywgcGVya0lkcykge1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGFjdG9ycyA9IGFjdG9ySWRzLm1hcChmdW5jdGlvbiAoYWN0b3JJZCkgeyByZXR1cm4gX3RoaXMuc3AuQWN0b3IuZnJvbShfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChhY3RvcklkKSk7IH0pLmZpbHRlcihmdW5jdGlvbiAoYWN0b3IpIHsgcmV0dXJuIGFjdG9yICE9PSBudWxsOyB9KTtcclxuICAgICAgICAgICAgICAgIHZhciBwZXJrcyA9IHBlcmtJZHMubWFwKGZ1bmN0aW9uIChwZXJrSWQpIHsgcmV0dXJuIF90aGlzLnNwLlBlcmsuZnJvbShfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChwZXJrSWQpKTsgfSkuZmlsdGVyKGZ1bmN0aW9uIChwZXJrKSB7IHJldHVybiBwZXJrICE9PSBudWxsOyB9KTtcclxuICAgICAgICAgICAgICAgIGFjdG9ycy5mb3JFYWNoKGZ1bmN0aW9uIChhY3RvcikgeyByZXR1cm4gcGVya3MuZm9yRWFjaChmdW5jdGlvbiAocGVyaykgeyByZXR1cm4gYWN0b3IgPT09IG51bGwgfHwgYWN0b3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdG9yLmFkZFBlcmsocGVyayk7IH0pOyB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoIV90aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBkaXNhYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZW5hYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29udHJvbGxlci5vbignY29udGFpbmVyQ2hhbmdlZCcsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNvbnRhaW5lckNoYW5nZWQoZSk7IH0pO1xyXG4gICAgICAgIGNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNldEludmVudG9yeU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2V0SW52ZW50b3J5TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNyZWF0ZUFjdG9yTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLm9uQ29udGFpbmVyQ2hhbmdlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZS5vbGRDb250YWluZXIgJiYgZS5uZXdDb250YWluZXIpIHtcclxuICAgICAgICAgICAgaWYgKGUubmV3Q29udGFpbmVyLmdldEZvcm1JRCgpID09PSAweDE0ICYmIGUubnVtSXRlbXMgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVBsYXllckludmVudG9yeUNoYW5nZWQoe1xyXG4gICAgICAgICAgICAgICAgICAgIGJhc2VJZDogZS5iYXNlT2JqLmdldEZvcm1JRCgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50OiBlLm51bUl0ZW1zLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLm9uU2V0SW52ZW50b3J5TWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBlbnRyaWVzID0gZS5tZXNzYWdlLmludmVudG9yeS5lbnRyaWVzO1xyXG4gICAgICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIFNldEludmVudG9yeU1lc3NhZ2Ugd2l0aCBlbXB0eSBpbnZlbnRvcnlcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBlbnRyaWVzLmZvckVhY2goZnVuY3Rpb24gKGVudHJ5KSB7IHJldHVybiBfdGhpcy5oYW5kbGVQbGF5ZXJJbnZlbnRvcnlDaGFuZ2VkKGVudHJ5KTsgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLm9uQ3JlYXRlQWN0b3JNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBfYSwgX2I7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWUubWVzc2FnZS5pc01lKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGVudHJpZXMgPSAoX2IgPSAoX2EgPSBlLm1lc3NhZ2UucHJvcHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pbnZlbnRvcnkpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5lbnRyaWVzO1xyXG4gICAgICAgIGlmIChlbnRyaWVzID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBDcmVhdGVBY3Rvck1lc3NhZ2Ugd2l0aG91dCBpbnZlbnRvcnlcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGVudHJpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgQ3JlYXRlQWN0b3JNZXNzYWdlIHdpdGggZW1wdHkgaW52ZW50b3J5XCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZW50cmllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkgeyByZXR1cm4gX3RoaXMuaGFuZGxlUGxheWVySW52ZW50b3J5Q2hhbmdlZChlbnRyeSk7IH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5oYW5kbGVQbGF5ZXJJbnZlbnRvcnlDaGFuZ2VkID0gZnVuY3Rpb24gKGVudHJ5KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgaXRlbSA9IHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZW50cnkuYmFzZUlkKTtcclxuICAgICAgICBpZiAoIWl0ZW0pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZW50cnkuY291bnQgPD0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwZXJrSWRzID0gdGhpcy5nZXRQZXJrSWRzQnlLZXl3b3JkKGl0ZW0pO1xyXG4gICAgICAgIGlmIChwZXJrSWRzKSB7XHJcbiAgICAgICAgICAgIHZhciBwbGF5ZXJJZCA9IDB4MTQ7XHJcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdEFkZFBlcmtzVG9BY3RvcnMoW3BsYXllcklkXSwgcGVya0lkcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRQZXJrSWRzQnlLZXl3b3JkID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICB0aGlzLmdldEtleXdvcmRQZXJrTWFwKCkuZm9yRWFjaChmdW5jdGlvbiAodiwgaykge1xyXG4gICAgICAgICAgICB2YXIga2V5V29yZCA9IF90aGlzLnNwLktleXdvcmQuZ2V0S2V5d29yZChrKTtcclxuICAgICAgICAgICAgaWYgKGl0ZW0uaGFzS2V5d29yZChrZXlXb3JkKSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDAgPyByZXN1bHQgOiBudWxsO1xyXG4gICAgfTtcclxuICAgIC8vIFRPRE86IG1vdmUgdGhpcyB0byBjb25maWdcclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRLZXl3b3JkUGVya01hcCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gbmV3IE1hcChbXHJcbiAgICAgICAgICAgIC8vINCh0YLRgNC10LvQtdGGXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0JvdzFcIiwgMHgxMDM2RjBdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCb3cyXCIsIDB4NThGNjFdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCb3czXCIsIDB4MTA1RjE5XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQm93NFwiLCAweDU4RjYzXSxcclxuICAgICAgICAgICAgLy8g0KPQsdC40LnRhtCwXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya1NuZWFrMVwiLCAweDU4MjEwXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrU25lYWsyXCIsIDB4MTA1RjIzXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrU25lYWszXCIsIDB4NTgyMDhdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtTbmVhazRcIiwgMHg1ODIxMV0sXHJcbiAgICAgICAgICAgIC8vINCf0LXRhdC+0YLQuNC90LXRhlxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtBcm1vckxpZ2h0MVwiLCAweDEwNUYyMl0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0FybW9yTGlnaHQyXCIsIDB4NTFCMUNdLFxyXG4gICAgICAgICAgICAvLyDQl9Cw0YfQsNGA0L7QstCw0YLQtdC70YxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrRW5jaGFudDJcIiwgMHgxMDhBNDRdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtFbmNoYW50MVwiLCAweDU4RjdDXSxcclxuICAgICAgICAgICAgLy8g0JvQsNGC0L3QuNC6XHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0FybW9ySGVhdnkxXCIsIDB4QkNEMkJdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtBcm1vckhlYXZ5MlwiLCAweDU4RjZEXSxcclxuICAgICAgICAgICAgLy8g0KnQuNGC0L7QvdC+0YHQtdGGXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0Jsb2NrMVwiLCAweDU4RjY3XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQmxvY2syXCIsIDB4MTA2MjUzXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQmxvY2szXCIsIDB4NThGNkFdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCbG9jazRcIiwgMHg1OEY2OV0sXHJcbiAgICAgICAgICAgIC8vINCc0LXRh9C90LjQuiwg0LrQu9C40L3QvtC6LCDRgNGD0LHQsNC60LAsINC60YDRg9GI0LjRgtC10LvRjCwg0LzQvtC90LDRhSwg0LrQvtC/0LXQudGJ0LjQuiwg0YHRgtGA0LDQttC90LjQuiAo0LTQstGD0YDRg9GH0L3QvtC1INC+0YDRg9C20LjQtSlcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMUhhbmQySGFuZDFcIiwgMHg1OEY2Rl0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazJIYW5kMlwiLCAweENCNDA3XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMkhhbmQzXCIsIDB4OTY1OTBdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsySGFuZDRcIiwgMHg1MkQ1MV0sXHJcbiAgICAgICAgICAgIC8vINCQ0YHRgdCw0YHQuNC9LCDRgNCw0LfQstC10LTRh9C40LosINGI0L/QuNC+0L0sINC/0YDQtdC00YjQtdGB0YLQstC10L3QvdC40LosINGA0YvRhtCw0YDRjCwg0YDQsNC30LHQvtC50L3QuNC6LCDQsdC10YDRgdC10YDQuiwg0LPRgNC+0LzQuNC70LAgKNC+0LTQvdC+0YDRg9GH0L3QvtC1INC+0YDRg9C20LjQtSlcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMUhhbmQySGFuZDFcIiwgMHg1OEY2Rl0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazFIYW5kMlwiLCAweENCNDA2XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMUhhbmQzXCIsIDB4MTA2MjU2XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMUhhbmQ0XCIsIDB4NTJENTBdLFxyXG4gICAgICAgIF0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5oYXNTd2VldFBpZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbW9kQ291bnQgPSB0aGlzLnNwLkdhbWUuZ2V0TW9kQ291bnQoKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZENvdW50OyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuR2FtZS5nZXRNb2ROYW1lKGkpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3N3ZWV0cGllJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgY29udHJvbGxlci5lbWl0dGVyLm9uKFwibmlja25hbWVDcmVhdGVcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTmlja25hbWVDcmVhdGUoZSk7IH0pO1xyXG4gICAgICAgIGNvbnRyb2xsZXIuZW1pdHRlci5vbihcIm5pY2tuYW1lRGVzdHJveVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25OaWNrbmFtZURlc3Ryb3koZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlLnByb3RvdHlwZS5vbk5pY2tuYW1lQ3JlYXRlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIHN0b3JhZ2VOaWNrbmFtZSA9IHR5cGVvZiB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXSA9PT0gJ29iamVjdCdcclxuICAgICAgICAgICAgPyB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXVxyXG4gICAgICAgICAgICA6IG51bGw7XHJcbiAgICAgICAgaWYgKHN0b3JhZ2VOaWNrbmFtZSA9PT0gbnVsbCAmJiBlLnJlbW90ZVJlZnJJZCkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXSA9IChfYSA9IHt9LCBfYVtlLnJlbW90ZVJlZnJJZF0gPSBlLnRleHRJZCwgX2EpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChzdG9yYWdlTmlja25hbWUgIT09IG51bGwgJiYgZS5yZW1vdGVSZWZySWQpIHtcclxuICAgICAgICAgICAgc3RvcmFnZU5pY2tuYW1lW2UucmVtb3RlUmVmcklkXSA9IGUudGV4dElkO1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXSA9IHN0b3JhZ2VOaWNrbmFtZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UucHJvdG90eXBlLm9uTmlja25hbWVEZXN0cm95ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgc3RvcmFnZU5pY2tuYW1lID0gdHlwZW9mIHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdID09PSAnb2JqZWN0J1xyXG4gICAgICAgICAgICA/IHRoaXMuc3Auc3RvcmFnZVtcImlkVGV4dE5pY2tuYW1lXCJdXHJcbiAgICAgICAgICAgIDogbnVsbDtcclxuICAgICAgICBpZiAoc3RvcmFnZU5pY2tuYW1lICE9PSBudWxsICYmIGUucmVtb3RlUmVmcklkKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSBzdG9yYWdlTmlja25hbWVbZS5yZW1vdGVSZWZySWRdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXSA9IHN0b3JhZ2VOaWNrbmFtZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuLy8gVE9ETzogbW92ZSB0byBzZXJ2aWNlXHJcbnZhciBwbGF5ZXJMYXN0U3RhbWluYVZhbHVlID0gMDtcclxudmFyIHBsYXllckxhc3RJc1NwcmludGluZ1ZhbHVlID0gZmFsc2U7XHJcbnZhciBibG9ja1BsYXllckNvbnRyb2xUaW1lU3RhbXAgPSAwO1xyXG52YXIgaXNQbGF5ZXJDb250cm9sRGlzYWJsZWQgPSB0cnVlO1xyXG52YXIgcGxheWVyQXR0YWNrVGltZW91dCA9IDA7XHJcbnZhciBhY3RpdmVUaW1lcnMgPSBuZXcgU2V0KCk7XHJcbi8vIFRPRE86IG1vdmUgdG8gY29uZmlnXHJcbnZhciBzdGFtaW5hQXR0YWNrTWFwID0gbmV3IE1hcChbXHJcbiAgICBbXCJTdGRcIiwgN10sXHJcbiAgICBbXCJQb3dlclwiLCAzNV0sXHJcbiAgICBbXCJKdW1wXCIsIDE1XSxcclxuICAgIFtcIkJvd1wiLCAyNV0sXHJcbiAgICBbXCJDcm9zc2Jvd1wiLCAzMF0sXHJcbl0pO1xyXG4vLyBUT0RPOiBjb25zaWRlciBzcGxpdHRpbmcgdGhpcyBzZXJ2aWNlIChzZXBhcmF0ZSBzdGFtaW5hIGFuZCB0aW1lciBtYW5hZ2VtZW50KVxyXG4vLyBUT0RPOiBzdWJzY3JpYmUgZXZlbnRzL2hvb2tzIGluIGNvbnN0cnVjdG9yXHJcbnZhciBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGlmICghX3RoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGRpc2FibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBlbmFibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNldEF0dGFja1N0YW1pbmFSZXN0cmljdGlvbigpO1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJIYW5kbGVyc0lmTmVlZGVkKCk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLnNldEF0dGFja1N0YW1pbmFSZXN0cmljdGlvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHBsYXllciA9IF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgIHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPSBwbGF5ZXIuZ2V0QWN0b3JWYWx1ZShcIlN0YW1pbmFcIik7XHJcbiAgICAgICAgICAgIHBsYXllckxhc3RJc1NwcmludGluZ1ZhbHVlID0gcGxheWVyLmlzU3ByaW50aW5nKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfYSA9IFsnU3ByaW50U3RhcnQnXTsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfYVtfaV07XHJcbiAgICAgICAgICAgIHZhciBzcCA9IHRoaXMuc3A7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA8IDcuNSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfYiA9IDAsIF9jID0gWydibG9ja1N0YXJ0J107IF9iIDwgX2MubGVuZ3RoOyBfYisrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2NbX2JdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RJc1NwcmludGluZ1ZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9kID0gMCwgX2UgPSBbJ2F0dGFja1N0YXJ0KicsICdBdHRhY2tTdGFydConXTsgX2QgPCBfZS5sZW5ndGg7IF9kKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfZVtfZF07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPCAoKF9hID0gc3RhbWluYUF0dGFja01hcC5nZXQoXCJTdGRcIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9mID0gMCwgX2cgPSBbJ2F0dGFja1Bvd2VyU3RhcnQqJywgJ0F0dGFja1Bvd2VyU3RhcnQqJ107IF9mIDwgX2cubGVuZ3RoOyBfZisrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2dbX2ZdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0U3RhbWluYVZhbHVlIDwgKChfYSA9IHN0YW1pbmFBdHRhY2tNYXAuZ2V0KFwiUG93ZXJcIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9oID0gMCwgX2ogPSBbJ0p1bXBEaXJlY3Rpb25hbFN0YXJ0KicsICdKdW1wU3RhbmRpbmdTdGFydConXTsgX2ggPCBfai5sZW5ndGg7IF9oKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfaltfaF07XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPCAoKF9hID0gc3RhbWluYUF0dGFja01hcC5nZXQoXCJKdW1wXCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfayA9IDAsIF9sID0gWydib3dBdHRhY2tTdGFydConXTsgX2sgPCBfbC5sZW5ndGg7IF9rKyspIHtcclxuICAgICAgICAgICAgdmFyIHBhdHRlcm4gPSBfbFtfa107XHJcbiAgICAgICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPCAoKF9hID0gc3RhbWluYUF0dGFja01hcC5nZXQoXCJCb3dcIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9tID0gMCwgX28gPSBbJ2Nyb3NzYm93QXR0YWNrU3RhcnQqJ107IF9tIDwgX28ubGVuZ3RoOyBfbSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX29bX21dO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0U3RhbWluYVZhbHVlIDwgKChfYSA9IHN0YW1pbmFBdHRhY2tNYXAuZ2V0KFwiQ3Jvc3Nib3dcIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5yZWdpc3RlckhhbmRsZXJzSWZOZWVkZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9hID0gWydhdHRhY2tTdGFydConLCAnQXR0YWNrU3RhcnQqJ107IF9pIDwgX2EubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2FbX2ldO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoY3R4KSB7IHJldHVybiBzZWxmLmJsb2NrUGxheWVyQXR0YWNrKGN0eC5hbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2xlZnRoYW5kJykpOyB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIF9iID0gMCwgX2MgPSBbJ2F0dGFja1Bvd2VyU3RhcnQqJywgJ0F0dGFja1Bvd2VyU3RhcnQqJywgJ0p1bXAqJ107IF9iIDwgX2MubGVuZ3RoOyBfYisrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2NbX2JdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGxheWVyQXR0YWNrVGltZW91dCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlVGltZXJzLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgfSwgMHgxNCwgMHgxNCwgcGF0dGVybik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChpc1BsYXllckNvbnRyb2xEaXNhYmxlZCA9PT0gdHJ1ZSAmJiBEYXRlLm5vdygpIC0gYmxvY2tQbGF5ZXJDb250cm9sVGltZVN0YW1wID49IHBsYXllckF0dGFja1RpbWVvdXQpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkuc2V0RG9udE1vdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgaXNQbGF5ZXJDb250cm9sRGlzYWJsZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5ibG9ja1BsYXllckF0dGFjayA9IGZ1bmN0aW9uIChpc0xlZnRIYW5kKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgdmFyIHBsYXllciA9IF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgIGlmIChwbGF5ZXIuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiYkluSnVtcFN0YXRlXCIpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIF9iID0gX3RoaXMuZ2V0VGltaW5ncygoX2EgPSBwbGF5ZXIuZ2V0RXF1aXBwZWRXZWFwb24oaXNMZWZ0SGFuZCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRXZWFwb25UeXBlKCkpLCBkZWxheSA9IF9iWzBdLCB0aW1lb3V0ID0gX2JbMV07XHJcbiAgICAgICAgICAgIHZhciBybmQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIGFjdGl2ZVRpbWVycy5hZGQocm5kKTtcclxuICAgICAgICAgICAgX3RoaXMuc3AuVXRpbGl0eS53YWl0KGRlbGF5IC8gMTAwMCkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2ZVRpbWVycy5kZWxldGUocm5kKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNQbGF5ZXJDb250cm9sRGlzYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJsb2NrUGxheWVyQ29udHJvbFRpbWVTdGFtcCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKS5zZXREb250TW92ZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBwbGF5ZXJBdHRhY2tUaW1lb3V0ID0gdGltZW91dDtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5ID0gZnVuY3Rpb24gKGtleSwgd2VhcG9uVGltaW5ncykge1xyXG4gICAgICAgIHZhciB2YWx1ZSA9IHdlYXBvblRpbWluZ3Nba2V5XTtcclxuICAgICAgICBpZiAodmFsdWUgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIHZhciBlbGVtZW50MCA9IHZhbHVlWzBdO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQwICE9PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkludmFsaWQgdGltaW5ncyBjb25maWcgZm9yIHdlYXBvbiB0eXBlXCIsIGtleSwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFswLCAwXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgZWxlbWVudDEgPSB2YWx1ZVsxXTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50MSAhPT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJJbnZhbGlkIHRpbWluZ3MgY29uZmlnIGZvciB3ZWFwb24gdHlwZVwiLCBrZXksIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbMCwgMF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIFtlbGVtZW50MCwgZWxlbWVudDFdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gWzAsIDBdO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRTZXR0aW5nc0Zyb21GaWxlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBzd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wic3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2VcIl07XHJcbiAgICAgICAgaWYgKCFzd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSB8fCB0eXBlb2Ygc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UgIT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJObyBzd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSBzZXR0aW5ncyBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB3ZWFwb25UaW1pbmdzID0gc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2Uud2VhcG9uVGltaW5ncztcclxuICAgICAgICBpZiAoIXdlYXBvblRpbWluZ3MgfHwgdHlwZW9mIHdlYXBvblRpbWluZ3MgIT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJObyB3ZWFwb25UaW1pbmdzIHNldHRpbmdzIGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3M7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmdldFNldHRpbmdzRGVmYXVsdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBmaXN0OiBbMCwgMzBdLFxyXG4gICAgICAgICAgICBzd29yZDogWzAsIDMwXSxcclxuICAgICAgICAgICAgZGFnZ2VyOiBbMCwgNjBdLFxyXG4gICAgICAgICAgICB3YXJBeGU6IFswLCA2MF0sXHJcbiAgICAgICAgICAgIG1hY2U6IFswLCA2NV0sXHJcbiAgICAgICAgICAgIGdyZWF0c3dvcmQ6IFswLCA2NV0sXHJcbiAgICAgICAgICAgIC8vIE5vdGU6IGJvdGggb2YgQmF0dGxlYXhlIGFuZCBXYXJoYW1tZXIgd2VhcG9uIHR5cGVzIGNvcnJlc3BvbmQgdG8gaWQ9Ni5cclxuICAgICAgICAgICAgYmF0dGxlYXhlOiBbMCwgNzBdLFxyXG4gICAgICAgICAgICB3YXJoYW1tZXI6IFswLCA3MF0sXHJcbiAgICAgICAgICAgIGJvdzogWzAsIDcwXSxcclxuICAgICAgICAgICAgc3RhZmY6IFswLCA3MF0sXHJcbiAgICAgICAgICAgIGNyb3NzYm93OiBbMCwgNzBdLFxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmdldFRpbWluZ3NGcm9tQ29uZmlnID0gZnVuY3Rpb24gKHdlYXBvbikge1xyXG4gICAgICAgIGlmICghd2VhcG9uKSB7XHJcbiAgICAgICAgICAgIHdlYXBvbiA9IDAgLyogV2VhcG9uVHlwZS5GaXN0ICovO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBza3ltcDUtY2xpZW50LXNldHRpbmdzLnR4dCBpcyBwZXJmZWN0bHkgZWRpdGFibGUgYnkgdXNlcnMsIHNvIHdlIGRvbid0IHVzZSBpdCBmb3Igbm93LlxyXG4gICAgICAgIC8vIEl0J3Mgd2VsbC10ZXN0ZWQgdGhvdWdoLCBzbyB3ZSBjYW4gZW5hYmxlIGl0IG9uY2Ugd2UgaGF2ZSBhIHByb3RlY3Rpb24gbWVjaGFuaXNtLlxyXG4gICAgICAgIC8vIGNvbnN0IHdlYXBvblRpbWluZ3MgPSB0aGlzLmdldFNldHRpbmdzRnJvbUZpbGUoKTtcclxuICAgICAgICB2YXIgd2VhcG9uVGltaW5ncyA9IHRoaXMuZ2V0U2V0dGluZ3NEZWZhdWx0KCk7XHJcbiAgICAgICAgaWYgKCF3ZWFwb25UaW1pbmdzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgd2VhcG9uVGltaW5nc1Jlc3VsdCA9IHtcclxuICAgICAgICAgICAgZmlzdDogWzAsIDBdLFxyXG4gICAgICAgICAgICBzd29yZDogWzAsIDBdLFxyXG4gICAgICAgICAgICBkYWdnZXI6IFswLCAwXSxcclxuICAgICAgICAgICAgd2FyQXhlOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIG1hY2U6IFswLCAwXSxcclxuICAgICAgICAgICAgZ3JlYXRzd29yZDogWzAsIDBdLFxyXG4gICAgICAgICAgICBiYXR0bGVheGU6IFswLCAwXSxcclxuICAgICAgICAgICAgd2FyaGFtbWVyOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIGJvdzogWzAsIDBdLFxyXG4gICAgICAgICAgICBzdGFmZjogWzAsIDBdLFxyXG4gICAgICAgICAgICBjcm9zc2JvdzogWzAsIDBdLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5maXN0ID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJmaXN0XCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuc3dvcmQgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcInN3b3JkXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuZGFnZ2VyID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJkYWdnZXJcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC53YXJBeGUgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcIndhckF4ZVwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0Lm1hY2UgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcIm1hY2VcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5ncmVhdHN3b3JkID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJncmVhdHN3b3JkXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuYmF0dGxlYXhlID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJiYXR0bGVheGVcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC53YXJoYW1tZXIgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcIndhcmhhbW1lclwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LmJvdyA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwiYm93XCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuc3RhZmYgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcInN0YWZmXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuY3Jvc3Nib3cgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcImNyb3NzYm93XCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHN3aXRjaCAod2VhcG9uKSB7XHJcbiAgICAgICAgICAgIGNhc2UgMCAvKiBXZWFwb25UeXBlLkZpc3QgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5maXN0O1xyXG4gICAgICAgICAgICBjYXNlIDEgLyogV2VhcG9uVHlwZS5Td29yZCAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LnN3b3JkO1xyXG4gICAgICAgICAgICBjYXNlIDIgLyogV2VhcG9uVHlwZS5EYWdnZXIgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5kYWdnZXI7XHJcbiAgICAgICAgICAgIGNhc2UgMyAvKiBXZWFwb25UeXBlLldhckF4ZSAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LndhckF4ZTtcclxuICAgICAgICAgICAgY2FzZSA0IC8qIFdlYXBvblR5cGUuTWFjZSAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0Lm1hY2U7XHJcbiAgICAgICAgICAgIGNhc2UgNSAvKiBXZWFwb25UeXBlLkdyZWF0c3dvcmQgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5ncmVhdHN3b3JkO1xyXG4gICAgICAgICAgICBjYXNlIDYgLyogV2VhcG9uVHlwZS5CYXR0bGVheGUgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5iYXR0bGVheGU7XHJcbiAgICAgICAgICAgIGNhc2UgNiAvKiBXZWFwb25UeXBlLldhcmhhbW1lciAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LndhcmhhbW1lcjtcclxuICAgICAgICAgICAgY2FzZSA3IC8qIFdlYXBvblR5cGUuQm93ICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuYm93O1xyXG4gICAgICAgICAgICBjYXNlIDggLyogV2VhcG9uVHlwZS5TdGFmZiAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LnN0YWZmO1xyXG4gICAgICAgICAgICBjYXNlIDkgLyogV2VhcG9uVHlwZS5Dcm9zc2JvdyAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LmNyb3NzYm93O1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJObyB0aW1pbmdzIGZvdW5kIGZvciB3ZWFwb24gdHlwZVwiLCB3ZWFwb24pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRUaW1pbmdzID0gZnVuY3Rpb24gKHdlYXBvbikge1xyXG4gICAgICAgIHZhciB0aW1pbmdzRnJvbUNvbmZpZyA9IHRoaXMuZ2V0VGltaW5nc0Zyb21Db25maWcod2VhcG9uKTtcclxuICAgICAgICBpZiAoIXdlYXBvbiB8fCAhdGltaW5nc0Zyb21Db25maWcpIHtcclxuICAgICAgICAgICAgd2VhcG9uID0gMCAvKiBXZWFwb25UeXBlLkZpc3QgKi87XHJcbiAgICAgICAgICAgIHRpbWluZ3NGcm9tQ29uZmlnID0gdGhpcy5nZXRUaW1pbmdzRnJvbUNvbmZpZyh3ZWFwb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRpbWluZ3NGcm9tQ29uZmlnKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiTm8gdGltaW5ncyBmb3VuZCBmb3Igd2VhcG9uIHR5cGVcIiwgd2VhcG9uKTtcclxuICAgICAgICAgICAgcmV0dXJuIFswLCAwXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRpbWluZ3NGcm9tQ29uZmlnO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5oYXNTd2VldFBpZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbW9kQ291bnQgPSB0aGlzLnNwLkdhbWUuZ2V0TW9kQ291bnQoKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZENvdW50OyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuR2FtZS5nZXRNb2ROYW1lKGkpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3N3ZWV0cGllJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGJyb3dzZXIgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSAnLi9jbGllbnRMaXN0ZW5lcic7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSAnLi4vLi4vbG9nZ2luZyc7XHJcbi8vIFRPRE86IG1vdmUgdG8gc2VydmVyL2dhbWVtb2RlXHJcbnZhciBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmFsdGFycyA9IFtcclxuICAgICAgICAgICAgMHgwMDEwMDc4MCwgMHgwMDBEOTg4MywgMHgwMDBEOTg3QiwgMHgwMDBEOTg4MSwgMHgwMDBEOTg4NywgMHgwMDBGQjk5NyxcclxuICAgICAgICAgICAgMHgwMDBEOTg4NSwgMHgwMDBEOTg3RCwgMHgwMDA3MTg1NCwgMHgwNzE4NzUwMCwgMHgwMjAwYzg2YiwgMHgwMDBkOTg3ZixcclxuICAgICAgICAgICAgMHgwNzA1OGQ0ZSwgMHgwNzA1OGQ1MywgMHgwNzBBNjkxMiwgMHgwNzA1OGQ1MSwgMHgwNzA1OGQ1MCwgMHgwNzA1OGQ0ZixcclxuICAgICAgICAgICAgMHgwNzA1OGQ0ZCwgMHgwNzA1OGQ0YywgMHgwNzA1OGQ0YiwgMHgwNzA1ZTJmYSwgMHgwNzA1OGQ0YSwgMHgwNzA1OGQ0OSxcclxuICAgICAgICAgICAgMHgwNzA1ZTM2NywgMHgwNzA1OGQ0OCwgMHgwNzA1OGQ1NSwgMHgwNzA1OGQ0NiwgMHgwNzA1OGQ0NywgMHgwNzA1ZTJiMCxcclxuICAgICAgICAgICAgMHgwNzA1OGQ0NVxyXG4gICAgICAgIF07XHJcbiAgICAgICAgaWYgKCFfdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZGlzYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGVuYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcImFjdGl2YXRlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkFjdGl2YXRlKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZS5wcm90b3R5cGUub25BY3RpdmF0ZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5hbHRhcnMuaW5jbHVkZXMoKChfYSA9IGV2ZW50LnRhcmdldC5nZXRCYXNlT2JqZWN0KCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGb3JtSUQoKSkgfHwgLTEpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgICAgIHZhciBzcmMgPSBcIndpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnaW5pdFNraWxsTWVudScpKVwiO1xyXG4gICAgICAgIGJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoc3JjKTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZS5wcm90b3R5cGUuaGFzU3dlZXRQaWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1vZENvdW50ID0gdGhpcy5zcC5HYW1lLmdldE1vZENvdW50KCk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLkdhbWUuZ2V0TW9kTmFtZShpKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdzd2VldHBpZScpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgLy8gVE9ETzogbW92ZSB0aGlzIHRvIGNvbmZpZ1xyXG4gICAgICAgIF90aGlzLnN0ZWFsdGggPSBbMHhCRTEyNiwgMHhDMDdDNiwgMHhDMDdDNywgMHhDMDdDOCwgMHhDMDdDOV07XHJcbiAgICAgICAgX3RoaXMubWFnaWMgPSBbMHg1ODIxMywgMHgxMDVGMjQsIDB4NTgyMTRdO1xyXG4gICAgICAgIF90aGlzLndhcnJpb3IgPSBbMHhDQjQwRCwgMHhDQjQwRiwgMHhDQjQxNCwgMHhDQjQxMSwgMHhDQjQxMiwgMHhDQjQxMCwgMHhDQjQwRV07XHJcbiAgICAgICAgaWYgKCFfdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZGlzYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGVuYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmFkZFN0YXRpY1BlcmtzVG9UaGVQbGF5ZXIoKTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5hZGRTdGF0aWNQZXJrc1RvVGhlUGxheWVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHBsYXllciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICB2YXIgYWxsU3RhdGljUGVya0lkcyA9IHRoaXMuc3RlYWx0aC5jb25jYXQodGhpcy5tYWdpYykuY29uY2F0KHRoaXMud2Fycmlvcik7XHJcbiAgICAgICAgYWxsU3RhdGljUGVya0lkcy5mb3JFYWNoKGZ1bmN0aW9uIChwZXJrSWQpIHtcclxuICAgICAgICAgICAgcGxheWVyLmFkZFBlcmsoX3RoaXMuc3AuUGVyay5mcm9tKF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHBlcmtJZCkpKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5oYXNTd2VldFBpZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbW9kQ291bnQgPSB0aGlzLnNwLkdhbWUuZ2V0TW9kQ291bnQoKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZENvdW50OyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuR2FtZS5nZXRNb2ROYW1lKGkpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3N3ZWV0cGllJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbi8vIFRPRE86IG1vdmUgdG8gdGhlIHNlcnZlci9nYW1lbW9kZVxyXG52YXIgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jYW50RHJvcEtleXdvcmQgPSBcIlN3ZWV0Q2FudERyb3BcIjtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UucHJvdG90eXBlLmNhbkRyb3BPclB1dEl0ZW0gPSBmdW5jdGlvbiAoaXRlbUlkKSB7XHJcbiAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGl0ZW1JZCk7XHJcbiAgICAgICAgaWYgKGl0ZW0gIT09IG51bGwpIHtcclxuICAgICAgICAgICAgaWYgKGl0ZW0uaGFzS2V5d29yZCh0aGlzLnNwLktleXdvcmQuZ2V0S2V5d29yZCh0aGlzLmNhbnREcm9wS2V5d29yZCkpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIFRpbWVTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFRpbWVTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gVGltZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMubGFzdFRpbWVVcGQgPSAwO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgVGltZVNlcnZpY2UucHJvdG90eXBlLmdldFRpbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGhvdXJzT2Zmc2V0U2V0dGluZyA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiaG91cnNPZmZzZXRcIl07XHJcbiAgICAgICAgdmFyIGhvdXJzT2Zmc2V0ID0gdHlwZW9mIGhvdXJzT2Zmc2V0U2V0dGluZyA9PT0gXCJudW1iZXJcIiA/IGhvdXJzT2Zmc2V0U2V0dGluZyA6IDA7XHJcbiAgICAgICAgdmFyIGhvdXJzT2Zmc2V0TXMgPSBob3Vyc09mZnNldCAqIDYwICogNjAgKiAxMDAwO1xyXG4gICAgICAgIHZhciBkID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIGhvdXJzT2Zmc2V0TXMpO1xyXG4gICAgICAgIHZhciBuZXdHYW1lSG91clZhbHVlID0gMDtcclxuICAgICAgICBuZXdHYW1lSG91clZhbHVlICs9IGQuZ2V0VVRDSG91cnMoKTtcclxuICAgICAgICBuZXdHYW1lSG91clZhbHVlICs9IGQuZ2V0VVRDTWludXRlcygpIC8gNjA7XHJcbiAgICAgICAgbmV3R2FtZUhvdXJWYWx1ZSArPSBkLmdldFVUQ1NlY29uZHMoKSAvIDYwIC8gNjA7XHJcbiAgICAgICAgbmV3R2FtZUhvdXJWYWx1ZSArPSBkLmdldFVUQ01pbGxpc2Vjb25kcygpIC8gNjAgLyA2MCAvIDEwMDA7XHJcbiAgICAgICAgcmV0dXJuIHsgbmV3R2FtZUhvdXJWYWx1ZTogbmV3R2FtZUhvdXJWYWx1ZSwgZGF0ZTogZCB9O1xyXG4gICAgfTtcclxuICAgIFRpbWVTZXJ2aWNlLnByb3RvdHlwZS5ldmVyeTJzZWNvbmRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBnYW1lSG91cklkID0gMHgzODtcclxuICAgICAgICB2YXIgZ2FtZU1vbnRoSWQgPSAweDM2O1xyXG4gICAgICAgIHZhciBnYW1lRGF5SWQgPSAweDM3O1xyXG4gICAgICAgIHZhciBnYW1lWWVhcklkID0gMHgzNTtcclxuICAgICAgICB2YXIgdGltZVNjYWxlSWQgPSAweDNhO1xyXG4gICAgICAgIHZhciBnYW1lSG91ciA9IHRoaXMuc3AuR2xvYmFsVmFyaWFibGUuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGdhbWVIb3VySWQpKTtcclxuICAgICAgICB2YXIgZ2FtZURheSA9IHRoaXMuc3AuR2xvYmFsVmFyaWFibGUuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGdhbWVEYXlJZCkpO1xyXG4gICAgICAgIHZhciBnYW1lTW9udGggPSB0aGlzLnNwLkdsb2JhbFZhcmlhYmxlLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeChnYW1lTW9udGhJZCkpO1xyXG4gICAgICAgIHZhciBnYW1lWWVhciA9IHRoaXMuc3AuR2xvYmFsVmFyaWFibGUuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGdhbWVZZWFySWQpKTtcclxuICAgICAgICB2YXIgdGltZVNjYWxlID0gdGhpcy5zcC5HbG9iYWxWYXJpYWJsZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgodGltZVNjYWxlSWQpKTtcclxuICAgICAgICBpZiAoIWdhbWVIb3VyIHx8ICFnYW1lRGF5IHx8ICFnYW1lTW9udGggfHwgIWdhbWVZZWFyIHx8ICF0aW1lU2NhbGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgX2EgPSB0aGlzLmdldFRpbWUoKSwgbmV3R2FtZUhvdXJWYWx1ZSA9IF9hLm5ld0dhbWVIb3VyVmFsdWUsIGRhdGUgPSBfYS5kYXRlO1xyXG4gICAgICAgIHZhciBkaWZmID0gTWF0aC5hYnMoZ2FtZUhvdXIuZ2V0VmFsdWUoKSAtIG5ld0dhbWVIb3VyVmFsdWUpO1xyXG4gICAgICAgIGlmIChkaWZmID49IDEgLyA2MCkge1xyXG4gICAgICAgICAgICBnYW1lSG91ci5zZXRWYWx1ZShuZXdHYW1lSG91clZhbHVlKTtcclxuICAgICAgICAgICAgZ2FtZURheS5zZXRWYWx1ZShkYXRlLmdldFVUQ0RhdGUoKSk7XHJcbiAgICAgICAgICAgIGdhbWVNb250aC5zZXRWYWx1ZShkYXRlLmdldFVUQ01vbnRoKCkpO1xyXG4gICAgICAgICAgICBnYW1lWWVhci5zZXRWYWx1ZShkYXRlLmdldFVUQ0Z1bGxZZWFyKCkgLSAyMDIwICsgMTk5KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGltZVNjYWxlLnNldFZhbHVlKGdhbWVIb3VyLmdldFZhbHVlKCkgPiBuZXdHYW1lSG91clZhbHVlID8gMC42IDogMS4yKTtcclxuICAgIH07XHJcbiAgICBUaW1lU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKERhdGUubm93KCkgLSB0aGlzLmxhc3RUaW1lVXBkIDw9IDIwMDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxhc3RUaW1lVXBkID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB0aGlzLmV2ZXJ5MnNlY29uZHMoKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gVGltZVNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgVGltZVNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIFByb2Nlc3NNZXRob2RUeXBlO1xyXG4oZnVuY3Rpb24gKFByb2Nlc3NNZXRob2RUeXBlKSB7XHJcbiAgICBQcm9jZXNzTWV0aG9kVHlwZVtcInVwZGF0ZVwiXSA9IFwidXBkYXRlXCI7XHJcbiAgICBQcm9jZXNzTWV0aG9kVHlwZVtcInRpY2tcIl0gPSBcInRpY2tcIjtcclxufSkoUHJvY2Vzc01ldGhvZFR5cGUgfHwgKFByb2Nlc3NNZXRob2RUeXBlID0ge30pKTtcclxudmFyIFRpbWVyc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoVGltZXJzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFRpbWVyc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMudGltZXJzQXJyID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgX3RoaXMuaW50ZXJ2YWxzQXJyID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgX3RoaXMubGFzdENhbGxUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBfdGhpcy5wcm9jZXNzTWV0aG9kVHlwZVN0b3JhZ2VLZXkgPSBcInVwZGF0ZVR5cGVTdG9yYWdlS2V5XCI7XHJcbiAgICAgICAgdmFyIHN0b3JhZ2VQcm9jZXNzTWV0aG9kID0gc3Auc3RvcmFnZVtfdGhpcy5wcm9jZXNzTWV0aG9kVHlwZVN0b3JhZ2VLZXldO1xyXG4gICAgICAgIGlmICh0eXBlb2Ygc3RvcmFnZVByb2Nlc3NNZXRob2QgIT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgICAgICBfdGhpcy5zZXRQcm9jZXNzTWV0aG9kKHN0b3JhZ2VQcm9jZXNzTWV0aG9kKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIF90aGlzLnNldFByb2Nlc3NNZXRob2QoUHJvY2Vzc01ldGhvZFR5cGUudGljayk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJtZW51T3BlblwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25NZW51T3BlbihlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInByZUxvYWRHYW1lXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uUHJlTG9hZEdhbWUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUuc2V0VGltZW91dCA9IGZ1bmN0aW9uIChoYW5kbGVyLCB0aW1lb3V0KSB7XHJcbiAgICAgICAgdmFyIGFyZ3MgPSBbXTtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDI7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICBhcmdzW19pIC0gMl0gPSBhcmd1bWVudHNbX2ldO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdGltZXIgPSB7IGhhbmRsZXI6IGhhbmRsZXIsIGFyZ3M6IGFyZ3MsIGRlbGF5TXM6IHRpbWVvdXQgIT09IG51bGwgJiYgdGltZW91dCAhPT0gdm9pZCAwID8gdGltZW91dCA6IDAsIHBhc3NlZE1zOiAwIH07XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnRpbWVyc0Fyci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMudGltZXJzQXJyW2ldKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpbWVyc0FycltpXSA9IHRpbWVyO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGkgKyAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLnRpbWVyc0Fyci5wdXNoKHRpbWVyKTtcclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5jbGVhclRpbWVvdXQgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aGlzLnRpbWVyc0FyciA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpZCA8PSAwIHx8IGlkID4gdGhpcy50aW1lcnNBcnIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy50aW1lcnNBcnJbaWQgLSAxXSA9IG51bGw7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLnNldEludGVydmFsID0gZnVuY3Rpb24gKGhhbmRsZXIsIHRpbWVvdXQpIHtcclxuICAgICAgICB2YXIgYXJncyA9IFtdO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMjsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIGFyZ3NbX2kgLSAyXSA9IGFyZ3VtZW50c1tfaV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0aW1lciA9IHsgaGFuZGxlcjogaGFuZGxlciwgYXJnczogYXJncywgZGVsYXlNczogdGltZW91dCAhPT0gbnVsbCAmJiB0aW1lb3V0ICE9PSB2b2lkIDAgPyB0aW1lb3V0IDogMCwgcGFzc2VkTXM6IDAgfTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaW50ZXJ2YWxzQXJyLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnRlcnZhbHNBcnJbaV0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJ2YWxzQXJyW2ldID0gdGltZXI7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaSArIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJ2YWxzQXJyLnB1c2godGltZXIpO1xyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLmNsZWFySW50ZXJ2YWwgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aGlzLmludGVydmFsc0FyciA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpZCA8PSAwIHx8IGlkID4gdGhpcy5pbnRlcnZhbHNBcnIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbnRlcnZhbHNBcnJbaWQgLSAxXSA9IG51bGw7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLnNldFByb2Nlc3NNZXRob2QgPSBmdW5jdGlvbiAobWV0aG9kKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBzd2l0Y2ggKG1ldGhvZCkge1xyXG4gICAgICAgICAgICBjYXNlIFByb2Nlc3NNZXRob2RUeXBlLnRpY2s6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbdGhpcy5wcm9jZXNzTWV0aG9kVHlwZVN0b3JhZ2VLZXldID0gUHJvY2Vzc01ldGhvZFR5cGUudGljaztcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRXZlbnRIYW5kbGUgPSB0aGlzLmNvbnRyb2xsZXIub24oUHJvY2Vzc01ldGhvZFR5cGUudGljaywgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMucHJvY2Vzc1RpbWVycygpOyB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgY2FzZSBQcm9jZXNzTWV0aG9kVHlwZS51cGRhdGU6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbdGhpcy5wcm9jZXNzTWV0aG9kVHlwZVN0b3JhZ2VLZXldID0gUHJvY2Vzc01ldGhvZFR5cGUudXBkYXRlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVFdmVudEhhbmRsZSA9IHRoaXMuY29udHJvbGxlci5vbihQcm9jZXNzTWV0aG9kVHlwZS51cGRhdGUsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLnByb2Nlc3NUaW1lcnMoKTsgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gRklYTUUoR00tMTAwOClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldFByb2Nlc3NNZXRob2QoUHJvY2Vzc01ldGhvZFR5cGUudXBkYXRlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKF9hKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvY2Vzc01ldGhvZChQcm9jZXNzTWV0aG9kVHlwZS50aWNrKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUucHJvY2Vzc1RpbWVycyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgZHQgPSBEYXRlLm5vdygpIC0gdGhpcy5sYXN0Q2FsbFRpbWU7XHJcbiAgICAgICAgdGhpcy5sYXN0Q2FsbFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIC8vIHByb2Nlc3MgdGltZXJzXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnRpbWVyc0Fyci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICB2YXIgdGltZXIgPSB0aGlzLnRpbWVyc0FycltpXTtcclxuICAgICAgICAgICAgaWYgKHRpbWVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aW1lci5wYXNzZWRNcyArPSBkdDtcclxuICAgICAgICAgICAgICAgIGlmICh0aW1lci5wYXNzZWRNcyA+PSB0aW1lci5kZWxheU1zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50aW1lcnNBcnJbaV0gPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGltZXIuaGFuZGxlciA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyLmhhbmRsZXIuY2FsbCh0aGlzLCB0aW1lci5hcmdzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2YWwodGltZXIuaGFuZGxlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGkgPT09IHRoaXMudGltZXJzQXJyLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBsYXN0IHVudXNlZCBlbGVtZW50XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpbWVyc0Fyci5sZW5ndGggLT0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBwcm9jZXNzIGludGVydmFsc1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5pbnRlcnZhbHNBcnIubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGludGVydmFsID0gdGhpcy5pbnRlcnZhbHNBcnJbaV07XHJcbiAgICAgICAgICAgIGlmIChpbnRlcnZhbCkge1xyXG4gICAgICAgICAgICAgICAgaW50ZXJ2YWwucGFzc2VkTXMgKz0gZHQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW50ZXJ2YWwucGFzc2VkTXMgPj0gaW50ZXJ2YWwuZGVsYXlNcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGludGVydmFsLnBhc3NlZE1zID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGludGVydmFsLmhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbC5oYW5kbGVyLmNhbGwodGhpcywgaW50ZXJ2YWwuYXJncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmFsKGludGVydmFsLmhhbmRsZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChpID09PSB0aGlzLmludGVydmFsc0Fyci5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAvLyByZW1vdmUgbGFzdCB1bnVzZWQgZWxlbWVudFxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcnZhbHNBcnIubGVuZ3RoIC09IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUub25NZW51T3BlbiA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKGUubmFtZSA9PT0gXCJNYWluIE1lbnVcIiAvKiBNZW51Lk1haW4gKi8pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudXBkYXRlRXZlbnRIYW5kbGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AudW5zdWJzY3JpYmUodGhpcy51cGRhdGVFdmVudEhhbmRsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZXRQcm9jZXNzTWV0aG9kKFByb2Nlc3NNZXRob2RUeXBlLnRpY2spO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5vblByZUxvYWRHYW1lID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZUV2ZW50SGFuZGxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AudW5zdWJzY3JpYmUodGhpcy51cGRhdGVFdmVudEhhbmRsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0UHJvY2Vzc01ldGhvZChQcm9jZXNzTWV0aG9kVHlwZS51cGRhdGUpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBUaW1lcnNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFRpbWVyc1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IGxvZ1RyYWNlLCBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4vcmVtb3RlU2VydmVyXCI7XHJcbnZhciBWb2ljZUNoYXRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFZvaWNlQ2hhdFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBWb2ljZUNoYXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5pc1RhbGtpbmcgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5wdXNoVG9UYWxrS2V5ID0gMHg1NjsgLy8gViBrZXlcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblRpY2soKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5vbkNvbm5lY3QgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gVm9pY2UgY2hhdCBpbml0aWFsaXphdGlvbiBoYW5kbGVkIGVsc2V3aGVyZSBmb3Igbm93XHJcbiAgICAgICAgbG9nVHJhY2UoXCJWb2ljZUNoYXRTZXJ2aWNlOiBDb25uZWN0ZWRcIik7XHJcbiAgICB9O1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUub25EaXNjb25uZWN0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzVGFsa2luZykge1xyXG4gICAgICAgICAgICB0aGlzLnN0b3BUYWxraW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaXNJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgfTtcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLm9uVGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIENoZWNrIHB1c2gtdG8tdGFsayBrZXkgc3RhdGVcclxuICAgICAgICB2YXIga2V5UHJlc3NlZCA9IHRoaXMuc3AuSW5wdXQuaXNLZXlQcmVzc2VkKHRoaXMucHVzaFRvVGFsa0tleSk7XHJcbiAgICAgICAgaWYgKGtleVByZXNzZWQgJiYgIXRoaXMuaXNUYWxraW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhcnRUYWxraW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKCFrZXlQcmVzc2VkICYmIHRoaXMuaXNUYWxraW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcFRhbGtpbmcoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gSGFuZGxlIGNvbnRpbnVvdXMgdm9pY2UgY2hhdCB1cGRhdGVzIGlmIG5lZWRlZFxyXG4gICAgfTtcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLnN0YXJ0VGFsa2luZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmlzVGFsa2luZyA9IHRydWU7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKFwiVm9pY2VDaGF0U2VydmljZTogU3RhcnRlZCB0YWxraW5nXCIpO1xyXG4gICAgICAgICAgICAvLyBBY3R1YWwgdm9pY2UgY2FwdHVyZSBoYW5kbGVkIGJ5IHVuZGVybHlpbmcgc3lzdGVtXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcihcIlZvaWNlQ2hhdFNlcnZpY2U6IEZhaWxlZCB0byBzdGFydCB0YWxraW5nOiBcIi5jb25jYXQoZXJyb3IpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUuc3RvcFRhbGtpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5pc1RhbGtpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgbG9nVHJhY2UoXCJWb2ljZUNoYXRTZXJ2aWNlOiBTdG9wcGVkIHRhbGtpbmdcIik7XHJcbiAgICAgICAgICAgIC8vIEFjdHVhbCB2b2ljZSBjYXB0dXJlIHN0b3BwaW5nIGhhbmRsZWQgYnkgdW5kZXJseWluZyBzeXN0ZW1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKFwiVm9pY2VDaGF0U2VydmljZTogRmFpbGVkIHRvIHN0b3AgdGFsa2luZzogXCIuY29uY2F0KGVycm9yKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8vIEhhbmRsZSBpbmNvbWluZyB2b2ljZSBjaGF0IGRhdGEgZnJvbSBvdGhlciBwbGF5ZXJzXHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5vblJlY2VpdmVWb2ljZURhdGEgPSBmdW5jdGlvbiAoc3BlYWtlcklkLCBhdWRpb0RhdGEsIHgsIHksIHopIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIFZvaWNlIHBsYXliYWNrIGhhbmRsZWQgYnkgdW5kZXJseWluZyBzeXN0ZW1cclxuICAgICAgICAgICAgbG9nVHJhY2UoXCJWb2ljZUNoYXRTZXJ2aWNlOiBSZWNlaXZlZCB2b2ljZSBkYXRhIGZyb20gXCIuY29uY2F0KHNwZWFrZXJJZCwgXCIgYXQgKFwiKS5jb25jYXQoeCwgXCIsIFwiKS5jb25jYXQoeSwgXCIsIFwiKS5jb25jYXQoeiwgXCIpXCIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKFwiVm9pY2VDaGF0U2VydmljZTogRmFpbGVkIHRvIHByb2Nlc3Mgdm9pY2UgZGF0YTogXCIuY29uY2F0KGVycm9yKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8vIEhhbmRsZSBiaW5hcnkgdm9pY2UgcGFja2V0cyByZWNlaXZlZCBmcm9tIHRoZSBzZXJ2ZXJcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLm9uUGFja2V0ID0gZnVuY3Rpb24gKHR5cGUsIHJhd0NvbnRlbnQsIGVycm9yKSB7XHJcbiAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKFwiVm9pY2VDaGF0U2VydmljZTogUGFja2V0IGVycm9yOiBcIi5jb25jYXQoZXJyb3IpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXJhd0NvbnRlbnQgfHwgcmF3Q29udGVudC5ieXRlTGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBpcyBhIGJpbmFyeSB2b2ljZSBwYWNrZXRcclxuICAgICAgICB2YXIgZGF0YSA9IG5ldyBVaW50OEFycmF5KHJhd0NvbnRlbnQpO1xyXG4gICAgICAgIGlmIChkYXRhWzBdID09PSAxMzUpIHsgLy8gQmluYXJ5Vm9pY2VQYWNrZXRJZFxyXG4gICAgICAgICAgICBpZiAocmF3Q29udGVudC5ieXRlTGVuZ3RoID49IDkpIHtcclxuICAgICAgICAgICAgICAgIC8vIEV4dHJhY3Qgc3BlYWtlciBJRCAoNCBieXRlcylcclxuICAgICAgICAgICAgICAgIHZhciBzcGVha2VySWRCeXRlcyA9IGRhdGEuc2xpY2UoMSwgNSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3BlYWtlcklkXzEgPSBuZXcgRGF0YVZpZXcoc3BlYWtlcklkQnl0ZXMuYnVmZmVyKS5nZXRVaW50MzIoMCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAvLyBFeHRyYWN0IGRhdGEgc2l6ZSAoNCBieXRlcylcclxuICAgICAgICAgICAgICAgIHZhciBkYXRhU2l6ZUJ5dGVzID0gZGF0YS5zbGljZSg1LCA5KTtcclxuICAgICAgICAgICAgICAgIHZhciBkYXRhU2l6ZSA9IG5ldyBEYXRhVmlldyhkYXRhU2l6ZUJ5dGVzLmJ1ZmZlcikuZ2V0VWludDMyKDAsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJhd0NvbnRlbnQuYnl0ZUxlbmd0aCA9PT0gOSArIGRhdGFTaXplKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBhdWRpbyBkYXRhXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGF1ZGlvRGF0YSA9IGRhdGEuc2xpY2UoOSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHNwZWFrZXIgcG9zaXRpb24gZnJvbSB3b3JsZCBtb2RlbFxyXG4gICAgICAgICAgICAgICAgICAgIHZhciByZW1vdGVTZXJ2ZXIgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmVtb3RlU2VydmVyKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgd29ybGRNb2RlbCA9IHJlbW90ZVNlcnZlci5nZXRXb3JsZE1vZGVsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHggPSAwLCB5ID0gMCwgeiA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gRmluZCB0aGUgc3BlYWtlciBpbiB0aGUgd29ybGQgbW9kZWwgdG8gZ2V0IHBvc2l0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwZWFrZXJGb3JtID0gd29ybGRNb2RlbC5mb3Jtcy5maW5kKGZ1bmN0aW9uIChmKSB7IHJldHVybiBmICYmIGYucmVmcklkID09PSBzcGVha2VySWRfMTsgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWFrZXJGb3JtICYmIHNwZWFrZXJGb3JtLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHggPSBzcGVha2VyRm9ybS5tb3ZlbWVudC5wb3NbMF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBzcGVha2VyRm9ybS5tb3ZlbWVudC5wb3NbMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHogPSBzcGVha2VyRm9ybS5tb3ZlbWVudC5wb3NbMl07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25SZWNlaXZlVm9pY2VEYXRhKHNwZWFrZXJJZF8xLCBhdWRpb0RhdGEuYnVmZmVyLCB4LCB5LCB6KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvLyBHZXQgY3VycmVudCBwdXNoLXRvLXRhbGsga2V5XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRQdXNoVG9UYWxrS2V5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnB1c2hUb1RhbGtLZXk7XHJcbiAgICB9O1xyXG4gICAgLy8gU2V0IHB1c2gtdG8tdGFsayBrZXlcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLnNldFB1c2hUb1RhbGtLZXkgPSBmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNUYWxraW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcFRhbGtpbmcoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5wdXNoVG9UYWxrS2V5ID0ga2V5O1xyXG4gICAgfTtcclxuICAgIC8vIENoZWNrIGlmIGN1cnJlbnRseSB0YWxraW5nXHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRJc1RhbGtpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNUYWxraW5nO1xyXG4gICAgfTtcclxuICAgIC8vIENoZWNrIGlmIHZvaWNlIGNoYXQgaXMgaW5pdGlhbGl6ZWRcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLmdldElzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNJbml0aWFsaXplZDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gVm9pY2VDaGF0U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBWb2ljZUNoYXRTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSBcIi4uLy4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXhcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgV29ybGRDbGVhbmVyU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhXb3JsZENsZWFuZXJTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gV29ybGRDbGVhbmVyU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5wcm90ZWN0aW9uID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiZ2FtZUxvYWRcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25HYW1lTG9hZCgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBXb3JsZENsZWFuZXJTZXJ2aWNlLnByb3RvdHlwZS5tb2RXY1Byb3RlY3Rpb24gPSBmdW5jdGlvbiAoYWN0b3JJZCwgbW9kKSB7XHJcbiAgICAgICAgdmFyIGN1cnJlbnRQcm90ZWN0aW9uID0gdGhpcy5wcm90ZWN0aW9uLmdldChhY3RvcklkKTtcclxuICAgICAgICB0aGlzLnByb3RlY3Rpb24uc2V0KGFjdG9ySWQsIGN1cnJlbnRQcm90ZWN0aW9uID8gY3VycmVudFByb3RlY3Rpb24gKyBtb2QgOiBtb2QpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkQ2xlYW5lclNlcnZpY2UucHJvdG90eXBlLmdldFdjUHJvdGVjdGlvbiA9IGZ1bmN0aW9uIChhY3RvcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdGVjdGlvbi5nZXQoYWN0b3JJZCkgfHwgMDtcclxuICAgIH07XHJcbiAgICBXb3JsZENsZWFuZXJTZXJ2aWNlLnByb3RvdHlwZS5vbkdhbWVMb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgaWYgKCFwbGF5ZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmluaXRpYWxQb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MocGxheWVyKTtcclxuICAgICAgICB0aGlzLmluaXRpYWxDZWxsT3JXb3JsZCA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsKHBsYXllcik7XHJcbiAgICB9O1xyXG4gICAgV29ybGRDbGVhbmVyU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzT25lQWN0b3IoKTtcclxuICAgIH07XHJcbiAgICBXb3JsZENsZWFuZXJTZXJ2aWNlLnByb3RvdHlwZS5wcm9jZXNzT25lQWN0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIHBjID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIGlmIChwYyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhY3RvciA9IHRoaXMuc3AuR2FtZS5maW5kUmFuZG9tQWN0b3IocGMuZ2V0UG9zaXRpb25YKCksIHBjLmdldFBvc2l0aW9uWSgpLCBwYy5nZXRQb3NpdGlvblooKSwgODE5Mik7XHJcbiAgICAgICAgaWYgKGFjdG9yID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFjdG9ySWQgPSBhY3Rvci5nZXRGb3JtSUQoKTtcclxuICAgICAgICB2YXIgY3VycmVudFByb3RlY3Rpb24gPSB0aGlzLnByb3RlY3Rpb24uZ2V0KGFjdG9ySWQpIHx8IDA7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRQcm90ZWN0aW9uID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhY3RvcklkID09PSAweDE0IHx8IGFjdG9yLmlzRGlzYWJsZWQoKSB8fCBhY3Rvci5pc0RlbGV0ZWQoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmlzQWN0b3JJbkRpYWxvZ3VlKGFjdG9yKSkge1xyXG4gICAgICAgICAgICAvLyBEZWxldGluZyBhY3RvciBpbiBkaWFsb2d1ZSBjcmFzaGVzIFNreXJpbVxyXG4gICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vc2t5cmltLW11bHRpcGxheWVyL2lzc3VlLXRyYWNrZXIvaXNzdWVzLzEzXHJcbiAgICAgICAgICAgIGFjdG9yLnNldFBvc2l0aW9uKDAsIDAsIDApO1xyXG4gICAgICAgICAgICBhY3Rvci5kaXNhYmxlTm9XYWl0KHRydWUpOyAvLyBTZWVtcyB0byBub3QgY3Jhc2hcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBLZWVwIHZhbmlsYSBwcmUtcGxhY2VkIGJvZGllcywgYnV0IGRlbGV0ZSBwbGF5ZXIgYm9kaWVzXHJcbiAgICAgICAgaWYgKGFjdG9yLmlzRGVhZCgpICYmIGFjdG9ySWQgPCAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgIGFjdG9yLmJsb2NrQWN0aXZhdGlvbih0cnVlKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKGFjdG9yKTtcclxuICAgICAgICB2YXIgY2VsbE9yV29ybGQgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbChhY3Rvcik7XHJcbiAgICAgICAgdmFyIGNoaWNrZW5SYWNlID0gMHhhOTE5ZDtcclxuICAgICAgICAvLyBXZSBkaXNjb3ZlcmVkIGFub21hbHkgY2hpY2tlbnMgdGhhdCBmYWlsIHRvIERpc2FibGUgaWYgd2UgbG9hZCBnYW1lIG5lYXIgdG8gdGhlbVxyXG4gICAgICAgIC8vIFJlZnM6IDEwNkMyMiwgMTA2QzIzXHJcbiAgICAgICAgaWYgKGFjdG9ySWQgPCAweGZmMDAwMDAwICYmICgoX2EgPSBhY3Rvci5nZXRSYWNlKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGb3JtSUQoKSkgPT09IGNoaWNrZW5SYWNlKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXRpYWxQb3MgJiYgT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2VOb1oocG9zLCB0aGlzLmluaXRpYWxQb3MpIDwgNDA5Nikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGxPcldvcmxkID09PSB0aGlzLmluaXRpYWxDZWxsT3JXb3JsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzQWN0b3JJbkRpYWxvZ3VlKGFjdG9yKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiRGVsZXRpbmcgY2hpY2tlbiBhbm9tYWx5XCIsIGFjdG9ySWQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICBhY3Rvci5raWxsU2lsZW50KG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdG9yLmJsb2NrQWN0aXZhdGlvbih0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBhY3Rvci5kaXNhYmxlTm9XYWl0KGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICBhY3Rvci5zZXRBbHBoYSgwLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFjdG9yLmRpc2FibGUoZmFsc2UpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBfdGhpcy5zcC5BY3Rvci5mcm9tKF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGFjdG9ySWQpKTtcclxuICAgICAgICAgICAgaWYgKCFhYyB8fCBfdGhpcy5pc0FjdG9ySW5EaWFsb2d1ZShhYykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhYy5kZWxldGUoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBXb3JsZENsZWFuZXJTZXJ2aWNlLnByb3RvdHlwZS5pc0FjdG9ySW5EaWFsb2d1ZSA9IGZ1bmN0aW9uIChhYykge1xyXG4gICAgICAgIHJldHVybiBhYy5pc0luRGlhbG9ndWVXaXRoUGxheWVyKCkgfHwgYWMuZ2V0RGlhbG9ndWVUYXJnZXQoKSAhPT0gbnVsbDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gV29ybGRDbGVhbmVyU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBXb3JsZENsZWFuZXJTZXJ2aWNlIH07XHJcbiIsImltcG9ydCB7IEV2ZW50RW1pdHRlckZhY3RvcnkgfSBmcm9tIFwiLi9ldmVudHMvZXZlbnRzXCI7XHJcbmltcG9ydCAqIGFzIHNwIGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG52YXIgU3BBcGlJbnRlcmFjdG9yID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gU3BBcGlJbnRlcmFjdG9yKCkge1xyXG4gICAgfVxyXG4gICAgU3BBcGlJbnRlcmFjdG9yLnNldHVwID0gZnVuY3Rpb24gKGxpc3RlbmVycykge1xyXG4gICAgICAgIGxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChsaXN0ZW5lcikgeyByZXR1cm4gU3BBcGlJbnRlcmFjdG9yLnJlZ2lzdGVyTGlzdGVuZXJGb3JMb29rdXAobGlzdGVuZXIuY29uc3RydWN0b3IsIGxpc3RlbmVyKTsgfSk7XHJcbiAgICB9O1xyXG4gICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoU3BBcGlJbnRlcmFjdG9yLmNvbnRyb2xsZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFNwQXBpSW50ZXJhY3Rvci5jb250cm9sbGVyO1xyXG4gICAgICAgIH1cclxuICAgICAgICBTcEFwaUludGVyYWN0b3IuY29udHJvbGxlciA9IHtcclxuICAgICAgICAgICAgLy8gVE9ETzogaGFuZGxlIGVycm9ycyBpbiBldmVudCBoYW5kbGVycy4gd2lsbCBvdXRwdXQgdG8gZ2FtZSBjb25zb2xlIGJ5IGRlZmF1bHRcclxuICAgICAgICAgICAgb246IHNwLm9uLFxyXG4gICAgICAgICAgICBvbmNlOiBzcC5vbmNlLFxyXG4gICAgICAgICAgICBlbWl0dGVyOiBFdmVudEVtaXR0ZXJGYWN0b3J5Lm1ha2VFdmVudEVtaXR0ZXIoKSxcclxuICAgICAgICAgICAgbG9va3VwTGlzdGVuZXI6IGZ1bmN0aW9uIChjb25zdHJ1Y3Rvcikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0gU3BBcGlJbnRlcmFjdG9yLmxpc3RlbmVyc0Zvckxvb2t1cEJ5TmFtZS5nZXQoY29uc3RydWN0b3IpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJsaXN0ZW5lciBub3QgZm91bmQgZm9yIG5hbWUgJ1wiLmNvbmNhdChjb25zdHJ1Y3Rvci5uYW1lLCBcIidcIikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCEobGlzdGVuZXIgaW5zdGFuY2VvZiBjb25zdHJ1Y3RvcikpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJsaXN0ZW5lciBjbGFzcyBtaXNtYXRjaCBmb3IgbmFtZSAnXCIuY29uY2F0KGNvbnN0cnVjdG9yLm5hbWUsIFwiJ1wiKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gU3BBcGlJbnRlcmFjdG9yLmNvbnRyb2xsZXI7XHJcbiAgICB9O1xyXG4gICAgU3BBcGlJbnRlcmFjdG9yLnJlZ2lzdGVyTGlzdGVuZXJGb3JMb29rdXAgPSBmdW5jdGlvbiAoY29uc3RydWN0b3IsIGxpc3RlbmVyKSB7XHJcbiAgICAgICAgaWYgKFNwQXBpSW50ZXJhY3Rvci5saXN0ZW5lcnNGb3JMb29rdXBCeU5hbWUuaGFzKGNvbnN0cnVjdG9yKSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJsaXN0ZW5lciByZS1yZWdpc3RyYXRpb24gZm9yIG5hbWUgJ1wiLmNvbmNhdChjb25zdHJ1Y3RvciwgXCInXCIpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmxpc3RlbmVyc0Zvckxvb2t1cEJ5TmFtZS5zZXQoY29uc3RydWN0b3IsIGxpc3RlbmVyKTtcclxuICAgIH07XHJcbiAgICBTcEFwaUludGVyYWN0b3IubGlzdGVuZXJzRm9yTG9va3VwQnlOYW1lID0gbmV3IE1hcCgpO1xyXG4gICAgcmV0dXJuIFNwQXBpSW50ZXJhY3RvcjtcclxufSgpKTtcclxuZXhwb3J0IHsgU3BBcGlJbnRlcmFjdG9yIH07XHJcbiIsImV4cG9ydCB2YXIgZ2V0QWN0b3JWYWx1ZXMgPSBmdW5jdGlvbiAoYWMpIHtcclxuICAgIGlmICghYWMpIHtcclxuICAgICAgICByZXR1cm4geyBoZWFsdGg6IDAsIHN0YW1pbmE6IDAsIG1hZ2lja2E6IDAgfTtcclxuICAgIH1cclxuICAgIHZhciBoZWFsdGhQZXJjZW50YWdlID0gKGFjLmlzRGVhZCgpKSA/IDAgOiBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZShcImhlYWx0aFwiKTtcclxuICAgIHZhciBzdGFtaW5hUGVyY2VudGFnZSA9IGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKFwic3RhbWluYVwiKTtcclxuICAgIHZhciBtYWdpY2thUGVyY2VudGFnZSA9IGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKFwibWFnaWNrYVwiKTtcclxuICAgIHZhciByZXN1bHRBY3RvclZhbHVlID0ge1xyXG4gICAgICAgIGhlYWx0aDogaGVhbHRoUGVyY2VudGFnZSxcclxuICAgICAgICBzdGFtaW5hOiBzdGFtaW5hUGVyY2VudGFnZSxcclxuICAgICAgICBtYWdpY2thOiBtYWdpY2thUGVyY2VudGFnZSxcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdWx0QWN0b3JWYWx1ZTtcclxufTtcclxuZXhwb3J0IHZhciBnZXRNYXhpbXVtQWN0b3JWYWx1ZSA9IGZ1bmN0aW9uIChhYywgYXZOYW1lKSB7XHJcbiAgICB2YXIgY3VycmVudFBlcmNlbnRhZ2UgPSBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZShhdk5hbWUpO1xyXG4gICAgcmV0dXJuIGN1cnJlbnRQZXJjZW50YWdlID09PSAwID9cclxuICAgICAgICBhYy5nZXRCYXNlQWN0b3JWYWx1ZShhdk5hbWUpIDpcclxuICAgICAgICBNYXRoLmNlaWwoYWMuZ2V0QWN0b3JWYWx1ZShhdk5hbWUpIC8gY3VycmVudFBlcmNlbnRhZ2UpO1xyXG59O1xyXG5leHBvcnQgdmFyIHNldEFjdG9yVmFsdWVQZXJjZW50YWdlID0gZnVuY3Rpb24gKGFjLCBhdk5hbWUsIHBlcmNlbnRhZ2UpIHtcclxuICAgIC8vIEFjdG9yIHZhbHVlIHBlcmNlbnRhZ2UgZm9yIGhlYWx0aCBtYXkgYmUgYmVsb3cgemVybyAoLTEuOCBmb3IgZXhhbXBsZSwgaXQgbWVhbnMgdSBoYXZlIC0xODAlIGhlYWx0aClcclxuICAgIHZhciBjdXJyZW50UGVyY2VudGFnZSA9IGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKGF2TmFtZSk7XHJcbiAgICBpZiAoY3VycmVudFBlcmNlbnRhZ2UgPT09IHBlcmNlbnRhZ2UpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB2YXIgY3VycmVudE1heFZhbHVlID0gZ2V0TWF4aW11bUFjdG9yVmFsdWUoYWMsIGF2TmFtZSk7XHJcbiAgICB2YXIgZGVsdGFQZXJjZW50YWdlID0gcGVyY2VudGFnZSAtIGN1cnJlbnRQZXJjZW50YWdlO1xyXG4gICAgaWYgKGRlbHRhUGVyY2VudGFnZSA+IDApIHtcclxuICAgICAgICBhYy5yZXN0b3JlQWN0b3JWYWx1ZShhdk5hbWUsIGRlbHRhUGVyY2VudGFnZSAqIGN1cnJlbnRNYXhWYWx1ZSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmIChkZWx0YVBlcmNlbnRhZ2UgPCAwKSB7XHJcbiAgICAgICAgYWMuZGFtYWdlQWN0b3JWYWx1ZShhdk5hbWUsIGRlbHRhUGVyY2VudGFnZSAqIGN1cnJlbnRNYXhWYWx1ZSk7XHJcbiAgICB9XHJcbn07XHJcbiIsIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvbiAqL1xyXG5pbXBvcnQgeyBEZWJ1ZywgaG9va3MsIEFjdG9yLCBwcmludENvbnNvbGUsIFV0aWxpdHksIEdhbWUsIHN0b3JhZ2UsIFxyXG4vLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG5zZXRDb2xsaXNpb24gfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgYXBwbHlXZWFwRHJhd24gfSBmcm9tIFwiLi9tb3ZlbWVudEFwcGx5XCI7XHJcbmV4cG9ydCB2YXIgQW5pbWF0aW9uRXZlbnROYW1lO1xyXG4oZnVuY3Rpb24gKEFuaW1hdGlvbkV2ZW50TmFtZSkge1xyXG4gICAgQW5pbWF0aW9uRXZlbnROYW1lW1wiUmFnZG9sbFwiXSA9IFwiUmFnZG9sbFwiO1xyXG4gICAgQW5pbWF0aW9uRXZlbnROYW1lW1wiR2V0VXBCZWdpblwiXSA9IFwiR2V0VXBCZWdpblwiO1xyXG59KShBbmltYXRpb25FdmVudE5hbWUgfHwgKEFuaW1hdGlvbkV2ZW50TmFtZSA9IHt9KSk7XHJcbjtcclxudmFyIGFsbG93ZWRJZGxlcyA9IG5ldyBBcnJheSgpO1xyXG52YXIgcmVmc1dpdGhEZWZhdWx0QW5pbXNEaXNhYmxlZCA9IG5ldyBTZXQoKTtcclxudmFyIGFsbG93ZWRBbmltcyA9IG5ldyBTZXQoKTtcclxudmFyIGFjdG9yU2l0QW5pbXNMb3dlckNhc2UgPSBbXHJcbiAgICAnaWRsZXN0b29sZW50ZXJwbGF5ZXInLFxyXG4gICAgJ2lkbGVzdG9vbGVudGVyJyxcclxuICAgICdpZGxlc3Rvb2xlbnRlcmluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcnJpZ2h0ZW50ZXInLFxyXG4gICAgJ2lkbGVjaGFpcmxlZnRlbnRlcicsXHJcbiAgICAnaWRsZWNoYWlyZnJvbnRlbnRlcicsXHJcbiAgICAnaWRsZWNoYWlyZW50ZXJpbnN0YW50JyxcclxuICAgICdpZGxlamFybGNoYWlyZW50ZXInLFxyXG4gICAgJ2lkbGVqYXJsY2hhaXJlbnRlcmluc3RhbnQnLFxyXG4gICAgJ2lkbGVzbm93ZWxmcHJpbmNlY2hhaXJkaWFsb2d1ZScsXHJcbiAgICAnaWRsZXNub3dlbGZwcmluY2VjaGFpcmVudGVyJyxcclxuICAgICdpZGxlc25vd2VsZnByaW5jZWNoYWlyZW50ZXJpbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJjaGlsZGVudGVyaW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRmcm9udGVudGVyJyxcclxuICAgICdpZGxlY2hhaXJjaGlsZGxlZnRlbnRlcicsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRyaWdodGVudGVyJyxcclxuXTtcclxudmFyIGFjdG9yR2V0VXBBbmltc0xvd2VyQ2FzZSA9IFtcclxuICAgICdpZGxlc3Rvb2xiYWNrZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlycmlnaHRleGl0JyxcclxuICAgICdpZGxlY2hhaXJyaWdodHF1aWNrZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlybGVmdGV4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmxlZnRxdWlja2V4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmZyb250ZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlyZnJvbnRxdWlja2V4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkZnJvbnRleGl0JyxcclxuICAgICdpZGxlY2hhaXJjaGlsZGxlZnRleGl0JyxcclxuICAgICdpZGxlY2hhaXJjaGlsZHJpZ2h0ZXhpdCdcclxuXTtcclxuLy8gSXQncyBjcml0aWNhbCBmb3IgdmFsdWVzIHRvIGJlIHRoZSBjb3JyZWN0IGNhc2UsIG5vdCBqdXN0IGxvd2VyY2FzZSwgb3RoZXJ3aXNlICdhbGxvd2VkSWRsZXMnIGNoZWNrIHdpbGwgYnJlYWtcclxuLy8gV2UgZG9uJ3Qgd2FudCB0byBtb2RpZnkgdGhlIGNoZWNrIGl0c2VsZiwgYmVjYXVzZSBpdCdsbCBiZSBzbG93ZXJcclxudmFyIGFuaW1PdmVycmlkZXNMb3dlckNhc2UgPSB7XHJcbiAgICAnaWRsZWNoYWlyYm9va19vbmVwYWdlJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlyc2hvdWxkZXJmbGV4JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlyd3JpdGUnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJhcm1zY3Jvc3NlZHZhcjEnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdjaGFpcmVhdGluZ3N0YXJ0X3ZhbXBpcmVtZWF0JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnY2hhaXJyZWFkaW5nc3RhcnQnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdjaGFpcnZhbXBpcmVlYXRpbmdzdGFydCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2NoYWlyZHJpbmtpbmdzdGFydCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2NoYWlyZWF0aW5nc3RhcnQnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgIC8vIFRoZSBvbmx5IHRyaXBsZSBhbmltYXRpb24gd2Uga25vdyBmb3Igbm93LiBPbmUgYmFzZSBhbmltIHRvIHNpdCwgdGhlbiB0d28gdG8gZWF0XHJcbiAgICAnY2hhaXJlYXRpbmdzb3Vwc3RhcnQnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxlZWF0c291cCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgLy8gTm8gbmVlZCB0byByZS1wbGF5IHRoZSBhbmltYXRpb24sIHVzZSBpbnN0YW50IHZhcmlhbnQgZm9yIHNwYXduaW5nIGFjdG9yc1xyXG4gICAgLy8gVGhpcyBpcyBub3QgZXNzZW50aWFsLCBidXQgbWFrZXMgdGhlIHN5bmMgZmVlbCBtb3JlIHNtb290aC4gVGhlIGxpc3QgaXMgbm90IGNvbXBsZXRlLlxyXG4gICAgJ2lkbGVjaGFpcnJpZ2h0ZW50ZXInOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJsZWZ0ZW50ZXInOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJmcm9udGVudGVyJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAvLyBVbnRlc3RlZCB5ZXQgbG9va3MgY29ycmVjdFxyXG4gICAgJ2lkbGVzbm93ZWxmcHJpbmNlZmlyZWFuZGZvcmdldCc6ICdJZGxlU25vd0VsZlByaW5jZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxldGFibGVtdWdlbnRlcic6ICdJZGxlVGFibGVFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGV0YWJsZWRyaW5rZW50ZXInOiAnSWRsZVRhYmxlRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxldGFibGVkcmlua2FuZG11Z2VudGVyJzogJ0lkbGVUYWJsZUVudGVySW5zdGFudCdcclxufTtcclxuLy8gdW5jbGFzc2lmaWVkOlxyXG4vLyBJZGxlQ2hhaXJFbnRlckluc3RhbnRcclxuLy8gSWRsZUNoYWlyRW50ZXJTdGFydFxyXG4vLyBJZGxlQ2hhaXJFbnRlclN0b3BcclxuLy8gSWRsZUNoYWlyRW50ZXJUb1NpdFxyXG4vLyBJZGxlQ2hhaXJFeGl0U3RhcnRcclxuLy8gSWRsZUNoYWlyRXhpdFRvU3RhbmRcclxuLy8gSWRsZUNoYWlyU2l0dGluZ1xyXG4vLyBJZGxlTGVmdENoYWlyRW50ZXJTdGFydFxyXG4vLyBDaGFpcklkbGVcclxuLy8gSWRsZVJpZ2h0Q2hhaXJFbnRlclN0YXJ0XHJcbi8vIElkbGVMZWZ0Q2hhaXJFbnRlclN0YXJ0XHJcbnZhciBpc0lkbGUgPSBmdW5jdGlvbiAoYW5pbUV2ZW50TmFtZSkge1xyXG4gICAgdmFyIGFuaW1FdmVudE5hbWVMb3dlckNhc2UgPSBhbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICByZXR1cm4gKGFuaW1FdmVudE5hbWVMb3dlckNhc2UgPT09IFwibW90aW9uZHJpdmVuaWRsZVwiIHx8XHJcbiAgICAgICAgKGFuaW1FdmVudE5hbWVMb3dlckNhc2Uuc3RhcnRzV2l0aChcImlkbGVcIikgJiZcclxuICAgICAgICAgICAgYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZSAhPT0gXCJpZGxlc3RvcFwiICYmXHJcbiAgICAgICAgICAgIGFuaW1FdmVudE5hbWVMb3dlckNhc2UgIT09IFwiaWRsZWZvcmNlZGVmYXVsdHN0YXRlXCIpKTtcclxufTtcclxuZXhwb3J0IHZhciBhcHBseUFuaW1hdGlvbiA9IGZ1bmN0aW9uIChyZWZyLCBhbmltLCBzdGF0ZSkge1xyXG4gICAgaWYgKHN0YXRlLmxhc3ROdW1DaGFuZ2VzID09PSBhbmltLm51bUNoYW5nZXMpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBzdGF0ZS5sYXN0TnVtQ2hhbmdlcyA9IGFuaW0ubnVtQ2hhbmdlcztcclxuICAgIGlmIChzdGF0ZS51c2VBbmltT3ZlcnJpZGVzKSB7XHJcbiAgICAgICAgdmFyIGFuaW1PdmVycmlkZSA9IGFuaW1PdmVycmlkZXNMb3dlckNhc2VbYW5pbS5hbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCldO1xyXG4gICAgICAgIGlmIChhbmltT3ZlcnJpZGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBhbmltLmFuaW1FdmVudE5hbWUgPSBhbmltT3ZlcnJpZGU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdmFyIGFuaW1FdmVudE5hbWVMb3dlckNhc2UgPSBhbmltLmFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChpc0lkbGUoYW5pbS5hbmltRXZlbnROYW1lKSkge1xyXG4gICAgICAgIGFsbG93ZWRJZGxlcy5wdXNoKFtyZWZyLmdldEZvcm1JRCgpLCBhbmltLmFuaW1FdmVudE5hbWVdKTtcclxuICAgIH1cclxuICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICBpZiAoYW5pbS5hbmltRXZlbnROYW1lID09PSBcIlNreW1wRmFrZUVxdWlwXCIpIHtcclxuICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgYXBwbHlXZWFwRHJhd24oYWMsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoYW5pbS5hbmltRXZlbnROYW1lID09PSBcIlNreW1wRmFrZVVuZXF1aXBcIikge1xyXG4gICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICBhcHBseVdlYXBEcmF3bihhYywgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoYW5pbS5hbmltRXZlbnROYW1lID09PSBcIlJhZ2RvbGxcIikge1xyXG4gICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICBpZiAoc3RvcmFnZVtcImFuaW1hdGlvbkZ1bmMxU2V0XCJdID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBzdG9yYWdlW1wiYW5pbWF0aW9uRnVuYzFcIl0oYWMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWMucHVzaEFjdG9yQXdheShhYywgMCk7XHJcbiAgICAgICAgICAgICAgICBhYy5zZXRBY3RvclZhbHVlKFwiVmFyaWFibGUxMFwiLCAtMTAwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHJlZnNXaXRoRGVmYXVsdEFuaW1zRGlzYWJsZWQuaGFzKHJlZnIuZ2V0Rm9ybUlEKCkpKSB7XHJcbiAgICAgICAgaWYgKGFuaW1FdmVudE5hbWVMb3dlckNhc2UuaW5jbHVkZXMoXCJhdHRhY2tcIikpIHtcclxuICAgICAgICAgICAgYWxsb3dlZEFuaW1zLmFkZChyZWZyLmdldEZvcm1JRCgpICsgXCI6XCIgKyBhbmltLmFuaW1FdmVudE5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIERlYnVnLnNlbmRBbmltYXRpb25FdmVudChyZWZyLCBhbmltLmFuaW1FdmVudE5hbWUpO1xyXG4gICAgaWYgKGFuaW0uYW5pbUV2ZW50TmFtZSA9PT0gXCJHZXRVcEJlZ2luXCIpIHtcclxuICAgICAgICB2YXIgcmVmcklkXzEgPSByZWZyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIFV0aWxpdHkud2FpdCgxKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWRfMSkpO1xyXG4gICAgICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgICAgIGFjLnNldEFjdG9yVmFsdWUoXCJWYXJpYWJsZTEwXCIsIDEwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoYWN0b3JTaXRBbmltc0xvd2VyQ2FzZS5maW5kKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4ID09PSBhbmltRXZlbnROYW1lTG93ZXJDYXNlOyB9KSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgc2V0Q29sbGlzaW9uKHJlZnIuZ2V0Rm9ybUlEKCksIGZhbHNlKTtcclxuICAgIH1cclxuICAgIGlmIChhY3RvckdldFVwQW5pbXNMb3dlckNhc2UuZmluZChmdW5jdGlvbiAoeCkgeyByZXR1cm4geCA9PT0gYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZTsgfSkgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHNldENvbGxpc2lvbihyZWZyLmdldEZvcm1JRCgpLCB0cnVlKTtcclxuICAgIH1cclxufTtcclxuZXhwb3J0IHZhciBzZXREZWZhdWx0QW5pbXNEaXNhYmxlZCA9IGZ1bmN0aW9uIChyZWZySWQsIGRpc2FibGVkKSB7XHJcbiAgICBpZiAoZGlzYWJsZWQpIHtcclxuICAgICAgICByZWZzV2l0aERlZmF1bHRBbmltc0Rpc2FibGVkLmFkZChyZWZySWQpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgcmVmc1dpdGhEZWZhdWx0QW5pbXNEaXNhYmxlZC5kZWxldGUocmVmcklkKTtcclxuICAgIH1cclxufTtcclxudmFyIEFuaW1hdGlvblNvdXJjZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIEFuaW1hdGlvblNvdXJjZShyZWZyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLnJlZnJJZCA9IDA7XHJcbiAgICAgICAgdGhpcy5udW1DaGFuZ2VzID0gMDtcclxuICAgICAgICB0aGlzLmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgIHRoaXMud2VhcE5vbkRyYXduQmxvY2tlciA9IDA7XHJcbiAgICAgICAgdGhpcy53ZWFwRHJhd25CbG9ja2VyID0gMDtcclxuICAgICAgICB0aGlzLnNuZWFrQmxvY2tlciA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5yZWZySWQgPSByZWZyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIGhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKCkgeyB9LFxyXG4gICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGN0eC5zZWxmSWQgIT09IF90aGlzLnJlZnJJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghY3R4LmFuaW1hdGlvblN1Y2NlZWRlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFdvcmthcm91bmQsIHNlZSBjYXJyeUFuaW1TeXN0ZW0udHMgaW4gZ2FtZW1vZGVcclxuICAgICAgICAgICAgICAgICAgICAvLyBDYXNlLXNlbnNldGl2ZSBjaGVjayBoZXJlIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2VcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3R4LmFuaW1FdmVudE5hbWUgIT09IFwiT2Zmc2V0Q2FycnlCYXNrZXRTdGFydFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5vblNlbmRBbmltYXRpb25FdmVudChjdHguYW5pbUV2ZW50TmFtZSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBBbmltYXRpb25Tb3VyY2UucHJvdG90eXBlLmZpbHRlck1vdmVtZW50ID0gZnVuY3Rpb24gKG1vdikge1xyXG4gICAgICAgIGlmICh0aGlzLndlYXBEcmF3bkJsb2NrZXIgPj0gRGF0ZS5ub3coKSkge1xyXG4gICAgICAgICAgICBtb3YuaXNXZWFwRHJhd24gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy53ZWFwTm9uRHJhd25CbG9ja2VyID49IERhdGUubm93KCkpIHtcclxuICAgICAgICAgICAgbW92LmlzV2VhcERyYXduID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnNuZWFrQmxvY2tlciA9PT0gbW92LmlzU25lYWtpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5zbmVha0Jsb2NrZXIgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICh0aGlzLnNuZWFrQmxvY2tlciA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBtb3YuaXNTbmVha2luZyA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKHRoaXMuc25lYWtCbG9ja2VyID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICBtb3YuaXNTbmVha2luZyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbW92O1xyXG4gICAgfTtcclxuICAgIEFuaW1hdGlvblNvdXJjZS5wcm90b3R5cGUuZ2V0QW5pbWF0aW9uID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfYSA9IHRoaXMsIG51bUNoYW5nZXMgPSBfYS5udW1DaGFuZ2VzLCBhbmltRXZlbnROYW1lID0gX2EuYW5pbUV2ZW50TmFtZTtcclxuICAgICAgICByZXR1cm4geyBudW1DaGFuZ2VzOiBudW1DaGFuZ2VzLCBhbmltRXZlbnROYW1lOiBhbmltRXZlbnROYW1lIH07XHJcbiAgICB9O1xyXG4gICAgQW5pbWF0aW9uU291cmNlLnByb3RvdHlwZS5vblNlbmRBbmltYXRpb25FdmVudCA9IGZ1bmN0aW9uIChhbmltRXZlbnROYW1lKSB7XHJcbiAgICAgICAgaWYgKGlnbm9yZWRBbmltcy5oYXMoYW5pbUV2ZW50TmFtZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbG93ZXIgPSBhbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgdmFyIGlzVG9yY2hFdmVudCA9IGxvd2VyLmluY2x1ZGVzKFwidG9yY2hcIik7XHJcbiAgICAgICAgaWYgKGFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhcInVuZXF1aXBcIikgJiYgIWlzVG9yY2hFdmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLndlYXBOb25EcmF3bkJsb2NrZXIgPSBEYXRlLm5vdygpICsgMzAwO1xyXG4gICAgICAgICAgICBhbmltRXZlbnROYW1lID0gXCJTa3ltcEZha2VVbmVxdWlwXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKGFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhcImVxdWlwXCIpICYmICFpc1RvcmNoRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy53ZWFwRHJhd25CbG9ja2VyID0gRGF0ZS5ub3coKSArIDMwMDtcclxuICAgICAgICAgICAgYW5pbUV2ZW50TmFtZSA9IFwiU2t5bXBGYWtlRXF1aXBcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFuaW1FdmVudE5hbWUgPT09IFwiU25lYWtTdGFydFwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc25lYWtCbG9ja2VyID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYW5pbUV2ZW50TmFtZSA9PT0gXCJTbmVha1N0b3BcIikge1xyXG4gICAgICAgICAgICB0aGlzLnNuZWFrQmxvY2tlciA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubnVtQ2hhbmdlcysrO1xyXG4gICAgICAgIHRoaXMuYW5pbUV2ZW50TmFtZSA9IGFuaW1FdmVudE5hbWU7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEFuaW1hdGlvblNvdXJjZTtcclxufSgpKTtcclxuZXhwb3J0IHsgQW5pbWF0aW9uU291cmNlIH07XHJcbnZhciBpZ25vcmVkQW5pbXMgPSBuZXcgU2V0KFtcclxuICAgIFwibW92ZVN0YXJ0XCIsXHJcbiAgICBcIm1vdmVTdG9wXCIsXHJcbiAgICBcInR1cm5TdG9wXCIsXHJcbiAgICBcIkN5Y2xpY0Nyb3NzQmxlbmRcIixcclxuICAgIFwiQ3ljbGljRnJlZXplXCIsXHJcbiAgICBcIlR1cm5MZWZ0XCIsXHJcbiAgICBcIlR1cm5SaWdodFwiLFxyXG5dKTtcclxuZXhwb3J0IHZhciBzZXR1cEhvb2tzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgaWYgKHJlZnNXaXRoRGVmYXVsdEFuaW1zRGlzYWJsZWQuaGFzKGN0eC5zZWxmSWQpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY3R4LmFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhcImF0dGFja1wiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhbmltS2V5ID0gY3R4LnNlbGZJZCArIFwiOlwiICsgY3R4LmFuaW1FdmVudE5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFsbG93ZWRBbmltcy5oYXMoYW5pbUtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dlZEFuaW1zLmRlbGV0ZShhbmltS2V5KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcImJsb2NrIGFuaW0gXCIgKyBjdHguYW5pbUV2ZW50TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gU2hvd1JhY2VNZW51IGZvcmNlcyB0aGlzIGFuaW1cclxuICAgICAgICAgICAgaWYgKGN0eC5hbmltRXZlbnROYW1lID09PSBcIk9mZnNldEJvdW5kU3RhbmRpbmdQbGF5ZXJJbnN0YW50XCIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAoY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBEaXNhYmxlIGlkbGUgYW5pbWF0aW9ucyBmb3IgMHhmZiBhY3RvcnNcclxuICAgICAgICAgICAgaWYgKGN0eC5zZWxmSWQgPCAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGlzSWRsZShjdHguYW5pbUV2ZW50TmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIHZhciBpID0gYWxsb3dlZElkbGVzLmZpbmRJbmRleChmdW5jdGlvbiAocGFpcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYWlyWzBdID09PSBjdHguc2VsZklkICYmIHBhaXJbMV0gPT09IGN0eC5hbmltRXZlbnROYW1lO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpID09PSAtMSA/IChjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCIpIDogYWxsb3dlZElkbGVzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGVhdmU6IGZ1bmN0aW9uICgpIHsgfSxcclxuICAgIH0pO1xyXG59O1xyXG4iLCJpbXBvcnQgeyBBY3RvckJhc2UsIEdhbWUsIFRFU01vZFBsYXRmb3JtLCBSYWNlLCBIZWFkUGFydCwgVGV4dHVyZVNldCwgcHJpbnRDb25zb2xlLCBWb2ljZVR5cGUsIG9uY2UsIFV0aWxpdHksIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmV4cG9ydCB2YXIgZ2V0QXBwZWFyYW5jZSA9IGZ1bmN0aW9uIChhY3Rvcikge1xyXG4gICAgdmFyIGJhc2UgPSBBY3RvckJhc2UuZnJvbShhY3Rvci5nZXRCYXNlT2JqZWN0KCkpO1xyXG4gICAgdmFyIGhhaXJDb2xvciA9IGJhc2UuZ2V0SGFpckNvbG9yKCk7XHJcbiAgICB2YXIgc2tpbkNvbG9yID0gVEVTTW9kUGxhdGZvcm0uZ2V0U2tpbkNvbG9yKGJhc2UpO1xyXG4gICAgdmFyIG5ld0FwcGVhcmFuY2UgPSB7XHJcbiAgICAgICAgaXNGZW1hbGU6IGJhc2UuZ2V0U2V4KCkgPT09IDEsXHJcbiAgICAgICAgcmFjZUlkOiBiYXNlLmdldFJhY2UoKSA/IGJhc2UuZ2V0UmFjZSgpLmdldEZvcm1JRCgpIDogMCxcclxuICAgICAgICB3ZWlnaHQ6IGJhc2UuZ2V0V2VpZ2h0KCksXHJcbiAgICAgICAgaGFpckNvbG9yOiBoYWlyQ29sb3IgPyBoYWlyQ29sb3IuZ2V0Q29sb3IoKSA6IDAsXHJcbiAgICAgICAgaGVhZHBhcnRJZHM6IFtdLFxyXG4gICAgICAgIGhlYWRUZXh0dXJlU2V0SWQ6IGJhc2UuZ2V0RmFjZVRleHR1cmVTZXQoKVxyXG4gICAgICAgICAgICA/IGJhc2UuZ2V0RmFjZVRleHR1cmVTZXQoKS5nZXRGb3JtSUQoKVxyXG4gICAgICAgICAgICA6IDAsXHJcbiAgICAgICAgb3B0aW9uczogbmV3IEFycmF5KDE5KSxcclxuICAgICAgICBwcmVzZXRzOiBuZXcgQXJyYXkoNCksXHJcbiAgICAgICAgdGludHM6IFtdLFxyXG4gICAgICAgIHNraW5Db2xvcjogc2tpbkNvbG9yID8gc2tpbkNvbG9yLmdldENvbG9yKCkgOiAwLFxyXG4gICAgICAgIG5hbWU6IGFjdG9yLmdldEJhc2VPYmplY3QoKS5nZXROYW1lKCksXHJcbiAgICB9O1xyXG4gICAgdmFyIG51bUhlYWRwYXJ0cyA9IGJhc2UuZ2V0TnVtSGVhZFBhcnRzKCk7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bUhlYWRwYXJ0czsgKytpKSB7XHJcbiAgICAgICAgdmFyIHBhcnQgPSBiYXNlLmdldE50aEhlYWRQYXJ0KGkpO1xyXG4gICAgICAgIGlmIChwYXJ0KSB7XHJcbiAgICAgICAgICAgIG5ld0FwcGVhcmFuY2UuaGVhZHBhcnRJZHMucHVzaChwYXJ0LmdldEZvcm1JRCgpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0FwcGVhcmFuY2Uub3B0aW9ucy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIG5ld0FwcGVhcmFuY2Uub3B0aW9uc1tpXSA9IGJhc2UuZ2V0RmFjZU1vcnBoKGkpO1xyXG4gICAgfVxyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdBcHBlYXJhbmNlLnByZXNldHMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICBuZXdBcHBlYXJhbmNlLnByZXNldHNbaV0gPSBiYXNlLmdldEZhY2VQcmVzZXQoaSk7XHJcbiAgICB9XHJcbiAgICB2YXIgbnVtVGludHMgPSBHYW1lLmdldFBsYXllcigpLmdldEZvcm1JRCgpID09PSBhY3Rvci5nZXRGb3JtSUQoKVxyXG4gICAgICAgID8gR2FtZS5nZXROdW1UaW50TWFza3MoKVxyXG4gICAgICAgIDogMDtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtVGludHM7ICsraSkge1xyXG4gICAgICAgIHZhciB0aW50ID0ge1xyXG4gICAgICAgICAgICB0ZXh0dXJlUGF0aDogR2FtZS5nZXROdGhUaW50TWFza1RleHR1cmVQYXRoKGkpLFxyXG4gICAgICAgICAgICB0eXBlOiBHYW1lLmdldE50aFRpbnRNYXNrVHlwZShpKSxcclxuICAgICAgICAgICAgYXJnYjogR2FtZS5nZXROdGhUaW50TWFza0NvbG9yKGkpLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbmV3QXBwZWFyYW5jZS50aW50cy5wdXNoKHRpbnQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ld0FwcGVhcmFuY2U7XHJcbn07XHJcbnZhciBpc1Zpc2libGUgPSBmdW5jdGlvbiAoYXJnYikgeyByZXR1cm4gYXJnYiA+IDB4MDBmZmZmZmYgfHwgYXJnYiA8IDA7IH07XHJcbmV4cG9ydCB2YXIgYXBwbHlUaW50cyA9IGZ1bmN0aW9uIChhY3RvciwgYXBwZWFyYW5jZSkge1xyXG4gICAgaWYgKCFhcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwibnVsbCBhcHBlYXJhbmNlIGhhcyBiZWVuIHBhc3NlZCB0byBhcHBseVRpbnRzXCIpO1xyXG4gICAgfVxyXG4gICAgdmFyIHRpbnRzID0gYXBwZWFyYW5jZS50aW50cy5maWx0ZXIoZnVuY3Rpb24gKHQpIHsgcmV0dXJuIGlzVmlzaWJsZSh0LmFyZ2IpOyB9KTtcclxuICAgIHZhciByYWNlV2FyUGFpbnRSZWdleCA9IC8uKkhlYWQuK1dhclBhaW50LiovO1xyXG4gICAgdmFyIHVuaVdhclBhaW50UmVnZXggPSAvLipIZWFkV2FyUGFpbnQuKi87XHJcbiAgICB2YXIgcmFjZVNwZWNpZmljV2FyUGFpbnQgPSB0aW50cy5maWx0ZXIoZnVuY3Rpb24gKHQpIHsgcmV0dXJuIGlzVmlzaWJsZSh0LmFyZ2IpICYmIHQudGV4dHVyZVBhdGgubWF0Y2gocmFjZVdhclBhaW50UmVnZXgpOyB9KS5sZW5ndGg7IC8vIE1hbGVIZWFkTm9yZFdhclBhaW50XHJcbiAgICB2YXIgdW5pV2FyUGFpbnQgPSB0aW50cy5maWx0ZXIoZnVuY3Rpb24gKHQpIHsgcmV0dXJuIGlzVmlzaWJsZSh0LmFyZ2IpICYmIHQudGV4dHVyZVBhdGgubWF0Y2godW5pV2FyUGFpbnRSZWdleCk7IH0pLmxlbmd0aDsgLy8gTWFsZUhlYWRXYXJQYWludFxyXG4gICAgaWYgKHJhY2VTcGVjaWZpY1dhclBhaW50ICsgdW5pV2FyUGFpbnQgPiAxKSB7XHJcbiAgICAgICAgLy8gSWYgdmlzaWJsZSB3YXIgcGFpbnRzIG9mIHRoZXNlIHR3byB0eXBlcyBwcmVzZW50LCB0aGVuIFNreXJpbSBjcmFzaGVzXHJcbiAgICAgICAgcHJpbnRDb25zb2xlKFwiYmFkIHdhcnBhaW50IVwiLCByYWNlU3BlY2lmaWNXYXJQYWludCwgdW5pV2FyUGFpbnQpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIFRFU01vZFBsYXRmb3JtLmNsZWFyVGludE1hc2tzKGFjdG9yKTtcclxuICAgIHRpbnRzLmZvckVhY2goZnVuY3Rpb24gKHRpbnQpIHtcclxuICAgICAgICBURVNNb2RQbGF0Zm9ybS5wdXNoVGludE1hc2soYWN0b3IsIHRpbnQudHlwZSwgdGludC5hcmdiLCB0aW50LnRleHR1cmVQYXRoKTtcclxuICAgIH0pO1xyXG4gICAgdmFyIHBsYXllckJhc2VJZCA9IEdhbWUuZ2V0UGxheWVyKCkuZ2V0QmFzZU9iamVjdCgpLmdldEZvcm1JRCgpO1xyXG4gICAgaWYgKGFjdG9yKVxyXG4gICAgICAgIFRFU01vZFBsYXRmb3JtLnNldEZvcm1JZFVuc2FmZShhY3Rvci5nZXRCYXNlT2JqZWN0KCksIHBsYXllckJhc2VJZCk7XHJcbn07XHJcbmV4cG9ydCB2YXIgc2lsZW50Vm9pY2VUeXBlSWQgPSAweDAwMDJmN2MzO1xyXG52YXIgYXBwbHlBcHBlYXJhbmNlQ29tbW9uID0gZnVuY3Rpb24gKGFwcGVhcmFuY2UsIG5wYykge1xyXG4gICAgdmFyIHJhY2UgPSBSYWNlLmZyb20oR2FtZS5nZXRGb3JtRXgoYXBwZWFyYW5jZS5yYWNlSWQpKTtcclxuICAgIHZhciBoZWFkcGFydHMgPSBhcHBlYXJhbmNlLmhlYWRwYXJ0SWRzXHJcbiAgICAgICAgLm1hcChmdW5jdGlvbiAoaWQpIHsgcmV0dXJuIEhlYWRQYXJ0LmZyb20oR2FtZS5nZXRGb3JtRXgoaWQpKTsgfSlcclxuICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChoZWFkcGFydCkgeyByZXR1cm4gISFoZWFkcGFydDsgfSk7XHJcbiAgICBURVNNb2RQbGF0Zm9ybS5zZXROcGNTZXgobnBjLCBhcHBlYXJhbmNlLmlzRmVtYWxlID8gMSA6IDApO1xyXG4gICAgaWYgKHJhY2UpIHtcclxuICAgICAgICBURVNNb2RQbGF0Zm9ybS5zZXROcGNSYWNlKG5wYywgcmFjZSk7XHJcbiAgICB9XHJcbiAgICBucGMuc2V0V2VpZ2h0KGFwcGVhcmFuY2Uud2VpZ2h0KTtcclxuICAgIFRFU01vZFBsYXRmb3JtLnNldE5wY1NraW5Db2xvcihucGMsIGFwcGVhcmFuY2Uuc2tpbkNvbG9yKTtcclxuICAgIFRFU01vZFBsYXRmb3JtLnNldE5wY0hhaXJDb2xvcihucGMsIGFwcGVhcmFuY2UuaGFpckNvbG9yKTtcclxuICAgIFRFU01vZFBsYXRmb3JtLnJlc2l6ZUhlYWRwYXJ0c0FycmF5KG5wYywgaGVhZHBhcnRzLmxlbmd0aCk7XHJcbiAgICBoZWFkcGFydHMuZm9yRWFjaChmdW5jdGlvbiAodiwgaSkgeyByZXR1cm4gbnBjLnNldE50aEhlYWRQYXJ0KHYsIGkpOyB9KTtcclxuICAgIG5wYy5zZXRGYWNlVGV4dHVyZVNldChUZXh0dXJlU2V0LmZyb20oR2FtZS5nZXRGb3JtRXgoYXBwZWFyYW5jZS5oZWFkVGV4dHVyZVNldElkKSkpOyAvLyBzZXRGYWNlVGV4dHVyZVNldCBzdXBwb3J0cyBudWxsIGFyZ3VtZW50XHJcbiAgICBucGMuc2V0Vm9pY2VUeXBlKFZvaWNlVHlwZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHNpbGVudFZvaWNlVHlwZUlkKSkpO1xyXG4gICAgYXBwZWFyYW5jZS5vcHRpb25zLmZvckVhY2goZnVuY3Rpb24gKHYsIGkpIHsgcmV0dXJuIG5wYy5zZXRGYWNlTW9ycGgodiwgaSk7IH0pO1xyXG4gICAgYXBwZWFyYW5jZS5wcmVzZXRzLmZvckVhY2goZnVuY3Rpb24gKHYsIGkpIHsgcmV0dXJuIG5wYy5zZXRGYWNlUHJlc2V0KHYsIGkpOyB9KTtcclxuICAgIGlmIChhcHBlYXJhbmNlLm5hbWUpIHtcclxuICAgICAgICBucGMuc2V0TmFtZShhcHBlYXJhbmNlLm5hbWUpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgLy8gZm9yIHVuZGVmaW5lZCBvciBlbXB0eSBuYW1lXHJcbiAgICAgICAgbnBjLnNldE5hbWUoXCIgXCIpO1xyXG4gICAgfVxyXG59O1xyXG5leHBvcnQgdmFyIGFwcGx5QXBwZWFyYW5jZSA9IGZ1bmN0aW9uIChhcHBlYXJhbmNlKSB7XHJcbiAgICB2YXIgbnBjID0gVEVTTW9kUGxhdGZvcm0uY3JlYXRlTnBjKCk7XHJcbiAgICBpZiAoIW5wYykge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImNyZWF0ZU5wYyByZXR1cm5lZCBudWxsXCIpO1xyXG4gICAgfVxyXG4gICAgYXBwbHlBcHBlYXJhbmNlQ29tbW9uKGFwcGVhcmFuY2UsIG5wYyk7XHJcbiAgICByZXR1cm4gbnBjO1xyXG59O1xyXG5leHBvcnQgdmFyIGFwcGx5QXBwZWFyYW5jZVRvUGxheWVyID0gZnVuY3Rpb24gKGFwcGVhcmFuY2UpIHtcclxuICAgIGFwcGx5QXBwZWFyYW5jZUNvbW1vbihhcHBlYXJhbmNlLCBBY3RvckJhc2UuZnJvbShHYW1lLmdldFBsYXllcigpLmdldEJhc2VPYmplY3QoKSkpO1xyXG4gICAgYXBwbHlUaW50cyhudWxsLCBhcHBlYXJhbmNlKTtcclxuICAgIEdhbWUuZ2V0UGxheWVyKCkucXVldWVOaU5vZGVVcGRhdGUoKTtcclxuICAgIFV0aWxpdHkud2FpdCgwLjA2MjUpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIG9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgIChfYSA9IEdhbWUuZ2V0UGxheWVyKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zdGFydERlZmVycmVkS2lsbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn07XHJcbiIsImltcG9ydCB7IEFjdG9yLCBBbW1vLCBHYW1lLCBTcGVsbCwgVWksIHNldEludmVudG9yeSwgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmltcG9ydCB7IGdldEludmVudG9yeSB9IGZyb20gJy4vaW52ZW50b3J5JztcclxuZXhwb3J0IHZhciBnZXRFcXVpcGVkU3BlbGwgPSBmdW5jdGlvbiAocmVmciwgc3BlbGxUeXBlKSB7XHJcbiAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgaWYgKCFhY3Rvcikge1xyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG4gICAgc3dpdGNoIChzcGVsbFR5cGUpIHtcclxuICAgICAgICBjYXNlIDAgLyogU3BlbGxUeXBlLkxlZnQgKi86IHtcclxuICAgICAgICAgICAgdmFyIHNwZWxsID0gYWN0b3IuZ2V0RXF1aXBwZWRTcGVsbCgwIC8qIFNwZWxsVHlwZS5MZWZ0ICovKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwZWxsID8gc3BlbGwuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlIDEgLyogU3BlbGxUeXBlLlJpZ2h0ICovOiB7XHJcbiAgICAgICAgICAgIHZhciBzcGVsbCA9IGFjdG9yLmdldEVxdWlwcGVkU3BlbGwoMSAvKiBTcGVsbFR5cGUuUmlnaHQgKi8pO1xyXG4gICAgICAgICAgICByZXR1cm4gc3BlbGwgPyBzcGVsbC5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgMiAvKiBTcGVsbFR5cGUuVm9pY2UgKi86IHtcclxuICAgICAgICAgICAgdmFyIHNwZWxsID0gYWN0b3IuZ2V0RXF1aXBwZWRTcGVsbCgyIC8qIFNwZWxsVHlwZS5Wb2ljZSAqLyk7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGVsbCA/IHNwZWxsLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAzIC8qIFNwZWxsVHlwZS5JbnN0YW50ICovOiB7XHJcbiAgICAgICAgICAgIHZhciBzcGVsbCA9IGFjdG9yLmdldEVxdWlwcGVkU3BlbGwoMyAvKiBTcGVsbFR5cGUuSW5zdGFudCAqLyk7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGVsbCA/IHNwZWxsLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn07XHJcbnZhciBmaWx0ZXJXb3JuID0gZnVuY3Rpb24gKGludikge1xyXG4gICAgcmV0dXJuIHsgZW50cmllczogaW52LmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4Lndvcm4gfHwgeC53b3JuTGVmdDsgfSkgfTtcclxufTtcclxudmFyIHJlbW92ZVVubmVjZXNzYXJ5RXh0cmEgPSBmdW5jdGlvbiAoaW52LCBpZ25vcmVBbW1vKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGVudHJpZXM6IGludi5lbnRyaWVzLm1hcChmdW5jdGlvbiAoeCkge1xyXG4gICAgICAgICAgICB2YXIgciA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoeCkpO1xyXG4gICAgICAgICAgICByLmNoYXJnZVBlcmNlbnQgPSByLm1heENoYXJnZTtcclxuICAgICAgICAgICAgaWYgKGlnbm9yZUFtbW8pIHtcclxuICAgICAgICAgICAgICAgIHIuY291bnQgPSBBbW1vLmZyb20oR2FtZS5nZXRGb3JtRXgoeC5iYXNlSWQpKSA/IHIuY291bnQgOiAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgci5jb3VudCA9IEFtbW8uZnJvbShHYW1lLmdldEZvcm1FeCh4LmJhc2VJZCkpID8gMTAwMCA6IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVsZXRlIHIubmFtZTtcclxuICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgfSksXHJcbiAgICB9O1xyXG59O1xyXG5leHBvcnQgdmFyIGdldEVxdWlwbWVudCA9IGZ1bmN0aW9uIChhYywgbnVtQ2hhbmdlcykge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBpbnY6IGdldEludmVudG9yeShhYyksXHJcbiAgICAgICAgbGVmdFNwZWxsOiBnZXRFcXVpcGVkU3BlbGwoYWMsIDAgLyogU3BlbGxUeXBlLkxlZnQgKi8pLFxyXG4gICAgICAgIHJpZ2h0U3BlbGw6IGdldEVxdWlwZWRTcGVsbChhYywgMSAvKiBTcGVsbFR5cGUuUmlnaHQgKi8pLFxyXG4gICAgICAgIHZvaWNlU3BlbGw6IGdldEVxdWlwZWRTcGVsbChhYywgMiAvKiBTcGVsbFR5cGUuVm9pY2UgKi8pLFxyXG4gICAgICAgIGluc3RhbnRTcGVsbDogZ2V0RXF1aXBlZFNwZWxsKGFjLCAzIC8qIFNwZWxsVHlwZS5JbnN0YW50ICovKSxcclxuICAgICAgICBudW1DaGFuZ2VzOiBudW1DaGFuZ2VzLFxyXG4gICAgfTtcclxufTtcclxuZXhwb3J0IHZhciBzeW5jU3BlbGxFcXVpcG1lbnQgPSBmdW5jdGlvbiAoYWMsIHNwZWxsQmFzZUlkLCBzcGVsbFR5cGUpIHtcclxuICAgIGlmIChzcGVsbEJhc2VJZCAhPT0gdW5kZWZpbmVkICYmIHNwZWxsQmFzZUlkID4gMCkge1xyXG4gICAgICAgIGFjLmVxdWlwU3BlbGwoU3BlbGwuZnJvbShHYW1lLmdldEZvcm1FeChzcGVsbEJhc2VJZCkpLCBzcGVsbFR5cGUpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgdmFyIGVxdWlwZWRTcGVsbCA9IGFjLmdldEVxdWlwcGVkU3BlbGwoc3BlbGxUeXBlKTtcclxuICAgICAgICBpZiAoZXF1aXBlZFNwZWxsKSB7XHJcbiAgICAgICAgICAgIGFjLnVuZXF1aXBTcGVsbChlcXVpcGVkU3BlbGwsIHNwZWxsVHlwZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5leHBvcnQgdmFyIGFwcGx5RXF1aXBtZW50ID0gZnVuY3Rpb24gKGFjLCBlcSkge1xyXG4gICAgYWMucmVtb3ZlQWxsSXRlbXMobnVsbCwgZmFsc2UsIHRydWUpO1xyXG4gICAgYWMudW5lcXVpcEFsbCgpO1xyXG4gICAgYWMucmVtb3ZlQWxsSXRlbXMobnVsbCwgZmFsc2UsIHRydWUpO1xyXG4gICAgdmFyIG5ld0ludmVudG9yeSA9IHJlbW92ZVVubmVjZXNzYXJ5RXh0cmEoZmlsdGVyV29ybihlcS5pbnYpLCBhYy5nZXRGb3JtSUQoKSA9PT0gMHgxNCk7XHJcbiAgICBzZXRJbnZlbnRvcnkoYWMuZ2V0Rm9ybUlEKCksIG5ld0ludmVudG9yeSk7XHJcbiAgICBzeW5jU3BlbGxFcXVpcG1lbnQoYWMsIGVxLmxlZnRTcGVsbCwgMCAvKiBTcGVsbFR5cGUuTGVmdCAqLyk7XHJcbiAgICBzeW5jU3BlbGxFcXVpcG1lbnQoYWMsIGVxLnJpZ2h0U3BlbGwsIDEgLyogU3BlbGxUeXBlLlJpZ2h0ICovKTtcclxuICAgIHN5bmNTcGVsbEVxdWlwbWVudChhYywgZXEudm9pY2VTcGVsbCwgMiAvKiBTcGVsbFR5cGUuVm9pY2UgKi8pO1xyXG4gICAgc3luY1NwZWxsRXF1aXBtZW50KGFjLCBlcS5pbnN0YW50U3BlbGwsIDMgLyogU3BlbGxUeXBlLkluc3RhbnQgKi8pO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbn07XHJcbmV4cG9ydCB2YXIgaXNCYWRNZW51U2hvd24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gKFVpLmlzTWVudU9wZW4oJ0ludmVudG9yeU1lbnUnKSB8fFxyXG4gICAgICAgIFVpLmlzTWVudU9wZW4oJ0Zhdm9yaXRlc01lbnUnKSB8fFxyXG4gICAgICAgIFVpLmlzTWVudU9wZW4oJ01hZ2ljTWVudScpIHx8XHJcbiAgICAgICAgVWkuaXNNZW51T3BlbignQ29udGFpbmVyTWVudScpIHx8XHJcbiAgICAgICAgVWkuaXNNZW51T3BlbignQ3JhZnRpbmcgTWVudScpIC8vIEFjdHVhbGx5IEkgZG9uJ3QgdGhpbmsgaXQgY2F1c2VzIGNyYXNoZXNcclxuICAgICk7XHJcbn07XHJcbiIsImltcG9ydCB7IGdldEV4dHJhQ29udGFpbmVyQ2hhbmdlcywgZ2V0Q29udGFpbmVyLCBPYmplY3RSZWZlcmVuY2UsIFRFU01vZFBsYXRmb3JtLCBHYW1lLCBzdG9yYWdlLCBFbmNoYW50bWVudCwgUG90aW9uLCBBY3RvciwgQW1tbywgcHJpbnRDb25zb2xlLCBGb3JtLCB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG4vLyAnbG94c3dvcmQgKExlZ2VuZGFyeSknID0+ICdsb3hzd29yZCdcclxudmFyIGdldFJlYWxOYW1lID0gZnVuY3Rpb24gKHMpIHtcclxuICAgIGlmICghcykge1xyXG4gICAgICAgIHJldHVybiBzO1xyXG4gICAgfVxyXG4gICAgdmFyIGFyciA9IHMuc3BsaXQoXCIgXCIpO1xyXG4gICAgaWYgKGFyci5sZW5ndGggJiYgYXJyW2Fyci5sZW5ndGggLSAxXS5tYXRjaCgvXlxcKC4qXFwpJC8pKSB7XHJcbiAgICAgICAgYXJyLnBvcCgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFyci5qb2luKFwiIFwiKTtcclxufTtcclxuLy8gJ2FhYWFhYWFhYWFhYWFhYWEnID0+ICdhYWEuLi4nXHJcbnZhciBjcm9wTmFtZSA9IGZ1bmN0aW9uIChzKSB7XHJcbiAgICBpZiAoIXMpIHtcclxuICAgICAgICByZXR1cm4gcztcclxuICAgIH1cclxuICAgIHZhciBtYXggPSAxMjg7XHJcbiAgICByZXR1cm4gcy5sZW5ndGggPj0gbWF4XHJcbiAgICAgICAgPyBzXHJcbiAgICAgICAgICAgIC5zcGxpdChcIlwiKVxyXG4gICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uICh4LCBpKSB7IHJldHVybiBpIDwgbWF4OyB9KVxyXG4gICAgICAgICAgICAuam9pbihcIlwiKVxyXG4gICAgICAgICAgICAuY29uY2F0KFwiLi4uXCIpXHJcbiAgICAgICAgOiBzO1xyXG59O1xyXG52YXIgY2hlY2tJZk5hbWVJc0dlbmVyYXRlZEJ5R2FtZSA9IGZ1bmN0aW9uIChhU3RyLCBiU3RyLCBmb3JtTmFtZSkge1xyXG4gICAgaWYgKCFhU3RyLmxlbmd0aCAmJiBiU3RyLnN0YXJ0c1dpdGgoZm9ybU5hbWUpKSB7XHJcbiAgICAgICAgdmFyIGJFbmRpbmcgPSBiU3RyLnN1YnN0cihmb3JtTmFtZS5sZW5ndGgpO1xyXG4gICAgICAgIGlmIChiRW5kaW5nLm1hdGNoKC9eXFxzXFwoLipcXCkkLykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59O1xyXG52YXIgbmFtZXNFcXVhbCA9IGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICB2YXIgYVN0ciA9IGEubmFtZSB8fCBcIlwiO1xyXG4gICAgdmFyIGJTdHIgPSBiLm5hbWUgfHwgXCJcIjtcclxuICAgIGlmIChjcm9wTmFtZShnZXRSZWFsTmFtZShhU3RyKSkgPT09IGNyb3BOYW1lKGdldFJlYWxOYW1lKGJTdHIpKSkge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgaWYgKGEuYmFzZUlkID09PSBiLmJhc2VJZCkge1xyXG4gICAgICAgIHZhciBmb3JtID0gR2FtZS5nZXRGb3JtRXgoYS5iYXNlSWQpO1xyXG4gICAgICAgIGlmIChmb3JtKSB7XHJcbiAgICAgICAgICAgIHZhciBmb3JtTmFtZSA9IGZvcm0uZ2V0TmFtZSgpO1xyXG4gICAgICAgICAgICBpZiAoY2hlY2tJZk5hbWVJc0dlbmVyYXRlZEJ5R2FtZShhU3RyLCBiU3RyLCBmb3JtTmFtZSkgfHxcclxuICAgICAgICAgICAgICAgIGNoZWNrSWZOYW1lSXNHZW5lcmF0ZWRCeUdhbWUoYlN0ciwgYVN0ciwgZm9ybU5hbWUpKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59O1xyXG52YXIgZXh0cmFzRXF1YWwgPSBmdW5jdGlvbiAoYSwgYiwgaWdub3JlV29ybikge1xyXG4gICAgaWYgKGlnbm9yZVdvcm4gPT09IHZvaWQgMCkgeyBpZ25vcmVXb3JuID0gZmFsc2U7IH1cclxuICAgIHJldHVybiAoYS5oZWFsdGggPT09IGIuaGVhbHRoICYmXHJcbiAgICAgICAgYS5lbmNoYW50bWVudElkID09PSBiLmVuY2hhbnRtZW50SWQgJiZcclxuICAgICAgICBhLm1heENoYXJnZSA9PT0gYi5tYXhDaGFyZ2UgJiZcclxuICAgICAgICAhIWEucmVtb3ZlRW5jaGFudG1lbnRPblVuZXF1aXAgPT09ICEhYi5yZW1vdmVFbmNoYW50bWVudE9uVW5lcXVpcCAmJlxyXG4gICAgICAgIGEuY2hhcmdlUGVyY2VudCA9PT0gYi5jaGFyZ2VQZXJjZW50ICYmXHJcbiAgICAgICAgLy9uYW1lc0VxdWFsKGEsIGIpICYmXHJcbiAgICAgICAgYS5zb3VsID09PSBiLnNvdWwgJiZcclxuICAgICAgICBhLnBvaXNvbklkID09PSBiLnBvaXNvbklkICYmXHJcbiAgICAgICAgYS5wb2lzb25Db3VudCA9PT0gYi5wb2lzb25Db3VudCAmJlxyXG4gICAgICAgICgoISFhLndvcm4gPT09ICEhYi53b3JuICYmICEhYS53b3JuTGVmdCA9PT0gISFiLndvcm5MZWZ0KSB8fCBpZ25vcmVXb3JuKSk7XHJcbn07XHJcbmV4cG9ydCB2YXIgaGFzRXh0cmFzID0gZnVuY3Rpb24gKGUpIHtcclxuICAgIHJldHVybiAhZXh0cmFzRXF1YWwoZSwgeyBiYXNlSWQ6IDAsIGNvdW50OiAwIH0pO1xyXG59O1xyXG52YXIgZXh0cmFjdEV4dHJhRGF0YSA9IGZ1bmN0aW9uIChyZWZyLCBleHRyYUxpc3QsIG91dCkge1xyXG4gICAgLy8gSSBzZWUgdGhhdCBFeHRyYVdvcm4gaXMgbm90IGVtaXR0ZWQgZm9yIDB4RkYgYWN0b3JzIHdoZW4gYXJyb3dzIGFyZSBlcXVpcHBlZC4gRml4aW5nXHJcbiAgICB2YXIgaXRlbSA9IEdhbWUuZ2V0Rm9ybUV4KG91dC5iYXNlSWQpO1xyXG4gICAgaWYgKEFtbW8uZnJvbShpdGVtKSkge1xyXG4gICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgaWYgKGFjdG9yICYmIGFjdG9yLmlzRXF1aXBwZWQoaXRlbSkpIHtcclxuICAgICAgICAgICAgb3V0Lndvcm4gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIChleHRyYUxpc3QgfHwgW10pLmZvckVhY2goZnVuY3Rpb24gKGV4dHJhKSB7XHJcbiAgICAgICAgc3dpdGNoIChleHRyYS50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgXCJIZWFsdGhcIjpcclxuICAgICAgICAgICAgICAgIG91dC5oZWFsdGggPSBNYXRoLnJvdW5kKGV4dHJhLmhlYWx0aCAqIDEwKSAvIDEwO1xyXG4gICAgICAgICAgICAgICAgLy8gVEVTTW9kUGxhdGZvcm06OkFkZEl0ZW1FeCBtYWtlcyBhbGwgaXRlbXMgYXQgbGVhc3QgMS4wMSBoZWFsdGhcclxuICAgICAgICAgICAgICAgIGlmIChvdXQuaGVhbHRoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG91dC5oZWFsdGg7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIkNvdW50XCI6XHJcbiAgICAgICAgICAgICAgICBvdXQuY291bnQgPSBleHRyYS5jb3VudDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiRW5jaGFudG1lbnRcIjpcclxuICAgICAgICAgICAgICAgIG91dC5lbmNoYW50bWVudElkID0gZXh0cmEuZW5jaGFudG1lbnRJZDtcclxuICAgICAgICAgICAgICAgIG91dC5tYXhDaGFyZ2UgPSBleHRyYS5tYXhDaGFyZ2U7XHJcbiAgICAgICAgICAgICAgICBvdXQucmVtb3ZlRW5jaGFudG1lbnRPblVuZXF1aXAgPSBleHRyYS5yZW1vdmVPblVuZXF1aXA7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIkNoYXJnZVwiOlxyXG4gICAgICAgICAgICAgICAgb3V0LmNoYXJnZVBlcmNlbnQgPSBleHRyYS5jaGFyZ2U7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIlBvaXNvblwiOlxyXG4gICAgICAgICAgICAgICAgb3V0LnBvaXNvbklkID0gZXh0cmEucG9pc29uSWQ7XHJcbiAgICAgICAgICAgICAgICBvdXQucG9pc29uQ291bnQgPSBleHRyYS5jb3VudDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiU291bFwiOlxyXG4gICAgICAgICAgICAgICAgb3V0LnNvdWwgPSBleHRyYS5zb3VsO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJUZXh0RGlzcGxheURhdGFcIjpcclxuICAgICAgICAgICAgICAgIG91dC5uYW1lID0gZXh0cmEubmFtZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiV29yblwiOlxyXG4gICAgICAgICAgICAgICAgb3V0Lndvcm4gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJXb3JuTGVmdFwiOlxyXG4gICAgICAgICAgICAgICAgb3V0Lndvcm5MZWZ0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59O1xyXG52YXIgc3F1YXNoID0gZnVuY3Rpb24gKGludikge1xyXG4gICAgdmFyIHJlcyA9IG5ldyBBcnJheSgpO1xyXG4gICAgaW52LmVudHJpZXMuZm9yRWFjaChmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBzYW1lID0gcmVzLmZpbmQoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIGUuYmFzZUlkID09PSB4LmJhc2VJZCAmJiBleHRyYXNFcXVhbCh4LCBlKTsgfSk7XHJcbiAgICAgICAgaWYgKHNhbWUpIHtcclxuICAgICAgICAgICAgc2FtZS5jb3VudCArPSBlLmNvdW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmVzLnB1c2goSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlKSkpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHsgZW50cmllczogcmVzLmZpbHRlcihmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5jb3VudCAhPT0gMDsgfSkgfTtcclxufTtcclxudmFyIGdldEV4dHJhQ29udGFpbmVyQ2hhbmdlc0FzSW52ZW50b3J5ID0gZnVuY3Rpb24gKHJlZnIpIHtcclxuICAgIHZhciBleHRyYUNvbnRhaW5lckNoYW5nZXMgPSBnZXRFeHRyYUNvbnRhaW5lckNoYW5nZXMocmVmci5nZXRGb3JtSUQoKSk7XHJcbiAgICB2YXIgZW50cmllcyA9IG5ldyBBcnJheSgpO1xyXG4gICAgKGV4dHJhQ29udGFpbmVyQ2hhbmdlcyB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbiAoY2hhbmdlc0VudHJ5KSB7XHJcbiAgICAgICAgdmFyIGVudHJ5ID0ge1xyXG4gICAgICAgICAgICBiYXNlSWQ6IGNoYW5nZXNFbnRyeS5iYXNlSWQsXHJcbiAgICAgICAgICAgIGNvdW50OiBjaGFuZ2VzRW50cnkuY291bnREZWx0YSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIChjaGFuZ2VzRW50cnkuZXh0ZW5kRGF0YUxpc3QgfHwgW10pLmZvckVhY2goZnVuY3Rpb24gKGV4dHJhTGlzdCkge1xyXG4gICAgICAgICAgICB2YXIgZSA9IHtcclxuICAgICAgICAgICAgICAgIGJhc2VJZDogZW50cnkuYmFzZUlkLFxyXG4gICAgICAgICAgICAgICAgY291bnQ6IDEsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGV4dHJhY3RFeHRyYURhdGEocmVmciwgZXh0cmFMaXN0LCBlKTtcclxuICAgICAgICAgICAgZW50cmllcy5wdXNoKGUpO1xyXG4gICAgICAgICAgICBlbnRyeS5jb3VudCAtPSBlLmNvdW50O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChlbnRyeS5jb3VudCAhPT0gMCkge1xyXG4gICAgICAgICAgICBlbnRyaWVzLnB1c2goZW50cnkpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgdmFyIHJlcyA9IHsgZW50cmllczogZW50cmllcyB9O1xyXG4gICAgcmVzID0gc3F1YXNoKHJlcyk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG59O1xyXG52YXIgZ2V0QmFzZUNvbnRhaW5lckFzSW52ZW50b3J5ID0gZnVuY3Rpb24gKHJlZnIpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgZW50cmllczogZ2V0Q29udGFpbmVyKHJlZnIuZ2V0QmFzZU9iamVjdCgpLmdldEZvcm1JRCgpKSxcclxuICAgIH07XHJcbn07XHJcbmV4cG9ydCB2YXIgc3VtSW52ZW50b3JpZXMgPSBmdW5jdGlvbiAobGhzLCByaHMpIHtcclxuICAgIHZhciBsZWZ0RW50cmllc1dpdGhFeHRyYXMgPSBsaHMuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGhhc0V4dHJhcyhlKTsgfSk7XHJcbiAgICB2YXIgcmlnaHRFbnRyaWVzV2l0aEV4dHJhcyA9IHJocy5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoZSkgeyByZXR1cm4gaGFzRXh0cmFzKGUpOyB9KTtcclxuICAgIHZhciBsZWZ0RW50cmllc1NpbXBsZSA9IGxocy5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoZSkgeyByZXR1cm4gIWhhc0V4dHJhcyhlKTsgfSk7XHJcbiAgICB2YXIgcmlnaHRFbnRyaWVzU2ltcGxlID0gcmhzLmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uIChlKSB7IHJldHVybiAhaGFzRXh0cmFzKGUpOyB9KTtcclxuICAgIGxlZnRFbnRyaWVzU2ltcGxlLmZvckVhY2goZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgbWF0Y2hpbmcgPSByaWdodEVudHJpZXNTaW1wbGUuZmluZChmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5iYXNlSWQgPT09IGUuYmFzZUlkOyB9KTtcclxuICAgICAgICBpZiAobWF0Y2hpbmcpIHtcclxuICAgICAgICAgICAgZS5jb3VudCArPSBtYXRjaGluZy5jb3VudDtcclxuICAgICAgICAgICAgbWF0Y2hpbmcuY291bnQgPSAwO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBlbnRyaWVzOiBsZWZ0RW50cmllc1dpdGhFeHRyYXNcclxuICAgICAgICAgICAgLmNvbmNhdChyaWdodEVudHJpZXNXaXRoRXh0cmFzKVxyXG4gICAgICAgICAgICAuY29uY2F0KGxlZnRFbnRyaWVzU2ltcGxlKVxyXG4gICAgICAgICAgICAuY29uY2F0KHJpZ2h0RW50cmllc1NpbXBsZSlcclxuICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoZSkgeyByZXR1cm4gZS5jb3VudCAhPT0gMDsgfSksXHJcbiAgICB9O1xyXG59O1xyXG5leHBvcnQgdmFyIHJlbW92ZVNpbXBsZUl0ZW1zQXNNYW55QXNQb3NzaWJsZSA9IGZ1bmN0aW9uIChpbnYsIGJhc2VJZCwgY291bnQpIHtcclxuICAgIHZhciByZXMgPSB7IGVudHJpZXM6IFtdIH07XHJcbiAgICByZXMuZW50cmllcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoaW52LmVudHJpZXMpKTtcclxuICAgIHZhciBlbnRyeSA9IHJlcy5lbnRyaWVzLmZpbmQoZnVuY3Rpb24gKGUpIHsgcmV0dXJuICFoYXNFeHRyYXMoZSkgJiYgZS5iYXNlSWQgPT09IGJhc2VJZDsgfSk7XHJcbiAgICBpZiAoZW50cnkpIHtcclxuICAgICAgICBlbnRyeS5jb3VudCAtPSBjb3VudDtcclxuICAgIH1cclxuICAgIHJlcy5lbnRyaWVzID0gcmVzLmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uIChlKSB7IHJldHVybiBlLmNvdW50ID4gMDsgfSk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG59O1xyXG5leHBvcnQgdmFyIGdldERpZmYgPSBmdW5jdGlvbiAobGhzLCByaHMsIGlnbm9yZVdvcm4pIHtcclxuICAgIHZhciBsaHNDb3B5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShsaHMpKTtcclxuICAgIHZhciByaHNDb3B5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyaHMpKTtcclxuICAgIHJoc0NvcHkuZW50cmllcy5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIHNhbWVGcm9tTGVmdCA9IGxoc0NvcHkuZW50cmllcy5maW5kKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmJhc2VJZCA9PT0gZS5iYXNlSWQgJiYgZXh0cmFzRXF1YWwoeCwgZSwgaWdub3JlV29ybik7IH0pO1xyXG4gICAgICAgIGlmIChzYW1lRnJvbUxlZnQpIHtcclxuICAgICAgICAgICAgc2FtZUZyb21MZWZ0LmNvdW50IC09IGUuY291bnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsaHNDb3B5LmVudHJpZXMucHVzaChlKTtcclxuICAgICAgICAgICAgbGhzQ29weS5lbnRyaWVzW2xoc0NvcHkuZW50cmllcy5sZW5ndGggLSAxXS5jb3VudCAqPSAtMTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB7IGVudHJpZXM6IGxoc0NvcHkuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguY291bnQgIT09IDA7IH0pIH07XHJcbn07XHJcbmV4cG9ydCB2YXIgZ2V0SW52ZW50b3J5ID0gZnVuY3Rpb24gKHJlZnIpIHtcclxuICAgIHJldHVybiBzcXVhc2goc3VtSW52ZW50b3JpZXMoZ2V0QmFzZUNvbnRhaW5lckFzSW52ZW50b3J5KHJlZnIpLCBnZXRFeHRyYUNvbnRhaW5lckNoYW5nZXNBc0ludmVudG9yeShyZWZyKSkpO1xyXG59O1xyXG52YXIgYmFzZXNSZXNldCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmIChzdG9yYWdlW1wiYmFzZXNSZXNldEV4aXN0c1wiXSAhPT0gdHJ1ZSkge1xyXG4gICAgICAgIHN0b3JhZ2VbXCJiYXNlc1Jlc2V0RXhpc3RzXCJdID0gdHJ1ZTtcclxuICAgICAgICBzdG9yYWdlW1wiYmFzZXNSZXNldFwiXSA9IG5ldyBTZXQoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBzdG9yYWdlW1wiYmFzZXNSZXNldFwiXTtcclxufTtcclxudmFyIHJlc2V0QmFzZSA9IGZ1bmN0aW9uIChyZWZyKSB7XHJcbiAgICB2YXIgYmFzZSA9IHJlZnIuZ2V0QmFzZU9iamVjdCgpO1xyXG4gICAgdmFyIGJhc2VJZCA9IGJhc2UgPyBiYXNlLmdldEZvcm1JRCgpIDogMDtcclxuICAgIGlmICghYmFzZXNSZXNldCgpLmhhcyhiYXNlSWQpKSB7XHJcbiAgICAgICAgYmFzZXNSZXNldCgpLmFkZChiYXNlSWQpO1xyXG4gICAgICAgIFRFU01vZFBsYXRmb3JtLnJlc2V0Q29udGFpbmVyKGJhc2UpO1xyXG4gICAgICAgIHJlZnIucmVtb3ZlQWxsSXRlbXMobnVsbCwgZmFsc2UsIHRydWUpO1xyXG4gICAgfVxyXG59O1xyXG5leHBvcnQgdmFyIGFwcGx5SW52ZW50b3J5ID0gZnVuY3Rpb24gKHJlZnIsIG5ld0ludmVudG9yeSwgZW5hYmxlQ3Jhc2hQcm90ZWN0aW9uLCBpZ25vcmVXb3JuKSB7XHJcbiAgICBpZiAoaWdub3JlV29ybiA9PT0gdm9pZCAwKSB7IGlnbm9yZVdvcm4gPSBmYWxzZTsgfVxyXG4gICAgcmVzZXRCYXNlKHJlZnIpO1xyXG4gICAgdmFyIGRpZmYgPSBnZXREaWZmKG5ld0ludmVudG9yeSwgZ2V0SW52ZW50b3J5KHJlZnIpLCBpZ25vcmVXb3JuKS5lbnRyaWVzO1xyXG4gICAgdmFyIHJlcyA9IHRydWU7XHJcbiAgICBkaWZmLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIChhLmNvdW50IDwgYi5jb3VudCA/IC0xIDogMSk7IH0pO1xyXG4gICAgZGlmZi5mb3JFYWNoKGZ1bmN0aW9uIChlLCBpKSB7XHJcbiAgICAgICAgaWYgKGkgPiAwICYmIGVuYWJsZUNyYXNoUHJvdGVjdGlvbikge1xyXG4gICAgICAgICAgICByZXMgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYWJzQ291bnQgPSBNYXRoLmFicyhlLmNvdW50KTtcclxuICAgICAgICB2YXIgcXVldWVOaU5vZGVVcGRhdGVOZWVkZWQgPSBmYWxzZTtcclxuICAgICAgICB2YXIgd29ybiA9ICEhZS53b3JuO1xyXG4gICAgICAgIHZhciB3b3JuTGVmdCA9ICEhZS53b3JuTGVmdDtcclxuICAgICAgICB2YXIgb25lU3RlcENvdW50ID0gZS5jb3VudCAvIGFic0NvdW50O1xyXG4gICAgICAgIHZhciBmID0gR2FtZS5nZXRGb3JtRXgoZS5iYXNlSWQpO1xyXG4gICAgICAgIGlmICghZikge1xyXG4gICAgICAgICAgICByZXR1cm4gcHJpbnRDb25zb2xlKFwiQmFkIGZvcm0gSUQgXCIuY29uY2F0KGUuYmFzZUlkLnRvU3RyaW5nKDE2KSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdHlwZSA9IGYuZ2V0VHlwZSgpO1xyXG4gICAgICAgIC8vIEZvciBtaXNjIGl0ZW1zLCBwb3Rpb25zIGFuZCBpbmdyZWRpZW50cyB3ZSBkb24ndCB3YW50IHRvIHNwbGl0IHRoZW0gaW50byBtdWx0aXBsZSBpdGVtc1xyXG4gICAgICAgIC8vIFRoaXMgd2FzIG1hZGUgdG8gZml4IGEgcGVyZm9ybWFuY2UgaXNzdWUgd2l0aCB1c2VycyBoYXZpbmcgMTAwMDArIG9mIG1pc2MgaXRlbXMgKGkuZS4gZ29sZClcclxuICAgICAgICBpZiAodHlwZSA9PT0gMzIgLyogRm9ybVR5cGUuTWlzYyAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSA0NiAvKiBGb3JtVHlwZS5Qb3Rpb24gKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMzAgLyogRm9ybVR5cGUuSW5ncmVkaWVudCAqLykge1xyXG4gICAgICAgICAgICBhYnNDb3VudCA9IDE7XHJcbiAgICAgICAgICAgIG9uZVN0ZXBDb3VudCA9IGUuY291bnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoYWJzQ291bnQgPiAxMDAwKSB7XHJcbiAgICAgICAgICAgICAgICBhYnNDb3VudCA9IDE7XHJcbiAgICAgICAgICAgICAgICBvbmVTdGVwQ291bnQgPSAxO1xyXG4gICAgICAgICAgICAgICAgLy8gQWxzbyBmb3IgYXJyb3dzIHdpdGggc3RyYW5nZSBjb3VudFxyXG4gICAgICAgICAgICAgICAgaWYgKHdvcm4gJiYgZS5jb3VudCA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBhYnNDb3VudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGUuY291bnQgPiAxICYmIEFtbW8uZnJvbShHYW1lLmdldEZvcm1FeChlLmJhc2VJZCkpKSB7XHJcbiAgICAgICAgICAgICAgICBhYnNDb3VudCA9IDE7XHJcbiAgICAgICAgICAgICAgICBvbmVTdGVwQ291bnQgPSBlLmNvdW50O1xyXG4gICAgICAgICAgICAgICAgaWYgKGUuY291bnQgPiA2MDAwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFdoeSB3b3VsZCBhY3RvciBoYXZlIDYwayBhcnJvd3M/XHJcbiAgICAgICAgICAgICAgICAgICAgZS5jb3VudCA9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgaV8xID0gMDsgaV8xIDwgYWJzQ291bnQ7ICsraV8xKSB7XHJcbiAgICAgICAgICAgIGlmICh3b3JuIHx8IHdvcm5MZWZ0KSB7XHJcbiAgICAgICAgICAgICAgICBURVNNb2RQbGF0Zm9ybS5wdXNoV29yblN0YXRlKCEhd29ybiwgISF3b3JuTGVmdCk7XHJcbiAgICAgICAgICAgICAgICBxdWV1ZU5pTm9kZVVwZGF0ZU5lZWRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGFkZEl0ZW1FeEFyZ3MgPSB2b2lkIDA7XHJcbiAgICAgICAgICAgIGFkZEl0ZW1FeEFyZ3MgPSBbXHJcbiAgICAgICAgICAgICAgICByZWZyLFxyXG4gICAgICAgICAgICAgICAgZixcclxuICAgICAgICAgICAgICAgIG9uZVN0ZXBDb3VudCxcclxuICAgICAgICAgICAgICAgIGUuaGVhbHRoID8gZS5oZWFsdGggOiAxLFxyXG4gICAgICAgICAgICAgICAgZS5lbmNoYW50bWVudElkXHJcbiAgICAgICAgICAgICAgICAgICAgPyBFbmNoYW50bWVudC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGUuZW5jaGFudG1lbnRJZCkpXHJcbiAgICAgICAgICAgICAgICAgICAgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgZS5tYXhDaGFyZ2UgPyBlLm1heENoYXJnZSA6IDAsXHJcbiAgICAgICAgICAgICAgICAhIWUucmVtb3ZlRW5jaGFudG1lbnRPblVuZXF1aXAsXHJcbiAgICAgICAgICAgICAgICBlLmNoYXJnZVBlcmNlbnQgPyBlLmNoYXJnZVBlcmNlbnQgOiAwLFxyXG4gICAgICAgICAgICAgICAgZS5uYW1lID8gY3JvcE5hbWUoZS5uYW1lKSA6IGYuZ2V0TmFtZSgpLFxyXG4gICAgICAgICAgICAgICAgZS5zb3VsID8gZS5zb3VsIDogMCxcclxuICAgICAgICAgICAgICAgIGUucG9pc29uSWQgPyBQb3Rpb24uZnJvbShHYW1lLmdldEZvcm1FeChlLnBvaXNvbklkKSkgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgZS5wb2lzb25Db3VudCA/IGUucG9pc29uQ291bnQgOiAwXHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgIHZhciBhcmdzVG9QcmludCA9IGFkZEl0ZW1FeEFyZ3MubWFwKGZ1bmN0aW9uIChhcmcpIHtcclxuICAgICAgICAgICAgICAgIGlmIChhcmcgaW5zdGFuY2VvZiBPYmplY3RSZWZlcmVuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJPYmplY3RSZWZlcmVuY2UoXCIuY29uY2F0KGFyZy5nZXRGb3JtSUQoKS50b1N0cmluZygxNiksIFwiKVwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEZvcm0pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJGb3JtKFwiLmNvbmNhdChhcmcuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpLCBcIilcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHByaW50Q29uc29sZShcIlRFU01vZFBsYXRmb3JtLmFkZEl0ZW1FeChcIi5jb25jYXQoYXJnc1RvUHJpbnQuam9pbihcIiwgXCIpLCBcIilcIikpO1xyXG4gICAgICAgICAgICBURVNNb2RQbGF0Zm9ybS5hZGRJdGVtRXguYXBwbHkoVEVTTW9kUGxhdGZvcm0sIGFkZEl0ZW1FeEFyZ3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocXVldWVOaU5vZGVVcGRhdGVOZWVkZWQpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgICAgICBhYy5xdWV1ZU5pTm9kZVVwZGF0ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzO1xyXG59O1xyXG4iLCJpbXBvcnQgeyBBY3RvciwgR2FtZSwgVEVTTW9kUGxhdGZvcm0sIERlYnVnIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IFJlc3Bhd25OZWVkZWRFcnJvciB9IGZyb20gXCIuLi9saWIvZXJyb3JzXCI7XHJcbmltcG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH0gZnJvbSBcIi4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXhcIjtcclxuaW1wb3J0IHsgU3BBcGlJbnRlcmFjdG9yIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NwQXBpSW50ZXJhY3RvclwiO1xyXG52YXIgc3FyID0gZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHggKiB4OyB9O1xyXG5leHBvcnQgdmFyIGFwcGx5TW92ZW1lbnQgPSBmdW5jdGlvbiAocmVmciwgbSwgaXNNeUNsb25lKSB7XHJcbiAgICBpZiAodGVsZXBvcnRJZk5lZWQocmVmciwgbSkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyBaIGF4aXMgaXNuJ3QgdXNlZnVsIGhlcmVcclxuICAgIHZhciBhY1ggPSByZWZyLmdldFBvc2l0aW9uWCgpO1xyXG4gICAgdmFyIGFjWSA9IHJlZnIuZ2V0UG9zaXRpb25ZKCk7XHJcbiAgICB2YXIgbGFnVW5pdHNOb1ogPSBNYXRoLnJvdW5kKE1hdGguc3FydChzcXIobS5wb3NbMF0gLSBhY1gpICsgc3FyKG0ucG9zWzFdIC0gYWNZKSkpO1xyXG4gICAgaWYgKGlzTXlDbG9uZSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5lbWl0dGVyLmVtaXQoXCJuZXdMb2NhbExhZ1ZhbHVlQ2FsY3VsYXRlZFwiLCB7IGxhZ1VuaXRzTm9aOiBsYWdVbml0c05vWiB9KTtcclxuICAgIH1cclxuICAgIHRyYW5zbGF0ZVRvKHJlZnIsIG0pO1xyXG4gICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgIGlmICghYWMpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB2YXIgbG9va0F0ID0gbnVsbDtcclxuICAgIGlmIChtLmxvb2tBdCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxvb2tBdCA9IEdhbWUuZmluZENsb3Nlc3RBY3RvcihtLmxvb2tBdFswXSwgbS5sb29rQXRbMV0sIG0ubG9va0F0WzJdLCAxMjgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBsb29rQXQgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChsb29rQXQpIHtcclxuICAgICAgICBhYy5zZXRIZWFkVHJhY2tpbmcodHJ1ZSk7XHJcbiAgICAgICAgYWMuc2V0TG9va0F0KGxvb2tBdCwgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgYWMuc2V0SGVhZFRyYWNraW5nKGZhbHNlKTtcclxuICAgIH1cclxuICAgIC8vIGFjLnN0b3BDb21iYXQoKTtcclxuICAgIGFjLmJsb2NrQWN0aXZhdGlvbih0cnVlKTtcclxuICAgIGtlZXBPZmZzZXRGcm9tQWN0b3IoYWMsIG0pO1xyXG4gICAgYXBwbHlTcHJpbnRpbmcoYWMsIG0ucnVuTW9kZSA9PT0gXCJTcHJpbnRpbmdcIik7XHJcbiAgICBhcHBseUJsb2NraW5nKGFjLCBtKTtcclxuICAgIGFwcGx5U25lYWtpbmcoYWMsIG0uaXNTbmVha2luZyk7XHJcbiAgICBhcHBseVdlYXBEcmF3bihhYywgbS5pc1dlYXBEcmF3bik7XHJcbiAgICBhcHBseUhlYWx0aFBlcmNlbnRhZ2UoYWMsIG0uaGVhbHRoUGVyY2VudGFnZSk7XHJcbiAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkuZW1pdHRlci5lbWl0KFwiYXBwbHlEZWF0aFN0YXRlRXZlbnRcIiwgeyBhY3RvcjogYWMsIGlzRGVhZDogbS5pc0RlYWQgfSk7XHJcbn07XHJcbnZhciBrZWVwT2Zmc2V0RnJvbUFjdG9yID0gZnVuY3Rpb24gKGFjLCBtKSB7XHJcbiAgICB2YXIgb2Zmc2V0QW5nbGUgPSBtLnJvdFsyXSAtIGFjLmdldEFuZ2xlWigpO1xyXG4gICAgaWYgKE1hdGguYWJzKG9mZnNldEFuZ2xlKSA8IDUpIHtcclxuICAgICAgICBvZmZzZXRBbmdsZSA9IDA7XHJcbiAgICB9XHJcbiAgICBpZiAobS5ydW5Nb2RlID09PSBcIlN0YW5kaW5nXCIpIHtcclxuICAgICAgICByZXR1cm4gYWMua2VlcE9mZnNldEZyb21BY3RvcihhYywgMCwgMCwgMCwgMCwgMCwgb2Zmc2V0QW5nbGUsIDEsIDEpO1xyXG4gICAgfVxyXG4gICAgdmFyIG9mZnNldCA9IFtcclxuICAgICAgICAzICogTWF0aC5zaW4oKG0uZGlyZWN0aW9uIC8gMTgwKSAqIE1hdGguUEkpLFxyXG4gICAgICAgIDMgKiBNYXRoLmNvcygobS5kaXJlY3Rpb24gLyAxODApICogTWF0aC5QSSksXHJcbiAgICAgICAgZ2V0T2Zmc2V0WihtLnJ1bk1vZGUpLFxyXG4gICAgXTtcclxuICAgIGFjLmtlZXBPZmZzZXRGcm9tQWN0b3IoYWMsIG9mZnNldFswXSwgb2Zmc2V0WzFdLCBvZmZzZXRbMl0sIDAsIDAsIG9mZnNldEFuZ2xlLCBtLnJ1bk1vZGUgPT09IFwiV2Fsa2luZ1wiID8gMjA0OCA6IDEsIDEpO1xyXG59O1xyXG52YXIgZ2V0T2Zmc2V0WiA9IGZ1bmN0aW9uIChydW5Nb2RlKSB7XHJcbiAgICBzd2l0Y2ggKHJ1bk1vZGUpIHtcclxuICAgICAgICBjYXNlIFwiV2Fsa2luZ1wiOlxyXG4gICAgICAgICAgICByZXR1cm4gLTUxMjtcclxuICAgICAgICBjYXNlIFwiUnVubmluZ1wiOlxyXG4gICAgICAgICAgICByZXR1cm4gLTEwMjQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gMDtcclxufTtcclxudmFyIGFwcGx5U3ByaW50aW5nID0gZnVuY3Rpb24gKGFjLCBpc1NwcmludGluZykge1xyXG4gICAgaWYgKGFjLmlzU3ByaW50aW5nKCkgIT0gaXNTcHJpbnRpbmcpIHtcclxuICAgICAgICBEZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQoYWMsIGlzU3ByaW50aW5nID8gXCJTcHJpbnRTdGFydFwiIDogXCJTcHJpbnRTdG9wXCIpO1xyXG4gICAgfVxyXG59O1xyXG52YXIgYXBwbHlCbG9ja2luZyA9IGZ1bmN0aW9uIChhYywgbSkge1xyXG4gICAgaWYgKGFjLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzQmxvY2tpbmdcIikgIT0gbS5pc0Jsb2NraW5nKSB7XHJcbiAgICAgICAgRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KGFjLCBtLmlzQmxvY2tpbmcgPyBcIkJsb2NrU3RhcnRcIiA6IFwiQmxvY2tTdG9wXCIpO1xyXG4gICAgICAgIERlYnVnLnNlbmRBbmltYXRpb25FdmVudChhYywgbS5pc1NuZWFraW5nID8gXCJTbmVha1N0YXJ0XCIgOiBcIlNuZWFrU3RvcFwiKTtcclxuICAgIH1cclxufTtcclxudmFyIGFwcGx5U25lYWtpbmcgPSBmdW5jdGlvbiAoYWMsIGlzU25lYWtpbmcpIHtcclxuICAgIHZhciBjdXJyZW50SXNTbmVha2luZyA9IGFjLmlzU25lYWtpbmcoKSB8fCBhYy5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc1NuZWFraW5nXCIpO1xyXG4gICAgaWYgKGN1cnJlbnRJc1NuZWFraW5nICE9IGlzU25lYWtpbmcpIHtcclxuICAgICAgICBEZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQoYWMsIGlzU25lYWtpbmcgPyBcIlNuZWFrU3RhcnRcIiA6IFwiU25lYWtTdG9wXCIpO1xyXG4gICAgfVxyXG59O1xyXG5leHBvcnQgdmFyIGFwcGx5V2VhcERyYXduID0gZnVuY3Rpb24gKGFjLCBpc1dlYXBEcmF3bikge1xyXG4gICAgaWYgKGFjLmlzV2VhcG9uRHJhd24oKSAhPT0gaXNXZWFwRHJhd24pIHtcclxuICAgICAgICBURVNNb2RQbGF0Zm9ybS5zZXRXZWFwb25EcmF3bk1vZGUoYWMsIGlzV2VhcERyYXduID8gMSA6IDApO1xyXG4gICAgfVxyXG59O1xyXG52YXIgYXBwbHlIZWFsdGhQZXJjZW50YWdlID0gZnVuY3Rpb24gKGFjLCBoZWFsdGhQZXJjZW50YWdlKSB7XHJcbiAgICB2YXIgY3VycmVudFBlcmNlbnRhZ2UgPSBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZSgnaGVhbHRoJyk7XHJcbiAgICBpZiAoY3VycmVudFBlcmNlbnRhZ2UgPT09IGhlYWx0aFBlcmNlbnRhZ2UpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB2YXIgY3VycmVudE1heCA9IGFjLmdldEJhc2VBY3RvclZhbHVlKCdoZWFsdGgnKTtcclxuICAgIHZhciBkZWx0YVBlcmNlbnRhZ2UgPSBoZWFsdGhQZXJjZW50YWdlIC0gY3VycmVudFBlcmNlbnRhZ2U7XHJcbiAgICB2YXIgayA9IDAuMjU7XHJcbiAgICBpZiAoZGVsdGFQZXJjZW50YWdlID4gMCkge1xyXG4gICAgICAgIGFjLnJlc3RvcmVBY3RvclZhbHVlKCdoZWFsdGgnLCBkZWx0YVBlcmNlbnRhZ2UgKiBjdXJyZW50TWF4ICogayk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmIChkZWx0YVBlcmNlbnRhZ2UgPCAwKSB7XHJcbiAgICAgICAgYWMuZGFtYWdlQWN0b3JWYWx1ZSgnaGVhbHRoJywgZGVsdGFQZXJjZW50YWdlICogY3VycmVudE1heCAqIGspO1xyXG4gICAgfVxyXG59O1xyXG4vLyBVc2UgZ2xvYmFsIHRlbXAgdmFyIHRvIGF2b2lkIGFsbG9jYXRpb24gb2YgYW4gYXJyYXkgb24gZWFjaCB0cmFuc2xhdGVUb1xyXG52YXIgZ1RlbXBUYXJnZXRQb3MgPSBbMCwgMCwgMF07XHJcbnZhciB0cmFuc2xhdGVUbyA9IGZ1bmN0aW9uIChyZWZyLCBtKSB7XHJcbiAgICB2YXIgX2E7XHJcbiAgICB2YXIgdGltZSA9IDAuMjtcclxuICAgIGlmIChtLmlzSW5KdW1wU3RhdGUgfHwgbS5ydW5Nb2RlICE9PSBcIlN0YW5kaW5nXCIpIHtcclxuICAgICAgICB0aW1lID0gMC4yO1xyXG4gICAgfVxyXG4gICAgLy8gTG9jYWwgbGFnIGNvbXBlbnNhdGlvblxyXG4gICAgLy8gVE9ETzogUmVtb3ZlIFwifHwgMFwiIGhhY2sgKGFkZGVkIHRvIHN1cHBvcnQgb2xkIE1wQ2xpZW50UGx1Z2luKVxyXG4gICAgdmFyIGRpc3RhbmNlQWRkID0gKG0uc3BlZWQgfHwgMCkgKiB0aW1lO1xyXG4gICAgdmFyIGRpcmVjdGlvbiA9IG0ucm90WzJdICsgbS5kaXJlY3Rpb247XHJcbiAgICBnVGVtcFRhcmdldFBvc1swXSA9IG0ucG9zWzBdO1xyXG4gICAgZ1RlbXBUYXJnZXRQb3NbMV0gPSBtLnBvc1sxXTtcclxuICAgIGdUZW1wVGFyZ2V0UG9zWzJdID0gbS5wb3NbMl07XHJcbiAgICAvLyBXZSBkbyBub3Qgd2FudCB0byBhZGQgcG9zIGluIGNhc2Ugb2Ygc3RhbmRpbmctanVtcGluZ1xyXG4gICAgaWYgKG0ucnVuTW9kZSAhPT0gXCJTdGFuZGluZ1wiKSB7XHJcbiAgICAgICAgZ1RlbXBUYXJnZXRQb3NbMF0gKz0gTWF0aC5zaW4oZGlyZWN0aW9uIC8gMTgwICogTWF0aC5QSSkgKiBkaXN0YW5jZUFkZDtcclxuICAgICAgICBnVGVtcFRhcmdldFBvc1sxXSArPSBNYXRoLmNvcyhkaXJlY3Rpb24gLyAxODAgKiBNYXRoLlBJKSAqIGRpc3RhbmNlQWRkO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlZnJSZWFsUG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKHJlZnIpO1xyXG4gICAgdmFyIGRpc3RhbmNlID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2UocmVmclJlYWxQb3MsIGdUZW1wVGFyZ2V0UG9zKTtcclxuICAgIHZhciBzcGVlZCA9IGRpc3RhbmNlIC8gdGltZTtcclxuICAgIHZhciBhbmdsZURpZmYgPSBNYXRoLmFicyhtLnJvdFsyXSAtIHJlZnIuZ2V0QW5nbGVaKCkpO1xyXG4gICAgaWYgKG0ucnVuTW9kZSAhPT0gXCJTdGFuZGluZ1wiIHx8XHJcbiAgICAgICAgbS5pc0luSnVtcFN0YXRlIHx8XHJcbiAgICAgICAgT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2VOb1oocmVmclJlYWxQb3MsIGdUZW1wVGFyZ2V0UG9zKSA+IDggfHxcclxuICAgICAgICBhbmdsZURpZmYgPiA4MCB8fFxyXG4gICAgICAgICgoX2EgPSBBY3Rvci5mcm9tKHJlZnIpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0U2l0U3RhdGUoKSkgPT09IDMpIHtcclxuICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgIGlmIChhY3RvciAmJiBhY3Rvci5nZXRBY3RvclZhbHVlKFwiVmFyaWFibGUxMFwiKSA8IC05OTkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWFjdG9yIHx8ICFhY3Rvci5pc0RlYWQoKSkge1xyXG4gICAgICAgICAgICByZWZyLnRyYW5zbGF0ZVRvKGdUZW1wVGFyZ2V0UG9zWzBdLCBnVGVtcFRhcmdldFBvc1sxXSwgZ1RlbXBUYXJnZXRQb3NbMl0sIG0ucm90WzBdLCBtLnJvdFsxXSwgbS5yb3RbMl0sIHNwZWVkLCAwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn07XHJcbnZhciB0ZWxlcG9ydElmTmVlZCA9IGZ1bmN0aW9uIChyZWZyLCBtKSB7XHJcbiAgICBpZiAoaXNJbkRpZmZlcmVudFdvcmxkT3JDZWxsKHJlZnIsIG0ud29ybGRPckNlbGwpIHx8XHJcbiAgICAgICAgKCFyZWZyLmlzM0RMb2FkZWQoKSAmJiBpc0luRGlmZmVyZW50RXh0ZXJpb3JDZWxsKHJlZnIsIG0ucG9zKSkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgUmVzcGF3bk5lZWRlZEVycm9yKFwibmVlZHMgdG8gYmUgcmVzcGF3bmVkXCIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59O1xyXG52YXIgY2VsbFdpZHRoID0gNDA5NjtcclxudmFyIGlzSW5EaWZmZXJlbnRFeHRlcmlvckNlbGwgPSBmdW5jdGlvbiAocmVmciwgcG9zKSB7XHJcbiAgICB2YXIgY3VycmVudFBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhyZWZyKTtcclxuICAgIHZhciBwbGF5ZXJQb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MoR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICB2YXIgdGFyZ2V0RGlzdGFuY2VUb1BsYXllciA9IE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlKHBsYXllclBvcywgcG9zKTtcclxuICAgIHZhciBjdXJyZW50RGlzdGFuY2VUb1BsYXllciA9IE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlKHBsYXllclBvcywgY3VycmVudFBvcyk7XHJcbiAgICByZXR1cm4gY3VycmVudERpc3RhbmNlVG9QbGF5ZXIgPiBjZWxsV2lkdGggJiYgdGFyZ2V0RGlzdGFuY2VUb1BsYXllciA8PSBjZWxsV2lkdGg7XHJcbn07XHJcbnZhciBpc0luRGlmZmVyZW50V29ybGRPckNlbGwgPSBmdW5jdGlvbiAocmVmciwgd29ybGRPckNlbGwpIHtcclxuICAgIHJldHVybiB3b3JsZE9yQ2VsbCAhPT0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwocmVmcik7XHJcbn07XHJcbiIsImltcG9ydCB7IEFjdG9yLCBURVNNb2RQbGF0Zm9ybSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gJy4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXgnO1xyXG52YXIgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yKCkge1xyXG4gICAgfVxyXG4gICAgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLnNhdmVQb3NpdGlvbiA9IGZ1bmN0aW9uIChwb3MsIHdvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgdGhpcy5sYXN0UGNQb3MgPSBwb3M7XHJcbiAgICAgICAgdGhpcy5sYXN0UGNQb3NDaGVjayA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdGhpcy5sYXN0UGNXb3JsZE9yQ2VsbCA9IHdvcmxkT3JDZWxsO1xyXG4gICAgfTtcclxuICAgIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5nZXRTcGVlZCA9IGZ1bmN0aW9uIChjdXJyZW50UG9zLCB3b3JsZE9yQ2VsbCkge1xyXG4gICAgICAgIGlmICh0aGlzLmxhc3RQY1Bvc0NoZWNrID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRpbWVEZWx0YVNlYyA9IChEYXRlLm5vdygpIC0gdGhpcy5sYXN0UGNQb3NDaGVjaykgLyAxMDAwO1xyXG4gICAgICAgIGlmICh0aW1lRGVsdGFTZWMgPiA1KVxyXG4gICAgICAgICAgICByZXR1cm4gMDsgLy8gVG9vIGluYWNjdXJhdGVcclxuICAgICAgICBpZiAodGltZURlbHRhU2VjID09PSAwKVxyXG4gICAgICAgICAgICByZXR1cm4gMDsgLy8gRGl2aXNpb24gYnkgemVyb1xyXG4gICAgICAgIGlmICh3b3JsZE9yQ2VsbCAhPT0gdGhpcy5sYXN0UGNXb3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGRpc3RhbmNlID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2UoY3VycmVudFBvcywgdGhpcy5sYXN0UGNQb3MpO1xyXG4gICAgICAgIHJldHVybiBkaXN0YW5jZSAvIHRpbWVEZWx0YVNlYztcclxuICAgIH07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IubGFzdFBjUG9zID0gWzAsIDAsIDBdO1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLmxhc3RQY1Bvc0NoZWNrID0gLTE7XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IubGFzdFBjV29ybGRPckNlbGwgPSAwO1xyXG4gICAgcmV0dXJuIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvcjtcclxufSgpKTtcclxuZXhwb3J0IHZhciBnZXRNb3ZlbWVudCA9IGZ1bmN0aW9uIChyZWZyLCBmb3JtKSB7XHJcbiAgICB2YXIgX2E7XHJcbiAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgLy8gSXQgaXMgcnVubmluZyBmb3IgT2JqZWN0UmVmZXJlbmNlcyBiZWNhdXNlIFN0YW5kaW5nXHJcbiAgICAvLyBEb2Vzbid0IGxlYWQgdG8gdHJhbnNsYXRlVG8gY2FsbFxyXG4gICAgdmFyIHJ1bk1vZGUgPSBhYyA/IGdldFJ1bk1vZGUoYWMpIDogXCJSdW5uaW5nXCI7XHJcbiAgICB2YXIgaGVhbHRoUGVyY2VudGFnZSA9IGFjICYmIGFjLmdldEFjdG9yVmFsdWVQZXJjZW50YWdlKFwiaGVhbHRoXCIpO1xyXG4gICAgaWYgKGFjICYmIGFjLmlzRGVhZCgpKSB7XHJcbiAgICAgICAgaGVhbHRoUGVyY2VudGFnZSA9IDA7XHJcbiAgICB9XHJcbiAgICB2YXIgbG9va0F0ID0gdW5kZWZpbmVkO1xyXG4gICAgaWYgKHJlZnIuZ2V0Rm9ybUlEKCkgIT09IDB4MTQpIHtcclxuICAgICAgICB2YXIgY29tYmF0VGFyZ2V0ID0gYWMgPT09IG51bGwgfHwgYWMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjLmdldENvbWJhdFRhcmdldCgpO1xyXG4gICAgICAgIGlmIChjb21iYXRUYXJnZXQpIHtcclxuICAgICAgICAgICAgbG9va0F0ID0gW1xyXG4gICAgICAgICAgICAgICAgY29tYmF0VGFyZ2V0LmdldFBvc2l0aW9uWCgpLFxyXG4gICAgICAgICAgICAgICAgY29tYmF0VGFyZ2V0LmdldFBvc2l0aW9uWSgpLFxyXG4gICAgICAgICAgICAgICAgY29tYmF0VGFyZ2V0LmdldFBvc2l0aW9uWigpLFxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHZhciBwb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MocmVmcik7XHJcbiAgICB2YXIgc3BlZWQ7XHJcbiAgICBpZiAocmVmci5nZXRGb3JtSUQoKSAhPT0gMHgxNCkge1xyXG4gICAgICAgIHNwZWVkID0gcmVmci5nZXRBbmltYXRpb25WYXJpYWJsZUZsb2F0KFwiU3BlZWRTYW1wbGVkXCIpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgLy8gUmVhbCBwbGF5ZXJzIG9mdGVuIHJ1biBpbnRvIHRoZSB3YWxsLlxyXG4gICAgICAgIC8vIFdlIG5lZWQgdG8gaGF2ZSB6ZXJvIHNwZWVkIGluIHRoaXMgY2FzZS4gU3BlZWRTYW1wbGVkIGRvZXNuJ3QgaGVscFxyXG4gICAgICAgIHZhciB3ID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwocmVmcik7XHJcbiAgICAgICAgc3BlZWQgPSBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IuZ2V0U3BlZWQocG9zLCB3KTtcclxuICAgICAgICBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3Iuc2F2ZVBvc2l0aW9uKHBvcywgdyk7XHJcbiAgICAgICAgLy8gSXQncyB1bnJlYWxpc3RpYyBzcGVlZC4gSXQgc3RpbGwgbWF5IGhhcHBlbiBkdWUgdG8gdGVsZXBvcnRzXHJcbiAgICAgICAgaWYgKHNwZWVkID4gMjAwMCkge1xyXG4gICAgICAgICAgICBzcGVlZCA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdmFyIHdvcmxkT3JDZWxsID0gcmVmci5nZXRXb3JsZFNwYWNlKCkgfHwgcmVmci5nZXRQYXJlbnRDZWxsKCk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHdvcmxkT3JDZWxsOiAod29ybGRPckNlbGwgPT09IG51bGwgfHwgd29ybGRPckNlbGwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHdvcmxkT3JDZWxsLmdldEZvcm1JRCgpKSB8fCAwLFxyXG4gICAgICAgIHBvczogcG9zLFxyXG4gICAgICAgIHJvdDogW3JlZnIuZ2V0QW5nbGVYKCksIHJlZnIuZ2V0QW5nbGVZKCksIHJlZnIuZ2V0QW5nbGVaKCldLFxyXG4gICAgICAgIHJ1bk1vZGU6IHJ1bk1vZGUsXHJcbiAgICAgICAgZGlyZWN0aW9uOiBydW5Nb2RlICE9PSBcIlN0YW5kaW5nXCJcclxuICAgICAgICAgICAgPyAzNjAgKiByZWZyLmdldEFuaW1hdGlvblZhcmlhYmxlRmxvYXQoXCJEaXJlY3Rpb25cIilcclxuICAgICAgICAgICAgOiAwLFxyXG4gICAgICAgIGlzSW5KdW1wU3RhdGU6ICEhKGFjICYmIGFjLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcImJJbkp1bXBTdGF0ZVwiKSksXHJcbiAgICAgICAgaXNTbmVha2luZzogISEoYWMgJiYgaXNTbmVha2luZyhhYykpLFxyXG4gICAgICAgIGlzQmxvY2tpbmc6ICEhKGFjICYmIGFjLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzQmxvY2tpbmdcIikpLFxyXG4gICAgICAgIGlzV2VhcERyYXduOiAhIShhYyAmJiBhYy5pc1dlYXBvbkRyYXduKCkpLFxyXG4gICAgICAgIGlzRGVhZDogKChfYSA9IGZvcm0gPT09IG51bGwgfHwgZm9ybSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZm9ybS5pc0RlYWQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGZhbHNlKSB8fCAhIShhYyAmJiBhYy5pc0RlYWQoKSksXHJcbiAgICAgICAgaGVhbHRoUGVyY2VudGFnZTogaGVhbHRoUGVyY2VudGFnZSB8fCAwLFxyXG4gICAgICAgIGxvb2tBdDogbG9va0F0LFxyXG4gICAgICAgIHNwZWVkOiBzcGVlZFxyXG4gICAgfTtcclxufTtcclxudmFyIGlzU25lYWtpbmcgPSBmdW5jdGlvbiAoYWMpIHtcclxuICAgIHJldHVybiBhYy5pc1NuZWFraW5nKCkgfHwgYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNTbmVha2luZ1wiKTtcclxufTtcclxudmFyIGdldFJ1bk1vZGUgPSBmdW5jdGlvbiAoYWMpIHtcclxuICAgIGlmIChhYy5pc1NwcmludGluZygpKSB7XHJcbiAgICAgICAgcmV0dXJuIFwiU3ByaW50aW5nXCI7XHJcbiAgICB9XHJcbiAgICB2YXIgc3BlZWQgPSBhYy5nZXRBbmltYXRpb25WYXJpYWJsZUZsb2F0KFwiU3BlZWRTYW1wbGVkXCIpO1xyXG4gICAgaWYgKCFzcGVlZCkge1xyXG4gICAgICAgIHJldHVybiBcIlN0YW5kaW5nXCI7XHJcbiAgICB9XHJcbiAgICB2YXIgZnVybml0dXJlID0gYWMuZ2V0RnVybml0dXJlUmVmZXJlbmNlKCk7XHJcbiAgICBpZiAoZnVybml0dXJlICE9PSBudWxsKVxyXG4gICAgICAgIHJldHVybiBcIlN0YW5kaW5nXCI7IC8vIFRPRE86IFNpdHRpbmc/XHJcbiAgICB2YXIgaXNSdW5uaW5nID0gdHJ1ZTtcclxuICAgIGlmIChhYy5nZXRGb3JtSUQoKSA9PSAweDE0KSB7XHJcbiAgICAgICAgaWYgKCFURVNNb2RQbGF0Zm9ybS5pc1BsYXllclJ1bm5pbmdFbmFibGVkKCkgfHwgc3BlZWQgPCAxNTApXHJcbiAgICAgICAgICAgIGlzUnVubmluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgaWYgKCFhYy5pc1J1bm5pbmcoKSB8fCBzcGVlZCA8IDE1MCkge1xyXG4gICAgICAgICAgICBpc1J1bm5pbmcgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVGbG9hdChcIklzQmxvY2tpbmdcIikpIHtcclxuICAgICAgICBpc1J1bm5pbmcgPSBpc1NuZWFraW5nKGFjKTtcclxuICAgIH1cclxuICAgIHZhciBjYXJyeVdlaWdodCA9IGFjLmdldEFjdG9yVmFsdWUoXCJDYXJyeVdlaWdodFwiKTtcclxuICAgIHZhciB0b3RhbEl0ZW1XZWlnaHQgPSBhYy5nZXRUb3RhbEl0ZW1XZWlnaHQoKTtcclxuICAgIGlmIChjYXJyeVdlaWdodCA8IHRvdGFsSXRlbVdlaWdodCkge1xyXG4gICAgICAgIGlzUnVubmluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlzUnVubmluZyA/IFwiUnVubmluZ1wiIDogXCJXYWxraW5nXCI7XHJcbn07XHJcbiIsImltcG9ydCB7IEdhbWUsIFNwZWxsLCBwcmludENvbnNvbGUgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmV4cG9ydCB2YXIgcmVtb3ZlQWxsU3BlbGxzID0gZnVuY3Rpb24gKGFjdG9yKSB7XHJcbiAgICB2YXIgc3BlbGxUb1JlbW92ZSA9IG5ldyBBcnJheSgpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhY3Rvci5nZXRTcGVsbENvdW50KCk7IGkrKykge1xyXG4gICAgICAgIHZhciBzcGVsbCA9IGFjdG9yLmdldE50aFNwZWxsKGkpO1xyXG4gICAgICAgIGlmIChzcGVsbCkge1xyXG4gICAgICAgICAgICBzcGVsbFRvUmVtb3ZlLnB1c2goc3BlbGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGZvciAodmFyIF9pID0gMCwgc3BlbGxUb1JlbW92ZV8xID0gc3BlbGxUb1JlbW92ZTsgX2kgPCBzcGVsbFRvUmVtb3ZlXzEubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgdmFyIHNwZWxsID0gc3BlbGxUb1JlbW92ZV8xW19pXTtcclxuICAgICAgICB2YXIgcmVtb3ZlUmVzdWx0ID0gYWN0b3IucmVtb3ZlU3BlbGwoc3BlbGwpO1xyXG4gICAgICAgIHByaW50Q29uc29sZShcInJlbW92ZVJlc3VsdDogXCIuY29uY2F0KHJlbW92ZVJlc3VsdCwgXCIsIHNwZWxsSWRUb1JlbW92ZTogXCIpLmNvbmNhdChzcGVsbFxyXG4gICAgICAgICAgICAuZ2V0Rm9ybUlEKClcclxuICAgICAgICAgICAgLnRvU3RyaW5nKDE2KSwgXCIsIHNwZWxsTmFtZTogXCIpLmNvbmNhdChzcGVsbC5nZXROYW1lKCkpKTtcclxuICAgIH1cclxufTtcclxuZXhwb3J0IHZhciBsZWFyblNwZWxscyA9IGZ1bmN0aW9uIChhY3Rvciwgc3BlbGxzSWRzKSB7XHJcbiAgICBmb3IgKHZhciBfaSA9IDAsIHNwZWxsc0lkc18xID0gc3BlbGxzSWRzOyBfaSA8IHNwZWxsc0lkc18xLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgIHZhciBzcGVsbElkID0gc3BlbGxzSWRzXzFbX2ldO1xyXG4gICAgICAgIHZhciBzcGVsbCA9IFNwZWxsLmZyb20oR2FtZS5nZXRGb3JtRXgoc3BlbGxJZCkpO1xyXG4gICAgICAgIGlmIChzcGVsbCkge1xyXG4gICAgICAgICAgICB2YXIgYWRkUmVzdWx0ID0gYWN0b3IuYWRkU3BlbGwoc3BlbGwsIGZhbHNlKTtcclxuICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiYWRkUmVzdWx0OiBcIi5jb25jYXQoYWRkUmVzdWx0LCBcIiwgc3BlbGxJZFRvTGVhcm46IFwiKS5jb25jYXQoc3BlbGxcclxuICAgICAgICAgICAgICAgIC5nZXRGb3JtSUQoKVxyXG4gICAgICAgICAgICAgICAgLnRvU3RyaW5nKDE2KSwgXCIsIHNwZWxsTmFtZTogXCIpLmNvbmNhdChzcGVsbC5nZXROYW1lKCkpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn07XHJcbiIsImltcG9ydCB7IFV0aWxpdHksIERlYnVnLCBnZXRQbGF0Zm9ybVZlcnNpb24sIG9uLCBHYW1lLCBVaSB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuZXhwb3J0IHZhciByZXF1aXJlZFZlcnNpb24gPSAnMi45LjAnO1xyXG52YXIgcmVhbFZlcnNpb24gPSB0eXBlb2YgZ2V0UGxhdGZvcm1WZXJzaW9uID09PSAnZnVuY3Rpb24nID8gZ2V0UGxhdGZvcm1WZXJzaW9uKCkgOiAndW5rbm93bic7XHJcbi8vIFRPRE86IG5vIG9uZSBhY3R1YWxseSBjYWxscyB0aGlzIGZ1bmN0aW9uLiBtYWtlIGEgc2VydmljZVxyXG5leHBvcnQgdmFyIHZlcmlmeVZlcnNpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIXJlcXVpcmVkVmVyc2lvbi5pbmNsdWRlcyhyZWFsVmVyc2lvbikpIHtcclxuICAgICAgICBEZWJ1Zy5tZXNzYWdlQm94KFwiWW91IG5lZWQgdG8gaGF2ZSBvbiBvZiB0aG9zZSBTa3lyaW1QbGF0Zm9ybSB2ZXJzaW9ucyBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkocmVxdWlyZWRWZXJzaW9uKSwgXCIgdG8gam9pbiB0aGlzIHNlcnZlci4gWW91ciBjdXJyZW50IHZlcnNpb24gaXMgXCIpLmNvbmNhdChyZWFsVmVyc2lvbikpO1xyXG4gICAgICAgIFV0aWxpdHkud2FpdE1lbnVNb2RlKDAuNSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIG9uKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIVVpLmlzTWVudU9wZW4oJ01lc3NhZ2VCb3hNZW51JykpIHtcclxuICAgICAgICAgICAgICAgICAgICBHYW1lLnF1aXRUb01haW5NZW51KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59O1xyXG4iLCJpbXBvcnQgeyBBY3RvciwgQWN0b3JCYXNlLCBjcmVhdGVUZXh0LCBkZXN0cm95VGV4dCwgR2FtZSwgS2V5d29yZCwgTmV0SW1tZXJzZSwgT2JqZWN0UmVmZXJlbmNlLCBvbmNlLCBwcmludENvbnNvbGUsIHNldFRleHRQb3MsIHNldFRleHRTaXplLCBzZXRUZXh0U3RyaW5nLCBzdG9yYWdlLCBURVNNb2RQbGF0Zm9ybSwgVXRpbGl0eSwgd29ybGRQb2ludFRvU2NyZWVuUG9pbnQgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgc2V0RGVmYXVsdEFuaW1zRGlzYWJsZWQsIGFwcGx5QW5pbWF0aW9uIH0gZnJvbSBcIi4uL3N5bmMvYW5pbWF0aW9uXCI7XHJcbmltcG9ydCB7IGFwcGx5QXBwZWFyYW5jZSB9IGZyb20gXCIuLi9zeW5jL2FwcGVhcmFuY2VcIjtcclxuaW1wb3J0IHsgaXNCYWRNZW51U2hvd24sIGFwcGx5RXF1aXBtZW50IH0gZnJvbSBcIi4uL3N5bmMvZXF1aXBtZW50XCI7XHJcbmltcG9ydCB7IFJlc3Bhd25OZWVkZWRFcnJvciB9IGZyb20gXCIuLi9saWIvZXJyb3JzXCI7XHJcbmltcG9ydCB7IGFwcGx5TW92ZW1lbnQgfSBmcm9tIFwiLi4vc3luYy9tb3ZlbWVudEFwcGx5XCI7XHJcbmltcG9ydCB7IFNwYXduUHJvY2VzcyB9IGZyb20gXCIuL3NwYXduUHJvY2Vzc1wiO1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gXCIuLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4XCI7XHJcbmltcG9ydCB7IFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIgfSBmcm9tIFwiLi9wbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyXCI7XHJcbmltcG9ydCB7IGdldE1vdmVtZW50IH0gZnJvbSBcIi4uL3N5bmMvbW92ZW1lbnRHZXRcIjtcclxuaW1wb3J0IHsgbGFzdFRyeUhvc3QsIHRyeUhvc3QgfSBmcm9tIFwiLi9ob3N0QXR0ZW1wdHNcIjtcclxuaW1wb3J0IHsgTW9kZWxBcHBseVV0aWxzIH0gZnJvbSBcIi4vbW9kZWxBcHBseVV0aWxzXCI7XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkIH0gZnJvbSBcIi4vd29ybGRWaWV3TWlzY1wiO1xyXG5pbXBvcnQgeyBTcEFwaUludGVyYWN0b3IgfSBmcm9tIFwiLi4vc2VydmljZXMvc3BBcGlJbnRlcmFjdG9yXCI7XHJcbmltcG9ydCB7IFdvcmxkQ2xlYW5lclNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvc2VydmljZXMvd29ybGRDbGVhbmVyU2VydmljZVwiO1xyXG5pbXBvcnQgeyBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvc2VydmljZXMvZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlXCI7XHJcbnZhciBfc2NyZWVuUmVzb2x1dGlvbjtcclxuZXhwb3J0IHZhciBnZXRTY3JlZW5SZXNvbHV0aW9uID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCFfc2NyZWVuUmVzb2x1dGlvbikge1xyXG4gICAgICAgIF9zY3JlZW5SZXNvbHV0aW9uID0ge1xyXG4gICAgICAgICAgICB3aWR0aDogVXRpbGl0eS5nZXRJTklJbnQoXCJpU2l6ZSBXOkRpc3BsYXlcIiksXHJcbiAgICAgICAgICAgIGhlaWdodDogVXRpbGl0eS5nZXRJTklJbnQoXCJpU2l6ZSBIOkRpc3BsYXlcIiksXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHJldHVybiBfc2NyZWVuUmVzb2x1dGlvbjtcclxufTtcclxudmFyIEZvcm1WaWV3ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gRm9ybVZpZXcocmVtb3RlUmVmcklkKSB7XHJcbiAgICAgICAgdGhpcy5yZW1vdGVSZWZySWQgPSByZW1vdGVSZWZySWQ7XHJcbiAgICAgICAgdGhpcy5sYXN0SGFydmVzdGVkQXBwbHkgPSAwO1xyXG4gICAgICAgIHRoaXMubGFzdE9wZW5BcHBseSA9IDA7XHJcbiAgICAgICAgdGhpcy5pc1NldE5vZGVUZXh0dXJlU2V0QXBwbGllZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuaXNTZXROb2RlU2NhbGVBcHBsaWVkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yZWZySWQgPSAwO1xyXG4gICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmFuaW1TdGF0ZSA9IHRoaXMuZ2V0RGVmYXVsdEFuaW1TdGF0ZSgpO1xyXG4gICAgICAgIHRoaXMubW92U3RhdGUgPSB7XHJcbiAgICAgICAgICAgIGxhc3ROdW1DaGFuZ2VzOiAwLFxyXG4gICAgICAgICAgICBsYXN0QXBwbHk6IDAsXHJcbiAgICAgICAgICAgIGxhc3RSZWhvc3Q6IDAsXHJcbiAgICAgICAgICAgIGV2ZXJBcHBsaWVkOiBmYWxzZSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuYXBwZWFyYW5jZVN0YXRlID0gdGhpcy5nZXREZWZhdWx0QXBwZWFyYW5jZVN0YXRlKCk7XHJcbiAgICAgICAgdGhpcy5lcVN0YXRlID0gdGhpcy5nZXREZWZhdWx0RXF1aXBTdGF0ZSgpO1xyXG4gICAgICAgIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkID0gMDtcclxuICAgICAgICB0aGlzLmxldmVsZWRCYXNlSWQgPSAwO1xyXG4gICAgICAgIHRoaXMuaXNPblNjcmVlbiA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMubGFzdFBjV29ybGRPckNlbGwgPSAwO1xyXG4gICAgICAgIHRoaXMubGFzdFdvcmxkT3JDZWxsID0gMDtcclxuICAgICAgICB0aGlzLnNwYXduTW9tZW50ID0gMDtcclxuICAgICAgICB0aGlzLndhc0hvc3RlZEJ5T3RoZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHt9O1xyXG4gICAgICAgIHRoaXMubG9jYWxJbW1vcnRhbCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMudGV4dE5hbWVJZCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLnZvaWNlSW5kaWNhdG9ySWQgPSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKG1vZGVsKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2csIF9oO1xyXG4gICAgICAgIC8vIE90aGVyIHBsYXllcnMgbXV0YXRlIGludG8gUEMgY2xvbmVzIHdoZW4gbW92aW5nIHRvIGFub3RoZXIgbG9jYXRpb25cclxuICAgICAgICBpZiAobW9kZWwubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmxhc3RXb3JsZE9yQ2VsbClcclxuICAgICAgICAgICAgICAgIHRoaXMubGFzdFdvcmxkT3JDZWxsID0gbW9kZWwubW92ZW1lbnQud29ybGRPckNlbGw7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxhc3RXb3JsZE9yQ2VsbCAhPT0gbW9kZWwubW92ZW1lbnQud29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlsxXSB3b3JsZE9yQ2VsbCBjaGFuZ2VkLCBkZXN0cm95aW5nIEZvcm1WaWV3IFwiLmNvbmNhdCh0aGlzLmxhc3RXb3JsZE9yQ2VsbC50b1N0cmluZygxNiksIFwiID0+IFwiKS5jb25jYXQobW9kZWwubW92ZW1lbnQud29ybGRPckNlbGwudG9TdHJpbmcoMTYpKSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RXb3JsZE9yQ2VsbCA9IG1vZGVsLm1vdmVtZW50LndvcmxkT3JDZWxsO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gRG9uJ3Qgc3Bhd24gZGVhZCBhY3RvcnMgaWYgbm90IGFscmVhZHlcclxuICAgICAgICBpZiAobW9kZWwuaXNEZWFkKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnJlZnJJZCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFBsYXllcnMgd2l0aCBkaWZmZXJlbnQgd29ybGRPckNlbGwgc2hvdWxkIGJlIGludmlzaWJsZVxyXG4gICAgICAgIGlmIChtb2RlbC5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICB2YXIgd29ybGRPckNlbGwgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbChHYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICAgICAgaWYgKHdvcmxkT3JDZWxsICE9PSAwICYmXHJcbiAgICAgICAgICAgICAgICBtb2RlbC5tb3ZlbWVudC53b3JsZE9yQ2VsbCAhPT0gd29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZySWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEFwcGx5IGFwcGVhcmFuY2UgYmVmb3JlIGJhc2UgZm9ybSBzZWxlY3Rpb24gdG8gcHJldmVudCBkb3VibGUtc3Bhd25cclxuICAgICAgICBpZiAobW9kZWwuYXBwZWFyYW5jZSB8fCAoIW1vZGVsLmFwcGVhcmFuY2UgJiYgdGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSkpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlIHx8XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5udW1BcHBlYXJhbmNlQ2hhbmdlcyAhPT0gdGhpcy5hcHBlYXJhbmNlU3RhdGUubGFzdE51bUNoYW5nZXMpIHtcclxuICAgICAgICAgICAgICAgIC8vIEJvdGggbm9uLW51bGxcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbC5hcHBlYXJhbmNlICYmIHRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbW9kZWxBcHBlYXJhbmNlQ29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkobW9kZWwuYXBwZWFyYW5jZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZUFwcGVhcmFuY2VDb3B5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbW9kZWxBcHBlYXJhbmNlQ29weS5uYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZUFwcGVhcmFuY2VDb3B5Lm5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBlcXVhbFdpdGhvdXROYW1lcyA9IEpTT04uc3RyaW5naWZ5KG1vZGVsQXBwZWFyYW5jZUNvcHkpID09PSBKU09OLnN0cmluZ2lmeShzdGF0ZUFwcGVhcmFuY2VDb3B5KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXF1YWxXaXRob3V0TmFtZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hhbmdlIG5hbWUgaW5wbGFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmcl8xID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgodGhpcy5yZWZySWQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgKF9hID0gcmVmcl8xID09PSBudWxsIHx8IHJlZnJfMSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmcl8xLmdldEJhc2VPYmplY3QoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldE5hbWUobW9kZWwuYXBwZWFyYW5jZS5uYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmcl8xID09PSBudWxsIHx8IHJlZnJfMSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmcl8xLnNldERpc3BsYXlOYW1lKG1vZGVsLmFwcGVhcmFuY2UubmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vcHJpbnRDb25zb2xlKFwiQXBwZWFyYW5jZSB1cGRhdGVkLCBjaGFuZ2luZyBuYW1lIGlucGxhY2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSByZS1hcHBseSBhcHBlYXJhbmNlIG9uIHRoZSBuZXh0IGdldEFwcGVhcmFuY2VCYXNlZEJhc2UgY2FsbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vcHJpbnRDb25zb2xlKFwiQXBwZWFyYW5jZSB1cGRhdGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEZvcmNlIHJlLWFwcGx5IGFwcGVhcmFuY2Ugb24gdGhlIG5leHQgZ2V0QXBwZWFyYW5jZUJhc2VkQmFzZSBjYWxsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vcHJpbnRDb25zb2xlKFwiQXBwZWFyYW5jZSB1cGRhdGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSA9IG1vZGVsLmFwcGVhcmFuY2UgfHwgbnVsbDtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZVN0YXRlLmxhc3ROdW1DaGFuZ2VzID0gbW9kZWwubnVtQXBwZWFyYW5jZUNoYW5nZXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHJlZklkID0gbW9kZWwucmVmcklkICYmIG1vZGVsLnJlZnJJZCA8IDB4ZmYwMDAwMDAgPyBtb2RlbC5yZWZySWQgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgaWYgKHJlZklkKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnJlZnJJZCAhPT0gcmVmSWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZySWQgPSBtb2RlbC5yZWZySWQ7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHZhciByZWZyXzIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeCh0aGlzLnJlZnJJZCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnJfMikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiYXNlID0gcmVmcl8yLmdldEJhc2VPYmplY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYmFzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBPYmplY3RSZWZlcmVuY2VFeC5kZWFsV2l0aFJlZihyZWZyXzIsIGJhc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdmFyIHRlbXBsYXRlQ2hhaW4gPSBtb2RlbC50ZW1wbGF0ZUNoYWluO1xyXG4gICAgICAgICAgICAvLyBUaGVyZSBpcyBubyBwbGFjZSBmb3IgcmFuZG9tL2xldmVsaW5nIGluIDEtc2l6ZWQgY2hhaW5cclxuICAgICAgICAgICAgLy8gSnVzdCBzcGF3biBhbiBOUEMsIGRvIG5vdCBnZW5lcmF0ZSBhIHRlbXBvcmFyeSBURVNOUEMgZm9ybVxyXG4gICAgICAgICAgICBpZiAoKHRlbXBsYXRlQ2hhaW4gPT09IG51bGwgfHwgdGVtcGxhdGVDaGFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGVtcGxhdGVDaGFpbi5sZW5ndGgpID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUNoYWluID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIFRPRE86IGdldExldmVsZWRCYXNlIGNyYXNoZXMgdG9vIG9mdGVuIEFUTVxyXG4gICAgICAgICAgICB2YXIgYmFzZSA9IG51bGw7IC8vR2FtZS5nZXRGb3JtRXgodGhpcy5nZXRMZXZlbGVkQmFzZSh0ZW1wbGF0ZUNoYWluKSk7XHJcbiAgICAgICAgICAgIGlmIChiYXNlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBiYXNlID0gR2FtZS5nZXRGb3JtRXgobW9kZWwuYmFzZUlkIHx8IE5hTik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGJhc2UgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGJhc2UgPSBHYW1lLmdldEZvcm1FeCh0aGlzLmdldEFwcGVhcmFuY2VCYXNlZEJhc2UoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGJhc2UgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgcmVmcl8zID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgodGhpcy5yZWZySWQpKTtcclxuICAgICAgICAgICAgdmFyIHJlc3Bhd25SZXF1aXJlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBpZiAoIXJlZnJfMykge1xyXG4gICAgICAgICAgICAgICAgcmVzcGF3blJlcXVpcmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICghcmVmcl8zLmdldEJhc2VPYmplY3QoKSkge1xyXG4gICAgICAgICAgICAgICAgcmVzcGF3blJlcXVpcmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChyZWZyXzMuZ2V0QmFzZU9iamVjdCgpLmdldEZvcm1JRCgpICE9PSBiYXNlLmdldEZvcm1JRCgpKSB7XHJcbiAgICAgICAgICAgICAgICByZXNwYXduUmVxdWlyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChyZXNwYXduUmVxdWlyZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHBsYXllcl8xID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgICAgIHZhciBzcGF3bk1ldGhvZE9yaWdpbmFsID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwYXduOiBmdW5jdGlvbiAoYmFzZUZvcm0sIF9zcGF3blBvc2l0aW9uLCBfc3Bhd25Sb3RhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxheWVyXzEucGxhY2VBdE1lKGJhc2VGb3JtLCAxLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHRyaWdnZXJTcGF3blByb2Nlc3M6IGZ1bmN0aW9uIChzcGF3bmluZ1JlZnIsIHNwYXduUG9zaXRpb24sIGFwcGVhcmFuY2UsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBTcGF3blByb2Nlc3MoYXBwZWFyYW5jZSwgc3Bhd25Qb3NpdGlvbiwgc3Bhd25pbmdSZWZyLmdldEZvcm1JRCgpLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHZhciBzcGF3bk1ldGhvZFN0dWIgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3Bhd246IGZ1bmN0aW9uIChiYXNlRm9ybSwgc3Bhd25Qb3NpdGlvbiwgc3Bhd25Sb3RhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZiA9IHN0b3JhZ2VbXCJmb3JtVmlld0Z1bmMxXCJdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gZihiYXNlRm9ybSwgc3Bhd25Qb3NpdGlvbiwgc3Bhd25Sb3RhdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWY7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyU3Bhd25Qcm9jZXNzOiBmdW5jdGlvbiAoc3Bhd25pbmdSZWZyLCBzcGF3blBvc2l0aW9uLCBhcHBlYXJhbmNlLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZiA9IHN0b3JhZ2VbXCJmb3JtVmlld0Z1bmMyXCJdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmKHNwYXduaW5nUmVmciwgc3Bhd25Qb3NpdGlvbiwgYXBwZWFyYW5jZSwgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB2YXIgc3Bhd25Vc2luZ1N0dWJNZXRob2QgPSBiYXNlLmdldFR5cGUoKSA9PT0gNDMgLyogRm9ybVR5cGUuTlBDICovXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgIXRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2VcclxuICAgICAgICAgICAgICAgICAgICAmJiBzdG9yYWdlW1wiZm9ybVZpZXdGdW5jMVNldFwiXSA9PT0gdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICYmIHN0b3JhZ2VbXCJmb3JtVmlld0Z1bmMyU2V0XCJdID09PSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwYXduTWV0aG9kID0gc3Bhd25Vc2luZ1N0dWJNZXRob2QgPyBzcGF3bk1ldGhvZFN0dWIgOiBzcGF3bk1ldGhvZE9yaWdpbmFsO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGVsLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmcl8zID0gc3Bhd25NZXRob2Quc3Bhd24oYmFzZSwgbW9kZWwubW92ZW1lbnQucG9zLCBtb2RlbC5tb3ZlbWVudC5yb3QpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwibW9kZWwubW92ZW1lbnQgd2FzIFwiICsgbW9kZWwubW92ZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMud2FzSG9zdGVkQnlPdGhlcjtcclxuICAgICAgICAgICAgICAgIGlmIChiYXNlLmdldFR5cGUoKSAhPT0gNDMgLyogRm9ybVR5cGUuTlBDICovKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmcl8zID09PSBudWxsIHx8IHJlZnJfMyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmcl8zLnNldEFuZ2xlKCgoX2IgPSBtb2RlbC5tb3ZlbWVudCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJvdFswXSkgfHwgMCwgKChfYyA9IG1vZGVsLm1vdmVtZW50KSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Mucm90WzFdKSB8fCAwLCAoKF9kID0gbW9kZWwubW92ZW1lbnQpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5yb3RbMl0pIHx8IDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhY2UgPSAoX2YgPSAoX2UgPSBBY3Rvci5mcm9tKHJlZnJfMykpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS5nZXRSYWNlKCkpID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZHJhdWdyUmFjZSA9IDB4ZDUzO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmYWxtZXJSYWNlID0gMHgxMzFmNDtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2hhdXJ1c1JhY2UgPSAweDEzMWViO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmcm9zdGJpdGVTcGlkZXJSYWNlR2lhbnQgPSAweDRlNTA3O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmcm9zdGJpdGVTcGlkZXJSYWNlTGFyZ2UgPSAweDUzNDc3O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkd2FydmVuQ2VudHVyaW9uUmFjZSA9IDB4MTMxZjE7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGR3YXJ2ZW5TcGhlcmVSYWNlID0gMHgxMzFmMjtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZHdhcnZlblNwaWRlclJhY2UgPSAweDEzMWYzO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcHJpZ2dhblJhY2UgPSAweDIwMTNiNzc7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwcmlnZ2FuUmFjZTIgPSAweGYzOTAzO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcHJpZ2dhblJhY2UzID0gMHgxMzIwNDtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3ByaWdnYW5SYWNlNCA9IDB4NDAxYjY0NDtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3ByaWdnYW5SYWNlNSA9IDB4OWFhNDQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvbGZSYWNlID0gMHgxMzIwYTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBwb3RlbnRpYWwgbWFzdGVyYW1idXNoc2NyaXB0XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhY2UgPT09IGRyYXVnclJhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gZmFsbWVyUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBjaGF1cnVzUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBmcm9zdGJpdGVTcGlkZXJSYWNlR2lhbnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gZnJvc3RiaXRlU3BpZGVyUmFjZUxhcmdlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGR3YXJ2ZW5DZW50dXJpb25SYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGR3YXJ2ZW5TcGhlcmVSYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGR3YXJ2ZW5TcGlkZXJSYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IHNwcmlnZ2FuUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBzcHJpZ2dhblJhY2UyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IHNwcmlnZ2FuUmFjZTNcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gc3ByaWdnYW5SYWNlNFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBzcHJpZ2dhblJhY2U1XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IHdvbGZSYWNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChfZyA9IEFjdG9yLmZyb20ocmVmcl8zKSkgPT09IG51bGwgfHwgX2cgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9nLnNldEFjdG9yVmFsdWUoXCJBZ2dyZXNzaW9uXCIsIDIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChyZWZyXzMgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkubG9va3VwTGlzdGVuZXIoV29ybGRDbGVhbmVyU2VydmljZSkubW9kV2NQcm90ZWN0aW9uKHJlZnJfMy5nZXRGb3JtSUQoKSwgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiByZXNldCBhbGwgc3RhdGVzP1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lcVN0YXRlID0gdGhpcy5nZXREZWZhdWx0RXF1aXBTdGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hbmltU3RhdGUgPSB0aGlzLmdldERlZmF1bHRBbmltU3RhdGUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHZhciBzcGF3blBvcyA9IHZvaWQgMDtcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbC5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwYXduUG9zID0gbW9kZWwubW92ZW1lbnQucG9zO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHByaW50Q29uc29sZShcIlNwYXduIE5QQyBhdCBtb3ZlbWVudC5wb3NcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzcGF3blBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhHYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJTcGF3biBOUEMgYXQgcGxheWVyIHBvc1wiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChyZWZyXzMpIHtcclxuICAgICAgICAgICAgICAgICAgICBzcGF3bk1ldGhvZC50cmlnZ2VyU3Bhd25Qcm9jZXNzKHJlZnJfMywgc3Bhd25Qb3MsIG1vZGVsLmFwcGVhcmFuY2UgfHwgbnVsbCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZWFkeSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNwYXduTW9tZW50ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIlVuYWJsZSB0byB0cmlnZ2VyU3Bhd25Qcm9jZXNzIGZvciBudWxsIHJlZnJcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZWwuYXBwZWFyYW5jZSAmJiBtb2RlbC5hcHBlYXJhbmNlLm5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyXzMgPT09IG51bGwgfHwgcmVmcl8zID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZWZyXzMuc2V0RGlzcGxheU5hbWUoXCJcIiArIG1vZGVsLmFwcGVhcmFuY2UubmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAoX2ggPSBBY3Rvci5mcm9tKHJlZnJfMykpID09PSBudWxsIHx8IF9oID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfaC5zZXRBY3RvclZhbHVlKFwiYXR0YWNrRGFtYWdlTXVsdFwiLCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnJlZnJJZCA9IHJlZnJfMy5nZXRGb3JtSUQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeCh0aGlzLnJlZnJJZCkpO1xyXG4gICAgICAgIGlmIChyZWZyKSB7XHJcbiAgICAgICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgIGlmIChhY3RvciAmJiAhdGhpcy5sb2NhbEltbW9ydGFsKSB7XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5zdGFydERlZmVycmVkS2lsbCgpO1xyXG4gICAgICAgICAgICAgICAgYWN0b3Iuc2V0QWN0b3JWYWx1ZShcImhlYWx0aFwiLCAxMDAwMDAwKTtcclxuICAgICAgICAgICAgICAgIGFjdG9yLnNldEFjdG9yVmFsdWUoXCJtYWdpY2thXCIsIDEwMDAwMDApO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2NhbEltbW9ydGFsID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmFwcGx5QWxsKHJlZnIsIG1vZGVsKTtcclxuICAgICAgICAgICAgdmFyIGdhbWVtb2RlVXBkYXRlU2VydmljZSA9IFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5sb29rdXBMaXN0ZW5lcihHYW1lbW9kZVVwZGF0ZVNlcnZpY2UpO1xyXG4gICAgICAgICAgICBnYW1lbW9kZVVwZGF0ZVNlcnZpY2UudXBkYXRlTmVpZ2hib3IocmVmciwgbW9kZWwsIHRoaXMuc3RhdGUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLmlzT25TY3JlZW4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnNwYXduTW9tZW50ID0gMDtcclxuICAgICAgICB2YXIgcmVmcklkID0gdGhpcy5yZWZySWQ7XHJcbiAgICAgICAgb25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChyZWZySWQgPj0gMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZWZyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmci5kZWxldGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5sb29rdXBMaXN0ZW5lcihXb3JsZENsZWFuZXJTZXJ2aWNlKS5tb2RXY1Byb3RlY3Rpb24ocmVmcklkLCAtMSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVEVTTW9kUGxhdGZvcm0uc2V0V2VhcG9uRHJhd25Nb2RlKGFjLCAtMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmxvY2FsSW1tb3J0YWwgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnJlbW92ZU5pY2tuYW1lKCk7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmFwcGx5QWxsID0gZnVuY3Rpb24gKHJlZnIsIG1vZGVsKSB7XHJcbiAgICAgICAgdmFyIF9hLCBfYiwgX2M7XHJcbiAgICAgICAgdmFyIGZvcmNlZFdlYXBEcmF3biA9IG51bGw7XHJcbiAgICAgICAgaWYgKFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0Q3Jvc3NoYWlyUmVmSWQoKSA9PT0gdGhpcy5yZWZySWQpIHtcclxuICAgICAgICAgICAgdGhpcy5sYXN0SGFydmVzdGVkQXBwbHkgPSAwO1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RPcGVuQXBwbHkgPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBpZiAobm93IC0gdGhpcy5sYXN0SGFydmVzdGVkQXBwbHkgPiA2NjYpIHtcclxuICAgICAgICAgICAgdGhpcy5sYXN0SGFydmVzdGVkQXBwbHkgPSBub3c7XHJcbiAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNIYXJ2ZXN0ZWQocmVmciwgISFtb2RlbC5pc0hhcnZlc3RlZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChub3cgLSB0aGlzLmxhc3RPcGVuQXBwbHkgPiAxMzMpIHtcclxuICAgICAgICAgICAgdGhpcy5sYXN0T3BlbkFwcGx5ID0gbm93O1xyXG4gICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzT3BlbihyZWZyLCAhIW1vZGVsLmlzT3Blbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5pc1NldE5vZGVTY2FsZUFwcGxpZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pc1NldE5vZGVTY2FsZUFwcGxpZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbE5vZGVTY2FsZShyZWZyLCBtb2RlbC5zZXROb2RlU2NhbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuaXNTZXROb2RlVGV4dHVyZVNldEFwcGxpZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pc1NldE5vZGVUZXh0dXJlU2V0QXBwbGllZCA9IHRydWU7XHJcbiAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsTm9kZVRleHR1cmVTZXQocmVmciwgbW9kZWwuc2V0Tm9kZVRleHR1cmVTZXQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWwuaW52ZW50b3J5ICYmXHJcbiAgICAgICAgICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0Q3Jvc3NoYWlyUmVmSWQoKSA9PSB0aGlzLnJlZnJJZCAmJlxyXG4gICAgICAgICAgICAhaXNCYWRNZW51U2hvd24oKSkge1xyXG4gICAgICAgICAgICAvLyBEbyBub3QgbGV0IGFjdG9ycyBicmVha2luZyB0aGVpciBlcXVpcG1lbnQgdmlhIGludmVudG9yeSBhcHBseVxyXG4gICAgICAgICAgICAvLyBIb3dldmVyLCBhY3R1YWxseSwgYWN0b3JzIGRvIG5vdCBoYXZlIGludmVudG9yeSBpbiB0aGVpciBtb2RlbHNcclxuICAgICAgICAgICAgLy8gRXhjZXB0IHlvdXIgY2xvbmUuXHJcbiAgICAgICAgICAgIGlmICghQWN0b3IuZnJvbShyZWZyKSkge1xyXG4gICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJbnZlbnRvcnkocmVmciwgbW9kZWwuaW52ZW50b3J5KTtcclxuICAgICAgICAgICAgICAgIG1vZGVsLmludmVudG9yeSA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWwuYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgIGlmIChtb2RlbC5hbmltYXRpb24uYW5pbUV2ZW50TmFtZSA9PT0gXCJTa3ltcEZha2VVbmVxdWlwXCIpIHtcclxuICAgICAgICAgICAgICAgIGZvcmNlZFdlYXBEcmF3biA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKG1vZGVsLmFuaW1hdGlvbi5hbmltRXZlbnROYW1lID09PSBcIlNreW1wRmFrZUVxdWlwXCIpIHtcclxuICAgICAgICAgICAgICAgIGZvcmNlZFdlYXBEcmF3biA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gVE9ETzogbWFrZSBob3N0IHNlcnZpY2VcclxuICAgICAgICB2YXIgaG9zdGVkID0gc3RvcmFnZVsnaG9zdGVkJ107XHJcbiAgICAgICAgdmFyIGFscmVhZHlIb3N0ZWQgPSBmYWxzZTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShob3N0ZWQpKSB7XHJcbiAgICAgICAgICAgIHZhciByZW1vdGVJZCA9IGxvY2FsSWRUb1JlbW90ZUlkKHRoaXMucmVmcklkKTtcclxuICAgICAgICAgICAgaWYgKGhvc3RlZC5pbmNsdWRlcyhyZW1vdGVJZCkgfHwgaG9zdGVkLmluY2x1ZGVzKHJlbW90ZUlkICsgMHgxMDAwMDAwMDApKSB7XHJcbiAgICAgICAgICAgICAgICBhbHJlYWR5SG9zdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBzZXREZWZhdWx0QW5pbXNEaXNhYmxlZCh0aGlzLnJlZnJJZCwgYWxyZWFkeUhvc3RlZCA/IGZhbHNlIDogdHJ1ZSk7XHJcbiAgICAgICAgaWYgKGFscmVhZHlIb3N0ZWQpIHtcclxuICAgICAgICAgICAgKF9hID0gQWN0b3IuZnJvbShyZWZyKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsZWFyS2VlcE9mZnNldEZyb21BY3RvcigpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWwubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMubW92U3RhdGUubGFzdEFwcGx5ICYmXHJcbiAgICAgICAgICAgICAgICBEYXRlLm5vdygpIC0gdGhpcy5tb3ZTdGF0ZS5sYXN0QXBwbHkgPiAxNTAwKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHRoaXMubW92U3RhdGUubGFzdFJlaG9zdCA+IDEwMDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdlN0YXRlLmxhc3RSZWhvc3QgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciByZW1vdGVJZCA9IHRoaXMucmVtb3RlUmVmcklkO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhYyAmJiBhYy5pczNETG9hZGVkKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cnlIb3N0SWZOZWVkKGFjLCByZW1vdGVJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcInRyeUhvc3RJZk5lZWQgLSByZWFzb246IG5vdCBzZWVpbmcgbW92ZW1lbnQgZm9yIGxvbmcgdGltZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCttb2RlbC5udW1Nb3ZlbWVudENoYW5nZXMgIT09XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1vdlN0YXRlLmxhc3ROdW1DaGFuZ2VzIHx8XHJcbiAgICAgICAgICAgICAgICBEYXRlLm5vdygpIC0gdGhpcy5tb3ZTdGF0ZS5sYXN0QXBwbHkgPiAyMDAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1vdlN0YXRlLmxhc3RBcHBseSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZWwuaXNIb3N0ZWRCeU90aGVyIHx8ICF0aGlzLm1vdlN0YXRlLmV2ZXJBcHBsaWVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJhY2t1cCA9IG1vZGVsLm1vdmVtZW50LmlzV2VhcERyYXduO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JjZWRXZWFwRHJhd24gPT09IHRydWUgfHwgZm9yY2VkV2VhcERyYXduID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5tb3ZlbWVudC5pc1dlYXBEcmF3biA9IGZvcmNlZFdlYXBEcmF3bjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHlNb3ZlbWVudChyZWZyLCBtb2RlbC5tb3ZlbWVudCwgISFtb2RlbC5pc015Q2xvbmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFJlc3Bhd25OZWVkZWRFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0V29ybGRPckNlbGwgPSBtb2RlbC5tb3ZlbWVudC53b3JsZE9yQ2VsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZySWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBtb2RlbC5tb3ZlbWVudC5pc1dlYXBEcmF3biA9IGJhY2t1cDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdlN0YXRlLmxhc3ROdW1DaGFuZ2VzID0gK21vZGVsLm51bU1vdmVtZW50Q2hhbmdlcztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdlN0YXRlLmV2ZXJBcHBsaWVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciByZW1vdGVJZCA9IHRoaXMucmVtb3RlUmVmcklkO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhYyAmJiByZW1vdGVJZCAmJiBhYy5pczNETG9hZGVkKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWMuY2xlYXJLZWVwT2Zmc2V0RnJvbUFjdG9yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IG1ha2UgaG9zdCBzZXJ2aWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBob3N0ZWRfMSA9IHN0b3JhZ2VbJ2hvc3RlZCddO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWxyZWFkeUhvc3RlZF8xID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvc3RlZF8xKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW90ZUlkXzEgPSBsb2NhbElkVG9SZW1vdGVJZChhYy5nZXRGb3JtSUQoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaG9zdGVkXzEuaW5jbHVkZXMocmVtb3RlSWRfMSkgfHwgaG9zdGVkXzEuaW5jbHVkZXMocmVtb3RlSWRfMSArIDB4MTAwMDAwMDAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFscmVhZHlIb3N0ZWRfMSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhbHJlYWR5SG9zdGVkXzEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRyeUhvc3RJZk5lZWQoYWMsIHJlbW90ZUlkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXZpb3VzbHksIHdlIGRpZCB0aGlzIGNsZWFudXAgb24gZWFjaCB1cGRhdGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBidXQgSSBndWVzcyBpdCdzIHRvbyBleHBlbnNpdmUgYW5kIGNhbiBwb3NzaWJseSBodXJ0IEZQU1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRFU01vZFBsYXRmb3JtLnNldFdlYXBvbkRyYXduTW9kZShhYywgLTEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyZWZyLmlzM0RMb2FkZWQoKSkge1xyXG4gICAgICAgICAgICBpZiAobW9kZWwuYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBhcHBseUFuaW1hdGlvbihyZWZyLCBtb2RlbC5hbmltYXRpb24sIHRoaXMuYW5pbVN0YXRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBVc2UgdGhlbSBvbmx5IG9uY2UsIGZvciBzcGF3bmluZyBhY3RvcnMgd2l0aCBjb3JyZWN0IGFuaW1hdGlvbnNcclxuICAgICAgICAgICAgdGhpcy5hbmltU3RhdGUudXNlQW5pbU92ZXJyaWRlcyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWwuYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAoYWN0b3IgJiYgIVBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuaXNJbkp1bXBTdGF0ZSgpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRXb3JsZE9yQ2VsbCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGFzdFBjV29ybGRPckNlbGwgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRXb3JsZE9yQ2VsbCgpICE9PSB0aGlzLmxhc3RQY1dvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZHJhdyB0aW50cyBpZiBQQyB3b3JsZC9jZWxsIGNoYW5nZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc09uU2NyZWVuID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFBjV29ybGRPckNlbGwgPSBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldFdvcmxkT3JDZWxsKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgaGVhZFBvcyA9IFtcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLmdldE5vZGVXb3JsZFBvc2l0aW9uWChhY3RvciwgXCJOUEMgSGVhZCBbSGVhZF1cIiwgZmFsc2UpLFxyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2UuZ2V0Tm9kZVdvcmxkUG9zaXRpb25ZKGFjdG9yLCBcIk5QQyBIZWFkIFtIZWFkXVwiLCBmYWxzZSksXHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5nZXROb2RlV29ybGRQb3NpdGlvblooYWN0b3IsIFwiTlBDIEhlYWQgW0hlYWRdXCIsIGZhbHNlKSxcclxuICAgICAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgICAgICB2YXIgc2NyZWVuUG9pbnQgPSB3b3JsZFBvaW50VG9TY3JlZW5Qb2ludChoZWFkUG9zKVswXTtcclxuICAgICAgICAgICAgICAgIHZhciBpc09uU2NyZWVuID0gc2NyZWVuUG9pbnRbMF0gPiAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuUG9pbnRbMV0gPiAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuUG9pbnRbMl0gPiAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuUG9pbnRbMF0gPCAxICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuUG9pbnRbMV0gPCAxICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuUG9pbnRbMl0gPCAxO1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzT25TY3JlZW4gIT0gdGhpcy5pc09uU2NyZWVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc09uU2NyZWVuID0gaXNPblNjcmVlbjtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNPblNjcmVlbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rvci5xdWV1ZU5pTm9kZVVwZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBHYW1lLmdldFBsYXllcigpLnF1ZXVlTmlOb2RlVXBkYXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbC5lcXVpcG1lbnQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZXFTdGF0ZS5sYXN0TnVtQ2hhbmdlcyAhPT0gbW9kZWwuZXF1aXBtZW50Lm51bUNoYW5nZXMpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgICAgICAvLyBJZiB3ZSBkbyBub3QgYmxvY2sgaW52ZW50b3J5IGhlcmUsIHdlIHdpbGwgYmUgYWJsZSB0byByZXByb2R1Y2UgdGhlIGJ1ZzpcclxuICAgICAgICAgICAgICAgIC8vIDEuIFBsYWNlIH45MCBib3RzIGFuZCBmb3JjZSB0aGVtIHRvIHJlZXF1aXAgaXJvbiBzd29yZHMgdG8gdGhlIGxlZnQgaGFuZCAocmF0ZSBzaG91bGQgYmUgfjUwbXMpXHJcbiAgICAgICAgICAgICAgICAvLyAyLiBPcGVuIHlvdXIgaW52ZW50b3J5IGFuZCByZWVxdWlwIGRpZmZlcmVudCBpdGVtcyBmYXN0XHJcbiAgICAgICAgICAgICAgICAvLyAzLiBBZnRlciAxLTIgbWludXRlcyBjbG9zZSB5b3VyIGludmVudG9yeSBhbmQgc2VlIHRoYXQgSFVEIGRpc2FwcGVhcmVkXHJcbiAgICAgICAgICAgICAgICBpZiAoYWMgJiZcclxuICAgICAgICAgICAgICAgICAgICAhaXNCYWRNZW51U2hvd24oKSAmJlxyXG4gICAgICAgICAgICAgICAgICAgIERhdGUubm93KCkgLSB0aGlzLmVxU3RhdGUubGFzdEVxTW9tZW50ID4gNTAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgRGF0ZS5ub3coKSAtIHRoaXMuc3Bhd25Nb21lbnQgPiAtMSAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3Bhd25Nb21lbnQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9pZiAodGhpcy5zcGF3bk1vbWVudCA+IDAgJiYgRGF0ZS5ub3coKSAtIHRoaXMuc3Bhd25Nb21lbnQgPiA1MDAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcGx5RXF1aXBtZW50KGFjLCBtb2RlbC5lcXVpcG1lbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXFTdGF0ZS5sYXN0TnVtQ2hhbmdlcyA9IG1vZGVsLmVxdWlwbWVudC5udW1DaGFuZ2VzO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVxU3RhdGUubGFzdEVxTW9tZW50ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgICAgICAvL31cclxuICAgICAgICAgICAgICAgICAgICAvL2NvbnN0IHJlczogYm9vbGVhbiA9IGFwcGx5RXF1aXBtZW50KGFjLCBtb2RlbC5lcXVpcG1lbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vaWYgKHJlcykgdGhpcy5lcVN0YXRlLmxhc3ROdW1DaGFuZ2VzID0gbW9kZWwuZXF1aXBtZW50Lm51bUNoYW5nZXM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKEZvcm1WaWV3LmlzRGlzcGxheWluZ05pY2tuYW1lcyAmJiB0aGlzLnJlZnJJZCAmJiAoKF9iID0gbW9kZWwuYXBwZWFyYW5jZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIHZhciBoZWFkUGFydCA9IFwiTlBDIEhlYWQgW0hlYWRdXCI7XHJcbiAgICAgICAgICAgIHZhciBtYXhOaWNrbmFtZURyYXdEaXN0YW5jZSA9IDEwMDA7XHJcbiAgICAgICAgICAgIHZhciBwbGF5ZXJBY3RvciA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgIHZhciBpc1Zpc2libGVCeVBsYXllciA9ICEoKF9jID0gbW9kZWwubW92ZW1lbnQpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5pc1NuZWFraW5nKVxyXG4gICAgICAgICAgICAgICAgJiYgcGxheWVyQWN0b3IuZ2V0RGlzdGFuY2UocmVmcikgPD0gbWF4Tmlja25hbWVEcmF3RGlzdGFuY2VcclxuICAgICAgICAgICAgICAgICYmIHBsYXllckFjdG9yLmhhc0xPUyhyZWZyKVxyXG4gICAgICAgICAgICAgICAgJiYgIXRoaXMuaXNTd2VldEhpZGVQZXJzb24ocmVmcik7XHJcbiAgICAgICAgICAgIGlmIChpc1Zpc2libGVCeVBsYXllcikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGhlYWRTY3JlZW5Qb3MgPSB3b3JsZFBvaW50VG9TY3JlZW5Qb2ludChbXHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5nZXROb2RlV29ybGRQb3NpdGlvblgocmVmciwgaGVhZFBhcnQsIGZhbHNlKSxcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLmdldE5vZGVXb3JsZFBvc2l0aW9uWShyZWZyLCBoZWFkUGFydCwgZmFsc2UpLFxyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2UuZ2V0Tm9kZVdvcmxkUG9zaXRpb25aKHJlZnIsIGhlYWRQYXJ0LCBmYWxzZSkgKyAzMlxyXG4gICAgICAgICAgICAgICAgXSlbMF07XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVzb2x1dGlvbiA9IGdldFNjcmVlblJlc29sdXRpb24oKTtcclxuICAgICAgICAgICAgICAgIHZhciB0ZXh0WFBvcyA9IE1hdGgucm91bmQoaGVhZFNjcmVlblBvc1swXSAqIHJlc29sdXRpb24ud2lkdGgpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRleHRZUG9zID0gTWF0aC5yb3VuZCgoMSAtIGhlYWRTY3JlZW5Qb3NbMV0pICogcmVzb2x1dGlvbi5oZWlnaHQpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGlzVGFsa2luZ1RleHQgPSAobW9kZWwgPT09IG51bGwgfHwgbW9kZWwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1vZGVsLmlzVGFsa2luZykgPyBcIlNwZWFraW5nXCIgOiBcIlwiO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnRleHROYW1lSWQgJiYgaGVhZFNjcmVlblBvc1syXSA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHROYW1lSWQgPSBjcmVhdGVUZXh0KHRleHRYUG9zLCB0ZXh0WVBvcywgcmVmci5nZXREaXNwbGF5TmFtZSgpLCBbMSwgMSwgMSwgMC44XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGV4dFNpemUodGhpcy50ZXh0TmFtZUlkLCAwLjUpO1xyXG4gICAgICAgICAgICAgICAgICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5lbWl0dGVyLmVtaXQoXCJuaWNrbmFtZUNyZWF0ZVwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZVJlZnJJZDogdGhpcy5nZXRSZW1vdGVSZWZySWQoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dElkOiB0aGlzLnRleHROYW1lSWRcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkZWxldGVOaWNrbmFtZSA9IGhlYWRTY3JlZW5Qb3NbMl0gPCAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVOaWNrbmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZU5pY2tuYW1lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRleHROYW1lSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGV4dFBvcyh0aGlzLnRleHROYW1lSWQsIHRleHRYUG9zLCB0ZXh0WVBvcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZvaWNlSW5kaWNhdG9ySWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZvaWNlSW5kaWNhdG9ySWQgPSBjcmVhdGVUZXh0KHRleHRYUG9zLCB0ZXh0WVBvcyAtIDM1LCBcIlwiLCBbMSwgMC44NSwgMC4yLCAwLjhdKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLnZvaWNlSW5kaWNhdG9ySWQsIDAuNCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52b2ljZUluZGljYXRvcklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRleHRTdHJpbmcodGhpcy52b2ljZUluZGljYXRvcklkLCBoZWFkU2NyZWVuUG9zWzJdID49IDAgPyBpc1RhbGtpbmdUZXh0IDogXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRleHRQb3ModGhpcy52b2ljZUluZGljYXRvcklkLCB0ZXh0WFBvcywgdGV4dFlQb3MgLSAzNSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVOaWNrbmFtZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZU5pY2tuYW1lKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5pc1N3ZWV0SGlkZVBlcnNvbiA9IGZ1bmN0aW9uIChyZWZyKSB7XHJcbiAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICBpZiAoIWFjdG9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGtleXdvcmQgPSBLZXl3b3JkLmdldEtleXdvcmQoJ1N3ZWV0SGlkZVBlcnNvbicpO1xyXG4gICAgICAgIHJldHVybiBhY3Rvci53b3JuSGFzS2V5d29yZChrZXl3b3JkKTtcclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUucmVtb3ZlTmlja25hbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudGV4dE5hbWVJZCkge1xyXG4gICAgICAgICAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkuZW1pdHRlci5lbWl0KFwibmlja25hbWVEZXN0cm95XCIsIHtcclxuICAgICAgICAgICAgICAgIHJlbW90ZVJlZnJJZDogdGhpcy5nZXRSZW1vdGVSZWZySWQoKSxcclxuICAgICAgICAgICAgICAgIHRleHRJZDogdGhpcy50ZXh0TmFtZUlkXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkZXN0cm95VGV4dCh0aGlzLnRleHROYW1lSWQpO1xyXG4gICAgICAgICAgICB0aGlzLnRleHROYW1lSWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnZvaWNlSW5kaWNhdG9ySWQpIHtcclxuICAgICAgICAgICAgZGVzdHJveVRleHQodGhpcy52b2ljZUluZGljYXRvcklkKTtcclxuICAgICAgICAgICAgdGhpcy52b2ljZUluZGljYXRvcklkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0QXBwZWFyYW5jZUJhc2VkQmFzZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgYmFzZSA9IEFjdG9yQmFzZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkKSk7XHJcbiAgICAgICAgaWYgKCFiYXNlICYmIHRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQgPSBhcHBseUFwcGVhcmFuY2UodGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSkuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0TGV2ZWxlZEJhc2UgPSBmdW5jdGlvbiAodGVtcGxhdGVDaGFpbikge1xyXG4gICAgICAgIGlmICh0ZW1wbGF0ZUNoYWluID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzdHIgPSB0ZW1wbGF0ZUNoYWluLmpvaW4oJywnKTtcclxuICAgICAgICBpZiAodGhpcy5sZXZlbGVkQmFzZUlkID09PSAwKSB7XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgdmFyIGxldmVsZWRCYXNlID0gVEVTTW9kUGxhdGZvcm0uZXZhbHVhdGVMZXZlbGVkTnBjKHN0cik7XHJcbiAgICAgICAgICAgIGlmICghbGV2ZWxlZEJhc2UpIHtcclxuICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIkZhaWxlZCB0byBldmFsdWF0ZSBsZXZlbGVkIG5wY1wiLCBzdHIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMubGV2ZWxlZEJhc2VJZCA9IChsZXZlbGVkQmFzZSA9PT0gbnVsbCB8fCBsZXZlbGVkQmFzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGV2ZWxlZEJhc2UuZ2V0Rm9ybUlEKCkpIHx8IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmxldmVsZWRCYXNlSWQ7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldERlZmF1bHRFcXVpcFN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7IGxhc3ROdW1DaGFuZ2VzOiAwLCBsYXN0RXFNb21lbnQ6IDAgfTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0RGVmYXVsdEFwcGVhcmFuY2VTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4geyBsYXN0TnVtQ2hhbmdlczogMCwgYXBwZWFyYW5jZTogbnVsbCB9O1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXREZWZhdWx0QW5pbVN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7IGxhc3ROdW1DaGFuZ2VzOiAwLCB1c2VBbmltT3ZlcnJpZGVzOiB0cnVlIH07XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLnRyeUhvc3RJZk5lZWQgPSBmdW5jdGlvbiAoYWMsIHJlbW90ZUlkKSB7XHJcbiAgICAgICAgdmFyIGxhc3QgPSBsYXN0VHJ5SG9zdFtyZW1vdGVJZF07XHJcbiAgICAgICAgaWYgKCFsYXN0IHx8IERhdGUubm93KCkgLSBsYXN0ID49IDEwMDApIHtcclxuICAgICAgICAgICAgbGFzdFRyeUhvc3RbcmVtb3RlSWRdID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgaWYgKGdldE1vdmVtZW50KGFjKS53b3JsZE9yQ2VsbCA9PT1cclxuICAgICAgICAgICAgICAgIGdldE1vdmVtZW50KEdhbWUuZ2V0UGxheWVyKCkpLndvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgICAgICB0cnlIb3N0KHJlbW90ZUlkKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0TG9jYWxSZWZySWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVmcklkO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXRSZW1vdGVSZWZySWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVtb3RlUmVmcklkO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LmlzRGlzcGxheWluZ05pY2tuYW1lcyA9IHRydWU7XHJcbiAgICByZXR1cm4gRm9ybVZpZXc7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IEZvcm1WaWV3IH07XHJcbiIsImltcG9ydCB7IEZvcm1WaWV3IH0gZnJvbSBcIi4vZm9ybVZpZXdcIjtcclxuaW1wb3J0IHsgU3BBcGlJbnRlcmFjdG9yIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NwQXBpSW50ZXJhY3RvclwiO1xyXG5pbXBvcnQgeyBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvc2VydmljZXMvZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlXCI7XHJcbnZhciBGb3JtVmlld0FycmF5ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gRm9ybVZpZXdBcnJheSgpIHtcclxuICAgICAgICB0aGlzLmZvcm1WaWV3cyA9IG5ldyBBcnJheSgpO1xyXG4gICAgfVxyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUudXBkYXRlRm9ybSA9IGZ1bmN0aW9uIChmb3JtLCBpKSB7XHJcbiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmZvcm1WaWV3c1tpXTtcclxuICAgICAgICBpZiAoIXZpZXcpIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JtVmlld3NbaV0gPSBuZXcgRm9ybVZpZXcoZm9ybS5yZWZySWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdmlldy51cGRhdGUoZm9ybSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLmRlc3Ryb3lGb3JtID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICB2YXIgZm9ybVZpZXcgPSB0aGlzLmZvcm1WaWV3c1tpXTtcclxuICAgICAgICBpZiAoZm9ybVZpZXcgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm1WaWV3LmRlc3Ryb3koKTtcclxuICAgICAgICB0aGlzLmZvcm1WaWV3c1tpXSA9IHVuZGVmaW5lZDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbiAobmV3U2l6ZSkge1xyXG4gICAgICAgIGlmICh0aGlzLmZvcm1WaWV3cy5sZW5ndGggPiBuZXdTaXplKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybVZpZXdzLnNsaWNlKG5ld1NpemUpLmZvckVhY2goZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgJiYgdi5kZXN0cm95KCk7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmZvcm1WaWV3cy5sZW5ndGggPSBuZXdTaXplO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLnVwZGF0ZUFsbCA9IGZ1bmN0aW9uIChtb2RlbCwgc2hvd01lLCBpc0Nsb25lVmlldykge1xyXG4gICAgICAgIHZhciBnYW1lbW9kZVVwZGF0ZVNlcnZpY2UgPSBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkubG9va3VwTGlzdGVuZXIoR2FtZW1vZGVVcGRhdGVTZXJ2aWNlKTtcclxuICAgICAgICBnYW1lbW9kZVVwZGF0ZVNlcnZpY2Uuc2V0Rm9ybVZpZXdBcnJheSh0aGlzKTtcclxuICAgICAgICB2YXIgZm9ybXMgPSBtb2RlbC5mb3JtcztcclxuICAgICAgICB2YXIgbiA9IGZvcm1zLmxlbmd0aDtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkge1xyXG4gICAgICAgICAgICB2YXIgZm9ybSA9IGZvcm1zW2ldO1xyXG4gICAgICAgICAgICBpZiAoIWZvcm0gfHwgKG1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPT09IGkgJiYgIXNob3dNZSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveUZvcm0oaSk7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgcmVhbFBvcyA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdmFyIG9mZnNldCA9IG1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPT09IGkgfHwgaXNDbG9uZVZpZXc7XHJcbiAgICAgICAgICAgIGlmIChvZmZzZXQgJiYgZm9ybS5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgcmVhbFBvcyA9IGZvcm0ubW92ZW1lbnQucG9zO1xyXG4gICAgICAgICAgICAgICAgZm9ybS5tb3ZlbWVudC5wb3MgPSBbXHJcbiAgICAgICAgICAgICAgICAgICAgcmVhbFBvc1swXSArIDEyOCxcclxuICAgICAgICAgICAgICAgICAgICByZWFsUG9zWzFdICsgMTI4LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlYWxQb3NbMl0sXHJcbiAgICAgICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpc0Nsb25lVmlldykge1xyXG4gICAgICAgICAgICAgICAgLy8gUHJldmVudCB1c2luZyB0aGUgc2FtZSByZWZyIGJ5IG5vcm1hbCBhbmQgY2xvbmUgdmlld3NcclxuICAgICAgICAgICAgICAgIGlmICghZm9ybS5yZWZySWQgfHwgZm9ybS5yZWZySWQgPj0gMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiYWNrdXAgPSBmb3JtLmlzSG9zdGVkQnlPdGhlcjtcclxuICAgICAgICAgICAgICAgICAgICBmb3JtLmlzSG9zdGVkQnlPdGhlciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRXhwbGFpbiB3aHkgZG8gbm90IEdhbWVtb2RlQXBpU3VwcG9ydC5zZXRJKGkpOyBoZXJlXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVGb3JtKGZvcm0sIGkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvcm0uaXNIb3N0ZWRCeU90aGVyID0gYmFja3VwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnNldEkoaSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZvcm0oZm9ybSwgaSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG9mZnNldCAmJiBmb3JtLm1vdmVtZW50ICYmIHJlYWxQb3MpIHtcclxuICAgICAgICAgICAgICAgIGZvcm0ubW92ZW1lbnQucG9zID0gcmVhbFBvcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5zeW5jRm9ybVZpZXcgPSBmdW5jdGlvbiAobW9kZWwsIHNob3dNZSkge1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kZWwuZm9ybXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKCFtb2RlbC5mb3Jtc1tpXSB8fCAobW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCA9PT0gaSAmJiAhc2hvd01lKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95Rm9ybShpKTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLmdldFJlbW90ZVJlZnJJZCA9IGZ1bmN0aW9uIChjbGllbnRzaWRlUmVmcklkKSB7XHJcbiAgICAgICAgaWYgKGNsaWVudHNpZGVSZWZySWQgPCAweGZmMDAwMDAwKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGlzIGZ1bmN0aW9uIGlzIG9ubHkgZm9yIDB4ZmYgZm9ybXNcIik7XHJcbiAgICAgICAgdmFyIGZvcm1WaWV3ID0gdGhpcy5mb3JtVmlld3MuZmluZChmdW5jdGlvbiAoZm9ybVZpZXcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZvcm1WaWV3ICYmIGZvcm1WaWV3LmdldExvY2FsUmVmcklkKCkgPT09IGNsaWVudHNpZGVSZWZySWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGZvcm1WaWV3ID8gZm9ybVZpZXcuZ2V0UmVtb3RlUmVmcklkKCkgOiAwO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLmdldExvY2FsUmVmcklkID0gZnVuY3Rpb24gKHJlbW90ZVJlZnJJZCkge1xyXG4gICAgICAgIGlmIChyZW1vdGVSZWZySWQgPCAweGZmMDAwMDAwKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGlzIGZ1bmN0aW9uIGlzIG9ubHkgZm9yIDB4ZmYgZm9ybXNcIik7XHJcbiAgICAgICAgdmFyIGZvcm1WaWV3ID0gdGhpcy5mb3JtVmlld3MuZmluZChmdW5jdGlvbiAoZm9ybVZpZXcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZvcm1WaWV3ICYmIGZvcm1WaWV3LmdldFJlbW90ZVJlZnJJZCgpID09PSByZW1vdGVSZWZySWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGZvcm1WaWV3ID8gZm9ybVZpZXcuZ2V0TG9jYWxSZWZySWQoKSA6IDA7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUuZ2V0TnRoRm9ybVZpZXcgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZvcm1WaWV3c1tpXTtcclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5nZXRGb3JtVmlld3NBcnJheUxlbmd0aCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5mb3JtVmlld3MubGVuZ3RoO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBGb3JtVmlld0FycmF5O1xyXG59KCkpO1xyXG5leHBvcnQgeyBGb3JtVmlld0FycmF5IH07XHJcbiIsImltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuc3RvcmFnZVtcImhvc3RBdHRlbXB0c1wiXSA9IFtdO1xyXG5leHBvcnQgdmFyIHRyeUhvc3QgPSBmdW5jdGlvbiAodGFyZ2V0UmVtb3RlSWQpIHtcclxuICAgIHN0b3JhZ2VbXCJob3N0QXR0ZW1wdHNcIl0ucHVzaCh0YXJnZXRSZW1vdGVJZCk7XHJcbn07XHJcbmV4cG9ydCB2YXIgbmV4dEhvc3RBdHRlbXB0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGFyciA9IHN0b3JhZ2VbXCJob3N0QXR0ZW1wdHNcIl07XHJcbiAgICBpZiAoYXJyLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJyLnNoaWZ0KCk7XHJcbn07XHJcbmV4cG9ydCB2YXIgbGFzdFRyeUhvc3QgPSB7fTtcclxuIiwiaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlLCBHYW1lLCBUZXh0dXJlU2V0LCBOZXRJbW1lcnNlIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGFwcGx5SW52ZW50b3J5IH0gZnJvbSBcIi4uL3N5bmMvaW52ZW50b3J5XCI7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi9sb2dnaW5nXCI7XHJcbi8vIEZvciAweGZmMDAwMDAwKyB1c2VkIGZyb20gRm9ybVZpZXdcclxuLy8gRm9yIG9iamVjdHMgZnJvbSBtYXN0ZXIgZmlsZXMgdXNlZCBkaXJlY3RseSBmcm9tIHJlbW90ZVNlcnZlci50c1xyXG52YXIgTW9kZWxBcHBseVV0aWxzID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gTW9kZWxBcHBseVV0aWxzKCkge1xyXG4gICAgfVxyXG4gICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJbnZlbnRvcnkgPSBmdW5jdGlvbiAocmVmciwgaW52ZW50b3J5KSB7XHJcbiAgICAgICAgYXBwbHlJbnZlbnRvcnkocmVmciwgaW52ZW50b3J5LCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICB9O1xyXG4gICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc09wZW4gPSBmdW5jdGlvbiAocmVmciwgaXNPcGVuKSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHJlZnIuc2V0T3Blbihpc09wZW4pO1xyXG4gICAgICAgIC8vIFNlZSBhbHNvIG9iamVjdFJlZmVyZW5jZUV4LnRzXHJcbiAgICAgICAgdmFyIGNhdmVHU2VjcmV0RG9vcjAxID0gMHg2ZjcwMztcclxuICAgICAgICAvLyBUT0RPOiBhZGQgbW9yZSBhY3RpdmF0b3JzIHRvIHN1cHBvcnQgbW9yZSBjZWxsc1xyXG4gICAgICAgIHZhciBwYXJlbnRBY3RpdmF0b3JJZCA9IDB4NDYwY2E7XHJcbiAgICAgICAgaWYgKCgoX2EgPSByZWZyLmdldEJhc2VPYmplY3QoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZvcm1JRCgpKSA9PT0gY2F2ZUdTZWNyZXREb29yMDEpIHtcclxuICAgICAgICAgICAgdmFyIG9wZW5Pck9wZW5pbmcgPSBbMSwgMl0uaW5jbHVkZXMocmVmci5nZXRPcGVuU3RhdGUoKSk7XHJcbiAgICAgICAgICAgIGlmIChvcGVuT3JPcGVuaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzT3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnIuYWN0aXZhdGUoT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtKHBhcmVudEFjdGl2YXRvcklkKSksIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIW9wZW5Pck9wZW5pbmcpIHtcclxuICAgICAgICAgICAgICAgIGlmIChpc09wZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyLmFjdGl2YXRlKE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybShwYXJlbnRBY3RpdmF0b3JJZCkpLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0Rpc2FibGVkID0gZnVuY3Rpb24gKHJlZnIsIGRpc2FibGVkKSB7XHJcbiAgICAgICAgdmFyIHdhc0Rpc2FibGVkID0gcmVmci5pc0Rpc2FibGVkKCk7XHJcbiAgICAgICAgaWYgKHdhc0Rpc2FibGVkID09IGRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgIHJlZnIuZGlzYWJsZShmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZWZyLmVuYWJsZSh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0hhcnZlc3RlZCA9IGZ1bmN0aW9uIChyZWZyLCBpc0hhcnZlc3RlZCkge1xyXG4gICAgICAgIHZhciBiYXNlID0gcmVmci5nZXRCYXNlT2JqZWN0KCk7XHJcbiAgICAgICAgaWYgKGJhc2UpIHtcclxuICAgICAgICAgICAgdmFyIHQgPSBiYXNlLmdldFR5cGUoKTtcclxuICAgICAgICAgICAgaWYgKHQgPT0gMzggLyogRm9ybVR5cGUuVHJlZSAqLyB8fCB0ID09IDM5IC8qIEZvcm1UeXBlLkZsb3JhICovKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgd2FzSGFydmVzdGVkID0gcmVmci5pc0hhcnZlc3RlZCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzSGFydmVzdGVkICE9IHdhc0hhcnZlc3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhYyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGFydmVzdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMjA7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWMgPSBHYW1lLmZpbmRSYW5kb21BY3RvcihyZWZyLmdldFBvc2l0aW9uWCgpLCByZWZyLmdldFBvc2l0aW9uWSgpLCByZWZyLmdldFBvc2l0aW9uWigpLCAxMDAwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWMgJiYgYWMuZ2V0Rm9ybUlEKCkgIT09IDB4MTQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNIYXJ2ZXN0ZWQgJiYgYWMgJiYgYWMuZ2V0Rm9ybUlEKCkgIT09IDB4MTQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5hY3RpdmF0ZShhYywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyLnNldEhhcnZlc3RlZChpc0hhcnZlc3RlZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZF8xID0gcmVmci5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5kaXNhYmxlKGZhbHNlKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN0b3JlZFJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChpZF8xKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdG9yZWRSZWZyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdG9yZWRSZWZyLmVuYWJsZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhciB3YXNIYXJ2ZXN0ZWQgPSByZWZyLmlzRGlzYWJsZWQoKTtcclxuICAgICAgICAgICAgICAgIGlmIChpc0hhcnZlc3RlZCAhPSB3YXNIYXJ2ZXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNIYXJ2ZXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkXzIgPSByZWZyLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyLmRpc2FibGUoZmFsc2UpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3RvcmVkUmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGlkXzIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN0b3JlZFJlZnIgJiYgIXJlc3RvcmVkUmVmci5pc0Rpc2FibGVkKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN0b3JlZFJlZnIuZGVsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVsZXRpb24gdGFrZXMgdGltZSwgc28gaW4gcHJhY3RpY2UgdGhpcyB3b3VsZCBiZSBjYWxsZWQgYSBsb3Qgb2YgdGltZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyLmVuYWJsZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxOb2RlVGV4dHVyZVNldCA9IGZ1bmN0aW9uIChyZWZyLCBzZXROb2RlVGV4dHVyZVNldCkge1xyXG4gICAgICAgIGlmIChzZXROb2RlVGV4dHVyZVNldCkge1xyXG4gICAgICAgICAgICBzZXROb2RlVGV4dHVyZVNldC5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZmlyc3RQZXJzb24gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHZhciB0ZXh0dXJlU2V0ID0gVGV4dHVyZVNldC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGVsZW1lbnQudGV4dHVyZVNldElkKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGV4dHVyZVNldCAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2Uuc2V0Tm9kZVRleHR1cmVTZXQocmVmciwgZWxlbWVudC5ub2RlTmFtZSwgdGV4dHVyZVNldCwgZmlyc3RQZXJzb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKFwiTW9kZWxBcHBseVV0aWxzXCIsIHJlZnIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpLCBcIkFwcGxpZWQgdGV4dHVyZSBzZXRcIiwgZWxlbWVudC50ZXh0dXJlU2V0SWQudG9TdHJpbmcoMTYpLCBcInRvXCIsIGVsZW1lbnQubm9kZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoXCJNb2RlbEFwcGx5VXRpbHNcIiwgcmVmci5nZXRGb3JtSUQoKS50b1N0cmluZygxNiksIFwiRmFpbGVkIHRvIGFwcGx5IHRleHR1cmUgc2V0XCIsIGVsZW1lbnQudGV4dHVyZVNldElkLnRvU3RyaW5nKDE2KSwgXCJ0b1wiLCBlbGVtZW50Lm5vZGVOYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsTm9kZVNjYWxlID0gZnVuY3Rpb24gKHJlZnIsIHNldE5vZGVTY2FsZSkge1xyXG4gICAgICAgIGlmIChzZXROb2RlU2NhbGUpIHtcclxuICAgICAgICAgICAgc2V0Tm9kZVNjYWxlLmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBmaXJzdFBlcnNvbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5zZXROb2RlU2NhbGUocmVmciwgZWxlbWVudC5ub2RlTmFtZSwgZWxlbWVudC5zY2FsZSwgZmlyc3RQZXJzb24pO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoXCJNb2RlbEFwcGx5VXRpbHNcIiwgcmVmci5nZXRGb3JtSUQoKS50b1N0cmluZygxNiksIFwiQXBwbGllZCBub2RlIHNjYWxlXCIsIGVsZW1lbnQuc2NhbGUsIFwidG9cIiwgZWxlbWVudC5ub2RlTmFtZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gTW9kZWxBcHBseVV0aWxzO1xyXG59KCkpO1xyXG5leHBvcnQgeyBNb2RlbEFwcGx5VXRpbHMgfTtcclxuIiwiaW1wb3J0IHsgR2FtZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gXCIuLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4XCI7XHJcbnZhciBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlcigpIHtcclxuICAgIH1cclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIudXBkYXRlRGF0YSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIHBsYXllciA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgaWYgKCFwbGF5ZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmluSnVtcFN0YXRlID0gcGxheWVyLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcImJJbkp1bXBTdGF0ZVwiKTtcclxuICAgICAgICB0aGlzLndvcmxkT3JDZWxsID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwocGxheWVyKTtcclxuICAgICAgICB0aGlzLmNyb3NzaGFpclJlZklkID0gKChfYSA9IEdhbWUuZ2V0Q3VycmVudENyb3NzaGFpclJlZigpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Rm9ybUlEKCkpIHx8IDA7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5pc0luSnVtcFN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmluSnVtcFN0YXRlO1xyXG4gICAgfTtcclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0V29ybGRPckNlbGwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud29ybGRPckNlbGw7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRDcm9zc2hhaXJSZWZJZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jcm9zc2hhaXJSZWZJZDtcclxuICAgIH07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmluSnVtcFN0YXRlID0gZmFsc2U7XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLndvcmxkT3JDZWxsID0gMDtcclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuY3Jvc3NoYWlyUmVmSWQgPSAwO1xyXG4gICAgcmV0dXJuIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXI7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIgfTtcclxuIiwiaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlLCBHYW1lLCBBY3RvciB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBhcHBseVRpbnRzIH0gZnJvbSBcIi4uL3N5bmMvYXBwZWFyYW5jZVwiO1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gXCIuLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4XCI7XHJcbnZhciBTcGF3blByb2Nlc3MgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBTcGF3blByb2Nlc3MoYXBwZWFyYW5jZSwgcG9zLCByZWZySWQsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7XHJcbiAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICBpZiAoIXJlZnIgfHwgcmVmci5nZXRGb3JtSUQoKSAhPT0gcmVmcklkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVmci5zZXRQb3NpdGlvbi5hcHBseShyZWZyLCBwb3MpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMuZW5hYmxlKGFwcGVhcmFuY2UsIHJlZnJJZCk7IH0pO1xyXG4gICAgfVxyXG4gICAgU3Bhd25Qcm9jZXNzLnByb3RvdHlwZS5lbmFibGUgPSBmdW5jdGlvbiAoYXBwZWFyYW5jZSwgcmVmcklkKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgIGlmICghcmVmciB8fCByZWZyLmdldEZvcm1JRCgpICE9PSByZWZySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgIGlmIChhYyAmJiBhcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgIGFwcGx5VGludHMoYWMsIGFwcGVhcmFuY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZWZyLmVuYWJsZShmYWxzZSkudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5yZXN1cnJlY3QocmVmcklkKTsgfSk7XHJcbiAgICB9O1xyXG4gICAgU3Bhd25Qcm9jZXNzLnByb3RvdHlwZS5yZXN1cnJlY3QgPSBmdW5jdGlvbiAocmVmcklkKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlZnJJZCkpO1xyXG4gICAgICAgIGlmICghcmVmciB8fCByZWZyLmdldEZvcm1JRCgpICE9PSByZWZySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICByZXR1cm4gYWMucmVzdXJyZWN0KCkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jYWxsYmFjaygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgT2JqZWN0UmVmZXJlbmNlRXguZGVhbFdpdGhSZWYocmVmciwgcmVmci5nZXRCYXNlT2JqZWN0KCkpO1xyXG4gICAgICAgIHJldHVybiByZWZyLnNldE1vdGlvblR5cGUoNCAvKiBNb3Rpb25UeXBlLktleWZyYW1lZCAqLywgdHJ1ZSkudGhlbih0aGlzLmNhbGxiYWNrKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gU3Bhd25Qcm9jZXNzO1xyXG59KCkpO1xyXG5leHBvcnQgeyBTcGF3blByb2Nlc3MgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IEZvcm1WaWV3QXJyYXkgfSBmcm9tICcuL2Zvcm1WaWV3QXJyYXknO1xyXG5pbXBvcnQgeyBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyIH0gZnJvbSAnLi9wbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyJztcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tICcuLi9zZXJ2aWNlcy9zZXJ2aWNlcy9jbGllbnRMaXN0ZW5lcic7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgU2luZ2xlUGxheWVyU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zaW5nbGVQbGF5ZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zZXJ2aWNlcy9yZW1vdGVTZXJ2ZXJcIjtcclxudmFyIFdvcmxkVmlldyA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhXb3JsZFZpZXcsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBXb3JsZFZpZXcoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBjb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBfdGhpcy5zdGF0ZSA9IF90aGlzLm1ha2VFbXB0eVN0YXRlKCk7XHJcbiAgICAgICAgdmFyIG9sZFZpZXcgPSBfdGhpcy5zcC5zdG9yYWdlW1widmlld1wiXTtcclxuICAgICAgICAvLyBjYW4ndCB1c2UgaW5zdGFuY2VvZiBoZXJlIGJlY2F1c2UgZWFjaCBob3QgcmVsb2FkIGNyZWF0ZXMgYSBuZXcgY2xhc3NcclxuICAgICAgICBfdGhpcy5vbGRWaWV3ID0gdHlwZW9mIG9sZFZpZXcgPT09IFwib2JqZWN0XCIgPyBvbGRWaWV3IDogdW5kZWZpbmVkO1xyXG4gICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbXCJ2aWV3XCJdID0gX3RoaXM7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5nZXRSZW1vdGVSZWZySWQgPSBmdW5jdGlvbiAoY2xpZW50c2lkZVJlZnJJZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmZvcm1WaWV3cy5nZXRSZW1vdGVSZWZySWQoY2xpZW50c2lkZVJlZnJJZCk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5nZXRMb2NhbFJlZnJJZCA9IGZ1bmN0aW9uIChyZW1vdGVSZWZySWQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5mb3JtVmlld3MuZ2V0TG9jYWxSZWZySWQocmVtb3RlUmVmcklkKTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLnN5bmNGb3JtQXJyYXkgPSBmdW5jdGlvbiAobW9kZWwpIHtcclxuICAgICAgICB2YXIgc2V0dGluZ3MgPSB0aGlzLnNwLnNldHRpbmdzO1xyXG4gICAgICAgIHZhciBzaG93TWUgPSBzZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzaG93LW1lJ107XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5mb3JtVmlld3Muc3luY0Zvcm1WaWV3KG1vZGVsLCAhIXNob3dNZSk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3RhdGUuZm9ybVZpZXdzLnJlc2l6ZSgwKTtcclxuICAgICAgICB0aGlzLnN0YXRlLmNsb25lRm9ybVZpZXdzLnJlc2l6ZSgwKTsgLy8gUmVjZW5ybHkgYWRkZWQsIG5vdCB0ZXN0ZWQgaWYgaXQncyBuZWVkZWRcclxuICAgICAgICB0aGlzLnN0YXRlID0gdGhpcy5tYWtlRW1wdHlTdGF0ZSgpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUuZ2V0Rm9ybVZpZXdzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmZvcm1WaWV3cztcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMucmVzZXRBbGxGb3JtVmlld3NJZlBsYXllckNoYW5nZWRXb3JsZCgpO1xyXG4gICAgICAgIHZhciBzaW5nbGVQbGF5ZXJTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNpbmdsZVBsYXllclNlcnZpY2UpO1xyXG4gICAgICAgIGlmICghc2luZ2xlUGxheWVyU2VydmljZS5pc1NpbmdsZVBsYXllcikge1xyXG4gICAgICAgICAgICB2YXIgbW9kZWxTb3VyY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmVtb3RlU2VydmVyKTtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVXb3JsZChtb2RlbFNvdXJjZS5nZXRXb3JsZE1vZGVsKCkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub2xkVmlldykge1xyXG4gICAgICAgICAgICB0aGlzLm9sZFZpZXcuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICB0aGlzLm9sZFZpZXcgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdQcmV2aW91cyBWaWV3IGRlc3Ryb3llZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLndhaXRHYW1lVGltZUFuZEFsbG93Rm9ybVZpZXdVcGRhdGUoMS4wKTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLnJlc2V0QWxsRm9ybVZpZXdzSWZQbGF5ZXJDaGFuZ2VkV29ybGQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5zdGF0ZTtcclxuICAgICAgICB2YXIgcGMgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgdmFyIHBjV29ybGRPckNlbGwgPSAocGMuZ2V0V29ybGRTcGFjZSgpIHx8IHBjLmdldFBhcmVudENlbGwoKSkuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgaWYgKHN0YXRlLnBjV29ybGRPckNlbGwgIT09IHBjV29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLnBjV29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdSZXNldCBhbGwgZm9ybSB2aWV3cycpO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuZm9ybVZpZXdzLnJlc2l6ZSgwKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmNsb25lRm9ybVZpZXdzLnJlc2l6ZSgwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzdGF0ZS5wY1dvcmxkT3JDZWxsID0gcGNXb3JsZE9yQ2VsbDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy8gV29yayBhcm91bmQgc2hvd1JhY2VNZW51IGlzc3VlXHJcbiAgICAvLyBEZWZhdWx0IG5vcmQgaW4gUmFjZSBNZW51IHdpbGwgaGF2ZSB2ZXJ5IHVnbHkgZmFjZVxyXG4gICAgLy8gSWYgb3RoZXIgcGxheWVycyBhcmUgc3Bhd25pbmcgd2hlbiB3ZSBzaG93IHRoaXMgbWVudVxyXG4gICAgLy8gVE9ETzogc2VwYXJhdGUgbGlzdGVuZXJcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUud2FpdEdhbWVUaW1lQW5kQWxsb3dGb3JtVmlld1VwZGF0ZSA9IGZ1bmN0aW9uIChzZWNvbmRzKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAvLyBXYWl0IDFzIGdhbWUgdGltZSAodGltZSBzcGVudCBpbiBSYWNlIE1lbnUgaXNuJ3QgY291bnRlZClcclxuICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdChzZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgX3RoaXMuc3RhdGUuYWxsb3dVcGRhdGUgPSB0cnVlO1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgJ1VwZGF0ZSBpcyBub3cgYWxsb3dlZCcpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUuc2V0Rm9ybVZpZXdVcGRhdGVBbGxvd2VkID0gZnVuY3Rpb24gKGFsbG93ZWQpIHtcclxuICAgICAgICB0aGlzLnN0YXRlLmFsbG93VXBkYXRlID0gYWxsb3dlZDtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCAnVXBkYXRlIGlzIG5vdycsIGFsbG93ZWQgPyAnYWxsb3dlZCcgOiAnZGlzYWxsb3dlZCcpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUudXBkYXRlV29ybGQgPSBmdW5jdGlvbiAobW9kZWwpIHtcclxuICAgICAgICB2YXIgc2V0dGluZ3MgPSB0aGlzLnNwLnNldHRpbmdzO1xyXG4gICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuc3RhdGU7XHJcbiAgICAgICAgaWYgKCFzdGF0ZS5hbGxvd1VwZGF0ZSkge1xyXG4gICAgICAgICAgICBtb2RlbCA9IHtcclxuICAgICAgICAgICAgICAgIGZvcm1zOiBbXSxcclxuICAgICAgICAgICAgICAgIHBsYXllckNoYXJhY3RlckZvcm1JZHg6IG1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHgsXHJcbiAgICAgICAgICAgICAgICBwbGF5ZXJDaGFyYWN0ZXJSZWZySWQ6IG1vZGVsLnBsYXllckNoYXJhY3RlclJlZnJJZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2tpcFVwZGF0ZXMgPSBzZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydza2lwVXBkYXRlcyddO1xyXG4gICAgICAgIC8vIHNraXAgNTAlIG9mIHVwZGF0ZXMgaWYgc3BlY2lmaWVkIGluIHRoZSBzZXR0aW5nc1xyXG4gICAgICAgIHN0YXRlLmNvdW50ZXIgPSAhc3RhdGUuY291bnRlcjtcclxuICAgICAgICBpZiAoc3RhdGUuY291bnRlciAmJiBza2lwVXBkYXRlcykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0YXRlLmZvcm1WaWV3cy5yZXNpemUobW9kZWwuZm9ybXMubGVuZ3RoKTtcclxuICAgICAgICB2YXIgc2hvd01lID0gc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2hvdy1tZSddO1xyXG4gICAgICAgIHZhciBzaG93Q2xvbmVzID0gc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2hvdy1jbG9uZXMnXTtcclxuICAgICAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLnVwZGF0ZURhdGEoKTtcclxuICAgICAgICBzdGF0ZS5mb3JtVmlld3MudXBkYXRlQWxsKG1vZGVsLCAhIXNob3dNZSwgZmFsc2UpO1xyXG4gICAgICAgIGlmIChzaG93Q2xvbmVzKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmNsb25lRm9ybVZpZXdzLnVwZGF0ZUFsbChtb2RlbCwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgc3RhdGUuY2xvbmVGb3JtVmlld3MucmVzaXplKDApO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLm1ha2VFbXB0eVN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGZvcm1WaWV3czogbmV3IEZvcm1WaWV3QXJyYXkoKSxcclxuICAgICAgICAgICAgY2xvbmVGb3JtVmlld3M6IG5ldyBGb3JtVmlld0FycmF5KCksXHJcbiAgICAgICAgICAgIGFsbG93VXBkYXRlOiBmYWxzZSxcclxuICAgICAgICAgICAgcGNXb3JsZE9yQ2VsbDogMCxcclxuICAgICAgICAgICAgY291bnRlcjogZmFsc2UsXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gV29ybGRWaWV3O1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFdvcmxkVmlldyB9O1xyXG4iLCJpbXBvcnQgeyBHYW1lLCBPYmplY3RSZWZlcmVuY2UsIHN0b3JhZ2UgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgU3BBcGlJbnRlcmFjdG9yIH0gZnJvbSAnLi4vc2VydmljZXMvc3BBcGlJbnRlcmFjdG9yJztcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NlcnZpY2VzL3JlbW90ZVNlcnZlclwiO1xyXG5leHBvcnQgdmFyIGdldFZpZXdGcm9tU3RvcmFnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciByZXMgPSBzdG9yYWdlW1widmlld1wiXTtcclxuICAgIC8vIGNhbid0IHVzZSBpbnN0YW5jZW9mIGhlcmUgYmVjYXVzZSBlYWNoIGhvdCByZWxvYWQgY3JlYXRlcyBhIG5ldyBjbGFzc1xyXG4gICAgaWYgKHR5cGVvZiByZXMgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxufTtcclxuZXhwb3J0IHZhciBsb2NhbElkVG9SZW1vdGVJZCA9IGZ1bmN0aW9uIChsb2NhbEZvcm1JZCwgbmV3Q2FzdCkge1xyXG4gICAgaWYgKG5ld0Nhc3QgPT09IHZvaWQgMCkgeyBuZXdDYXN0ID0gZmFsc2U7IH1cclxuICAgIGlmIChuZXdDYXN0ICYmIGxvY2FsRm9ybUlkID09IDB4MTQpIHtcclxuICAgICAgICByZXR1cm4gU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmxvb2t1cExpc3RlbmVyKFJlbW90ZVNlcnZlcikuZ2V0TXlSZW1vdGVSZWZySWQoKTtcclxuICAgIH1cclxuICAgIGlmIChsb2NhbEZvcm1JZCA+PSAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgdmFyIHZpZXcgPSBnZXRWaWV3RnJvbVN0b3JhZ2UoKTtcclxuICAgICAgICBpZiAoIXZpZXcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvY2FsRm9ybUlkID0gdmlldy5nZXRSZW1vdGVSZWZySWQobG9jYWxGb3JtSWQpO1xyXG4gICAgICAgIGlmICghbG9jYWxGb3JtSWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHNlcnZlcnNpZGUgaWRzIGFyZSA2NGJpdFxyXG4gICAgICAgIGlmIChsb2NhbEZvcm1JZCA+PSAweDEwMDAwMDAwMCkge1xyXG4gICAgICAgICAgICBsb2NhbEZvcm1JZCAtPSAweDEwMDAwMDAwMDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbG9jYWxGb3JtSWQ7XHJcbn07XHJcbmV4cG9ydCB2YXIgcmVtb3RlSWRUb0xvY2FsSWQgPSBmdW5jdGlvbiAocmVtb3RlRm9ybUlkKSB7XHJcbiAgICBpZiAocmVtb3RlRm9ybUlkID49IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICB2YXIgdmlldyA9IGdldFZpZXdGcm9tU3RvcmFnZSgpO1xyXG4gICAgICAgIGlmICghdmlldykge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVtb3RlRm9ybUlkID0gdmlldy5nZXRMb2NhbFJlZnJJZChyZW1vdGVGb3JtSWQpO1xyXG4gICAgICAgIGlmICghcmVtb3RlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZW1vdGVGb3JtSWQ7XHJcbn07XHJcbmV4cG9ydCB2YXIgZ2V0T2JqZWN0UmVmZXJlbmNlID0gZnVuY3Rpb24gKGkpIHtcclxuICAgIHZhciB2aWV3ID0gZ2V0Vmlld0Zyb21TdG9yYWdlKCk7XHJcbiAgICBpZiAodmlldykge1xyXG4gICAgICAgIHZhciBmb3JtVmlldyA9IHZpZXcuZ2V0Rm9ybVZpZXdzKCkuZ2V0TnRoRm9ybVZpZXcoaSk7XHJcbiAgICAgICAgaWYgKGZvcm1WaWV3KSB7XHJcbiAgICAgICAgICAgIHZhciByZWZySWQgPSBmb3JtVmlldy5nZXRMb2NhbFJlZnJJZCgpO1xyXG4gICAgICAgICAgICBpZiAocmVmcklkID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZWZyICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZnI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxufTtcclxuIiwibW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKFwiY3J5cHRvXCIpOyIsIm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShcImZzXCIpOyIsIm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShcImluc3BlY3RvclwiKTsiLCJtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoXCJub2RlOmNyeXB0b1wiKTsiLCJtb2R1bGUuZXhwb3J0cyA9IHNreXJpbVBsYXRmb3JtOyIsImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnLi9pbmRleC5qcydcblxuZXhwb3J0IHsgRXZlbnRFbWl0dGVyIH1cbmV4cG9ydCBkZWZhdWx0IEV2ZW50RW1pdHRlclxuIiwiLy8gVGhlIG1vZHVsZSBjYWNoZVxudmFyIF9fd2VicGFja19tb2R1bGVfY2FjaGVfXyA9IHt9O1xuXG4vLyBUaGUgcmVxdWlyZSBmdW5jdGlvblxuZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkge1xuXHQvLyBDaGVjayBpZiBtb2R1bGUgaXMgaW4gY2FjaGVcblx0dmFyIGNhY2hlZE1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF07XG5cdGlmIChjYWNoZWRNb2R1bGUgIT09IHVuZGVmaW5lZCkge1xuXHRcdHJldHVybiBjYWNoZWRNb2R1bGUuZXhwb3J0cztcblx0fVxuXHQvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKVxuXHR2YXIgbW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXSA9IHtcblx0XHQvLyBubyBtb2R1bGUuaWQgbmVlZGVkXG5cdFx0Ly8gbm8gbW9kdWxlLmxvYWRlZCBuZWVkZWRcblx0XHRleHBvcnRzOiB7fVxuXHR9O1xuXG5cdC8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvblxuXHRfX3dlYnBhY2tfbW9kdWxlc19fW21vZHVsZUlkXShtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTtcblxuXHQvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZVxuXHRyZXR1cm4gbW9kdWxlLmV4cG9ydHM7XG59XG5cbiIsIi8vIGdldERlZmF1bHRFeHBvcnQgZnVuY3Rpb24gZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBub24taGFybW9ueSBtb2R1bGVzXG5fX3dlYnBhY2tfcmVxdWlyZV9fLm4gPSAobW9kdWxlKSA9PiB7XG5cdHZhciBnZXR0ZXIgPSBtb2R1bGUgJiYgbW9kdWxlLl9fZXNNb2R1bGUgP1xuXHRcdCgpID0+IChtb2R1bGVbJ2RlZmF1bHQnXSkgOlxuXHRcdCgpID0+IChtb2R1bGUpO1xuXHRfX3dlYnBhY2tfcmVxdWlyZV9fLmQoZ2V0dGVyLCB7IGE6IGdldHRlciB9KTtcblx0cmV0dXJuIGdldHRlcjtcbn07IiwiLy8gZGVmaW5lIGdldHRlciBmdW5jdGlvbnMgZm9yIGhhcm1vbnkgZXhwb3J0c1xuX193ZWJwYWNrX3JlcXVpcmVfXy5kID0gKGV4cG9ydHMsIGRlZmluaXRpb24pID0+IHtcblx0Zm9yKHZhciBrZXkgaW4gZGVmaW5pdGlvbikge1xuXHRcdGlmKF9fd2VicGFja19yZXF1aXJlX18ubyhkZWZpbml0aW9uLCBrZXkpICYmICFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywga2V5KSkge1xuXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGRlZmluaXRpb25ba2V5XSB9KTtcblx0XHR9XG5cdH1cbn07IiwiX193ZWJwYWNrX3JlcXVpcmVfXy5vID0gKG9iaiwgcHJvcCkgPT4gKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSIsIi8vIGRlZmluZSBfX2VzTW9kdWxlIG9uIGV4cG9ydHNcbl9fd2VicGFja19yZXF1aXJlX18uciA9IChleHBvcnRzKSA9PiB7XG5cdGlmKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC50b1N0cmluZ1RhZykge1xuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICdNb2R1bGUnIH0pO1xuXHR9XG5cdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7XG59OyIsImltcG9ydCB7IEdhbWUsIFV0aWxpdHksIG9uY2UgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgU2t5bXBDbGllbnQgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9za3ltcENsaWVudFwiO1xyXG5pbXBvcnQgKiBhcyBzcCBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2VydmljZXMvYmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZSc7XHJcbmltcG9ydCB7IEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3NlcnZpY2VzL2VuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2UnO1xyXG5pbXBvcnQgeyBMb2FkR2FtZVNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3NlcnZpY2VzL2xvYWRHYW1lU2VydmljZSc7XHJcbmltcG9ydCB7IFNlbmRJbnB1dHNTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zZW5kSW5wdXRzU2VydmljZSc7XHJcbmltcG9ydCB7IFNpbmdsZVBsYXllclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3NlcnZpY2VzL3NpbmdsZVBsYXllclNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTcEFwaUludGVyYWN0b3IgfSBmcm9tICcuL3NlcnZpY2VzL3NwQXBpSW50ZXJhY3Rvcic7XHJcbmltcG9ydCB7IFRpbWVTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvdGltZVNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3BWZXJzaW9uQ2hlY2tTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENvbnNvbGVDb21tYW5kc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9jb25zb2xlQ29tbWFuZHNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IExhc3RJbnZTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvbGFzdEludlNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQWN0aXZhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9hY3RpdmF0aW9uU2VydmljZVwiO1xyXG5pbXBvcnQgeyBDcmFmdFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9jcmFmdFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgRHJvcEl0ZW1TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZHJvcEl0ZW1TZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEhpdFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9oaXRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFJhZ2RvbGxTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvcmFnZG9sbFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgRGVhdGhTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZGVhdGhTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENvbnRhaW5lcnNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvY29udGFpbmVyc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgTmV0d29ya2luZ1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9uZXR3b3JraW5nU2VydmljZVwiO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9yZW1vdGVTZXJ2ZXJcIjtcclxuaW1wb3J0IHsgU3BTbmlwcGV0U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3NwU25pcHBldFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9kaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZVwiO1xyXG5pbXBvcnQgeyBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9kaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgV29ybGRDbGVhbmVyU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3dvcmxkQ2xlYW5lclNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZVwiO1xyXG5pbXBvcnQgeyBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvbG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZVwiO1xyXG5pbXBvcnQgeyBCcm93c2VyU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Jyb3dzZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvYXV0aFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQ2hhcmFjdGVyU2VsZWN0U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2NoYXJhY3RlclNlbGVjdFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgTmV0SW5mb1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9uZXRJbmZvU2VydmljZVwiO1xyXG5pbXBvcnQgeyBBbmltRGVidWdTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvYW5pbURlYnVnU2VydmljZVwiO1xyXG5pbXBvcnQgeyBUaW1lcnNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvdGltZXJzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBQbGF5ZXJCb3dTaG90U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3BsYXllckJvd1Nob3RTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZ2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2VcIjtcclxuaW1wb3J0IHsgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEZyb250SG90UmVsb2FkU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Zyb250SG90UmVsb2FkU2VydmljZVwiO1xyXG5pbXBvcnQgeyBCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9ibG9ja2VkQW5pbWF0aW9uc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgVm9pY2VDaGF0U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3ZvaWNlQ2hhdFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgV29ybGRWaWV3IH0gZnJvbSBcIi4vdmlldy93b3JsZFZpZXdcIjtcclxuaW1wb3J0IHsgS2V5Ym9hcmRFdmVudHNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMva2V5Ym9hcmRFdmVudHNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IE1hZ2ljU3luY1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9tYWdpY1N5bmNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFByb2ZpbGluZ1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9wcm9maWxpbmdTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFNldHRpbmdzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3NldHRpbmdzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlXCI7XHJcbm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgVXRpbGl0eS5zZXRJTklCb29sKFwiYkFsd2F5c0FjdGl2ZTpHZW5lcmFsXCIsIHRydWUpO1xyXG4gICAgR2FtZS5zZXRHYW1lU2V0dGluZ0ludChcImlEZWF0aERyb3BXZWFwb25DaGFuY2VcIiwgMCk7XHJcbn0pO1xyXG52YXIgbWFpbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCk7XHJcbiAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtcclxuICAgICAgICAgICAgbmV3IEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgTG9hZEdhbWVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNpbmdsZVBsYXllclNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTZW5kSW5wdXRzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTa3ltcENsaWVudChzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBUaW1lU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTcFZlcnNpb25DaGVja1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQ29uc29sZUNvbW1hbmRzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBMYXN0SW52U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBBY3RpdmF0aW9uU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBDcmFmdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRHJvcEl0ZW1TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEhpdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgUmFnZG9sbFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRGVhdGhTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IENvbnRhaW5lcnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IE5ldHdvcmtpbmdTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFJlbW90ZVNlcnZlcihzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTcFNuaXBwZXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNldHRpbmdzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFdvcmxkQ2xlYW5lclNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBCcm93c2VyU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBBdXRoU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IE5ldEluZm9TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEFuaW1EZWJ1Z1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgVGltZXJzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBQbGF5ZXJCb3dTaG90U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBHYW1lbW9kZVVwZGF0ZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEJsb2NrZWRBbmltYXRpb25zU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBWb2ljZUNoYXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFdvcmxkVmlldyhzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBLZXlib2FyZEV2ZW50c1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgTWFnaWNTeW5jU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBQcm9maWxpbmdTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgXTtcclxuICAgICAgICBTcEFwaUludGVyYWN0b3Iuc2V0dXAobGlzdGVuZXJzKTtcclxuICAgIH1cclxuICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgLy8gVE9ETzogaGFuZGxlIHNldHVwIGZhaWx1cmUuIHdpbGwgb3V0cHV0IHRvIGdhbWUgY29uc29sZSBieSBkZWZhdWx0XHJcbiAgICAgICAgdGhyb3cgZTtcclxuICAgIH1cclxufTtcclxuLy8gWzE4LjA4LjIwMjNdXHJcbi8vIEkgc2F3IFwiYXR0ZW1wdCB0byBjYWxsIGhvb2tzLmFkZCB3aGlsZSBpbiBob29rIGNvbnRleHRcIiBlcnJvclxyXG4vLyBJJ20gbm90IHN1cmUgaWYgaXQncyBhIEMrKyBidWcgaW4gU2t5cmltUGxhdGZvcm0gb3IgYW4gYXJ0aWZhY3Qgb2Ygd2VicGFjaytob3RyZWxvYWRcclxuLy8gQnV0IGxldCdzIGZvciBub3cgZW5zdXJlIHRoYXQgXCJtYWluXCIgZXhlY3V0ZXMgaW5zaWRlIHRpY2sgY29udGV4dFxyXG5vbmNlKFwidGlja1wiLCBtYWluKTtcclxuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9