/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./node_modules/eventemitter3/index.js":
/*!*********************************************!*\
  !*** ./node_modules/eventemitter3/index.js ***!
  \*********************************************/
/***/ ((module) => {



var has = Object.prototype.hasOwnProperty
  , prefix = '~';

/**
 * Constructor to create a storage for our `EE` objects.
 * An `Events` instance is a plain object whose properties are event names.
 *
 * @constructor
 * @private
 */
function Events() {}

//
// We try to not inherit from `Object.prototype`. In some engines creating an
// instance in this way is faster than calling `Object.create(null)` directly.
// If `Object.create(null)` is not supported we prefix the event names with a
// character to make sure that the built-in object properties are not
// overridden or used as an attack vector.
//
if (Object.create) {
  Events.prototype = Object.create(null);

  //
  // This hack is needed because the `__proto__` property is still inherited in
  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.
  //
  if (!new Events().__proto__) prefix = false;
}

/**
 * Representation of a single event listener.
 *
 * @param {Function} fn The listener function.
 * @param {*} context The context to invoke the listener with.
 * @param {Boolean} [once=false] Specify if the listener is a one-time listener.
 * @constructor
 * @private
 */
function EE(fn, context, once) {
  this.fn = fn;
  this.context = context;
  this.once = once || false;
}

/**
 * Add a listener for a given event.
 *
 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} context The context to invoke the listener with.
 * @param {Boolean} once Specify if the listener is a one-time listener.
 * @returns {EventEmitter}
 * @private
 */
function addListener(emitter, event, fn, context, once) {
  if (typeof fn !== 'function') {
    throw new TypeError('The listener must be a function');
  }

  var listener = new EE(fn, context || emitter, once)
    , evt = prefix ? prefix + event : event;

  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;
  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);
  else emitter._events[evt] = [emitter._events[evt], listener];

  return emitter;
}

/**
 * Clear event by name.
 *
 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
 * @param {(String|Symbol)} evt The Event name.
 * @private
 */
function clearEvent(emitter, evt) {
  if (--emitter._eventsCount === 0) emitter._events = new Events();
  else delete emitter._events[evt];
}

/**
 * Minimal `EventEmitter` interface that is molded against the Node.js
 * `EventEmitter` interface.
 *
 * @constructor
 * @public
 */
function EventEmitter() {
  this._events = new Events();
  this._eventsCount = 0;
}

/**
 * Return an array listing the events for which the emitter has registered
 * listeners.
 *
 * @returns {Array}
 * @public
 */
EventEmitter.prototype.eventNames = function eventNames() {
  var names = []
    , events
    , name;

  if (this._eventsCount === 0) return names;

  for (name in (events = this._events)) {
    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);
  }

  if (Object.getOwnPropertySymbols) {
    return names.concat(Object.getOwnPropertySymbols(events));
  }

  return names;
};

/**
 * Return the listeners registered for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Array} The registered listeners.
 * @public
 */
EventEmitter.prototype.listeners = function listeners(event) {
  var evt = prefix ? prefix + event : event
    , handlers = this._events[evt];

  if (!handlers) return [];
  if (handlers.fn) return [handlers.fn];

  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {
    ee[i] = handlers[i].fn;
  }

  return ee;
};

/**
 * Return the number of listeners listening to a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Number} The number of listeners.
 * @public
 */
EventEmitter.prototype.listenerCount = function listenerCount(event) {
  var evt = prefix ? prefix + event : event
    , listeners = this._events[evt];

  if (!listeners) return 0;
  if (listeners.fn) return 1;
  return listeners.length;
};

/**
 * Calls each of the listeners registered for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @returns {Boolean} `true` if the event had listeners, else `false`.
 * @public
 */
EventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {
  var evt = prefix ? prefix + event : event;

  if (!this._events[evt]) return false;

  var listeners = this._events[evt]
    , len = arguments.length
    , args
    , i;

  if (listeners.fn) {
    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);

    switch (len) {
      case 1: return listeners.fn.call(listeners.context), true;
      case 2: return listeners.fn.call(listeners.context, a1), true;
      case 3: return listeners.fn.call(listeners.context, a1, a2), true;
      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;
      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;
      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;
    }

    for (i = 1, args = new Array(len -1); i < len; i++) {
      args[i - 1] = arguments[i];
    }

    listeners.fn.apply(listeners.context, args);
  } else {
    var length = listeners.length
      , j;

    for (i = 0; i < length; i++) {
      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);

      switch (len) {
        case 1: listeners[i].fn.call(listeners[i].context); break;
        case 2: listeners[i].fn.call(listeners[i].context, a1); break;
        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;
        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;
        default:
          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {
            args[j - 1] = arguments[j];
          }

          listeners[i].fn.apply(listeners[i].context, args);
      }
    }
  }

  return true;
};

/**
 * Add a listener for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} [context=this] The context to invoke the listener with.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.on = function on(event, fn, context) {
  return addListener(this, event, fn, context, false);
};

/**
 * Add a one-time listener for a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn The listener function.
 * @param {*} [context=this] The context to invoke the listener with.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.once = function once(event, fn, context) {
  return addListener(this, event, fn, context, true);
};

/**
 * Remove the listeners of a given event.
 *
 * @param {(String|Symbol)} event The event name.
 * @param {Function} fn Only remove the listeners that match this function.
 * @param {*} context Only remove the listeners that have this context.
 * @param {Boolean} once Only remove one-time listeners.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {
  var evt = prefix ? prefix + event : event;

  if (!this._events[evt]) return this;
  if (!fn) {
    clearEvent(this, evt);
    return this;
  }

  var listeners = this._events[evt];

  if (listeners.fn) {
    if (
      listeners.fn === fn &&
      (!once || listeners.once) &&
      (!context || listeners.context === context)
    ) {
      clearEvent(this, evt);
    }
  } else {
    for (var i = 0, events = [], length = listeners.length; i < length; i++) {
      if (
        listeners[i].fn !== fn ||
        (once && !listeners[i].once) ||
        (context && listeners[i].context !== context)
      ) {
        events.push(listeners[i]);
      }
    }

    //
    // Reset the array, or remove it completely if we have no more listeners.
    //
    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;
    else clearEvent(this, evt);
  }

  return this;
};

/**
 * Remove all listeners, or those of the specified event.
 *
 * @param {(String|Symbol)} [event] The event name.
 * @returns {EventEmitter} `this`.
 * @public
 */
EventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {
  var evt;

  if (event) {
    evt = prefix ? prefix + event : event;
    if (this._events[evt]) clearEvent(this, evt);
  } else {
    this._events = new Events();
    this._eventsCount = 0;
  }

  return this;
};

//
// Alias methods names because people roll like that.
//
EventEmitter.prototype.off = EventEmitter.prototype.removeListener;
EventEmitter.prototype.addListener = EventEmitter.prototype.on;

//
// Expose the prefix.
//
EventEmitter.prefixed = prefix;

//
// Allow `EventEmitter` to be imported as module namespace.
//
EventEmitter.EventEmitter = EventEmitter;

//
// Expose the module.
//
if (true) {
  module.exports = EventEmitter;
}


/***/ }),

/***/ "./src/extensions/formTypeEx.ts":
/*!**************************************!*\
  !*** ./src/extensions/formTypeEx.ts ***!
  \**************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormTypeEx: () => (/* binding */ FormTypeEx)
/* harmony export */ });
var FormTypeEx = /** @class */ (function () {
    function FormTypeEx() {
    }
    FormTypeEx.isItem = function (type) {
        return type === 42 /* FormType.Ammo */ ||
            type === 26 /* FormType.Armor */ ||
            type === 27 /* FormType.Book */ ||
            type === 30 /* FormType.Ingredient */ ||
            type === 31 /* FormType.Light */ ||
            type === 46 /* FormType.Potion */ ||
            type === 23 /* FormType.ScrollItem */ ||
            type === 52 /* FormType.SoulGem */ ||
            type === 41 /* FormType.Weapon */ ||
            type === 32 /* FormType.Misc */;
    };
    return FormTypeEx;
}());



/***/ }),

/***/ "./src/extensions/objectReferenceEx.ts":
/*!*********************************************!*\
  !*** ./src/extensions/objectReferenceEx.ts ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ObjectReferenceEx: () => (/* binding */ ObjectReferenceEx)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _formTypeEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./formTypeEx */ "./src/extensions/formTypeEx.ts");


var ObjectReferenceEx = /** @class */ (function () {
    function ObjectReferenceEx() {
    }
    ObjectReferenceEx.getWorldOrCell = function (self) {
        var world = self.getWorldSpace();
        if (world) {
            return world.getFormID();
        }
        var cell = self.getParentCell();
        if (cell) {
            return cell.getFormID();
        }
        return 0;
    };
    ObjectReferenceEx.getPos = function (self) {
        return [self.getPositionX(), self.getPositionY(), self.getPositionZ()];
    };
    ;
    ObjectReferenceEx.getDistance = function (a, b) {
        var deltaX = a[0] - b[0];
        var deltaY = a[1] - b[1];
        var deltaZ = a[2] - b[2];
        return Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
    };
    ;
    ObjectReferenceEx.getDistanceNoZ = function (a, b) {
        var deltaX = a[0] - b[0];
        var deltaY = a[1] - b[1];
        return Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    };
    ;
    ObjectReferenceEx.dealWithRef = function (self, base) {
        var _a, _b;
        var t = base.getType();
        var isItem = _formTypeEx__WEBPACK_IMPORTED_MODULE_1__.FormTypeEx.isItem(t);
        // BlackFallsBarrow02, door isn't opening via SetOpen so we're hacking it.
        // Not blocking activation & asking parent to activate until will be in the correct state
        // See also modelApplyUtils.ts
        var caveGSecretDoor01 = 0x6f703;
        // You can also block for t === FormType.Flora || t === FormType.Tree, but I don't think it's necessary.
        if (t === 40 /* FormType.Furniture */
            || t === 24 /* FormType.Activator */
            || t === 28 /* FormType.Container */
            || isItem
            || t === 43 /* FormType.NPC */
            || (t === 29 /* FormType.Door */ && ((_a = self.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) !== caveGSecretDoor01)) {
            self.blockActivation(true);
        }
        else {
            self.blockActivation(false);
        }
        if (self.isLocked()) {
            self.lock(false, false);
        }
        if (isItem) {
            self.setMotionType(4 /* MotionType.Keyframed */, false);
        }
        // https://github.com/skyrim-multiplayer/issue-tracker/issues/36
        if (t === 39 /* FormType.Flora */ && ((_b = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Flora.from(base)) === null || _b === void 0 ? void 0 : _b.getIngredient())) {
            self.setMotionType(4 /* MotionType.Keyframed */, false);
        }
    };
    return ObjectReferenceEx;
}());



/***/ }),

/***/ "./src/features/authModel.ts":
/*!***********************************!*\
  !*** ./src/features/authModel.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   authGameDataStorageKey: () => (/* binding */ authGameDataStorageKey)
/* harmony export */ });
;
;
;
var authGameDataStorageKey = "authGameData";


/***/ }),

/***/ "./src/lib/errors.ts":
/*!***************************!*\
  !*** ./src/lib/errors.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NeverError: () => (/* binding */ NeverError),
/* harmony export */   RespawnNeededError: () => (/* binding */ RespawnNeededError)
/* harmony export */ });
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var RespawnNeededError = /** @class */ (function (_super) {
    __extends(RespawnNeededError, _super);
    function RespawnNeededError(message) {
        var _this = _super.call(this, message) || this;
        Object.setPrototypeOf(_this, RespawnNeededError.prototype);
        return _this;
    }
    return RespawnNeededError;
}(Error));

var NeverError = /** @class */ (function (_super) {
    __extends(NeverError, _super);
    function NeverError(message) {
        var _this = _super.call(this, "NeverError: ".concat(JSON.stringify(message))) || this;
        Object.setPrototypeOf(_this, NeverError.prototype);
        return _this;
    }
    return NeverError;
}(Error));



/***/ }),

/***/ "./src/lib/idManager.ts":
/*!******************************!*\
  !*** ./src/lib/idManager.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   IdManager: () => (/* binding */ IdManager)
/* harmony export */ });
var IdManager = /** @class */ (function () {
    function IdManager() {
        this.idByValue = new Array();
        this.valueById = new Array();
        this.minimumUnusedId = 0;
    }
    IdManager.prototype.allocateIdFor = function (value) {
        if (this.idByValue.length <= value) {
            this.idByValue.length = value + 1;
        }
        this.idByValue[value] = this.minimumUnusedId;
        if (this.valueById.length <= this.minimumUnusedId) {
            this.valueById.length = this.minimumUnusedId + 1;
        }
        this.valueById[this.minimumUnusedId] = value;
        var res = this.minimumUnusedId;
        this.minimumUnusedId++;
        while (this.valueById.length > this.minimumUnusedId &&
            typeof this.valueById[this.minimumUnusedId] === "number") {
            this.minimumUnusedId++;
        }
        return res;
    };
    IdManager.prototype.freeIdFor = function (value) {
        var id = this.idByValue[value];
        if (id < this.minimumUnusedId) {
            this.minimumUnusedId = id;
        }
        this.idByValue[value] = undefined;
        this.valueById[id] = undefined;
        return;
    };
    IdManager.prototype.getId = function (value) {
        var r = this.idByValue[value];
        return typeof r === "number" ? r : -1;
    };
    IdManager.prototype.getValueById = function (id) {
        return this.valueById[id];
    };
    return IdManager;
}());



/***/ }),

/***/ "./src/lib/nameof.ts":
/*!***************************!*\
  !*** ./src/lib/nameof.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   nameof: () => (/* binding */ nameof)
/* harmony export */ });
function nameof(key) {
    return key;
}


/***/ }),

/***/ "./src/logging.ts":
/*!************************!*\
  !*** ./src/logging.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   logError: () => (/* binding */ logError),
/* harmony export */   logTrace: () => (/* binding */ logTrace)
/* harmony export */ });
/* harmony import */ var _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @skyrim-platform/skyrim-platform */ "skyrimPlatform");
/* harmony import */ var _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__);
var __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};

// TODO: redirect this to spdlog
function logError(service) {
    var rest = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        rest[_i - 1] = arguments[_i];
    }
    var restProcessed = rest.map(function (item) {
        if (item instanceof Error) {
            return item.stack || item.message;
        }
        return item;
    });
    _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__.printConsole.apply(void 0, __spreadArray(["Error in ".concat(typeof service !== "string" ? service.constructor.name : service, ":")], restProcessed, false));
}
// TODO: redirect this to spdlog
function logTrace(service) {
    var rest = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        rest[_i - 1] = arguments[_i];
    }
    var restProcessed = rest.map(function (item) {
        if (item instanceof Error) {
            return item.stack || item.message;
        }
        return item;
    });
    _skyrim_platform_skyrim_platform__WEBPACK_IMPORTED_MODULE_0__.printConsole.apply(void 0, __spreadArray(["Trace in ".concat(typeof service !== "string" ? service.constructor.name : service, ":")], restProcessed, false));
}


/***/ }),

/***/ "./src/messages.ts":
/*!*************************!*\
  !*** ./src/messages.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   MsgType: () => (/* binding */ MsgType)
/* harmony export */ });
var MsgType;
(function (MsgType) {
    MsgType[MsgType["CustomPacket"] = 1] = "CustomPacket";
    MsgType[MsgType["UpdateMovement"] = 2] = "UpdateMovement";
    MsgType[MsgType["UpdateAnimation"] = 3] = "UpdateAnimation";
    MsgType[MsgType["UpdateAppearance"] = 4] = "UpdateAppearance";
    MsgType[MsgType["UpdateEquipment"] = 5] = "UpdateEquipment";
    MsgType[MsgType["Activate"] = 6] = "Activate";
    MsgType[MsgType["UpdateProperty"] = 7] = "UpdateProperty";
    MsgType[MsgType["PutItem"] = 8] = "PutItem";
    MsgType[MsgType["TakeItem"] = 9] = "TakeItem";
    MsgType[MsgType["FinishSpSnippet"] = 10] = "FinishSpSnippet";
    MsgType[MsgType["OnEquip"] = 11] = "OnEquip";
    MsgType[MsgType["ConsoleCommand"] = 12] = "ConsoleCommand";
    MsgType[MsgType["CraftItem"] = 13] = "CraftItem";
    MsgType[MsgType["Host"] = 14] = "Host";
    MsgType[MsgType["CustomEvent"] = 15] = "CustomEvent";
    MsgType[MsgType["ChangeValues"] = 16] = "ChangeValues";
    MsgType[MsgType["OnHit"] = 17] = "OnHit";
    MsgType[MsgType["DeathStateContainer"] = 18] = "DeathStateContainer";
    MsgType[MsgType["DropItem"] = 19] = "DropItem";
    MsgType[MsgType["Teleport"] = 20] = "Teleport";
    MsgType[MsgType["OpenContainer"] = 21] = "OpenContainer";
    MsgType[MsgType["PlayerBowShot"] = 22] = "PlayerBowShot";
    MsgType[MsgType["SpellCast"] = 23] = "SpellCast";
    MsgType[MsgType["UpdateAnimVariables"] = 24] = "UpdateAnimVariables";
    // ex-strings
    MsgType[MsgType["DestroyActor"] = 25] = "DestroyActor";
    MsgType[MsgType["HostStart"] = 26] = "HostStart";
    MsgType[MsgType["HostStop"] = 27] = "HostStop";
    MsgType[MsgType["SetInventory"] = 28] = "SetInventory";
    MsgType[MsgType["SetRaceMenuOpen"] = 29] = "SetRaceMenuOpen";
    MsgType[MsgType["SpSnippet"] = 30] = "SpSnippet";
    MsgType[MsgType["Teleport2"] = 31] = "Teleport2";
    MsgType[MsgType["UpdateGamemodeData"] = 32] = "UpdateGamemodeData";
    MsgType[MsgType["CreateActor"] = 33] = "CreateActor";
    MsgType[MsgType["VoiceChatMessage"] = 34] = "VoiceChatMessage";
    MsgType[MsgType["UpdateVoiceChatMessage"] = 35] = "UpdateVoiceChatMessage";
})(MsgType || (MsgType = {}));


/***/ }),

/***/ "./src/services/events/events.ts":
/*!***************************************!*\
  !*** ./src/services/events/events.ts ***!
  \***************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EventEmitterFactory: () => (/* binding */ EventEmitterFactory)
/* harmony export */ });
/* harmony import */ var eventemitter3__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! eventemitter3 */ "./node_modules/eventemitter3/index.mjs");

var EventEmitterFactory = /** @class */ (function () {
    function EventEmitterFactory() {
    }
    EventEmitterFactory.makeEventEmitter = function () {
        return (new eventemitter3__WEBPACK_IMPORTED_MODULE_0__.EventEmitter());
    };
    return EventEmitterFactory;
}());



/***/ }),

/***/ "./src/services/services/activationService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/activationService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ActivationService: () => (/* binding */ ActivationService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _lastInvService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// TODO: refactor this out



var ActivationService = /** @class */ (function (_super) {
    __extends(ActivationService, _super);
    function ActivationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("activate", function (e) { return _this.onActivate(e); });
        return _this;
    }
    ActivationService.prototype.onActivate = function (e) {
        var lastInvService = this.controller.lookupListener(_lastInvService__WEBPACK_IMPORTED_MODULE_4__.LastInvService);
        lastInvService.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_2__.getInventory)(this.sp.Game.getPlayer());
        var caster = e.caster ? e.caster.getFormID() : 0;
        var target = e.target ? e.target.getFormID() : 0;
        if (!target || !caster) {
            return;
        }
        // Actors never have non-ff ids locally in skymp
        if (caster !== 0x14 && caster < 0xff000000) {
            return;
        }
        target = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__.localIdToRemoteId)(target);
        if (!target) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logError)(this, 'localIdToRemoteId returned 0 (target) in on(\'activate\')');
            return;
        }
        caster = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_3__.localIdToRemoteId)(caster);
        if (!caster) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logError)(this, 'localIdToRemoteId returned 0 (caster) in on(\'activate\')');
            return;
        }
        var openState = e.target.getOpenState();
        if (openState === 2 /* OpenState.Opening */ || openState === 4 /* OpenState.Closing */) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Ignoring activation of door because it's already opening or closing");
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.Activate,
                data: { caster: caster, target: target, isSecondActivation: false }
            },
            reliability: "reliable"
        });
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Sent activation for caster=", caster.toString(16), "and target=", target.toString(16));
    };
    return ActivationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/animDebugService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/animDebugService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnimDebugService: () => (/* binding */ AnimDebugService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__);
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};



var playerId = 0x14;
var AnimDebugService = /** @class */ (function (_super) {
    __extends(AnimDebugService, _super);
    function AnimDebugService(sp, controller) {
        var _this = this;
        var _a;
        _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.settings = _this.sp.settings["skymp5-client"]["animDebug"];
        // clear previous texts in case of hotreload
        if (_this.sp.storage[AnimQueueCollection.Name] && _this.sp.storage[AnimQueueCollection.Name].clearSPText) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Destroying old AnimQueueCollection");
            try {
                _this.sp.storage[AnimQueueCollection.Name].clearSPText();
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Failed to destroy old AnimQueueCollection:", e);
            }
        }
        var self = _this;
        _this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) { },
            leave: function (ctx) {
                self.onSendAnimationEventLeave(ctx);
            }
        }, playerId, playerId);
        if (!_this.settings || !_this.settings.isActive) {
            return _this;
        }
        if ((_a = _this.settings.textOutput) === null || _a === void 0 ? void 0 : _a.isActive) {
            _this.queue = new AnimQueueCollection(_this.sp, _this.settings);
            _this.sp.storage[AnimQueueCollection.name] = _this.queue;
        }
        return _this;
    }
    AnimDebugService.prototype.onSendAnimationEventLeave = function (ctx) {
        if (this.queue === undefined) {
            return;
        }
        this.queue.push(ctx.animEventName, ctx.animationSucceeded ? animationSucceededTextColor : animationNotSucceededTextColor);
    };
    return AnimDebugService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

var animationSucceededTextColor = [255, 255, 255, 1];
var animationNotSucceededTextColor = [255, 0, 0, 1];
var AnimQueueCollection = /** @class */ (function () {
    function AnimQueueCollection(sp, settings) {
        var _a, _b, _c, _d, _e, _f;
        this.sp = sp;
        var arrayLength = (_b = (_a = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _a === void 0 ? void 0 : _a.itemCount) !== null && _b !== void 0 ? _b : 5;
        var startPos = (_d = (_c = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _c === void 0 ? void 0 : _c.startPos) !== null && _d !== void 0 ? _d : { x: 650, y: 600 };
        ;
        var yPosDelta = (_f = (_e = settings === null || settings === void 0 ? void 0 : settings.textOutput) === null || _e === void 0 ? void 0 : _e.yPosDelta) !== null && _f !== void 0 ? _f : 32;
        var y = startPos.y;
        this.list = new Array(arrayLength);
        for (var idx = 0; idx < arrayLength; ++idx) {
            this.list[idx] = { name: "", textId: sp.createText(startPos.x, y, "", animationSucceededTextColor), color: animationSucceededTextColor };
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_2__.setTextSize)(this.list[idx].textId, 0.5);
            y += yPosDelta;
        }
    }
    AnimQueueCollection.prototype.clearSPText = function () {
        var _this = this;
        if (this.list.length === 0) {
            return;
        }
        this.list.forEach(function (item) { return _this.sp.destroyText(item.textId); });
    };
    AnimQueueCollection.prototype.push = function (animName, color) {
        var prevItem = null;
        for (var idx = this.list.length - 1; idx >= 0; --idx) {
            var item = this.list[idx];
            prevItem = __assign({}, item);
            item.name = animName;
            item.color = color;
            this.sp.setTextString(item.textId, item.name);
            this.sp.setTextColor(item.textId, item.color);
            animName = prevItem.name;
            color = prevItem.color;
        }
    };
    AnimQueueCollection.Name = "AnimQueueCollection";
    return AnimQueueCollection;
}());


/***/ }),

/***/ "./src/services/services/authService.ts":
/*!**********************************************!*\
  !*** ./src/services/services/authService.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AuthService: () => (/* binding */ AuthService)
/* harmony export */ });
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! crypto */ "crypto");
/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _timersService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _characterSelectService__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./characterSelectService */ "./src/services/services/characterSelectService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();









// Define as module-level variables instead of global declarations
var window = global.window || globalThis.window || {};
// Constants used on both client and browser side (see browsersideWidgetSetter)
var events = {
    openDiscordOauth: 'openDiscordOauth',
    authAttempt: 'authAttemptEvent',
    openGithub: 'openGithub',
    openPatreon: 'openPatreon',
    clearAuthData: 'clearAuthData',
    updateRequired: 'updateRequired',
    backToLogin: 'backToLogin',
    joinDiscord: 'joinDiscord',
    hideBrowser: 'hideBrowser',
};
// Vaiables used on both client and browser side (see browsersideWidgetSetter)
var browserState = {
    comment: '',
    failCount: 9000,
    loginFailedReason: '',
};
var authData = null;
var AuthService = /** @class */ (function (_super) {
    __extends(AuthService, _super);
    function AuthService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.deniedWidgetSetter = function () {
            var widget = {
                type: "form",
                id: 2,
                caption: "Update Available",
                elements: [
                    {
                        type: "text",
                        text: "hooray! update released",
                        tags: []
                    },
                    {
                        type: "text",
                        text: "download now at",
                        tags: []
                    },
                    {
                        type: "text",
                        text: "skymp.net",
                        tags: []
                    },
                    {
                        type: "button",
                        text: "open skymp.net",
                        tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                        click: function () { return window.skyrimPlatform.sendMessage(events.updateRequired); },
                        hint: "Go to download page",
                    }
                ]
            };
            window.skyrimPlatform.widgets.set([widget]);
            // Make sure gamemode will not be able to update widgets anymore
            window.skyrimPlatform.widgets = null;
        };
        _this.loginFailedWidgetSetter = function () {
            var splitParts = browserState.loginFailedReason.split('\n');
            var textElements = splitParts.map(function (part) { return ({
                type: "text",
                text: part,
                tags: [],
            }); });
            var widget = {
                type: "form",
                id: 2,
                caption: "Error",
                elements: new Array()
            };
            textElements.forEach(function (element) { return widget.elements.push(element); });
            if (browserState.loginFailedReason === 'please join the discord server') {
                widget.elements.push({
                    type: "button",
                    text: "Join Server",
                    tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.joinDiscord); },
                    hint: null
                });
            }
            widget.elements.push({
                type: "button",
                text: "Back",
                tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                click: function () { return window.skyrimPlatform.sendMessage(events.backToLogin); },
                hint: undefined
            });
            if (window.skyrimPlatform && window.skyrimPlatform.widgets) {
                window.skyrimPlatform.widgets.set([widget]);
            }
        };
        _this.loginWidgetSetter = function () {
            // Note: isConnecting is injected via getText() wrapper
            // @ts-ignore - isConnecting is provided by FunctionInfo.getText()
            var connecting = isConnecting;
            var authDataUsername = authData ? (authData.discordUsername
                ? authData.discordUsername
                : "id: ".concat(authData.masterApiId)) : "not authorized";
            var buttonText = authData ? "Change Account" : "Login via Discord";
            var elements = [
                {
                    type: "text",
                    text: authDataUsername,
                    tags: [],
                }
            ];
            // Only show buttons if not connecting
            if (!connecting) {
                elements.push({
                    type: "button",
                    text: buttonText,
                    tags: ["ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.openDiscordOauth); },
                    hint: "You can login or change account",
                });
                elements.push({
                    type: "button",
                    text: "Connect",
                    tags: ["BUTTON_STYLE_FRAME", "ELEMENT_STYLE_MARGIN_EXTENDED"],
                    click: function () { return window.skyrimPlatform.sendMessage(events.authAttempt); },
                    hint: "Connect to game server",
                });
            }
            // Always show status text
            elements.push({
                type: "text",
                text: browserState.comment,
                tags: [],
            });
            var loginWidget = {
                type: "form",
                id: 1,
                caption: "Authentication",
                elements: elements
            };
            window.skyrimPlatform.widgets.set([loginWidget]);
        };
        _this.browsersideWidgetSetter = function () {
            var loginWidget = {
                type: "form",
                id: 1,
                caption: "Authentication",
                elements: [
                    {
                        type: "text",
                        text: (authData ? (authData.discordUsername
                            ? "".concat(authData.discordUsername)
                            : "id: ".concat(authData.masterApiId)) : "not authorized"),
                        tags: [],
                    },
                    {
                        type: "button",
                        text: authData ? "Change Account" : "Login via Discord",
                        tags: [],
                        click: function () { return window.skyrimPlatform.sendMessage(events.openDiscordOauth); },
                        hint: "You can login or change account",
                    },
                    {
                        type: "button",
                        text: "Connect",
                        tags: ["BUTTON_STYLE_FRAME", "ELEMENT_STYLE_MARGIN_EXTENDED"],
                        click: function () { return window.skyrimPlatform.sendMessage(events.authAttempt); },
                        hint: "Connect to game server",
                    },
                    {
                        type: "text",
                        text: browserState.comment,
                        tags: [],
                    },
                ]
            };
            window.skyrimPlatform.widgets.set([loginWidget]);
        };
        _this._isListenBrowserMessage = false;
        _this.trigger = {
            authNeededFired: false,
            browserWindowLoadedFired: false,
            get conditionMet() {
                return this.authNeededFired && this.browserWindowLoadedFired;
            }
        };
        _this.discordAuthState = crypto__WEBPACK_IMPORTED_MODULE_0__.randomBytes(32).toString('hex');
        _this.authDialogOpen = false;
        _this.loggingStartMoment = 0;
        _this.authAttemptProgressIndicator = false;
        _this.authAttemptProgressIndicatorCounter = 0;
        _this.lastSlowCounter = -1;
        _this.playerEverSawActualGameplay = false;
        _this.githubUrl = "https://github.com/skyrim-multiplayer/skymp";
        _this.patreonUrl = "https://www.patreon.com/skymp";
        _this.pluginAuthDataName = "auth-data-no-load";
        _this.controller.emitter.on("authNeeded", function (e) { return _this.onAuthNeeded(e); });
        _this.controller.emitter.on("browserWindowLoaded", function (e) { return _this.onBrowserWindowLoaded(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.emitter.on("connectionAccepted", function () { return _this.handleConnectionAccepted(); });
        _this.controller.emitter.on("connectionDenied", function (e) { return _this.handleConnectionDenied(e); });
        _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage(e); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    AuthService.prototype.onAuthNeeded = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received authNeeded event");
        this.setListenBrowserMessage(true, 'authNeeded received');
        // Try to read auth data from disk first
        authData = this.readAuthDataFromDisk();
        // If no auth file exists, check for offline mode settings
        if (!authData) {
            var settingsGameData = this.sp.settings["skymp5-client"]["gameData"];
            var hasOfflineSettings = Number.isInteger(settingsGameData === null || settingsGameData === void 0 ? void 0 : settingsGameData.profileId);
            if (hasOfflineSettings) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "No auth file found, using offline mode from settings with profileId:", settingsGameData.profileId);
                this.controller.emitter.emit("authAttempt", {
                    authGameData: {
                        local: {
                            profileId: settingsGameData.profileId,
                            accessToken: settingsGameData.accessToken
                        }
                    }
                });
                return;
            }
        }
        // Auth file exists or no offline settings - show login menu
        if (authData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth file found, showing login menu with existing auth data");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "No auth file and no offline settings, showing login menu");
        }
        this.setListenBrowserMessage(true, 'regular auth needed');
        // Show browser and load the UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        // Try to load the UI explicitly
        try {
            this.sp.browser.loadUrl("file:///Data/Platform/UI/index.html");
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Attempted to load UI from file:///Data/Platform/UI/index.html");
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Failed to load UI:", e);
        }
        // Set trigger flag and wait for browser to load
        this.trigger.authNeededFired = true;
        this.onBrowserWindowLoadedAndOnlineAuthNeeded();
    };
    AuthService.prototype.onBrowserWindowLoadedShowStartWindow = function (data) {
        var _a;
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        authData = data;
        (_a = this.sp.browser) === null || _a === void 0 ? void 0 : _a.executeJavaScript("window?.useMenuStore?.getState().onStart(".concat(JSON.stringify(data), ")"));
    };
    AuthService.prototype.onBrowserWindowLoaded = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received browserWindowLoaded event");
        this.trigger.browserWindowLoadedFired = true;
        this.onBrowserWindowLoadedAndOnlineAuthNeeded();
    };
    AuthService.prototype.onCreateActorMessage = function (e) {
        if (e.message.isMe) {
            if (this.authDialogOpen) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received createActorMessage for self, resetting widgets");
                this.sp.browser.executeJavaScript('window.skyrimPlatform.widgets.set([]);');
                this.authDialogOpen = false;
            }
            else {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Received createActorMessage for self, but auth dialog was not open so not resetting widgets");
            }
        }
        this.loggingStartMoment = 0;
        this.authAttemptProgressIndicator = false;
    };
    AuthService.prototype.onCustomPacketMessage = function (event) {
        var msg = event.message;
        var msgContent = {};
        try {
            msgContent = JSON.parse(msg.contentJsonDump);
        }
        catch (e) {
            if (e instanceof SyntaxError) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "onCustomPacketMessage failed to parse JSON", e.message, "json:", msg.contentJsonDump);
                return;
            }
            else {
                throw e;
            }
        }
        switch (msgContent["customPacketType"]) {
            // case 'loginRequired':
            //   logTrace(this, 'loginRequired received');
            //   this.loginWithSkympIoCredentials();
            //   break;
            case 'loginFailedNotLoggedViaDiscord':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedNotLoggedViaDiscord received');
                browserState.loginFailedReason = 'please login via discord';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedNotLoggedViaDiscord received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedNotInTheDiscordServer':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedNotInTheDiscordServer received');
                browserState.loginFailedReason = 'please join the discord server';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedNotInTheDiscordServer received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedBanned':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedBanned received');
                browserState.loginFailedReason = 'you are banned';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedBanned received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
            case 'loginFailedIpMismatch':
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'loginFailedIpMismatch received');
                browserState.loginFailedReason = 'what was that?';
                browserState.comment = '';
                this.setListenBrowserMessage(true, 'loginFailedIpMismatch received');
                this.loggingStartMoment = 0;
                this.refreshWidgets();
                break;
        }
    };
    AuthService.prototype.onBrowserWindowLoadedAndOnlineAuthNeeded = function () {
        var _this = this;
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "isListenBrowserMessage was false for some reason, aborting auth");
            return;
        }
        if (!this.trigger.conditionMet) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserWindowLoadedAndOnlineAuthNeeded waiting for both triggers to load");
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Showing widgets and starting loop");
        // Make sure auth data is loaded
        if (!authData) {
            authData = this.readAuthDataFromDisk();
        }
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
        // Delay initial state injection to ensure React is mounted
        var timersService = this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService);
        timersService.setTimeout(function () {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, 'Sending initial auth state to React UI');
            _this.refreshWidgets();
        }, 500);
        // Start Discord OAuth login state checking loop
        this.checkLoginState();
    };
    AuthService.prototype.onBrowserMessage = function (e) {
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserMessage: isListenBrowserMessage was false, ignoring message", JSON.stringify(e.arguments));
            return;
        }
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "onBrowserMessage:", JSON.stringify(e.arguments));
        var eventKey = e.arguments[0];
        switch (eventKey) {
            case events.openDiscordOauth:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "openDiscordOauth event received, opening browser");
                browserState.comment = 'opening browser...';
                this.refreshWidgets();
                var settingsService_1 = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
                var discordAuthBaseUrl = this.sp.settings["skymp5-client"]["discord-auth-url"] || "http://localhost:".concat(this.getServerPort());
                var discordAuthUrl = "".concat(discordAuthBaseUrl, "/api/users/login-discord?state=").concat(this.discordAuthState);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Loading Discord OAuth URL:", discordAuthUrl);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "win32 object:", this.sp.win32);
                try {
                    this.sp.win32.loadUrl(discordAuthUrl);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "win32.loadUrl called successfully");
                }
                catch (error) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Failed to call win32.loadUrl:", error);
                }
                // Launch checkLoginState loop
                this.checkLoginState();
                break;
            case events.authAttempt:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "authAttempt event received (Connect button clicked)");
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Current authData:", authData);
                if (authData === null) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "authData is null, cannot connect");
                    browserState.comment = 'please login first';
                    this.refreshWidgets();
                    break;
                }
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Emitting authAttempt event with authData:", JSON.stringify(authData));
                // Emit authAttempt event to trigger connection
                this.controller.emitter.emit("authAttempt", { authGameData: { remote: authData } });
                this.authAttemptProgressIndicator = true;
                break;
            case events.clearAuthData:
                // Doesn't seem to be used - launcher manages auth data
                break;
            case events.openGithub:
                this.sp.win32.loadUrl(this.githubUrl);
                break;
            case events.openPatreon:
                this.sp.win32.loadUrl(this.patreonUrl);
                break;
            case events.updateRequired:
                this.sp.win32.loadUrl("https://skymp.net/UpdInstall");
                break;
            case events.backToLogin:
                // Check if user manually went back from character select
                var characterSelectService = this.controller.lookupListener(_characterSelectService__WEBPACK_IMPORTED_MODULE_8__.CharacterSelectService);
                if (characterSelectService && characterSelectService.resetAuthState) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'User manually went back from character select, resetting auth state');
                    // Reset flag
                    characterSelectService.resetAuthState = false;
                    // Clear progress indicator to prevent auto-connect
                    this.authAttemptProgressIndicator = false;
                    // Clear logging start moment
                    this.loggingStartMoment = 0;
                    // Clear any error messages
                    browserState.loginFailedReason = '';
                    browserState.comment = '';
                }
                // Reload auth data from disk so user sees their previous account info
                authData = this.readAuthDataFromDisk();
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Reloaded auth data after Back button pressed:', authData ? 'found' : 'not found');
                // Refresh the React UI with updated auth state
                this.refreshWidgets();
                break;
            case events.joinDiscord:
                this.sp.win32.loadUrl("https://discord.gg/bstarrp");
                break;
            case 'requestAuthState':
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'React UI requesting auth state, sending current state');
                this.refreshWidgets();
                break;
            default:
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Unknown event key", eventKey);
                break;
        }
    };
    AuthService.prototype.createPlaySession = function (token, callback) {
        var client = new this.sp.HttpClient("http://localhost:".concat(this.getServerPort()));
        var route = "/api/users/me/play/main";
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Creating play session ".concat(route));
        client.post(route, {
            body: '{}',
            contentType: 'application/json',
            headers: {
                'authorization': "Bearer ".concat(token),
            },
            // @ts-ignore
        }, function (res) {
            if (res.status != 200) {
                callback('', 'status code ' + res.status);
            }
            else {
                // TODO: handle JSON.parse failure?
                callback(JSON.parse(res.body).session, '');
            }
        });
    };
    AuthService.prototype.checkLoginState = function () {
        var _this = this;
        if (!this.isListenBrowserMessage) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "checkLoginState: isListenBrowserMessage was false, aborting check");
            return;
        }
        var timersService = this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService);
        // Social engineering protection, don't show the full state
        var halfDiscordAuthState = this.discordAuthState.slice(0, 16);
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Checking login state", halfDiscordAuthState, '...');
        new this.sp.HttpClient("http://localhost:".concat(this.getServerPort()))
            .get("/api/users/login-discord/status?state=" + this.discordAuthState, undefined, 
        // @ts-ignore
        function (response) {
            switch (response.status) {
                case 200:
                    var _a = JSON.parse(response.body), token = _a.token, masterApiId_1 = _a.masterApiId, discordUsername_1 = _a.discordUsername, discordDiscriminator_1 = _a.discordDiscriminator, discordAvatar_1 = _a.discordAvatar;
                    browserState.failCount = 0;
                    _this.createPlaySession(token, function (playSession, error) {
                        if (error) {
                            browserState.failCount = 0;
                            browserState.comment = (error);
                            timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
                            _this.refreshWidgets();
                            return;
                        }
                        authData = {
                            session: playSession,
                            masterApiId: masterApiId_1,
                            discordUsername: discordUsername_1,
                            discordDiscriminator: discordDiscriminator_1,
                            discordAvatar: discordAvatar_1,
                        };
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Discord auth successful, authData set:", JSON.stringify(authData));
                        browserState.comment = 'connected successfully';
                        _this.refreshWidgets();
                    });
                    break;
                case 401: // Unauthorized
                    browserState.failCount = 0;
                    browserState.comment = ''; //(`Still waiting...`);
                    timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
                    break;
                case 403: // Forbidden
                case 404: // Not found
                    browserState.failCount = 9000;
                    browserState.comment = ("Fail: ".concat(response.body));
                    break;
                default:
                    ++browserState.failCount;
                    browserState.comment = "Server returned ".concat(response.status.toString() || "???", " \"").concat(response.body || response.error, "\"");
                    timersService.setTimeout(function () { return _this.checkLoginState(); }, Math.floor((1.5 + Math.random() * 2) * 1000));
            }
        });
    };
    ;
    AuthService.prototype.refreshWidgets = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'refreshAuthUI called');
        // Inject auth state into window for React UI
        var authState = {
            authData: authData,
            comment: browserState.comment,
            loginFailedReason: browserState.loginFailedReason,
            isConnecting: this.authAttemptProgressIndicator
        };
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.auth = ".concat(JSON.stringify(authState), ";\n      window.dispatchEvent(new CustomEvent('skymp:authUpdate', { detail: ").concat(JSON.stringify(authState), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
        this.authDialogOpen = true;
    };
    ;
    AuthService.prototype.readAuthDataFromDisk = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Reading", this.pluginAuthDataName, "from disk");
        try {
            // @ts-expect-error (TODO: Remove in 2.10.0)
            var data = this.sp.getPluginSourceCode(this.pluginAuthDataName, "PluginsNoLoad");
            if (!data) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Read empty", this.pluginAuthDataName, "returning null");
                return null;
            }
            return JSON.parse(data.slice(2)) || null;
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Error reading", this.pluginAuthDataName, "from disk:", e, ", falling back to null");
            return null;
        }
    };
    AuthService.prototype.writeAuthDataToDisk = function (data) {
        // Auth data writing is handled by the launcher, client only reads
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth data writing disabled - launcher manages auth data");
    };
    ;
    AuthService.prototype.handleConnectionDenied = function (e) {
        var _this = this;
        this.authAttemptProgressIndicator = false;
        if (e.error.toLowerCase().includes("invalid password")) {
            this.controller.once("tick", function () {
                _this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
            });
            browserState.loginFailedReason = 'invalid password';
            this.refreshWidgets();
            this.sp.browser.setVisible(true);
            this.sp.browser.setFocused(true);
            this.controller.once("update", function () {
                _this.sp.Game.disablePlayerControls(true, true, true, true, true, true, true, true, 0);
            });
            this.setListenBrowserMessage(true, 'connectionDenied event received');
        }
    };
    AuthService.prototype.handleConnectionAccepted = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "handleConnectionAccepted called");
        // Keep browser message listener active so user can still interact with auth menu
        // this.setListenBrowserMessage(false, 'connectionAccepted event received');
        this.loggingStartMoment = Date.now();
        var authData = this.sp.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_1__.authGameDataStorageKey];
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Auth data from storage:", JSON.stringify(authData));
        if (authData === null || authData === void 0 ? void 0 : authData.local) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Logging in offline mode, profileId =", authData.local.profileId);
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_6__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: 'loginWithSkympIo',
                    gameData: {
                        profileId: authData.local.profileId,
                    },
                }),
            };
            this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable"
            });
            return;
        }
        if (authData === null || authData === void 0 ? void 0 : authData.remote) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Logging in as a master API user');
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_6__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: 'loginWithSkympIo',
                    gameData: {
                        session: authData.remote.session,
                        masterApiId: authData.remote.masterApiId,
                        discordUsername: authData.remote.discordUsername,
                        discordDiscriminator: authData.remote.discordDiscriminator,
                        discordAvatar: authData.remote.discordAvatar,
                    },
                }),
            };
            this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable"
            });
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, 'Not found authentication method');
    };
    ;
    AuthService.prototype.onTick = function () {
        // TODO: Should be no hardcoded/magic-number limit
        // TODO: Busy waiting is bad. Should be replaced with some kind of event
        var maxLoggingDelay = 15000;
        if (this.loggingStartMoment && Date.now() - this.loggingStartMoment > maxLoggingDelay) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Max logging delay reached received');
            if (this.playerEverSawActualGameplay) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Player saw actual gameplay, reconnecting');
                this.loggingStartMoment = 0;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).reconnect();
                // TODO: should we prompt user to relogin?
            }
            else {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, 'Player never saw actual gameplay, showing login dialog');
                this.loggingStartMoment = 0;
                this.authAttemptProgressIndicator = false;
                this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_5__.NetworkingService).close();
                browserState.comment = "";
                browserState.loginFailedReason = 'technical difficulties\nplease try again\nor contact us on discord';
                this.refreshWidgets();
                authData = null;
                // Note: Auth data cleanup handled by launcher
            }
        }
        if (this.authAttemptProgressIndicator) {
            this.authAttemptProgressIndicatorCounter++;
            if (this.authAttemptProgressIndicatorCounter === 1000000) {
                this.authAttemptProgressIndicatorCounter = 0;
            }
            var slowCounter = Math.floor(this.authAttemptProgressIndicatorCounter / 15);
            var newSlowCounter = Math.floor(slowCounter / 1); // Only changes every ~15 ticks
            // Only refresh widgets when the dot pattern changes
            if (newSlowCounter !== this.lastSlowCounter) {
                this.lastSlowCounter = newSlowCounter;
                var dot = slowCounter % 3 === 0 ? '.' : slowCounter % 3 === 1 ? '..' : '...';
                browserState.comment = "connecting" + dot;
                this.refreshWidgets();
            }
        }
    };
    AuthService.prototype.onceUpdate = function () {
        this.playerEverSawActualGameplay = true;
    };
    AuthService.prototype.isListenBrowserMessage = function () {
        return this._isListenBrowserMessage;
    };
    AuthService.prototype.setListenBrowserMessage = function (value, reason) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "setListenBrowserMessage:", value, "reason:", reason);
        this._isListenBrowserMessage = value;
    };
    AuthService.prototype.getServerPort = function () {
        // Use the same port that the UI server uses (typically 3000 for dev, port+1 for custom ports)
        // This matches the pattern in ui.ts
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_7__.SettingsService);
        var serverPort = settingsService.getServerPort();
        return serverPort === 7777 ? 3000 : serverPort + 1;
    };
    return AuthService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/blockPapyrusEventsService.ts":
/*!************************************************************!*\
  !*** ./src/services/services/blockPapyrusEventsService.ts ***!
  \************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BlockPapyrusEventsService: () => (/* binding */ BlockPapyrusEventsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var BlockPapyrusEventsService = /** @class */ (function (_super) {
    __extends(BlockPapyrusEventsService, _super);
    function BlockPapyrusEventsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("tick", function () { return _this.onceTick(); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    BlockPapyrusEventsService.prototype.onceTick = function () {
        // @ts-ignore
        this.sp.blockPapyrusEvents(true);
    };
    BlockPapyrusEventsService.prototype.onceUpdate = function () {
        this.sp.TESModPlatform.blockPapyrusEvents(true);
    };
    return BlockPapyrusEventsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/blockedAnimationsService.ts":
/*!***********************************************************!*\
  !*** ./src/services/services/blockedAnimationsService.ts ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BlockedAnimationsService: () => (/* binding */ BlockedAnimationsService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var BlockedAnimationsService = /** @class */ (function (_super) {
    __extends(BlockedAnimationsService, _super);
    function BlockedAnimationsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var blockedAnims = [];
        var self = _this;
        blockedAnims.forEach(function (blockedAnim) {
            _this.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(self, "blocking animation event", ctx.animEventName);
                    ctx.animEventName = "";
                },
                leave: function () { }
            }, 0x14, 0x14, blockedAnim);
        });
        return _this;
    }
    return BlockedAnimationsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/browserService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/browserService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   BrowserService: () => (/* binding */ BrowserService)
/* harmony export */ });
/* harmony import */ var _view_formView__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/formView */ "./src/view/formView.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: send event instead of direct dependency on FormView class



var unfocusEventString = "window.dispatchEvent(new CustomEvent('skymp5-client:browserUnfocused', {}))";
var focusEventString = "window.dispatchEvent(new CustomEvent('skymp5-client:browserFocused', {}))";
var BrowserService = /** @class */ (function (_super) {
    __extends(BrowserService, _super);
    function BrowserService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.badMenusOpen = new Set();
        _this.badMenus = [
            "BarterMenu" /* Menu.Barter */,
            "Book Menu" /* Menu.Book */,
            "ContainerMenu" /* Menu.Container */,
            "Crafting Menu" /* Menu.Crafting */,
            "GiftMenu" /* Menu.Gift */,
            "InventoryMenu" /* Menu.Inventory */,
            "Journal Menu" /* Menu.Journal */,
            "Lockpicking Menu" /* Menu.Lockpicking */,
            "Loading Menu" /* Menu.Loading */,
            "MapMenu" /* Menu.Map */,
            "RaceSex Menu" /* Menu.RaceSex */,
            "StatsMenu" /* Menu.Stats */,
            "TweenMenu" /* Menu.Tween */,
            //Menu.Console,
            //Menu.Main,
        ];
        _this.sp.browser.setVisible(false);
        _this.controller.emitter.on("queryKeyCodeBindings", function (e) { return _this.onQueryKeyCodeBindings(e); });
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.on("menuOpen", function (e) { return _this.onMenuOpen(e); });
        _this.controller.on("menuClose", function (e) { return _this.onMenuClose(e); });
        return _this;
    }
    // TODO: keycodes should be configurable
    BrowserService.prototype.onQueryKeyCodeBindings = function (e) {
        if (e.isDown([59 /* DxScanCode.F1 */])) {
            _view_formView__WEBPACK_IMPORTED_MODULE_0__.FormView.isDisplayingNicknames = !_view_formView__WEBPACK_IMPORTED_MODULE_0__.FormView.isDisplayingNicknames;
        }
        if (e.isDown([60 /* DxScanCode.F2 */])) {
            this.sp.browser.setVisible(!this.sp.browser.isVisible());
        }
        if (this.badMenusOpen.size === 0 && e.isDown([64 /* DxScanCode.F6 */])) {
            var newState = !this.sp.browser.isFocused();
            this.sp.browser.setFocused(newState);
            if (newState) {
                this.sp.browser.executeJavaScript(focusEventString);
            }
            else {
                this.sp.browser.executeJavaScript(unfocusEventString);
            }
        }
        if (this.badMenusOpen.size === 0 && e.isDown([28 /* DxScanCode.Enter */])) {
            this.sp.browser.setFocused(true);
            this.sp.browser.executeJavaScript(focusEventString);
        }
        if (e.isDown([1 /* DxScanCode.Escape */])) {
            if (this.sp.browser.isFocused()) {
                this.sp.browser.setFocused(false);
                this.sp.browser.executeJavaScript(unfocusEventString);
            }
        }
    };
    BrowserService.prototype.onceUpdate = function () {
        this.sp.browser.setVisible(true);
    };
    BrowserService.prototype.onBrowserMessage = function (e) {
        var onFrontLoadedEventKey = "front-loaded";
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received browser message:", JSON.stringify(e.arguments));
        if (e.arguments[0] === onFrontLoadedEventKey) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received front-loaded message, emitting browserWindowLoaded event");
            this.controller.emitter.emit("browserWindowLoaded", {});
        }
    };
    BrowserService.prototype.onMenuOpen = function (e) {
        if (this.isBadMenu(e.name)) {
            this.sp.browser.setVisible(false);
            this.badMenusOpen.add(e.name);
        }
        else if (e.name === "HUD Menu" /* Menu.HUD */) {
            this.sp.browser.setVisible(true);
        }
    };
    BrowserService.prototype.onMenuClose = function (e) {
        if (this.badMenusOpen.delete(e.name)) {
            if (this.badMenusOpen.size === 0) {
                this.sp.browser.setVisible(true);
            }
        }
        if (e.name === "HUD Menu" /* Menu.HUD */) {
            this.sp.browser.setVisible(false);
        }
    };
    BrowserService.prototype.isBadMenu = function (menu) {
        return this.badMenus.includes(menu);
    };
    return BrowserService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/characterSelectService.ts":
/*!*********************************************************!*\
  !*** ./src/services/services/characterSelectService.ts ***!
  \*********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CharacterSelectService: () => (/* binding */ CharacterSelectService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




// Events used on both client and browser side
var events = {
    selectCharacter: 'characterSelect_select',
    createCharacter: 'characterSelect_create',
    deleteCharacter: 'characterSelect_delete',
    backToLogin: 'characterSelect_back',
};
var CharacterSelectService = /** @class */ (function (_super) {
    __extends(CharacterSelectService, _super);
    function CharacterSelectService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.characterSelectActive = false;
        _this.resetAuthState = false;
        _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage(e); });
        _this.controller.on("browserMessage", function (e) { return _this.onBrowserMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        // Listen for loginSuccess event from AuthService
        _this.controller.emitter.on("loginSuccess", function (e) { return _this.onLoginSuccess(e); });
        return _this;
    }
    CharacterSelectService.prototype.onLoginSuccess = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Received loginSuccess event, user authenticated");
        // The server will send character list automatically after login
        // No need to request it here
    };
    CharacterSelectService.prototype.onCustomPacketMessage = function (event) {
        try {
            var content = JSON.parse(event.message.contentJsonDump);
            switch (content.customPacketType) {
                case "characterList":
                    this.handleCharacterList(content);
                    break;
                case "characterError":
                    this.handleCharacterError(content.message || "Unknown error occurred");
                    break;
            }
        }
        catch (e) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)(this, "Error parsing custom packet: ".concat(e));
        }
    };
    CharacterSelectService.prototype.handleCharacterList = function (data) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Received character list: ".concat(data.characters.length, " characters, ").concat(data.maxSlots, " max slots"));
        this.characterSelectActive = true;
        // Inject data into window for custom UI access (following skyrim-roleplay pattern)
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.characterSelect = ".concat(JSON.stringify(data), ";\n      window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: ").concat(JSON.stringify(data), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
        // Show browser for character selection UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
    };
    CharacterSelectService.prototype.handleCharacterError = function (message) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)(this, "Character error: ".concat(message));
        // Inject error into window for custom UI access
        var injectScript = "\n      window.skymp = window.skymp || {};\n      window.skymp.characterSelectError = ".concat(JSON.stringify(message), ";\n      window.dispatchEvent(new CustomEvent('skymp:characterError', { detail: ").concat(JSON.stringify({ message: message }), " }));\n    ");
        this.sp.browser.executeJavaScript(injectScript);
    };
    CharacterSelectService.prototype.onCreateActorMessage = function (e) {
        // Hide character select screen when player spawns in world
        if (this.characterSelectActive) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Player spawned, hiding character select screen");
            var clearScript = "\n        if (window.skymp) {\n          window.skymp.characterSelect = null;\n          window.skymp.characterSelectError = null;\n        }\n        window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: null }));\n      ";
            this.sp.browser.executeJavaScript(clearScript);
            this.characterSelectActive = false;
        }
    };
    CharacterSelectService.prototype.onBrowserMessage = function (e) {
        var eventKey = e.arguments[0];
        var eventData = e.arguments[1];
        switch (eventKey) {
            case events.selectCharacter:
                this.sendSelectCharacter(eventData);
                break;
            case events.createCharacter:
                this.sendCreateCharacter();
                break;
            case events.deleteCharacter:
                this.sendDeleteCharacter(eventData);
                break;
            case events.backToLogin:
                this.handleBackToLogin();
                break;
        }
    };
    CharacterSelectService.prototype.sendSelectCharacter = function (visibleId) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Selecting character visibleId=".concat(visibleId));
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'selectCharacter',
                visibleId: visibleId,
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.sendCreateCharacter = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Creating new character");
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'createCharacter',
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.sendDeleteCharacter = function (visibleId) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Deleting character visibleId=".concat(visibleId));
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.CustomPacket,
            contentJsonDump: JSON.stringify({
                customPacketType: 'deleteCharacter',
                visibleId: visibleId,
            }),
        };
        this.controller.emitter.emit("sendMessage", {
            message: message,
            reliability: "reliable"
        });
    };
    CharacterSelectService.prototype.handleBackToLogin = function () {
        (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Back to login - returning to fresh auth screen");
        // Set flag to prevent auto-reconnect in authService
        this.resetAuthState = true;
        // Clear character select data
        var clearScript = "\n      if (window.skymp) {\n        window.skymp.characterSelect = null;\n        window.skymp.characterSelectError = null;\n      }\n      window.dispatchEvent(new CustomEvent('skymp:characterList', { detail: null }));\n    ";
        this.sp.browser.executeJavaScript(clearScript);
        this.characterSelectActive = false;
        // Close connection and ensure browser stays visible for auth screen
        this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_3__.NetworkingService).close();
        // Keep browser visible for auth UI
        this.sp.browser.setVisible(true);
        this.sp.browser.setFocused(true);
    };
    return CharacterSelectService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/clientListener.ts":
/*!*************************************************!*\
  !*** ./src/services/services/clientListener.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ClientListener: () => (/* binding */ ClientListener)
/* harmony export */ });
;
var ClientListener = /** @class */ (function () {
    function ClientListener() {
        // Don't let TypeScript treat this class as empty
        this._nonEmptyClassMark = '';
    }
    return ClientListener;
}());



/***/ }),

/***/ "./src/services/services/consoleCommandsService.ts":
/*!*********************************************************!*\
  !*** ./src/services/services/consoleCommandsService.ts ***!
  \*********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ConsoleCommandsService: () => (/* binding */ ConsoleCommandsService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: refactor this out


var CmdArgument;
(function (CmdArgument) {
    CmdArgument[CmdArgument["ObjectReference"] = 0] = "ObjectReference";
    CmdArgument[CmdArgument["BaseForm"] = 1] = "BaseForm";
    CmdArgument[CmdArgument["Int"] = 2] = "Int";
    CmdArgument[CmdArgument["String"] = 3] = "String";
})(CmdArgument || (CmdArgument = {}));
var ConsoleCommandsService = /** @class */ (function (_super) {
    __extends(ConsoleCommandsService, _super);
    function ConsoleCommandsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.immuneSchema = ["mp"];
        _this.nonVanilaCommands = ["mp"];
        _this.schemas = ConsoleCommandsService.createSchemas();
        _this.setupMpCommand();
        _this.setupVanilaCommands();
        return _this;
    }
    ConsoleCommandsService.createSchemas = function () {
        var schemas = new Map();
        schemas.set("additem", [CmdArgument.ObjectReference, CmdArgument.BaseForm, CmdArgument.Int]);
        schemas.set("equipitem", [CmdArgument.ObjectReference, CmdArgument.BaseForm]);
        schemas.set("placeatme", [CmdArgument.ObjectReference, CmdArgument.BaseForm]);
        schemas.set("disable", [CmdArgument.ObjectReference]);
        schemas.set("mp", [CmdArgument.ObjectReference, CmdArgument.String]);
        return schemas;
    };
    ConsoleCommandsService.prototype.setupMpCommand = function () {
        var command = this.sp.findConsoleCommand(" ConfigureUM") || this.sp.findConsoleCommand("test");
        if (command === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "command was null in setupMpCommand");
            return;
        }
        command.shortName = "mp";
        command.execute = this.getCommandExecutor("mp");
    };
    ConsoleCommandsService.prototype.setupVanilaCommands = function () {
        var _this = this;
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "Setting up vanila commands");
        this.schemas.forEach(function (_, commandName) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Setting up command", commandName);
            var command = _this.sp.findConsoleCommand(commandName);
            if (command === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "command", commandName, "was null in setupVanilaCommands");
                return;
            }
            if (_this.nonVanilaCommands.includes(commandName)) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "command", commandName, " is non-vanila command");
                return;
            }
            command.execute = _this.getCommandExecutor(commandName);
        });
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "Vanila commands set up");
    };
    ConsoleCommandsService.prototype.getCommandExecutor = function (commandName) {
        var _this = this;
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            // TODO: handle possible exceptions in this function
            var schema = _this.schemas.get(commandName);
            if (schema === undefined) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Schema not found for command", commandName);
                return false;
            }
            if (args.length !== schema.length && !_this.immuneSchema.includes(commandName)) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Mismatch found in the schema of", commandName, "command");
                return false;
            }
            for (var i = 0; i < args.length; ++i) {
                switch (schema[i]) {
                    case CmdArgument.ObjectReference:
                        args[i] = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(parseInt("".concat(args[i])));
                        break;
                }
            }
            for (var i = 0; i < args.length; ++i) {
                if (typeof args[i] !== "string" && typeof args[i] !== "number") {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "Bad argument type in command", commandName, "argument index", i);
                    return false;
                }
            }
            _this.controller.emitter.emit("sendMessage", {
                message: {
                    t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.ConsoleCommand,
                    data: {
                        commandName: commandName,
                        args: args
                    }
                },
                reliability: "reliable"
            });
            // Meant to be shown to user, not for logging
            _this.sp.printConsole("sent");
            return false;
        };
    };
    return ConsoleCommandsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_3__.ClientListener));



/***/ }),

/***/ "./src/services/services/containersService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/containersService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ContainersService: () => (/* binding */ ContainersService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _lastInvService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};








var ContainersService = /** @class */ (function (_super) {
    __extends(ContainersService, _super);
    function ContainersService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    ContainersService.prototype.onContainerChanged = function (e) {
        var _this = this;
        var sweetCantDropService = this.controller.lookupListener(_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_6__.SweetTaffySweetCantDropService);
        if (e.oldContainer && e.newContainer) {
            if (e.oldContainer.getFormID() === 0x14 ||
                e.newContainer.getFormID() === 0x14) {
                var lastInvService_1 = this.controller.lookupListener(_lastInvService__WEBPACK_IMPORTED_MODULE_5__.LastInvService);
                if (!lastInvService_1.lastInv) {
                    lastInvService_1.lastInv = (0,_remoteServer__WEBPACK_IMPORTED_MODULE_3__.getPcInventory)();
                }
                if (lastInvService_1.lastInv) {
                    var newInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.getInventory)(this.sp.Game.getPlayer());
                    // It seems that 'ignoreWorn = false' fixes this:
                    // https://github.com/skyrim-multiplayer/issue-tracker/issues/43
                    // For some reason excess diff is produced when 'ignoreWorn = true'
                    // I thought that it would be vice versa but that's how it works
                    var ignoreWorn = false;
                    var diff = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.getDiff)(lastInvService_1.lastInv, newInv, ignoreWorn);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('diff:');
                    for (var i = 0; i < diff.entries.length; ++i) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("[".concat(i, "] ").concat(JSON.stringify(diff.entries[i])));
                    }
                    var msgs = diff.entries
                        .filter(function (entry) {
                        // TODO: review this condition, seems to be incorrect
                        return entry.count > 0
                            ? sweetCantDropService.canDropOrPutItem(entry.baseId)
                            : true;
                    })
                        .filter(function (entry) { return entry.count !== 0; })
                        .map(function (entry) {
                        var _a;
                        var entryCopy = JSON.parse(JSON.stringify(entry));
                        var msg = __assign(__assign({}, entryCopy), { t: entry.count > 0 ? _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PutItem : _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.TakeItem, target: e.oldContainer.getFormID() === 0x14
                                ? (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__.localIdToRemoteId)(e.newContainer.getFormID())
                                : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_7__.localIdToRemoteId)(e.oldContainer.getFormID()) });
                        msg.count = Math.abs(msg.count);
                        if (((_a = _this.sp.Game.getFormEx(entry.baseId)) === null || _a === void 0 ? void 0 : _a.getName()) === msg.name) {
                            delete msg.name;
                        }
                        return msg;
                    });
                    msgs.forEach(function (msg) { return _this.controller.emitter.emit("sendMessage", {
                        message: msg,
                        reliability: "reliable"
                    }); });
                    // Prevent emitting 1,2,3,4,5 changes when taking/putting 5 potions one by one
                    // This code makes it 1,1,1,1,1 but works only for extra-less items
                    // At the moment of writing this I think it's not needed for items with extras
                    diff.entries.forEach(function (entry) {
                        if (lastInvService_1.lastInv && !(0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.hasExtras)(entry)) {
                            var put = entry.count > 0;
                            var take = entry.count < 0;
                            if (put) {
                                lastInvService_1.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.removeSimpleItemsAsManyAsPossible)(lastInvService_1.lastInv, entry.baseId, entry.count);
                            }
                            else if (take) {
                                var add = { entries: [entry] };
                                add.entries[0].count *= -1;
                                lastInvService_1.lastInv = (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_4__.sumInventories)(lastInvService_1.lastInv, add);
                            }
                        }
                    });
                }
            }
        }
    };
    return ContainersService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/craftService.ts":
/*!***********************************************!*\
  !*** ./src/services/services/craftService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CraftService: () => (/* binding */ CraftService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out




var CraftService = /** @class */ (function (_super) {
    __extends(CraftService, _super);
    function CraftService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.furnitureStreak = new Map();
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    CraftService.prototype.onContainerChanged = function (e) {
        var oldContainerId = e.oldContainer ? e.oldContainer.getFormID() : 0;
        var newContainerId = e.newContainer ? e.newContainer.getFormID() : 0;
        var baseObjId = e.baseObj ? e.baseObj.getFormID() : 0;
        if (oldContainerId !== 0x14 && newContainerId !== 0x14) {
            return;
        }
        var furnitureRef = this.sp.Game.getPlayer().getFurnitureReference();
        if (!furnitureRef) {
            return;
        }
        var furnitureId = furnitureRef.getFormID();
        if (oldContainerId === 0x14 && newContainerId === 0) {
            var craftInputObjects = this.furnitureStreak.get(furnitureId);
            if (!craftInputObjects) {
                craftInputObjects = { entries: [] };
            }
            craftInputObjects.entries.push({
                baseId: baseObjId,
                count: e.numItems,
            });
            this.furnitureStreak.set(furnitureId, craftInputObjects);
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Adding baseObjId", baseObjId.toString(16), "numItems", e.numItems, "to craft");
        }
        else if (oldContainerId === 0 && newContainerId === 0x14) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Finishing craft');
            var craftInputObjects = this.furnitureStreak.get(furnitureId);
            if (craftInputObjects && craftInputObjects.entries.length) {
                this.furnitureStreak.delete(furnitureId);
                var workbench = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(furnitureId);
                if (!workbench) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "localIdToRemoteId returned 0 for furnitureId", furnitureId);
                    return;
                }
                var resultObjectId = baseObjId;
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Sending craft workbench", workbench, "resultObjectId", resultObjectId, "craftInputObjects", JSON.stringify(craftInputObjects.entries));
                this.controller.emitter.emit("sendMessage", {
                    message: {
                        t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CraftItem,
                        data: { workbench: workbench, craftInputObjects: craftInputObjects, resultObjectId: resultObjectId },
                    },
                    reliability: "reliable"
                });
            }
        }
    };
    return CraftService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/deathService.ts":
/*!***********************************************!*\
  !*** ./src/services/services/deathService.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DeathService: () => (/* binding */ DeathService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _ragdollService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./ragdollService */ "./src/services/services/ragdollService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var DeathService = /** @class */ (function (_super) {
    __extends(DeathService, _super);
    function DeathService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.applyDeathState = function (actor, isDead) {
            if (actor.isDead() === isDead && _this.isPlayer(actor) === false) {
                return;
            }
            if (isDead === true) {
                _this.killActor(actor, null);
            }
            else {
                _this.resurrectActor(actor);
            }
        };
        _this.killActor = function (actor, killer) {
            if (killer === void 0) { killer = null; }
            if (_this.isPlayer(actor) === true) {
                _this.playerDead = true;
                _this.busyForOtherReasonsCounter++;
                _this.sp.Utility.wait(7.5).then(function () { return _this.busyForOtherReasonsCounter--; });
                _this.allowedPlayerAnimations = [];
                actor.setDontMove(true);
                _this.killWithPush(actor);
            }
            else {
                actor.endDeferredKill();
                actor.kill(killer);
            }
        };
        _this.resurrectActor = function (actor) {
            if (_this.isPlayer(actor) === true) {
                _this.playerDead = false;
                _this.busyForOtherReasonsCounter++;
                _this.sp.Utility.wait(7.5).then(function () { return _this.busyForOtherReasonsCounter--; });
                _this.allowedPlayerAnimations = null;
                actor.setDontMove(false);
                _this.ressurectWithPushKill(actor);
            }
            else {
                throw new _lib_errors__WEBPACK_IMPORTED_MODULE_2__.RespawnNeededError("needs to be respawned");
            }
        };
        _this.killWithPush = function (actor) {
            var _a;
            (_a = _this.allowedPlayerAnimations) === null || _a === void 0 ? void 0 : _a.push(_sync_animation__WEBPACK_IMPORTED_MODULE_3__.AnimationEventName.Ragdoll);
            actor.pushActorAway(actor, 0);
        };
        _this.ressurectWithPushKill = function (act) {
            var formId = act.getFormID();
            var ragdollService = _this.controller.lookupListener(_ragdollService__WEBPACK_IMPORTED_MODULE_4__.RagdollService);
            ragdollService.safeRemoveRagdollFromWorld(act, function () {
                var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(_this.sp.Game.getFormEx(formId));
                if (!actor) {
                    return;
                }
                // TODO: should use actor variable instead of getPlayer?
                // TODO: use different iGetUpType if ressurecting under water
                _this.sp.Game.getPlayer().setAnimationVariableInt("iGetUpType", 1);
                _this.sp.Debug.sendAnimationEvent(actor, _sync_animation__WEBPACK_IMPORTED_MODULE_3__.AnimationEventName.GetUpBegin);
            });
        };
        _this.isPlayer = function (actor) {
            return actor.getFormID() === _this.playerActorId;
        };
        // Null to allow all animations. Empty array to disallow all
        _this.allowedPlayerAnimations = null;
        _this.playerActorId = 0x14;
        _this.playerDead = false;
        _this.busyForOtherReasonsCounter = 0;
        controller.once("update", function () { return _this.onceUpdate(); });
        controller.emitter.on("applyDeathStateEvent", function (e) { return _this.onApplyDeathState(e); });
        _this.hookDisableKillMoves();
        _this.hookDisableStagger();
        _this.hookDisableBlockedAnims();
        return _this;
    }
    DeathService.prototype.isBusy = function () {
        return this.playerDead || this.busyForOtherReasonsCounter > 0;
    };
    DeathService.prototype.onceUpdate = function () {
        var player = this.sp.Game.getPlayer();
        player === null || player === void 0 ? void 0 : player.startDeferredKill();
    };
    DeathService.prototype.onApplyDeathState = function (e) {
        this.applyDeathState(e.actor, e.isDead);
    };
    DeathService.prototype.hookDisableKillMoves = function () {
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                ctx.animEventName = "";
            },
            leave: function () { },
        }, 0xff000000, 0xffffffff, "KillMove*");
    };
    DeathService.prototype.hookDisableStagger = function () {
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                ctx.animEventName = "";
            },
            leave: function () { },
        }, 0xff000000, 0xffffffff, "staggerStart");
    };
    DeathService.prototype.hookDisableBlockedAnims = function () {
        var _this = this;
        this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) {
                if (_this.allowedPlayerAnimations === null) {
                    return;
                }
                if (!_this.allowedPlayerAnimations.includes(ctx.animEventName)) {
                    ctx.animEventName = "";
                }
            },
            leave: function () { },
        }, this.playerActorId, this.playerActorId);
    };
    return DeathService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableDifficultySelectionService.ts":
/*!********************************************************************!*\
  !*** ./src/services/services/disableDifficultySelectionService.ts ***!
  \********************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableDifficultySelectionService: () => (/* binding */ DisableDifficultySelectionService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var DisableDifficultySelectionService = /** @class */ (function (_super) {
    __extends(DisableDifficultySelectionService, _super);
    function DisableDifficultySelectionService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.difficulty = 5;
        _this.counter = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    DisableDifficultySelectionService.prototype.onUpdate = function () {
        this.counter++;
        if (this.counter >= 60) {
            this.counter = 0;
            this.sp.Utility.setINIInt("iDifficulty:GamePlay", this.difficulty);
        }
    };
    return DisableDifficultySelectionService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableFastTravelService.ts":
/*!***********************************************************!*\
  !*** ./src/services/services/disableFastTravelService.ts ***!
  \***********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableFastTravelService: () => (/* binding */ DisableFastTravelService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var DisableFastTravelService = /** @class */ (function (_super) {
    __extends(DisableFastTravelService, _super);
    function DisableFastTravelService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    DisableFastTravelService.prototype.onUpdate = function () {
        this.sp.Game.enableFastTravel(false);
    };
    return DisableFastTravelService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/disableSkillAdvanceService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/disableSkillAdvanceService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DisableSkillAdvanceService: () => (/* binding */ DisableSkillAdvanceService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var DisableSkillAdvanceService = /** @class */ (function (_super) {
    __extends(DisableSkillAdvanceService, _super);
    function DisableSkillAdvanceService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    DisableSkillAdvanceService.prototype.onceUpdate = function () {
        // turn off player level exp
        this.sp.Game.setGameSettingFloat("fXPPerSkillRank", 0);
        // turn off skill exp
        this.turnOffSkillLocalExp(18 /* ActorValue.Alteration */);
        this.turnOffSkillLocalExp(19 /* ActorValue.Conjuration */);
        this.turnOffSkillLocalExp(20 /* ActorValue.Destruction */);
        this.turnOffSkillLocalExp(21 /* ActorValue.Illusion */);
        this.turnOffSkillLocalExp(22 /* ActorValue.Restoration */);
        this.turnOffSkillLocalExp(23 /* ActorValue.Enchanting */);
        this.turnOffSkillLocalExp(6 /* ActorValue.OneHanded */);
        this.turnOffSkillLocalExp(7 /* ActorValue.TwoHanded */);
        this.turnOffSkillLocalExp(8 /* ActorValue.Archery */);
        this.turnOffSkillLocalExp(9 /* ActorValue.Block */);
        this.turnOffSkillLocalExp(10 /* ActorValue.Smithing */);
        this.turnOffSkillLocalExp(11 /* ActorValue.HeavyArmor */);
        this.turnOffSkillLocalExp(12 /* ActorValue.LightArmor */);
        this.turnOffSkillLocalExp(13 /* ActorValue.Pickpocket */);
        this.turnOffSkillLocalExp(14 /* ActorValue.Lockpicking */);
        this.turnOffSkillLocalExp(15 /* ActorValue.Sneak */);
        this.turnOffSkillLocalExp(16 /* ActorValue.Alchemy */);
        this.turnOffSkillLocalExp(17 /* ActorValue.Speech */);
    };
    DisableSkillAdvanceService.prototype.turnOffSkillLocalExp = function (av) {
        var avi = this.sp.ActorValueInfo.getActorValueInfoByID(av);
        if (avi === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Not found ActorValueInfo for actor value", av);
            return;
        }
        avi.setSkillUseMult(0);
        avi.setSkillOffsetMult(0);
    };
    ;
    return DisableSkillAdvanceService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/dropItemService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/dropItemService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   DropItemService: () => (/* binding */ DropItemService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _worldCleanerService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var DropItemService = /** @class */ (function (_super) {
    __extends(DropItemService, _super);
    function DropItemService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        return _this;
    }
    DropItemService.prototype.onContainerChanged = function (e) {
        var _this = this;
        var _a;
        var sweetCantDropService = this.controller.lookupListener(_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_2__.SweetTaffySweetCantDropService);
        var pl = this.sp.Game.getPlayer();
        var isPlayer = pl && e.oldContainer && pl.getFormID() === e.oldContainer.getFormID();
        var noContainer = e.newContainer === null || e.newContainer === undefined;
        var isReference = e.reference !== null;
        if (e.newContainer && e.newContainer.getFormID() === pl.getFormID())
            return;
        if (!this.sp.Ui.isMenuOpen("InventoryMenu"))
            return;
        if (isPlayer &&
            isReference &&
            noContainer &&
            sweetCantDropService.canDropOrPutItem(e.baseObj.getFormID())) {
            var radius = 2000;
            var baseId = e.baseObj.getFormID();
            var player = this.sp.Game.getPlayer();
            var set = new Set();
            for (var i = 0; i < 200; i++) {
                var refrId = (_a = this.sp.Game.findRandomReferenceOfType(this.sp.Game.getFormEx(baseId), player.getPositionX(), player.getPositionY(), player.getPositionZ(), radius)) === null || _a === void 0 ? void 0 : _a.getFormID();
                if (refrId) {
                    set.add(refrId);
                }
                else {
                    break;
                }
            }
            var numFound_1 = 0;
            var worldCleanerService_1 = this.controller.lookupListener(_worldCleanerService__WEBPACK_IMPORTED_MODULE_3__.WorldCleanerService);
            set.forEach(function (refrId) {
                var ref = _this.sp.ObjectReference.from(_this.sp.Game.getFormEx(refrId));
                if (ref !== null && ref.isDeleted() === false) {
                    var refrId_1 = ref.getFormID();
                    if (worldCleanerService_1.getWcProtection(refrId_1) === 0) {
                        ref.delete();
                        ++numFound_1;
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Found and deleted reference " + refrId_1.toString(16));
                    }
                    else {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Found reference " + refrId_1.toString(16) + " but it's protected");
                    }
                }
            });
            if (!numFound_1) {
                return (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Ignoring item drop as false positive");
            }
            var t = _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.DropItem;
            var count = e.numItems;
            this.controller.emitter.emit("sendMessage", {
                message: {
                    t: t,
                    baseId: baseId,
                    count: count,
                },
                reliability: "reliable"
            });
        }
    };
    return DropItemService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/enforceLimitationsService.ts":
/*!************************************************************!*\
  !*** ./src/services/services/enforceLimitationsService.ts ***!
  \************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EnforceLimitationsService: () => (/* binding */ EnforceLimitationsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var EnforceLimitationsService = /** @class */ (function (_super) {
    __extends(EnforceLimitationsService, _super);
    function EnforceLimitationsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.once("update", function () { return _this.onceUpdate(); });
        controller.emitter.on("gameLoad", function (e) { return _this.onGameLoad(e); });
        return _this;
    }
    EnforceLimitationsService.prototype.onceUpdate = function () {
        this.sp.Game.setInChargen(true, true, false);
    };
    EnforceLimitationsService.prototype.onGameLoad = function (event) {
        this.sp.Game.setInChargen(true, true, false);
    };
    return EnforceLimitationsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/frontHotReloadService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/frontHotReloadService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FrontHotReloadService: () => (/* binding */ FrontHotReloadService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var FrontHotReloadService = /** @class */ (function (_super) {
    __extends(FrontHotReloadService, _super);
    function FrontHotReloadService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var enable = !!_this.sp.settings["skymp5-client"]["enable-front-hotreload"];
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "enable-front-hotreload is", enable);
        if (!enable) {
            return _this;
        }
        // TODO: refactor out very similar code in skympClient.ts
        var authGameData = _this.sp.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_1__.authGameDataStorageKey];
        var storageHasValidAuthGameData = (authGameData === null || authGameData === void 0 ? void 0 : authGameData.local) || (authGameData === null || authGameData === void 0 ? void 0 : authGameData.remote);
        if (storageHasValidAuthGameData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Recovered AuthGameData from storage, starting FrontHotReloadService");
            _this.connectToFrontHotReload();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Unable to recover AuthGameData from storage, waiting for auth");
            _this.controller.emitter.on("authAttempt", function (e) { return _this.onAuthAttempt(e); });
        }
        return _this;
    }
    FrontHotReloadService.prototype.onAuthAttempt = function (e) {
        this.connectToFrontHotReload();
    };
    FrontHotReloadService.prototype.connectToFrontHotReload = function () {
        var _this = this;
        this.controller.once("update", function () {
            var url = "localhost:1234";
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "Loading url", url);
            _this.sp.browser.loadUrl(url);
        });
    };
    return FrontHotReloadService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/gamemodeEventSourceService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/gamemodeEventSourceService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   GamemodeEventSourceService: () => (/* binding */ GamemodeEventSourceService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// The reason we use global skyrimPlatform is that this.sp may be limited, and gamemode api needs unlimited access to skyrimPlatform
// Sligthly different types



var GamemodeEventSourceService = /** @class */ (function (_super) {
    __extends(GamemodeEventSourceService, _super);
    function GamemodeEventSourceService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.setupEventSource = function (ctx) {
            _this.controller.once('update', function () {
                try {
                    ctx._fn(ctx);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "'eventSources", ctx._eventName, "- Added");
                }
                catch (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", ctx._eventName, "-", e);
                }
            });
        };
        if (Array.isArray(_this.sp.storage['eventSourceContexts'])) {
            _this.sp.storage['eventSourceContexts'] = _this.sp.storage['eventSourceContexts'].filter(function (ctx) { return !ctx._expired; });
            _this.sp.storage['eventSourceContexts'].forEach(function (ctx) {
                _this.setupEventSource(ctx);
            });
        }
        _this.controller.emitter.on("updateGamemodeDataMessage", function (e) { return _this.onUpdateGamemodeDataMessage(e); });
        return _this;
    }
    GamemodeEventSourceService.prototype.onUpdateGamemodeDataMessage = function (event) {
        var _this = this;
        if (this.sp.settings["skymp5-client"]["disable-gamemode-updates"]) {
            if (this.sp.storage['GamemodeEventSourceService_sawEventSources'] === true) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings");
                return;
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings - processing first update only");
            this.sp.storage['GamemodeEventSourceService_sawEventSources'] = true;
        }
        if (!Array.isArray(this.sp.storage['eventSourceContexts'])) {
            this.sp.storage['eventSourceContexts'] = [];
        }
        else {
            this.sp.storage['eventSourceContexts'].forEach(function (ctx) {
                ctx.sendEvent = function () { };
                ctx._expired = true;
            });
        }
        var eventSourcesRecord = {};
        event.message.eventSources.forEach(function (pair) { return eventSourcesRecord[pair.name] = pair.content; });
        var eventNames = Object.keys(eventSourcesRecord);
        var blockedEventSources = this.sp.settings["skymp5-client"]["blockedEventSources"];
        if (Array.isArray(blockedEventSources)) {
            blockedEventSources.forEach(function (blockedEventSource) {
                eventNames = eventNames.filter(function (eventName) { return eventName !== blockedEventSource; });
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "'eventSources", blockedEventSource, "- Blocked by the client");
            });
        }
        var serverJsVerificationService = this.controller.lookupListener(_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__.ServerJsVerificationService);
        eventNames.forEach(function (eventName) {
            var result = serverJsVerificationService.verifyServerJs(eventSourcesRecord[eventName]);
            if (result.src === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", eventName, 'Verification failed:', result.error);
                return;
            }
            try {
                var fn = new Function('ctx', result.src);
                var ctx = {
                    refr: undefined,
                    value: undefined,
                    _model: undefined,
                    _view: undefined,
                    i: -1,
                    get: function (_propName) {
                        throw new Error("ctx.get can't be used in event source");
                    },
                    respawn: function () {
                        throw new Error("ctx.respawn can't be used in event source");
                    },
                    sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
                    sendEvent: function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        var message = {
                            t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CustomEvent,
                            argsJsonDumps: args.map(function (arg) { return JSON.stringify(arg); }),
                            eventName: eventName
                        };
                        _this.controller.emitter.emit("sendMessage", {
                            message: message,
                            reliability: "reliable"
                        });
                    },
                    getFormIdInServerFormat: function (clientsideFormId) {
                        return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(clientsideFormId);
                    },
                    getFormIdInClientFormat: function (serversideFormId) {
                        return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.remoteIdToLocalId)(serversideFormId);
                    },
                    _fn: fn,
                    _eventName: eventName,
                    state: {},
                };
                _this.sp.storage['eventSourceContexts'].push(ctx);
                _this.setupEventSource(ctx);
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "'eventSources", eventName, "-", e);
            }
        });
    };
    return GamemodeEventSourceService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/gamemodeUpdateService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/gamemodeUpdateService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   GamemodeUpdateService: () => (/* binding */ GamemodeUpdateService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: refactor

// The reason we use global skyrimPlatform is that this.sp may be limited, and gamemode api needs unlimited access to skyrimPlatform
// Sligthly different types



var GamemodeUpdateService = /** @class */ (function (_super) {
    __extends(GamemodeUpdateService, _super);
    function GamemodeUpdateService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("updateGamemodeDataMessage", function (e) { return _this.onUpdateGamemodeDataMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.updateOwnerCtx = {
            sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
            refr: undefined,
            value: undefined,
            _model: undefined,
            getFormIdInServerFormat: function (clientsideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(clientsideFormId);
            },
            getFormIdInClientFormat: function (serversideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(serversideFormId);
            },
            get: function (propName) {
                return this._model[propName];
            },
            state: {},
            _view: undefined,
            i: -1,
            respawn: function () { throw new Error("ctx.respawn is not available for updateOwner"); }
        };
        _this.updateNeighborCtx = {
            refr: undefined,
            value: undefined,
            _model: undefined,
            sp: skyrimPlatform__WEBPACK_IMPORTED_MODULE_3__,
            state: undefined,
            _view: undefined,
            i: -1,
            getFormIdInServerFormat: function (clientsideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.localIdToRemoteId)(clientsideFormId);
            },
            getFormIdInClientFormat: function (serversideFormId) {
                return (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(serversideFormId);
            },
            get: function (propName) {
                return this._model[propName];
            },
            respawn: function () {
                this._view.destroyForm(this.i);
            }
        };
        _this.updateNeighborFunctionsKeys = [];
        _this.updateNeighborFunctions = {};
        return _this;
    }
    GamemodeUpdateService.prototype.setFormViewArray = function (formViewArray) {
        this.updateNeighborCtx._view = formViewArray;
    };
    GamemodeUpdateService.prototype.setI = function (i) {
        this.updateNeighborCtx.i = i;
    };
    GamemodeUpdateService.prototype.updateNeighbor = function (refr, model, state) {
        for (var _i = 0, _a = this.updateNeighborFunctionsKeys; _i < _a.length; _i++) {
            var key = _a[_i];
            var v = model[key];
            // According to docs:
            // In `updateOwner`/`updateNeighbor` equals to a value of a currently processed property.
            // Can't be `undefined` here, since updates are not received for `undefined` property values.
            // In other contexts is always `undefined`.
            if (v !== undefined) {
                this.updateNeighborCtx.refr = refr;
                this.updateNeighborCtx.value = v;
                this.updateNeighborCtx._model = model;
                this.updateNeighborCtx.state = state;
                var f = this.updateNeighborFunctions[key];
                // Actually, 'f' should always be a valid function, but who knows
                try {
                    if (f) {
                        f(this.updateNeighborCtx);
                    }
                }
                catch (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "updateNeighbor", key, '-', e);
                }
            }
        }
    };
    GamemodeUpdateService.prototype.onUpdateGamemodeDataMessage = function (event) {
        if (this.sp.settings["skymp5-client"]["disable-gamemode-updates"]) {
            if (this.sp.storage['GamemodeUpdateService_sawUpdateFunctions'] === true) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings");
                return;
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Gamemode updates are disabled by settings - processing first update only");
            this.sp.storage['GamemodeUpdateService_sawUpdateFunctions'] = true;
        }
        this.sp.storage['updateNeighborFunctions'] = undefined;
        this.sp.storage['updateOwnerFunctions'] = undefined;
        this.updateGamemodeUpdateFunctions('updateNeighborFunctions', event.message.updateNeighborFunctions);
        this.updateGamemodeUpdateFunctions('updateOwnerFunctions', event.message.updateOwnerFunctions);
    };
    GamemodeUpdateService.prototype.onCreateActorMessage = function (event) {
        var _this = this;
        if (!event.message.isMe) {
            return;
        }
        // Otherwise worldModel.playerCharacterFormIdx may be unassigned
        this.controller.once("tick", function () {
            var remoteServer = _this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_1__.RemoteServer);
            var worldModel = remoteServer.getWorldModel();
            var myFormModel = worldModel.forms[worldModel.playerCharacterFormIdx];
            if (!myFormModel) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(_this, "Unable to find formModel with index", worldModel.playerCharacterFormIdx);
                return;
            }
            _this.setOwnerModel(myFormModel);
        });
    };
    GamemodeUpdateService.prototype.onTick = function () {
        var keys = this.sp.storage["updateNeighborFunctions_keys"];
        if (keys && Array.isArray(keys)) {
            this.updateNeighborFunctionsKeys = keys;
        }
        else {
            this.updateNeighborFunctionsKeys = [];
        }
        // TODO: Shouldn't we check storage value before assignment?
        this.updateNeighborFunctions = this.sp.storage["updateNeighborFunctions"];
    };
    GamemodeUpdateService.prototype.onUpdate = function () {
        var playerRef = this.sp.ObjectReference.from(this.sp.Game.getPlayer());
        var keys = this.sp.storage["updateOwnerFunctions_keys"];
        if (!keys || !Array.isArray(keys)) {
            keys = [];
        }
        var funcs = this.sp.storage["updateOwnerFunctions"];
        if (this.sp.storage["ownerModelSet"] !== true) {
            return;
        }
        var ownerModel = this.sp.storage["ownerModel"];
        for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {
            var propName = keys_1[_i];
            var f = funcs[propName];
            // Actually, must always be a valid funciton, but who knows
            if (!f) {
                continue;
            }
            this.updateOwnerCtx._model = ownerModel;
            if (!this.updateOwnerCtx._model) {
                continue;
            }
            this.updateOwnerCtx.value = this.updateOwnerCtx._model[propName];
            if (this.updateOwnerCtx.value === undefined) {
                continue;
            }
            this.updateOwnerCtx.refr = playerRef;
            this.updateOwnerCtx._model = ownerModel;
            try {
                if (f) {
                    f(this.updateOwnerCtx);
                }
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "updateOwner", propName, '-', e);
            }
        }
    };
    GamemodeUpdateService.prototype.setOwnerModel = function (ownerModel) {
        this.sp.storage["ownerModel"] = ownerModel;
        this.sp.storage["ownerModelSet"] = true;
    };
    ;
    GamemodeUpdateService.prototype.updateGamemodeUpdateFunctions = function (storageVar, functionSources) {
        var serverJsVerificationService = this.controller.lookupListener(_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_5__.ServerJsVerificationService);
        var functionSourcesRecord = {};
        functionSources.forEach(function (pair) { return functionSourcesRecord[pair.name] = pair.content; });
        this.sp.storage[storageVar] = functionSourcesRecord;
        for (var _i = 0, _a = Object.keys(functionSourcesRecord); _i < _a.length; _i++) {
            var propName = _a[_i];
            var result = serverJsVerificationService.verifyServerJs(this.sp.storage[storageVar][propName]);
            if (result.src === null) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, storageVar, propName, 'Verification failed:', result.error);
                delete this.sp.storage[storageVar][propName];
                continue;
            }
            try {
                this.sp.storage[storageVar][propName] = new Function('ctx', result.src);
                var emptyFunction = functionSourcesRecord[propName] === '';
                if (emptyFunction) {
                    delete this.sp.storage[storageVar][propName];
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, storageVar, propName, 'Added empty');
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, storageVar, propName, 'Added');
                }
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, storageVar, propName, e);
            }
        }
        this.sp.storage["".concat(storageVar, "_keys")] = Object.keys(this.sp.storage[storageVar]);
    };
    return GamemodeUpdateService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/hitService.ts":
/*!*********************************************!*\
  !*** ./src/services/services/hitService.ts ***!
  \*********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   HitService: () => (/* binding */ HitService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out




var HitService = /** @class */ (function (_super) {
    __extends(HitService, _super);
    function HitService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.recentMagicHits = new Map();
        controller.on('hit', function (e) { return _this.onHit(e); });
        return _this;
    }
    HitService.prototype.onHit = function (e) {
        // TODO: add more logging in case of 'return'
        // TODO: allow non-weapon sources
        var aggressor = e.aggressor.getFormID();
        if (aggressor < 0xff000000 && aggressor !== 0x14)
            return; // all skymp npcs are FF+
        if (aggressor >= 0xff000000) {
            // TODO: make host service
            var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.storage['hosted'];
            var alreadyHosted = false;
            if (Array.isArray(hosted)) {
                var remoteId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(aggressor);
                if (hosted.includes(remoteId) || hosted.includes(remoteId + 0x100000000)) {
                    alreadyHosted = true;
                }
            }
            if (!alreadyHosted) {
                return;
            }
        }
        var base = e.target.getBaseObject();
        var type = base === null || base === void 0 ? void 0 : base.getType();
        if (type === 34 /* FormType.Static */ || type === 36 /* FormType.MovableStatic */) {
            return;
        }
        var isWeapon = this.sp.Weapon.from(e.source);
        var isSpell = !isWeapon && this.sp.Spell.from(e.source);
        var isScroll = !isWeapon && !isSpell && this.sp.Scroll.from(e.source);
        if (!isWeapon && !isSpell && !isScroll) {
            return;
        }
        // prevent double hit that happens for some reason with magic projectiles
        if (isSpell || isScroll) {
            var aggressorId = e.aggressor.getFormID();
            var now = Date.now();
            var lastHitTime = this.recentMagicHits.get(aggressorId);
            if (lastHitTime && now - lastHitTime < 100) {
                return;
            }
            this.recentMagicHits.set(aggressorId, now);
        }
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.OnHit, data: this.getHitData(e) },
            reliability: "reliable"
        });
    };
    HitService.prototype.getHitData = function (e) {
        var hitData = {
            aggressor: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.aggressor.getFormID()),
            isBashAttack: e.isBashAttack,
            isHitBlocked: e.isHitBlocked,
            isPowerAttack: e.isPowerAttack,
            isSneakAttack: e.isSneakAttack,
            projectile: e.projectile ? e.projectile.getFormID() : 0,
            source: e.source ? e.source.getFormID() : 0,
            target: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.target.getFormID())
        };
        return hitData;
    };
    return HitService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/keyboardEventsService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/keyboardEventsService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   KeyboardEventsService: () => (/* binding */ KeyboardEventsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var KeyboardEventsService = /** @class */ (function (_super) {
    __extends(KeyboardEventsService, _super);
    function KeyboardEventsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastNumKeys = 0;
        controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    KeyboardEventsService.prototype.onUpdate = function () {
        var _this = this;
        var numKeys = this.sp.Input.getNumKeysPressed();
        if (this.lastNumKeys !== numKeys) {
            this.lastNumKeys = numKeys;
            this.controller.emitter.emit("queryKeyCodeBindings", {
                isDown: function (binding) {
                    if (binding.every(function (key) { return _this.sp.Input.isKeyPressed(key); })) {
                        return true;
                    }
                    return false;
                }
            });
        }
    };
    return KeyboardEventsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/lastInvService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/lastInvService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LastInvService: () => (/* binding */ LastInvService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var LastInvService = /** @class */ (function (_super) {
    __extends(LastInvService, _super);
    function LastInvService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        return _this;
    }
    Object.defineProperty(LastInvService.prototype, "lastInv", {
        get: function () {
            return this._lastInv;
        },
        set: function (newValue) {
            this._lastInv = newValue;
        },
        enumerable: false,
        configurable: true
    });
    return LastInvService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/loadGameService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/loadGameService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LoadGameService: () => (/* binding */ LoadGameService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var LoadGameService = /** @class */ (function (_super) {
    __extends(LoadGameService, _super);
    function LoadGameService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this._isCausedBySkyrimPlatform = false;
        _this.controller.on("loadGame", function () { return _this.onLoadGame(); });
        return _this;
    }
    LoadGameService.prototype.loadGame = function (pos, rot, worldOrCell, changeFormNpc, loadOrder, time) {
        try {
            // @ts-ignore
            this.sp.loadGame(pos, rot, worldOrCell, changeFormNpc, loadOrder, time);
        }
        catch (e) {
            // Hotfix non-vanilla headparts bug
            // @ts-ignore
            this.sp.loadGame(pos, rot, worldOrCell, undefined, loadOrder, time);
        }
        this._isCausedBySkyrimPlatform = true;
    };
    LoadGameService.prototype.onLoadGame = function () {
        var _this = this;
        try {
            var gameLoadEvent = {
                isCausedBySkyrimPlatform: this._isCausedBySkyrimPlatform
            };
            this.controller.emitter.emit("gameLoad", gameLoadEvent);
        }
        catch (e) {
            this.controller.once("tick", function () {
                _this._isCausedBySkyrimPlatform = false;
            });
            throw e;
        }
        this.controller.once("tick", function () {
            _this._isCausedBySkyrimPlatform = false;
        });
    };
    return LoadGameService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/loadOrderVerificationService.ts":
/*!***************************************************************!*\
  !*** ./src/services/services/loadOrderVerificationService.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   LoadOrderVerificationService: () => (/* binding */ LoadOrderVerificationService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _view_formView__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../view/formView */ "./src/view/formView.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var STATE_KEY = 'loadOrderCheckState';
;
var LoadOrderVerificationService = /** @class */ (function (_super) {
    __extends(LoadOrderVerificationService, _super);
    function LoadOrderVerificationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    LoadOrderVerificationService.prototype.onceUpdate = function () {
        this.verifyLoadOrder();
    };
    LoadOrderVerificationService.prototype.verifyLoadOrder = function () {
        var _this = this;
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_4__.SettingsService);
        this.resetText();
        var clientMods = this.getClientMods();
        this.printModOrder('Client load order:', clientMods);
        return settingsService.getServerMods()
            .then(function (serverMods) {
            _this.printModOrder('Server load order:', serverMods);
            if (clientMods.length < serverMods.length) {
                throw new Error("Missing some server mods. Server has ".concat(serverMods.length, ", we have ").concat(clientMods.length));
            }
            if (clientMods.length > serverMods.length) {
                _this.updateText('LOAD ORDER WARNING: you have more mods than server!\n(or could not receive server mod list)\nCheck console for details.', [255, 255, 0, 1], 5);
            }
            var fail = [];
            for (var i = 0; i < serverMods.length; ++i) {
                // Need case-insensitive check for 1.6+
                if (clientMods[i].filename.toLowerCase() !== serverMods[i].filename.toLowerCase() ||
                    clientMods[i].size !== serverMods[i].size ||
                    clientMods[i].crc32 !== serverMods[i].crc32) {
                    fail.push(i);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("".concat(i, "-th mod (numbered from 0) does not match."));
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Server has ".concat(JSON.stringify(serverMods[i])));
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("We have ".concat(JSON.stringify(clientMods[i])));
                }
            }
            if (fail.length !== 0) {
                throw new Error('Load order check failed! Indices: ' + JSON.stringify(fail));
            }
        })
            .catch(function (err) {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(err);
            if (_this.sp.settings['skymp5-client']['ignoreLoadOrderMismatch']) {
                _this.updateText('LOAD ORDER ERROR!\nHowever, ignoring it because of ignoreLoadOrderMismatch being set.' +
                    '\nExpect EVERYTHING BREAK, unless you know what you are doing.\nCheck console for details.' +
                    '\nThis message will disappear after 30 seconds.', [255, 0, 0, 1], 30);
                return;
            }
            _this.updateText('LOAD ORDER ERROR!\nCheck console for details.', [255, 0, 0, 1]);
        });
    };
    ;
    LoadOrderVerificationService.prototype.getState = function () {
        if (typeof this.sp.storage[STATE_KEY] !== 'object') {
            return {};
        }
        return this.sp.storage[STATE_KEY];
    };
    ;
    LoadOrderVerificationService.prototype.setState = function (replacement) {
        var oldState = this.sp.storage[STATE_KEY] = this.getState();
        for (var _i = 0, _a = Object.entries(replacement); _i < _a.length; _i++) {
            var _b = _a[_i], k = _b[0], v = _b[1];
            oldState[k] = v;
        }
    };
    ;
    LoadOrderVerificationService.prototype.resetText = function () {
        var statusTextId = this.getState().statusTextId;
        if (statusTextId) {
            this.sp.destroyText(statusTextId);
            statusTextId = undefined;
            this.setState({ statusTextId: statusTextId });
        }
    };
    ;
    LoadOrderVerificationService.prototype.updateText = function (text, color, clearDelay) {
        var _this = this;
        var _a = (0,_view_formView__WEBPACK_IMPORTED_MODULE_1__.getScreenResolution)(), width = _a.width, height = _a.height;
        this.resetText();
        var statusTextId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(width / 2, height / 2, text, color);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(statusTextId, 0.5);
        this.setState({ statusTextId: statusTextId });
        if (clearDelay) {
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(clearDelay).then(function () { return _this.resetText(); });
        }
    };
    LoadOrderVerificationService.prototype.enumerateClientMods = function (getCount, getAt) {
        var result = [];
        for (var i = 0; i < getCount(); ++i) {
            var filename = getAt(i);
            var _a = this.getFileInfoSafe(filename), crc32 = _a.crc32, size = _a.size;
            result.push({ filename: filename, crc32: crc32, size: size });
        }
        return result;
    };
    LoadOrderVerificationService.prototype.getClientMods = function () {
        return this.enumerateClientMods(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getModCount, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getModName);
    };
    ;
    LoadOrderVerificationService.prototype.printModOrder = function (header, order) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(header);
        for (var _i = 0, _a = Object.entries(order); _i < _a.length; _i++) {
            var _b = _a[_i], i = _b[0], mod = _b[1];
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("#".concat(i, " ").concat(JSON.stringify(mod)));
        }
    };
    ;
    LoadOrderVerificationService.prototype.getFileInfoSafe = function (filename) {
        try {
            return this.sp.getFileInfo(filename);
        }
        catch (e) {
            var message = e.message;
            if (typeof message === "string" && message.includes('is not a valid argument')) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Failed to get file info for", filename);
                return { crc32: 0, size: 0 };
            }
            else {
                throw e;
            }
        }
    };
    return LoadOrderVerificationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/magicSyncService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/magicSyncService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   MagicSyncService: () => (/* binding */ MagicSyncService)
/* harmony export */ });
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
// TODO: refactor this out

// @ts-expect-error (TODO: Remove in 2.10.0)



var MagicSyncService = /** @class */ (function (_super) {
    __extends(MagicSyncService, _super);
    function MagicSyncService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.playerId = 0x14;
        _this.sendUpdateAnimationVariablesRateMs = 500;
        _this.lastSpellCastEventMsg = null;
        _this.lastSendUpdateAnimationVariables = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.on("spellCast", function (e) { return _this.onSpellCast(e); });
        var self = _this;
        _this.sp.hooks.sendAnimationEvent.add({
            enter: function (ctx) { },
            leave: function (ctx) {
                self.onSendAnimationEventLeave(ctx);
            }
        }, _this.playerId, _this.playerId);
        return _this;
    }
    MagicSyncService.prototype.onUpdate = function () {
        var _this = this;
        if (this.isAnyMagicStuffEquiped() === false) {
            return;
        }
        if (Date.now() - this.lastSendUpdateAnimationVariables <= this.sendUpdateAnimationVariablesRateMs) {
            return;
        }
        this.lastSendUpdateAnimationVariables = Date.now();
        this.controller.once('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.Game.getPlayer();
            if (!ac) {
                return;
            }
            var animVariables = _this.getAnimationVariablesFromActorConverted(ac.getFormID());
            _this.controller.emitter.emit("sendMessage", {
                message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.UpdateAnimVariables, data: _this.getUpdateAnimVariablesEventData(ac, animVariables) },
                reliability: "reliable"
            });
        });
    };
    MagicSyncService.prototype.onSpellCast = function (event) {
        var isInterruptCast = false;
        var msg = this.getSpellCastEventData(event, isInterruptCast);
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.SpellCast, data: msg },
            reliability: "reliable"
        });
        this.lastSpellCastEventMsg = msg;
    };
    MagicSyncService.prototype.onSendAnimationEventLeave = function (ctx) {
        var _this = this;
        if (!this.lastSpellCastEventMsg || !this.isInteraptSpellCastAnim(ctx.animEventName)) {
            return;
        }
        this.controller.once('update', function () {
            if (!_this.lastSpellCastEventMsg || _this.lastSpellCastEventMsg.interruptCast) {
                return;
            }
            var msg = _this.lastSpellCastEventMsg;
            msg.interruptCast = true;
            msg.actorAnimationVariables = _this.getAnimationVariablesFromActorConverted((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.remoteIdToLocalId)(_this.lastSpellCastEventMsg.caster));
            _this.controller.emitter.emit("sendMessage", {
                message: { t: _messages__WEBPACK_IMPORTED_MODULE_3__.MsgType.SpellCast, data: msg },
                reliability: "reliable"
            });
        });
    };
    MagicSyncService.prototype.getSpellCastEventData = function (e, isInterruptCast) {
        var spellCastData = {
            caster: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.caster.getFormID(), true),
            // @ts-expect-error (TODO: Remove in 2.10.0)
            target: e.target ? (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(e.target.getFormID(), true) : 0,
            spell: e.spell ? e.spell.getFormID() : 0,
            interruptCast: isInterruptCast,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            isDualCasting: e.isDualCasting,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            castingSource: e.castingSource,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            aimAngle: e.aimAngle,
            // @ts-expect-error (TODO: Remove in 2.10.0)
            aimHeading: e.aimHeading,
            actorAnimationVariables: this.getAnimationVariablesFromActorConverted(e.caster.getFormID()),
        };
        return spellCastData;
    };
    MagicSyncService.prototype.getAnimationVariablesFromActorConverted = function (actorId) {
        var animVars = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.getAnimationVariablesFromActor)(actorId);
        var booleans = animVars.booleans;
        var floats = animVars.floats;
        var integers = animVars.integers;
        return {
            booleans: Array.from(new Uint8Array(booleans)),
            floats: Array.from(new Uint8Array(floats)),
            integers: Array.from(new Uint8Array(integers)),
        };
    };
    MagicSyncService.prototype.getUpdateAnimVariablesEventData = function (ac, animVariables) {
        var animVarsData = {
            actorRemoteId: (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_0__.localIdToRemoteId)(ac.getFormID(), true),
            actorAnimationVariables: animVariables,
        };
        return animVarsData;
    };
    MagicSyncService.prototype.isInteraptSpellCastAnim = function (animEventName) {
        var eventName = animEventName.toLowerCase();
        return eventName === "mlh_equipped_event" || eventName === "mrh_equipped_event";
    };
    ;
    MagicSyncService.prototype.isSpellCastAnim = function (animEventName) {
        var eventName = animEventName.toLowerCase();
        var isSpellCastAnimForLeftHand = eventName === "mlh_spellaimedconcentrationstart" || eventName === "mlh_spellaimedstart" || eventName === "mlh_spellready_event" ||
            eventName === "mlh_spellrelease_event" || eventName === "mlh_equipped_event";
        var isSpellCastAnimForRightHand = eventName === "mrh_spellaimedconcentrationstart" || eventName === "mrh_spellaimedstart" || eventName === "mrh_spellready_event" ||
            eventName === "mrh_spellrelease_event" || eventName === "mrh_equipped_event";
        return isSpellCastAnimForLeftHand || isSpellCastAnimForRightHand;
    };
    ;
    MagicSyncService.prototype.isAnyMagicStuffEquiped = function () {
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.Game.getPlayer();
        if (!ac) {
            return false;
        }
        if (ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Left) || ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Right)) {
            return true;
        }
        if (ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Voise) || ac.getEquippedSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.SpellType.Instant)) {
            return true;
        }
        var leftHandEquipmentType = ac.getEquippedItemType(1 /* SlotType.Left */);
        var rightHandEquipmentType = ac.getEquippedItemType(2 /* SlotType.Right */);
        // TODO: Spell => SpellOrScroll, since Spell is now a deprecated name (TODO: Remove in 2.10.0)
        if (leftHandEquipmentType === 9 /* EquippedItemType.Spell */ || leftHandEquipmentType === 8 /* EquippedItemType.Staff */ ||
            rightHandEquipmentType === 9 /* EquippedItemType.Spell */ || rightHandEquipmentType === 8 /* EquippedItemType.Staff */) {
            return true;
        }
        return false;
    };
    return MagicSyncService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/netInfoService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/netInfoService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NetInfoService: () => (/* binding */ NetInfoService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var NetInfoService = /** @class */ (function (_super) {
    __extends(NetInfoService, _super);
    function NetInfoService(sp, controller) {
        var _this = this;
        var _a;
        _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.receivedPacketCount = 0;
        _this.sentPacketCount = 0;
        _this.localLagUnits = 0;
        _this.delayMs = 1000;
        _this.lastDt = 0;
        _this.dt = 0;
        _this.greenARGB = [0, 128, 0, 1];
        _this.redARGB = [255, 0, 0, 1];
        // clear previous texts in case of hotreload
        if (_this.sp.storage[NetInfoTexts.Name] && _this.sp.storage[NetInfoTexts.Name].clear) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Destroying old NetInfoTexts");
            try {
                (_a = _this.sp.storage[NetInfoTexts.Name]) === null || _a === void 0 ? void 0 : _a.clear();
            }
            catch (e) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(_this, "Failed to destroy old NetInfoTexts:", e);
            }
        }
        if (!_this.isEnabled()) {
            return _this;
        }
        _this.textIds = new NetInfoTexts(_this.sp);
        _this.sp.storage[NetInfoTexts.Name] = _this.textIds;
        _this.lastDt = Date.now();
        _this.controller.emitter.on("sendMessage", function (e) { return _this.onSendMessage(e); });
        _this.controller.emitter.on("sendMessageWithRefrId", function (e) { return _this.onSendMessageWithRefrId(e); });
        _this.controller.emitter.on("anyMessage", function (e) { return _this.onAnyMessage(e); });
        _this.controller.emitter.on("newLocalLagValueCalculated", function (e) { return _this.onNewLocalLagValueCalculated(e); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    NetInfoService.prototype.onSendMessage = function (e) {
        this.addSentPacketCount(1);
    };
    NetInfoService.prototype.onSendMessageWithRefrId = function (e) {
        this.addSentPacketCount(1);
    };
    NetInfoService.prototype.onAnyMessage = function (e) {
        this.addReceivedPacketCount(1);
    };
    NetInfoService.prototype.onNewLocalLagValueCalculated = function (e) {
        this.setLocalLagUnits(e.lagUnitsNoZ);
    };
    NetInfoService.prototype.onUpdate = function () {
        if (this.textIds === undefined) {
            return;
        }
        this.dt += Date.now() - this.lastDt;
        this.lastDt = Date.now();
        var isConnected = this.sp.mpClientPlugin.isConnected();
        this.sp.setTextString(this.textIds.connectionStateTextId, "".concat(isConnected ? "ON" : "OFF"));
        this.sp.setTextColor(this.textIds.connectionStateTextId, isConnected ? this.greenARGB : this.redARGB);
        // https://www.creationkit.com/index.php?title=Unit
        var units = this.getLocalLagUnits();
        var unitsInMeter = 70.0218818381;
        var meters = Math.round(units / unitsInMeter * 10) / 10;
        this.sp.setTextString(this.textIds.localPositionLagAmountTextId, "".concat(units, " units (~").concat(meters, " m)"));
        if (this.delayMs > this.dt) {
            return;
        }
        this.sp.setTextString(this.textIds.receivedPacketAmountTextId, "".concat(Math.round(this.getAndClearReceivedPacketCount())));
        this.sp.setTextString(this.textIds.sentPacketAmountTextId, "".concat(Math.round(this.getAndClearSentPacketCount())));
        this.dt = 0;
    };
    NetInfoService.prototype.addReceivedPacketCount = function (count) {
        this.receivedPacketCount += count;
    };
    NetInfoService.prototype.getAndClearReceivedPacketCount = function () {
        var value = this.receivedPacketCount;
        this.receivedPacketCount = 0;
        return value;
    };
    NetInfoService.prototype.addSentPacketCount = function (count) {
        this.sentPacketCount += count;
    };
    NetInfoService.prototype.getAndClearSentPacketCount = function () {
        var value = this.sentPacketCount;
        this.sentPacketCount = 0;
        return value;
    };
    NetInfoService.prototype.setLocalLagUnits = function (distance) {
        this.localLagUnits = distance;
    };
    NetInfoService.prototype.getLocalLagUnits = function () {
        return this.localLagUnits;
    };
    NetInfoService.prototype.isEnabled = function () {
        return !!this.sp.settings["skymp5-client"]["show-net-info"];
    };
    return NetInfoService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));

var NetInfoTexts = /** @class */ (function () {
    function NetInfoTexts(sp, connectionStaticTextId, connectionStateTextId, receivedPacketStaticTextId, receivedPacketAmountTextId, sentPacketStaticTextId, sentPacketAmountTextId, localPositionLagStaticTextId, localPositionLagAmountTextId) {
        if (connectionStaticTextId === void 0) { connectionStaticTextId = sp.createText(100, 350, "connection:", [255, 255, 255, 1]); }
        if (connectionStateTextId === void 0) { connectionStateTextId = sp.createText(220, 350, "", [255, 255, 255, 1]); }
        if (receivedPacketStaticTextId === void 0) { receivedPacketStaticTextId = sp.createText(120, 390, "incoming (p/s):", [255, 255, 255, 1]); }
        if (receivedPacketAmountTextId === void 0) { receivedPacketAmountTextId = sp.createText(250, 390, "", [255, 255, 255, 1]); }
        if (sentPacketStaticTextId === void 0) { sentPacketStaticTextId = sp.createText(120, 430, "outgoing (p/s):", [255, 255, 255, 1]); }
        if (sentPacketAmountTextId === void 0) { sentPacketAmountTextId = sp.createText(250, 430, "", [255, 255, 255, 1]); }
        if (localPositionLagStaticTextId === void 0) { localPositionLagStaticTextId = sp.createText(90, 470, "local lag:", [255, 255, 255, 1]); }
        if (localPositionLagAmountTextId === void 0) { localPositionLagAmountTextId = sp.createText(250, 470, "", [255, 255, 255, 1]); }
        this.sp = sp;
        this.connectionStaticTextId = connectionStaticTextId;
        this.connectionStateTextId = connectionStateTextId;
        this.receivedPacketStaticTextId = receivedPacketStaticTextId;
        this.receivedPacketAmountTextId = receivedPacketAmountTextId;
        this.sentPacketStaticTextId = sentPacketStaticTextId;
        this.sentPacketAmountTextId = sentPacketAmountTextId;
        this.localPositionLagStaticTextId = localPositionLagStaticTextId;
        this.localPositionLagAmountTextId = localPositionLagAmountTextId;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.connectionStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.connectionStateTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.receivedPacketStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.receivedPacketAmountTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.sentPacketStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.sentPacketAmountTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.localPositionLagStaticTextId, 0.5);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.localPositionLagAmountTextId, 0.5);
    }
    NetInfoTexts.prototype.clear = function () {
        this.sp.destroyText(this.connectionStaticTextId);
        this.sp.destroyText(this.connectionStateTextId);
        this.sp.destroyText(this.receivedPacketStaticTextId);
        this.sp.destroyText(this.receivedPacketAmountTextId);
        this.sp.destroyText(this.sentPacketStaticTextId);
        this.sp.destroyText(this.sentPacketAmountTextId);
        this.sp.destroyText(this.localPositionLagStaticTextId);
        this.sp.destroyText(this.localPositionLagAmountTextId);
    };
    NetInfoTexts.Name = "netInfoTexts";
    return NetInfoTexts;
}());


/***/ }),

/***/ "./src/services/services/networkingService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/networkingService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   NetworkingService: () => (/* binding */ NetworkingService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var NetworkingService = /** @class */ (function (_super) {
    __extends(NetworkingService, _super);
    function NetworkingService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.emitter.on("sendMessage", function (e) { return _this.onSendMessage(e); });
        _this.controller.emitter.on("sendRawMessage", function (e) { return _this.onSendRawMessage(e); });
        _this.controller.emitter.on("sendMessageWithRefrId", function (e) { return _this.onSendMessageWithRefrId(e); });
        return _this;
    }
    NetworkingService.prototype.onSendMessage = function (e) {
        this.sp.mpClientPlugin.send(JSON.stringify(e.message), this.isReliable(e.reliability));
    };
    NetworkingService.prototype.onSendRawMessage = function (e) {
        // @ts-expect-error
        this.sp.mpClientPlugin.sendRaw(e.rawMessage, e.rawMessage.byteLength, this.isReliable(e.reliability));
    };
    NetworkingService.prototype.onSendMessageWithRefrId = function (e) {
        var refrId = e.message._refrId;
        var remoteServer = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_4__.RemoteServer);
        var idxInModel = refrId
            ? remoteServer.getWorldModel().forms.findIndex(function (f) { return f && f.refrId === refrId; })
            : remoteServer.getWorldModel().playerCharacterFormIdx;
        // fixes "can't get property idx of null or undefined"
        if (!remoteServer.getWorldModel().forms[idxInModel]) {
            return;
        }
        // @ts-ignore
        e.message.idx = remoteServer.getWorldModel().forms[idxInModel].idx;
        delete e.message._refrId;
        this.sp.mpClientPlugin.send(JSON.stringify(e.message), this.isReliable(e.reliability));
    };
    NetworkingService.prototype.connect = function (hostName, port) {
        this.serverAddress = { hostName: hostName, port: port };
        this.createClientSafe();
    };
    NetworkingService.prototype.reconnect = function () {
        this.createClientSafe();
    };
    NetworkingService.prototype.close = function () {
        this.sp.mpClientPlugin.destroyClient();
    };
    NetworkingService.prototype.isConnected = function () {
        return this.sp.mpClientPlugin.isConnected();
    };
    NetworkingService.prototype.onTick = function () {
        var _this = this;
        this.sp.mpClientPlugin.tick(function (packetType, rawContent, error) {
            switch (packetType) {
                case "connectionAccepted":
                    _this.controller.emitter.emit("connectionAccepted", {});
                    break;
                case "connectionDenied":
                    _this.controller.emitter.emit("connectionDenied", { error: error });
                    _this.reconnect();
                    break;
                case "connectionFailed":
                    _this.controller.emitter.emit("connectionFailed", {});
                    _this.reconnect();
                    break;
                case "disconnect":
                    _this.controller.emitter.emit("connectionDisconnect", {});
                    _this.reconnect();
                    break;
                case "message":
                    // TODO: in theory can be empty jsonContent and non-empty error
                    var msgAny = void 0;
                    if (rawContent === null) {
                        msgAny = {};
                        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(_this, "null rawContent");
                    }
                    else if ((new Uint8Array(rawContent)[0]) === 0x7b) {
                        // assume json
                        msgAny = JSON.parse(_this.sp.decodeUtf8(rawContent));
                    }
                    else {
                        // assume raw
                        var event = { rawContent: rawContent };
                        return _this.controller.emitter.emit("anyRawMessage", event);
                    }
                    if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.OpenContainer) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("openContainerMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateMovement) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateMovementMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimation) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAnimationMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateEquipment) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateEquipmentMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.ChangeValues) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("changeValuesMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SpellCast) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("spellCastMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimVariables) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAnimVariablesMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAppearance) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateAppearanceMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Teleport) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("teleportMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateProperty) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updatePropertyMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.DeathStateContainer) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("deathStateContainerMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CreateActor) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("createActorMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.CustomPacket) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("customPacketMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.DestroyActor) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("destroyActorMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.HostStart) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("hostStartMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.HostStop) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("hostStopMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SetInventory) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("setInventoryMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SetRaceMenuOpen) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("setRaceMenuOpenMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.SpSnippet) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("spSnippetMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateGamemodeData) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("updateGamemodeDataMessage", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else if (msgAny.t === _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Teleport2) {
                        var event = { message: msgAny };
                        _this.controller.emitter.emit("teleportMessage2", event);
                        _this.controller.emitter.emit("anyMessage", event);
                    }
                    else {
                        // throw new NeverError(msgAny);
                        throw new Error("Unhandled MsgType " + msgAny.t);
                    }
                    break;
            }
        });
    };
    NetworkingService.prototype.createClientSafe = function () {
        var _a = this.serverAddress, hostName = _a.hostName, port = _a.port;
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "createClientSafe " + hostName + ":" + port);
        if (this.serverAddress.hostName !== "" && this.serverAddress.port !== 0) {
            this.sp.mpClientPlugin.createClient(hostName, port);
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "createClientSafe failed");
        }
    };
    Object.defineProperty(NetworkingService.prototype, "serverAddress", {
        get: function () {
            var res = this.sp.storage["serverAddress"];
            if (typeof res === "object") {
                var result = res;
                if (typeof result.hostName === "string" && typeof result.port === "number") {
                    return result;
                }
            }
            return { hostName: "", port: 0 };
        },
        set: function (newValue) {
            this.sp.storage["serverAddress"] = newValue;
        },
        enumerable: false,
        configurable: true
    });
    NetworkingService.prototype.isReliable = function (reliability) {
        switch (reliability) {
            case "reliable":
                return true;
            case "unreliable":
                return false;
            default:
                throw new _lib_errors__WEBPACK_IMPORTED_MODULE_1__.NeverError(reliability);
        }
    };
    return NetworkingService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_3__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/playerBowShotService.ts":
/*!*******************************************************!*\
  !*** ./src/services/services/playerBowShotService.ts ***!
  \*******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PlayerBowShotService: () => (/* binding */ PlayerBowShotService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();





var PlayerBowShotService = /** @class */ (function (_super) {
    __extends(PlayerBowShotService, _super);
    function PlayerBowShotService(sp, controller) {
        var _this_1 = _super.call(this) || this;
        _this_1.sp = sp;
        _this_1.controller = controller;
        _this_1.score = 0;
        _this_1.inventoryUnblockMoment = 0;
        _this_1.controller.emitter.on("queryBlockSetInventoryEvent", function (e) { return _this_1.onQueryBlockSetInventoryEvent(e); });
        _this_1.controller.on("playerBowShot", function (e) { return _this_1.onPlayerBowShot(e); });
        var _this = _this_1;
        var eventPatterns = ["attackRelease", "crossbowAttackStart"];
        eventPatterns.forEach(function (eventPattern) {
            _this_1.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) {
                },
                leave: function (ctx) {
                    if (!ctx.animationSucceeded) {
                        return;
                    }
                    if (ctx.animEventName === "crossbowAttackStart") {
                        _this.score = 1;
                    }
                    else if (ctx.animEventName === "attackRelease") {
                        if (_this.score === 1) {
                            _this.controller.once("update", function () { _this.onPlayerCrossbowShot(); });
                            _this.score = 0;
                        }
                    }
                    else {
                        _this.score = 0;
                    }
                }
            }, 0x14, 0x14, eventPattern);
        });
        return _this_1;
    }
    PlayerBowShotService.prototype.onQueryBlockSetInventoryEvent = function (e) {
        if (Date.now() < this.inventoryUnblockMoment) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Blocked inventory operation");
            e.block();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Not blocked inventory operation");
        }
    };
    PlayerBowShotService.prototype.onPlayerBowShot = function (e) {
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PlayerBowShot,
                weaponId: e.weapon.getFormID(),
                ammoId: e.ammo.getFormID(),
                power: e.power,
                isSunGazing: e.isSunGazing || false
            },
            reliability: "unreliable"
        });
    };
    PlayerBowShotService.prototype.onPlayerCrossbowShot = function () {
        var actor = this.sp.Game.getPlayer();
        if (actor === null) {
            return;
        }
        var crossbow = actor.getEquippedWeapon(false);
        if (crossbow === null) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Couldn't get equipped weapon");
            return;
        }
        var weaponType = crossbow.getWeaponType();
        if (weaponType !== 9 /* WeaponType.Crossbow */) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Expected weapon to be crossbow, but got WeaponType", weaponType);
            return;
        }
        var equippedAmmoEntries = (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.getEquipment)(actor, 0).inv.entries.filter(function (entry) { return entry.worn && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(entry.baseId)); });
        if (equippedAmmoEntries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Ammo not found");
            return;
        }
        if (equippedAmmoEntries.length > 1) {
            var equippedAmmoIds = equippedAmmoEntries.map(function (entry) { return entry.baseId; });
            (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logError)(this, "Found more than 1 ammos:", equippedAmmoIds);
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.PlayerBowShot,
                weaponId: crossbow.getFormID(),
                ammoId: equippedAmmoEntries[0].baseId,
                isSunGazing: false,
                power: 1.0
            },
            reliability: "unreliable"
        });
        // Fixes race condition when the server removes an item faster than local crossbow does that: -1 total
        // Then crossbow removes one more item: -2 total
        // The item is being added back: -1 total (which is correct but looks ugly in process)
        this.inventoryUnblockMoment = Date.now() + 5 * 1000;
        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(this, "Sent crossbow shot");
    };
    return PlayerBowShotService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/profilingService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/profilingService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ProfilingService: () => (/* binding */ ProfilingService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var inspector__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! inspector */ "inspector");
/* harmony import */ var inspector__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(inspector__WEBPACK_IMPORTED_MODULE_2__);
/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! fs */ "fs");
/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_3__);
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};




var ProfilingService = /** @class */ (function (_super) {
    __extends(ProfilingService, _super);
    function ProfilingService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        var settings = sp.settings["skymp5-client"];
        if (!settings["enableProfiling"]) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "ProfilingService: disabled");
            return _this;
        }
        var profilingDurationMs = _this.getInteger(settings["profilingDurationMs"]) || 10000;
        var session = new inspector__WEBPACK_IMPORTED_MODULE_2__.Session();
        session.connect();
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "ProfilingService: start");
        _this.startProfiling(session, profilingDurationMs);
        return _this;
    }
    ProfilingService.prototype.startProfiling = function (session, profilingDurationMs) {
        return __awaiter(this, void 0, void 0, function () {
            var profile, fileNameSuffix;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, new Promise(function (resolve, reject) {
                            session.post('Profiler.enable', function (err) {
                                if (err) {
                                    reject(err);
                                }
                                else {
                                    resolve(undefined);
                                }
                            });
                        })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, new Promise(function (resolve, reject) {
                                session.post('Profiler.start', function (err) {
                                    if (err) {
                                        reject(err);
                                    }
                                    else {
                                        resolve(undefined);
                                    }
                                });
                            })];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, new Promise(function (resolve) {
                                setTimeout(resolve, profilingDurationMs);
                            })];
                    case 3:
                        _a.sent();
                        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(this, "ProfilingService: stop");
                        return [4 /*yield*/, new Promise(function (resolve, reject) {
                                session.post('Profiler.stop', function (err, res) {
                                    if (err) {
                                        reject(err);
                                    }
                                    else {
                                        resolve(res);
                                    }
                                });
                            })];
                    case 4:
                        profile = (_a.sent()).profile;
                        fileNameSuffix = Math.random().toString().replace(".0", "");
                        fs__WEBPACK_IMPORTED_MODULE_3__.writeFileSync("./profile".concat(fileNameSuffix, ".cpuprofile"), JSON.stringify(profile));
                        return [2 /*return*/];
                }
            });
        });
    };
    ProfilingService.prototype.getInteger = function (value) {
        if (typeof value === 'number') {
            if (Number.isInteger(value)) {
                return value;
            }
        }
        return undefined;
    };
    return ProfilingService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/ragdollService.ts":
/*!*************************************************!*\
  !*** ./src/services/services/ragdollService.ts ***!
  \*************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   RagdollService: () => (/* binding */ RagdollService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var RagdollService = /** @class */ (function (_super) {
    __extends(RagdollService, _super);
    function RagdollService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        // TODO: think about tracking ragdoll state of player
        _this.safeRemoveRagdollFromWorld = function (actor, afterRemoveCallback) {
            _this.setLocalDamageMult(0);
            actor.forceRemoveRagdollFromWorld().then(function () {
                _this.controller.once("update", function () {
                    _this.setLocalDamageMult(_this.defaultLocalDamageMult);
                    afterRemoveCallback();
                });
            });
        };
        _this.defaultLocalDamageMult = 1;
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    RagdollService.prototype.onceUpdate = function () {
        this.setLocalDamageMult(this.defaultLocalDamageMult);
    };
    RagdollService.prototype.setLocalDamageMult = function (damageMult) {
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCE", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCH", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCL", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCN", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCVE", damageMult);
        this.sp.Game.setGameSettingFloat("fDiffMultHPToPCVH", damageMult);
    };
    return RagdollService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/remoteServer.ts":
/*!***********************************************!*\
  !*** ./src/services/services/remoteServer.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   RemoteServer: () => (/* binding */ RemoteServer),
/* harmony export */   getPcInventory: () => (/* binding */ getPcInventory)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _lib_idManager__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../lib/idManager */ "./src/lib/idManager.ts");
/* harmony import */ var _lib_nameof__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../lib/nameof */ "./src/lib/nameof.ts");
/* harmony import */ var _sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../sync/actorvalues */ "./src/sync/actorvalues.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _sync_spell__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../../sync/spell */ "./src/sync/spell.ts");
/* harmony import */ var _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ../../view/modelApplyUtils */ "./src/view/modelApplyUtils.ts");
/* harmony import */ var _loadGameService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./loadGameService */ "./src/services/services/loadGameService.ts");
/* harmony import */ var _ragdollService__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./ragdollService */ "./src/services/services/ragdollService.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ../../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _timeService__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./timeService */ "./src/services/services/timeService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _voiceChatService__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./voiceChatService */ "./src/services/services/voiceChatService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
// @ts-expect-error (TODO: Remove in 2.10.0)



/* eslint-disable @typescript-eslint/no-empty-function */













// TODO: refactor worldViewMisc into service





var getPcInventory = function () {
    var res = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['pcInv'];
    if (typeof res === 'object' && res['entries']) {
        return res;
    }
    return undefined;
};
var setPcInventory = function (inv) {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['pcInv'] = inv;
};
var pcInvLastApply = 0;
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.on)('update', function () {
    if ((0,_sync_equipment__WEBPACK_IMPORTED_MODULE_7__.isBadMenuShown)()) {
        return;
    }
    if (Date.now() - pcInvLastApply > 5000) {
        pcInvLastApply = Date.now();
        var pcInv = getPcInventory();
        if (pcInv) {
            (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_8__.applyInventory)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), pcInv, false, true);
        }
    }
});
var unequipIronHelmet = function () {
    var ironHelment = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Armor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(0x00012e4d));
    var pl = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
    if (pl) {
        pl.unequipItem(ironHelment, false, true);
    }
};
var RemoteServer = /** @class */ (function (_super) {
    __extends(RemoteServer, _super);
    function RemoteServer(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.numSetInventory = 0;
        _this.controller.emitter.on("hostStartMessage", function (e) { return _this.onHostStartMessage(e); });
        _this.controller.emitter.on("hostStopMessage", function (e) { return _this.onHostStopMessage(e); });
        _this.controller.emitter.on("setInventoryMessage", function (e) { return _this.onSetInventoryMessage(e); });
        _this.controller.emitter.on("openContainerMessage", function (e) { return _this.onOpenContainerMessage(e); });
        _this.controller.emitter.on("updateMovementMessage", function (e) { return _this.onUpdateMovementMessage(e); });
        _this.controller.emitter.on("updateAnimationMessage", function (e) { return _this.onUpdateAnimationMessage(e); });
        _this.controller.emitter.on("updateEquipmentMessage", function (e) { return _this.onUpdateEquipmentMessage(e); });
        _this.controller.emitter.on("changeValuesMessage", function (e) { return _this.onChangeValuesMessage(e); });
        _this.controller.emitter.on("updateAppearanceMessage", function (e) { return _this.onUpdateAppearanceMessage(e); });
        _this.controller.emitter.on("teleportMessage", function (e) { return _this.onTeleportMessage(e); });
        _this.controller.emitter.on("teleportMessage2", function (e) { return _this.onTeleportMessage(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        _this.controller.emitter.on("destroyActorMessage", function (e) { return _this.onDestroyActorMessage(e); });
        _this.controller.emitter.on("setRaceMenuOpenMessage", function (e) { return _this.onSetRaceMenuOpenMessage(e); });
        _this.controller.emitter.on("updatePropertyMessage", function (e) { return _this.onUpdatePropertyMessage(e); });
        _this.controller.emitter.on("deathStateContainerMessage", function (e) { return _this.onDeathStateContainerMessage(e); });
        _this.controller.emitter.on("connectionAccepted", function () { return _this.handleConnectionAccepted(); });
        _this.controller.emitter.on("spellCastMessage", function (e) { return _this.onSpellCastMessage(e); });
        _this.controller.emitter.on("updateAnimVariablesMessage", function (e) { return _this.onUpdateAnimVariablesMessage(e); });
        _this.controller.emitter.on("voiceChatMessage", function (e) { return _this.onVoiceChatMessage(e); });
        _this.controller.emitter.on("updateVoiceChatMessage", function (e) { return _this.onUpdateVoiceChatMessage(e); });
        return _this;
    }
    RemoteServer.prototype.onHostStartMessage = function (event) {
        var msg = event.message;
        var target = msg.target;
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        if (typeof hosted !== typeof []) {
            // if you try to switch to Set please checkout .concat usage.
            // concat compiles but doesn't work as expected
            hosted = new Array();
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'] = hosted;
        }
        if (!hosted.includes(target)) {
            hosted.push(target);
        }
    };
    RemoteServer.prototype.onHostStopMessage = function (event) {
        var msg = event.message;
        var target = msg.target;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, 'hostStop ' + target.toString(16));
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        if (typeof hosted === typeof []) {
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'] = hosted.filter(function (x) { return x !== target; });
        }
    };
    RemoteServer.prototype.onSetInventoryMessage = function (event) {
        var _this = this;
        this.numSetInventory++;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            setPcInventory(msg.inventory);
            var blocked = false;
            _this.controller.emitter.emit('queryBlockSetInventoryEvent', {
                block: function () { return blocked = true; }
            });
            if (!blocked) {
                pcInvLastApply = 0;
            }
        });
    };
    RemoteServer.prototype.onOpenContainerMessage = function (event) {
        var _this = this;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return __awaiter(_this, void 0, void 0, function () {
            var remoteId, localId, refr, baseObject, baseType, functionChecker, factName, delaySeconds;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                    case 1:
                        _a.sent(); // Give a chance to update inventory
                        remoteId = event.message.target;
                        localId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(remoteId);
                        refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(localId));
                        if (refr === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, 'onOpenContainerMessage - refr not found', 'remoteId', remoteId.toString(16), 'localId', localId.toString(16));
                            return [2 /*return*/];
                        }
                        refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), true);
                        baseObject = refr.getBaseObject();
                        baseType = baseObject === null || baseObject === void 0 ? void 0 : baseObject.getType();
                        functionChecker = null;
                        factName = "";
                        delaySeconds = -1.0;
                        if (baseType === 28 /* FormType.Container */) {
                            functionChecker = function () { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen("ContainerMenu"); };
                            factName = "'ContainerMenu open'";
                            delaySeconds = 0.0;
                        }
                        else if (baseType === 40 /* FormType.Furniture */) {
                            functionChecker = function () { var _a; return !!((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.getFurnitureReference()); };
                            factName = "'getFurnitureReference not null'";
                            delaySeconds = 1.0;
                        }
                        if (functionChecker === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - not a container or furniture", baseType);
                            return [2 /*return*/];
                        }
                        // In SkyMP containers have 2-nd, closing activation under the hood.
                        // This differs from Skyrim's behavior, where it's just one activation.
                        (function () { return __awaiter(_this, void 0, void 0, function () {
                            var message;
                            var _this = this;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting for", factName, "to be true");
                                        _a.label = 1;
                                    case 1:
                                        if (!!functionChecker()) return [3 /*break*/, 3];
                                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                                    case 2:
                                        _a.sent();
                                        return [3 /*break*/, 1];
                                    case 3:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting for", factName, "to be false");
                                        _a.label = 4;
                                    case 4:
                                        if (!functionChecker()) return [3 /*break*/, 6];
                                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1)];
                                    case 5:
                                        _a.sent();
                                        return [3 /*break*/, 4];
                                    case 6:
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - menu closed", factName);
                                        message = {
                                            t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.Activate,
                                            data: {
                                                caster: 0x14, target: event.message.target, isSecondActivation: true
                                            }
                                        };
                                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "onOpenContainerMesage - waiting", delaySeconds, "seconds before sending ActivateMessage");
                                        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.waitMenuMode(delaySeconds).then(function () {
                                            _this.controller.emitter.emit("sendMessage", {
                                                message: message,
                                                reliability: "reliable"
                                            });
                                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "onOpenContainerMesage - sent ActivateMessage", message);
                                        });
                                        return [2 /*return*/];
                                }
                            });
                        }); })();
                        return [2 /*return*/];
                }
            });
        }); });
    };
    RemoteServer.prototype.onTeleportMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var id = ("idx" in msg && typeof msg.idx === "number") ? _this.getIdManager().getId(msg.idx) : _this.getMyActorIndex();
            var refr = id === _this.getMyActorIndex() ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer() : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getObjectReference)(id);
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "Teleporting id", id, "refrId", refr === null || refr === void 0 ? void 0 : refr.getFormID().toString(16), "...", msg.pos, 'cell/world is', msg.worldOrCell.toString(16));
            var ragdollService = _this.controller.lookupListener(_ragdollService__WEBPACK_IMPORTED_MODULE_12__.RagdollService);
            var refrId = refr === null || refr === void 0 ? void 0 : refr.getFormID();
            var removeRagdollCallback = function () {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.moveRefrToPosition(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId || 0)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Cell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.worldOrCell)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.WorldSpace.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.worldOrCell)), msg.pos[0], msg.pos[1], msg.pos[2], msg.rot[0], msg.rot[1], msg.rot[2]);
            };
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor /*&& actor.getFormID() === 0x14*/) {
                ragdollService.safeRemoveRagdollFromWorld(actor, removeRagdollCallback);
            }
            else {
                removeRagdollCallback();
            }
        });
    };
    RemoteServer.prototype.onCreateActorMessage = function (event) {
        var _this = this;
        var _a;
        var msg = event.message;
        if (this.skipFormViewCreation(msg)) {
            var refrId_1 = msg.refrId;
            this.onceLoad(refrId_1, function (refr) {
                var _a;
                if (refr) {
                    _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.dealWithRef(refr, refr.getBaseObject());
                    if (msg.props) {
                        if (msg.props.inventory) {
                            _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelInventory(refr, msg.props.inventory);
                        }
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsOpen(refr, !!msg.props['isOpen']);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsHarvested(refr, !!msg.props['isHarvested']);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelNodeScale(refr, msg.props.setNodeScale);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelNodeTextureSet(refr, msg.props.setNodeTextureSet);
                        _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsDisabled(refr, !!msg.props['disabled']);
                        // TODO: move to a separate module
                        var animation_1 = msg.props.lastAnimation;
                        if (typeof animation_1 === "string") {
                            var refrid_1 = refr.getFormID();
                            (function () { return __awaiter(_this, void 0, void 0, function () {
                                var i_1, res2;
                                var _a;
                                return __generator(this, function (_b) {
                                    switch (_b.label) {
                                        case 0:
                                            i_1 = 0;
                                            _b.label = 1;
                                        case 1:
                                            if (!(i_1 < 5)) return [3 /*break*/, 4];
                                            res2 = (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrid_1))) === null || _a === void 0 ? void 0 : _a.playAnimation(animation_1);
                                            if (res2) {
                                                return [3 /*break*/, 4];
                                            }
                                            return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(2)];
                                        case 2:
                                            _b.sent();
                                            _b.label = 3;
                                        case 3:
                                            i_1++;
                                            return [3 /*break*/, 1];
                                        case 4: return [2 /*return*/];
                                    }
                                });
                            }); })();
                        }
                        var displayName = msg.props.displayName;
                        // keep in sync with spSnippetService.ts
                        if (typeof displayName === "string") {
                            var replaceValue = (_a = refr.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getName();
                            if (replaceValue !== undefined) {
                                displayName = displayName.replace(/%original_name%/g, replaceValue);
                            }
                            else {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, "Couldn't get a replaceValue for SetDisplayName, refr.getFormID() was", refr.getFormID().toString(16));
                            }
                            refr.setDisplayName(displayName, true);
                            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "calling setDisplayName", displayName, "for", refr.getFormID().toString(16));
                        }
                    }
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed to apply model to', refrId_1.toString(16));
                }
            });
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Create actor");
        var i = this.getIdManager().allocateIdFor(msg.idx);
        if (this.worldModel.forms.length <= i) {
            this.worldModel.forms.length = i + 1;
        }
        var movement = undefined;
        // TODO: better check if it is an npc (not an object reference)
        if (msg.refrId !== undefined && msg.refrId >= 0xff000000) {
            movement = {
                pos: msg.transform.pos,
                rot: msg.transform.rot,
                worldOrCell: msg.transform.worldOrCell,
                runMode: 'Standing',
                direction: 0,
                isInJumpState: false,
                isSneaking: false,
                isBlocking: false,
                isWeapDrawn: false,
                isDead: false,
                healthPercentage: 1.0,
                speed: 0,
            };
        }
        var form = {
            idx: msg.idx,
            movement: movement,
            numMovementChanges: 0,
            numAppearanceChanges: 0,
            baseId: msg.baseId,
            refrId: msg.refrId,
            isMyClone: msg.isMe,
        };
        this.worldModel.forms[i] = form;
        if (msg.appearance) {
            form.appearance = msg.appearance;
        }
        if (msg.equipment) {
            form.equipment = msg.equipment;
        }
        if (msg.isDead) {
            form.isDead = msg.isDead;
        }
        if (msg.animation) {
            form.animation = msg.animation;
        }
        if (msg.props) {
            for (var propName in msg.props) {
                form[propName] = msg.props[propName];
            }
        }
        msg.customPropsJsonDumps.forEach(function (element) {
            var _a;
            var parsed;
            try {
                parsed = JSON.parse(element.propValueJsonDump);
            }
            catch (e) {
                if (e instanceof SyntaxError) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, "createActor", (_a = msg.refrId) === null || _a === void 0 ? void 0 : _a.toString(16), "failed to parse custom prop", element.propName, element.propValueJsonDump, e.message);
                }
                else {
                    throw e;
                }
            }
            form[element.propName] = parsed;
        });
        if (msg.isMe) {
            this.worldModel.playerCharacterFormIdx = i;
            this.worldModel.playerCharacterRefrId = msg.refrId || 0;
        }
        // TODO: move to a separate module
        if (msg.props && !msg.props.isHostedByOther) {
        }
        if (msg.props && msg.props.isRaceMenuOpen && msg.isMe) {
            this.onSetRaceMenuOpenMessage({ message: { t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.SetRaceMenuOpen, open: true } });
        }
        var numSetInventory = this.numSetInventory;
        var applyPcInv = function () {
            if (msg.equipment) {
                (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_7__.applyEquipment)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), msg.equipment);
            }
            if (numSetInventory !== _this.numSetInventory) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, 'Skipping inventory apply due to newer setInventory message');
                return;
            }
            if (msg.props && msg.props.inventory) {
                _this.onSetInventoryMessage({
                    message: {
                        t: _messages__WEBPACK_IMPORTED_MODULE_1__.MsgType.SetInventory,
                        inventory: msg.props.inventory
                    }
                });
            }
        };
        if (msg.isMe && msg.props && msg.props.learnedSpells) {
            var learnedSpells_1 = msg.props.learnedSpells;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(function () {
                    var player = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                    if (player) {
                        (0,_sync_spell__WEBPACK_IMPORTED_MODULE_9__.removeAllSpells)(player);
                        (0,_sync_spell__WEBPACK_IMPORTED_MODULE_9__.learnSpells)(player, learnedSpells_1);
                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "player learnedSpells:", JSON.stringify(learnedSpells_1));
                    }
                });
            });
        }
        if (msg.isMe) {
            if ((_a = msg.props) === null || _a === void 0 ? void 0 : _a.isDead) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
                    _this.controller.emitter.emit("applyDeathStateEvent", {
                        actor: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(),
                        isDead: true
                    });
                });
            }
        }
        if (msg.isMe) {
            var spawnTask_1 = { running: false };
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                // Use MoveRefrToPosition to spawn if possible (not in main menu)
                // In case of connection lost this is essential
                if (!spawnTask_1.running) {
                    spawnTask_1.running = true;
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, 'Using moveRefrToPosition to spawn player');
                    (function () { return __awaiter(_this, void 0, void 0, function () {
                        var pl, pos, sqr, distance;
                        return __generator(this, function (_a) {
                            switch (_a.label) {
                                case 0:
                                    if (false) {}
                                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, 'Spawning...');
                                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.moveRefrToPosition(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer(), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Cell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.transform.worldOrCell)), skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.WorldSpace.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(msg.transform.worldOrCell)), msg.transform.pos[0], msg.transform.pos[1], msg.transform.pos[2], msg.transform.rot[0], msg.transform.rot[1], msg.transform.rot[2]);
                                    return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1)];
                                case 1:
                                    _a.sent();
                                    pl = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                                    if (!pl) {
                                        return [3 /*break*/, 2];
                                    }
                                    pos = [
                                        pl.getPositionX(),
                                        pl.getPositionY(),
                                        pl.getPositionZ(),
                                    ];
                                    sqr = function (x) { return x * x; };
                                    distance = Math.sqrt(sqr(pos[0] - msg.transform.pos[0]) +
                                        sqr(pos[1] - msg.transform.pos[1]));
                                    if (distance < 256) {
                                        return [3 /*break*/, 2];
                                    }
                                    return [3 /*break*/, 0];
                                case 2: return [2 /*return*/];
                            }
                        });
                    }); })();
                    // Unfortunatelly it requires two calls to work
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(applyPcInv);
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1.3).then(applyPcInv);
                    // Note: appearance part was copy-pasted
                    if (msg.appearance) {
                        (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(msg.appearance);
                    }
                }
                if (msg.props) {
                    var baseActorValues_1 = new Map([
                        ['healRate', msg.props.healRate],
                        ['healRateMult', msg.props.healRateMult],
                        ['health', msg.props.health],
                        ['magickaRate', msg.props.magickaRate],
                        ['magickaRateMult', msg.props.magickaRateMult],
                        ['magicka', msg.props.magicka],
                        ['staminaRate', msg.props.staminaRate],
                        ['staminaRateMult', msg.props.staminaRateMult],
                        ['stamina', msg.props.stamina],
                        ['healthPercentage', msg.props.healthPercentage],
                        ['staminaPercentage', msg.props.staminaPercentage],
                        ['magickaPercentage', msg.props.magickaPercentage],
                    ]);
                    var player_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                    if (player_1) {
                        baseActorValues_1.forEach(function (value, key) {
                            if (typeof value === 'number') {
                                if (key.includes('Percentage')) {
                                    var subKey = key.replace('Percentage', '');
                                    var subValue = baseActorValues_1.get(subKey);
                                    if (typeof subValue === 'number') {
                                        (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(player_1, subKey, value);
                                    }
                                }
                                else {
                                    player_1.setActorValue(key, value);
                                }
                            }
                        });
                    }
                }
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('tick', function () {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('tick', function () {
                    if (!spawnTask_1.running) {
                        spawnTask_1.running = true;
                        var loadOrder = new Array();
                        for (var i_2 = 0; i_2 < _this.sp.Game.getModCount(); ++i_2) {
                            loadOrder.push(_this.sp.Game.getModName(i_2));
                        }
                        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "loading game in world/cell", msg.transform.worldOrCell.toString(16));
                        var loadGameService = _this.controller.lookupListener(_loadGameService__WEBPACK_IMPORTED_MODULE_11__.LoadGameService);
                        loadGameService.loadGame(msg.transform.pos, msg.transform.rot, msg.transform.worldOrCell, msg.appearance
                            ? {
                                name: msg.appearance.name,
                                raceId: msg.appearance.raceId,
                                // TODO: In types, isFemale is under face, but in the reality SP expects it here. Fix required.
                                // @ts-expect-error
                                isFemale: msg.appearance.isFemale,
                                face: {
                                    hairColor: msg.appearance.hairColor,
                                    bodySkinColor: msg.appearance.skinColor,
                                    headTextureSetId: msg.appearance.headTextureSetId,
                                    headPartIds: msg.appearance.headpartIds,
                                    presets: msg.appearance.presets
                                },
                            }
                            : undefined, loadOrder, { minutes: 0, seconds: 0, hours: _this.controller.lookupListener(_timeService__WEBPACK_IMPORTED_MODULE_16__.TimeService).getTime().newGameHourValue });
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                            applyPcInv();
                            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.3).then(applyPcInv);
                            // Note: appearance part was copy-pasted
                            if (msg.appearance) {
                                (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(msg.appearance);
                            }
                        });
                    }
                });
            });
        }
    };
    RemoteServer.prototype.onDestroyActorMessage = function (event) {
        var _a;
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        this.worldModel.forms[i] = undefined;
        (_a = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getViewFromStorage)()) === null || _a === void 0 ? void 0 : _a.syncFormArray(this.worldModel);
        // Shrink to fit
        while (1) {
            var length = this.worldModel.forms.length;
            if (!length) {
                break;
            }
            if (this.worldModel.forms[length - 1]) {
                break;
            }
            this.worldModel.forms.length = length - 1;
        }
        if (this.worldModel.playerCharacterFormIdx === i) {
            this.worldModel.playerCharacterFormIdx = -1;
            this.worldModel.playerCharacterRefrId = 0;
            // TODO: move to a separate module
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.quitToMainMenu(); });
        }
        this.getIdManager().freeIdFor(msg.idx);
    };
    RemoteServer.prototype.onUpdateMovementMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateMovementMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.movement = msg.data;
        if (!form.numMovementChanges) {
            form.numMovementChanges = 0;
        }
        form.numMovementChanges++;
    };
    RemoteServer.prototype.onUpdateAnimationMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateAnimationMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.animation = msg.data;
    };
    RemoteServer.prototype.onUpdateAppearanceMessage = function (event) {
        var _this = this;
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateAppearanceMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.appearance = msg.data || undefined;
        if (!form.numAppearanceChanges) {
            form.numAppearanceChanges = 0;
        }
        form.numAppearanceChanges++;
        var newAppearance = msg.data;
        if (i === this.getMyActorIndex() && newAppearance) {
            this.controller.once("update", function () {
                (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.applyAppearanceToPlayer)(newAppearance);
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(_this, "Applied appearance to the player");
            });
        }
    };
    RemoteServer.prototype.onUpdateEquipmentMessage = function (event) {
        var msg = event.message;
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onUpdateEquipmentMessage - Form with idx", msg.idx, "not found");
            return;
        }
        form.equipment = msg.data;
    };
    RemoteServer.prototype.onUpdatePropertyMessage = function (event) {
        var _this = this;
        var msg = event.message;
        var msgData = this.extractUpdatePropertyMessageData(msg);
        if (this.skipFormViewCreation(msg)) {
            var refrId_2 = msg.refrId;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId_2));
                if (!refr) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'UpdateProperty: refr not found');
                    return;
                }
                if (msg.propName === 'inventory') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelInventory(refr, msgData);
                }
                else if (msg.propName === 'isOpen') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsOpen(refr, !!msgData);
                }
                else if (msg.propName === 'isHarvested') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsHarvested(refr, !!msgData);
                }
                else if (msg.propName === 'disabled') {
                    _view_modelApplyUtils__WEBPACK_IMPORTED_MODULE_10__.ModelApplyUtils.applyModelIsDisabled(refr, !!msgData);
                }
            });
            return;
        }
        var i = this.getIdManager().getId(msg.idx);
        var form = this.worldModel.forms[i];
        form[msg.propName] = msgData;
    };
    RemoteServer.prototype.onDeathStateContainerMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Received death state:", JSON.stringify(msg.tIsDead));
        var id = this.getIdManager().getId(msg.tIsDead.idx);
        var form = this.worldModel.forms[id];
        if (form === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Form with idx", msg.tIsDead.idx, "not found");
            return;
        }
        if (msg.tIsDead.propName !== (0,_lib_nameof__WEBPACK_IMPORTED_MODULE_4__.nameof)('isDead')) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Invalid propName", msg.tIsDead.propName);
            return;
        }
        var msgData = this.extractUpdatePropertyMessageData(msg.tIsDead);
        if (typeof msgData !== 'boolean') {
            (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, "onDeathStateContainerMessage - Invalid data", msgData);
            return;
        }
        if (msg.tChangeValues) {
            this.onChangeValuesMessage({ message: msg.tChangeValues });
        }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return _this.onUpdatePropertyMessage({ message: msg.tIsDead }); });
        if (msg.tTeleport) {
            this.onTeleportMessage({ message: msg.tTeleport });
        }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var _a;
            var actor = id === _this.getWorldModel().playerCharacterFormIdx
                ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()
                : skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)((_a = form.refrId) !== null && _a !== void 0 ? _a : 0)));
            if (actor) {
                try {
                    _this.controller.emitter.emit("applyDeathStateEvent", {
                        actor: actor,
                        isDead: msgData
                    });
                }
                catch (e) {
                    if (e instanceof _lib_errors__WEBPACK_IMPORTED_MODULE_13__.RespawnNeededError) {
                        actor.disableNoWait(false);
                        actor.delete();
                    }
                    else {
                        throw e;
                    }
                }
            }
        });
    };
    RemoteServer.prototype.handleConnectionAccepted = function () {
        this.worldModel.forms = [];
        this.worldModel.playerCharacterFormIdx = -1;
        this.worldModel.playerCharacterRefrId = 0;
        (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logTrace)(this, "Handle connection accepted");
    };
    RemoteServer.prototype.onChangeValuesMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var id = _this.getIdManager().getId(msg.idx);
            var refr = id === _this.getMyActorIndex() ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer() : (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.getObjectReference)(id);
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (!ac) {
                return;
            }
            var _a = msg.data, health = _a.health, stamina = _a.stamina, magicka = _a.magicka;
            if (typeof health === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'health', health);
            }
            if (typeof stamina === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'stamina', stamina);
            }
            if (typeof magicka === "number") {
                (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_5__.setActorValuePercentage)(ac, 'magicka', magicka);
            }
        });
    };
    RemoteServer.prototype.onSetRaceMenuOpenMessage = function (event) {
        var msg = event.message;
        if (msg.open) {
            // wait 0.3s cause we can see visual bugs when teleporting
            // and showing this menu at the same time in onConnect
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
                return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.3).then(function () {
                    unequipIronHelmet();
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.showRaceMenu();
                });
            });
        }
        else {
            // TODO: Implement closeMenu in SkyrimPlatform
        }
    };
    /** Packet handlers end **/
    RemoteServer.prototype.getWorldModel = function () {
        return this.worldModel;
    };
    RemoteServer.prototype.getMyActorIndex = function () {
        return this.worldModel.playerCharacterFormIdx;
    };
    RemoteServer.prototype.getMyRemoteRefrId = function () {
        return this.worldModel.playerCharacterRefrId;
    };
    RemoteServer.prototype.getIdManager = function () {
        return this.idManager_;
    };
    Object.defineProperty(RemoteServer.prototype, "worldModel", {
        get: function () {
            if (typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"] === "function") {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"] = { forms: [], playerCharacterFormIdx: -1, playerCharacterRefrId: 0 };
            }
            return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["worldModel"];
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(RemoteServer.prototype, "idManager_", {
        get: function () {
            if (typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"] === "function") {
                // Note: full IdManager object preserved across hot-reloads, including methods.
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"] = new _lib_idManager__WEBPACK_IMPORTED_MODULE_3__.IdManager();
            }
            return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["idManager"];
        },
        enumerable: false,
        configurable: true
    });
    RemoteServer.prototype.onceLoad = function (refrId, callback, maxAttempts) {
        var _this = this;
        if (maxAttempts === void 0) { maxAttempts = 120; }
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
            if (refr) {
                callback(refr);
            }
            else {
                maxAttempts--;
                if (maxAttempts > 0) {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () { return _this.onceLoad(refrId, callback, maxAttempts); });
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed to load object reference ' + refrId.toString(16));
                }
            }
        });
    };
    ;
    RemoteServer.prototype.skipFormViewCreation = function (msg) {
        // Optimization added in #1186, however it doesn't work for doors for some reason
        return msg.refrId && msg.refrId < 0xff000000 && msg.baseRecordType !== 'DOOR';
    };
    ;
    RemoteServer.prototype.extractUpdatePropertyMessageData = function (updatePropertyMessage) {
        var msgData = updatePropertyMessage.data;
        if (updatePropertyMessage.dataDump !== undefined) {
            try {
                msgData = JSON.parse(updatePropertyMessage.dataDump);
            }
            catch (e) {
                if (e instanceof SyntaxError) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(this, 'extractUpdatePropertyMessageData - Failed to parse dataDump', updatePropertyMessage.dataDump);
                    return;
                }
                else {
                    throw e;
                }
            }
        }
        return msgData;
    };
    RemoteServer.prototype.onSpellCastMessage = function (event) {
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.caster)));
            if (!ac) {
                return;
            }
            var actorAnimationVariables = {
                booleans: new Uint8Array(msg.data.actorAnimationVariables.booleans),
                floats: new Uint8Array(msg.data.actorAnimationVariables.floats),
                integers: new Uint8Array(msg.data.actorAnimationVariables.integers)
            };
            if (msg.data.interruptCast) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.interruptCast)(ac.getFormID(), msg.data.castingSource, actorAnimationVariables);
                return;
            }
            var spell = ac.getEquippedSpell(msg.data.castingSource);
            if (spell) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.castSpellImmediate)(ac.getFormID(), msg.data.castingSource, spell.getFormID(), (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.target), msg.data.aimAngle, msg.data.aimHeading, actorAnimationVariables);
            }
        });
    };
    RemoteServer.prototype.onUpdateAnimVariablesMessage = function (event) {
        var _this = this;
        var msg = event.message;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)('update', function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx((0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_15__.remoteIdToLocalId)(msg.data.actorRemoteId)));
            if (!ac) {
                return;
            }
            var actorAnimationVariables = {
                booleans: new Uint8Array(msg.data.actorAnimationVariables.booleans),
                floats: new Uint8Array(msg.data.actorAnimationVariables.floats),
                integers: new Uint8Array(msg.data.actorAnimationVariables.integers)
            };
            var isApplyed = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.applyAnimationVariablesToActor)(ac.getFormID(), actorAnimationVariables);
            if (!isApplyed) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_17__.logError)(_this, 'Failed apply AnimationVariables to actor with id: ' + ac.getFormID().toString(16));
            }
        });
    };
    RemoteServer.prototype.onVoiceChatMessage = function (event) {
        var msg = event.message;
        // Update form model with isTalking state
        var speakerForm = this.worldModel.forms.find(function (f) { return f && f.refrId === msg.data.speakerId; });
        if (speakerForm) {
            speakerForm.isTalking = msg.data.isTalking;
        }
        // Forward to VoiceChatService for processing
        var voiceChatService = this.controller.lookupListener(_voiceChatService__WEBPACK_IMPORTED_MODULE_18__.VoiceChatService);
        if (voiceChatService) {
            var audioData = new Uint8Array(msg.data.audioData);
            voiceChatService.onReceiveVoiceData(msg.data.speakerId, audioData.buffer, 0, 0, 0);
        }
    };
    RemoteServer.prototype.onUpdateVoiceChatMessage = function (event) {
        var msg = event.message;
        // Update form model with isTalking state
        var speakerForm = this.worldModel.forms.find(function (f) { return f && f.refrId === msg.data.speakerId; });
        if (speakerForm) {
            speakerForm.isTalking = msg.data.isTalking;
        }
        // Forward to VoiceChatService with 3D position data
        var voiceChatService = this.controller.lookupListener(_voiceChatService__WEBPACK_IMPORTED_MODULE_18__.VoiceChatService);
        if (voiceChatService) {
            var audioData = new Uint8Array(msg.data.audioData);
            voiceChatService.onReceiveVoiceData(msg.data.speakerId, audioData.buffer, msg.data.position[0], // x
            msg.data.position[1], // y
            msg.data.position[2] // z
            );
        }
    };
    return RemoteServer;
}(_clientListener__WEBPACK_IMPORTED_MODULE_14__.ClientListener));



/***/ }),

/***/ "./src/services/services/sendInputsService.ts":
/*!****************************************************!*\
  !*** ./src/services/services/sendInputsService.ts ***!
  \****************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SendInputsService: () => (/* binding */ SendInputsService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _singlePlayerService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _sync_movementGet__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../sync/movementGet */ "./src/sync/movementGet.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_actorvalues__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../../sync/actorvalues */ "./src/sync/actorvalues.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _view_hostAttempts__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../../view/hostAttempts */ "./src/view/hostAttempts.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _deathService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./deathService */ "./src/services/services/deathService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




// TODO: refactor this out









var playerFormId = 0x14;
// TODO: split this service into EquipmentService, MovementService, AnimationService, ActorValueService, HostAttemptsService
var SendInputsService = /** @class */ (function (_super) {
    __extends(SendInputsService, _super);
    function SendInputsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastSendMovementMoment = new Map();
        _this.playerAnimSource = new Map(); // TODO: make service
        _this.lastAnimationSent = new Map();
        _this.actorValuesNeedUpdate = false;
        _this.isRaceSexMenuShown = false;
        _this.equipmentChanged = false;
        _this.numEquipmentChanges = 0;
        _this.prevValues = { health: 0, stamina: 0, magicka: 0 };
        _this.prevActorValuesUpdateTime = 0;
        _this.prevCastingDetectedTime = 0;
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.on("equip", function (e) { return _this.onEquip(e); });
        _this.controller.on("unequip", function (e) { return _this.onUnequip(e); });
        _this.controller.on("loadGame", function () { return _this.onLoadGame(); });
        return _this;
    }
    SendInputsService.prototype.onUpdate = function () {
        if (!this.singlePlayerService.isSinglePlayer) {
            this.sendInputs();
            var player = this.sp.Game.getPlayer();
            var isPlayerCasting = player.getAnimationVariableBool("IsCastingRight")
                || player.getAnimationVariableBool("IsCastingLeft")
                || player.getAnimationVariableBool("IsCastingDual");
            if (isPlayerCasting) {
                this.prevCastingDetectedTime = Date.now();
            }
        }
    };
    SendInputsService.prototype.onEquip = function (event) {
        if (!event.actor || !event.baseObj) {
            return;
        }
        if (event.actor.getFormID() !== playerFormId) {
            return;
        }
        var type = event.baseObj.getType();
        if (type !== 27 /* FormType.Book */ && type !== 46 /* FormType.Potion */ && type !== 30 /* FormType.Ingredient */) {
            // Trigger UpdateEquipment only for equips that are not spell tomes, potions, ingredients
            this.equipmentChanged = true;
        }
        // Send OnEquip for any equips including spell tomes, potions, ingredients
        // Otherwise, the server won't trigger spell learn, potion drink, ingredient eat and Papyrus scripts
        this.controller.emitter.emit("sendMessage", {
            message: { t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.OnEquip, baseId: event.baseObj.getFormID() },
            reliability: "unreliable"
        });
    };
    SendInputsService.prototype.onUnequip = function (event) {
        if (!event.actor || !event.baseObj) {
            return;
        }
        if (event.actor.getFormID() === playerFormId) {
            this.equipmentChanged = true;
        }
    };
    SendInputsService.prototype.onLoadGame = function () {
        var _this = this;
        // Currently only armor is equipped after relogging (see remoteServer.ts)
        // This hack forces sending /equipment without weapons/ back to the server
        this.sp.Utility.wait(3).then(function () { return (_this.equipmentChanged = true); });
    };
    SendInputsService.prototype.sendInputs = function () {
        var _this = this;
        var hosted = typeof this.sp.storage['hosted'] === typeof [] ? this.sp.storage['hosted'] : [];
        var targets = [undefined].concat(hosted);
        var modelSource = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_10__.RemoteServer);
        var world = modelSource.getWorldModel();
        targets.forEach(function (target) {
            var targetFormModel = target ? _this.getForm(target, world) : _this.getForm(undefined, world);
            _this.sendMovement(target, targetFormModel);
            _this.sendAnimation(target);
            _this.sendAppearance(target);
            _this.sendEquipment(target);
            _this.sendActorValuePercentage(target, targetFormModel);
        });
        this.sendHostAttempts();
    };
    SendInputsService.prototype.sendMovement = function (_refrId, form) {
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        var refrIdStr = "".concat(_refrId);
        var sendMovementRateMs = 130;
        var now = Date.now();
        var last = this.lastSendMovementMoment.get(refrIdStr);
        if (!last || now - last > sendMovementRateMs) {
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateMovement,
                data: (0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_3__.getMovement)(owner, form),
                _refrId: _refrId
            };
            this.controller.emitter.emit("sendMessageWithRefrId", {
                message: message,
                reliability: "unreliable"
            });
            this.lastSendMovementMoment.set(refrIdStr, now);
        }
    };
    SendInputsService.prototype.sendActorValuePercentage = function (_refrId, form) {
        var _a;
        var canSend = form && ((_a = form.isDead) !== null && _a !== void 0 ? _a : false) === false;
        if (!canSend) {
            return;
        }
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        var av = (0,_sync_actorvalues__WEBPACK_IMPORTED_MODULE_7__.getActorValues)(this.sp.Game.getPlayer());
        var currentTime = Date.now();
        if (this.actorValuesNeedUpdate === false &&
            this.prevValues.health === av.health &&
            this.prevValues.stamina === av.stamina &&
            this.prevValues.magicka === av.magicka) {
            return;
        }
        if (currentTime - this.prevActorValuesUpdateTime < 2000 &&
            this.actorValuesNeedUpdate === false) {
            return;
        }
        // Delaying actor values update due to casting
        // TODO: use partial updates for actor values once server finally supports it
        // i.e. keep sending health and stamina during casting, but delay magicka update
        if (currentTime - this.prevCastingDetectedTime < 500 &&
            av.health > 0 // don't delay death actor value update
        ) {
            return;
        }
        var deathService = this.controller.lookupListener(_deathService__WEBPACK_IMPORTED_MODULE_11__.DeathService);
        if (deathService.isBusy()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_12__.logTrace)(this, "Not sending actor values, death service is busy");
            return;
        }
        var message = {
            t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.ChangeValues,
            data: av,
            _refrId: _refrId
        };
        this.controller.emitter.emit("sendMessageWithRefrId", {
            message: message,
            reliability: "unreliable"
        });
        this.actorValuesNeedUpdate = false;
        this.prevValues = av;
        this.prevActorValuesUpdateTime = currentTime;
    };
    SendInputsService.prototype.sendAnimation = function (_refrId) {
        var owner = this.getInputOwner(_refrId);
        if (!owner) {
            return;
        }
        // Extermly important that it's a local id since AnimationSource depends on it
        var refrIdStr = owner.getFormID().toString(16);
        var animSource = this.playerAnimSource.get(refrIdStr);
        if (!animSource) {
            animSource = new _sync_animation__WEBPACK_IMPORTED_MODULE_5__.AnimationSource(owner);
            this.playerAnimSource.set(refrIdStr, animSource);
        }
        var anim = animSource.getAnimation();
        var lastAnimationSent = this.lastAnimationSent.get(refrIdStr);
        if (!lastAnimationSent ||
            anim.numChanges !== lastAnimationSent.numChanges) {
            // Drink potion anim from this mod https://www.nexusmods.com/skyrimspecialedition/mods/97660
            if (anim.animEventName !== '' && !anim.animEventName.startsWith("DrinkPotion_")) {
                this.lastAnimationSent.set(refrIdStr, anim);
                this.updateActorValuesAfterAnimation(anim.animEventName);
                var message = {
                    t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAnimation,
                    data: anim,
                    _refrId: _refrId
                };
                this.controller.emitter.emit("sendMessageWithRefrId", {
                    message: message,
                    reliability: "unreliable"
                });
            }
        }
    };
    SendInputsService.prototype.sendAppearance = function (_refrId) {
        if (_refrId) {
            return;
        }
        var shown = this.sp.Ui.isMenuOpen('RaceSex Menu');
        if (shown != this.isRaceSexMenuShown) {
            this.isRaceSexMenuShown = shown;
            if (!shown) {
                this.sp.printConsole('Exited from race menu');
                var appearance = (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_6__.getAppearance)(this.sp.Game.getPlayer());
                // TODO: log appearance contents to debug appearance issues?
                var message = {
                    t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateAppearance,
                    data: appearance,
                    _refrId: _refrId
                };
                this.controller.emitter.emit("sendMessageWithRefrId", {
                    message: message,
                    reliability: "reliable"
                });
            }
        }
    };
    SendInputsService.prototype.sendEquipment = function (_refrId) {
        if (_refrId) {
            return;
        }
        if (this.equipmentChanged) {
            this.equipmentChanged = false;
            ++this.numEquipmentChanges;
            var eq = (0,_sync_equipment__WEBPACK_IMPORTED_MODULE_8__.getEquipment)(this.sp.Game.getPlayer(), this.numEquipmentChanges);
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.UpdateEquipment,
                data: eq,
                _refrId: _refrId
            };
            this.controller.emitter.emit("sendMessageWithRefrId", {
                message: message,
                reliability: "reliable"
            });
        }
    };
    SendInputsService.prototype.sendHostAttempts = function () {
        var remoteId = (0,_view_hostAttempts__WEBPACK_IMPORTED_MODULE_9__.nextHostAttempt)();
        if (!remoteId) {
            return;
        }
        this.controller.emitter.emit("sendMessage", {
            message: {
                t: _messages__WEBPACK_IMPORTED_MODULE_2__.MsgType.Host,
                remoteId: remoteId
            },
            reliability: "unreliable"
        });
    };
    SendInputsService.prototype.getInputOwner = function (_refrId) {
        return _refrId
            ? this.sp.Actor.from(this.sp.Game.getFormEx(_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_4__.remoteIdToLocalId(_refrId)))
            : this.sp.Game.getPlayer();
    };
    SendInputsService.prototype.getForm = function (refrId, world) {
        var form = refrId
            ? world === null || world === void 0 ? void 0 : world.forms.find(function (f) { return (f === null || f === void 0 ? void 0 : f.refrId) === refrId; })
            : world.forms[world.playerCharacterFormIdx];
        return form;
    };
    SendInputsService.prototype.updateActorValuesAfterAnimation = function (animName) {
        if (animName === 'JumpLand' ||
            animName === 'JumpLandDirectional' ||
            animName === 'DeathAnim') {
            this.actorValuesNeedUpdate = true;
        }
    };
    Object.defineProperty(SendInputsService.prototype, "singlePlayerService", {
        get: function () {
            return this.controller.lookupListener(_singlePlayerService__WEBPACK_IMPORTED_MODULE_1__.SinglePlayerService);
        },
        enumerable: false,
        configurable: true
    });
    return SendInputsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/serverJsVerificationService.ts":
/*!**************************************************************!*\
  !*** ./src/services/services/serverJsVerificationService.ts ***!
  \**************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ServerJsVerificationService: () => (/* binding */ ServerJsVerificationService)
/* harmony export */ });
/* harmony import */ var node_crypto__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! node:crypto */ "node:crypto");
/* harmony import */ var node_crypto__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(node_crypto__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();




var ServerJsVerificationService = /** @class */ (function (_super) {
    __extends(ServerJsVerificationService, _super);
    function ServerJsVerificationService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        return _this;
    }
    ServerJsVerificationService.prototype.verifyServerJs = function (src) {
        if (!src) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Empty server JS, skipping verification');
            return { src: src, error: null };
        }
        var settingsService = this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_2__.SettingsService);
        var getTargetPeerResult = settingsService.getTargetPeer();
        if (!getTargetPeerResult.targetPeerCached) {
            return { src: null, error: 'target peer not ready' };
        }
        var publicKeys = getTargetPeerResult.targetPeerCached.publicKeys;
        if (!publicKeys) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'No public keys configured, skipping server JS verification');
            return { src: src, error: null };
        }
        var lastLineStart = src.lastIndexOf('\n') + 1;
        var sigPrefix = '// skymp:sig:y:';
        if (lastLineStart === 0 || !src.substring(lastLineStart).startsWith(sigPrefix)) {
            return { src: null, error: 'no signature found' };
        }
        var _a = src.substring(lastLineStart + sigPrefix.length).split(':'), keyId = _a[0], sig = _a[1];
        if (!this.isAlphaNumeric(keyId)) {
            return { src: null, error: 'malformed key id' };
        }
        var key = publicKeys[keyId];
        if (!key) {
            return { src: null, error: 'unknown key' };
        }
        var toVerify = this.toArrayBufferView(src.substring(0, lastLineStart - 1), 'utf8');
        if (!(0,node_crypto__WEBPACK_IMPORTED_MODULE_0__.verify)(null, toVerify, key, this.toArrayBufferView(sig, 'base64'))) {
            return { src: null, error: 'bad signature' };
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Server JS verified with key ".concat(keyId));
        return { src: src, error: null };
    };
    ServerJsVerificationService.prototype.isAlphaNumeric = function (str) {
        for (var i = 0; i < str.length; ++i) {
            var code = str.charCodeAt(i);
            if (!((97 <= code && code <= 122) ||
                (65 <= code && code <= 90) ||
                (48 <= code && code <= 57))) {
                return false;
            }
        }
        return true;
    };
    ServerJsVerificationService.prototype.toArrayBufferView = function (str, enc) {
        var buf = Buffer.from(str, enc);
        return new Uint8Array(buf.buffer, buf.byteOffset, buf.byteLength);
    };
    return ServerJsVerificationService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/settingsService.ts":
/*!**************************************************!*\
  !*** ./src/services/services/settingsService.ts ***!
  \**************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SettingsService: () => (/* binding */ SettingsService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _authService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./authService */ "./src/services/services/authService.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _timersService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (undefined && undefined.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};





var SettingsService = /** @class */ (function (_super) {
    __extends(SettingsService, _super);
    function SettingsService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.targetPeerCache = null;
        return _this;
    }
    SettingsService.prototype.getServerMasterKey = function () {
        var masterKey = this.sp.settings["skymp5-client"]["server-master-key"];
        if (!masterKey) {
            masterKey = this.sp.settings["skymp5-client"]["master-key"];
        }
        if (!masterKey) {
            masterKey = this.sp.settings["skymp5-client"]["server-ip"] + ":" + this.sp.settings["skymp5-client"]["server-port"];
        }
        return masterKey;
    };
    SettingsService.prototype.getMasterUrl = function () {
        return this.normalizeUrl(this.sp.settings["skymp5-client"]["master"] || "https://gateway.skymp.net");
    };
    SettingsService.prototype.makeMasterApiClient = function () {
        var masterApiBaseUrl = this.getMasterUrl();
        return new skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.HttpClient(masterApiBaseUrl);
    };
    SettingsService.prototype.getTargetPeer = function (callback) {
        var _this = this;
        if (this.targetPeerCache) {
            callback === null || callback === void 0 ? void 0 : callback(this.targetPeerCache);
            return { targetPeerCached: this.targetPeerCache };
        }
        this.getTargetPeerImpl(function (targetPeer) {
            _this.targetPeerCache = targetPeer;
            callback === null || callback === void 0 ? void 0 : callback(targetPeer);
        });
        return { targetPeerCached: null };
    };
    // have to use callbacks here: promises don't work in the main menu
    SettingsService.prototype.getTargetPeerImpl = function (callback) {
        var _this = this;
        var masterApiClient = this.makeMasterApiClient();
        var masterKey = this.getServerMasterKey();
        var serverInfoRequestTimeoutMs = 5000;
        var defaultPeer = {
            host: this.sp.settings['skymp5-client']['server-ip'],
            port: this.sp.settings['skymp5-client']['server-port'],
            publicKeys: this.sp.settings['skymp5-client']['server-public-keys'],
        };
        var resolved = false;
        var states = {
            start: function () {
                var _a;
                try {
                    if (_this.sp.settings['skymp5-client']['server-info-ignore']) {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, 'Skipping serverinfo request due to server-info-ignore in config');
                        states.resolve(defaultPeer);
                        return;
                    }
                    _this.controller.lookupListener(_timersService__WEBPACK_IMPORTED_MODULE_3__.TimersService).setTimeout(function () { return states.reject(new Error('getTargetPeer: serverinfo request timed out')); }, serverInfoRequestTimeoutMs);
                    var headers = {};
                    var session = (_a = _this.controller.lookupListener(_authService__WEBPACK_IMPORTED_MODULE_1__.AuthService).readAuthDataFromDisk()) === null || _a === void 0 ? void 0 : _a.session;
                    if (session) {
                        headers['X-Session'] = session;
                    }
                    masterApiClient.get("/api/servers/".concat(masterKey, "/serverinfo"), { headers: headers }, states.handleResponse);
                }
                catch (e) {
                    states.reject(e);
                }
            },
            handleResponse: function (res) {
                try {
                    if (res.status !== 200) {
                        throw new Error("status ".concat(res.status));
                    }
                    states.resolve(JSON.parse(res.body));
                }
                catch (e) {
                    states.reject(e);
                }
            },
            resolve: function (targetPeer) {
                if (resolved) {
                    return;
                }
                resolved = true;
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Resolved target peer", targetPeer);
                var enrichedTargetPeer = __assign({}, targetPeer);
                enrichedTargetPeer.publicKeys = __assign(__assign({}, defaultPeer.publicKeys), targetPeer.publicKeys);
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Enriched target peer", enrichedTargetPeer);
                callback(enrichedTargetPeer);
            },
            reject: function (err) {
                if (resolved) {
                    return;
                }
                resolved = true;
                (0,_logging__WEBPACK_IMPORTED_MODULE_4__.logTrace)(_this, "Server info request failed, falling back to", defaultPeer, "; error:", err);
                callback(defaultPeer);
            },
        };
        states.start();
    };
    SettingsService.prototype.getServerMods = function () {
        return __awaiter(this, void 0, void 0, function () {
            var masterApiClient, masterKey, attempt, res, manifest, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        masterApiClient = this.makeMasterApiClient();
                        masterKey = this.getServerMasterKey();
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)(masterKey);
                        attempt = 0;
                        _a.label = 1;
                    case 1:
                        if (!(attempt < 5)) return [3 /*break*/, 7];
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 4, , 6]);
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Trying to get server mods, attempt ".concat(attempt));
                        return [4 /*yield*/, masterApiClient.get("/api/servers/".concat(masterKey, "/manifest.json"))];
                    case 3:
                        res = _a.sent();
                        if (res.status != 200) {
                            throw new Error("status code ".concat(res.status, ", error ").concat(res.error));
                        }
                        manifest = JSON.parse(res.body);
                        if (manifest.versionMajor !== 1) {
                            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("server manifest version is ".concat(manifest.versionMajor, ", we expect 1"));
                            return [2 /*return*/, []];
                        }
                        return [2 /*return*/, manifest.mods];
                    case 4:
                        e_1 = _a.sent();
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Request/parse error: ".concat(e_1));
                        return [4 /*yield*/, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.1 + Math.random())];
                    case 5:
                        _a.sent();
                        return [3 /*break*/, 6];
                    case 6:
                        ++attempt;
                        return [3 /*break*/, 1];
                    case 7: return [2 /*return*/, []];
                }
            });
        });
    };
    ;
    SettingsService.prototype.getServerPort = function () {
        // Return the server port from settings
        return this.sp.settings['skymp5-client']['server-port'] || 7777;
    };
    SettingsService.prototype.normalizeUrl = function (url) {
        if (url.endsWith('/')) {
            return url.slice(0, url.length - 1);
        }
        return url;
    };
    ;
    return SettingsService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/singlePlayerService.ts":
/*!******************************************************!*\
  !*** ./src/services/services/singlePlayerService.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SinglePlayerService: () => (/* binding */ SinglePlayerService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SinglePlayerService = /** @class */ (function (_super) {
    __extends(SinglePlayerService, _super);
    function SinglePlayerService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this._isSinglePlayer = false;
        _this.controller.emitter.on("gameLoad", function (e) { return _this.onGameLoad(e); });
        return _this;
    }
    Object.defineProperty(SinglePlayerService.prototype, "isSinglePlayer", {
        get: function () {
            return this._isSinglePlayer;
        },
        enumerable: false,
        configurable: true
    });
    SinglePlayerService.prototype.onGameLoad = function (event) {
        if (!event.isCausedBySkyrimPlatform && !this._isSinglePlayer) {
            this.sp.Debug.messageBox('Save has been loaded in multiplayer, switching to the single-player mode');
            this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).close();
            this._isSinglePlayer = true;
            this.sp.Game.setInChargen(false, false, false);
        }
    };
    return SinglePlayerService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/skympClient.ts":
/*!**********************************************!*\
  !*** ./src/services/services/skympClient.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SkympClient: () => (/* binding */ SkympClient)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _networkingService__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _features_authModel__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../features/authModel */ "./src/features/authModel.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _settingsService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./settingsService */ "./src/services/services/settingsService.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();







(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('Hello Multiplayer!');
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)('settings:', skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.settings['skymp5-client']);
var SkympClient = /** @class */ (function (_super) {
    __extends(SkympClient, _super);
    function SkympClient(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("connectionFailed", function (e) { return _this.onConnectionFailed(e); });
        _this.controller.emitter.on("connectionDenied", function (e) { return _this.onConnectionDenied(e); });
        _this.controller.emitter.on("createActorMessage", function (e) { return _this.onActorCreateMessage(e); });
        // TODO: refactor out very similar code in frontHotReloadService.ts
        var authGameData = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_3__.authGameDataStorageKey];
        var storageHasValidAuthGameData = (authGameData === null || authGameData === void 0 ? void 0 : authGameData.local) || (authGameData === null || authGameData === void 0 ? void 0 : authGameData.remote);
        if (storageHasValidAuthGameData) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(_this, "Recovered AuthGameData from storage, starting client");
            _this.startClient();
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(_this, "Unable to recover AuthGameData from storage, requesting auth");
            // Next tick because we're in constructor of the service, AuthService may not be listening events yet
            _this.controller.once("tick", function () {
                _this.controller.emitter.emit("authNeeded", {});
            });
            _this.controller.emitter.on("authAttempt", function (e) { return _this.onAuthAttempt(e); });
        }
        return _this;
    }
    SkympClient.prototype.onAuthAttempt = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Caught auth event");
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage[_features_authModel__WEBPACK_IMPORTED_MODULE_3__.authGameDataStorageKey] = e.authGameData;
        this.startClient();
        // TODO: remove this when you will be able to see errors without console
        // this.sp.browser.setFocused(false);
    };
    SkympClient.prototype.onActorCreateMessage = function (e) {
        if (e.message.isMe) {
            this.sp.browser.setFocused(false);
        }
    };
    SkympClient.prototype.onConnectionFailed = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Connection failed");
    };
    SkympClient.prototype.onConnectionDenied = function (e) {
        (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, "Connection denied: " + e.error);
    };
    SkympClient.prototype.startClient = function () {
        var _this = this;
        // once("tick", ...) is needed to ensure networking service initialized
        this.controller.once("tick", function () { return _this.establishConnectionConditional(); });
        this.ctor();
    };
    SkympClient.prototype.ctor = function () {
        // TODO: refactor into service
        (0,_sync_animation__WEBPACK_IMPORTED_MODULE_2__.setupHooks)();
        this.sp.printConsole('SkympClient ctor');
    };
    SkympClient.prototype.establishConnectionConditional = function () {
        var _this = this;
        var isConnected = this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).isConnected();
        if (isConnected) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_5__.logTrace)(this, 'Reconnect is not required');
            return;
        }
        this.controller.lookupListener(_settingsService__WEBPACK_IMPORTED_MODULE_6__.SettingsService).getTargetPeer(function (_a) {
            var host = _a.host, port = _a.port;
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage.targetIp = host;
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage.targetPort = port;
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Connecting to ".concat(host, ":").concat(port));
            _this.controller.lookupListener(_networkingService__WEBPACK_IMPORTED_MODULE_1__.NetworkingService).connect(host, port);
        });
    };
    return SkympClient;
}(_clientListener__WEBPACK_IMPORTED_MODULE_4__.ClientListener));



/***/ }),

/***/ "./src/services/services/spSnippetService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/spSnippetService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpSnippetService: () => (/* binding */ SpSnippetService)
/* harmony export */ });
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../view/worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _view_worldView__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../../view/worldView */ "./src/view/worldView.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (undefined && undefined.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};


// TODO: refactor worldViewMisc into service



var SpSnippetService = /** @class */ (function (_super) {
    __extends(SpSnippetService, _super);
    function SpSnippetService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.controller.emitter.on("spSnippetMessage", function (e) { return _this.onSpSnippetMessage(e); });
        _this.spAny = sp;
        return _this;
    }
    SpSnippetService.prototype.onSpSnippetMessage = function (event) {
        var _this = this;
        var msg = event.message;
        this.controller.once('update', function () { return __awaiter(_this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                this.run(msg)
                    .then(function (res) {
                    var isNoResultSnippet = msg.snippetIdx === 0xffffffff;
                    if (isNoResultSnippet) {
                        return;
                    }
                    if (res === undefined) {
                        res = null;
                    }
                    if (res !== null
                        && typeof res !== "number"
                        && typeof res !== "string"
                        && typeof res !== "boolean") {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(_this, "Unsupported SpSnippet result type '".concat(typeof res, "'"));
                        return;
                    }
                    var message = res === null ? {
                        t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.FinishSpSnippet,
                        snippetIdx: msg.snippetIdx
                    }
                        : {
                            t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.FinishSpSnippet,
                            returnValue: res,
                            snippetIdx: msg.snippetIdx,
                        };
                    _this.controller.emitter.emit("sendMessage", {
                        message: message,
                        reliability: "reliable"
                    });
                })
                    .catch(function (e) {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(_this, 'SpSnippet ' + msg.class + ' ' + msg.function + ' failed ' + e);
                });
                return [2 /*return*/];
            });
        }); });
    };
    SpSnippetService.prototype.run = function (snippet) {
        var _a;
        return __awaiter(this, void 0, void 0, function () {
            var functionLowerCase, classLowerCase, newName, selfId, self, replaceValue, worldView_1, form, sign, count, soundId, sound, name, name;
            var _this = this;
            return __generator(this, function (_b) {
                functionLowerCase = snippet.function.toLowerCase();
                classLowerCase = snippet.class.toLowerCase();
                // keep in sync with remoteServer.ts
                if (classLowerCase === "objectreference") {
                    if (functionLowerCase === "setdisplayname") {
                        newName = snippet.arguments[0];
                        if (typeof newName === "string") {
                            selfId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(snippet.selfId);
                            self = this.sp.ObjectReference.from(this.sp.Game.getFormEx(selfId));
                            replaceValue = (_a = self === null || self === void 0 ? void 0 : self.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getName();
                            if (replaceValue !== undefined) {
                                newName = newName.replace(/%original_name%/g, replaceValue);
                                snippet.arguments[0] = newName;
                            }
                            else {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Couldn't get a replaceValue for SetDisplayName, snippet.selfId was", snippet.selfId.toString(16));
                            }
                        }
                        else {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Encountered SetDisplayName with non-string argument", newName);
                        }
                    }
                }
                if (classLowerCase === "game") {
                    if (functionLowerCase === "showracemenu" || functionLowerCase === "showlimitedracemenu") {
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "showracemenu called");
                        worldView_1 = this.controller.lookupListener(_view_worldView__WEBPACK_IMPORTED_MODULE_4__.WorldView);
                        worldView_1.setFormViewUpdateAllowed(false);
                        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Waiting 1.0s before calling showracemenu");
                        this.sp.Utility.wait(1.0).then(function () {
                            _this.runStatic(snippet);
                            worldView_1.waitGameTimeAndAllowFormViewUpdate(1.0);
                        });
                        return [2 /*return*/];
                    }
                }
                if (classLowerCase === "skymphacks") {
                    if (functionLowerCase === "additem" || functionLowerCase === "removeitem") {
                        form = this.sp.Form.from(this.deserializeArg(snippet.arguments[0]));
                        if (form === null) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Unable to find form with id " + snippet.arguments[0].formId.toString(16));
                            return [2 /*return*/];
                        }
                        sign = snippet.function === "AddItem" ? "+" : "-";
                        count = snippet.arguments[1];
                        soundId = 0x334ab;
                        if (form.getFormID() !== 0xf) {
                            soundId = 0x14115;
                        }
                        sound = this.sp.Sound.from(this.sp.Game.getFormEx(soundId));
                        if (sound !== null) {
                            name = form.getName();
                            if (name.trim() === "") {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Sound will not be played because item has no name");
                            }
                            else {
                                sound.play(this.sp.Game.getPlayer());
                            }
                        }
                        else {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Unable to find sound with id " + soundId.toString(16));
                        }
                        if (count <= 0) {
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logError)(this, "Positive count expected, got " + count.toString());
                        }
                        else {
                            name = form.getName();
                            if (name.trim() === "") {
                                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, "Notification will not be shown because item has no name");
                            }
                            else {
                                this.sp.Debug.notification(sign + " " + name + " (" + count + ")");
                            }
                            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, sign + " " + name + " (" + count + ")");
                        }
                    }
                    else
                        throw new Error("Unknown SkympHack - " + snippet.function);
                    return [2 /*return*/];
                }
                return [2 /*return*/, snippet.selfId ? this.runMethod(snippet) : this.runStatic(snippet)];
            });
        });
    };
    ;
    SpSnippetService.prototype.deserializeArg = function (arg) {
        if (typeof arg === "object") {
            var formId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(arg.formId);
            var form = this.sp.Game.getFormEx(formId);
            var cl = this.spAny[arg.type];
            if (!cl) {
                var matchingKey = Object.keys(this.spAny).find(function (key) {
                    return key.toLowerCase() === arg.type.toLowerCase();
                });
                if (matchingKey) {
                    cl = this.spAny[matchingKey];
                }
            }
            if (!cl) {
                throw new Error("deserializeArg - Class ".concat(arg.type, " not found"));
            }
            var gameObject = cl.from(form);
            return gameObject;
        }
        return arg;
    };
    ;
    SpSnippetService.prototype.runMethod = function (snippet) {
        return __awaiter(this, void 0, void 0, function () {
            var selfId, self, cl, matchingKey, selfCasted, f;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        selfId = (0,_view_worldViewMisc__WEBPACK_IMPORTED_MODULE_2__.remoteIdToLocalId)(snippet.selfId);
                        self = this.sp.Game.getFormEx(selfId);
                        if (!self)
                            throw new Error("Unable to find form with id ".concat(selfId.toString(16)));
                        cl = this.spAny[snippet.class];
                        if (!cl) {
                            matchingKey = Object.keys(this.spAny).find(function (key) {
                                return key.toLowerCase() === snippet.class.toLowerCase();
                            });
                            if (matchingKey) {
                                cl = this.spAny[matchingKey];
                            }
                        }
                        if (!cl) {
                            throw new Error("runMethod - Class ".concat(snippet.class, " not found, found"));
                        }
                        selfCasted = cl.from(self);
                        if (!selfCasted)
                            throw new Error("Form ".concat(selfId.toString(16), " is not instance of ").concat(snippet.class, ", form type is ").concat(self.getType()));
                        f = selfCasted[snippet.function];
                        return [4 /*yield*/, f.apply(selfCasted, snippet.arguments.map(function (arg) { return _this.deserializeArg(arg); }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ;
    SpSnippetService.prototype.runStatic = function (snippet) {
        return __awaiter(this, void 0, void 0, function () {
            var papyrusClass;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        papyrusClass = this.spAny[snippet.class];
                        return [4 /*yield*/, papyrusClass[snippet.function].apply(papyrusClass, snippet.arguments.map(function (arg) { return _this.deserializeArg(arg); }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ;
    return SpSnippetService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/spVersionCheckService.ts":
/*!********************************************************!*\
  !*** ./src/services/services/spVersionCheckService.ts ***!
  \********************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpVersionCheckService: () => (/* binding */ SpVersionCheckService)
/* harmony export */ });
/* harmony import */ var _version__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../version */ "./src/version.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SpVersionCheckService = /** @class */ (function (_super) {
    __extends(SpVersionCheckService, _super);
    function SpVersionCheckService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SpVersionCheckService.prototype.onceUpdate = function () {
        var _this = this;
        var realVersion = this.sp.getPlatformVersion();
        if (!_version__WEBPACK_IMPORTED_MODULE_0__.requiredVersion.includes(realVersion)) {
            this.sp.Debug.messageBox("You need to have on of those SkyrimPlatform versions ".concat(JSON.stringify(_version__WEBPACK_IMPORTED_MODULE_0__.requiredVersion), " to join this server. Your current version is ").concat(realVersion));
            this.sp.Utility.waitMenuMode(0.5).then(function () {
                _this.controller.on('update', function () {
                    if (!_this.sp.Ui.isMenuOpen('MessageBoxMenu')) {
                        _this.sp.Game.quitToMainMenu();
                    }
                });
            });
        }
    };
    return SpVersionCheckService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetCameraEnforcementService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetCameraEnforcementService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetCameraEnforcementService: () => (/* binding */ SweetCameraEnforcementService)
/* harmony export */ });
/* harmony import */ var _messages__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../messages */ "./src/messages.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var playerId = 0x14;
// ex AnimDebugService part
var SweetCameraEnforcementService = /** @class */ (function (_super) {
    __extends(SweetCameraEnforcementService, _super);
    function SweetCameraEnforcementService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.currentAnim = null;
        _this.stopAnimInProgress = false;
        _this.exitAnimName = null;
        _this.interruptAnimName = null;
        _this.tryInvokeAnimCount = 0;
        _this.lastNotificationMoment = 0;
        _this.tryInvokeAnimCountMax = 1000000000;
        _this.exitAnimEvent = undefined;
        _this.optionsCache = undefined;
        _this.optionCb = undefined;
        _this.usePlayerControlsDelayMs = true;
        var hasSweetPie = _this.hasSweetPie();
        if (!hasSweetPie) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.settings = _this.sp.settings["skymp5-client"]["animDebug"];
        if (hasSweetPie) {
            var self_1 = _this;
            _this.sp.hooks.sendAnimationEvent.add({
                enter: function (ctx) { },
                leave: function (ctx) {
                    self_1.onSendAnimationEventLeave(ctx);
                    self_1.onSendExitAnimationEventLeave(ctx); // Tracking the successful launch of the exit animation
                },
            }, playerId, playerId);
            _this.controller.on("buttonEvent", function (e) { return _this.onButtonEvent(e); });
            _this.controller.emitter.on("customPacketMessage", function (e) { return _this.onCustomPacketMessage2(e); });
        }
        return _this;
    }
    SweetCameraEnforcementService.prototype.onCustomPacketMessage2 = function (e) {
        var _this = this;
        var content = {};
        try {
            content = JSON.parse(e.message.contentJsonDump);
        }
        catch (err) {
            if (err instanceof SyntaxError) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Failed to parse custom packet contentJsonDump:", e.message.contentJsonDump, "Error:", err);
                return;
            }
            throw err;
        }
        if (content["customPacketType"] !== "invokeAnim") {
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received custom packet with customPacketType invokeAnim");
        var name = content["animEventName"];
        var requestId = content["requestId"];
        var weaponDrawnAllowed = content["weaponDrawnAllowed"];
        var furnitureAllowed = content["furnitureAllowed"];
        var exitAnimName = content["exitAnimName"];
        var interruptAnimName = content["interruptAnimName"];
        var timeMs = content["timeMs"];
        var isPlayExitAnimAfterwardsEnabled = content["isPlayExitAnimAfterwardsEnabled"];
        var parentAnimEventName = content["parentAnimEventName"];
        var enablePlayerControlsDelayMs = content["enablePlayerControlsDelayMs"];
        var preferInterruptAnimAsExitAnimTimeMs = content["preferInterruptAnimAsExitAnimTimeMs"];
        if (typeof name !== "string") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Expected animEventName to be string");
            return;
        }
        if (typeof requestId !== "string" && typeof requestId !== "number" && typeof requestId !== "undefined") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logError)(this, "Expected requestId to be string or number or undefined");
            return;
        }
        this.controller.once("update", function () {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Trying to invoke anim", name, "with weaponDrawnAllowed=", weaponDrawnAllowed, ", furnitureAllowed=", furnitureAllowed, ", exitAnimName=", exitAnimName, ", interruptAnimName=", interruptAnimName, ", timeMs=", timeMs, ", isPlayExitAnimAfterwardsEnabled=", isPlayExitAnimAfterwardsEnabled, ", parentAnimEventName=", parentAnimEventName, ", enablePlayerControlsDelayMs=", enablePlayerControlsDelayMs, ", preferInterruptAnimAsExitAnimTimeMs=", preferInterruptAnimAsExitAnimTimeMs);
            var result = _this.tryInvokeAnim(name, { weaponDrawnAllowed: weaponDrawnAllowed, furnitureAllowed: furnitureAllowed, exitAnimName: exitAnimName, interruptAnimName: interruptAnimName, timeMs: timeMs, isPlayExitAnimAfterwardsEnabled: isPlayExitAnimAfterwardsEnabled, parentAnimEventName: parentAnimEventName, enablePlayerControlsDelayMs: enablePlayerControlsDelayMs, preferInterruptAnimAsExitAnimTimeMs: preferInterruptAnimAsExitAnimTimeMs });
            var message = {
                t: _messages__WEBPACK_IMPORTED_MODULE_0__.MsgType.CustomPacket,
                contentJsonDump: JSON.stringify({
                    customPacketType: "invokeAnimResult",
                    result: result,
                    requestId: requestId,
                })
            };
            _this.controller.emitter.emit("sendMessage", {
                message: message,
                reliability: "reliable",
            });
        });
    };
    SweetCameraEnforcementService.prototype.onSendAnimationEventLeave = function (ctx) {
        var _this = this;
        var animLowerCase = ctx.animEventName.toLowerCase();
        if (animLowerCase.startsWith("idle") && !animLowerCase.startsWith("idleforcedefaultstate")) {
            this.controller.once("update", function () {
                var _a;
                // This is only for player.playidle
                if (!_this.sp.Ui.isMenuOpen("Console" /* Menu.Console */)) {
                    return;
                }
                if ((_a = _this.sp.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.getFurnitureReference()) {
                    return;
                }
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Forcing third person and disabling player controls");
                _this.sp.Game.forceThirdPerson();
                _this.sp.Game.disablePlayerControls(true, false, true, false, false, false, false, false, 0);
                _this.currentAnim = { name: ctx.animEventName, options: null, preferInterruptAnimState: null };
                _this.startAntiExploitPolling();
            });
        }
    };
    SweetCameraEnforcementService.prototype.exitAnim = function (options) {
        var _this = this;
        var _a, _b;
        // TODO(1): See another TODO(1) in this file
        if (options.playExitAnim) {
            var useInterruptAnimAsExitAnim = false;
            if (options.useInterruptAnimAsExitAnim) {
                useInterruptAnimAsExitAnim = true;
                this.usePlayerControlsDelayMs = false;
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Using interrupt anim as exit anim: ".concat(this.interruptAnimName, ". Reason: useInterruptAnimAsExitAnim is true"));
            }
            if ((_b = (_a = this.currentAnim) === null || _a === void 0 ? void 0 : _a.preferInterruptAnimState) === null || _b === void 0 ? void 0 : _b.prefer) {
                useInterruptAnimAsExitAnim = true;
                this.usePlayerControlsDelayMs = false;
                (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Using interrupt anim as exit anim: ".concat(this.interruptAnimName, ". Reason: preferInterruptAnimState.prefer is true"));
            }
            var animEventToSend = useInterruptAnimAsExitAnim ? (this.interruptAnimName || "IdleStop") : (this.exitAnimName || "IdleForceDefaultState");
            this.sp.Debug.sendAnimationEvent(this.sp.Game.getPlayer(), animEventToSend);
            this.exitAnimEvent = animEventToSend;
            this.optionsCache = options;
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Sent animation event:", animEventToSend);
        }
        else {
            this.currentAnim = null;
            var enablePlayerControlsDelaySeconds = (typeof options.enablePlayerControlsDelayMs === "number"
                && options.enablePlayerControlsDelayMs > 0
                && Number.isFinite(options.enablePlayerControlsDelayMs)
                && this.usePlayerControlsDelayMs)
                ? options.enablePlayerControlsDelayMs / 1000
                : 0.5;
            var stopAnimDelaySeconds = enablePlayerControlsDelaySeconds + 0.5;
            this.stopAnimInProgress = true;
            this.sp.Utility.wait(enablePlayerControlsDelaySeconds).then(function () {
                _this.sp.Game.enablePlayerControls(true, false, true, false, false, false, false, false, 0);
            });
            this.sp.Utility.wait(stopAnimDelaySeconds).then(function () {
                _this.stopAnimInProgress = false;
                if (_this.optionCb) {
                    _this.optionCb();
                    _this.optionCb = undefined;
                }
            });
        }
    };
    SweetCameraEnforcementService.prototype.onSendExitAnimationEventLeave = function (ctx) {
        var _this = this;
        if (ctx.animationSucceeded && this.exitAnimEvent && this.optionsCache && ctx.animEventName === this.exitAnimEvent) {
            this.currentAnim = null;
            var enablePlayerControlsDelaySeconds = (typeof this.optionsCache.enablePlayerControlsDelayMs === "number"
                && this.optionsCache.enablePlayerControlsDelayMs > 0
                && Number.isFinite(this.optionsCache.enablePlayerControlsDelayMs)
                && this.usePlayerControlsDelayMs)
                ? this.optionsCache.enablePlayerControlsDelayMs / 1000
                : 0.5;
            var stopAnimDelaySeconds = enablePlayerControlsDelaySeconds + 0.5;
            this.stopAnimInProgress = true;
            this.optionsCache = undefined;
            this.exitAnimEvent = undefined;
            this.usePlayerControlsDelayMs = true;
            this.sp.Utility.wait(enablePlayerControlsDelaySeconds).then(function () {
                _this.sp.Game.enablePlayerControls(true, false, true, false, false, false, false, false, 0);
            });
            this.sp.Utility.wait(stopAnimDelaySeconds).then(function () {
                _this.stopAnimInProgress = false;
                if (_this.optionCb) {
                    _this.optionCb();
                    _this.optionCb = undefined;
                }
            });
        }
        else {
            this.optionsCache = undefined;
            this.exitAnimEvent = undefined;
            if (this.optionCb) {
                this.optionCb = undefined;
            }
        }
    };
    SweetCameraEnforcementService.prototype.startAntiExploitPolling = function (mode) {
        // Fixes https://github.com/skyrim-multiplayer/skymp5-gamemode/issues/240
        // P.S. There is a very similar code in skymp5-gamemode
        // See disableCheats.ts, skymp5-gamemode for comments
        var _this = this;
        if (mode === void 0) { mode = "death"; }
        var _callNative = this.sp.callNative;
        var cameraState = -1;
        var needsExitingAnim = false;
        var f = function (i) {
            var _a;
            if (i >= 10 * 60) {
                return;
            }
            cameraState = _callNative("Game", "getCameraState", undefined);
            needsExitingAnim = _this.needsExitingAnim;
            if (!needsExitingAnim) {
                return f(Infinity);
            }
            if (cameraState === 0) { // 1-st person
                _callNative("Game", "forceThirdPerson", undefined);
                _this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
                if (mode === "death") {
                    (_a = _this.sp.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.damageActorValue("Health", 10000);
                }
                return f(Infinity);
            }
            _this.controller.once("update", function () { return f(i + 1); });
        };
        f(0);
    };
    SweetCameraEnforcementService.prototype.onButtonEvent = function (e) {
        var _a, _b;
        // TODO: de-hardcode controls
        if (e.isPressed) {
            return;
        }
        if (e.code === 57 /* DxScanCode.Spacebar */
            || e.code === 17 /* DxScanCode.W */
            || e.code === 30 /* DxScanCode.A */
            || e.code === 31 /* DxScanCode.S */
            || e.code === 32 /* DxScanCode.D */) {
            if (this.needsExitingAnim) {
                if ((_a = this.currentAnim) === null || _a === void 0 ? void 0 : _a.options) {
                    this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: this.currentAnim.options.enablePlayerControlsDelayMs });
                }
                else {
                    this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
                }
            }
        }
        else {
            if (this.needsExitingAnim) {
                var intervalMs = (_b = this.settings) === null || _b === void 0 ? void 0 : _b.exitAnimNotificationIntervalMs;
                if (!intervalMs || (Date.now() - this.lastNotificationMoment) >= intervalMs) {
                    this.lastNotificationMoment = Date.now();
                    this.sp.Debug.notification(",    ");
                }
            }
        }
        if (!e.isUp) {
            return;
        }
        if (!this.settings || !this.settings.animKeys) {
            return;
        }
        var animEvent = this.settings.animKeys[e.code];
        if (!animEvent) {
            return;
        }
        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Starting anims from keyboard is disabled in this version");
        // this.tryInvokeAnim(animEvent, {
        //     weaponDrawnAllowed: false,
        //     furnitureAllowed: false,
        //     exitAnimName: null,
        //     interruptAnimName: null,
        //     timeMs: 0,
        //     isPlayExitAnimAfterwardsEnabled: true,
        //     parentAnimEventName: null,
        //     enablePlayerControlsDelayMs: null,
        //     preferInterruptAnimAsExitAnimTimeMs: null,
        // });
    };
    SweetCameraEnforcementService.prototype.tryInvokeAnim = function (animEvent, options) {
        var _this = this;
        this.tryInvokeAnimCount++;
        if (this.tryInvokeAnimCount >= this.tryInvokeAnimCountMax) {
            this.tryInvokeAnimCount = 0;
        }
        var currentInvokeAnimCount = this.tryInvokeAnimCount;
        if (typeof options.exitAnimName === "string") {
            this.exitAnimName = options.exitAnimName;
        }
        else {
            this.exitAnimName = null;
        }
        if (typeof options.interruptAnimName === "string") {
            this.interruptAnimName = options.interruptAnimName;
        }
        else {
            this.interruptAnimName = null;
        }
        if (typeof options.timeMs === "number" && options.timeMs > 0 && Number.isFinite(options.timeMs)) {
            var timeSeconds = options.timeMs / 1000;
            // Using Utility.wait makes sense because it waits game time, not simply real time.
            this.sp.Utility.wait(timeSeconds).then(function () {
                if (_this.tryInvokeAnimCount !== currentInvokeAnimCount) {
                    return;
                }
                if (!_this.needsExitingAnim) {
                    return;
                }
                var isPlayExitAnimAfterwardsEnabled = typeof options.isPlayExitAnimAfterwardsEnabled === "boolean" ? options.isPlayExitAnimAfterwardsEnabled : true;
                _this.exitAnim({ playExitAnim: isPlayExitAnimAfterwardsEnabled, enablePlayerControlsDelayMs: options.enablePlayerControlsDelayMs });
            });
        }
        var player = this.sp.Game.getPlayer();
        if (!player) {
            return { success: false, reason: "player_not_found" };
        }
        if (player.isWeaponDrawn() && !options.weaponDrawnAllowed) {
            return { success: false, reason: "weapon_drawn" };
        }
        if (player.getAnimationVariableBool("bInJumpState")) {
            return { success: false, reason: "jump_state" };
        }
        if (this.sp.Ui.isMenuOpen("FavoritesMenu" /* Menu.Favorites */)) {
            return { success: false, reason: "favorites_menu_open" };
        }
        if (this.sp.Ui.isMenuOpen("Console" /* Menu.Console */)) {
            return { success: false, reason: "console_menu_open" };
        }
        if (this.stopAnimInProgress) {
            return { success: false, reason: "busy_stopping_anim" };
        }
        if (player.getFurnitureReference() && !options.furnitureAllowed) {
            return { success: false, reason: "player_in_furniture" };
        }
        if (player.isSneaking()) {
            return { success: false, reason: "player_sneaking" };
        }
        if (player.isSwimming()) {
            return { success: false, reason: "player_swimming" };
        }
        if (animEvent.toLowerCase() === "idleforcedefaultstate") {
            if (this.needsExitingAnim) {
                this.exitAnim({ playExitAnim: true, enablePlayerControlsDelayMs: undefined });
            }
        }
        else {
            var doInvoke = function () {
                _this.sp.Game.forceThirdPerson();
                _this.sp.Game.disablePlayerControls(true, false, true, false, false, false, false, false, 0);
                _this.sp.Debug.sendAnimationEvent(_this.sp.Game.getPlayer(), animEvent);
                var preferInterruptAnimState = null;
                if (typeof options.preferInterruptAnimAsExitAnimTimeMs === "number"
                    && options.preferInterruptAnimAsExitAnimTimeMs > 0
                    && Number.isFinite(options.preferInterruptAnimAsExitAnimTimeMs)) {
                    var state_1 = { prefer: true };
                    (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Prefer interrupt anim as exit anim for ".concat(options.preferInterruptAnimAsExitAnimTimeMs, " ms"));
                    _this.sp.Utility.wait(options.preferInterruptAnimAsExitAnimTimeMs / 1000).then(function () {
                        state_1.prefer = false;
                        (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "Prefer interrupt anim as exit anim state changed to false");
                    });
                    preferInterruptAnimState = state_1;
                }
                _this.currentAnim = { name: animEvent, options: options, preferInterruptAnimState: preferInterruptAnimState };
                _this.startAntiExploitPolling("no_death");
            };
            if (typeof options.parentAnimEventName === "string" && this.currentAnimName === options.parentAnimEventName) {
                doInvoke();
            }
            else if (Array.isArray(options.parentAnimEventName) && options.parentAnimEventName.includes(this.currentAnimName)) {
                doInvoke();
            }
            else if (this.needsExitingAnim) {
                // TODO (1): consider not using enablePlayerControlsDelayMs here, because useInterruptAnimAsExitAnim doesn't need it
                this.optionCb = doInvoke;
                this.exitAnim({ playExitAnim: true, useInterruptAnimAsExitAnim: true, enablePlayerControlsDelayMs: options.enablePlayerControlsDelayMs });
            }
            else {
                doInvoke();
            }
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Sent animation event: ".concat(animEvent));
        }
        return { success: true };
    };
    SweetCameraEnforcementService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    Object.defineProperty(SweetCameraEnforcementService.prototype, "needsExitingAnim", {
        get: function () {
            return this.currentAnimName !== null;
        },
        enumerable: false,
        configurable: true
    });
    Object.defineProperty(SweetCameraEnforcementService.prototype, "currentAnimName", {
        get: function () {
            return this.currentAnim ? this.currentAnim.name : null;
        },
        enumerable: false,
        configurable: true
    });
    return SweetCameraEnforcementService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyDynamicPerksService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetTaffyDynamicPerksService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyDynamicPerksService: () => (/* binding */ SweetTaffyDynamicPerksService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SweetTaffyDynamicPerksService = /** @class */ (function (_super) {
    __extends(SweetTaffyDynamicPerksService, _super);
    function SweetTaffyDynamicPerksService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.requestAddPerksToActors = function (actorIds, perkIds) {
            _this.controller.once("update", function () {
                var actors = actorIds.map(function (actorId) { return _this.sp.Actor.from(_this.sp.Game.getFormEx(actorId)); }).filter(function (actor) { return actor !== null; });
                var perks = perkIds.map(function (perkId) { return _this.sp.Perk.from(_this.sp.Game.getFormEx(perkId)); }).filter(function (perk) { return perk !== null; });
                actors.forEach(function (actor) { return perks.forEach(function (perk) { return actor === null || actor === void 0 ? void 0 : actor.addPerk(perk); }); });
            });
        };
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(_this, "SweetTaffy features enabled");
        }
        controller.on('containerChanged', function (e) { return _this.onContainerChanged(e); });
        controller.emitter.on("setInventoryMessage", function (e) { return _this.onSetInventoryMessage(e); });
        controller.emitter.on("createActorMessage", function (e) { return _this.onCreateActorMessage(e); });
        return _this;
    }
    SweetTaffyDynamicPerksService.prototype.onContainerChanged = function (e) {
        if (!this.hasSweetPie()) {
            return;
        }
        if (e.oldContainer && e.newContainer) {
            if (e.newContainer.getFormID() === 0x14 && e.numItems > 0) {
                this.handlePlayerInventoryChanged({
                    baseId: e.baseObj.getFormID(),
                    count: e.numItems,
                });
            }
        }
    };
    SweetTaffyDynamicPerksService.prototype.onSetInventoryMessage = function (e) {
        var _this = this;
        if (!this.hasSweetPie()) {
            return;
        }
        var entries = e.message.inventory.entries;
        if (entries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received SetInventoryMessage with empty inventory");
            return;
        }
        this.controller.once("update", function () {
            entries.forEach(function (entry) { return _this.handlePlayerInventoryChanged(entry); });
        });
    };
    SweetTaffyDynamicPerksService.prototype.onCreateActorMessage = function (e) {
        var _this = this;
        var _a, _b;
        if (!this.hasSweetPie()) {
            return;
        }
        if (!e.message.isMe) {
            return;
        }
        var entries = (_b = (_a = e.message.props) === null || _a === void 0 ? void 0 : _a.inventory) === null || _b === void 0 ? void 0 : _b.entries;
        if (entries === undefined) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received CreateActorMessage without inventory");
            return;
        }
        if (entries.length === 0) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_1__.logTrace)(this, "Received CreateActorMessage with empty inventory");
            return;
        }
        this.controller.once("update", function () {
            entries.forEach(function (entry) { return _this.handlePlayerInventoryChanged(entry); });
        });
    };
    SweetTaffyDynamicPerksService.prototype.handlePlayerInventoryChanged = function (entry) {
        if (!this.hasSweetPie()) {
            return;
        }
        var item = this.sp.Game.getFormEx(entry.baseId);
        if (!item) {
            return;
        }
        if (entry.count <= 0) {
            return;
        }
        var perkIds = this.getPerkIdsByKeyword(item);
        if (perkIds) {
            var playerId = 0x14;
            this.requestAddPerksToActors([playerId], perkIds);
        }
    };
    SweetTaffyDynamicPerksService.prototype.getPerkIdsByKeyword = function (item) {
        var _this = this;
        var result = new Array();
        this.getKeywordPerkMap().forEach(function (v, k) {
            var keyWord = _this.sp.Keyword.getKeyword(k);
            if (item.hasKeyword(keyWord)) {
                result.push(v);
            }
        });
        return result.length > 0 ? result : null;
    };
    // TODO: move this to config
    SweetTaffyDynamicPerksService.prototype.getKeywordPerkMap = function () {
        return new Map([
            // 
            ["SweetPerkBow1", 0x1036F0],
            ["SweetPerkBow2", 0x58F61],
            ["SweetPerkBow3", 0x105F19],
            ["SweetPerkBow4", 0x58F63],
            // 
            ["SweetPerkSneak1", 0x58210],
            ["SweetPerkSneak2", 0x105F23],
            ["SweetPerkSneak3", 0x58208],
            ["SweetPerkSneak4", 0x58211],
            // 
            ["SweetPerkArmorLight1", 0x105F22],
            ["SweetPerkArmorLight2", 0x51B1C],
            // 
            ["SweetPerkEnchant2", 0x108A44],
            ["SweetPerkEnchant1", 0x58F7C],
            // 
            ["SweetPerkArmorHeavy1", 0xBCD2B],
            ["SweetPerkArmorHeavy2", 0x58F6D],
            // 
            ["SweetPerkBlock1", 0x58F67],
            ["SweetPerkBlock2", 0x106253],
            ["SweetPerkBlock3", 0x58F6A],
            ["SweetPerkBlock4", 0x58F69],
            // , , , , , ,  ( )
            ["SweetPerk1Hand2Hand1", 0x58F6F],
            ["SweetPerk2Hand2", 0xCB407],
            ["SweetPerk2Hand3", 0x96590],
            ["SweetPerk2Hand4", 0x52D51],
            // , , , , , , ,  ( )
            ["SweetPerk1Hand2Hand1", 0x58F6F],
            ["SweetPerk1Hand2", 0xCB406],
            ["SweetPerk1Hand3", 0x106256],
            ["SweetPerk1Hand4", 0x52D50],
        ]);
    };
    SweetTaffyDynamicPerksService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyDynamicPerksService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyNicknamesService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/sweetTaffyNicknamesService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyNicknamesService: () => (/* binding */ SweetTaffyNicknamesService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var SweetTaffyNicknamesService = /** @class */ (function (_super) {
    __extends(SweetTaffyNicknamesService, _super);
    function SweetTaffyNicknamesService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.emitter.on("nicknameCreate", function (e) { return _this.onNicknameCreate(e); });
        controller.emitter.on("nicknameDestroy", function (e) { return _this.onNicknameDestroy(e); });
        return _this;
    }
    SweetTaffyNicknamesService.prototype.onNicknameCreate = function (e) {
        var _a;
        var storageNickname = typeof this.sp.storage["idTextNickname"] === 'object'
            ? this.sp.storage["idTextNickname"]
            : null;
        if (storageNickname === null && e.remoteRefrId) {
            this.sp.storage["idTextNickname"] = (_a = {}, _a[e.remoteRefrId] = e.textId, _a);
        }
        else if (storageNickname !== null && e.remoteRefrId) {
            storageNickname[e.remoteRefrId] = e.textId;
            this.sp.storage["idTextNickname"] = storageNickname;
        }
    };
    SweetTaffyNicknamesService.prototype.onNicknameDestroy = function (e) {
        var storageNickname = typeof this.sp.storage["idTextNickname"] === 'object'
            ? this.sp.storage["idTextNickname"]
            : null;
        if (storageNickname !== null && e.remoteRefrId) {
            delete storageNickname[e.remoteRefrId];
            this.sp.storage["idTextNickname"] = storageNickname;
        }
    };
    return SweetTaffyNicknamesService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));

;


/***/ }),

/***/ "./src/services/services/sweetTaffyPlayerCombatService.ts":
/*!****************************************************************!*\
  !*** ./src/services/services/sweetTaffyPlayerCombatService.ts ***!
  \****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyPlayerCombatService: () => (/* binding */ SweetTaffyPlayerCombatService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


// TODO: move to service
var playerLastStaminaValue = 0;
var playerLastIsSprintingValue = false;
var blockPlayerControlTimeStamp = 0;
var isPlayerControlDisabled = true;
var playerAttackTimeout = 0;
var activeTimers = new Set();
// TODO: move to config
var staminaAttackMap = new Map([
    ["Std", 7],
    ["Power", 35],
    ["Jump", 15],
    ["Bow", 25],
    ["Crossbow", 30],
]);
// TODO: consider splitting this service (separate stamina and timer management)
// TODO: subscribe events/hooks in constructor
var SweetTaffyPlayerCombatService = /** @class */ (function (_super) {
    __extends(SweetTaffyPlayerCombatService, _super);
    function SweetTaffyPlayerCombatService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SweetTaffyPlayerCombatService.prototype.onceUpdate = function () {
        this.setAttackStaminaRestriction();
        this.registerHandlersIfNeeded();
    };
    SweetTaffyPlayerCombatService.prototype.setAttackStaminaRestriction = function () {
        var _this = this;
        if (!this.hasSweetPie()) {
            return;
        }
        this.controller.on("update", function () {
            var player = _this.sp.Game.getPlayer();
            playerLastStaminaValue = player.getActorValue("Stamina");
            playerLastIsSprintingValue = player.isSprinting();
        });
        for (var _i = 0, _a = ['SprintStart']; _i < _a.length; _i++) {
            var pattern = _a[_i];
            var sp = this.sp;
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    if (playerLastStaminaValue < 7.5) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _b = 0, _c = ['blockStart']; _b < _c.length; _b++) {
            var pattern = _c[_b];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    if (playerLastIsSprintingValue) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _d = 0, _e = ['attackStart*', 'AttackStart*']; _d < _e.length; _d++) {
            var pattern = _e[_d];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Std")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _f = 0, _g = ['attackPowerStart*', 'AttackPowerStart*']; _f < _g.length; _f++) {
            var pattern = _g[_f];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Power")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _h = 0, _j = ['JumpDirectionalStart*', 'JumpStandingStart*']; _h < _j.length; _h++) {
            var pattern = _j[_h];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Jump")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _k = 0, _l = ['bowAttackStart*']; _k < _l.length; _k++) {
            var pattern = _l[_k];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Bow")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
        for (var _m = 0, _o = ['crossbowAttackStart*']; _m < _o.length; _m++) {
            var pattern = _o[_m];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function (ctx) {
                    var _a;
                    if (playerLastStaminaValue < ((_a = staminaAttackMap.get("Crossbow")) !== null && _a !== void 0 ? _a : 0)) {
                        ctx.animEventName = "";
                    }
                }),
                leave: (function () { }),
            }, 0x14, 0x14, pattern);
        }
    };
    SweetTaffyPlayerCombatService.prototype.registerHandlersIfNeeded = function () {
        var _this = this;
        var self = this;
        if (!this.hasSweetPie()) {
            return;
        }
        for (var _i = 0, _a = ['attackStart*', 'AttackStart*']; _i < _a.length; _i++) {
            var pattern = _a[_i];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function () { }),
                leave: (function (ctx) { return self.blockPlayerAttack(ctx.animEventName.toLowerCase().includes('lefthand')); }),
            }, 0x14, 0x14, pattern);
        }
        for (var _b = 0, _c = ['attackPowerStart*', 'AttackPowerStart*', 'Jump*']; _b < _c.length; _b++) {
            var pattern = _c[_b];
            this.sp.hooks.sendAnimationEvent.add({
                enter: (function () { }),
                leave: (function () {
                    playerAttackTimeout = 0;
                    activeTimers.clear();
                }),
            }, 0x14, 0x14, pattern);
        }
        this.controller.on("update", function () {
            if (isPlayerControlDisabled === true && Date.now() - blockPlayerControlTimeStamp >= playerAttackTimeout) {
                _this.sp.Game.getPlayer().setDontMove(false);
                isPlayerControlDisabled = false;
            }
        });
    };
    SweetTaffyPlayerCombatService.prototype.blockPlayerAttack = function (isLeftHand) {
        var _this = this;
        this.controller.once("update", function () {
            var _a;
            var player = _this.sp.Game.getPlayer();
            if (player.getAnimationVariableBool("bInJumpState")) {
                return;
            }
            var _b = _this.getTimings((_a = player.getEquippedWeapon(isLeftHand)) === null || _a === void 0 ? void 0 : _a.getWeaponType()), delay = _b[0], timeout = _b[1];
            var rnd = Math.random().toString();
            activeTimers.add(rnd);
            _this.sp.Utility.wait(delay / 1000).then(function () {
                if (!activeTimers.delete(rnd)) {
                    return;
                }
                _this.controller.once("update", function () {
                    isPlayerControlDisabled = true;
                    blockPlayerControlTimeStamp = Date.now();
                    _this.sp.Game.getPlayer().setDontMove(true);
                    playerAttackTimeout = timeout;
                });
            });
        });
    };
    SweetTaffyPlayerCombatService.prototype.getAndValidateTimingsConfigKey = function (key, weaponTimings) {
        var value = weaponTimings[key];
        if (value && Array.isArray(value) && value.length === 2) {
            var element0 = value[0];
            if (typeof element0 !== "number") {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "Invalid timings config for weapon type", key, value);
                return [0, 0];
            }
            var element1 = value[1];
            if (typeof element1 !== "number") {
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "Invalid timings config for weapon type", key, value);
                return [0, 0];
            }
            return [element0, element1];
        }
        return [0, 0];
    };
    ;
    SweetTaffyPlayerCombatService.prototype.getSettingsFromFile = function () {
        var sweetTaffyPlayerCombatService = this.sp.settings["skymp5-client"]["sweetTaffyPlayerCombatService"];
        if (!sweetTaffyPlayerCombatService || typeof sweetTaffyPlayerCombatService !== "object") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No sweetTaffyPlayerCombatService settings found");
            return null;
        }
        var weaponTimings = sweetTaffyPlayerCombatService.weaponTimings;
        if (!weaponTimings || typeof weaponTimings !== "object") {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No weaponTimings settings found");
            return null;
        }
        return weaponTimings;
    };
    SweetTaffyPlayerCombatService.prototype.getSettingsDefault = function () {
        return {
            fist: [0, 30],
            sword: [0, 30],
            dagger: [0, 60],
            warAxe: [0, 60],
            mace: [0, 65],
            greatsword: [0, 65],
            // Note: both of Battleaxe and Warhammer weapon types correspond to id=6.
            battleaxe: [0, 70],
            warhammer: [0, 70],
            bow: [0, 70],
            staff: [0, 70],
            crossbow: [0, 70],
        };
    };
    SweetTaffyPlayerCombatService.prototype.getTimingsFromConfig = function (weapon) {
        if (!weapon) {
            weapon = 0 /* WeaponType.Fist */;
        }
        // skymp5-client-settings.txt is perfectly editable by users, so we don't use it for now.
        // It's well-tested though, so we can enable it once we have a protection mechanism.
        // const weaponTimings = this.getSettingsFromFile();
        var weaponTimings = this.getSettingsDefault();
        if (!weaponTimings) {
            return null;
        }
        var weaponTimingsResult = {
            fist: [0, 0],
            sword: [0, 0],
            dagger: [0, 0],
            warAxe: [0, 0],
            mace: [0, 0],
            greatsword: [0, 0],
            battleaxe: [0, 0],
            warhammer: [0, 0],
            bow: [0, 0],
            staff: [0, 0],
            crossbow: [0, 0],
        };
        weaponTimingsResult.fist = this.getAndValidateTimingsConfigKey("fist", weaponTimings);
        weaponTimingsResult.sword = this.getAndValidateTimingsConfigKey("sword", weaponTimings);
        weaponTimingsResult.dagger = this.getAndValidateTimingsConfigKey("dagger", weaponTimings);
        weaponTimingsResult.warAxe = this.getAndValidateTimingsConfigKey("warAxe", weaponTimings);
        weaponTimingsResult.mace = this.getAndValidateTimingsConfigKey("mace", weaponTimings);
        weaponTimingsResult.greatsword = this.getAndValidateTimingsConfigKey("greatsword", weaponTimings);
        weaponTimingsResult.battleaxe = this.getAndValidateTimingsConfigKey("battleaxe", weaponTimings);
        weaponTimingsResult.warhammer = this.getAndValidateTimingsConfigKey("warhammer", weaponTimings);
        weaponTimingsResult.bow = this.getAndValidateTimingsConfigKey("bow", weaponTimings);
        weaponTimingsResult.staff = this.getAndValidateTimingsConfigKey("staff", weaponTimings);
        weaponTimingsResult.crossbow = this.getAndValidateTimingsConfigKey("crossbow", weaponTimings);
        switch (weapon) {
            case 0 /* WeaponType.Fist */:
                return weaponTimingsResult.fist;
            case 1 /* WeaponType.Sword */:
                return weaponTimingsResult.sword;
            case 2 /* WeaponType.Dagger */:
                return weaponTimingsResult.dagger;
            case 3 /* WeaponType.WarAxe */:
                return weaponTimingsResult.warAxe;
            case 4 /* WeaponType.Mace */:
                return weaponTimingsResult.mace;
            case 5 /* WeaponType.Greatsword */:
                return weaponTimingsResult.greatsword;
            case 6 /* WeaponType.Battleaxe */:
                return weaponTimingsResult.battleaxe;
            case 6 /* WeaponType.Warhammer */:
                return weaponTimingsResult.warhammer;
            case 7 /* WeaponType.Bow */:
                return weaponTimingsResult.bow;
            case 8 /* WeaponType.Staff */:
                return weaponTimingsResult.staff;
            case 9 /* WeaponType.Crossbow */:
                return weaponTimingsResult.crossbow;
            default:
                (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No timings found for weapon type", weapon);
                return null;
        }
    };
    SweetTaffyPlayerCombatService.prototype.getTimings = function (weapon) {
        var timingsFromConfig = this.getTimingsFromConfig(weapon);
        if (!weapon || !timingsFromConfig) {
            weapon = 0 /* WeaponType.Fist */;
            timingsFromConfig = this.getTimingsFromConfig(weapon);
        }
        if (!timingsFromConfig) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)(this, "No timings found for weapon type", weapon);
            return [0, 0];
        }
        return timingsFromConfig;
    };
    ;
    SweetTaffyPlayerCombatService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyPlayerCombatService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffySkillMenuService.ts":
/*!*************************************************************!*\
  !*** ./src/services/services/sweetTaffySkillMenuService.ts ***!
  \*************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffySkillMenuService: () => (/* binding */ SweetTaffySkillMenuService)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



// TODO: move to server/gamemode
var SweetTaffySkillMenuService = /** @class */ (function (_super) {
    __extends(SweetTaffySkillMenuService, _super);
    function SweetTaffySkillMenuService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.altars = [
            0x00100780, 0x000D9883, 0x000D987B, 0x000D9881, 0x000D9887, 0x000FB997,
            0x000D9885, 0x000D987D, 0x00071854, 0x07187500, 0x0200c86b, 0x000d987f,
            0x07058d4e, 0x07058d53, 0x070A6912, 0x07058d51, 0x07058d50, 0x07058d4f,
            0x07058d4d, 0x07058d4c, 0x07058d4b, 0x0705e2fa, 0x07058d4a, 0x07058d49,
            0x0705e367, 0x07058d48, 0x07058d55, 0x07058d46, 0x07058d47, 0x0705e2b0,
            0x07058d45
        ];
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("activate", function (e) { return _this.onActivate(e); });
        return _this;
    }
    SweetTaffySkillMenuService.prototype.onActivate = function (event) {
        var _a;
        if (!this.hasSweetPie()) {
            return;
        }
        if (!this.altars.includes(((_a = event.target.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) || -1)) {
            return;
        }
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.browser.setFocused(true);
        var src = "window.dispatchEvent(new CustomEvent('initSkillMenu'))";
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.browser.executeJavaScript(src);
    };
    SweetTaffySkillMenuService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffySkillMenuService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffyStaticPerksService.ts":
/*!***************************************************************!*\
  !*** ./src/services/services/sweetTaffyStaticPerksService.ts ***!
  \***************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffyStaticPerksService: () => (/* binding */ SweetTaffyStaticPerksService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();


var SweetTaffyStaticPerksService = /** @class */ (function (_super) {
    __extends(SweetTaffyStaticPerksService, _super);
    function SweetTaffyStaticPerksService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        // TODO: move this to config
        _this.stealth = [0xBE126, 0xC07C6, 0xC07C7, 0xC07C8, 0xC07C9];
        _this.magic = [0x58213, 0x105F24, 0x58214];
        _this.warrior = [0xCB40D, 0xCB40F, 0xCB414, 0xCB411, 0xCB412, 0xCB410, 0xCB40E];
        if (!_this.hasSweetPie()) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features disabled");
        }
        else {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)(_this, "SweetTaffy features enabled");
        }
        _this.controller.once("update", function () { return _this.onceUpdate(); });
        return _this;
    }
    SweetTaffyStaticPerksService.prototype.onceUpdate = function () {
        if (!this.hasSweetPie()) {
            return;
        }
        this.addStaticPerksToThePlayer();
    };
    SweetTaffyStaticPerksService.prototype.addStaticPerksToThePlayer = function () {
        var _this = this;
        var player = this.sp.Game.getPlayer();
        var allStaticPerkIds = this.stealth.concat(this.magic).concat(this.warrior);
        allStaticPerkIds.forEach(function (perkId) {
            player.addPerk(_this.sp.Perk.from(_this.sp.Game.getFormEx(perkId)));
        });
    };
    SweetTaffyStaticPerksService.prototype.hasSweetPie = function () {
        var modCount = this.sp.Game.getModCount();
        for (var i = 0; i < modCount; ++i) {
            if (this.sp.Game.getModName(i).toLowerCase().includes('sweetpie')) {
                return true;
            }
        }
        return false;
    };
    return SweetTaffyStaticPerksService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/sweetTaffySweetCantDropService.ts":
/*!*****************************************************************!*\
  !*** ./src/services/services/sweetTaffySweetCantDropService.ts ***!
  \*****************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SweetTaffySweetCantDropService: () => (/* binding */ SweetTaffySweetCantDropService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

// TODO: move to the server/gamemode
var SweetTaffySweetCantDropService = /** @class */ (function (_super) {
    __extends(SweetTaffySweetCantDropService, _super);
    function SweetTaffySweetCantDropService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.cantDropKeyword = "SweetCantDrop";
        return _this;
    }
    SweetTaffySweetCantDropService.prototype.canDropOrPutItem = function (itemId) {
        var item = this.sp.Game.getFormEx(itemId);
        if (item !== null) {
            if (item.hasKeyword(this.sp.Keyword.getKeyword(this.cantDropKeyword))) {
                return false;
            }
        }
        return true;
    };
    return SweetTaffySweetCantDropService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/timeService.ts":
/*!**********************************************!*\
  !*** ./src/services/services/timeService.ts ***!
  \**********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   TimeService: () => (/* binding */ TimeService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var TimeService = /** @class */ (function (_super) {
    __extends(TimeService, _super);
    function TimeService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.lastTimeUpd = 0;
        controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    TimeService.prototype.getTime = function () {
        var hoursOffsetSetting = this.sp.settings["skymp5-client"]["hoursOffset"];
        var hoursOffset = typeof hoursOffsetSetting === "number" ? hoursOffsetSetting : 0;
        var hoursOffsetMs = hoursOffset * 60 * 60 * 1000;
        var d = new Date(Date.now() + hoursOffsetMs);
        var newGameHourValue = 0;
        newGameHourValue += d.getUTCHours();
        newGameHourValue += d.getUTCMinutes() / 60;
        newGameHourValue += d.getUTCSeconds() / 60 / 60;
        newGameHourValue += d.getUTCMilliseconds() / 60 / 60 / 1000;
        return { newGameHourValue: newGameHourValue, date: d };
    };
    TimeService.prototype.every2seconds = function () {
        var gameHourId = 0x38;
        var gameMonthId = 0x36;
        var gameDayId = 0x37;
        var gameYearId = 0x35;
        var timeScaleId = 0x3a;
        var gameHour = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameHourId));
        var gameDay = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameDayId));
        var gameMonth = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameMonthId));
        var gameYear = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(gameYearId));
        var timeScale = this.sp.GlobalVariable.from(this.sp.Game.getFormEx(timeScaleId));
        if (!gameHour || !gameDay || !gameMonth || !gameYear || !timeScale) {
            return;
        }
        var _a = this.getTime(), newGameHourValue = _a.newGameHourValue, date = _a.date;
        var diff = Math.abs(gameHour.getValue() - newGameHourValue);
        if (diff >= 1 / 60) {
            gameHour.setValue(newGameHourValue);
            gameDay.setValue(date.getUTCDate());
            gameMonth.setValue(date.getUTCMonth());
            gameYear.setValue(date.getUTCFullYear() - 2020 + 199);
        }
        timeScale.setValue(gameHour.getValue() > newGameHourValue ? 0.6 : 1.2);
    };
    TimeService.prototype.onUpdate = function () {
        if (Date.now() - this.lastTimeUpd <= 2000) {
            return;
        }
        this.lastTimeUpd = Date.now();
        this.every2seconds();
    };
    return TimeService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/timersService.ts":
/*!************************************************!*\
  !*** ./src/services/services/timersService.ts ***!
  \************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   TimersService: () => (/* binding */ TimersService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();

var ProcessMethodType;
(function (ProcessMethodType) {
    ProcessMethodType["update"] = "update";
    ProcessMethodType["tick"] = "tick";
})(ProcessMethodType || (ProcessMethodType = {}));
var TimersService = /** @class */ (function (_super) {
    __extends(TimersService, _super);
    function TimersService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.timersArr = new Array();
        _this.intervalsArr = new Array();
        _this.lastCallTime = Date.now();
        _this.processMethodTypeStorageKey = "updateTypeStorageKey";
        var storageProcessMethod = sp.storage[_this.processMethodTypeStorageKey];
        if (typeof storageProcessMethod !== "function") {
            _this.setProcessMethod(storageProcessMethod);
        }
        else {
            _this.setProcessMethod(ProcessMethodType.tick);
        }
        _this.controller.on("menuOpen", function (e) { return _this.onMenuOpen(e); });
        _this.controller.on("preLoadGame", function () { return _this.onPreLoadGame(); });
        return _this;
    }
    TimersService.prototype.setTimeout = function (handler, timeout) {
        var args = [];
        for (var _i = 2; _i < arguments.length; _i++) {
            args[_i - 2] = arguments[_i];
        }
        var timer = { handler: handler, args: args, delayMs: timeout !== null && timeout !== void 0 ? timeout : 0, passedMs: 0 };
        for (var i = 0; i < this.timersArr.length; ++i) {
            if (!this.timersArr[i]) {
                this.timersArr[i] = timer;
                return i + 1;
            }
        }
        return this.timersArr.push(timer);
    };
    TimersService.prototype.clearTimeout = function (id) {
        if (id === undefined) {
            this.timersArr = new Array();
            return;
        }
        if (id <= 0 || id > this.timersArr.length) {
            return;
        }
        this.timersArr[id - 1] = null;
        return;
    };
    TimersService.prototype.setInterval = function (handler, timeout) {
        var args = [];
        for (var _i = 2; _i < arguments.length; _i++) {
            args[_i - 2] = arguments[_i];
        }
        var timer = { handler: handler, args: args, delayMs: timeout !== null && timeout !== void 0 ? timeout : 0, passedMs: 0 };
        for (var i = 0; i < this.intervalsArr.length; ++i) {
            if (!this.intervalsArr[i]) {
                this.intervalsArr[i] = timer;
                return i + 1;
            }
        }
        return this.intervalsArr.push(timer);
    };
    TimersService.prototype.clearInterval = function (id) {
        if (id === undefined) {
            this.intervalsArr = new Array();
            return;
        }
        if (id <= 0 || id > this.intervalsArr.length) {
            return;
        }
        this.intervalsArr[id - 1] = null;
        return;
    };
    TimersService.prototype.setProcessMethod = function (method) {
        var _this = this;
        switch (method) {
            case ProcessMethodType.tick:
                this.sp.storage[this.processMethodTypeStorageKey] = ProcessMethodType.tick;
                this.updateEventHandle = this.controller.on(ProcessMethodType.tick, function () { return _this.processTimers(); });
                return;
            case ProcessMethodType.update:
                this.sp.storage[this.processMethodTypeStorageKey] = ProcessMethodType.update;
                this.updateEventHandle = this.controller.on(ProcessMethodType.update, function () { return _this.processTimers(); });
                return;
            default:
                break;
        }
        try {
            if (this.sp.Game.getPlayer()) {
                // FIXME(GM-1008)
            }
            this.setProcessMethod(ProcessMethodType.update);
        }
        catch (_a) {
            this.setProcessMethod(ProcessMethodType.tick);
        }
    };
    TimersService.prototype.processTimers = function () {
        var dt = Date.now() - this.lastCallTime;
        this.lastCallTime = Date.now();
        // process timers
        for (var i = 0; i < this.timersArr.length; ++i) {
            var timer = this.timersArr[i];
            if (timer) {
                timer.passedMs += dt;
                if (timer.passedMs >= timer.delayMs) {
                    this.timersArr[i] = null;
                    if (typeof timer.handler === "function") {
                        timer.handler.call(this, timer.args);
                    }
                    else {
                        eval(timer.handler);
                    }
                }
            }
            else if (i === this.timersArr.length - 1) {
                // remove last unused element
                this.timersArr.length -= 1;
            }
        }
        // process intervals
        for (var i = 0; i < this.intervalsArr.length; ++i) {
            var interval = this.intervalsArr[i];
            if (interval) {
                interval.passedMs += dt;
                if (interval.passedMs >= interval.delayMs) {
                    interval.passedMs = 0;
                    if (typeof interval.handler === "function") {
                        interval.handler.call(this, interval.args);
                    }
                    else {
                        eval(interval.handler);
                    }
                }
            }
            else if (i === this.intervalsArr.length - 1) {
                // remove last unused element
                this.intervalsArr.length -= 1;
            }
        }
    };
    TimersService.prototype.onMenuOpen = function (e) {
        if (e.name === "Main Menu" /* Menu.Main */) {
            if (this.updateEventHandle) {
                this.sp.unsubscribe(this.updateEventHandle);
            }
            this.setProcessMethod(ProcessMethodType.tick);
        }
    };
    TimersService.prototype.onPreLoadGame = function () {
        if (this.updateEventHandle) {
            this.sp.unsubscribe(this.updateEventHandle);
        }
        this.setProcessMethod(ProcessMethodType.update);
    };
    return TimersService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/services/voiceChatService.ts":
/*!***************************************************!*\
  !*** ./src/services/services/voiceChatService.ts ***!
  \***************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   VoiceChatService: () => (/* binding */ VoiceChatService)
/* harmony export */ });
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _remoteServer__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var VoiceChatService = /** @class */ (function (_super) {
    __extends(VoiceChatService, _super);
    function VoiceChatService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.isInitialized = false;
        _this.isTalking = false;
        _this.pushToTalkKey = 0x56; // V key
        _this.controller.on("tick", function () { return _this.onTick(); });
        _this.controller.on("update", function () { return _this.onUpdate(); });
        return _this;
    }
    VoiceChatService.prototype.onConnect = function () {
        // Voice chat initialization handled elsewhere for now
        (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Connected");
    };
    VoiceChatService.prototype.onDisconnect = function () {
        if (this.isTalking) {
            this.stopTalking();
        }
        this.isInitialized = false;
    };
    VoiceChatService.prototype.onTick = function () {
        if (!this.isInitialized) {
            return;
        }
        // Check push-to-talk key state
        var keyPressed = this.sp.Input.isKeyPressed(this.pushToTalkKey);
        if (keyPressed && !this.isTalking) {
            this.startTalking();
        }
        else if (!keyPressed && this.isTalking) {
            this.stopTalking();
        }
    };
    VoiceChatService.prototype.onUpdate = function () {
        // Handle continuous voice chat updates if needed
    };
    VoiceChatService.prototype.startTalking = function () {
        try {
            this.isTalking = true;
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Started talking");
            // Actual voice capture handled by underlying system
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to start talking: ".concat(error));
        }
    };
    VoiceChatService.prototype.stopTalking = function () {
        try {
            this.isTalking = false;
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Stopped talking");
            // Actual voice capture stopping handled by underlying system
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to stop talking: ".concat(error));
        }
    };
    // Handle incoming voice chat data from other players
    VoiceChatService.prototype.onReceiveVoiceData = function (speakerId, audioData, x, y, z) {
        if (!this.isInitialized) {
            return;
        }
        try {
            // Voice playback handled by underlying system
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logTrace)("VoiceChatService: Received voice data from ".concat(speakerId, " at (").concat(x, ", ").concat(y, ", ").concat(z, ")"));
        }
        catch (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Failed to process voice data: ".concat(error));
        }
    };
    // Handle binary voice packets received from the server
    VoiceChatService.prototype.onPacket = function (type, rawContent, error) {
        if (error) {
            (0,_logging__WEBPACK_IMPORTED_MODULE_0__.logError)("VoiceChatService: Packet error: ".concat(error));
            return;
        }
        if (!rawContent || rawContent.byteLength === 0) {
            return;
        }
        // Check if this is a binary voice packet
        var data = new Uint8Array(rawContent);
        if (data[0] === 135) { // BinaryVoicePacketId
            if (rawContent.byteLength >= 9) {
                // Extract speaker ID (4 bytes)
                var speakerIdBytes = data.slice(1, 5);
                var speakerId_1 = new DataView(speakerIdBytes.buffer).getUint32(0, true);
                // Extract data size (4 bytes)
                var dataSizeBytes = data.slice(5, 9);
                var dataSize = new DataView(dataSizeBytes.buffer).getUint32(0, true);
                if (rawContent.byteLength === 9 + dataSize) {
                    // Extract audio data
                    var audioData = data.slice(9);
                    // Get speaker position from world model
                    var remoteServer = this.controller.lookupListener(_remoteServer__WEBPACK_IMPORTED_MODULE_2__.RemoteServer);
                    var worldModel = remoteServer.getWorldModel();
                    var x = 0, y = 0, z = 0;
                    // Find the speaker in the world model to get position
                    var speakerForm = worldModel.forms.find(function (f) { return f && f.refrId === speakerId_1; });
                    if (speakerForm && speakerForm.movement) {
                        x = speakerForm.movement.pos[0];
                        y = speakerForm.movement.pos[1];
                        z = speakerForm.movement.pos[2];
                    }
                    this.onReceiveVoiceData(speakerId_1, audioData.buffer, x, y, z);
                }
            }
        }
    };
    // Get current push-to-talk key
    VoiceChatService.prototype.getPushToTalkKey = function () {
        return this.pushToTalkKey;
    };
    // Set push-to-talk key
    VoiceChatService.prototype.setPushToTalkKey = function (key) {
        if (this.isTalking) {
            this.stopTalking();
        }
        this.pushToTalkKey = key;
    };
    // Check if currently talking
    VoiceChatService.prototype.getIsTalking = function () {
        return this.isTalking;
    };
    // Check if voice chat is initialized
    VoiceChatService.prototype.getIsInitialized = function () {
        return this.isInitialized;
    };
    return VoiceChatService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_1__.ClientListener));



/***/ }),

/***/ "./src/services/services/worldCleanerService.ts":
/*!******************************************************!*\
  !*** ./src/services/services/worldCleanerService.ts ***!
  \******************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WorldCleanerService: () => (/* binding */ WorldCleanerService)
/* harmony export */ });
/* harmony import */ var _clientListener__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../logging */ "./src/logging.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();



var WorldCleanerService = /** @class */ (function (_super) {
    __extends(WorldCleanerService, _super);
    function WorldCleanerService(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        _this.protection = new Map();
        _this.controller.on("update", function () { return _this.onUpdate(); });
        _this.controller.emitter.on("gameLoad", function () { return _this.onGameLoad(); });
        return _this;
    }
    WorldCleanerService.prototype.modWcProtection = function (actorId, mod) {
        var currentProtection = this.protection.get(actorId);
        this.protection.set(actorId, currentProtection ? currentProtection + mod : mod);
    };
    WorldCleanerService.prototype.getWcProtection = function (actorId) {
        return this.protection.get(actorId) || 0;
    };
    WorldCleanerService.prototype.onGameLoad = function () {
        var player = this.sp.Game.getPlayer();
        if (!player) {
            return;
        }
        this.initialPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(player);
        this.initialCellOrWorld = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(player);
    };
    WorldCleanerService.prototype.onUpdate = function () {
        this.processOneActor();
    };
    WorldCleanerService.prototype.processOneActor = function () {
        var _this = this;
        var _a;
        var pc = this.sp.Game.getPlayer();
        if (pc === null) {
            return;
        }
        var actor = this.sp.Game.findRandomActor(pc.getPositionX(), pc.getPositionY(), pc.getPositionZ(), 8192);
        if (actor === null) {
            return;
        }
        var actorId = actor.getFormID();
        var currentProtection = this.protection.get(actorId) || 0;
        if (currentProtection > 0) {
            return;
        }
        if (actorId === 0x14 || actor.isDisabled() || actor.isDeleted()) {
            return;
        }
        if (this.isActorInDialogue(actor)) {
            // Deleting actor in dialogue crashes Skyrim
            // https://github.com/skyrim-multiplayer/issue-tracker/issues/13
            actor.setPosition(0, 0, 0);
            actor.disableNoWait(true); // Seems to not crash
            return;
        }
        // Keep vanila pre-placed bodies, but delete player bodies
        if (actor.isDead() && actorId < 0xff000000) {
            actor.blockActivation(true);
            return;
        }
        var pos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(actor);
        var cellOrWorld = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(actor);
        var chickenRace = 0xa919d;
        // We discovered anomaly chickens that fail to Disable if we load game near to them
        // Refs: 106C22, 106C23
        if (actorId < 0xff000000 && ((_a = actor.getRace()) === null || _a === void 0 ? void 0 : _a.getFormID()) === chickenRace) {
            if (this.initialPos && _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getDistanceNoZ(pos, this.initialPos) < 4096) {
                if (cellOrWorld === this.initialCellOrWorld) {
                    if (this.isActorInDialogue(actor)) {
                        return;
                    }
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)(this, "Deleting chicken anomaly", actorId.toString(16));
                    actor.killSilent(null);
                    actor.blockActivation(true);
                    actor.disableNoWait(false);
                    actor.setAlpha(0, false);
                    return;
                }
            }
        }
        actor.disable(false).then(function () {
            var ac = _this.sp.Actor.from(_this.sp.Game.getFormEx(actorId));
            if (!ac || _this.isActorInDialogue(ac)) {
                return;
            }
            ac.delete();
        });
    };
    WorldCleanerService.prototype.isActorInDialogue = function (ac) {
        return ac.isInDialogueWithPlayer() || ac.getDialogueTarget() !== null;
    };
    return WorldCleanerService;
}(_clientListener__WEBPACK_IMPORTED_MODULE_0__.ClientListener));



/***/ }),

/***/ "./src/services/spApiInteractor.ts":
/*!*****************************************!*\
  !*** ./src/services/spApiInteractor.ts ***!
  \*****************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpApiInteractor: () => (/* binding */ SpApiInteractor)
/* harmony export */ });
/* harmony import */ var _events_events__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./events/events */ "./src/services/events/events.ts");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__);


var SpApiInteractor = /** @class */ (function () {
    function SpApiInteractor() {
    }
    SpApiInteractor.setup = function (listeners) {
        listeners.forEach(function (listener) { return SpApiInteractor.registerListenerForLookup(listener.constructor, listener); });
    };
    SpApiInteractor.getControllerInstance = function () {
        if (SpApiInteractor.controller) {
            return SpApiInteractor.controller;
        }
        SpApiInteractor.controller = {
            // TODO: handle errors in event handlers. will output to game console by default
            on: skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.on,
            once: skyrimPlatform__WEBPACK_IMPORTED_MODULE_1__.once,
            emitter: _events_events__WEBPACK_IMPORTED_MODULE_0__.EventEmitterFactory.makeEventEmitter(),
            lookupListener: function (constructor) {
                var listener = SpApiInteractor.listenersForLookupByName.get(constructor);
                if (listener === undefined) {
                    throw new Error("listener not found for name '".concat(constructor.name, "'"));
                }
                if (!(listener instanceof constructor)) {
                    throw new Error("listener class mismatch for name '".concat(constructor.name, "'"));
                }
                return listener;
            },
        };
        return SpApiInteractor.controller;
    };
    SpApiInteractor.registerListenerForLookup = function (constructor, listener) {
        if (SpApiInteractor.listenersForLookupByName.has(constructor)) {
            throw new Error("listener re-registration for name '".concat(constructor, "'"));
        }
        SpApiInteractor.listenersForLookupByName.set(constructor, listener);
    };
    SpApiInteractor.listenersForLookupByName = new Map();
    return SpApiInteractor;
}());



/***/ }),

/***/ "./src/sync/actorvalues.ts":
/*!*********************************!*\
  !*** ./src/sync/actorvalues.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getActorValues: () => (/* binding */ getActorValues),
/* harmony export */   getMaximumActorValue: () => (/* binding */ getMaximumActorValue),
/* harmony export */   setActorValuePercentage: () => (/* binding */ setActorValuePercentage)
/* harmony export */ });
var getActorValues = function (ac) {
    if (!ac) {
        return { health: 0, stamina: 0, magicka: 0 };
    }
    var healthPercentage = (ac.isDead()) ? 0 : ac.getActorValuePercentage("health");
    var staminaPercentage = ac.getActorValuePercentage("stamina");
    var magickaPercentage = ac.getActorValuePercentage("magicka");
    var resultActorValue = {
        health: healthPercentage,
        stamina: staminaPercentage,
        magicka: magickaPercentage,
    };
    return resultActorValue;
};
var getMaximumActorValue = function (ac, avName) {
    var currentPercentage = ac.getActorValuePercentage(avName);
    return currentPercentage === 0 ?
        ac.getBaseActorValue(avName) :
        Math.ceil(ac.getActorValue(avName) / currentPercentage);
};
var setActorValuePercentage = function (ac, avName, percentage) {
    // Actor value percentage for health may be below zero (-1.8 for example, it means u have -180% health)
    var currentPercentage = ac.getActorValuePercentage(avName);
    if (currentPercentage === percentage) {
        return;
    }
    var currentMaxValue = getMaximumActorValue(ac, avName);
    var deltaPercentage = percentage - currentPercentage;
    if (deltaPercentage > 0) {
        ac.restoreActorValue(avName, deltaPercentage * currentMaxValue);
    }
    else if (deltaPercentage < 0) {
        ac.damageActorValue(avName, deltaPercentage * currentMaxValue);
    }
};


/***/ }),

/***/ "./src/sync/animation.ts":
/*!*******************************!*\
  !*** ./src/sync/animation.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   AnimationEventName: () => (/* binding */ AnimationEventName),
/* harmony export */   AnimationSource: () => (/* binding */ AnimationSource),
/* harmony export */   applyAnimation: () => (/* binding */ applyAnimation),
/* harmony export */   setDefaultAnimsDisabled: () => (/* binding */ setDefaultAnimsDisabled),
/* harmony export */   setupHooks: () => (/* binding */ setupHooks)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _movementApply__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./movementApply */ "./src/sync/movementApply.ts");
/* eslint-disable @typescript-eslint/no-empty-function */


var AnimationEventName;
(function (AnimationEventName) {
    AnimationEventName["Ragdoll"] = "Ragdoll";
    AnimationEventName["GetUpBegin"] = "GetUpBegin";
})(AnimationEventName || (AnimationEventName = {}));
;
var allowedIdles = new Array();
var refsWithDefaultAnimsDisabled = new Set();
var allowedAnims = new Set();
var actorSitAnimsLowerCase = [
    'idlestoolenterplayer',
    'idlestoolenter',
    'idlestoolenterinstant',
    'idlechairrightenter',
    'idlechairleftenter',
    'idlechairfrontenter',
    'idlechairenterinstant',
    'idlejarlchairenter',
    'idlejarlchairenterinstant',
    'idlesnowelfprincechairdialogue',
    'idlesnowelfprincechairenter',
    'idlesnowelfprincechairenterinstant',
    'idlechairchildenterinstant',
    'idlechairchildfrontenter',
    'idlechairchildleftenter',
    'idlechairchildrightenter',
];
var actorGetUpAnimsLowerCase = [
    'idlestoolbackexit',
    'idlechairrightexit',
    'idlechairrightquickexit',
    'idlechairleftexit',
    'idlechairleftquickexit',
    'idlechairfrontexit',
    'idlechairfrontquickexit',
    'idlechairchildfrontexit',
    'idlechairchildleftexit',
    'idlechairchildrightexit'
];
// It's critical for values to be the correct case, not just lowercase, otherwise 'allowedIdles' check will break
// We don't want to modify the check itself, because it'll be slower
var animOverridesLowerCase = {
    'idlechairbook_onepage': 'IdleChairEnterInstant',
    'idlechairshoulderflex': 'IdleChairEnterInstant',
    'idlechairwrite': 'IdleChairEnterInstant',
    'idlechairarmscrossedvar1': 'IdleChairEnterInstant',
    'chaireatingstart_vampiremeat': 'IdleChairEnterInstant',
    'chairreadingstart': 'IdleChairEnterInstant',
    'chairvampireeatingstart': 'IdleChairEnterInstant',
    'chairdrinkingstart': 'IdleChairEnterInstant',
    'chaireatingstart': 'IdleChairEnterInstant',
    // The only triple animation we know for now. One base anim to sit, then two to eat
    'chaireatingsoupstart': 'IdleChairEnterInstant',
    'idleeatsoup': 'IdleChairEnterInstant',
    // No need to re-play the animation, use instant variant for spawning actors
    // This is not essential, but makes the sync feel more smooth. The list is not complete.
    'idlechairrightenter': 'IdleChairEnterInstant',
    'idlechairleftenter': 'IdleChairEnterInstant',
    'idlechairfrontenter': 'IdleChairEnterInstant',
    // Untested yet looks correct
    'idlesnowelfprincefireandforget': 'IdleSnowElfPrinceChairEnterInstant',
    'idletablemugenter': 'IdleTableEnterInstant',
    'idletabledrinkenter': 'IdleTableEnterInstant',
    'idletabledrinkandmugenter': 'IdleTableEnterInstant'
};
// unclassified:
// IdleChairEnterInstant
// IdleChairEnterStart
// IdleChairEnterStop
// IdleChairEnterToSit
// IdleChairExitStart
// IdleChairExitToStand
// IdleChairSitting
// IdleLeftChairEnterStart
// ChairIdle
// IdleRightChairEnterStart
// IdleLeftChairEnterStart
var isIdle = function (animEventName) {
    var animEventNameLowerCase = animEventName.toLowerCase();
    return (animEventNameLowerCase === "motiondrivenidle" ||
        (animEventNameLowerCase.startsWith("idle") &&
            animEventNameLowerCase !== "idlestop" &&
            animEventNameLowerCase !== "idleforcedefaultstate"));
};
var applyAnimation = function (refr, anim, state) {
    if (state.lastNumChanges === anim.numChanges) {
        return;
    }
    state.lastNumChanges = anim.numChanges;
    if (state.useAnimOverrides) {
        var animOverride = animOverridesLowerCase[anim.animEventName.toLowerCase()];
        if (animOverride !== undefined) {
            anim.animEventName = animOverride;
        }
    }
    var animEventNameLowerCase = anim.animEventName.toLowerCase();
    if (isIdle(anim.animEventName)) {
        allowedIdles.push([refr.getFormID(), anim.animEventName]);
    }
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (anim.animEventName === "SkympFakeEquip") {
        if (ac) {
            (0,_movementApply__WEBPACK_IMPORTED_MODULE_1__.applyWeapDrawn)(ac, true);
        }
        return;
    }
    if (anim.animEventName === "SkympFakeUnequip") {
        if (ac) {
            (0,_movementApply__WEBPACK_IMPORTED_MODULE_1__.applyWeapDrawn)(ac, false);
        }
        return;
    }
    if (anim.animEventName === "Ragdoll") {
        if (ac) {
            if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["animationFunc1Set"] === true) {
                // @ts-ignore
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["animationFunc1"](ac);
            }
            else {
                ac.pushActorAway(ac, 0);
                ac.setActorValue("Variable10", -1000);
            }
        }
        return;
    }
    if (refsWithDefaultAnimsDisabled.has(refr.getFormID())) {
        if (animEventNameLowerCase.includes("attack")) {
            allowedAnims.add(refr.getFormID() + ":" + anim.animEventName);
        }
    }
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(refr, anim.animEventName);
    if (anim.animEventName === "GetUpBegin") {
        var refrId_1 = refr.getFormID();
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(1).then(function () {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId_1));
            if (ac) {
                ac.setActorValue("Variable10", 1000);
            }
        });
    }
    if (actorSitAnimsLowerCase.find(function (x) { return x === animEventNameLowerCase; }) !== undefined) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setCollision)(refr.getFormID(), false);
    }
    if (actorGetUpAnimsLowerCase.find(function (x) { return x === animEventNameLowerCase; }) !== undefined) {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setCollision)(refr.getFormID(), true);
    }
};
var setDefaultAnimsDisabled = function (refrId, disabled) {
    if (disabled) {
        refsWithDefaultAnimsDisabled.add(refrId);
    }
    else {
        refsWithDefaultAnimsDisabled.delete(refrId);
    }
};
var AnimationSource = /** @class */ (function () {
    function AnimationSource(refr) {
        var _this = this;
        this.refrId = 0;
        this.numChanges = 0;
        this.animEventName = "";
        this.weapNonDrawnBlocker = 0;
        this.weapDrawnBlocker = 0;
        this.sneakBlocker = null;
        this.refrId = refr.getFormID();
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.hooks.sendAnimationEvent.add({
            enter: function () { },
            leave: function (ctx) {
                if (ctx.selfId !== _this.refrId) {
                    return;
                }
                if (!ctx.animationSucceeded) {
                    // Workaround, see carryAnimSystem.ts in gamemode
                    // Case-sensetive check here for better performance
                    if (ctx.animEventName !== "OffsetCarryBasketStart") {
                        return;
                    }
                }
                _this.onSendAnimationEvent(ctx.animEventName);
            },
        });
    }
    AnimationSource.prototype.filterMovement = function (mov) {
        if (this.weapDrawnBlocker >= Date.now()) {
            mov.isWeapDrawn = true;
        }
        if (this.weapNonDrawnBlocker >= Date.now()) {
            mov.isWeapDrawn = false;
        }
        if (this.sneakBlocker === mov.isSneaking) {
            this.sneakBlocker = null;
        }
        else if (this.sneakBlocker === true) {
            mov.isSneaking = true;
        }
        else if (this.sneakBlocker === false) {
            mov.isSneaking = false;
        }
        return mov;
    };
    AnimationSource.prototype.getAnimation = function () {
        var _a = this, numChanges = _a.numChanges, animEventName = _a.animEventName;
        return { numChanges: numChanges, animEventName: animEventName };
    };
    AnimationSource.prototype.onSendAnimationEvent = function (animEventName) {
        if (ignoredAnims.has(animEventName)) {
            return;
        }
        var lower = animEventName.toLowerCase();
        var isTorchEvent = lower.includes("torch");
        if (animEventName.toLowerCase().includes("unequip") && !isTorchEvent) {
            this.weapNonDrawnBlocker = Date.now() + 300;
            animEventName = "SkympFakeUnequip";
        }
        else if (animEventName.toLowerCase().includes("equip") && !isTorchEvent) {
            this.weapDrawnBlocker = Date.now() + 300;
            animEventName = "SkympFakeEquip";
        }
        if (animEventName === "SneakStart") {
            this.sneakBlocker = true;
            return;
        }
        if (animEventName === "SneakStop") {
            this.sneakBlocker = false;
            return;
        }
        this.numChanges++;
        this.animEventName = animEventName;
    };
    return AnimationSource;
}());

var ignoredAnims = new Set([
    "moveStart",
    "moveStop",
    "turnStop",
    "CyclicCrossBlend",
    "CyclicFreeze",
    "TurnLeft",
    "TurnRight",
]);
var setupHooks = function () {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.hooks.sendAnimationEvent.add({
        enter: function (ctx) {
            if (refsWithDefaultAnimsDisabled.has(ctx.selfId)) {
                if (ctx.animEventName.toLowerCase().includes("attack")) {
                    var animKey = ctx.selfId + ":" + ctx.animEventName;
                    if (allowedAnims.has(animKey)) {
                        allowedAnims.delete(animKey);
                    }
                    else {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("block anim " + ctx.animEventName);
                        return (ctx.animEventName = "");
                    }
                }
            }
            // ShowRaceMenu forces this anim
            if (ctx.animEventName === "OffsetBoundStandingPlayerInstant") {
                return (ctx.animEventName = "");
            }
            // Disable idle animations for 0xff actors
            if (ctx.selfId < 0xff000000) {
                return;
            }
            if (isIdle(ctx.animEventName)) {
                var i = allowedIdles.findIndex(function (pair) {
                    return pair[0] === ctx.selfId && pair[1] === ctx.animEventName;
                });
                i === -1 ? (ctx.animEventName = "") : allowedIdles.splice(i, 1);
            }
        },
        leave: function () { },
    });
};


/***/ }),

/***/ "./src/sync/appearance.ts":
/*!********************************!*\
  !*** ./src/sync/appearance.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyAppearance: () => (/* binding */ applyAppearance),
/* harmony export */   applyAppearanceToPlayer: () => (/* binding */ applyAppearanceToPlayer),
/* harmony export */   applyTints: () => (/* binding */ applyTints),
/* harmony export */   getAppearance: () => (/* binding */ getAppearance),
/* harmony export */   silentVoiceTypeId: () => (/* binding */ silentVoiceTypeId)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var getAppearance = function (actor) {
    var base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(actor.getBaseObject());
    var hairColor = base.getHairColor();
    var skinColor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.getSkinColor(base);
    var newAppearance = {
        isFemale: base.getSex() === 1,
        raceId: base.getRace() ? base.getRace().getFormID() : 0,
        weight: base.getWeight(),
        hairColor: hairColor ? hairColor.getColor() : 0,
        headpartIds: [],
        headTextureSetId: base.getFaceTextureSet()
            ? base.getFaceTextureSet().getFormID()
            : 0,
        options: new Array(19),
        presets: new Array(4),
        tints: [],
        skinColor: skinColor ? skinColor.getColor() : 0,
        name: actor.getBaseObject().getName(),
    };
    var numHeadparts = base.getNumHeadParts();
    for (var i = 0; i < numHeadparts; ++i) {
        var part = base.getNthHeadPart(i);
        if (part) {
            newAppearance.headpartIds.push(part.getFormID());
        }
    }
    for (var i = 0; i < newAppearance.options.length; ++i) {
        newAppearance.options[i] = base.getFaceMorph(i);
    }
    for (var i = 0; i < newAppearance.presets.length; ++i) {
        newAppearance.presets[i] = base.getFacePreset(i);
    }
    var numTints = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getFormID() === actor.getFormID()
        ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNumTintMasks()
        : 0;
    for (var i = 0; i < numTints; ++i) {
        var tint = {
            texturePath: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskTexturePath(i),
            type: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskType(i),
            argb: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getNthTintMaskColor(i),
        };
        newAppearance.tints.push(tint);
    }
    return newAppearance;
};
var isVisible = function (argb) { return argb > 0x00ffffff || argb < 0; };
var applyTints = function (actor, appearance) {
    if (!appearance) {
        throw new Error("null appearance has been passed to applyTints");
    }
    var tints = appearance.tints.filter(function (t) { return isVisible(t.argb); });
    var raceWarPaintRegex = /.*Head.+WarPaint.*/;
    var uniWarPaintRegex = /.*HeadWarPaint.*/;
    var raceSpecificWarPaint = tints.filter(function (t) { return isVisible(t.argb) && t.texturePath.match(raceWarPaintRegex); }).length; // MaleHeadNordWarPaint
    var uniWarPaint = tints.filter(function (t) { return isVisible(t.argb) && t.texturePath.match(uniWarPaintRegex); }).length; // MaleHeadWarPaint
    if (raceSpecificWarPaint + uniWarPaint > 1) {
        // If visible war paints of these two types present, then Skyrim crashes
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("bad warpaint!", raceSpecificWarPaint, uniWarPaint);
        return;
    }
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.clearTintMasks(actor);
    tints.forEach(function (tint) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.pushTintMask(actor, tint.type, tint.argb, tint.texturePath);
    });
    var playerBaseId = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getBaseObject().getFormID();
    if (actor)
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setFormIdUnsafe(actor.getBaseObject(), playerBaseId);
};
var silentVoiceTypeId = 0x0002f7c3;
var applyAppearanceCommon = function (appearance, npc) {
    var race = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Race.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(appearance.raceId));
    var headparts = appearance.headpartIds
        .map(function (id) { return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.HeadPart.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id)); })
        .filter(function (headpart) { return !!headpart; });
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcSex(npc, appearance.isFemale ? 1 : 0);
    if (race) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcRace(npc, race);
    }
    npc.setWeight(appearance.weight);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcSkinColor(npc, appearance.skinColor);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setNpcHairColor(npc, appearance.hairColor);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.resizeHeadpartsArray(npc, headparts.length);
    headparts.forEach(function (v, i) { return npc.setNthHeadPart(v, i); });
    npc.setFaceTextureSet(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TextureSet.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(appearance.headTextureSetId))); // setFaceTextureSet supports null argument
    npc.setVoiceType(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.VoiceType.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(silentVoiceTypeId)));
    appearance.options.forEach(function (v, i) { return npc.setFaceMorph(v, i); });
    appearance.presets.forEach(function (v, i) { return npc.setFacePreset(v, i); });
    if (appearance.name) {
        npc.setName(appearance.name);
    }
    else {
        // for undefined or empty name
        npc.setName(" ");
    }
};
var applyAppearance = function (appearance) {
    var npc = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.createNpc();
    if (!npc) {
        throw new Error("createNpc returned null");
    }
    applyAppearanceCommon(appearance, npc);
    return npc;
};
var applyAppearanceToPlayer = function (appearance) {
    applyAppearanceCommon(appearance, skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().getBaseObject()));
    applyTints(null, appearance);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().queueNiNodeUpdate();
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.wait(0.0625).then(function () {
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
            var _a;
            (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()) === null || _a === void 0 ? void 0 : _a.startDeferredKill();
        });
    });
};


/***/ }),

/***/ "./src/sync/equipment.ts":
/*!*******************************!*\
  !*** ./src/sync/equipment.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyEquipment: () => (/* binding */ applyEquipment),
/* harmony export */   getEquipedSpell: () => (/* binding */ getEquipedSpell),
/* harmony export */   getEquipment: () => (/* binding */ getEquipment),
/* harmony export */   isBadMenuShown: () => (/* binding */ isBadMenuShown),
/* harmony export */   syncSpellEquipment: () => (/* binding */ syncSpellEquipment)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _inventory__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./inventory */ "./src/sync/inventory.ts");


var getEquipedSpell = function (refr, spellType) {
    var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (!actor) {
        return 0;
    }
    switch (spellType) {
        case 0 /* SpellType.Left */: {
            var spell = actor.getEquippedSpell(0 /* SpellType.Left */);
            return spell ? spell.getFormID() : 0;
        }
        case 1 /* SpellType.Right */: {
            var spell = actor.getEquippedSpell(1 /* SpellType.Right */);
            return spell ? spell.getFormID() : 0;
        }
        case 2 /* SpellType.Voice */: {
            var spell = actor.getEquippedSpell(2 /* SpellType.Voice */);
            return spell ? spell.getFormID() : 0;
        }
        case 3 /* SpellType.Instant */: {
            var spell = actor.getEquippedSpell(3 /* SpellType.Instant */);
            return spell ? spell.getFormID() : 0;
        }
        default: {
            return 0;
        }
    }
};
var filterWorn = function (inv) {
    return { entries: inv.entries.filter(function (x) { return x.worn || x.wornLeft; }) };
};
var removeUnnecessaryExtra = function (inv, ignoreAmmo) {
    return {
        entries: inv.entries.map(function (x) {
            var r = JSON.parse(JSON.stringify(x));
            r.chargePercent = r.maxCharge;
            if (ignoreAmmo) {
                r.count = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(x.baseId)) ? r.count : 1;
            }
            else {
                r.count = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(x.baseId)) ? 1000 : 1;
            }
            delete r.name;
            return r;
        }),
    };
};
var getEquipment = function (ac, numChanges) {
    return {
        inv: (0,_inventory__WEBPACK_IMPORTED_MODULE_1__.getInventory)(ac),
        leftSpell: getEquipedSpell(ac, 0 /* SpellType.Left */),
        rightSpell: getEquipedSpell(ac, 1 /* SpellType.Right */),
        voiceSpell: getEquipedSpell(ac, 2 /* SpellType.Voice */),
        instantSpell: getEquipedSpell(ac, 3 /* SpellType.Instant */),
        numChanges: numChanges,
    };
};
var syncSpellEquipment = function (ac, spellBaseId, spellType) {
    if (spellBaseId !== undefined && spellBaseId > 0) {
        ac.equipSpell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Spell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(spellBaseId)), spellType);
    }
    else {
        var equipedSpell = ac.getEquippedSpell(spellType);
        if (equipedSpell) {
            ac.unequipSpell(equipedSpell, spellType);
        }
    }
};
var applyEquipment = function (ac, eq) {
    ac.removeAllItems(null, false, true);
    ac.unequipAll();
    ac.removeAllItems(null, false, true);
    var newInventory = removeUnnecessaryExtra(filterWorn(eq.inv), ac.getFormID() === 0x14);
    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setInventory)(ac.getFormID(), newInventory);
    syncSpellEquipment(ac, eq.leftSpell, 0 /* SpellType.Left */);
    syncSpellEquipment(ac, eq.rightSpell, 1 /* SpellType.Right */);
    syncSpellEquipment(ac, eq.voiceSpell, 2 /* SpellType.Voice */);
    syncSpellEquipment(ac, eq.instantSpell, 3 /* SpellType.Instant */);
    return true;
};
var isBadMenuShown = function () {
    return (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('InventoryMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('FavoritesMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('MagicMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('ContainerMenu') ||
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('Crafting Menu') // Actually I don't think it causes crashes
    );
};


/***/ }),

/***/ "./src/sync/inventory.ts":
/*!*******************************!*\
  !*** ./src/sync/inventory.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyInventory: () => (/* binding */ applyInventory),
/* harmony export */   getDiff: () => (/* binding */ getDiff),
/* harmony export */   getInventory: () => (/* binding */ getInventory),
/* harmony export */   hasExtras: () => (/* binding */ hasExtras),
/* harmony export */   removeSimpleItemsAsManyAsPossible: () => (/* binding */ removeSimpleItemsAsManyAsPossible),
/* harmony export */   sumInventories: () => (/* binding */ sumInventories)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

// 'loxsword (Legendary)' => 'loxsword'
var getRealName = function (s) {
    if (!s) {
        return s;
    }
    var arr = s.split(" ");
    if (arr.length && arr[arr.length - 1].match(/^\(.*\)$/)) {
        arr.pop();
    }
    return arr.join(" ");
};
// 'aaaaaaaaaaaaaaaa' => 'aaa...'
var cropName = function (s) {
    if (!s) {
        return s;
    }
    var max = 128;
    return s.length >= max
        ? s
            .split("")
            .filter(function (x, i) { return i < max; })
            .join("")
            .concat("...")
        : s;
};
var checkIfNameIsGeneratedByGame = function (aStr, bStr, formName) {
    if (!aStr.length && bStr.startsWith(formName)) {
        var bEnding = bStr.substr(formName.length);
        if (bEnding.match(/^\s\(.*\)$/)) {
            return true;
        }
    }
    return false;
};
var namesEqual = function (a, b) {
    var aStr = a.name || "";
    var bStr = b.name || "";
    if (cropName(getRealName(aStr)) === cropName(getRealName(bStr))) {
        return true;
    }
    if (a.baseId === b.baseId) {
        var form = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(a.baseId);
        if (form) {
            var formName = form.getName();
            if (checkIfNameIsGeneratedByGame(aStr, bStr, formName) ||
                checkIfNameIsGeneratedByGame(bStr, aStr, formName))
                return true;
        }
    }
    return false;
};
var extrasEqual = function (a, b, ignoreWorn) {
    if (ignoreWorn === void 0) { ignoreWorn = false; }
    return (a.health === b.health &&
        a.enchantmentId === b.enchantmentId &&
        a.maxCharge === b.maxCharge &&
        !!a.removeEnchantmentOnUnequip === !!b.removeEnchantmentOnUnequip &&
        a.chargePercent === b.chargePercent &&
        //namesEqual(a, b) &&
        a.soul === b.soul &&
        a.poisonId === b.poisonId &&
        a.poisonCount === b.poisonCount &&
        ((!!a.worn === !!b.worn && !!a.wornLeft === !!b.wornLeft) || ignoreWorn));
};
var hasExtras = function (e) {
    return !extrasEqual(e, { baseId: 0, count: 0 });
};
var extractExtraData = function (refr, extraList, out) {
    // I see that ExtraWorn is not emitted for 0xFF actors when arrows are equipped. Fixing
    var item = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(out.baseId);
    if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(item)) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (actor && actor.isEquipped(item)) {
            out.worn = true;
        }
    }
    (extraList || []).forEach(function (extra) {
        switch (extra.type) {
            case "Health":
                out.health = Math.round(extra.health * 10) / 10;
                // TESModPlatform::AddItemEx makes all items at least 1.01 health
                if (out.health === 1) {
                    delete out.health;
                }
                break;
            case "Count":
                out.count = extra.count;
                break;
            case "Enchantment":
                out.enchantmentId = extra.enchantmentId;
                out.maxCharge = extra.maxCharge;
                out.removeEnchantmentOnUnequip = extra.removeOnUnequip;
                break;
            case "Charge":
                out.chargePercent = extra.charge;
                break;
            case "Poison":
                out.poisonId = extra.poisonId;
                out.poisonCount = extra.count;
                break;
            case "Soul":
                out.soul = extra.soul;
                break;
            case "TextDisplayData":
                out.name = extra.name;
                break;
            case "Worn":
                out.worn = true;
                break;
            case "WornLeft":
                out.wornLeft = true;
                break;
        }
    });
};
var squash = function (inv) {
    var res = new Array();
    inv.entries.forEach(function (e) {
        var same = res.find(function (x) { return e.baseId === x.baseId && extrasEqual(x, e); });
        if (same) {
            same.count += e.count;
        }
        else {
            res.push(JSON.parse(JSON.stringify(e)));
        }
    });
    return { entries: res.filter(function (x) { return x.count !== 0; }) };
};
var getExtraContainerChangesAsInventory = function (refr) {
    var extraContainerChanges = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getExtraContainerChanges)(refr.getFormID());
    var entries = new Array();
    (extraContainerChanges || []).forEach(function (changesEntry) {
        var entry = {
            baseId: changesEntry.baseId,
            count: changesEntry.countDelta,
        };
        (changesEntry.extendDataList || []).forEach(function (extraList) {
            var e = {
                baseId: entry.baseId,
                count: 1,
            };
            extractExtraData(refr, extraList, e);
            entries.push(e);
            entry.count -= e.count;
        });
        if (entry.count !== 0) {
            entries.push(entry);
        }
    });
    var res = { entries: entries };
    res = squash(res);
    return res;
};
var getBaseContainerAsInventory = function (refr) {
    return {
        entries: (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getContainer)(refr.getBaseObject().getFormID()),
    };
};
var sumInventories = function (lhs, rhs) {
    var leftEntriesWithExtras = lhs.entries.filter(function (e) { return hasExtras(e); });
    var rightEntriesWithExtras = rhs.entries.filter(function (e) { return hasExtras(e); });
    var leftEntriesSimple = lhs.entries.filter(function (e) { return !hasExtras(e); });
    var rightEntriesSimple = rhs.entries.filter(function (e) { return !hasExtras(e); });
    leftEntriesSimple.forEach(function (e) {
        var matching = rightEntriesSimple.find(function (x) { return x.baseId === e.baseId; });
        if (matching) {
            e.count += matching.count;
            matching.count = 0;
        }
    });
    return {
        entries: leftEntriesWithExtras
            .concat(rightEntriesWithExtras)
            .concat(leftEntriesSimple)
            .concat(rightEntriesSimple)
            .filter(function (e) { return e.count !== 0; }),
    };
};
var removeSimpleItemsAsManyAsPossible = function (inv, baseId, count) {
    var res = { entries: [] };
    res.entries = JSON.parse(JSON.stringify(inv.entries));
    var entry = res.entries.find(function (e) { return !hasExtras(e) && e.baseId === baseId; });
    if (entry) {
        entry.count -= count;
    }
    res.entries = res.entries.filter(function (e) { return e.count > 0; });
    return res;
};
var getDiff = function (lhs, rhs, ignoreWorn) {
    var lhsCopy = JSON.parse(JSON.stringify(lhs));
    var rhsCopy = JSON.parse(JSON.stringify(rhs));
    rhsCopy.entries.forEach(function (e) {
        var sameFromLeft = lhsCopy.entries.find(function (x) { return x.baseId === e.baseId && extrasEqual(x, e, ignoreWorn); });
        if (sameFromLeft) {
            sameFromLeft.count -= e.count;
        }
        else {
            lhsCopy.entries.push(e);
            lhsCopy.entries[lhsCopy.entries.length - 1].count *= -1;
        }
    });
    return { entries: lhsCopy.entries.filter(function (x) { return x.count !== 0; }) };
};
var getInventory = function (refr) {
    return squash(sumInventories(getBaseContainerAsInventory(refr), getExtraContainerChangesAsInventory(refr)));
};
var basesReset = function () {
    if (skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesResetExists"] !== true) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesResetExists"] = true;
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesReset"] = new Set();
    }
    return skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["basesReset"];
};
var resetBase = function (refr) {
    var base = refr.getBaseObject();
    var baseId = base ? base.getFormID() : 0;
    if (!basesReset().has(baseId)) {
        basesReset().add(baseId);
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.resetContainer(base);
        refr.removeAllItems(null, false, true);
    }
};
var applyInventory = function (refr, newInventory, enableCrashProtection, ignoreWorn) {
    if (ignoreWorn === void 0) { ignoreWorn = false; }
    resetBase(refr);
    var diff = getDiff(newInventory, getInventory(refr), ignoreWorn).entries;
    var res = true;
    diff.sort(function (a, b) { return (a.count < b.count ? -1 : 1); });
    diff.forEach(function (e, i) {
        if (i > 0 && enableCrashProtection) {
            res = false;
            return;
        }
        var absCount = Math.abs(e.count);
        var queueNiNodeUpdateNeeded = false;
        var worn = !!e.worn;
        var wornLeft = !!e.wornLeft;
        var oneStepCount = e.count / absCount;
        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.baseId);
        if (!f) {
            return (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Bad form ID ".concat(e.baseId.toString(16)));
        }
        var type = f.getType();
        // For misc items, potions and ingredients we don't want to split them into multiple items
        // This was made to fix a performance issue with users having 10000+ of misc items (i.e. gold)
        if (type === 32 /* FormType.Misc */ ||
            type === 46 /* FormType.Potion */ ||
            type === 30 /* FormType.Ingredient */) {
            absCount = 1;
            oneStepCount = e.count;
        }
        else {
            if (absCount > 1000) {
                absCount = 1;
                oneStepCount = 1;
                // Also for arrows with strange count
                if (worn && e.count < 0) {
                    absCount = 0;
                }
            }
            if (e.count > 1 && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ammo.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.baseId))) {
                absCount = 1;
                oneStepCount = e.count;
                if (e.count > 60000) {
                    // Why would actor have 60k arrows?
                    e.count = 1;
                }
            }
        }
        for (var i_1 = 0; i_1 < absCount; ++i_1) {
            if (worn || wornLeft) {
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.pushWornState(!!worn, !!wornLeft);
                queueNiNodeUpdateNeeded = true;
            }
            var addItemExArgs = void 0;
            addItemExArgs = [
                refr,
                f,
                oneStepCount,
                e.health ? e.health : 1,
                e.enchantmentId
                    ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Enchantment.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.enchantmentId))
                    : null,
                e.maxCharge ? e.maxCharge : 0,
                !!e.removeEnchantmentOnUnequip,
                e.chargePercent ? e.chargePercent : 0,
                e.name ? cropName(e.name) : f.getName(),
                e.soul ? e.soul : 0,
                e.poisonId ? skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Potion.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(e.poisonId)) : null,
                e.poisonCount ? e.poisonCount : 0
            ];
            var argsToPrint = addItemExArgs.map(function (arg) {
                if (arg instanceof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference) {
                    return "ObjectReference(".concat(arg.getFormID().toString(16), ")");
                }
                else if (arg instanceof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Form) {
                    return "Form(".concat(arg.getFormID().toString(16), ")");
                }
                else {
                    return JSON.stringify(arg);
                }
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("TESModPlatform.addItemEx(".concat(argsToPrint.join(", "), ")"));
            skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.addItemEx.apply(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform, addItemExArgs);
        }
        if (queueNiNodeUpdateNeeded) {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (ac) {
                ac.queueNiNodeUpdate();
            }
        }
    });
    return res;
};


/***/ }),

/***/ "./src/sync/movementApply.ts":
/*!***********************************!*\
  !*** ./src/sync/movementApply.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   applyMovement: () => (/* binding */ applyMovement),
/* harmony export */   applyWeapDrawn: () => (/* binding */ applyWeapDrawn)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");




var sqr = function (x) { return x * x; };
var applyMovement = function (refr, m, isMyClone) {
    if (teleportIfNeed(refr, m)) {
        return;
    }
    // Z axis isn't useful here
    var acX = refr.getPositionX();
    var acY = refr.getPositionY();
    var lagUnitsNoZ = Math.round(Math.sqrt(sqr(m.pos[0] - acX) + sqr(m.pos[1] - acY)));
    if (isMyClone === true) {
        _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__.SpApiInteractor.getControllerInstance().emitter.emit("newLocalLagValueCalculated", { lagUnitsNoZ: lagUnitsNoZ });
    }
    translateTo(refr, m);
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    if (!ac) {
        return;
    }
    var lookAt = null;
    if (m.lookAt) {
        try {
            lookAt = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.findClosestActor(m.lookAt[0], m.lookAt[1], m.lookAt[2], 128);
        }
        catch (e) {
            lookAt = null;
        }
    }
    if (lookAt) {
        ac.setHeadTracking(true);
        ac.setLookAt(lookAt, false);
    }
    else {
        ac.setHeadTracking(false);
    }
    // ac.stopCombat();
    ac.blockActivation(true);
    keepOffsetFromActor(ac, m);
    applySprinting(ac, m.runMode === "Sprinting");
    applyBlocking(ac, m);
    applySneaking(ac, m.isSneaking);
    applyWeapDrawn(ac, m.isWeapDrawn);
    applyHealthPercentage(ac, m.healthPercentage);
    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_3__.SpApiInteractor.getControllerInstance().emitter.emit("applyDeathStateEvent", { actor: ac, isDead: m.isDead });
};
var keepOffsetFromActor = function (ac, m) {
    var offsetAngle = m.rot[2] - ac.getAngleZ();
    if (Math.abs(offsetAngle) < 5) {
        offsetAngle = 0;
    }
    if (m.runMode === "Standing") {
        return ac.keepOffsetFromActor(ac, 0, 0, 0, 0, 0, offsetAngle, 1, 1);
    }
    var offset = [
        3 * Math.sin((m.direction / 180) * Math.PI),
        3 * Math.cos((m.direction / 180) * Math.PI),
        getOffsetZ(m.runMode),
    ];
    ac.keepOffsetFromActor(ac, offset[0], offset[1], offset[2], 0, 0, offsetAngle, m.runMode === "Walking" ? 2048 : 1, 1);
};
var getOffsetZ = function (runMode) {
    switch (runMode) {
        case "Walking":
            return -512;
        case "Running":
            return -1024;
    }
    return 0;
};
var applySprinting = function (ac, isSprinting) {
    if (ac.isSprinting() != isSprinting) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, isSprinting ? "SprintStart" : "SprintStop");
    }
};
var applyBlocking = function (ac, m) {
    if (ac.getAnimationVariableBool("IsBlocking") != m.isBlocking) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, m.isBlocking ? "BlockStart" : "BlockStop");
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, m.isSneaking ? "SneakStart" : "SneakStop");
    }
};
var applySneaking = function (ac, isSneaking) {
    var currentIsSneaking = ac.isSneaking() || ac.getAnimationVariableBool("IsSneaking");
    if (currentIsSneaking != isSneaking) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.sendAnimationEvent(ac, isSneaking ? "SneakStart" : "SneakStop");
    }
};
var applyWeapDrawn = function (ac, isWeapDrawn) {
    if (ac.isWeaponDrawn() !== isWeapDrawn) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, isWeapDrawn ? 1 : 0);
    }
};
var applyHealthPercentage = function (ac, healthPercentage) {
    var currentPercentage = ac.getActorValuePercentage('health');
    if (currentPercentage === healthPercentage) {
        return;
    }
    var currentMax = ac.getBaseActorValue('health');
    var deltaPercentage = healthPercentage - currentPercentage;
    var k = 0.25;
    if (deltaPercentage > 0) {
        ac.restoreActorValue('health', deltaPercentage * currentMax * k);
    }
    else if (deltaPercentage < 0) {
        ac.damageActorValue('health', deltaPercentage * currentMax * k);
    }
};
// Use global temp var to avoid allocation of an array on each translateTo
var gTempTargetPos = [0, 0, 0];
var translateTo = function (refr, m) {
    var _a;
    var time = 0.2;
    if (m.isInJumpState || m.runMode !== "Standing") {
        time = 0.2;
    }
    // Local lag compensation
    // TODO: Remove "|| 0" hack (added to support old MpClientPlugin)
    var distanceAdd = (m.speed || 0) * time;
    var direction = m.rot[2] + m.direction;
    gTempTargetPos[0] = m.pos[0];
    gTempTargetPos[1] = m.pos[1];
    gTempTargetPos[2] = m.pos[2];
    // We do not want to add pos in case of standing-jumping
    if (m.runMode !== "Standing") {
        gTempTargetPos[0] += Math.sin(direction / 180 * Math.PI) * distanceAdd;
        gTempTargetPos[1] += Math.cos(direction / 180 * Math.PI) * distanceAdd;
    }
    var refrRealPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(refr);
    var distance = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(refrRealPos, gTempTargetPos);
    var speed = distance / time;
    var angleDiff = Math.abs(m.rot[2] - refr.getAngleZ());
    if (m.runMode !== "Standing" ||
        m.isInJumpState ||
        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistanceNoZ(refrRealPos, gTempTargetPos) > 8 ||
        angleDiff > 80 ||
        ((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) === null || _a === void 0 ? void 0 : _a.getSitState()) === 3) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (actor && actor.getActorValue("Variable10") < -999) {
            return;
        }
        if (!actor || !actor.isDead()) {
            refr.translateTo(gTempTargetPos[0], gTempTargetPos[1], gTempTargetPos[2], m.rot[0], m.rot[1], m.rot[2], speed, 0);
        }
    }
};
var teleportIfNeed = function (refr, m) {
    if (isInDifferentWorldOrCell(refr, m.worldOrCell) ||
        (!refr.is3DLoaded() && isInDifferentExteriorCell(refr, m.pos))) {
        throw new _lib_errors__WEBPACK_IMPORTED_MODULE_1__.RespawnNeededError("needs to be respawned");
    }
    return false;
};
var cellWidth = 4096;
var isInDifferentExteriorCell = function (refr, pos) {
    var currentPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(refr);
    var playerPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getPos(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
    var targetDistanceToPlayer = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(playerPos, pos);
    var currentDistanceToPlayer = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getDistance(playerPos, currentPos);
    return currentDistanceToPlayer > cellWidth && targetDistanceToPlayer <= cellWidth;
};
var isInDifferentWorldOrCell = function (refr, worldOrCell) {
    return worldOrCell !== _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.getWorldOrCell(refr);
};


/***/ }),

/***/ "./src/sync/movementGet.ts":
/*!*********************************!*\
  !*** ./src/sync/movementGet.ts ***!
  \*********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getMovement: () => (/* binding */ getMovement)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");


var PlayerCharacterSpeedCalculator = /** @class */ (function () {
    function PlayerCharacterSpeedCalculator() {
    }
    PlayerCharacterSpeedCalculator.savePosition = function (pos, worldOrCell) {
        this.lastPcPos = pos;
        this.lastPcPosCheck = Date.now();
        this.lastPcWorldOrCell = worldOrCell;
    };
    PlayerCharacterSpeedCalculator.getSpeed = function (currentPos, worldOrCell) {
        if (this.lastPcPosCheck === -1) {
            return 0;
        }
        var timeDeltaSec = (Date.now() - this.lastPcPosCheck) / 1000;
        if (timeDeltaSec > 5)
            return 0; // Too inaccurate
        if (timeDeltaSec === 0)
            return 0; // Division by zero
        if (worldOrCell !== this.lastPcWorldOrCell) {
            return 0;
        }
        var distance = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getDistance(currentPos, this.lastPcPos);
        return distance / timeDeltaSec;
    };
    PlayerCharacterSpeedCalculator.lastPcPos = [0, 0, 0];
    PlayerCharacterSpeedCalculator.lastPcPosCheck = -1;
    PlayerCharacterSpeedCalculator.lastPcWorldOrCell = 0;
    return PlayerCharacterSpeedCalculator;
}());
var getMovement = function (refr, form) {
    var _a;
    var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
    // It is running for ObjectReferences because Standing
    // Doesn't lead to translateTo call
    var runMode = ac ? getRunMode(ac) : "Running";
    var healthPercentage = ac && ac.getActorValuePercentage("health");
    if (ac && ac.isDead()) {
        healthPercentage = 0;
    }
    var lookAt = undefined;
    if (refr.getFormID() !== 0x14) {
        var combatTarget = ac === null || ac === void 0 ? void 0 : ac.getCombatTarget();
        if (combatTarget) {
            lookAt = [
                combatTarget.getPositionX(),
                combatTarget.getPositionY(),
                combatTarget.getPositionZ(),
            ];
        }
    }
    var pos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getPos(refr);
    var speed;
    if (refr.getFormID() !== 0x14) {
        speed = refr.getAnimationVariableFloat("SpeedSampled");
    }
    else {
        // Real players often run into the wall.
        // We need to have zero speed in this case. SpeedSampled doesn't help
        var w = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(refr);
        speed = PlayerCharacterSpeedCalculator.getSpeed(pos, w);
        PlayerCharacterSpeedCalculator.savePosition(pos, w);
        // It's unrealistic speed. It still may happen due to teleports
        if (speed > 2000) {
            speed = 0;
        }
    }
    var worldOrCell = refr.getWorldSpace() || refr.getParentCell();
    return {
        worldOrCell: (worldOrCell === null || worldOrCell === void 0 ? void 0 : worldOrCell.getFormID()) || 0,
        pos: pos,
        rot: [refr.getAngleX(), refr.getAngleY(), refr.getAngleZ()],
        runMode: runMode,
        direction: runMode !== "Standing"
            ? 360 * refr.getAnimationVariableFloat("Direction")
            : 0,
        isInJumpState: !!(ac && ac.getAnimationVariableBool("bInJumpState")),
        isSneaking: !!(ac && isSneaking(ac)),
        isBlocking: !!(ac && ac.getAnimationVariableBool("IsBlocking")),
        isWeapDrawn: !!(ac && ac.isWeaponDrawn()),
        isDead: ((_a = form === null || form === void 0 ? void 0 : form.isDead) !== null && _a !== void 0 ? _a : false) || !!(ac && ac.isDead()),
        healthPercentage: healthPercentage || 0,
        lookAt: lookAt,
        speed: speed
    };
};
var isSneaking = function (ac) {
    return ac.isSneaking() || ac.getAnimationVariableBool("IsSneaking");
};
var getRunMode = function (ac) {
    if (ac.isSprinting()) {
        return "Sprinting";
    }
    var speed = ac.getAnimationVariableFloat("SpeedSampled");
    if (!speed) {
        return "Standing";
    }
    var furniture = ac.getFurnitureReference();
    if (furniture !== null)
        return "Standing"; // TODO: Sitting?
    var isRunning = true;
    if (ac.getFormID() == 0x14) {
        if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.isPlayerRunningEnabled() || speed < 150)
            isRunning = false;
    }
    else {
        if (!ac.isRunning() || speed < 150) {
            isRunning = false;
        }
    }
    if (ac.getAnimationVariableFloat("IsBlocking")) {
        isRunning = isSneaking(ac);
    }
    var carryWeight = ac.getActorValue("CarryWeight");
    var totalItemWeight = ac.getTotalItemWeight();
    if (carryWeight < totalItemWeight) {
        isRunning = false;
    }
    return isRunning ? "Running" : "Walking";
};


/***/ }),

/***/ "./src/sync/spell.ts":
/*!***************************!*\
  !*** ./src/sync/spell.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   learnSpells: () => (/* binding */ learnSpells),
/* harmony export */   removeAllSpells: () => (/* binding */ removeAllSpells)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var removeAllSpells = function (actor) {
    var spellToRemove = new Array();
    for (var i = 0; i < actor.getSpellCount(); i++) {
        var spell = actor.getNthSpell(i);
        if (spell) {
            spellToRemove.push(spell);
        }
    }
    for (var _i = 0, spellToRemove_1 = spellToRemove; _i < spellToRemove_1.length; _i++) {
        var spell = spellToRemove_1[_i];
        var removeResult = actor.removeSpell(spell);
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("removeResult: ".concat(removeResult, ", spellIdToRemove: ").concat(spell
            .getFormID()
            .toString(16), ", spellName: ").concat(spell.getName()));
    }
};
var learnSpells = function (actor, spellsIds) {
    for (var _i = 0, spellsIds_1 = spellsIds; _i < spellsIds_1.length; _i++) {
        var spellId = spellsIds_1[_i];
        var spell = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Spell.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(spellId));
        if (spell) {
            var addResult = actor.addSpell(spell, false);
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("addResult: ".concat(addResult, ", spellIdToLearn: ").concat(spell
                .getFormID()
                .toString(16), ", spellName: ").concat(spell.getName()));
        }
    }
};


/***/ }),

/***/ "./src/version.ts":
/*!************************!*\
  !*** ./src/version.ts ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   requiredVersion: () => (/* binding */ requiredVersion),
/* harmony export */   verifyVersion: () => (/* binding */ verifyVersion)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

var requiredVersion = '2.9.0';
var realVersion = typeof skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getPlatformVersion === 'function' ? (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.getPlatformVersion)() : 'unknown';
// TODO: no one actually calls this function. make a service
var verifyVersion = function () {
    if (!requiredVersion.includes(realVersion)) {
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Debug.messageBox("You need to have on of those SkyrimPlatform versions ".concat(JSON.stringify(requiredVersion), " to join this server. Your current version is ").concat(realVersion));
        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.waitMenuMode(0.5).then(function () {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.on)('update', function () {
                if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Ui.isMenuOpen('MessageBoxMenu')) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.quitToMainMenu();
                }
            });
        });
    }
};


/***/ }),

/***/ "./src/view/formView.ts":
/*!******************************!*\
  !*** ./src/view/formView.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormView: () => (/* binding */ FormView),
/* harmony export */   getScreenResolution: () => (/* binding */ getScreenResolution)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_animation__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/animation */ "./src/sync/animation.ts");
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _sync_equipment__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../sync/equipment */ "./src/sync/equipment.ts");
/* harmony import */ var _lib_errors__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../lib/errors */ "./src/lib/errors.ts");
/* harmony import */ var _sync_movementApply__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../sync/movementApply */ "./src/sync/movementApply.ts");
/* harmony import */ var _spawnProcess__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./spawnProcess */ "./src/view/spawnProcess.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");
/* harmony import */ var _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./playerCharacterDataHolder */ "./src/view/playerCharacterDataHolder.ts");
/* harmony import */ var _sync_movementGet__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../sync/movementGet */ "./src/sync/movementGet.ts");
/* harmony import */ var _hostAttempts__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./hostAttempts */ "./src/view/hostAttempts.ts");
/* harmony import */ var _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./modelApplyUtils */ "./src/view/modelApplyUtils.ts");
/* harmony import */ var _worldViewMisc__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./worldViewMisc */ "./src/view/worldViewMisc.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ../services/services/worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");
















var _screenResolution;
var getScreenResolution = function () {
    if (!_screenResolution) {
        _screenResolution = {
            width: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.getINIInt("iSize W:Display"),
            height: skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.getINIInt("iSize H:Display"),
        };
    }
    return _screenResolution;
};
var FormView = /** @class */ (function () {
    function FormView(remoteRefrId) {
        this.remoteRefrId = remoteRefrId;
        this.lastHarvestedApply = 0;
        this.lastOpenApply = 0;
        this.isSetNodeTextureSetApplied = false;
        this.isSetNodeScaleApplied = false;
        this.refrId = 0;
        this.ready = false;
        this.animState = this.getDefaultAnimState();
        this.movState = {
            lastNumChanges: 0,
            lastApply: 0,
            lastRehost: 0,
            everApplied: false,
        };
        this.appearanceState = this.getDefaultAppearanceState();
        this.eqState = this.getDefaultEquipState();
        this.appearanceBasedBaseId = 0;
        this.leveledBaseId = 0;
        this.isOnScreen = false;
        this.lastPcWorldOrCell = 0;
        this.lastWorldOrCell = 0;
        this.spawnMoment = 0;
        this.wasHostedByOther = undefined;
        this.state = {};
        this.localImmortal = false;
        this.textNameId = undefined;
        this.voiceIndicatorId = undefined;
    }
    FormView.prototype.update = function (model) {
        var _this = this;
        var _a, _b, _c, _d, _e, _f, _g, _h;
        // Other players mutate into PC clones when moving to another location
        if (model.movement) {
            if (!this.lastWorldOrCell)
                this.lastWorldOrCell = model.movement.worldOrCell;
            if (this.lastWorldOrCell !== model.movement.worldOrCell) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("[1] worldOrCell changed, destroying FormView ".concat(this.lastWorldOrCell.toString(16), " => ").concat(model.movement.worldOrCell.toString(16)));
                this.lastWorldOrCell = model.movement.worldOrCell;
                this.destroy();
                this.refrId = 0;
                this.appearanceBasedBaseId = 0;
                return;
            }
        }
        // Don't spawn dead actors if not already
        if (model.isDead) {
            if (this.refrId === 0) {
                return;
            }
        }
        // Players with different worldOrCell should be invisible
        if (model.movement) {
            var worldOrCell = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.getWorldOrCell(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
            if (worldOrCell !== 0 &&
                model.movement.worldOrCell !== worldOrCell) {
                this.destroy();
                this.refrId = 0;
                return;
            }
        }
        // Apply appearance before base form selection to prevent double-spawn
        if (model.appearance || (!model.appearance && this.appearanceState.appearance)) {
            if (!this.appearanceState.appearance ||
                model.numAppearanceChanges !== this.appearanceState.lastNumChanges) {
                // Both non-null
                if (model.appearance && this.appearanceState.appearance) {
                    var modelAppearanceCopy = JSON.parse(JSON.stringify(model.appearance));
                    var stateAppearanceCopy = JSON.parse(JSON.stringify(this.appearanceState.appearance));
                    modelAppearanceCopy.name = "";
                    stateAppearanceCopy.name = "";
                    var equalWithoutNames = JSON.stringify(modelAppearanceCopy) === JSON.stringify(stateAppearanceCopy);
                    if (equalWithoutNames) {
                        // Change name inplace
                        var refr_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
                        (_a = refr_1 === null || refr_1 === void 0 ? void 0 : refr_1.getBaseObject()) === null || _a === void 0 ? void 0 : _a.setName(model.appearance.name);
                        refr_1 === null || refr_1 === void 0 ? void 0 : refr_1.setDisplayName(model.appearance.name, true);
                        //printConsole("Appearance updated, changing name inplace");
                    }
                    else {
                        // Force re-apply appearance on the next getAppearanceBasedBase call
                        this.appearanceBasedBaseId = 0;
                        //printConsole("Appearance updated");
                    }
                }
                else {
                    // Force re-apply appearance on the next getAppearanceBasedBase call
                    this.appearanceBasedBaseId = 0;
                    //printConsole("Appearance updated");
                }
                this.appearanceState.appearance = model.appearance || null;
                this.appearanceState.lastNumChanges = model.numAppearanceChanges;
            }
        }
        var refId = model.refrId && model.refrId < 0xff000000 ? model.refrId : undefined;
        if (refId) {
            if (this.refrId !== refId) {
                this.destroy();
                this.refrId = model.refrId;
                this.ready = true;
                var refr_2 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
                if (refr_2) {
                    var base = refr_2.getBaseObject();
                    if (base) {
                        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.dealWithRef(refr_2, base);
                    }
                }
            }
        }
        else {
            var templateChain = model.templateChain;
            // There is no place for random/leveling in 1-sized chain
            // Just spawn an NPC, do not generate a temporary TESNPC form
            if ((templateChain === null || templateChain === void 0 ? void 0 : templateChain.length) === 1) {
                templateChain = undefined;
            }
            // TODO: getLeveledBase crashes too often ATM
            var base = null; //Game.getFormEx(this.getLeveledBase(templateChain));
            if (base === null) {
                base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(model.baseId || NaN);
            }
            if (base === null) {
                base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.getAppearanceBasedBase());
            }
            if (base === null) {
                return;
            }
            var refr_3 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
            var respawnRequired = false;
            if (!refr_3) {
                respawnRequired = true;
            }
            else if (!refr_3.getBaseObject()) {
                respawnRequired = true;
            }
            else if (refr_3.getBaseObject().getFormID() !== base.getFormID()) {
                respawnRequired = true;
            }
            if (respawnRequired) {
                this.destroy();
                var player_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
                var spawnMethodOriginal = {
                    spawn: function (baseForm, _spawnPosition, _spawnRotation) {
                        return player_1.placeAtMe(baseForm, 1, true, true);
                    },
                    triggerSpawnProcess: function (spawningRefr, spawnPosition, appearance, callback) {
                        new _spawnProcess__WEBPACK_IMPORTED_MODULE_6__.SpawnProcess(appearance, spawnPosition, spawningRefr.getFormID(), callback);
                    }
                };
                var spawnMethodStub = {
                    spawn: function (baseForm, spawnPosition, spawnRotation) {
                        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc1"];
                        var ref = f(baseForm, spawnPosition, spawnRotation);
                        return ref;
                    },
                    triggerSpawnProcess: function (spawningRefr, spawnPosition, appearance, callback) {
                        var f = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc2"];
                        f(spawningRefr, spawnPosition, appearance, callback);
                    }
                };
                var spawnUsingStubMethod = base.getType() === 43 /* FormType.NPC */
                    && !this.appearanceState.appearance
                    && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc1Set"] === true
                    && skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["formViewFunc2Set"] === true;
                var spawnMethod = spawnUsingStubMethod ? spawnMethodStub : spawnMethodOriginal;
                if (model.movement) {
                    refr_3 = spawnMethod.spawn(base, model.movement.pos, model.movement.rot);
                }
                else {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("model.movement was " + model.movement);
                }
                this.state = {};
                delete this.wasHostedByOther;
                if (base.getType() !== 43 /* FormType.NPC */) {
                    refr_3 === null || refr_3 === void 0 ? void 0 : refr_3.setAngle(((_b = model.movement) === null || _b === void 0 ? void 0 : _b.rot[0]) || 0, ((_c = model.movement) === null || _c === void 0 ? void 0 : _c.rot[1]) || 0, ((_d = model.movement) === null || _d === void 0 ? void 0 : _d.rot[2]) || 0);
                }
                else {
                    var race = (_f = (_e = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _e === void 0 ? void 0 : _e.getRace()) === null || _f === void 0 ? void 0 : _f.getFormID();
                    var draugrRace = 0xd53;
                    var falmerRace = 0x131f4;
                    var chaurusRace = 0x131eb;
                    var frostbiteSpiderRaceGiant = 0x4e507;
                    var frostbiteSpiderRaceLarge = 0x53477;
                    var dwarvenCenturionRace = 0x131f1;
                    var dwarvenSphereRace = 0x131f2;
                    var dwarvenSpiderRace = 0x131f3;
                    var sprigganRace = 0x2013b77;
                    var sprigganRace2 = 0xf3903;
                    var sprigganRace3 = 0x13204;
                    var sprigganRace4 = 0x401b644;
                    var sprigganRace5 = 0x9aa44;
                    var wolfRace = 0x1320a;
                    // potential masterambushscript
                    if (race === draugrRace
                        || race === falmerRace
                        || race === chaurusRace
                        || race === frostbiteSpiderRaceGiant
                        || race === frostbiteSpiderRaceLarge
                        || race === dwarvenCenturionRace
                        || race === dwarvenSphereRace
                        || race === dwarvenSpiderRace
                        || race === sprigganRace
                        || race === sprigganRace2
                        || race === sprigganRace3
                        || race === sprigganRace4
                        || race === sprigganRace5
                        || race === wolfRace) {
                        (_g = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _g === void 0 ? void 0 : _g.setActorValue("Aggression", 2);
                    }
                }
                if (refr_3 !== null) {
                    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__.WorldCleanerService).modWcProtection(refr_3.getFormID(), 1);
                }
                // TODO: reset all states?
                this.eqState = this.getDefaultEquipState();
                this.animState = this.getDefaultAnimState();
                this.ready = false;
                var spawnPos = void 0;
                if (model.movement) {
                    spawnPos = model.movement.pos;
                    // printConsole("Spawn NPC at movement.pos");
                }
                else {
                    spawnPos = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_7__.ObjectReferenceEx.getPos(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer());
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Spawn NPC at player pos");
                }
                if (refr_3) {
                    spawnMethod.triggerSpawnProcess(refr_3, spawnPos, model.appearance || null, function () {
                        _this.ready = true;
                        _this.spawnMoment = Date.now();
                    });
                }
                else {
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Unable to triggerSpawnProcess for null refr");
                }
                if (model.appearance && model.appearance.name) {
                    refr_3 === null || refr_3 === void 0 ? void 0 : refr_3.setDisplayName("" + model.appearance.name, true);
                }
                (_h = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr_3)) === null || _h === void 0 ? void 0 : _h.setActorValue("attackDamageMult", 0);
            }
            this.refrId = refr_3.getFormID();
        }
        if (!this.ready) {
            return;
        }
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.refrId));
        if (refr) {
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor && !this.localImmortal) {
                actor.startDeferredKill();
                actor.setActorValue("health", 1000000);
                actor.setActorValue("magicka", 1000000);
                this.localImmortal = true;
            }
            this.applyAll(refr, model);
            var gamemodeUpdateService = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_15__.GamemodeUpdateService);
            gamemodeUpdateService.updateNeighbor(refr, model, this.state);
        }
    };
    FormView.prototype.destroy = function () {
        this.isOnScreen = false;
        this.spawnMoment = 0;
        var refrId = this.refrId;
        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
            if (refrId >= 0xff000000) {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
                if (refr) {
                    refr.delete();
                }
                _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_14__.WorldCleanerService).modWcProtection(refrId, -1);
                var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
                if (ac) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, -1);
                }
            }
        });
        this.localImmortal = false;
        this.removeNickname();
    };
    FormView.prototype.applyAll = function (refr, model) {
        var _a, _b, _c;
        var forcedWeapDrawn = null;
        if (_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getCrosshairRefId() === this.refrId) {
            this.lastHarvestedApply = 0;
            this.lastOpenApply = 0;
        }
        var now = Date.now();
        if (now - this.lastHarvestedApply > 666) {
            this.lastHarvestedApply = now;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelIsHarvested(refr, !!model.isHarvested);
        }
        if (now - this.lastOpenApply > 133) {
            this.lastOpenApply = now;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelIsOpen(refr, !!model.isOpen);
        }
        if (!this.isSetNodeScaleApplied) {
            this.isSetNodeScaleApplied = true;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelNodeScale(refr, model.setNodeScale);
        }
        if (!this.isSetNodeTextureSetApplied) {
            this.isSetNodeTextureSetApplied = true;
            _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelNodeTextureSet(refr, model.setNodeTextureSet);
        }
        if (model.inventory &&
            _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getCrosshairRefId() == this.refrId &&
            !(0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.isBadMenuShown)()) {
            // Do not let actors breaking their equipment via inventory apply
            // However, actually, actors do not have inventory in their models
            // Except your clone.
            if (!skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) {
                _modelApplyUtils__WEBPACK_IMPORTED_MODULE_11__.ModelApplyUtils.applyModelInventory(refr, model.inventory);
                model.inventory = undefined;
            }
        }
        if (model.animation) {
            if (model.animation.animEventName === "SkympFakeUnequip") {
                forcedWeapDrawn = false;
            }
            else if (model.animation.animEventName === "SkympFakeEquip") {
                forcedWeapDrawn = true;
            }
        }
        // TODO: make host service
        var hosted = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
        var alreadyHosted = false;
        if (Array.isArray(hosted)) {
            var remoteId = (0,_worldViewMisc__WEBPACK_IMPORTED_MODULE_12__.localIdToRemoteId)(this.refrId);
            if (hosted.includes(remoteId) || hosted.includes(remoteId + 0x100000000)) {
                alreadyHosted = true;
            }
        }
        (0,_sync_animation__WEBPACK_IMPORTED_MODULE_1__.setDefaultAnimsDisabled)(this.refrId, alreadyHosted ? false : true);
        if (alreadyHosted) {
            (_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr)) === null || _a === void 0 ? void 0 : _a.clearKeepOffsetFromActor();
        }
        if (model.movement) {
            var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (this.movState.lastApply &&
                Date.now() - this.movState.lastApply > 1500) {
                if (Date.now() - this.movState.lastRehost > 1000) {
                    this.movState.lastRehost = Date.now();
                    var remoteId = this.remoteRefrId;
                    if (ac && ac.is3DLoaded()) {
                        this.tryHostIfNeed(ac, remoteId);
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("tryHostIfNeed - reason: not seeing movement for long time");
                    }
                }
            }
            if (+model.numMovementChanges !==
                this.movState.lastNumChanges ||
                Date.now() - this.movState.lastApply > 2000) {
                this.movState.lastApply = Date.now();
                if (model.isHostedByOther || !this.movState.everApplied) {
                    var backup = model.movement.isWeapDrawn;
                    if (forcedWeapDrawn === true || forcedWeapDrawn === false) {
                        model.movement.isWeapDrawn = forcedWeapDrawn;
                    }
                    try {
                        (0,_sync_movementApply__WEBPACK_IMPORTED_MODULE_5__.applyMovement)(refr, model.movement, !!model.isMyClone);
                    }
                    catch (e) {
                        if (e instanceof _lib_errors__WEBPACK_IMPORTED_MODULE_4__.RespawnNeededError) {
                            this.lastWorldOrCell = model.movement.worldOrCell;
                            this.destroy();
                            this.refrId = 0;
                            this.appearanceBasedBaseId = 0;
                            return;
                        }
                        else {
                            throw e;
                        }
                    }
                    model.movement.isWeapDrawn = backup;
                    this.movState.lastNumChanges = +model.numMovementChanges;
                    this.movState.everApplied = true;
                }
                else {
                    var remoteId = this.remoteRefrId;
                    if (ac && remoteId && ac.is3DLoaded()) {
                        ac.clearKeepOffsetFromActor();
                        // TODO: make host service
                        var hosted_1 = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage['hosted'];
                        var alreadyHosted_1 = false;
                        if (Array.isArray(hosted_1)) {
                            var remoteId_1 = (0,_worldViewMisc__WEBPACK_IMPORTED_MODULE_12__.localIdToRemoteId)(ac.getFormID());
                            if (hosted_1.includes(remoteId_1) || hosted_1.includes(remoteId_1 + 0x100000000)) {
                                alreadyHosted_1 = true;
                            }
                        }
                        if (!alreadyHosted_1) {
                            if (this.tryHostIfNeed(ac, remoteId)) {
                                // previously, we did this cleanup on each update
                                // but I guess it's too expensive and can possibly hurt FPS
                                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.setWeaponDrawnMode(ac, -1);
                            }
                        }
                    }
                }
            }
        }
        if (refr.is3DLoaded()) {
            if (model.animation) {
                (0,_sync_animation__WEBPACK_IMPORTED_MODULE_1__.applyAnimation)(refr, model.animation, this.animState);
            }
            // Use them only once, for spawning actors with correct animations
            this.animState.useAnimOverrides = false;
        }
        if (model.appearance) {
            var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
            if (actor && !_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.isInJumpState()) {
                if (_playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell()) {
                    if (this.lastPcWorldOrCell &&
                        _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell() !== this.lastPcWorldOrCell) {
                        // Redraw tints if PC world/cell changed
                        this.isOnScreen = false;
                    }
                    this.lastPcWorldOrCell = _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_8__.PlayerCharacterDataHolder.getWorldOrCell();
                }
                var headPos = [
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionX(actor, "NPC Head [Head]", false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionY(actor, "NPC Head [Head]", false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionZ(actor, "NPC Head [Head]", false),
                ];
                var screenPoint = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.worldPointToScreenPoint)(headPos)[0];
                var isOnScreen = screenPoint[0] > 0 &&
                    screenPoint[1] > 0 &&
                    screenPoint[2] > 0 &&
                    screenPoint[0] < 1 &&
                    screenPoint[1] < 1 &&
                    screenPoint[2] < 1;
                if (isOnScreen != this.isOnScreen) {
                    this.isOnScreen = isOnScreen;
                    if (isOnScreen) {
                        actor.queueNiNodeUpdate();
                        skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer().queueNiNodeUpdate();
                    }
                }
            }
        }
        if (model.equipment) {
            if (this.eqState.lastNumChanges !== model.equipment.numChanges) {
                var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
                // If we do not block inventory here, we will be able to reproduce the bug:
                // 1. Place ~90 bots and force them to reequip iron swords to the left hand (rate should be ~50ms)
                // 2. Open your inventory and reequip different items fast
                // 3. After 1-2 minutes close your inventory and see that HUD disappeared
                if (ac &&
                    !(0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.isBadMenuShown)() &&
                    Date.now() - this.eqState.lastEqMoment > 500 &&
                    Date.now() - this.spawnMoment > -1 &&
                    this.spawnMoment > 0) {
                    //if (this.spawnMoment > 0 && Date.now() - this.spawnMoment > 5000) {
                    if ((0,_sync_equipment__WEBPACK_IMPORTED_MODULE_3__.applyEquipment)(ac, model.equipment)) {
                        this.eqState.lastNumChanges = model.equipment.numChanges;
                    }
                    this.eqState.lastEqMoment = Date.now();
                    //}
                    //const res: boolean = applyEquipment(ac, model.equipment);
                    //if (res) this.eqState.lastNumChanges = model.equipment.numChanges;
                }
            }
        }
        if (FormView.isDisplayingNicknames && this.refrId && ((_b = model.appearance) === null || _b === void 0 ? void 0 : _b.name)) {
            var headPart = "NPC Head [Head]";
            var maxNicknameDrawDistance = 1000;
            var playerActor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
            var isVisibleByPlayer = !((_c = model.movement) === null || _c === void 0 ? void 0 : _c.isSneaking)
                && playerActor.getDistance(refr) <= maxNicknameDrawDistance
                && playerActor.hasLOS(refr)
                && !this.isSweetHidePerson(refr);
            if (isVisibleByPlayer) {
                var headScreenPos = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.worldPointToScreenPoint)([
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionX(refr, headPart, false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionY(refr, headPart, false),
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.getNodeWorldPositionZ(refr, headPart, false) + 32
                ])[0];
                var resolution = getScreenResolution();
                var textXPos = Math.round(headScreenPos[0] * resolution.width);
                var textYPos = Math.round((1 - headScreenPos[1]) * resolution.height);
                var isTalkingText = (model === null || model === void 0 ? void 0 : model.isTalking) ? "Speaking" : "";
                if (!this.textNameId && headScreenPos[2] > 0) {
                    this.textNameId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(textXPos, textYPos, refr.getDisplayName(), [1, 1, 1, 0.8]);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.textNameId, 0.5);
                    _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().emitter.emit("nicknameCreate", {
                        remoteRefrId: this.getRemoteRefrId(),
                        textId: this.textNameId
                    });
                }
                else {
                    var deleteNickname = headScreenPos[2] < 0;
                    if (deleteNickname) {
                        this.removeNickname();
                    }
                    if (this.textNameId) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextPos)(this.textNameId, textXPos, textYPos);
                    }
                }
                if (!this.voiceIndicatorId) {
                    this.voiceIndicatorId = (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.createText)(textXPos, textYPos - 35, "", [1, 0.85, 0.2, 0.8]);
                    (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextSize)(this.voiceIndicatorId, 0.4);
                }
                else {
                    if (this.voiceIndicatorId) {
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextString)(this.voiceIndicatorId, headScreenPos[2] >= 0 ? isTalkingText : "");
                        (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.setTextPos)(this.voiceIndicatorId, textXPos, textYPos - 35);
                    }
                }
            }
            else {
                this.removeNickname();
            }
        }
        else {
            this.removeNickname();
        }
    };
    FormView.prototype.isSweetHidePerson = function (refr) {
        var actor = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (!actor) {
            return false;
        }
        var keyword = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Keyword.getKeyword('SweetHidePerson');
        return actor.wornHasKeyword(keyword);
    };
    FormView.prototype.removeNickname = function () {
        if (this.textNameId) {
            _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_13__.SpApiInteractor.getControllerInstance().emitter.emit("nicknameDestroy", {
                remoteRefrId: this.getRemoteRefrId(),
                textId: this.textNameId
            });
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.destroyText)(this.textNameId);
            this.textNameId = undefined;
        }
        if (this.voiceIndicatorId) {
            (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.destroyText)(this.voiceIndicatorId);
            this.voiceIndicatorId = undefined;
        }
    };
    FormView.prototype.getAppearanceBasedBase = function () {
        var base = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ActorBase.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(this.appearanceBasedBaseId));
        if (!base && this.appearanceState.appearance) {
            this.appearanceBasedBaseId = (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_2__.applyAppearance)(this.appearanceState.appearance).getFormID();
        }
        return this.appearanceBasedBaseId;
    };
    FormView.prototype.getLeveledBase = function (templateChain) {
        if (templateChain === undefined) {
            return 0;
        }
        var str = templateChain.join(',');
        if (this.leveledBaseId === 0) {
            // @ts-ignore
            var leveledBase = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TESModPlatform.evaluateLeveledNpc(str);
            if (!leveledBase) {
                (0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.printConsole)("Failed to evaluate leveled npc", str);
            }
            this.leveledBaseId = (leveledBase === null || leveledBase === void 0 ? void 0 : leveledBase.getFormID()) || 0;
        }
        return this.leveledBaseId;
    };
    FormView.prototype.getDefaultEquipState = function () {
        return { lastNumChanges: 0, lastEqMoment: 0 };
    };
    ;
    FormView.prototype.getDefaultAppearanceState = function () {
        return { lastNumChanges: 0, appearance: null };
    };
    ;
    FormView.prototype.getDefaultAnimState = function () {
        return { lastNumChanges: 0, useAnimOverrides: true };
    };
    ;
    FormView.prototype.tryHostIfNeed = function (ac, remoteId) {
        var last = _hostAttempts__WEBPACK_IMPORTED_MODULE_10__.lastTryHost[remoteId];
        if (!last || Date.now() - last >= 1000) {
            _hostAttempts__WEBPACK_IMPORTED_MODULE_10__.lastTryHost[remoteId] = Date.now();
            if ((0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_9__.getMovement)(ac).worldOrCell ===
                (0,_sync_movementGet__WEBPACK_IMPORTED_MODULE_9__.getMovement)(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer()).worldOrCell) {
                (0,_hostAttempts__WEBPACK_IMPORTED_MODULE_10__.tryHost)(remoteId);
                return true;
            }
        }
        return false;
    };
    ;
    FormView.prototype.getLocalRefrId = function () {
        return this.refrId;
    };
    FormView.prototype.getRemoteRefrId = function () {
        return this.remoteRefrId;
    };
    FormView.isDisplayingNicknames = true;
    return FormView;
}());



/***/ }),

/***/ "./src/view/formViewArray.ts":
/*!***********************************!*\
  !*** ./src/view/formViewArray.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   FormViewArray: () => (/* binding */ FormViewArray)
/* harmony export */ });
/* harmony import */ var _formView__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./formView */ "./src/view/formView.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");



var FormViewArray = /** @class */ (function () {
    function FormViewArray() {
        this.formViews = new Array();
    }
    FormViewArray.prototype.updateForm = function (form, i) {
        var view = this.formViews[i];
        if (!view) {
            this.formViews[i] = new _formView__WEBPACK_IMPORTED_MODULE_0__.FormView(form.refrId);
        }
        else {
            view.update(form);
        }
    };
    FormViewArray.prototype.destroyForm = function (i) {
        var formView = this.formViews[i];
        if (formView === undefined) {
            return;
        }
        formView.destroy();
        this.formViews[i] = undefined;
    };
    FormViewArray.prototype.resize = function (newSize) {
        if (this.formViews.length > newSize) {
            this.formViews.slice(newSize).forEach(function (v) { return v && v.destroy(); });
        }
        this.formViews.length = newSize;
    };
    FormViewArray.prototype.updateAll = function (model, showMe, isCloneView) {
        var gamemodeUpdateService = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_2__.GamemodeUpdateService);
        gamemodeUpdateService.setFormViewArray(this);
        var forms = model.forms;
        var n = forms.length;
        for (var i = 0; i < n; ++i) {
            var form = forms[i];
            if (!form || (model.playerCharacterFormIdx === i && !showMe)) {
                this.destroyForm(i);
                continue;
            }
            var realPos = undefined;
            var offset = model.playerCharacterFormIdx === i || isCloneView;
            if (offset && form.movement) {
                realPos = form.movement.pos;
                form.movement.pos = [
                    realPos[0] + 128,
                    realPos[1] + 128,
                    realPos[2],
                ];
            }
            if (isCloneView) {
                // Prevent using the same refr by normal and clone views
                if (!form.refrId || form.refrId >= 0xff000000) {
                    var backup = form.isHostedByOther;
                    form.isHostedByOther = true;
                    // TODO: Explain why do not GamemodeApiSupport.setI(i); here
                    this.updateForm(form, i);
                    form.isHostedByOther = backup;
                }
            }
            else {
                gamemodeUpdateService.setI(i);
                this.updateForm(form, i);
            }
            if (offset && form.movement && realPos) {
                form.movement.pos = realPos;
            }
        }
    };
    FormViewArray.prototype.syncFormView = function (model, showMe) {
        for (var i = 0; i < model.forms.length; ++i) {
            if (!model.forms[i] || (model.playerCharacterFormIdx === i && !showMe)) {
                this.destroyForm(i);
                continue;
            }
        }
    };
    FormViewArray.prototype.getRemoteRefrId = function (clientsideRefrId) {
        if (clientsideRefrId < 0xff000000)
            throw new Error("This function is only for 0xff forms");
        var formView = this.formViews.find(function (formView) {
            return formView && formView.getLocalRefrId() === clientsideRefrId;
        });
        return formView ? formView.getRemoteRefrId() : 0;
    };
    FormViewArray.prototype.getLocalRefrId = function (remoteRefrId) {
        if (remoteRefrId < 0xff000000)
            throw new Error("This function is only for 0xff forms");
        var formView = this.formViews.find(function (formView) {
            return formView && formView.getRemoteRefrId() === remoteRefrId;
        });
        return formView ? formView.getLocalRefrId() : 0;
    };
    FormViewArray.prototype.getNthFormView = function (i) {
        return this.formViews[i];
    };
    FormViewArray.prototype.getFormViewsArrayLength = function () {
        return this.formViews.length;
    };
    return FormViewArray;
}());



/***/ }),

/***/ "./src/view/hostAttempts.ts":
/*!**********************************!*\
  !*** ./src/view/hostAttempts.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   lastTryHost: () => (/* binding */ lastTryHost),
/* harmony export */   nextHostAttempt: () => (/* binding */ nextHostAttempt),
/* harmony export */   tryHost: () => (/* binding */ tryHost)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);

skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"] = [];
var tryHost = function (targetRemoteId) {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"].push(targetRemoteId);
};
var nextHostAttempt = function () {
    var arr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["hostAttempts"];
    if (arr.length === 0) {
        return undefined;
    }
    return arr.shift();
};
var lastTryHost = {};


/***/ }),

/***/ "./src/view/modelApplyUtils.ts":
/*!*************************************!*\
  !*** ./src/view/modelApplyUtils.ts ***!
  \*************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ModelApplyUtils: () => (/* binding */ ModelApplyUtils)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_inventory__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/inventory */ "./src/sync/inventory.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../logging */ "./src/logging.ts");



// For 0xff000000+ used from FormView
// For objects from master files used directly from remoteServer.ts
var ModelApplyUtils = /** @class */ (function () {
    function ModelApplyUtils() {
    }
    ModelApplyUtils.applyModelInventory = function (refr, inventory) {
        (0,_sync_inventory__WEBPACK_IMPORTED_MODULE_1__.applyInventory)(refr, inventory, false, true);
    };
    ModelApplyUtils.applyModelIsOpen = function (refr, isOpen) {
        var _a;
        refr.setOpen(isOpen);
        // See also objectReferenceEx.ts
        var caveGSecretDoor01 = 0x6f703;
        // TODO: add more activators to support more cells
        var parentActivatorId = 0x460ca;
        if (((_a = refr.getBaseObject()) === null || _a === void 0 ? void 0 : _a.getFormID()) === caveGSecretDoor01) {
            var openOrOpening = [1, 2].includes(refr.getOpenState());
            if (openOrOpening) {
                if (!isOpen) {
                    refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getForm(parentActivatorId)), false);
                }
            }
            if (!openOrOpening) {
                if (isOpen) {
                    refr.activate(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getForm(parentActivatorId)), false);
                }
            }
        }
    };
    ModelApplyUtils.applyModelIsDisabled = function (refr, disabled) {
        var wasDisabled = refr.isDisabled();
        if (wasDisabled == disabled) {
            return;
        }
        if (disabled) {
            refr.disable(false);
        }
        else {
            refr.enable(true);
        }
    };
    ModelApplyUtils.applyModelIsHarvested = function (refr, isHarvested) {
        var base = refr.getBaseObject();
        if (base) {
            var t = base.getType();
            if (t == 38 /* FormType.Tree */ || t == 39 /* FormType.Flora */) {
                var wasHarvested = refr.isHarvested();
                if (isHarvested != wasHarvested) {
                    var ac = null;
                    if (isHarvested) {
                        for (var i = 0; i < 20; ++i) {
                            ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.findRandomActor(refr.getPositionX(), refr.getPositionY(), refr.getPositionZ(), 10000);
                            if (ac && ac.getFormID() !== 0x14) {
                                break;
                            }
                        }
                    }
                    if (isHarvested && ac && ac.getFormID() !== 0x14) {
                        refr.activate(ac, true);
                    }
                    else {
                        refr.setHarvested(isHarvested);
                        var id_1 = refr.getFormID();
                        refr.disable(false).then(function () {
                            var restoredRefr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id_1));
                            if (restoredRefr) {
                                restoredRefr.enable(false);
                            }
                        });
                    }
                }
            }
            else {
                var wasHarvested = refr.isDisabled();
                if (isHarvested != wasHarvested) {
                    if (isHarvested) {
                        var id_2 = refr.getFormID();
                        refr.disable(false).then(function () {
                            var restoredRefr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(id_2));
                            if (restoredRefr && !restoredRefr.isDisabled()) {
                                restoredRefr.delete();
                                // Deletion takes time, so in practice this would be called a lot of times
                            }
                        });
                    }
                    else {
                        refr.enable(true);
                    }
                }
            }
        }
    };
    ModelApplyUtils.applyModelNodeTextureSet = function (refr, setNodeTextureSet) {
        if (setNodeTextureSet) {
            setNodeTextureSet.forEach(function (element) {
                var firstPerson = false;
                var textureSet = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.TextureSet.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(element.textureSetId));
                if (textureSet !== null) {
                    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.setNodeTextureSet(refr, element.nodeName, textureSet, firstPerson);
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)("ModelApplyUtils", refr.getFormID().toString(16), "Applied texture set", element.textureSetId.toString(16), "to", element.nodeName);
                }
                else {
                    (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logError)("ModelApplyUtils", refr.getFormID().toString(16), "Failed to apply texture set", element.textureSetId.toString(16), "to", element.nodeName);
                }
            });
        }
    };
    ModelApplyUtils.applyModelNodeScale = function (refr, setNodeScale) {
        if (setNodeScale) {
            setNodeScale.forEach(function (element) {
                var firstPerson = false;
                skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.NetImmerse.setNodeScale(refr, element.nodeName, element.scale, firstPerson);
                (0,_logging__WEBPACK_IMPORTED_MODULE_2__.logTrace)("ModelApplyUtils", refr.getFormID().toString(16), "Applied node scale", element.scale, "to", element.nodeName);
            });
        }
    };
    return ModelApplyUtils;
}());



/***/ }),

/***/ "./src/view/playerCharacterDataHolder.ts":
/*!***********************************************!*\
  !*** ./src/view/playerCharacterDataHolder.ts ***!
  \***********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   PlayerCharacterDataHolder: () => (/* binding */ PlayerCharacterDataHolder)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");


var PlayerCharacterDataHolder = /** @class */ (function () {
    function PlayerCharacterDataHolder() {
    }
    PlayerCharacterDataHolder.updateData = function () {
        var _a;
        var player = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getPlayer();
        if (!player) {
            return;
        }
        this.inJumpState = player.getAnimationVariableBool("bInJumpState");
        this.worldOrCell = _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_1__.ObjectReferenceEx.getWorldOrCell(player);
        this.crosshairRefId = ((_a = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getCurrentCrosshairRef()) === null || _a === void 0 ? void 0 : _a.getFormID()) || 0;
    };
    PlayerCharacterDataHolder.isInJumpState = function () {
        return this.inJumpState;
    };
    PlayerCharacterDataHolder.getWorldOrCell = function () {
        return this.worldOrCell;
    };
    PlayerCharacterDataHolder.getCrosshairRefId = function () {
        return this.crosshairRefId;
    };
    PlayerCharacterDataHolder.inJumpState = false;
    PlayerCharacterDataHolder.worldOrCell = 0;
    PlayerCharacterDataHolder.crosshairRefId = 0;
    return PlayerCharacterDataHolder;
}());



/***/ }),

/***/ "./src/view/spawnProcess.ts":
/*!**********************************!*\
  !*** ./src/view/spawnProcess.ts ***!
  \**********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   SpawnProcess: () => (/* binding */ SpawnProcess)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _sync_appearance__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../sync/appearance */ "./src/sync/appearance.ts");
/* harmony import */ var _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../extensions/objectReferenceEx */ "./src/extensions/objectReferenceEx.ts");



var SpawnProcess = /** @class */ (function () {
    function SpawnProcess(appearance, pos, refrId, callback) {
        var _this = this;
        this.callback = callback;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        refr.setPosition.apply(refr, pos).then(function () { return _this.enable(appearance, refrId); });
    }
    SpawnProcess.prototype.enable = function (appearance, refrId) {
        var _this = this;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (ac && appearance) {
            (0,_sync_appearance__WEBPACK_IMPORTED_MODULE_1__.applyTints)(ac, appearance);
        }
        refr.enable(false).then(function () { return _this.resurrect(refrId); });
    };
    SpawnProcess.prototype.resurrect = function (refrId) {
        var _this = this;
        var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
        if (!refr || refr.getFormID() !== refrId) {
            return;
        }
        var ac = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Actor.from(refr);
        if (ac) {
            return ac.resurrect().then(function () {
                _this.callback();
            });
        }
        _extensions_objectReferenceEx__WEBPACK_IMPORTED_MODULE_2__.ObjectReferenceEx.dealWithRef(refr, refr.getBaseObject());
        return refr.setMotionType(4 /* MotionType.Keyframed */, true).then(this.callback);
    };
    return SpawnProcess;
}());



/***/ }),

/***/ "./src/view/worldView.ts":
/*!*******************************!*\
  !*** ./src/view/worldView.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   WorldView: () => (/* binding */ WorldView)
/* harmony export */ });
/* harmony import */ var _formViewArray__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./formViewArray */ "./src/view/formViewArray.ts");
/* harmony import */ var _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./playerCharacterDataHolder */ "./src/view/playerCharacterDataHolder.ts");
/* harmony import */ var _services_services_clientListener__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/clientListener */ "./src/services/services/clientListener.ts");
/* harmony import */ var _logging__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../logging */ "./src/logging.ts");
/* harmony import */ var _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../services/services/singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../services/services/remoteServer */ "./src/services/services/remoteServer.ts");
var __extends = (undefined && undefined.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();






var WorldView = /** @class */ (function (_super) {
    __extends(WorldView, _super);
    function WorldView(sp, controller) {
        var _this = _super.call(this) || this;
        _this.sp = sp;
        _this.controller = controller;
        controller.on("update", function () { return _this.onUpdate(); });
        controller.once("update", function () { return _this.onceUpdate(); });
        _this.state = _this.makeEmptyState();
        var oldView = _this.sp.storage["view"];
        // can't use instanceof here because each hot reload creates a new class
        _this.oldView = typeof oldView === "object" ? oldView : undefined;
        _this.sp.storage["view"] = _this;
        return _this;
    }
    WorldView.prototype.getRemoteRefrId = function (clientsideRefrId) {
        return this.state.formViews.getRemoteRefrId(clientsideRefrId);
    };
    WorldView.prototype.getLocalRefrId = function (remoteRefrId) {
        return this.state.formViews.getLocalRefrId(remoteRefrId);
    };
    WorldView.prototype.syncFormArray = function (model) {
        var settings = this.sp.settings;
        var showMe = settings['skymp5-client']['show-me'];
        this.state.formViews.syncFormView(model, !!showMe);
    };
    WorldView.prototype.destroy = function () {
        this.state.formViews.resize(0);
        this.state.cloneFormViews.resize(0); // Recenrly added, not tested if it's needed
        this.state = this.makeEmptyState();
    };
    WorldView.prototype.getFormViews = function () {
        return this.state.formViews;
    };
    WorldView.prototype.onUpdate = function () {
        this.resetAllFormViewsIfPlayerChangedWorld();
        var singlePlayerService = this.controller.lookupListener(_services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_4__.SinglePlayerService);
        if (!singlePlayerService.isSinglePlayer) {
            var modelSource = this.controller.lookupListener(_services_services_remoteServer__WEBPACK_IMPORTED_MODULE_5__.RemoteServer);
            this.updateWorld(modelSource.getWorldModel());
        }
    };
    WorldView.prototype.onceUpdate = function () {
        if (this.oldView) {
            this.oldView.destroy();
            this.oldView = undefined;
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Previous View destroyed');
        }
        this.waitGameTimeAndAllowFormViewUpdate(1.0);
    };
    WorldView.prototype.resetAllFormViewsIfPlayerChangedWorld = function () {
        var state = this.state;
        var pc = this.sp.Game.getPlayer();
        var pcWorldOrCell = (pc.getWorldSpace() || pc.getParentCell()).getFormID();
        if (state.pcWorldOrCell !== pcWorldOrCell) {
            if (state.pcWorldOrCell) {
                (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Reset all form views');
                state.formViews.resize(0);
                state.cloneFormViews.resize(0);
            }
            state.pcWorldOrCell = pcWorldOrCell;
        }
    };
    // Work around showRaceMenu issue
    // Default nord in Race Menu will have very ugly face
    // If other players are spawning when we show this menu
    // TODO: separate listener
    WorldView.prototype.waitGameTimeAndAllowFormViewUpdate = function (seconds) {
        var _this = this;
        // Wait 1s game time (time spent in Race Menu isn't counted)
        this.sp.Utility.wait(seconds).then(function () {
            _this.state.allowUpdate = true;
            (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(_this, 'Update is now allowed');
        });
    };
    WorldView.prototype.setFormViewUpdateAllowed = function (allowed) {
        this.state.allowUpdate = allowed;
        (0,_logging__WEBPACK_IMPORTED_MODULE_3__.logTrace)(this, 'Update is now', allowed ? 'allowed' : 'disallowed');
    };
    WorldView.prototype.updateWorld = function (model) {
        var settings = this.sp.settings;
        var state = this.state;
        if (!state.allowUpdate) {
            model = {
                forms: [],
                playerCharacterFormIdx: model.playerCharacterFormIdx,
                playerCharacterRefrId: model.playerCharacterRefrId
            };
        }
        var skipUpdates = settings['skymp5-client']['skipUpdates'];
        // skip 50% of updates if specified in the settings
        state.counter = !state.counter;
        if (state.counter && skipUpdates) {
            return;
        }
        state.formViews.resize(model.forms.length);
        var showMe = settings['skymp5-client']['show-me'];
        var showClones = settings['skymp5-client']['show-clones'];
        _playerCharacterDataHolder__WEBPACK_IMPORTED_MODULE_1__.PlayerCharacterDataHolder.updateData();
        state.formViews.updateAll(model, !!showMe, false);
        if (showClones) {
            state.cloneFormViews.updateAll(model, false, true);
        }
        else {
            state.cloneFormViews.resize(0);
        }
    };
    WorldView.prototype.makeEmptyState = function () {
        return {
            formViews: new _formViewArray__WEBPACK_IMPORTED_MODULE_0__.FormViewArray(),
            cloneFormViews: new _formViewArray__WEBPACK_IMPORTED_MODULE_0__.FormViewArray(),
            allowUpdate: false,
            pcWorldOrCell: 0,
            counter: false,
        };
    };
    return WorldView;
}(_services_services_clientListener__WEBPACK_IMPORTED_MODULE_2__.ClientListener));



/***/ }),

/***/ "./src/view/worldViewMisc.ts":
/*!***********************************!*\
  !*** ./src/view/worldViewMisc.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   getObjectReference: () => (/* binding */ getObjectReference),
/* harmony export */   getViewFromStorage: () => (/* binding */ getViewFromStorage),
/* harmony export */   localIdToRemoteId: () => (/* binding */ localIdToRemoteId),
/* harmony export */   remoteIdToLocalId: () => (/* binding */ remoteIdToLocalId)
/* harmony export */ });
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../services/services/remoteServer */ "./src/services/services/remoteServer.ts");



var getViewFromStorage = function () {
    var res = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.storage["view"];
    // can't use instanceof here because each hot reload creates a new class
    if (typeof res === "object") {
        return res;
    }
    return undefined;
};
var localIdToRemoteId = function (localFormId, newCast) {
    if (newCast === void 0) { newCast = false; }
    if (newCast && localFormId == 0x14) {
        return _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_1__.SpApiInteractor.getControllerInstance().lookupListener(_services_services_remoteServer__WEBPACK_IMPORTED_MODULE_2__.RemoteServer).getMyRemoteRefrId();
    }
    if (localFormId >= 0xff000000) {
        var view = getViewFromStorage();
        if (!view) {
            return 0;
        }
        localFormId = view.getRemoteRefrId(localFormId);
        if (!localFormId) {
            return 0;
        }
        // serverside ids are 64bit
        if (localFormId >= 0x100000000) {
            localFormId -= 0x100000000;
        }
    }
    return localFormId;
};
var remoteIdToLocalId = function (remoteFormId) {
    if (remoteFormId >= 0xff000000) {
        var view = getViewFromStorage();
        if (!view) {
            return 0;
        }
        remoteFormId = view.getLocalRefrId(remoteFormId);
        if (!remoteFormId) {
            return 0;
        }
    }
    return remoteFormId;
};
var getObjectReference = function (i) {
    var view = getViewFromStorage();
    if (view) {
        var formView = view.getFormViews().getNthFormView(i);
        if (formView) {
            var refrId = formView.getLocalRefrId();
            if (refrId > 0) {
                var refr = skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.ObjectReference.from(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.getFormEx(refrId));
                if (refr !== null) {
                    return refr;
                }
            }
        }
    }
    return null;
};


/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "inspector":
/*!****************************!*\
  !*** external "inspector" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("inspector");

/***/ }),

/***/ "node:crypto":
/*!******************************!*\
  !*** external "node:crypto" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:crypto");

/***/ }),

/***/ "skyrimPlatform":
/*!***********************************!*\
  !*** external ["skyrimPlatform"] ***!
  \***********************************/
/***/ ((module) => {

module.exports = skyrimPlatform;

/***/ }),

/***/ "./node_modules/eventemitter3/index.mjs":
/*!**********************************************!*\
  !*** ./node_modules/eventemitter3/index.mjs ***!
  \**********************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   EventEmitter: () => (/* reexport default export from named module */ _index_js__WEBPACK_IMPORTED_MODULE_0__),
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/* harmony import */ var _index_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index.js */ "./node_modules/eventemitter3/index.js");



/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (_index_js__WEBPACK_IMPORTED_MODULE_0__);


/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/compat get default export */
/******/ 	(() => {
/******/ 		// getDefaultExport function for compatibility with non-harmony modules
/******/ 		__webpack_require__.n = (module) => {
/******/ 			var getter = module && module.__esModule ?
/******/ 				() => (module['default']) :
/******/ 				() => (module);
/******/ 			__webpack_require__.d(getter, { a: getter });
/******/ 			return getter;
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! skyrimPlatform */ "skyrimPlatform");
/* harmony import */ var skyrimPlatform__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__);
/* harmony import */ var _services_services_skympClient__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./services/services/skympClient */ "./src/services/services/skympClient.ts");
/* harmony import */ var _services_services_blockPapyrusEventsService__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./services/services/blockPapyrusEventsService */ "./src/services/services/blockPapyrusEventsService.ts");
/* harmony import */ var _services_services_enforceLimitationsService__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./services/services/enforceLimitationsService */ "./src/services/services/enforceLimitationsService.ts");
/* harmony import */ var _services_services_loadGameService__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./services/services/loadGameService */ "./src/services/services/loadGameService.ts");
/* harmony import */ var _services_services_sendInputsService__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./services/services/sendInputsService */ "./src/services/services/sendInputsService.ts");
/* harmony import */ var _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./services/services/singlePlayerService */ "./src/services/services/singlePlayerService.ts");
/* harmony import */ var _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./services/spApiInteractor */ "./src/services/spApiInteractor.ts");
/* harmony import */ var _services_services_timeService__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./services/services/timeService */ "./src/services/services/timeService.ts");
/* harmony import */ var _services_services_spVersionCheckService__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./services/services/spVersionCheckService */ "./src/services/services/spVersionCheckService.ts");
/* harmony import */ var _services_services_consoleCommandsService__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./services/services/consoleCommandsService */ "./src/services/services/consoleCommandsService.ts");
/* harmony import */ var _services_services_lastInvService__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./services/services/lastInvService */ "./src/services/services/lastInvService.ts");
/* harmony import */ var _services_services_activationService__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./services/services/activationService */ "./src/services/services/activationService.ts");
/* harmony import */ var _services_services_craftService__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./services/services/craftService */ "./src/services/services/craftService.ts");
/* harmony import */ var _services_services_dropItemService__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./services/services/dropItemService */ "./src/services/services/dropItemService.ts");
/* harmony import */ var _services_services_hitService__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ./services/services/hitService */ "./src/services/services/hitService.ts");
/* harmony import */ var _services_services_ragdollService__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./services/services/ragdollService */ "./src/services/services/ragdollService.ts");
/* harmony import */ var _services_services_deathService__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ./services/services/deathService */ "./src/services/services/deathService.ts");
/* harmony import */ var _services_services_containersService__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./services/services/containersService */ "./src/services/services/containersService.ts");
/* harmony import */ var _services_services_networkingService__WEBPACK_IMPORTED_MODULE_19__ = __webpack_require__(/*! ./services/services/networkingService */ "./src/services/services/networkingService.ts");
/* harmony import */ var _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_20__ = __webpack_require__(/*! ./services/services/remoteServer */ "./src/services/services/remoteServer.ts");
/* harmony import */ var _services_services_spSnippetService__WEBPACK_IMPORTED_MODULE_21__ = __webpack_require__(/*! ./services/services/spSnippetService */ "./src/services/services/spSnippetService.ts");
/* harmony import */ var _services_services_sweetTaffyDynamicPerksService__WEBPACK_IMPORTED_MODULE_22__ = __webpack_require__(/*! ./services/services/sweetTaffyDynamicPerksService */ "./src/services/services/sweetTaffyDynamicPerksService.ts");
/* harmony import */ var _services_services_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_23__ = __webpack_require__(/*! ./services/services/sweetTaffySweetCantDropService */ "./src/services/services/sweetTaffySweetCantDropService.ts");
/* harmony import */ var _services_services_sweetTaffyStaticPerksService__WEBPACK_IMPORTED_MODULE_24__ = __webpack_require__(/*! ./services/services/sweetTaffyStaticPerksService */ "./src/services/services/sweetTaffyStaticPerksService.ts");
/* harmony import */ var _services_services_disableSkillAdvanceService__WEBPACK_IMPORTED_MODULE_25__ = __webpack_require__(/*! ./services/services/disableSkillAdvanceService */ "./src/services/services/disableSkillAdvanceService.ts");
/* harmony import */ var _services_services_disableFastTravelService__WEBPACK_IMPORTED_MODULE_26__ = __webpack_require__(/*! ./services/services/disableFastTravelService */ "./src/services/services/disableFastTravelService.ts");
/* harmony import */ var _services_services_disableDifficultySelectionService__WEBPACK_IMPORTED_MODULE_27__ = __webpack_require__(/*! ./services/services/disableDifficultySelectionService */ "./src/services/services/disableDifficultySelectionService.ts");
/* harmony import */ var _services_services_sweetTaffyPlayerCombatService__WEBPACK_IMPORTED_MODULE_28__ = __webpack_require__(/*! ./services/services/sweetTaffyPlayerCombatService */ "./src/services/services/sweetTaffyPlayerCombatService.ts");
/* harmony import */ var _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_29__ = __webpack_require__(/*! ./services/services/worldCleanerService */ "./src/services/services/worldCleanerService.ts");
/* harmony import */ var _services_services_sweetTaffySkillMenuService__WEBPACK_IMPORTED_MODULE_30__ = __webpack_require__(/*! ./services/services/sweetTaffySkillMenuService */ "./src/services/services/sweetTaffySkillMenuService.ts");
/* harmony import */ var _services_services_loadOrderVerificationService__WEBPACK_IMPORTED_MODULE_31__ = __webpack_require__(/*! ./services/services/loadOrderVerificationService */ "./src/services/services/loadOrderVerificationService.ts");
/* harmony import */ var _services_services_browserService__WEBPACK_IMPORTED_MODULE_32__ = __webpack_require__(/*! ./services/services/browserService */ "./src/services/services/browserService.ts");
/* harmony import */ var _services_services_authService__WEBPACK_IMPORTED_MODULE_33__ = __webpack_require__(/*! ./services/services/authService */ "./src/services/services/authService.ts");
/* harmony import */ var _services_services_characterSelectService__WEBPACK_IMPORTED_MODULE_34__ = __webpack_require__(/*! ./services/services/characterSelectService */ "./src/services/services/characterSelectService.ts");
/* harmony import */ var _services_services_netInfoService__WEBPACK_IMPORTED_MODULE_35__ = __webpack_require__(/*! ./services/services/netInfoService */ "./src/services/services/netInfoService.ts");
/* harmony import */ var _services_services_animDebugService__WEBPACK_IMPORTED_MODULE_36__ = __webpack_require__(/*! ./services/services/animDebugService */ "./src/services/services/animDebugService.ts");
/* harmony import */ var _services_services_timersService__WEBPACK_IMPORTED_MODULE_37__ = __webpack_require__(/*! ./services/services/timersService */ "./src/services/services/timersService.ts");
/* harmony import */ var _services_services_playerBowShotService__WEBPACK_IMPORTED_MODULE_38__ = __webpack_require__(/*! ./services/services/playerBowShotService */ "./src/services/services/playerBowShotService.ts");
/* harmony import */ var _services_services_gamemodeEventSourceService__WEBPACK_IMPORTED_MODULE_39__ = __webpack_require__(/*! ./services/services/gamemodeEventSourceService */ "./src/services/services/gamemodeEventSourceService.ts");
/* harmony import */ var _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_40__ = __webpack_require__(/*! ./services/services/gamemodeUpdateService */ "./src/services/services/gamemodeUpdateService.ts");
/* harmony import */ var _services_services_frontHotReloadService__WEBPACK_IMPORTED_MODULE_41__ = __webpack_require__(/*! ./services/services/frontHotReloadService */ "./src/services/services/frontHotReloadService.ts");
/* harmony import */ var _services_services_blockedAnimationsService__WEBPACK_IMPORTED_MODULE_42__ = __webpack_require__(/*! ./services/services/blockedAnimationsService */ "./src/services/services/blockedAnimationsService.ts");
/* harmony import */ var _services_services_voiceChatService__WEBPACK_IMPORTED_MODULE_43__ = __webpack_require__(/*! ./services/services/voiceChatService */ "./src/services/services/voiceChatService.ts");
/* harmony import */ var _view_worldView__WEBPACK_IMPORTED_MODULE_44__ = __webpack_require__(/*! ./view/worldView */ "./src/view/worldView.ts");
/* harmony import */ var _services_services_keyboardEventsService__WEBPACK_IMPORTED_MODULE_45__ = __webpack_require__(/*! ./services/services/keyboardEventsService */ "./src/services/services/keyboardEventsService.ts");
/* harmony import */ var _services_services_magicSyncService__WEBPACK_IMPORTED_MODULE_46__ = __webpack_require__(/*! ./services/services/magicSyncService */ "./src/services/services/magicSyncService.ts");
/* harmony import */ var _services_services_profilingService__WEBPACK_IMPORTED_MODULE_47__ = __webpack_require__(/*! ./services/services/profilingService */ "./src/services/services/profilingService.ts");
/* harmony import */ var _services_services_settingsService__WEBPACK_IMPORTED_MODULE_48__ = __webpack_require__(/*! ./services/services/settingsService */ "./src/services/services/settingsService.ts");
/* harmony import */ var _services_services_sweetCameraEnforcementService__WEBPACK_IMPORTED_MODULE_49__ = __webpack_require__(/*! ./services/services/sweetCameraEnforcementService */ "./src/services/services/sweetCameraEnforcementService.ts");
/* harmony import */ var _services_services_sweetTaffyNicknamesService__WEBPACK_IMPORTED_MODULE_50__ = __webpack_require__(/*! ./services/services/sweetTaffyNicknamesService */ "./src/services/services/sweetTaffyNicknamesService.ts");
/* harmony import */ var _services_services_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_51__ = __webpack_require__(/*! ./services/services/serverJsVerificationService */ "./src/services/services/serverJsVerificationService.ts");





















































(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("update", function () {
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Utility.setINIBool("bAlwaysActive:General", true);
    skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.Game.setGameSettingInt("iDeathDropWeaponChance", 0);
});
var main = function () {
    try {
        var controller = _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__.SpApiInteractor.getControllerInstance();
        var listeners = [
            new _services_services_blockPapyrusEventsService__WEBPACK_IMPORTED_MODULE_2__.BlockPapyrusEventsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_loadGameService__WEBPACK_IMPORTED_MODULE_4__.LoadGameService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_singlePlayerService__WEBPACK_IMPORTED_MODULE_6__.SinglePlayerService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_enforceLimitationsService__WEBPACK_IMPORTED_MODULE_3__.EnforceLimitationsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sendInputsService__WEBPACK_IMPORTED_MODULE_5__.SendInputsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_skympClient__WEBPACK_IMPORTED_MODULE_1__.SkympClient(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_timeService__WEBPACK_IMPORTED_MODULE_8__.TimeService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_spVersionCheckService__WEBPACK_IMPORTED_MODULE_9__.SpVersionCheckService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_consoleCommandsService__WEBPACK_IMPORTED_MODULE_10__.ConsoleCommandsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_lastInvService__WEBPACK_IMPORTED_MODULE_11__.LastInvService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_activationService__WEBPACK_IMPORTED_MODULE_12__.ActivationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_craftService__WEBPACK_IMPORTED_MODULE_13__.CraftService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_dropItemService__WEBPACK_IMPORTED_MODULE_14__.DropItemService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_hitService__WEBPACK_IMPORTED_MODULE_15__.HitService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_ragdollService__WEBPACK_IMPORTED_MODULE_16__.RagdollService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_deathService__WEBPACK_IMPORTED_MODULE_17__.DeathService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_containersService__WEBPACK_IMPORTED_MODULE_18__.ContainersService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_networkingService__WEBPACK_IMPORTED_MODULE_19__.NetworkingService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_remoteServer__WEBPACK_IMPORTED_MODULE_20__.RemoteServer(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_spSnippetService__WEBPACK_IMPORTED_MODULE_21__.SpSnippetService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_settingsService__WEBPACK_IMPORTED_MODULE_48__.SettingsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyDynamicPerksService__WEBPACK_IMPORTED_MODULE_22__.SweetTaffyDynamicPerksService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyStaticPerksService__WEBPACK_IMPORTED_MODULE_24__.SweetTaffyStaticPerksService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffySweetCantDropService__WEBPACK_IMPORTED_MODULE_23__.SweetTaffySweetCantDropService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyPlayerCombatService__WEBPACK_IMPORTED_MODULE_28__.SweetTaffyPlayerCombatService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffySkillMenuService__WEBPACK_IMPORTED_MODULE_30__.SweetTaffySkillMenuService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetCameraEnforcementService__WEBPACK_IMPORTED_MODULE_49__.SweetCameraEnforcementService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableSkillAdvanceService__WEBPACK_IMPORTED_MODULE_25__.DisableSkillAdvanceService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableFastTravelService__WEBPACK_IMPORTED_MODULE_26__.DisableFastTravelService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_disableDifficultySelectionService__WEBPACK_IMPORTED_MODULE_27__.DisableDifficultySelectionService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_worldCleanerService__WEBPACK_IMPORTED_MODULE_29__.WorldCleanerService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_loadOrderVerificationService__WEBPACK_IMPORTED_MODULE_31__.LoadOrderVerificationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_browserService__WEBPACK_IMPORTED_MODULE_32__.BrowserService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_authService__WEBPACK_IMPORTED_MODULE_33__.AuthService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_characterSelectService__WEBPACK_IMPORTED_MODULE_34__.CharacterSelectService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_netInfoService__WEBPACK_IMPORTED_MODULE_35__.NetInfoService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_animDebugService__WEBPACK_IMPORTED_MODULE_36__.AnimDebugService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_timersService__WEBPACK_IMPORTED_MODULE_37__.TimersService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_playerBowShotService__WEBPACK_IMPORTED_MODULE_38__.PlayerBowShotService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_gamemodeEventSourceService__WEBPACK_IMPORTED_MODULE_39__.GamemodeEventSourceService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_gamemodeUpdateService__WEBPACK_IMPORTED_MODULE_40__.GamemodeUpdateService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_frontHotReloadService__WEBPACK_IMPORTED_MODULE_41__.FrontHotReloadService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_blockedAnimationsService__WEBPACK_IMPORTED_MODULE_42__.BlockedAnimationsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_voiceChatService__WEBPACK_IMPORTED_MODULE_43__.VoiceChatService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _view_worldView__WEBPACK_IMPORTED_MODULE_44__.WorldView(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_keyboardEventsService__WEBPACK_IMPORTED_MODULE_45__.KeyboardEventsService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_magicSyncService__WEBPACK_IMPORTED_MODULE_46__.MagicSyncService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_profilingService__WEBPACK_IMPORTED_MODULE_47__.ProfilingService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_sweetTaffyNicknamesService__WEBPACK_IMPORTED_MODULE_50__.SweetTaffyNicknamesService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
            new _services_services_serverJsVerificationService__WEBPACK_IMPORTED_MODULE_51__.ServerJsVerificationService(skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__, controller),
        ];
        _services_spApiInteractor__WEBPACK_IMPORTED_MODULE_7__.SpApiInteractor.setup(listeners);
    }
    catch (e) {
        // TODO: handle setup failure. will output to game console by default
        throw e;
    }
};
// [18.08.2023]
// I saw "attempt to call hooks.add while in hook context" error
// I'm not sure if it's a C++ bug in SkyrimPlatform or an artifact of webpack+hotreload
// But let's for now ensure that "main" executes inside tick context
(0,skyrimPlatform__WEBPACK_IMPORTED_MODULE_0__.once)("tick", main);

/******/ })()
;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUNsQ0E7QUFHcUM7QUFDWTtBQUMxQztBQUNQO0FBQ0E7QUFDQTtBQUNBLENBQUMsZ0RBQWdEO0FBQ2pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ087QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYSxpREFBSztBQUNsQjtBQUNBO0FBQ0EsWUFBWSw4REFBYztBQUMxQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSw4REFBYztBQUMxQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCLG1EQUFPO0FBQ3ZCO0FBQ0EsZ0JBQWdCLG1EQUFPO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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Q25DLGdCQUFnQixrRkFBZ0IsQ0FBQywyQ0FBRTtBQUNuQyxnQkFBZ0Isc0dBQTBCLENBQUMsMkNBQUU7QUFDN0MsZ0JBQWdCLHdHQUEyQixDQUFDLDJDQUFFO0FBQzlDO0FBQ0EsUUFBUSxzRUFBZTtBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9EQUFJIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL25vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4LmpzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvZXh0ZW5zaW9ucy9mb3JtVHlwZUV4LnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2ZlYXR1cmVzL2F1dGhNb2RlbC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2xpYi9lcnJvcnMudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9saWIvaWRNYW5hZ2VyLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvbGliL25hbWVvZi50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2xvZ2dpbmcudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9tZXNzYWdlcy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL2V2ZW50cy9ldmVudHMudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9hY3RpdmF0aW9uU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2FuaW1EZWJ1Z1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9hdXRoU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Jsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9ibG9ja2VkQW5pbWF0aW9uc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9icm93c2VyU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2NoYXJhY3RlclNlbGVjdFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9jbGllbnRMaXN0ZW5lci50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2NvbnNvbGVDb21tYW5kc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9jb250YWluZXJzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2NyYWZ0U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2RlYXRoU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Rpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Rpc2FibGVGYXN0VHJhdmVsU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Rpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZHJvcEl0ZW1TZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZW5mb3JjZUxpbWl0YXRpb25zU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2Zyb250SG90UmVsb2FkU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2dhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvaGl0U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2tleWJvYXJkRXZlbnRzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL2xhc3RJbnZTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvbG9hZEdhbWVTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvbG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL21hZ2ljU3luY1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9uZXRJbmZvU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL25ldHdvcmtpbmdTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvcGxheWVyQm93U2hvdFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9wcm9maWxpbmdTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvcmFnZG9sbFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9yZW1vdGVTZXJ2ZXIudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zZW5kSW5wdXRzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NldHRpbmdzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NpbmdsZVBsYXllclNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9za3ltcENsaWVudC50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3NwU25pcHBldFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zcFZlcnNpb25DaGVja1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeU5pY2tuYW1lc1NlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3RpbWVTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc2VydmljZXMvdGltZXJzU2VydmljZS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3NlcnZpY2VzL3NlcnZpY2VzL3ZvaWNlQ2hhdFNlcnZpY2UudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zZXJ2aWNlcy9zZXJ2aWNlcy93b3JsZENsZWFuZXJTZXJ2aWNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc2VydmljZXMvc3BBcGlJbnRlcmFjdG9yLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9hY3RvcnZhbHVlcy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvYW5pbWF0aW9uLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9hcHBlYXJhbmNlLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvc3luYy9lcXVpcG1lbnQudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL2ludmVudG9yeS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvbW92ZW1lbnRBcHBseS50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3N5bmMvbW92ZW1lbnRHZXQudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy9zeW5jL3NwZWxsLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmVyc2lvbi50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvZm9ybVZpZXcudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L2Zvcm1WaWV3QXJyYXkudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L2hvc3RBdHRlbXB0cy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvbW9kZWxBcHBseVV0aWxzLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy9wbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLnRzIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvLi9zcmMvdmlldy9zcGF3blByb2Nlc3MudHMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL3NyYy92aWV3L3dvcmxkVmlldy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL3ZpZXcvd29ybGRWaWV3TWlzYy50cyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L2V4dGVybmFsIG5vZGUtY29tbW9uanMgXCJjcnlwdG9cIiIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L2V4dGVybmFsIG5vZGUtY29tbW9uanMgXCJmc1wiIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvZXh0ZXJuYWwgbm9kZS1jb21tb25qcyBcImluc3BlY3RvclwiIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvZXh0ZXJuYWwgbm9kZS1jb21tb25qcyBcIm5vZGU6Y3J5cHRvXCIiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC9leHRlcm5hbCB2YXIgW1wic2t5cmltUGxhdGZvcm1cIl0iLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC8uL25vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4Lm1qcyIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50L3dlYnBhY2svYm9vdHN0cmFwIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvd2VicGFjay9ydW50aW1lL2NvbXBhdCBnZXQgZGVmYXVsdCBleHBvcnQiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC93ZWJwYWNrL3J1bnRpbWUvZGVmaW5lIHByb3BlcnR5IGdldHRlcnMiLCJ3ZWJwYWNrOi8vc2t5bXA1LWNsaWVudC93ZWJwYWNrL3J1bnRpbWUvaGFzT3duUHJvcGVydHkgc2hvcnRoYW5kIiwid2VicGFjazovL3NreW1wNS1jbGllbnQvd2VicGFjay9ydW50aW1lL21ha2UgbmFtZXNwYWNlIG9iamVjdCIsIndlYnBhY2s6Ly9za3ltcDUtY2xpZW50Ly4vc3JjL2luZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIGhhcyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHlcbiAgLCBwcmVmaXggPSAnfic7XG5cbi8qKlxuICogQ29uc3RydWN0b3IgdG8gY3JlYXRlIGEgc3RvcmFnZSBmb3Igb3VyIGBFRWAgb2JqZWN0cy5cbiAqIEFuIGBFdmVudHNgIGluc3RhbmNlIGlzIGEgcGxhaW4gb2JqZWN0IHdob3NlIHByb3BlcnRpZXMgYXJlIGV2ZW50IG5hbWVzLlxuICpcbiAqIEBjb25zdHJ1Y3RvclxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gRXZlbnRzKCkge31cblxuLy9cbi8vIFdlIHRyeSB0byBub3QgaW5oZXJpdCBmcm9tIGBPYmplY3QucHJvdG90eXBlYC4gSW4gc29tZSBlbmdpbmVzIGNyZWF0aW5nIGFuXG4vLyBpbnN0YW5jZSBpbiB0aGlzIHdheSBpcyBmYXN0ZXIgdGhhbiBjYWxsaW5nIGBPYmplY3QuY3JlYXRlKG51bGwpYCBkaXJlY3RseS5cbi8vIElmIGBPYmplY3QuY3JlYXRlKG51bGwpYCBpcyBub3Qgc3VwcG9ydGVkIHdlIHByZWZpeCB0aGUgZXZlbnQgbmFtZXMgd2l0aCBhXG4vLyBjaGFyYWN0ZXIgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIGJ1aWx0LWluIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSBub3Rcbi8vIG92ZXJyaWRkZW4gb3IgdXNlZCBhcyBhbiBhdHRhY2sgdmVjdG9yLlxuLy9cbmlmIChPYmplY3QuY3JlYXRlKSB7XG4gIEV2ZW50cy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gIC8vXG4gIC8vIFRoaXMgaGFjayBpcyBuZWVkZWQgYmVjYXVzZSB0aGUgYF9fcHJvdG9fX2AgcHJvcGVydHkgaXMgc3RpbGwgaW5oZXJpdGVkIGluXG4gIC8vIHNvbWUgb2xkIGJyb3dzZXJzIGxpa2UgQW5kcm9pZCA0LCBpUGhvbmUgNS4xLCBPcGVyYSAxMSBhbmQgU2FmYXJpIDUuXG4gIC8vXG4gIGlmICghbmV3IEV2ZW50cygpLl9fcHJvdG9fXykgcHJlZml4ID0gZmFsc2U7XG59XG5cbi8qKlxuICogUmVwcmVzZW50YXRpb24gb2YgYSBzaW5nbGUgZXZlbnQgbGlzdGVuZXIuXG4gKlxuICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLlxuICogQHBhcmFtIHsqfSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC5cbiAqIEBwYXJhbSB7Qm9vbGVhbn0gW29uY2U9ZmFsc2VdIFNwZWNpZnkgaWYgdGhlIGxpc3RlbmVyIGlzIGEgb25lLXRpbWUgbGlzdGVuZXIuXG4gKiBAY29uc3RydWN0b3JcbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIEVFKGZuLCBjb250ZXh0LCBvbmNlKSB7XG4gIHRoaXMuZm4gPSBmbjtcbiAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcbiAgdGhpcy5vbmNlID0gb25jZSB8fCBmYWxzZTtcbn1cblxuLyoqXG4gKiBBZGQgYSBsaXN0ZW5lciBmb3IgYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0ge0V2ZW50RW1pdHRlcn0gZW1pdHRlciBSZWZlcmVuY2UgdG8gdGhlIGBFdmVudEVtaXR0ZXJgIGluc3RhbmNlLlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLlxuICogQHBhcmFtIHsqfSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC5cbiAqIEBwYXJhbSB7Qm9vbGVhbn0gb25jZSBTcGVjaWZ5IGlmIHRoZSBsaXN0ZW5lciBpcyBhIG9uZS10aW1lIGxpc3RlbmVyLlxuICogQHJldHVybnMge0V2ZW50RW1pdHRlcn1cbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIGFkZExpc3RlbmVyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkge1xuICBpZiAodHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpO1xuICB9XG5cbiAgdmFyIGxpc3RlbmVyID0gbmV3IEVFKGZuLCBjb250ZXh0IHx8IGVtaXR0ZXIsIG9uY2UpXG4gICAgLCBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50O1xuXG4gIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIsIGVtaXR0ZXIuX2V2ZW50c0NvdW50Kys7XG4gIGVsc2UgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XS5mbikgZW1pdHRlci5fZXZlbnRzW2V2dF0ucHVzaChsaXN0ZW5lcik7XG4gIGVsc2UgZW1pdHRlci5fZXZlbnRzW2V2dF0gPSBbZW1pdHRlci5fZXZlbnRzW2V2dF0sIGxpc3RlbmVyXTtcblxuICByZXR1cm4gZW1pdHRlcjtcbn1cblxuLyoqXG4gKiBDbGVhciBldmVudCBieSBuYW1lLlxuICpcbiAqIEBwYXJhbSB7RXZlbnRFbWl0dGVyfSBlbWl0dGVyIFJlZmVyZW5jZSB0byB0aGUgYEV2ZW50RW1pdHRlcmAgaW5zdGFuY2UuXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZ0IFRoZSBFdmVudCBuYW1lLlxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gY2xlYXJFdmVudChlbWl0dGVyLCBldnQpIHtcbiAgaWYgKC0tZW1pdHRlci5fZXZlbnRzQ291bnQgPT09IDApIGVtaXR0ZXIuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTtcbiAgZWxzZSBkZWxldGUgZW1pdHRlci5fZXZlbnRzW2V2dF07XG59XG5cbi8qKlxuICogTWluaW1hbCBgRXZlbnRFbWl0dGVyYCBpbnRlcmZhY2UgdGhhdCBpcyBtb2xkZWQgYWdhaW5zdCB0aGUgTm9kZS5qc1xuICogYEV2ZW50RW1pdHRlcmAgaW50ZXJmYWNlLlxuICpcbiAqIEBjb25zdHJ1Y3RvclxuICogQHB1YmxpY1xuICovXG5mdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7XG4gIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTtcbiAgdGhpcy5fZXZlbnRzQ291bnQgPSAwO1xufVxuXG4vKipcbiAqIFJldHVybiBhbiBhcnJheSBsaXN0aW5nIHRoZSBldmVudHMgZm9yIHdoaWNoIHRoZSBlbWl0dGVyIGhhcyByZWdpc3RlcmVkXG4gKiBsaXN0ZW5lcnMuXG4gKlxuICogQHJldHVybnMge0FycmF5fVxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLmV2ZW50TmFtZXMgPSBmdW5jdGlvbiBldmVudE5hbWVzKCkge1xuICB2YXIgbmFtZXMgPSBbXVxuICAgICwgZXZlbnRzXG4gICAgLCBuYW1lO1xuXG4gIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzO1xuXG4gIGZvciAobmFtZSBpbiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzKSkge1xuICAgIGlmIChoYXMuY2FsbChldmVudHMsIG5hbWUpKSBuYW1lcy5wdXNoKHByZWZpeCA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lKTtcbiAgfVxuXG4gIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7XG4gICAgcmV0dXJuIG5hbWVzLmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGV2ZW50cykpO1xuICB9XG5cbiAgcmV0dXJuIG5hbWVzO1xufTtcblxuLyoqXG4gKiBSZXR1cm4gdGhlIGxpc3RlbmVycyByZWdpc3RlcmVkIGZvciBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEByZXR1cm5zIHtBcnJheX0gVGhlIHJlZ2lzdGVyZWQgbGlzdGVuZXJzLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudCkge1xuICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudFxuICAgICwgaGFuZGxlcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTtcblxuICBpZiAoIWhhbmRsZXJzKSByZXR1cm4gW107XG4gIGlmIChoYW5kbGVycy5mbikgcmV0dXJuIFtoYW5kbGVycy5mbl07XG5cbiAgZm9yICh2YXIgaSA9IDAsIGwgPSBoYW5kbGVycy5sZW5ndGgsIGVlID0gbmV3IEFycmF5KGwpOyBpIDwgbDsgaSsrKSB7XG4gICAgZWVbaV0gPSBoYW5kbGVyc1tpXS5mbjtcbiAgfVxuXG4gIHJldHVybiBlZTtcbn07XG5cbi8qKlxuICogUmV0dXJuIHRoZSBudW1iZXIgb2YgbGlzdGVuZXJzIGxpc3RlbmluZyB0byBhIGdpdmVuIGV2ZW50LlxuICpcbiAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS5cbiAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBudW1iZXIgb2YgbGlzdGVuZXJzLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7XG4gIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50XG4gICAgLCBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTtcblxuICBpZiAoIWxpc3RlbmVycykgcmV0dXJuIDA7XG4gIGlmIChsaXN0ZW5lcnMuZm4pIHJldHVybiAxO1xuICByZXR1cm4gbGlzdGVuZXJzLmxlbmd0aDtcbn07XG5cbi8qKlxuICogQ2FsbHMgZWFjaCBvZiB0aGUgbGlzdGVuZXJzIHJlZ2lzdGVyZWQgZm9yIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHJldHVybnMge0Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgZXZlbnQgaGFkIGxpc3RlbmVycywgZWxzZSBgZmFsc2VgLlxuICogQHB1YmxpY1xuICovXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbiBlbWl0KGV2ZW50LCBhMSwgYTIsIGEzLCBhNCwgYTUpIHtcbiAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7XG5cbiAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIGZhbHNlO1xuXG4gIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XVxuICAgICwgbGVuID0gYXJndW1lbnRzLmxlbmd0aFxuICAgICwgYXJnc1xuICAgICwgaTtcblxuICBpZiAobGlzdGVuZXJzLmZuKSB7XG4gICAgaWYgKGxpc3RlbmVycy5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnMuZm4sIHVuZGVmaW5lZCwgdHJ1ZSk7XG5cbiAgICBzd2l0Y2ggKGxlbikge1xuICAgICAgY2FzZSAxOiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlO1xuICAgICAgY2FzZSAyOiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExKSwgdHJ1ZTtcbiAgICAgIGNhc2UgMzogcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlO1xuICAgICAgY2FzZSA0OiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlO1xuICAgICAgY2FzZSA1OiByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0KSwgdHJ1ZTtcbiAgICAgIGNhc2UgNjogcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlO1xuICAgIH1cblxuICAgIGZvciAoaSA9IDEsIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0xKTsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTtcbiAgICB9XG5cbiAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpO1xuICB9IGVsc2Uge1xuICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoXG4gICAgICAsIGo7XG5cbiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChsaXN0ZW5lcnNbaV0ub25jZSkgdGhpcy5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzW2ldLmZuLCB1bmRlZmluZWQsIHRydWUpO1xuXG4gICAgICBzd2l0Y2ggKGxlbikge1xuICAgICAgICBjYXNlIDE6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0KTsgYnJlYWs7XG4gICAgICAgIGNhc2UgMjogbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExKTsgYnJlYWs7XG4gICAgICAgIGNhc2UgMzogbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMik7IGJyZWFrO1xuICAgICAgICBjYXNlIDQ6IGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIsIGEzKTsgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgaWYgKCFhcmdzKSBmb3IgKGogPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtMSk7IGogPCBsZW47IGorKykge1xuICAgICAgICAgICAgYXJnc1tqIC0gMV0gPSBhcmd1bWVudHNbal07XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbi8qKlxuICogQWRkIGEgbGlzdGVuZXIgZm9yIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLlxuICogQHBhcmFtIHsqfSBbY29udGV4dD10aGlzXSBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguXG4gKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudCwgZm4sIGNvbnRleHQpIHtcbiAgcmV0dXJuIGFkZExpc3RlbmVyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgZmFsc2UpO1xufTtcblxuLyoqXG4gKiBBZGQgYSBvbmUtdGltZSBsaXN0ZW5lciBmb3IgYSBnaXZlbiBldmVudC5cbiAqXG4gKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgbGlzdGVuZXIgZnVuY3Rpb24uXG4gKiBAcGFyYW0geyp9IFtjb250ZXh0PXRoaXNdIFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC5cbiAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHtcbiAgcmV0dXJuIGFkZExpc3RlbmVyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgdHJ1ZSk7XG59O1xuXG4vKipcbiAqIFJlbW92ZSB0aGUgbGlzdGVuZXJzIG9mIGEgZ2l2ZW4gZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLlxuICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gT25seSByZW1vdmUgdGhlIGxpc3RlbmVycyB0aGF0IG1hdGNoIHRoaXMgZnVuY3Rpb24uXG4gKiBAcGFyYW0geyp9IGNvbnRleHQgT25seSByZW1vdmUgdGhlIGxpc3RlbmVycyB0aGF0IGhhdmUgdGhpcyBjb250ZXh0LlxuICogQHBhcmFtIHtCb29sZWFufSBvbmNlIE9ubHkgcmVtb3ZlIG9uZS10aW1lIGxpc3RlbmVycy5cbiAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC5cbiAqIEBwdWJsaWNcbiAqL1xuRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkge1xuICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDtcblxuICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gdGhpcztcbiAgaWYgKCFmbikge1xuICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTtcblxuICBpZiAobGlzdGVuZXJzLmZuKSB7XG4gICAgaWYgKFxuICAgICAgbGlzdGVuZXJzLmZuID09PSBmbiAmJlxuICAgICAgKCFvbmNlIHx8IGxpc3RlbmVycy5vbmNlKSAmJlxuICAgICAgKCFjb250ZXh0IHx8IGxpc3RlbmVycy5jb250ZXh0ID09PSBjb250ZXh0KVxuICAgICkge1xuICAgICAgY2xlYXJFdmVudCh0aGlzLCBldnQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBmb3IgKHZhciBpID0gMCwgZXZlbnRzID0gW10sIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgaWYgKFxuICAgICAgICBsaXN0ZW5lcnNbaV0uZm4gIT09IGZuIHx8XG4gICAgICAgIChvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSkgfHxcbiAgICAgICAgKGNvbnRleHQgJiYgbGlzdGVuZXJzW2ldLmNvbnRleHQgIT09IGNvbnRleHQpXG4gICAgICApIHtcbiAgICAgICAgZXZlbnRzLnB1c2gobGlzdGVuZXJzW2ldKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuICAgIC8vIFJlc2V0IHRoZSBhcnJheSwgb3IgcmVtb3ZlIGl0IGNvbXBsZXRlbHkgaWYgd2UgaGF2ZSBubyBtb3JlIGxpc3RlbmVycy5cbiAgICAvL1xuICAgIGlmIChldmVudHMubGVuZ3RoKSB0aGlzLl9ldmVudHNbZXZ0XSA9IGV2ZW50cy5sZW5ndGggPT09IDEgPyBldmVudHNbMF0gOiBldmVudHM7XG4gICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7XG4gIH1cblxuICByZXR1cm4gdGhpcztcbn07XG5cbi8qKlxuICogUmVtb3ZlIGFsbCBsaXN0ZW5lcnMsIG9yIHRob3NlIG9mIHRoZSBzcGVjaWZpZWQgZXZlbnQuXG4gKlxuICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IFtldmVudF0gVGhlIGV2ZW50IG5hbWUuXG4gKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuXG4gKiBAcHVibGljXG4gKi9cbkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7XG4gIHZhciBldnQ7XG5cbiAgaWYgKGV2ZW50KSB7XG4gICAgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDtcbiAgICBpZiAodGhpcy5fZXZlbnRzW2V2dF0pIGNsZWFyRXZlbnQodGhpcywgZXZ0KTtcbiAgfSBlbHNlIHtcbiAgICB0aGlzLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7XG4gICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwO1xuICB9XG5cbiAgcmV0dXJuIHRoaXM7XG59O1xuXG4vL1xuLy8gQWxpYXMgbWV0aG9kcyBuYW1lcyBiZWNhdXNlIHBlb3BsZSByb2xsIGxpa2UgdGhhdC5cbi8vXG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLm9mZiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXI7XG5FdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbjtcblxuLy9cbi8vIEV4cG9zZSB0aGUgcHJlZml4LlxuLy9cbkV2ZW50RW1pdHRlci5wcmVmaXhlZCA9IHByZWZpeDtcblxuLy9cbi8vIEFsbG93IGBFdmVudEVtaXR0ZXJgIHRvIGJlIGltcG9ydGVkIGFzIG1vZHVsZSBuYW1lc3BhY2UuXG4vL1xuRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjtcblxuLy9cbi8vIEV4cG9zZSB0aGUgbW9kdWxlLlxuLy9cbmlmICgndW5kZWZpbmVkJyAhPT0gdHlwZW9mIG1vZHVsZSkge1xuICBtb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjtcbn1cbiIsInZhciBGb3JtVHlwZUV4ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gRm9ybVR5cGVFeCgpIHtcclxuICAgIH1cclxuICAgIEZvcm1UeXBlRXguaXNJdGVtID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gdHlwZSA9PT0gNDIgLyogRm9ybVR5cGUuQW1tbyAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAyNiAvKiBGb3JtVHlwZS5Bcm1vciAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSAyNyAvKiBGb3JtVHlwZS5Cb29rICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDMwIC8qIEZvcm1UeXBlLkluZ3JlZGllbnQgKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMzEgLyogRm9ybVR5cGUuTGlnaHQgKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gNDYgLyogRm9ybVR5cGUuUG90aW9uICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDIzIC8qIEZvcm1UeXBlLlNjcm9sbEl0ZW0gKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gNTIgLyogRm9ybVR5cGUuU291bEdlbSAqLyB8fFxyXG4gICAgICAgICAgICB0eXBlID09PSA0MSAvKiBGb3JtVHlwZS5XZWFwb24gKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gMzIgLyogRm9ybVR5cGUuTWlzYyAqLztcclxuICAgIH07XHJcbiAgICByZXR1cm4gRm9ybVR5cGVFeDtcclxufSgpKTtcclxuZXhwb3J0IHsgRm9ybVR5cGVFeCB9O1xyXG4iLCJpbXBvcnQgeyBGbG9yYSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBGb3JtVHlwZUV4IH0gZnJvbSBcIi4vZm9ybVR5cGVFeFwiO1xyXG52YXIgT2JqZWN0UmVmZXJlbmNlRXggPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBPYmplY3RSZWZlcmVuY2VFeCgpIHtcclxuICAgIH1cclxuICAgIE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsID0gZnVuY3Rpb24gKHNlbGYpIHtcclxuICAgICAgICB2YXIgd29ybGQgPSBzZWxmLmdldFdvcmxkU3BhY2UoKTtcclxuICAgICAgICBpZiAod29ybGQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHdvcmxkLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgY2VsbCA9IHNlbGYuZ2V0UGFyZW50Q2VsbCgpO1xyXG4gICAgICAgIGlmIChjZWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjZWxsLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gMDtcclxuICAgIH07XHJcbiAgICBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MgPSBmdW5jdGlvbiAoc2VsZikge1xyXG4gICAgICAgIHJldHVybiBbc2VsZi5nZXRQb3NpdGlvblgoKSwgc2VsZi5nZXRQb3NpdGlvblkoKSwgc2VsZi5nZXRQb3NpdGlvblooKV07XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgT2JqZWN0UmVmZXJlbmNlRXguZ2V0RGlzdGFuY2UgPSBmdW5jdGlvbiAoYSwgYikge1xyXG4gICAgICAgIHZhciBkZWx0YVggPSBhWzBdIC0gYlswXTtcclxuICAgICAgICB2YXIgZGVsdGFZID0gYVsxXSAtIGJbMV07XHJcbiAgICAgICAgdmFyIGRlbHRhWiA9IGFbMl0gLSBiWzJdO1xyXG4gICAgICAgIHJldHVybiBNYXRoLnNxcnQoZGVsdGFYICogZGVsdGFYICsgZGVsdGFZICogZGVsdGFZICsgZGVsdGFaICogZGVsdGFaKTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZU5vWiA9IGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgdmFyIGRlbHRhWCA9IGFbMF0gLSBiWzBdO1xyXG4gICAgICAgIHZhciBkZWx0YVkgPSBhWzFdIC0gYlsxXTtcclxuICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KGRlbHRhWCAqIGRlbHRhWCArIGRlbHRhWSAqIGRlbHRhWSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgT2JqZWN0UmVmZXJlbmNlRXguZGVhbFdpdGhSZWYgPSBmdW5jdGlvbiAoc2VsZiwgYmFzZSkge1xyXG4gICAgICAgIHZhciBfYSwgX2I7XHJcbiAgICAgICAgdmFyIHQgPSBiYXNlLmdldFR5cGUoKTtcclxuICAgICAgICB2YXIgaXNJdGVtID0gRm9ybVR5cGVFeC5pc0l0ZW0odCk7XHJcbiAgICAgICAgLy8gQmxhY2tGYWxsc0JhcnJvdzAyLCBkb29yIGlzbid0IG9wZW5pbmcgdmlhIFNldE9wZW4gc28gd2UncmUgaGFja2luZyBpdC5cclxuICAgICAgICAvLyBOb3QgYmxvY2tpbmcgYWN0aXZhdGlvbiAmIGFza2luZyBwYXJlbnQgdG8gYWN0aXZhdGUgdW50aWwgd2lsbCBiZSBpbiB0aGUgY29ycmVjdCBzdGF0ZVxyXG4gICAgICAgIC8vIFNlZSBhbHNvIG1vZGVsQXBwbHlVdGlscy50c1xyXG4gICAgICAgIHZhciBjYXZlR1NlY3JldERvb3IwMSA9IDB4NmY3MDM7XHJcbiAgICAgICAgLy8gWW91IGNhbiBhbHNvIGJsb2NrIGZvciB0ID09PSBGb3JtVHlwZS5GbG9yYSB8fCB0ID09PSBGb3JtVHlwZS5UcmVlLCBidXQgSSBkb24ndCB0aGluayBpdCdzIG5lY2Vzc2FyeS5cclxuICAgICAgICBpZiAodCA9PT0gNDAgLyogRm9ybVR5cGUuRnVybml0dXJlICovXHJcbiAgICAgICAgICAgIHx8IHQgPT09IDI0IC8qIEZvcm1UeXBlLkFjdGl2YXRvciAqL1xyXG4gICAgICAgICAgICB8fCB0ID09PSAyOCAvKiBGb3JtVHlwZS5Db250YWluZXIgKi9cclxuICAgICAgICAgICAgfHwgaXNJdGVtXHJcbiAgICAgICAgICAgIHx8IHQgPT09IDQzIC8qIEZvcm1UeXBlLk5QQyAqL1xyXG4gICAgICAgICAgICB8fCAodCA9PT0gMjkgLyogRm9ybVR5cGUuRG9vciAqLyAmJiAoKF9hID0gc2VsZi5nZXRCYXNlT2JqZWN0KCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGb3JtSUQoKSkgIT09IGNhdmVHU2VjcmV0RG9vcjAxKSkge1xyXG4gICAgICAgICAgICBzZWxmLmJsb2NrQWN0aXZhdGlvbih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHNlbGYuYmxvY2tBY3RpdmF0aW9uKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNlbGYuaXNMb2NrZWQoKSkge1xyXG4gICAgICAgICAgICBzZWxmLmxvY2soZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlzSXRlbSkge1xyXG4gICAgICAgICAgICBzZWxmLnNldE1vdGlvblR5cGUoNCAvKiBNb3Rpb25UeXBlLktleWZyYW1lZCAqLywgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vc2t5cmltLW11bHRpcGxheWVyL2lzc3VlLXRyYWNrZXIvaXNzdWVzLzM2XHJcbiAgICAgICAgaWYgKHQgPT09IDM5IC8qIEZvcm1UeXBlLkZsb3JhICovICYmICgoX2IgPSBGbG9yYS5mcm9tKGJhc2UpKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZ2V0SW5ncmVkaWVudCgpKSkge1xyXG4gICAgICAgICAgICBzZWxmLnNldE1vdGlvblR5cGUoNCAvKiBNb3Rpb25UeXBlLktleWZyYW1lZCAqLywgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gT2JqZWN0UmVmZXJlbmNlRXg7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IE9iamVjdFJlZmVyZW5jZUV4IH07XHJcbiIsIjtcclxuO1xyXG47XHJcbmV4cG9ydCB2YXIgYXV0aEdhbWVEYXRhU3RvcmFnZUtleSA9IFwiYXV0aEdhbWVEYXRhXCI7XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgUmVzcGF3bk5lZWRlZEVycm9yID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFJlc3Bhd25OZWVkZWRFcnJvciwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFJlc3Bhd25OZWVkZWRFcnJvcihtZXNzYWdlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgbWVzc2FnZSkgfHwgdGhpcztcclxuICAgICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoX3RoaXMsIFJlc3Bhd25OZWVkZWRFcnJvci5wcm90b3R5cGUpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIHJldHVybiBSZXNwYXduTmVlZGVkRXJyb3I7XHJcbn0oRXJyb3IpKTtcclxuZXhwb3J0IHsgUmVzcGF3bk5lZWRlZEVycm9yIH07XHJcbnZhciBOZXZlckVycm9yID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKE5ldmVyRXJyb3IsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBOZXZlckVycm9yKG1lc3NhZ2UpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBcIk5ldmVyRXJyb3I6IFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShtZXNzYWdlKSkpIHx8IHRoaXM7XHJcbiAgICAgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKF90aGlzLCBOZXZlckVycm9yLnByb3RvdHlwZSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIE5ldmVyRXJyb3I7XHJcbn0oRXJyb3IpKTtcclxuZXhwb3J0IHsgTmV2ZXJFcnJvciB9O1xyXG4iLCJ2YXIgSWRNYW5hZ2VyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gSWRNYW5hZ2VyKCkge1xyXG4gICAgICAgIHRoaXMuaWRCeVZhbHVlID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgdGhpcy52YWx1ZUJ5SWQgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICB0aGlzLm1pbmltdW1VbnVzZWRJZCA9IDA7XHJcbiAgICB9XHJcbiAgICBJZE1hbmFnZXIucHJvdG90eXBlLmFsbG9jYXRlSWRGb3IgPSBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICBpZiAodGhpcy5pZEJ5VmFsdWUubGVuZ3RoIDw9IHZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaWRCeVZhbHVlLmxlbmd0aCA9IHZhbHVlICsgMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pZEJ5VmFsdWVbdmFsdWVdID0gdGhpcy5taW5pbXVtVW51c2VkSWQ7XHJcbiAgICAgICAgaWYgKHRoaXMudmFsdWVCeUlkLmxlbmd0aCA8PSB0aGlzLm1pbmltdW1VbnVzZWRJZCkge1xyXG4gICAgICAgICAgICB0aGlzLnZhbHVlQnlJZC5sZW5ndGggPSB0aGlzLm1pbmltdW1VbnVzZWRJZCArIDE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudmFsdWVCeUlkW3RoaXMubWluaW11bVVudXNlZElkXSA9IHZhbHVlO1xyXG4gICAgICAgIHZhciByZXMgPSB0aGlzLm1pbmltdW1VbnVzZWRJZDtcclxuICAgICAgICB0aGlzLm1pbmltdW1VbnVzZWRJZCsrO1xyXG4gICAgICAgIHdoaWxlICh0aGlzLnZhbHVlQnlJZC5sZW5ndGggPiB0aGlzLm1pbmltdW1VbnVzZWRJZCAmJlxyXG4gICAgICAgICAgICB0eXBlb2YgdGhpcy52YWx1ZUJ5SWRbdGhpcy5taW5pbXVtVW51c2VkSWRdID09PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWluaW11bVVudXNlZElkKys7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9O1xyXG4gICAgSWRNYW5hZ2VyLnByb3RvdHlwZS5mcmVlSWRGb3IgPSBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICB2YXIgaWQgPSB0aGlzLmlkQnlWYWx1ZVt2YWx1ZV07XHJcbiAgICAgICAgaWYgKGlkIDwgdGhpcy5taW5pbXVtVW51c2VkSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5taW5pbXVtVW51c2VkSWQgPSBpZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pZEJ5VmFsdWVbdmFsdWVdID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHRoaXMudmFsdWVCeUlkW2lkXSA9IHVuZGVmaW5lZDtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9O1xyXG4gICAgSWRNYW5hZ2VyLnByb3RvdHlwZS5nZXRJZCA9IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgIHZhciByID0gdGhpcy5pZEJ5VmFsdWVbdmFsdWVdO1xyXG4gICAgICAgIHJldHVybiB0eXBlb2YgciA9PT0gXCJudW1iZXJcIiA/IHIgOiAtMTtcclxuICAgIH07XHJcbiAgICBJZE1hbmFnZXIucHJvdG90eXBlLmdldFZhbHVlQnlJZCA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnZhbHVlQnlJZFtpZF07XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIElkTWFuYWdlcjtcclxufSgpKTtcclxuZXhwb3J0IHsgSWRNYW5hZ2VyIH07XHJcbiIsImV4cG9ydCBmdW5jdGlvbiBuYW1lb2Yoa2V5KSB7XHJcbiAgICByZXR1cm4ga2V5O1xyXG59XHJcbiIsInZhciBfX3NwcmVhZEFycmF5ID0gKHRoaXMgJiYgdGhpcy5fX3NwcmVhZEFycmF5KSB8fCBmdW5jdGlvbiAodG8sIGZyb20sIHBhY2spIHtcclxuICAgIGlmIChwYWNrIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIGZvciAodmFyIGkgPSAwLCBsID0gZnJvbS5sZW5ndGgsIGFyOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKGFyIHx8ICEoaSBpbiBmcm9tKSkge1xyXG4gICAgICAgICAgICBpZiAoIWFyKSBhciA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGZyb20sIDAsIGkpO1xyXG4gICAgICAgICAgICBhcltpXSA9IGZyb21baV07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRvLmNvbmNhdChhciB8fCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChmcm9tKSk7XHJcbn07XHJcbmltcG9ydCB7IHByaW50Q29uc29sZSB9IGZyb20gXCJAc2t5cmltLXBsYXRmb3JtL3NreXJpbS1wbGF0Zm9ybVwiO1xyXG4vLyBUT0RPOiByZWRpcmVjdCB0aGlzIHRvIHNwZGxvZ1xyXG5leHBvcnQgZnVuY3Rpb24gbG9nRXJyb3Ioc2VydmljZSkge1xyXG4gICAgdmFyIHJlc3QgPSBbXTtcclxuICAgIGZvciAodmFyIF9pID0gMTsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgcmVzdFtfaSAtIDFdID0gYXJndW1lbnRzW19pXTtcclxuICAgIH1cclxuICAgIHZhciByZXN0UHJvY2Vzc2VkID0gcmVzdC5tYXAoZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtLnN0YWNrIHx8IGl0ZW0ubWVzc2FnZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGl0ZW07XHJcbiAgICB9KTtcclxuICAgIHByaW50Q29uc29sZS5hcHBseSh2b2lkIDAsIF9fc3ByZWFkQXJyYXkoW1wiRXJyb3IgaW4gXCIuY29uY2F0KHR5cGVvZiBzZXJ2aWNlICE9PSBcInN0cmluZ1wiID8gc2VydmljZS5jb25zdHJ1Y3Rvci5uYW1lIDogc2VydmljZSwgXCI6XCIpXSwgcmVzdFByb2Nlc3NlZCwgZmFsc2UpKTtcclxufVxyXG4vLyBUT0RPOiByZWRpcmVjdCB0aGlzIHRvIHNwZGxvZ1xyXG5leHBvcnQgZnVuY3Rpb24gbG9nVHJhY2Uoc2VydmljZSkge1xyXG4gICAgdmFyIHJlc3QgPSBbXTtcclxuICAgIGZvciAodmFyIF9pID0gMTsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgcmVzdFtfaSAtIDFdID0gYXJndW1lbnRzW19pXTtcclxuICAgIH1cclxuICAgIHZhciByZXN0UHJvY2Vzc2VkID0gcmVzdC5tYXAoZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtLnN0YWNrIHx8IGl0ZW0ubWVzc2FnZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGl0ZW07XHJcbiAgICB9KTtcclxuICAgIHByaW50Q29uc29sZS5hcHBseSh2b2lkIDAsIF9fc3ByZWFkQXJyYXkoW1wiVHJhY2UgaW4gXCIuY29uY2F0KHR5cGVvZiBzZXJ2aWNlICE9PSBcInN0cmluZ1wiID8gc2VydmljZS5jb25zdHJ1Y3Rvci5uYW1lIDogc2VydmljZSwgXCI6XCIpXSwgcmVzdFByb2Nlc3NlZCwgZmFsc2UpKTtcclxufVxyXG4iLCJleHBvcnQgdmFyIE1zZ1R5cGU7XHJcbihmdW5jdGlvbiAoTXNnVHlwZSkge1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQ3VzdG9tUGFja2V0XCJdID0gMV0gPSBcIkN1c3RvbVBhY2tldFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlTW92ZW1lbnRcIl0gPSAyXSA9IFwiVXBkYXRlTW92ZW1lbnRcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZUFuaW1hdGlvblwiXSA9IDNdID0gXCJVcGRhdGVBbmltYXRpb25cIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZUFwcGVhcmFuY2VcIl0gPSA0XSA9IFwiVXBkYXRlQXBwZWFyYW5jZVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlRXF1aXBtZW50XCJdID0gNV0gPSBcIlVwZGF0ZUVxdWlwbWVudFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQWN0aXZhdGVcIl0gPSA2XSA9IFwiQWN0aXZhdGVcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZVByb3BlcnR5XCJdID0gN10gPSBcIlVwZGF0ZVByb3BlcnR5XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJQdXRJdGVtXCJdID0gOF0gPSBcIlB1dEl0ZW1cIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlRha2VJdGVtXCJdID0gOV0gPSBcIlRha2VJdGVtXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJGaW5pc2hTcFNuaXBwZXRcIl0gPSAxMF0gPSBcIkZpbmlzaFNwU25pcHBldFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiT25FcXVpcFwiXSA9IDExXSA9IFwiT25FcXVpcFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQ29uc29sZUNvbW1hbmRcIl0gPSAxMl0gPSBcIkNvbnNvbGVDb21tYW5kXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJDcmFmdEl0ZW1cIl0gPSAxM10gPSBcIkNyYWZ0SXRlbVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiSG9zdFwiXSA9IDE0XSA9IFwiSG9zdFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiQ3VzdG9tRXZlbnRcIl0gPSAxNV0gPSBcIkN1c3RvbUV2ZW50XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJDaGFuZ2VWYWx1ZXNcIl0gPSAxNl0gPSBcIkNoYW5nZVZhbHVlc1wiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiT25IaXRcIl0gPSAxN10gPSBcIk9uSGl0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJEZWF0aFN0YXRlQ29udGFpbmVyXCJdID0gMThdID0gXCJEZWF0aFN0YXRlQ29udGFpbmVyXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJEcm9wSXRlbVwiXSA9IDE5XSA9IFwiRHJvcEl0ZW1cIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlRlbGVwb3J0XCJdID0gMjBdID0gXCJUZWxlcG9ydFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiT3BlbkNvbnRhaW5lclwiXSA9IDIxXSA9IFwiT3BlbkNvbnRhaW5lclwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiUGxheWVyQm93U2hvdFwiXSA9IDIyXSA9IFwiUGxheWVyQm93U2hvdFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiU3BlbGxDYXN0XCJdID0gMjNdID0gXCJTcGVsbENhc3RcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlVwZGF0ZUFuaW1WYXJpYWJsZXNcIl0gPSAyNF0gPSBcIlVwZGF0ZUFuaW1WYXJpYWJsZXNcIjtcclxuICAgIC8vIGV4LXN0cmluZ3NcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkRlc3Ryb3lBY3RvclwiXSA9IDI1XSA9IFwiRGVzdHJveUFjdG9yXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJIb3N0U3RhcnRcIl0gPSAyNl0gPSBcIkhvc3RTdGFydFwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiSG9zdFN0b3BcIl0gPSAyN10gPSBcIkhvc3RTdG9wXCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJTZXRJbnZlbnRvcnlcIl0gPSAyOF0gPSBcIlNldEludmVudG9yeVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiU2V0UmFjZU1lbnVPcGVuXCJdID0gMjldID0gXCJTZXRSYWNlTWVudU9wZW5cIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIlNwU25pcHBldFwiXSA9IDMwXSA9IFwiU3BTbmlwcGV0XCI7XHJcbiAgICBNc2dUeXBlW01zZ1R5cGVbXCJUZWxlcG9ydDJcIl0gPSAzMV0gPSBcIlRlbGVwb3J0MlwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlR2FtZW1vZGVEYXRhXCJdID0gMzJdID0gXCJVcGRhdGVHYW1lbW9kZURhdGFcIjtcclxuICAgIE1zZ1R5cGVbTXNnVHlwZVtcIkNyZWF0ZUFjdG9yXCJdID0gMzNdID0gXCJDcmVhdGVBY3RvclwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVm9pY2VDaGF0TWVzc2FnZVwiXSA9IDM0XSA9IFwiVm9pY2VDaGF0TWVzc2FnZVwiO1xyXG4gICAgTXNnVHlwZVtNc2dUeXBlW1wiVXBkYXRlVm9pY2VDaGF0TWVzc2FnZVwiXSA9IDM1XSA9IFwiVXBkYXRlVm9pY2VDaGF0TWVzc2FnZVwiO1xyXG59KShNc2dUeXBlIHx8IChNc2dUeXBlID0ge30pKTtcclxuIiwiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50ZW1pdHRlcjNcIjtcclxudmFyIEV2ZW50RW1pdHRlckZhY3RvcnkgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBFdmVudEVtaXR0ZXJGYWN0b3J5KCkge1xyXG4gICAgfVxyXG4gICAgRXZlbnRFbWl0dGVyRmFjdG9yeS5tYWtlRXZlbnRFbWl0dGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiAobmV3IEV2ZW50RW1pdHRlcigpKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gRXZlbnRFbWl0dGVyRmFjdG9yeTtcclxufSgpKTtcclxuZXhwb3J0IHsgRXZlbnRFbWl0dGVyRmFjdG9yeSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGdldEludmVudG9yeSB9IGZyb20gXCIuLi8uLi9zeW5jL2ludmVudG9yeVwiO1xyXG4vLyBUT0RPOiByZWZhY3RvciB0aGlzIG91dFxyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgTGFzdEludlNlcnZpY2UgfSBmcm9tIFwiLi9sYXN0SW52U2VydmljZVwiO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgQWN0aXZhdGlvblNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQWN0aXZhdGlvblNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBBY3RpdmF0aW9uU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwiYWN0aXZhdGVcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQWN0aXZhdGUoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEFjdGl2YXRpb25TZXJ2aWNlLnByb3RvdHlwZS5vbkFjdGl2YXRlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgbGFzdEludlNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTGFzdEludlNlcnZpY2UpO1xyXG4gICAgICAgIGxhc3RJbnZTZXJ2aWNlLmxhc3RJbnYgPSBnZXRJbnZlbnRvcnkodGhpcy5zcC5HYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICB2YXIgY2FzdGVyID0gZS5jYXN0ZXIgPyBlLmNhc3Rlci5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0ID8gZS50YXJnZXQuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIGlmICghdGFyZ2V0IHx8ICFjYXN0ZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBBY3RvcnMgbmV2ZXIgaGF2ZSBub24tZmYgaWRzIGxvY2FsbHkgaW4gc2t5bXBcclxuICAgICAgICBpZiAoY2FzdGVyICE9PSAweDE0ICYmIGNhc3RlciA8IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0YXJnZXQgPSBsb2NhbElkVG9SZW1vdGVJZCh0YXJnZXQpO1xyXG4gICAgICAgIGlmICghdGFyZ2V0KSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsICdsb2NhbElkVG9SZW1vdGVJZCByZXR1cm5lZCAwICh0YXJnZXQpIGluIG9uKFxcJ2FjdGl2YXRlXFwnKScpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc3RlciA9IGxvY2FsSWRUb1JlbW90ZUlkKGNhc3Rlcik7XHJcbiAgICAgICAgaWYgKCFjYXN0ZXIpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgJ2xvY2FsSWRUb1JlbW90ZUlkIHJldHVybmVkIDAgKGNhc3RlcikgaW4gb24oXFwnYWN0aXZhdGVcXCcpJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG9wZW5TdGF0ZSA9IGUudGFyZ2V0LmdldE9wZW5TdGF0ZSgpO1xyXG4gICAgICAgIGlmIChvcGVuU3RhdGUgPT09IDIgLyogT3BlblN0YXRlLk9wZW5pbmcgKi8gfHwgb3BlblN0YXRlID09PSA0IC8qIE9wZW5TdGF0ZS5DbG9zaW5nICovKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiSWdub3JpbmcgYWN0aXZhdGlvbiBvZiBkb29yIGJlY2F1c2UgaXQncyBhbHJlYWR5IG9wZW5pbmcgb3IgY2xvc2luZ1wiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkFjdGl2YXRlLFxyXG4gICAgICAgICAgICAgICAgZGF0YTogeyBjYXN0ZXI6IGNhc3RlciwgdGFyZ2V0OiB0YXJnZXQsIGlzU2Vjb25kQWN0aXZhdGlvbjogZmFsc2UgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZW50IGFjdGl2YXRpb24gZm9yIGNhc3Rlcj1cIiwgY2FzdGVyLnRvU3RyaW5nKDE2KSwgXCJhbmQgdGFyZ2V0PVwiLCB0YXJnZXQudG9TdHJpbmcoMTYpKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gQWN0aXZhdGlvblNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQWN0aXZhdGlvblNlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIF9fYXNzaWduID0gKHRoaXMgJiYgdGhpcy5fX2Fzc2lnbikgfHwgZnVuY3Rpb24gKCkge1xyXG4gICAgX19hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uKHQpIHtcclxuICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHtcclxuICAgICAgICAgICAgcyA9IGFyZ3VtZW50c1tpXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKVxyXG4gICAgICAgICAgICAgICAgdFtwXSA9IHNbcF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0O1xyXG4gICAgfTtcclxuICAgIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG59O1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IHNldFRleHRTaXplIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbnZhciBwbGF5ZXJJZCA9IDB4MTQ7XHJcbnZhciBBbmltRGVidWdTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEFuaW1EZWJ1Z1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBBbmltRGVidWdTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuc2V0dGluZ3MgPSBfdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJhbmltRGVidWdcIl07XHJcbiAgICAgICAgLy8gY2xlYXIgcHJldmlvdXMgdGV4dHMgaW4gY2FzZSBvZiBob3RyZWxvYWRcclxuICAgICAgICBpZiAoX3RoaXMuc3Auc3RvcmFnZVtBbmltUXVldWVDb2xsZWN0aW9uLk5hbWVdICYmIF90aGlzLnNwLnN0b3JhZ2VbQW5pbVF1ZXVlQ29sbGVjdGlvbi5OYW1lXS5jbGVhclNQVGV4dCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJEZXN0cm95aW5nIG9sZCBBbmltUXVldWVDb2xsZWN0aW9uXCIpO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVtBbmltUXVldWVDb2xsZWN0aW9uLk5hbWVdLmNsZWFyU1BUZXh0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIkZhaWxlZCB0byBkZXN0cm95IG9sZCBBbmltUXVldWVDb2xsZWN0aW9uOlwiLCBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2VsZiA9IF90aGlzO1xyXG4gICAgICAgIF90aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkgeyB9LFxyXG4gICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5vblNlbmRBbmltYXRpb25FdmVudExlYXZlKGN0eCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCBwbGF5ZXJJZCwgcGxheWVySWQpO1xyXG4gICAgICAgIGlmICghX3RoaXMuc2V0dGluZ3MgfHwgIV90aGlzLnNldHRpbmdzLmlzQWN0aXZlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBfdGhpcztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKChfYSA9IF90aGlzLnNldHRpbmdzLnRleHRPdXRwdXQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pc0FjdGl2ZSkge1xyXG4gICAgICAgICAgICBfdGhpcy5xdWV1ZSA9IG5ldyBBbmltUXVldWVDb2xsZWN0aW9uKF90aGlzLnNwLCBfdGhpcy5zZXR0aW5ncyk7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbQW5pbVF1ZXVlQ29sbGVjdGlvbi5uYW1lXSA9IF90aGlzLnF1ZXVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBBbmltRGVidWdTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRBbmltYXRpb25FdmVudExlYXZlID0gZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgIGlmICh0aGlzLnF1ZXVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnF1ZXVlLnB1c2goY3R4LmFuaW1FdmVudE5hbWUsIGN0eC5hbmltYXRpb25TdWNjZWVkZWQgPyBhbmltYXRpb25TdWNjZWVkZWRUZXh0Q29sb3IgOiBhbmltYXRpb25Ob3RTdWNjZWVkZWRUZXh0Q29sb3IpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBBbmltRGVidWdTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEFuaW1EZWJ1Z1NlcnZpY2UgfTtcclxudmFyIGFuaW1hdGlvblN1Y2NlZWRlZFRleHRDb2xvciA9IFsyNTUsIDI1NSwgMjU1LCAxXTtcclxudmFyIGFuaW1hdGlvbk5vdFN1Y2NlZWRlZFRleHRDb2xvciA9IFsyNTUsIDAsIDAsIDFdO1xyXG52YXIgQW5pbVF1ZXVlQ29sbGVjdGlvbiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIEFuaW1RdWV1ZUNvbGxlY3Rpb24oc3AsIHNldHRpbmdzKSB7XHJcbiAgICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2Y7XHJcbiAgICAgICAgdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIHZhciBhcnJheUxlbmd0aCA9IChfYiA9IChfYSA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy50ZXh0T3V0cHV0KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuaXRlbUNvdW50KSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiA1O1xyXG4gICAgICAgIHZhciBzdGFydFBvcyA9IChfZCA9IChfYyA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy50ZXh0T3V0cHV0KSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Muc3RhcnRQb3MpICE9PSBudWxsICYmIF9kICE9PSB2b2lkIDAgPyBfZCA6IHsgeDogNjUwLCB5OiA2MDAgfTtcclxuICAgICAgICA7XHJcbiAgICAgICAgdmFyIHlQb3NEZWx0YSA9IChfZiA9IChfZSA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy50ZXh0T3V0cHV0KSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UueVBvc0RlbHRhKSAhPT0gbnVsbCAmJiBfZiAhPT0gdm9pZCAwID8gX2YgOiAzMjtcclxuICAgICAgICB2YXIgeSA9IHN0YXJ0UG9zLnk7XHJcbiAgICAgICAgdGhpcy5saXN0ID0gbmV3IEFycmF5KGFycmF5TGVuZ3RoKTtcclxuICAgICAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCBhcnJheUxlbmd0aDsgKytpZHgpIHtcclxuICAgICAgICAgICAgdGhpcy5saXN0W2lkeF0gPSB7IG5hbWU6IFwiXCIsIHRleHRJZDogc3AuY3JlYXRlVGV4dChzdGFydFBvcy54LCB5LCBcIlwiLCBhbmltYXRpb25TdWNjZWVkZWRUZXh0Q29sb3IpLCBjb2xvcjogYW5pbWF0aW9uU3VjY2VlZGVkVGV4dENvbG9yIH07XHJcbiAgICAgICAgICAgIHNldFRleHRTaXplKHRoaXMubGlzdFtpZHhdLnRleHRJZCwgMC41KTtcclxuICAgICAgICAgICAgeSArPSB5UG9zRGVsdGE7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgQW5pbVF1ZXVlQ29sbGVjdGlvbi5wcm90b3R5cGUuY2xlYXJTUFRleHQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAodGhpcy5saXN0Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7IHJldHVybiBfdGhpcy5zcC5kZXN0cm95VGV4dChpdGVtLnRleHRJZCk7IH0pO1xyXG4gICAgfTtcclxuICAgIEFuaW1RdWV1ZUNvbGxlY3Rpb24ucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiAoYW5pbU5hbWUsIGNvbG9yKSB7XHJcbiAgICAgICAgdmFyIHByZXZJdGVtID0gbnVsbDtcclxuICAgICAgICBmb3IgKHZhciBpZHggPSB0aGlzLmxpc3QubGVuZ3RoIC0gMTsgaWR4ID49IDA7IC0taWR4KSB7XHJcbiAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5saXN0W2lkeF07XHJcbiAgICAgICAgICAgIHByZXZJdGVtID0gX19hc3NpZ24oe30sIGl0ZW0pO1xyXG4gICAgICAgICAgICBpdGVtLm5hbWUgPSBhbmltTmFtZTtcclxuICAgICAgICAgICAgaXRlbS5jb2xvciA9IGNvbG9yO1xyXG4gICAgICAgICAgICB0aGlzLnNwLnNldFRleHRTdHJpbmcoaXRlbS50ZXh0SWQsIGl0ZW0ubmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc2V0VGV4dENvbG9yKGl0ZW0udGV4dElkLCBpdGVtLmNvbG9yKTtcclxuICAgICAgICAgICAgYW5pbU5hbWUgPSBwcmV2SXRlbS5uYW1lO1xyXG4gICAgICAgICAgICBjb2xvciA9IHByZXZJdGVtLmNvbG9yO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBBbmltUXVldWVDb2xsZWN0aW9uLk5hbWUgPSBcIkFuaW1RdWV1ZUNvbGxlY3Rpb25cIjtcclxuICAgIHJldHVybiBBbmltUXVldWVDb2xsZWN0aW9uO1xyXG59KCkpO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcclxuaW1wb3J0IHsgYXV0aEdhbWVEYXRhU3RvcmFnZUtleSB9IGZyb20gXCIuLi8uLi9mZWF0dXJlcy9hdXRoTW9kZWxcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBUaW1lcnNTZXJ2aWNlIH0gZnJvbSBcIi4vdGltZXJzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBOZXR3b3JraW5nU2VydmljZSB9IGZyb20gXCIuL25ldHdvcmtpbmdTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSBcIi4vc2V0dGluZ3NTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENoYXJhY3RlclNlbGVjdFNlcnZpY2UgfSBmcm9tIFwiLi9jaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlXCI7XHJcbi8vIERlZmluZSBhcyBtb2R1bGUtbGV2ZWwgdmFyaWFibGVzIGluc3RlYWQgb2YgZ2xvYmFsIGRlY2xhcmF0aW9uc1xyXG52YXIgd2luZG93ID0gZ2xvYmFsLndpbmRvdyB8fCBnbG9iYWxUaGlzLndpbmRvdyB8fCB7fTtcclxuLy8gQ29uc3RhbnRzIHVzZWQgb24gYm90aCBjbGllbnQgYW5kIGJyb3dzZXIgc2lkZSAoc2VlIGJyb3dzZXJzaWRlV2lkZ2V0U2V0dGVyKVxyXG52YXIgZXZlbnRzID0ge1xyXG4gICAgb3BlbkRpc2NvcmRPYXV0aDogJ29wZW5EaXNjb3JkT2F1dGgnLFxyXG4gICAgYXV0aEF0dGVtcHQ6ICdhdXRoQXR0ZW1wdEV2ZW50JyxcclxuICAgIG9wZW5HaXRodWI6ICdvcGVuR2l0aHViJyxcclxuICAgIG9wZW5QYXRyZW9uOiAnb3BlblBhdHJlb24nLFxyXG4gICAgY2xlYXJBdXRoRGF0YTogJ2NsZWFyQXV0aERhdGEnLFxyXG4gICAgdXBkYXRlUmVxdWlyZWQ6ICd1cGRhdGVSZXF1aXJlZCcsXHJcbiAgICBiYWNrVG9Mb2dpbjogJ2JhY2tUb0xvZ2luJyxcclxuICAgIGpvaW5EaXNjb3JkOiAnam9pbkRpc2NvcmQnLFxyXG4gICAgaGlkZUJyb3dzZXI6ICdoaWRlQnJvd3NlcicsXHJcbn07XHJcbi8vIFZhaWFibGVzIHVzZWQgb24gYm90aCBjbGllbnQgYW5kIGJyb3dzZXIgc2lkZSAoc2VlIGJyb3dzZXJzaWRlV2lkZ2V0U2V0dGVyKVxyXG52YXIgYnJvd3NlclN0YXRlID0ge1xyXG4gICAgY29tbWVudDogJycsXHJcbiAgICBmYWlsQ291bnQ6IDkwMDAsXHJcbiAgICBsb2dpbkZhaWxlZFJlYXNvbjogJycsXHJcbn07XHJcbnZhciBhdXRoRGF0YSA9IG51bGw7XHJcbnZhciBBdXRoU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhBdXRoU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEF1dGhTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmRlbmllZFdpZGdldFNldHRlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHdpZGdldCA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwiZm9ybVwiLFxyXG4gICAgICAgICAgICAgICAgaWQ6IDIsXHJcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIlVwZGF0ZSBBdmFpbGFibGVcIixcclxuICAgICAgICAgICAgICAgIGVsZW1lbnRzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJob29yYXkhIHVwZGF0ZSByZWxlYXNlZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogXCJkb3dubG9hZCBub3cgYXRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW11cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFwic2t5bXAubmV0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtdXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IFwib3BlbiBza3ltcC5uZXRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW1wiRUxFTUVOVF9TVFlMRV9NQVJHSU5fRVhURU5ERURcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLnVwZGF0ZVJlcXVpcmVkKTsgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGludDogXCJHbyB0byBkb3dubG9hZCBwYWdlXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cy5zZXQoW3dpZGdldF0pO1xyXG4gICAgICAgICAgICAvLyBNYWtlIHN1cmUgZ2FtZW1vZGUgd2lsbCBub3QgYmUgYWJsZSB0byB1cGRhdGUgd2lkZ2V0cyBhbnltb3JlXHJcbiAgICAgICAgICAgIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzID0gbnVsbDtcclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLmxvZ2luRmFpbGVkV2lkZ2V0U2V0dGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgc3BsaXRQYXJ0cyA9IGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbi5zcGxpdCgnXFxuJyk7XHJcbiAgICAgICAgICAgIHZhciB0ZXh0RWxlbWVudHMgPSBzcGxpdFBhcnRzLm1hcChmdW5jdGlvbiAocGFydCkgeyByZXR1cm4gKHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgdGV4dDogcGFydCxcclxuICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxyXG4gICAgICAgICAgICB9KTsgfSk7XHJcbiAgICAgICAgICAgIHZhciB3aWRnZXQgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImZvcm1cIixcclxuICAgICAgICAgICAgICAgIGlkOiAyLFxyXG4gICAgICAgICAgICAgICAgY2FwdGlvbjogXCJFcnJvclwiLFxyXG4gICAgICAgICAgICAgICAgZWxlbWVudHM6IG5ldyBBcnJheSgpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRleHRFbGVtZW50cy5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7IHJldHVybiB3aWRnZXQuZWxlbWVudHMucHVzaChlbGVtZW50KTsgfSk7XHJcbiAgICAgICAgICAgIGlmIChicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPT09ICdwbGVhc2Ugam9pbiB0aGUgZGlzY29yZCBzZXJ2ZXInKSB7XHJcbiAgICAgICAgICAgICAgICB3aWRnZXQuZWxlbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcIkpvaW4gU2VydmVyXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnczogW1wiRUxFTUVOVF9TVFlMRV9NQVJHSU5fRVhURU5ERURcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMuam9pbkRpc2NvcmQpOyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGhpbnQ6IG51bGxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHdpZGdldC5lbGVtZW50cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICB0ZXh0OiBcIkJhY2tcIixcclxuICAgICAgICAgICAgICAgIHRhZ3M6IFtcIkVMRU1FTlRfU1RZTEVfTUFSR0lOX0VYVEVOREVEXCJdLFxyXG4gICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMuYmFja1RvTG9naW4pOyB9LFxyXG4gICAgICAgICAgICAgICAgaGludDogdW5kZWZpbmVkXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAod2luZG93LnNreXJpbVBsYXRmb3JtICYmIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS53aWRnZXRzKSB7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cy5zZXQoW3dpZGdldF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5sb2dpbldpZGdldFNldHRlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy8gTm90ZTogaXNDb25uZWN0aW5nIGlzIGluamVjdGVkIHZpYSBnZXRUZXh0KCkgd3JhcHBlclxyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlIC0gaXNDb25uZWN0aW5nIGlzIHByb3ZpZGVkIGJ5IEZ1bmN0aW9uSW5mby5nZXRUZXh0KClcclxuICAgICAgICAgICAgdmFyIGNvbm5lY3RpbmcgPSBpc0Nvbm5lY3Rpbmc7XHJcbiAgICAgICAgICAgIHZhciBhdXRoRGF0YVVzZXJuYW1lID0gYXV0aERhdGEgPyAoYXV0aERhdGEuZGlzY29yZFVzZXJuYW1lXHJcbiAgICAgICAgICAgICAgICA/IGF1dGhEYXRhLmRpc2NvcmRVc2VybmFtZVxyXG4gICAgICAgICAgICAgICAgOiBcImlkOiBcIi5jb25jYXQoYXV0aERhdGEubWFzdGVyQXBpSWQpKSA6IFwibm90IGF1dGhvcml6ZWRcIjtcclxuICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQgPSBhdXRoRGF0YSA/IFwiQ2hhbmdlIEFjY291bnRcIiA6IFwiTG9naW4gdmlhIERpc2NvcmRcIjtcclxuICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IGF1dGhEYXRhVXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgIC8vIE9ubHkgc2hvdyBidXR0b25zIGlmIG5vdCBjb25uZWN0aW5nXHJcbiAgICAgICAgICAgIGlmICghY29ubmVjdGluZykge1xyXG4gICAgICAgICAgICAgICAgZWxlbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJidXR0b25cIixcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBidXR0b25UZXh0LFxyXG4gICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtcIkVMRU1FTlRfU1RZTEVfTUFSR0lOX0VYVEVOREVEXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLm9wZW5EaXNjb3JkT2F1dGgpOyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGhpbnQ6IFwiWW91IGNhbiBsb2dpbiBvciBjaGFuZ2UgYWNjb3VudFwiLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IFwiQ29ubmVjdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhZ3M6IFtcIkJVVFRPTl9TVFlMRV9GUkFNRVwiLCBcIkVMRU1FTlRfU1RZTEVfTUFSR0lOX0VYVEVOREVEXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLmF1dGhBdHRlbXB0KTsgfSxcclxuICAgICAgICAgICAgICAgICAgICBoaW50OiBcIkNvbm5lY3QgdG8gZ2FtZSBzZXJ2ZXJcIixcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIEFsd2F5cyBzaG93IHN0YXR1cyB0ZXh0XHJcbiAgICAgICAgICAgIGVsZW1lbnRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICB0ZXh0OiBicm93c2VyU3RhdGUuY29tbWVudCxcclxuICAgICAgICAgICAgICAgIHRhZ3M6IFtdLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdmFyIGxvZ2luV2lkZ2V0ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJmb3JtXCIsXHJcbiAgICAgICAgICAgICAgICBpZDogMSxcclxuICAgICAgICAgICAgICAgIGNhcHRpb246IFwiQXV0aGVudGljYXRpb25cIixcclxuICAgICAgICAgICAgICAgIGVsZW1lbnRzOiBlbGVtZW50c1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB3aW5kb3cuc2t5cmltUGxhdGZvcm0ud2lkZ2V0cy5zZXQoW2xvZ2luV2lkZ2V0XSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5icm93c2Vyc2lkZVdpZGdldFNldHRlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGxvZ2luV2lkZ2V0ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJmb3JtXCIsXHJcbiAgICAgICAgICAgICAgICBpZDogMSxcclxuICAgICAgICAgICAgICAgIGNhcHRpb246IFwiQXV0aGVudGljYXRpb25cIixcclxuICAgICAgICAgICAgICAgIGVsZW1lbnRzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogKGF1dGhEYXRhID8gKGF1dGhEYXRhLmRpc2NvcmRVc2VybmFtZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBcIlwiLmNvbmNhdChhdXRoRGF0YS5kaXNjb3JkVXNlcm5hbWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IFwiaWQ6IFwiLmNvbmNhdChhdXRoRGF0YS5tYXN0ZXJBcGlJZCkpIDogXCJub3QgYXV0aG9yaXplZFwiKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiYnV0dG9uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGF1dGhEYXRhID8gXCJDaGFuZ2UgQWNjb3VudFwiIDogXCJMb2dpbiB2aWEgRGlzY29yZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xpY2s6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHdpbmRvdy5za3lyaW1QbGF0Zm9ybS5zZW5kTWVzc2FnZShldmVudHMub3BlbkRpc2NvcmRPYXV0aCk7IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpbnQ6IFwiWW91IGNhbiBsb2dpbiBvciBjaGFuZ2UgYWNjb3VudFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImJ1dHRvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBcIkNvbm5lY3RcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW1wiQlVUVE9OX1NUWUxFX0ZSQU1FXCIsIFwiRUxFTUVOVF9TVFlMRV9NQVJHSU5fRVhURU5ERURcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoKSB7IHJldHVybiB3aW5kb3cuc2t5cmltUGxhdGZvcm0uc2VuZE1lc3NhZ2UoZXZlbnRzLmF1dGhBdHRlbXB0KTsgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGludDogXCJDb25uZWN0IHRvIGdhbWUgc2VydmVyXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBicm93c2VyU3RhdGUuY29tbWVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMuc2V0KFtsb2dpbldpZGdldF0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgX3RoaXMuX2lzTGlzdGVuQnJvd3Nlck1lc3NhZ2UgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy50cmlnZ2VyID0ge1xyXG4gICAgICAgICAgICBhdXRoTmVlZGVkRmlyZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBicm93c2VyV2luZG93TG9hZGVkRmlyZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBnZXQgY29uZGl0aW9uTWV0KCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXV0aE5lZWRlZEZpcmVkICYmIHRoaXMuYnJvd3NlcldpbmRvd0xvYWRlZEZpcmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5kaXNjb3JkQXV0aFN0YXRlID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XHJcbiAgICAgICAgX3RoaXMuYXV0aERpYWxvZ09wZW4gPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgIF90aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yQ291bnRlciA9IDA7XHJcbiAgICAgICAgX3RoaXMubGFzdFNsb3dDb3VudGVyID0gLTE7XHJcbiAgICAgICAgX3RoaXMucGxheWVyRXZlclNhd0FjdHVhbEdhbWVwbGF5ID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuZ2l0aHViVXJsID0gXCJodHRwczovL2dpdGh1Yi5jb20vc2t5cmltLW11bHRpcGxheWVyL3NreW1wXCI7XHJcbiAgICAgICAgX3RoaXMucGF0cmVvblVybCA9IFwiaHR0cHM6Ly93d3cucGF0cmVvbi5jb20vc2t5bXBcIjtcclxuICAgICAgICBfdGhpcy5wbHVnaW5BdXRoRGF0YU5hbWUgPSBcImF1dGgtZGF0YS1uby1sb2FkXCI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiYXV0aE5lZWRlZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BdXRoTmVlZGVkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJicm93c2VyV2luZG93TG9hZGVkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkJyb3dzZXJXaW5kb3dMb2FkZWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DcmVhdGVBY3Rvck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNvbm5lY3Rpb25BY2NlcHRlZFwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5oYW5kbGVDb25uZWN0aW9uQWNjZXB0ZWQoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY29ubmVjdGlvbkRlbmllZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMuaGFuZGxlQ29ubmVjdGlvbkRlbmllZChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3VzdG9tUGFja2V0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DdXN0b21QYWNrZXRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwiYnJvd3Nlck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQnJvd3Nlck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVGljaygpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25BdXRoTmVlZGVkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGF1dGhOZWVkZWQgZXZlbnRcIik7XHJcbiAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAnYXV0aE5lZWRlZCByZWNlaXZlZCcpO1xyXG4gICAgICAgIC8vIFRyeSB0byByZWFkIGF1dGggZGF0YSBmcm9tIGRpc2sgZmlyc3RcclxuICAgICAgICBhdXRoRGF0YSA9IHRoaXMucmVhZEF1dGhEYXRhRnJvbURpc2soKTtcclxuICAgICAgICAvLyBJZiBubyBhdXRoIGZpbGUgZXhpc3RzLCBjaGVjayBmb3Igb2ZmbGluZSBtb2RlIHNldHRpbmdzXHJcbiAgICAgICAgaWYgKCFhdXRoRGF0YSkge1xyXG4gICAgICAgICAgICB2YXIgc2V0dGluZ3NHYW1lRGF0YSA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiZ2FtZURhdGFcIl07XHJcbiAgICAgICAgICAgIHZhciBoYXNPZmZsaW5lU2V0dGluZ3MgPSBOdW1iZXIuaXNJbnRlZ2VyKHNldHRpbmdzR2FtZURhdGEgPT09IG51bGwgfHwgc2V0dGluZ3NHYW1lRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3NHYW1lRGF0YS5wcm9maWxlSWQpO1xyXG4gICAgICAgICAgICBpZiAoaGFzT2ZmbGluZVNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIk5vIGF1dGggZmlsZSBmb3VuZCwgdXNpbmcgb2ZmbGluZSBtb2RlIGZyb20gc2V0dGluZ3Mgd2l0aCBwcm9maWxlSWQ6XCIsIHNldHRpbmdzR2FtZURhdGEucHJvZmlsZUlkKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhdXRoQXR0ZW1wdFwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXV0aEdhbWVEYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9maWxlSWQ6IHNldHRpbmdzR2FtZURhdGEucHJvZmlsZUlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzVG9rZW46IHNldHRpbmdzR2FtZURhdGEuYWNjZXNzVG9rZW5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEF1dGggZmlsZSBleGlzdHMgb3Igbm8gb2ZmbGluZSBzZXR0aW5ncyAtIHNob3cgbG9naW4gbWVudVxyXG4gICAgICAgIGlmIChhdXRoRGF0YSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkF1dGggZmlsZSBmb3VuZCwgc2hvd2luZyBsb2dpbiBtZW51IHdpdGggZXhpc3RpbmcgYXV0aCBkYXRhXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJObyBhdXRoIGZpbGUgYW5kIG5vIG9mZmxpbmUgc2V0dGluZ3MsIHNob3dpbmcgbG9naW4gbWVudVwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXRMaXN0ZW5Ccm93c2VyTWVzc2FnZSh0cnVlLCAncmVndWxhciBhdXRoIG5lZWRlZCcpO1xyXG4gICAgICAgIC8vIFNob3cgYnJvd3NlciBhbmQgbG9hZCB0aGUgVUlcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgICAgICAvLyBUcnkgdG8gbG9hZCB0aGUgVUkgZXhwbGljaXRseVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5sb2FkVXJsKFwiZmlsZTovLy9EYXRhL1BsYXRmb3JtL1VJL2luZGV4Lmh0bWxcIik7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQXR0ZW1wdGVkIHRvIGxvYWQgVUkgZnJvbSBmaWxlOi8vL0RhdGEvUGxhdGZvcm0vVUkvaW5kZXguaHRtbFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJGYWlsZWQgdG8gbG9hZCBVSTpcIiwgZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFNldCB0cmlnZ2VyIGZsYWcgYW5kIHdhaXQgZm9yIGJyb3dzZXIgdG8gbG9hZFxyXG4gICAgICAgIHRoaXMudHJpZ2dlci5hdXRoTmVlZGVkRmlyZWQgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMub25Ccm93c2VyV2luZG93TG9hZGVkQW5kT25saW5lQXV0aE5lZWRlZCgpO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkJyb3dzZXJXaW5kb3dMb2FkZWRTaG93U3RhcnRXaW5kb3cgPSBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0VmlzaWJsZSh0cnVlKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgICAgICBhdXRoRGF0YSA9IGRhdGE7XHJcbiAgICAgICAgKF9hID0gdGhpcy5zcC5icm93c2VyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZXhlY3V0ZUphdmFTY3JpcHQoXCJ3aW5kb3c/LnVzZU1lbnVTdG9yZT8uZ2V0U3RhdGUoKS5vblN0YXJ0KFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShkYXRhKSwgXCIpXCIpKTtcclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25Ccm93c2VyV2luZG93TG9hZGVkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGJyb3dzZXJXaW5kb3dMb2FkZWQgZXZlbnRcIik7XHJcbiAgICAgICAgdGhpcy50cmlnZ2VyLmJyb3dzZXJXaW5kb3dMb2FkZWRGaXJlZCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5vbkJyb3dzZXJXaW5kb3dMb2FkZWRBbmRPbmxpbmVBdXRoTmVlZGVkKCk7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQ3JlYXRlQWN0b3JNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoZS5tZXNzYWdlLmlzTWUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYXV0aERpYWxvZ09wZW4pIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgY3JlYXRlQWN0b3JNZXNzYWdlIGZvciBzZWxmLCByZXNldHRpbmcgd2lkZ2V0c1wiKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdCgnd2luZG93LnNreXJpbVBsYXRmb3JtLndpZGdldHMuc2V0KFtdKTsnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aERpYWxvZ09wZW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgY3JlYXRlQWN0b3JNZXNzYWdlIGZvciBzZWxmLCBidXQgYXV0aCBkaWFsb2cgd2FzIG5vdCBvcGVuIHNvIG5vdCByZXNldHRpbmcgd2lkZ2V0c1wiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLm9uQ3VzdG9tUGFja2V0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBtc2dDb250ZW50ID0ge307XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbXNnQ29udGVudCA9IEpTT04ucGFyc2UobXNnLmNvbnRlbnRKc29uRHVtcCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25DdXN0b21QYWNrZXRNZXNzYWdlIGZhaWxlZCB0byBwYXJzZSBKU09OXCIsIGUubWVzc2FnZSwgXCJqc29uOlwiLCBtc2cuY29udGVudEpzb25EdW1wKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgc3dpdGNoIChtc2dDb250ZW50W1wiY3VzdG9tUGFja2V0VHlwZVwiXSkge1xyXG4gICAgICAgICAgICAvLyBjYXNlICdsb2dpblJlcXVpcmVkJzpcclxuICAgICAgICAgICAgLy8gICBsb2dUcmFjZSh0aGlzLCAnbG9naW5SZXF1aXJlZCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAvLyAgIHRoaXMubG9naW5XaXRoU2t5bXBJb0NyZWRlbnRpYWxzKCk7XHJcbiAgICAgICAgICAgIC8vICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xvZ2luRmFpbGVkTm90TG9nZ2VkVmlhRGlzY29yZCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdsb2dpbkZhaWxlZE5vdExvZ2dlZFZpYURpc2NvcmQgcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICdwbGVhc2UgbG9naW4gdmlhIGRpc2NvcmQnO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnJztcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ2xvZ2luRmFpbGVkTm90TG9nZ2VkVmlhRGlzY29yZCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xvZ2luRmFpbGVkTm90SW5UaGVEaXNjb3JkU2VydmVyJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ2xvZ2luRmFpbGVkTm90SW5UaGVEaXNjb3JkU2VydmVyIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAncGxlYXNlIGpvaW4gdGhlIGRpc2NvcmQgc2VydmVyJztcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdsb2dpbkZhaWxlZE5vdEluVGhlRGlzY29yZFNlcnZlciByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnaW5nU3RhcnRNb21lbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xvZ2luRmFpbGVkQmFubmVkJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ2xvZ2luRmFpbGVkQmFubmVkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24gPSAneW91IGFyZSBiYW5uZWQnO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnJztcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UodHJ1ZSwgJ2xvZ2luRmFpbGVkQmFubmVkIHJlY2VpdmVkJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbG9naW5GYWlsZWRJcE1pc21hdGNoJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ2xvZ2luRmFpbGVkSXBNaXNtYXRjaCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJ3doYXQgd2FzIHRoYXQ/JztcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdsb2dpbkZhaWxlZElwTWlzbWF0Y2ggcmVjZWl2ZWQnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ID0gMDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25Ccm93c2VyV2luZG93TG9hZGVkQW5kT25saW5lQXV0aE5lZWRlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICghdGhpcy5pc0xpc3RlbkJyb3dzZXJNZXNzYWdlKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSB3YXMgZmFsc2UgZm9yIHNvbWUgcmVhc29uLCBhYm9ydGluZyBhdXRoXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy50cmlnZ2VyLmNvbmRpdGlvbk1ldCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uQnJvd3NlcldpbmRvd0xvYWRlZEFuZE9ubGluZUF1dGhOZWVkZWQgd2FpdGluZyBmb3IgYm90aCB0cmlnZ2VycyB0byBsb2FkXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2hvd2luZyB3aWRnZXRzIGFuZCBzdGFydGluZyBsb29wXCIpO1xyXG4gICAgICAgIC8vIE1ha2Ugc3VyZSBhdXRoIGRhdGEgaXMgbG9hZGVkXHJcbiAgICAgICAgaWYgKCFhdXRoRGF0YSkge1xyXG4gICAgICAgICAgICBhdXRoRGF0YSA9IHRoaXMucmVhZEF1dGhEYXRhRnJvbURpc2soKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICAgICAgLy8gRGVsYXkgaW5pdGlhbCBzdGF0ZSBpbmplY3Rpb24gdG8gZW5zdXJlIFJlYWN0IGlzIG1vdW50ZWRcclxuICAgICAgICB2YXIgdGltZXJzU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihUaW1lcnNTZXJ2aWNlKTtcclxuICAgICAgICB0aW1lcnNTZXJ2aWNlLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgJ1NlbmRpbmcgaW5pdGlhbCBhdXRoIHN0YXRlIHRvIFJlYWN0IFVJJyk7XHJcbiAgICAgICAgICAgIF90aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgfSwgNTAwKTtcclxuICAgICAgICAvLyBTdGFydCBEaXNjb3JkIE9BdXRoIGxvZ2luIHN0YXRlIGNoZWNraW5nIGxvb3BcclxuICAgICAgICB0aGlzLmNoZWNrTG9naW5TdGF0ZSgpO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vbkJyb3dzZXJNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uQnJvd3Nlck1lc3NhZ2U6IGlzTGlzdGVuQnJvd3Nlck1lc3NhZ2Ugd2FzIGZhbHNlLCBpZ25vcmluZyBtZXNzYWdlXCIsIEpTT04uc3RyaW5naWZ5KGUuYXJndW1lbnRzKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNldHRpbmdzU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXR0aW5nc1NlcnZpY2UpO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25Ccm93c2VyTWVzc2FnZTpcIiwgSlNPTi5zdHJpbmdpZnkoZS5hcmd1bWVudHMpKTtcclxuICAgICAgICB2YXIgZXZlbnRLZXkgPSBlLmFyZ3VtZW50c1swXTtcclxuICAgICAgICBzd2l0Y2ggKGV2ZW50S2V5KSB7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLm9wZW5EaXNjb3JkT2F1dGg6XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9wZW5EaXNjb3JkT2F1dGggZXZlbnQgcmVjZWl2ZWQsIG9wZW5pbmcgYnJvd3NlclwiKTtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJ29wZW5pbmcgYnJvd3Nlci4uLic7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3NTZXJ2aWNlXzEgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU2V0dGluZ3NTZXJ2aWNlKTtcclxuICAgICAgICAgICAgICAgIHZhciBkaXNjb3JkQXV0aEJhc2VVcmwgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImRpc2NvcmQtYXV0aC11cmxcIl0gfHwgXCJodHRwOi8vbG9jYWxob3N0OlwiLmNvbmNhdCh0aGlzLmdldFNlcnZlclBvcnQoKSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgZGlzY29yZEF1dGhVcmwgPSBcIlwiLmNvbmNhdChkaXNjb3JkQXV0aEJhc2VVcmwsIFwiL2FwaS91c2Vycy9sb2dpbi1kaXNjb3JkP3N0YXRlPVwiKS5jb25jYXQodGhpcy5kaXNjb3JkQXV0aFN0YXRlKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTG9hZGluZyBEaXNjb3JkIE9BdXRoIFVSTDpcIiwgZGlzY29yZEF1dGhVcmwpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJ3aW4zMiBvYmplY3Q6XCIsIHRoaXMuc3Aud2luMzIpO1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNwLndpbjMyLmxvYWRVcmwoZGlzY29yZEF1dGhVcmwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwid2luMzIubG9hZFVybCBjYWxsZWQgc3VjY2Vzc2Z1bGx5XCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJGYWlsZWQgdG8gY2FsbCB3aW4zMi5sb2FkVXJsOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBMYXVuY2ggY2hlY2tMb2dpblN0YXRlIGxvb3BcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tMb2dpblN0YXRlKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuYXV0aEF0dGVtcHQ6XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcImF1dGhBdHRlbXB0IGV2ZW50IHJlY2VpdmVkIChDb25uZWN0IGJ1dHRvbiBjbGlja2VkKVwiKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ3VycmVudCBhdXRoRGF0YTpcIiwgYXV0aERhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGF1dGhEYXRhID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJhdXRoRGF0YSBpcyBudWxsLCBjYW5ub3QgY29ubmVjdFwiKTtcclxuICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuY29tbWVudCA9ICdwbGVhc2UgbG9naW4gZmlyc3QnO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiRW1pdHRpbmcgYXV0aEF0dGVtcHQgZXZlbnQgd2l0aCBhdXRoRGF0YTpcIiwgSlNPTi5zdHJpbmdpZnkoYXV0aERhdGEpKTtcclxuICAgICAgICAgICAgICAgIC8vIEVtaXQgYXV0aEF0dGVtcHQgZXZlbnQgdG8gdHJpZ2dlciBjb25uZWN0aW9uXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYXV0aEF0dGVtcHRcIiwgeyBhdXRoR2FtZURhdGE6IHsgcmVtb3RlOiBhdXRoRGF0YSB9IH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIGV2ZW50cy5jbGVhckF1dGhEYXRhOlxyXG4gICAgICAgICAgICAgICAgLy8gRG9lc24ndCBzZWVtIHRvIGJlIHVzZWQgLSBsYXVuY2hlciBtYW5hZ2VzIGF1dGggZGF0YVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLm9wZW5HaXRodWI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLndpbjMyLmxvYWRVcmwodGhpcy5naXRodWJVcmwpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLm9wZW5QYXRyZW9uOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC53aW4zMi5sb2FkVXJsKHRoaXMucGF0cmVvblVybCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMudXBkYXRlUmVxdWlyZWQ6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLndpbjMyLmxvYWRVcmwoXCJodHRwczovL3NreW1wLm5ldC9VcGRJbnN0YWxsXCIpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgZXZlbnRzLmJhY2tUb0xvZ2luOlxyXG4gICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdXNlciBtYW51YWxseSB3ZW50IGJhY2sgZnJvbSBjaGFyYWN0ZXIgc2VsZWN0XHJcbiAgICAgICAgICAgICAgICB2YXIgY2hhcmFjdGVyU2VsZWN0U2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlKTtcclxuICAgICAgICAgICAgICAgIGlmIChjaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlICYmIGNoYXJhY3RlclNlbGVjdFNlcnZpY2UucmVzZXRBdXRoU3RhdGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnVXNlciBtYW51YWxseSB3ZW50IGJhY2sgZnJvbSBjaGFyYWN0ZXIgc2VsZWN0LCByZXNldHRpbmcgYXV0aCBzdGF0ZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IGZsYWdcclxuICAgICAgICAgICAgICAgICAgICBjaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnJlc2V0QXV0aFN0YXRlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgcHJvZ3Jlc3MgaW5kaWNhdG9yIHRvIHByZXZlbnQgYXV0by1jb25uZWN0XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgbG9nZ2luZyBzdGFydCBtb21lbnRcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgYW55IGVycm9yIG1lc3NhZ2VzXHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAnJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIFJlbG9hZCBhdXRoIGRhdGEgZnJvbSBkaXNrIHNvIHVzZXIgc2VlcyB0aGVpciBwcmV2aW91cyBhY2NvdW50IGluZm9cclxuICAgICAgICAgICAgICAgIGF1dGhEYXRhID0gdGhpcy5yZWFkQXV0aERhdGFGcm9tRGlzaygpO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ1JlbG9hZGVkIGF1dGggZGF0YSBhZnRlciBCYWNrIGJ1dHRvbiBwcmVzc2VkOicsIGF1dGhEYXRhID8gJ2ZvdW5kJyA6ICdub3QgZm91bmQnKTtcclxuICAgICAgICAgICAgICAgIC8vIFJlZnJlc2ggdGhlIFJlYWN0IFVJIHdpdGggdXBkYXRlZCBhdXRoIHN0YXRlXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuam9pbkRpc2NvcmQ6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLndpbjMyLmxvYWRVcmwoXCJodHRwczovL2Rpc2NvcmQuZ2cvYnN0YXJycFwiKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdyZXF1ZXN0QXV0aFN0YXRlJzpcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdSZWFjdCBVSSByZXF1ZXN0aW5nIGF1dGggc3RhdGUsIHNlbmRpbmcgY3VycmVudCBzdGF0ZScpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIlVua25vd24gZXZlbnQga2V5XCIsIGV2ZW50S2V5KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUuY3JlYXRlUGxheVNlc3Npb24gPSBmdW5jdGlvbiAodG9rZW4sIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgdmFyIGNsaWVudCA9IG5ldyB0aGlzLnNwLkh0dHBDbGllbnQoXCJodHRwOi8vbG9jYWxob3N0OlwiLmNvbmNhdCh0aGlzLmdldFNlcnZlclBvcnQoKSkpO1xyXG4gICAgICAgIHZhciByb3V0ZSA9IFwiL2FwaS91c2Vycy9tZS9wbGF5L21haW5cIjtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNyZWF0aW5nIHBsYXkgc2Vzc2lvbiBcIi5jb25jYXQocm91dGUpKTtcclxuICAgICAgICBjbGllbnQucG9zdChyb3V0ZSwge1xyXG4gICAgICAgICAgICBib2R5OiAne30nLFxyXG4gICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICAgICAnYXV0aG9yaXphdGlvbic6IFwiQmVhcmVyIFwiLmNvbmNhdCh0b2tlbiksXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICB9LCBmdW5jdGlvbiAocmVzKSB7XHJcbiAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzICE9IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soJycsICdzdGF0dXMgY29kZSAnICsgcmVzLnN0YXR1cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBoYW5kbGUgSlNPTi5wYXJzZSBmYWlsdXJlP1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soSlNPTi5wYXJzZShyZXMuYm9keSkuc2Vzc2lvbiwgJycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLmNoZWNrTG9naW5TdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICghdGhpcy5pc0xpc3RlbkJyb3dzZXJNZXNzYWdlKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiY2hlY2tMb2dpblN0YXRlOiBpc0xpc3RlbkJyb3dzZXJNZXNzYWdlIHdhcyBmYWxzZSwgYWJvcnRpbmcgY2hlY2tcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRpbWVyc1NlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoVGltZXJzU2VydmljZSk7XHJcbiAgICAgICAgLy8gU29jaWFsIGVuZ2luZWVyaW5nIHByb3RlY3Rpb24sIGRvbid0IHNob3cgdGhlIGZ1bGwgc3RhdGVcclxuICAgICAgICB2YXIgaGFsZkRpc2NvcmRBdXRoU3RhdGUgPSB0aGlzLmRpc2NvcmRBdXRoU3RhdGUuc2xpY2UoMCwgMTYpO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ2hlY2tpbmcgbG9naW4gc3RhdGVcIiwgaGFsZkRpc2NvcmRBdXRoU3RhdGUsICcuLi4nKTtcclxuICAgICAgICBuZXcgdGhpcy5zcC5IdHRwQ2xpZW50KFwiaHR0cDovL2xvY2FsaG9zdDpcIi5jb25jYXQodGhpcy5nZXRTZXJ2ZXJQb3J0KCkpKVxyXG4gICAgICAgICAgICAuZ2V0KFwiL2FwaS91c2Vycy9sb2dpbi1kaXNjb3JkL3N0YXR1cz9zdGF0ZT1cIiArIHRoaXMuZGlzY29yZEF1dGhTdGF0ZSwgdW5kZWZpbmVkLCBcclxuICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAocmVzcG9uc2Uuc3RhdHVzKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDIwMDpcclxuICAgICAgICAgICAgICAgICAgICB2YXIgX2EgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpLCB0b2tlbiA9IF9hLnRva2VuLCBtYXN0ZXJBcGlJZF8xID0gX2EubWFzdGVyQXBpSWQsIGRpc2NvcmRVc2VybmFtZV8xID0gX2EuZGlzY29yZFVzZXJuYW1lLCBkaXNjb3JkRGlzY3JpbWluYXRvcl8xID0gX2EuZGlzY29yZERpc2NyaW1pbmF0b3IsIGRpc2NvcmRBdmF0YXJfMSA9IF9hLmRpc2NvcmRBdmF0YXI7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmZhaWxDb3VudCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY3JlYXRlUGxheVNlc3Npb24odG9rZW4sIGZ1bmN0aW9uIChwbGF5U2Vzc2lvbiwgZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicm93c2VyU3RhdGUuZmFpbENvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gKGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyc1NlcnZpY2Uuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5jaGVja0xvZ2luU3RhdGUoKTsgfSwgTWF0aC5mbG9vcigoMS41ICsgTWF0aC5yYW5kb20oKSAqIDIpICogMTAwMCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhdXRoRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb246IHBsYXlTZXNzaW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFzdGVyQXBpSWQ6IG1hc3RlckFwaUlkXzEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkVXNlcm5hbWU6IGRpc2NvcmRVc2VybmFtZV8xLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29yZERpc2NyaW1pbmF0b3I6IGRpc2NvcmREaXNjcmltaW5hdG9yXzEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkQXZhdGFyOiBkaXNjb3JkQXZhdGFyXzEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkRpc2NvcmQgYXV0aCBzdWNjZXNzZnVsLCBhdXRoRGF0YSBzZXQ6XCIsIEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJ2Nvbm5lY3RlZCBzdWNjZXNzZnVsbHknO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZWZyZXNoV2lkZ2V0cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA0MDE6IC8vIFVuYXV0aG9yaXplZFxyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5mYWlsQ291bnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gJyc7IC8vKGBTdGlsbCB3YWl0aW5nLi4uYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGltZXJzU2VydmljZS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmNoZWNrTG9naW5TdGF0ZSgpOyB9LCBNYXRoLmZsb29yKCgxLjUgKyBNYXRoLnJhbmRvbSgpICogMikgKiAxMDAwKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDQwMzogLy8gRm9yYmlkZGVuXHJcbiAgICAgICAgICAgICAgICBjYXNlIDQwNDogLy8gTm90IGZvdW5kXHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmZhaWxDb3VudCA9IDkwMDA7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSAoXCJGYWlsOiBcIi5jb25jYXQocmVzcG9uc2UuYm9keSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICArK2Jyb3dzZXJTdGF0ZS5mYWlsQ291bnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSBcIlNlcnZlciByZXR1cm5lZCBcIi5jb25jYXQocmVzcG9uc2Uuc3RhdHVzLnRvU3RyaW5nKCkgfHwgXCI/Pz9cIiwgXCIgXFxcIlwiKS5jb25jYXQocmVzcG9uc2UuYm9keSB8fCByZXNwb25zZS5lcnJvciwgXCJcXFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVyc1NlcnZpY2Uuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5jaGVja0xvZ2luU3RhdGUoKTsgfSwgTWF0aC5mbG9vcigoMS41ICsgTWF0aC5yYW5kb20oKSAqIDIpICogMTAwMCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLnJlZnJlc2hXaWRnZXRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsICdyZWZyZXNoQXV0aFVJIGNhbGxlZCcpO1xyXG4gICAgICAgIC8vIEluamVjdCBhdXRoIHN0YXRlIGludG8gd2luZG93IGZvciBSZWFjdCBVSVxyXG4gICAgICAgIHZhciBhdXRoU3RhdGUgPSB7XHJcbiAgICAgICAgICAgIGF1dGhEYXRhOiBhdXRoRGF0YSxcclxuICAgICAgICAgICAgY29tbWVudDogYnJvd3NlclN0YXRlLmNvbW1lbnQsXHJcbiAgICAgICAgICAgIGxvZ2luRmFpbGVkUmVhc29uOiBicm93c2VyU3RhdGUubG9naW5GYWlsZWRSZWFzb24sXHJcbiAgICAgICAgICAgIGlzQ29ubmVjdGluZzogdGhpcy5hdXRoQXR0ZW1wdFByb2dyZXNzSW5kaWNhdG9yXHJcbiAgICAgICAgfTtcclxuICAgICAgICB2YXIgaW5qZWN0U2NyaXB0ID0gXCJcXG4gICAgICB3aW5kb3cuc2t5bXAgPSB3aW5kb3cuc2t5bXAgfHwge307XFxuICAgICAgd2luZG93LnNreW1wLmF1dGggPSBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkoYXV0aFN0YXRlKSwgXCI7XFxuICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDphdXRoVXBkYXRlJywgeyBkZXRhaWw6IFwiKS5jb25jYXQoSlNPTi5zdHJpbmdpZnkoYXV0aFN0YXRlKSwgXCIgfSkpO1xcbiAgICBcIik7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGluamVjdFNjcmlwdCk7XHJcbiAgICAgICAgdGhpcy5hdXRoRGlhbG9nT3BlbiA9IHRydWU7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLnJlYWRBdXRoRGF0YUZyb21EaXNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVhZGluZ1wiLCB0aGlzLnBsdWdpbkF1dGhEYXRhTmFtZSwgXCJmcm9tIGRpc2tcIik7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnNwLmdldFBsdWdpblNvdXJjZUNvZGUodGhpcy5wbHVnaW5BdXRoRGF0YU5hbWUsIFwiUGx1Z2luc05vTG9hZFwiKTtcclxuICAgICAgICAgICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlYWQgZW1wdHlcIiwgdGhpcy5wbHVnaW5BdXRoRGF0YU5hbWUsIFwicmV0dXJuaW5nIG51bGxcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhLnNsaWNlKDIpKSB8fCBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkVycm9yIHJlYWRpbmdcIiwgdGhpcy5wbHVnaW5BdXRoRGF0YU5hbWUsIFwiZnJvbSBkaXNrOlwiLCBlLCBcIiwgZmFsbGluZyBiYWNrIHRvIG51bGxcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUud3JpdGVBdXRoRGF0YVRvRGlzayA9IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgLy8gQXV0aCBkYXRhIHdyaXRpbmcgaXMgaGFuZGxlZCBieSB0aGUgbGF1bmNoZXIsIGNsaWVudCBvbmx5IHJlYWRzXHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJBdXRoIGRhdGEgd3JpdGluZyBkaXNhYmxlZCAtIGxhdW5jaGVyIG1hbmFnZXMgYXV0aCBkYXRhXCIpO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5oYW5kbGVDb25uZWN0aW9uRGVuaWVkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvciA9IGZhbHNlO1xyXG4gICAgICAgIGlmIChlLmVycm9yLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoXCJpbnZhbGlkIHBhc3N3b3JkXCIpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgYnJvd3NlclN0YXRlLmxvZ2luRmFpbGVkUmVhc29uID0gJ2ludmFsaWQgcGFzc3dvcmQnO1xyXG4gICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5kaXNhYmxlUGxheWVyQ29udHJvbHModHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlKHRydWUsICdjb25uZWN0aW9uRGVuaWVkIGV2ZW50IHJlY2VpdmVkJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5oYW5kbGVDb25uZWN0aW9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJoYW5kbGVDb25uZWN0aW9uQWNjZXB0ZWQgY2FsbGVkXCIpO1xyXG4gICAgICAgIC8vIEtlZXAgYnJvd3NlciBtZXNzYWdlIGxpc3RlbmVyIGFjdGl2ZSBzbyB1c2VyIGNhbiBzdGlsbCBpbnRlcmFjdCB3aXRoIGF1dGggbWVudVxyXG4gICAgICAgIC8vIHRoaXMuc2V0TGlzdGVuQnJvd3Nlck1lc3NhZ2UoZmFsc2UsICdjb25uZWN0aW9uQWNjZXB0ZWQgZXZlbnQgcmVjZWl2ZWQnKTtcclxuICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdmFyIGF1dGhEYXRhID0gdGhpcy5zcC5zdG9yYWdlW2F1dGhHYW1lRGF0YVN0b3JhZ2VLZXldO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQXV0aCBkYXRhIGZyb20gc3RvcmFnZTpcIiwgSlNPTi5zdHJpbmdpZnkoYXV0aERhdGEpKTtcclxuICAgICAgICBpZiAoYXV0aERhdGEgPT09IG51bGwgfHwgYXV0aERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhEYXRhLmxvY2FsKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTG9nZ2luZyBpbiBvZmZsaW5lIG1vZGUsIHByb2ZpbGVJZCA9XCIsIGF1dGhEYXRhLmxvY2FsLnByb2ZpbGVJZCk7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21QYWNrZXQsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50SnNvbkR1bXA6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21QYWNrZXRUeXBlOiAnbG9naW5XaXRoU2t5bXBJbycsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2FtZURhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZmlsZUlkOiBhdXRoRGF0YS5sb2NhbC5wcm9maWxlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGF1dGhEYXRhID09PSBudWxsIHx8IGF1dGhEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoRGF0YS5yZW1vdGUpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgJ0xvZ2dpbmcgaW4gYXMgYSBtYXN0ZXIgQVBJIHVzZXInKTtcclxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbVBhY2tldCxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRKc29uRHVtcDogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbVBhY2tldFR5cGU6ICdsb2dpbldpdGhTa3ltcElvJyxcclxuICAgICAgICAgICAgICAgICAgICBnYW1lRGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uOiBhdXRoRGF0YS5yZW1vdGUuc2Vzc2lvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFzdGVyQXBpSWQ6IGF1dGhEYXRhLnJlbW90ZS5tYXN0ZXJBcGlJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzY29yZFVzZXJuYW1lOiBhdXRoRGF0YS5yZW1vdGUuZGlzY29yZFVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkRGlzY3JpbWluYXRvcjogYXV0aERhdGEucmVtb3RlLmRpc2NvcmREaXNjcmltaW5hdG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNjb3JkQXZhdGFyOiBhdXRoRGF0YS5yZW1vdGUuZGlzY29yZEF2YXRhcixcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2dFcnJvcih0aGlzLCAnTm90IGZvdW5kIGF1dGhlbnRpY2F0aW9uIG1ldGhvZCcpO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5vblRpY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gVE9ETzogU2hvdWxkIGJlIG5vIGhhcmRjb2RlZC9tYWdpYy1udW1iZXIgbGltaXRcclxuICAgICAgICAvLyBUT0RPOiBCdXN5IHdhaXRpbmcgaXMgYmFkLiBTaG91bGQgYmUgcmVwbGFjZWQgd2l0aCBzb21lIGtpbmQgb2YgZXZlbnRcclxuICAgICAgICB2YXIgbWF4TG9nZ2luZ0RlbGF5ID0gMTUwMDA7XHJcbiAgICAgICAgaWYgKHRoaXMubG9nZ2luZ1N0YXJ0TW9tZW50ICYmIERhdGUubm93KCkgLSB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA+IG1heExvZ2dpbmdEZWxheSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnTWF4IGxvZ2dpbmcgZGVsYXkgcmVhY2hlZCByZWNlaXZlZCcpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wbGF5ZXJFdmVyU2F3QWN0dWFsR2FtZXBsYXkpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdQbGF5ZXIgc2F3IGFjdHVhbCBnYW1lcGxheSwgcmVjb25uZWN0aW5nJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTmV0d29ya2luZ1NlcnZpY2UpLnJlY29ubmVjdCgpO1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogc2hvdWxkIHdlIHByb21wdCB1c2VyIHRvIHJlbG9naW4/XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUGxheWVyIG5ldmVyIHNhdyBhY3R1YWwgZ2FtZXBsYXksIHNob3dpbmcgbG9naW4gZGlhbG9nJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dpbmdTdGFydE1vbWVudCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5jb21tZW50ID0gXCJcIjtcclxuICAgICAgICAgICAgICAgIGJyb3dzZXJTdGF0ZS5sb2dpbkZhaWxlZFJlYXNvbiA9ICd0ZWNobmljYWwgZGlmZmljdWx0aWVzXFxucGxlYXNlIHRyeSBhZ2Fpblxcbm9yIGNvbnRhY3QgdXMgb24gZGlzY29yZCc7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hXaWRnZXRzKCk7XHJcbiAgICAgICAgICAgICAgICBhdXRoRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAvLyBOb3RlOiBBdXRoIGRhdGEgY2xlYW51cCBoYW5kbGVkIGJ5IGxhdW5jaGVyXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvcikge1xyXG4gICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3JDb3VudGVyKys7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3JDb3VudGVyID09PSAxMDAwMDAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGhBdHRlbXB0UHJvZ3Jlc3NJbmRpY2F0b3JDb3VudGVyID0gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgc2xvd0NvdW50ZXIgPSBNYXRoLmZsb29yKHRoaXMuYXV0aEF0dGVtcHRQcm9ncmVzc0luZGljYXRvckNvdW50ZXIgLyAxNSk7XHJcbiAgICAgICAgICAgIHZhciBuZXdTbG93Q291bnRlciA9IE1hdGguZmxvb3Ioc2xvd0NvdW50ZXIgLyAxKTsgLy8gT25seSBjaGFuZ2VzIGV2ZXJ5IH4xNSB0aWNrc1xyXG4gICAgICAgICAgICAvLyBPbmx5IHJlZnJlc2ggd2lkZ2V0cyB3aGVuIHRoZSBkb3QgcGF0dGVybiBjaGFuZ2VzXHJcbiAgICAgICAgICAgIGlmIChuZXdTbG93Q291bnRlciAhPT0gdGhpcy5sYXN0U2xvd0NvdW50ZXIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNsb3dDb3VudGVyID0gbmV3U2xvd0NvdW50ZXI7XHJcbiAgICAgICAgICAgICAgICB2YXIgZG90ID0gc2xvd0NvdW50ZXIgJSAzID09PSAwID8gJy4nIDogc2xvd0NvdW50ZXIgJSAzID09PSAxID8gJy4uJyA6ICcuLi4nO1xyXG4gICAgICAgICAgICAgICAgYnJvd3NlclN0YXRlLmNvbW1lbnQgPSBcImNvbm5lY3RpbmdcIiArIGRvdDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaFdpZGdldHMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBBdXRoU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnBsYXllckV2ZXJTYXdBY3R1YWxHYW1lcGxheSA9IHRydWU7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLmlzTGlzdGVuQnJvd3Nlck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzTGlzdGVuQnJvd3Nlck1lc3NhZ2U7XHJcbiAgICB9O1xyXG4gICAgQXV0aFNlcnZpY2UucHJvdG90eXBlLnNldExpc3RlbkJyb3dzZXJNZXNzYWdlID0gZnVuY3Rpb24gKHZhbHVlLCByZWFzb24pIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcInNldExpc3RlbkJyb3dzZXJNZXNzYWdlOlwiLCB2YWx1ZSwgXCJyZWFzb246XCIsIHJlYXNvbik7XHJcbiAgICAgICAgdGhpcy5faXNMaXN0ZW5Ccm93c2VyTWVzc2FnZSA9IHZhbHVlO1xyXG4gICAgfTtcclxuICAgIEF1dGhTZXJ2aWNlLnByb3RvdHlwZS5nZXRTZXJ2ZXJQb3J0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIFVzZSB0aGUgc2FtZSBwb3J0IHRoYXQgdGhlIFVJIHNlcnZlciB1c2VzICh0eXBpY2FsbHkgMzAwMCBmb3IgZGV2LCBwb3J0KzEgZm9yIGN1c3RvbSBwb3J0cylcclxuICAgICAgICAvLyBUaGlzIG1hdGNoZXMgdGhlIHBhdHRlcm4gaW4gdWkudHNcclxuICAgICAgICB2YXIgc2V0dGluZ3NTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNldHRpbmdzU2VydmljZSk7XHJcbiAgICAgICAgdmFyIHNlcnZlclBvcnQgPSBzZXR0aW5nc1NlcnZpY2UuZ2V0U2VydmVyUG9ydCgpO1xyXG4gICAgICAgIHJldHVybiBzZXJ2ZXJQb3J0ID09PSA3Nzc3ID8gMzAwMCA6IHNlcnZlclBvcnQgKyAxO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBBdXRoU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBBdXRoU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQmxvY2tQYXB5cnVzRXZlbnRzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VUaWNrKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UucHJvdG90eXBlLm9uY2VUaWNrID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICB0aGlzLnNwLmJsb2NrUGFweXJ1c0V2ZW50cyh0cnVlKTtcclxuICAgIH07XHJcbiAgICBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuVEVTTW9kUGxhdGZvcm0uYmxvY2tQYXB5cnVzRXZlbnRzKHRydWUpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIHZhciBibG9ja2VkQW5pbXMgPSBbXTtcclxuICAgICAgICB2YXIgc2VsZiA9IF90aGlzO1xyXG4gICAgICAgIGJsb2NrZWRBbmltcy5mb3JFYWNoKGZ1bmN0aW9uIChibG9ja2VkQW5pbSkge1xyXG4gICAgICAgICAgICBfdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2Uoc2VsZiwgXCJibG9ja2luZyBhbmltYXRpb24gZXZlbnRcIiwgY3R4LmFuaW1FdmVudE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKCkgeyB9XHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIGJsb2NrZWRBbmltKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEJsb2NrZWRBbmltYXRpb25zU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG4vLyBUT0RPOiBzZW5kIGV2ZW50IGluc3RlYWQgb2YgZGlyZWN0IGRlcGVuZGVuY3kgb24gRm9ybVZpZXcgY2xhc3NcclxuaW1wb3J0IHsgRm9ybVZpZXcgfSBmcm9tIFwiLi4vLi4vdmlldy9mb3JtVmlld1wiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIHVuZm9jdXNFdmVudFN0cmluZyA9IFwid2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDUtY2xpZW50OmJyb3dzZXJVbmZvY3VzZWQnLCB7fSkpXCI7XHJcbnZhciBmb2N1c0V2ZW50U3RyaW5nID0gXCJ3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wNS1jbGllbnQ6YnJvd3NlckZvY3VzZWQnLCB7fSkpXCI7XHJcbnZhciBCcm93c2VyU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhCcm93c2VyU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEJyb3dzZXJTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmJhZE1lbnVzT3BlbiA9IG5ldyBTZXQoKTtcclxuICAgICAgICBfdGhpcy5iYWRNZW51cyA9IFtcclxuICAgICAgICAgICAgXCJCYXJ0ZXJNZW51XCIgLyogTWVudS5CYXJ0ZXIgKi8sXHJcbiAgICAgICAgICAgIFwiQm9vayBNZW51XCIgLyogTWVudS5Cb29rICovLFxyXG4gICAgICAgICAgICBcIkNvbnRhaW5lck1lbnVcIiAvKiBNZW51LkNvbnRhaW5lciAqLyxcclxuICAgICAgICAgICAgXCJDcmFmdGluZyBNZW51XCIgLyogTWVudS5DcmFmdGluZyAqLyxcclxuICAgICAgICAgICAgXCJHaWZ0TWVudVwiIC8qIE1lbnUuR2lmdCAqLyxcclxuICAgICAgICAgICAgXCJJbnZlbnRvcnlNZW51XCIgLyogTWVudS5JbnZlbnRvcnkgKi8sXHJcbiAgICAgICAgICAgIFwiSm91cm5hbCBNZW51XCIgLyogTWVudS5Kb3VybmFsICovLFxyXG4gICAgICAgICAgICBcIkxvY2twaWNraW5nIE1lbnVcIiAvKiBNZW51LkxvY2twaWNraW5nICovLFxyXG4gICAgICAgICAgICBcIkxvYWRpbmcgTWVudVwiIC8qIE1lbnUuTG9hZGluZyAqLyxcclxuICAgICAgICAgICAgXCJNYXBNZW51XCIgLyogTWVudS5NYXAgKi8sXHJcbiAgICAgICAgICAgIFwiUmFjZVNleCBNZW51XCIgLyogTWVudS5SYWNlU2V4ICovLFxyXG4gICAgICAgICAgICBcIlN0YXRzTWVudVwiIC8qIE1lbnUuU3RhdHMgKi8sXHJcbiAgICAgICAgICAgIFwiVHdlZW5NZW51XCIgLyogTWVudS5Ud2VlbiAqLyxcclxuICAgICAgICAgICAgLy9NZW51LkNvbnNvbGUsXHJcbiAgICAgICAgICAgIC8vTWVudS5NYWluLFxyXG4gICAgICAgIF07XHJcbiAgICAgICAgX3RoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKGZhbHNlKTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJxdWVyeUtleUNvZGVCaW5kaW5nc1wiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25RdWVyeUtleUNvZGVCaW5kaW5ncyhlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImJyb3dzZXJNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkJyb3dzZXJNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwibWVudU9wZW5cIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTWVudU9wZW4oZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJtZW51Q2xvc2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTWVudUNsb3NlKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICAvLyBUT0RPOiBrZXljb2RlcyBzaG91bGQgYmUgY29uZmlndXJhYmxlXHJcbiAgICBCcm93c2VyU2VydmljZS5wcm90b3R5cGUub25RdWVyeUtleUNvZGVCaW5kaW5ncyA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgaWYgKGUuaXNEb3duKFs1OSAvKiBEeFNjYW5Db2RlLkYxICovXSkpIHtcclxuICAgICAgICAgICAgRm9ybVZpZXcuaXNEaXNwbGF5aW5nTmlja25hbWVzID0gIUZvcm1WaWV3LmlzRGlzcGxheWluZ05pY2tuYW1lcztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGUuaXNEb3duKFs2MCAvKiBEeFNjYW5Db2RlLkYyICovXSkpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUoIXRoaXMuc3AuYnJvd3Nlci5pc1Zpc2libGUoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmJhZE1lbnVzT3Blbi5zaXplID09PSAwICYmIGUuaXNEb3duKFs2NCAvKiBEeFNjYW5Db2RlLkY2ICovXSkpIHtcclxuICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gIXRoaXMuc3AuYnJvd3Nlci5pc0ZvY3VzZWQoKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQobmV3U3RhdGUpO1xyXG4gICAgICAgICAgICBpZiAobmV3U3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChmb2N1c0V2ZW50U3RyaW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdCh1bmZvY3VzRXZlbnRTdHJpbmcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmJhZE1lbnVzT3Blbi5zaXplID09PSAwICYmIGUuaXNEb3duKFsyOCAvKiBEeFNjYW5Db2RlLkVudGVyICovXSkpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChmb2N1c0V2ZW50U3RyaW5nKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGUuaXNEb3duKFsxIC8qIER4U2NhbkNvZGUuRXNjYXBlICovXSkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuYnJvd3Nlci5pc0ZvY3VzZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KHVuZm9jdXNFdmVudFN0cmluZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQnJvd3NlclNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICB9O1xyXG4gICAgQnJvd3NlclNlcnZpY2UucHJvdG90eXBlLm9uQnJvd3Nlck1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBvbkZyb250TG9hZGVkRXZlbnRLZXkgPSBcImZyb250LWxvYWRlZFwiO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgYnJvd3NlciBtZXNzYWdlOlwiLCBKU09OLnN0cmluZ2lmeShlLmFyZ3VtZW50cykpO1xyXG4gICAgICAgIGlmIChlLmFyZ3VtZW50c1swXSA9PT0gb25Gcm9udExvYWRlZEV2ZW50S2V5KSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgZnJvbnQtbG9hZGVkIG1lc3NhZ2UsIGVtaXR0aW5nIGJyb3dzZXJXaW5kb3dMb2FkZWQgZXZlbnRcIik7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJicm93c2VyV2luZG93TG9hZGVkXCIsIHt9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQnJvd3NlclNlcnZpY2UucHJvdG90eXBlLm9uTWVudU9wZW4gPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzQmFkTWVudShlLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKGZhbHNlKTtcclxuICAgICAgICAgICAgdGhpcy5iYWRNZW51c09wZW4uYWRkKGUubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKGUubmFtZSA9PT0gXCJIVUQgTWVudVwiIC8qIE1lbnUuSFVEICovKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBCcm93c2VyU2VydmljZS5wcm90b3R5cGUub25NZW51Q2xvc2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmICh0aGlzLmJhZE1lbnVzT3Blbi5kZWxldGUoZS5uYW1lKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5iYWRNZW51c09wZW4uc2l6ZSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGUubmFtZSA9PT0gXCJIVUQgTWVudVwiIC8qIE1lbnUuSFVEICovKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQnJvd3NlclNlcnZpY2UucHJvdG90eXBlLmlzQmFkTWVudSA9IGZ1bmN0aW9uIChtZW51KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYmFkTWVudXMuaW5jbHVkZXMobWVudSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEJyb3dzZXJTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEJyb3dzZXJTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgTmV0d29ya2luZ1NlcnZpY2UgfSBmcm9tIFwiLi9uZXR3b3JraW5nU2VydmljZVwiO1xyXG4vLyBFdmVudHMgdXNlZCBvbiBib3RoIGNsaWVudCBhbmQgYnJvd3NlciBzaWRlXHJcbnZhciBldmVudHMgPSB7XHJcbiAgICBzZWxlY3RDaGFyYWN0ZXI6ICdjaGFyYWN0ZXJTZWxlY3Rfc2VsZWN0JyxcclxuICAgIGNyZWF0ZUNoYXJhY3RlcjogJ2NoYXJhY3RlclNlbGVjdF9jcmVhdGUnLFxyXG4gICAgZGVsZXRlQ2hhcmFjdGVyOiAnY2hhcmFjdGVyU2VsZWN0X2RlbGV0ZScsXHJcbiAgICBiYWNrVG9Mb2dpbjogJ2NoYXJhY3RlclNlbGVjdF9iYWNrJyxcclxufTtcclxudmFyIENoYXJhY3RlclNlbGVjdFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQ2hhcmFjdGVyU2VsZWN0U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIENoYXJhY3RlclNlbGVjdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY2hhcmFjdGVyU2VsZWN0QWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMucmVzZXRBdXRoU3RhdGUgPSBmYWxzZTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjdXN0b21QYWNrZXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkN1c3RvbVBhY2tldE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJicm93c2VyTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Ccm93c2VyTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNyZWF0ZUFjdG9yTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgLy8gTGlzdGVuIGZvciBsb2dpblN1Y2Nlc3MgZXZlbnQgZnJvbSBBdXRoU2VydmljZVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImxvZ2luU3VjY2Vzc1wiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Mb2dpblN1Y2Nlc3MoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLm9uTG9naW5TdWNjZXNzID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGxvZ2luU3VjY2VzcyBldmVudCwgdXNlciBhdXRoZW50aWNhdGVkXCIpO1xyXG4gICAgICAgIC8vIFRoZSBzZXJ2ZXIgd2lsbCBzZW5kIGNoYXJhY3RlciBsaXN0IGF1dG9tYXRpY2FsbHkgYWZ0ZXIgbG9naW5cclxuICAgICAgICAvLyBObyBuZWVkIHRvIHJlcXVlc3QgaXQgaGVyZVxyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLm9uQ3VzdG9tUGFja2V0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHZhciBjb250ZW50ID0gSlNPTi5wYXJzZShldmVudC5tZXNzYWdlLmNvbnRlbnRKc29uRHVtcCk7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoY29udGVudC5jdXN0b21QYWNrZXRUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY2hhcmFjdGVyTGlzdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2hhcmFjdGVyTGlzdChjb250ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjaGFyYWN0ZXJFcnJvclwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2hhcmFjdGVyRXJyb3IoY29udGVudC5tZXNzYWdlIHx8IFwiVW5rbm93biBlcnJvciBvY2N1cnJlZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkVycm9yIHBhcnNpbmcgY3VzdG9tIHBhY2tldDogXCIuY29uY2F0KGUpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUuaGFuZGxlQ2hhcmFjdGVyTGlzdCA9IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBjaGFyYWN0ZXIgbGlzdDogXCIuY29uY2F0KGRhdGEuY2hhcmFjdGVycy5sZW5ndGgsIFwiIGNoYXJhY3RlcnMsIFwiKS5jb25jYXQoZGF0YS5tYXhTbG90cywgXCIgbWF4IHNsb3RzXCIpKTtcclxuICAgICAgICB0aGlzLmNoYXJhY3RlclNlbGVjdEFjdGl2ZSA9IHRydWU7XHJcbiAgICAgICAgLy8gSW5qZWN0IGRhdGEgaW50byB3aW5kb3cgZm9yIGN1c3RvbSBVSSBhY2Nlc3MgKGZvbGxvd2luZyBza3lyaW0tcm9sZXBsYXkgcGF0dGVybilcclxuICAgICAgICB2YXIgaW5qZWN0U2NyaXB0ID0gXCJcXG4gICAgICB3aW5kb3cuc2t5bXAgPSB3aW5kb3cuc2t5bXAgfHwge307XFxuICAgICAgd2luZG93LnNreW1wLmNoYXJhY3RlclNlbGVjdCA9IFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShkYXRhKSwgXCI7XFxuICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdza3ltcDpjaGFyYWN0ZXJMaXN0JywgeyBkZXRhaWw6IFwiKS5jb25jYXQoSlNPTi5zdHJpbmdpZnkoZGF0YSksIFwiIH0pKTtcXG4gICAgXCIpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5leGVjdXRlSmF2YVNjcmlwdChpbmplY3RTY3JpcHQpO1xyXG4gICAgICAgIC8vIFNob3cgYnJvd3NlciBmb3IgY2hhcmFjdGVyIHNlbGVjdGlvbiBVSVxyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgICAgIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKHRydWUpO1xyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLmhhbmRsZUNoYXJhY3RlckVycm9yID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcclxuICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkNoYXJhY3RlciBlcnJvcjogXCIuY29uY2F0KG1lc3NhZ2UpKTtcclxuICAgICAgICAvLyBJbmplY3QgZXJyb3IgaW50byB3aW5kb3cgZm9yIGN1c3RvbSBVSSBhY2Nlc3NcclxuICAgICAgICB2YXIgaW5qZWN0U2NyaXB0ID0gXCJcXG4gICAgICB3aW5kb3cuc2t5bXAgPSB3aW5kb3cuc2t5bXAgfHwge307XFxuICAgICAgd2luZG93LnNreW1wLmNoYXJhY3RlclNlbGVjdEVycm9yID0gXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpLCBcIjtcXG4gICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3NreW1wOmNoYXJhY3RlckVycm9yJywgeyBkZXRhaWw6IFwiKS5jb25jYXQoSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiBtZXNzYWdlIH0pLCBcIiB9KSk7XFxuICAgIFwiKTtcclxuICAgICAgICB0aGlzLnNwLmJyb3dzZXIuZXhlY3V0ZUphdmFTY3JpcHQoaW5qZWN0U2NyaXB0KTtcclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5vbkNyZWF0ZUFjdG9yTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgLy8gSGlkZSBjaGFyYWN0ZXIgc2VsZWN0IHNjcmVlbiB3aGVuIHBsYXllciBzcGF3bnMgaW4gd29ybGRcclxuICAgICAgICBpZiAodGhpcy5jaGFyYWN0ZXJTZWxlY3RBY3RpdmUpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJQbGF5ZXIgc3Bhd25lZCwgaGlkaW5nIGNoYXJhY3RlciBzZWxlY3Qgc2NyZWVuXCIpO1xyXG4gICAgICAgICAgICB2YXIgY2xlYXJTY3JpcHQgPSBcIlxcbiAgICAgICAgaWYgKHdpbmRvdy5za3ltcCkge1xcbiAgICAgICAgICB3aW5kb3cuc2t5bXAuY2hhcmFjdGVyU2VsZWN0ID0gbnVsbDtcXG4gICAgICAgICAgd2luZG93LnNreW1wLmNoYXJhY3RlclNlbGVjdEVycm9yID0gbnVsbDtcXG4gICAgICAgIH1cXG4gICAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA6Y2hhcmFjdGVyTGlzdCcsIHsgZGV0YWlsOiBudWxsIH0pKTtcXG4gICAgICBcIjtcclxuICAgICAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGNsZWFyU2NyaXB0KTtcclxuICAgICAgICAgICAgdGhpcy5jaGFyYWN0ZXJTZWxlY3RBY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUub25Ccm93c2VyTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIGV2ZW50S2V5ID0gZS5hcmd1bWVudHNbMF07XHJcbiAgICAgICAgdmFyIGV2ZW50RGF0YSA9IGUuYXJndW1lbnRzWzFdO1xyXG4gICAgICAgIHN3aXRjaCAoZXZlbnRLZXkpIHtcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuc2VsZWN0Q2hhcmFjdGVyOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kU2VsZWN0Q2hhcmFjdGVyKGV2ZW50RGF0YSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuY3JlYXRlQ2hhcmFjdGVyOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kQ3JlYXRlQ2hhcmFjdGVyKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuZGVsZXRlQ2hhcmFjdGVyOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kRGVsZXRlQ2hhcmFjdGVyKGV2ZW50RGF0YSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBldmVudHMuYmFja1RvTG9naW46XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUJhY2tUb0xvZ2luKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUuc2VuZFNlbGVjdENoYXJhY3RlciA9IGZ1bmN0aW9uICh2aXNpYmxlSWQpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlNlbGVjdGluZyBjaGFyYWN0ZXIgdmlzaWJsZUlkPVwiLmNvbmNhdCh2aXNpYmxlSWQpKTtcclxuICAgICAgICB2YXIgbWVzc2FnZSA9IHtcclxuICAgICAgICAgICAgdDogTXNnVHlwZS5DdXN0b21QYWNrZXQsXHJcbiAgICAgICAgICAgIGNvbnRlbnRKc29uRHVtcDogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgY3VzdG9tUGFja2V0VHlwZTogJ3NlbGVjdENoYXJhY3RlcicsXHJcbiAgICAgICAgICAgICAgICB2aXNpYmxlSWQ6IHZpc2libGVJZCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgQ2hhcmFjdGVyU2VsZWN0U2VydmljZS5wcm90b3R5cGUuc2VuZENyZWF0ZUNoYXJhY3RlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkNyZWF0aW5nIG5ldyBjaGFyYWN0ZXJcIik7XHJcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tUGFja2V0LFxyXG4gICAgICAgICAgICBjb250ZW50SnNvbkR1bXA6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgIGN1c3RvbVBhY2tldFR5cGU6ICdjcmVhdGVDaGFyYWN0ZXInLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBDaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlLnByb3RvdHlwZS5zZW5kRGVsZXRlQ2hhcmFjdGVyID0gZnVuY3Rpb24gKHZpc2libGVJZCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiRGVsZXRpbmcgY2hhcmFjdGVyIHZpc2libGVJZD1cIi5jb25jYXQodmlzaWJsZUlkKSk7XHJcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ3VzdG9tUGFja2V0LFxyXG4gICAgICAgICAgICBjb250ZW50SnNvbkR1bXA6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgIGN1c3RvbVBhY2tldFR5cGU6ICdkZWxldGVDaGFyYWN0ZXInLFxyXG4gICAgICAgICAgICAgICAgdmlzaWJsZUlkOiB2aXNpYmxlSWQsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIENoYXJhY3RlclNlbGVjdFNlcnZpY2UucHJvdG90eXBlLmhhbmRsZUJhY2tUb0xvZ2luID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQmFjayB0byBsb2dpbiAtIHJldHVybmluZyB0byBmcmVzaCBhdXRoIHNjcmVlblwiKTtcclxuICAgICAgICAvLyBTZXQgZmxhZyB0byBwcmV2ZW50IGF1dG8tcmVjb25uZWN0IGluIGF1dGhTZXJ2aWNlXHJcbiAgICAgICAgdGhpcy5yZXNldEF1dGhTdGF0ZSA9IHRydWU7XHJcbiAgICAgICAgLy8gQ2xlYXIgY2hhcmFjdGVyIHNlbGVjdCBkYXRhXHJcbiAgICAgICAgdmFyIGNsZWFyU2NyaXB0ID0gXCJcXG4gICAgICBpZiAod2luZG93LnNreW1wKSB7XFxuICAgICAgICB3aW5kb3cuc2t5bXAuY2hhcmFjdGVyU2VsZWN0ID0gbnVsbDtcXG4gICAgICAgIHdpbmRvdy5za3ltcC5jaGFyYWN0ZXJTZWxlY3RFcnJvciA9IG51bGw7XFxuICAgICAgfVxcbiAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2t5bXA6Y2hhcmFjdGVyTGlzdCcsIHsgZGV0YWlsOiBudWxsIH0pKTtcXG4gICAgXCI7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KGNsZWFyU2NyaXB0KTtcclxuICAgICAgICB0aGlzLmNoYXJhY3RlclNlbGVjdEFjdGl2ZSA9IGZhbHNlO1xyXG4gICAgICAgIC8vIENsb3NlIGNvbm5lY3Rpb24gYW5kIGVuc3VyZSBicm93c2VyIHN0YXlzIHZpc2libGUgZm9yIGF1dGggc2NyZWVuXHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKE5ldHdvcmtpbmdTZXJ2aWNlKS5jbG9zZSgpO1xyXG4gICAgICAgIC8vIEtlZXAgYnJvd3NlciB2aXNpYmxlIGZvciBhdXRoIFVJXHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5zcC5icm93c2VyLnNldEZvY3VzZWQodHJ1ZSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIENoYXJhY3RlclNlbGVjdFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQ2hhcmFjdGVyU2VsZWN0U2VydmljZSB9O1xyXG4iLCI7XHJcbnZhciBDbGllbnRMaXN0ZW5lciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIENsaWVudExpc3RlbmVyKCkge1xyXG4gICAgICAgIC8vIERvbid0IGxldCBUeXBlU2NyaXB0IHRyZWF0IHRoaXMgY2xhc3MgYXMgZW1wdHlcclxuICAgICAgICB0aGlzLl9ub25FbXB0eUNsYXNzTWFyayA9ICcnO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIENsaWVudExpc3RlbmVyO1xyXG59KCkpO1xyXG5leHBvcnQgeyBDbGllbnRMaXN0ZW5lciB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nRXJyb3IsIGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG4vLyBUT0RPOiByZWZhY3RvciB0aGlzIG91dFxyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCB9IGZyb20gXCIuLi8uLi92aWV3L3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgQ21kQXJndW1lbnQ7XHJcbihmdW5jdGlvbiAoQ21kQXJndW1lbnQpIHtcclxuICAgIENtZEFyZ3VtZW50W0NtZEFyZ3VtZW50W1wiT2JqZWN0UmVmZXJlbmNlXCJdID0gMF0gPSBcIk9iamVjdFJlZmVyZW5jZVwiO1xyXG4gICAgQ21kQXJndW1lbnRbQ21kQXJndW1lbnRbXCJCYXNlRm9ybVwiXSA9IDFdID0gXCJCYXNlRm9ybVwiO1xyXG4gICAgQ21kQXJndW1lbnRbQ21kQXJndW1lbnRbXCJJbnRcIl0gPSAyXSA9IFwiSW50XCI7XHJcbiAgICBDbWRBcmd1bWVudFtDbWRBcmd1bWVudFtcIlN0cmluZ1wiXSA9IDNdID0gXCJTdHJpbmdcIjtcclxufSkoQ21kQXJndW1lbnQgfHwgKENtZEFyZ3VtZW50ID0ge30pKTtcclxudmFyIENvbnNvbGVDb21tYW5kc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQ29uc29sZUNvbW1hbmRzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIENvbnNvbGVDb21tYW5kc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuaW1tdW5lU2NoZW1hID0gW1wibXBcIl07XHJcbiAgICAgICAgX3RoaXMubm9uVmFuaWxhQ29tbWFuZHMgPSBbXCJtcFwiXTtcclxuICAgICAgICBfdGhpcy5zY2hlbWFzID0gQ29uc29sZUNvbW1hbmRzU2VydmljZS5jcmVhdGVTY2hlbWFzKCk7XHJcbiAgICAgICAgX3RoaXMuc2V0dXBNcENvbW1hbmQoKTtcclxuICAgICAgICBfdGhpcy5zZXR1cFZhbmlsYUNvbW1hbmRzKCk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQ29uc29sZUNvbW1hbmRzU2VydmljZS5jcmVhdGVTY2hlbWFzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBzY2hlbWFzID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIHNjaGVtYXMuc2V0KFwiYWRkaXRlbVwiLCBbQ21kQXJndW1lbnQuT2JqZWN0UmVmZXJlbmNlLCBDbWRBcmd1bWVudC5CYXNlRm9ybSwgQ21kQXJndW1lbnQuSW50XSk7XHJcbiAgICAgICAgc2NoZW1hcy5zZXQoXCJlcXVpcGl0ZW1cIiwgW0NtZEFyZ3VtZW50Lk9iamVjdFJlZmVyZW5jZSwgQ21kQXJndW1lbnQuQmFzZUZvcm1dKTtcclxuICAgICAgICBzY2hlbWFzLnNldChcInBsYWNlYXRtZVwiLCBbQ21kQXJndW1lbnQuT2JqZWN0UmVmZXJlbmNlLCBDbWRBcmd1bWVudC5CYXNlRm9ybV0pO1xyXG4gICAgICAgIHNjaGVtYXMuc2V0KFwiZGlzYWJsZVwiLCBbQ21kQXJndW1lbnQuT2JqZWN0UmVmZXJlbmNlXSk7XHJcbiAgICAgICAgc2NoZW1hcy5zZXQoXCJtcFwiLCBbQ21kQXJndW1lbnQuT2JqZWN0UmVmZXJlbmNlLCBDbWRBcmd1bWVudC5TdHJpbmddKTtcclxuICAgICAgICByZXR1cm4gc2NoZW1hcztcclxuICAgIH07XHJcbiAgICBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlLnByb3RvdHlwZS5zZXR1cE1wQ29tbWFuZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgY29tbWFuZCA9IHRoaXMuc3AuZmluZENvbnNvbGVDb21tYW5kKFwiIENvbmZpZ3VyZVVNXCIpIHx8IHRoaXMuc3AuZmluZENvbnNvbGVDb21tYW5kKFwidGVzdFwiKTtcclxuICAgICAgICBpZiAoY29tbWFuZCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcImNvbW1hbmQgd2FzIG51bGwgaW4gc2V0dXBNcENvbW1hbmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29tbWFuZC5zaG9ydE5hbWUgPSBcIm1wXCI7XHJcbiAgICAgICAgY29tbWFuZC5leGVjdXRlID0gdGhpcy5nZXRDb21tYW5kRXhlY3V0b3IoXCJtcFwiKTtcclxuICAgIH07XHJcbiAgICBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlLnByb3RvdHlwZS5zZXR1cFZhbmlsYUNvbW1hbmRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZXR0aW5nIHVwIHZhbmlsYSBjb21tYW5kc1wiKTtcclxuICAgICAgICB0aGlzLnNjaGVtYXMuZm9yRWFjaChmdW5jdGlvbiAoXywgY29tbWFuZE5hbWUpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU2V0dGluZyB1cCBjb21tYW5kXCIsIGNvbW1hbmROYW1lKTtcclxuICAgICAgICAgICAgdmFyIGNvbW1hbmQgPSBfdGhpcy5zcC5maW5kQ29uc29sZUNvbW1hbmQoY29tbWFuZE5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoY29tbWFuZCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiY29tbWFuZFwiLCBjb21tYW5kTmFtZSwgXCJ3YXMgbnVsbCBpbiBzZXR1cFZhbmlsYUNvbW1hbmRzXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChfdGhpcy5ub25WYW5pbGFDb21tYW5kcy5pbmNsdWRlcyhjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcImNvbW1hbmRcIiwgY29tbWFuZE5hbWUsIFwiIGlzIG5vbi12YW5pbGEgY29tbWFuZFwiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUgPSBfdGhpcy5nZXRDb21tYW5kRXhlY3V0b3IoY29tbWFuZE5hbWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiVmFuaWxhIGNvbW1hbmRzIHNldCB1cFwiKTtcclxuICAgIH07XHJcbiAgICBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlLnByb3RvdHlwZS5nZXRDb21tYW5kRXhlY3V0b3IgPSBmdW5jdGlvbiAoY29tbWFuZE5hbWUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhcmdzID0gW107XHJcbiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gVE9ETzogaGFuZGxlIHBvc3NpYmxlIGV4Y2VwdGlvbnMgaW4gdGhpcyBmdW5jdGlvblxyXG4gICAgICAgICAgICB2YXIgc2NoZW1hID0gX3RoaXMuc2NoZW1hcy5nZXQoY29tbWFuZE5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoc2NoZW1hID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIlNjaGVtYSBub3QgZm91bmQgZm9yIGNvbW1hbmRcIiwgY29tbWFuZE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCAhPT0gc2NoZW1hLmxlbmd0aCAmJiAhX3RoaXMuaW1tdW5lU2NoZW1hLmluY2x1ZGVzKGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiTWlzbWF0Y2ggZm91bmQgaW4gdGhlIHNjaGVtYSBvZlwiLCBjb21tYW5kTmFtZSwgXCJjb21tYW5kXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChzY2hlbWFbaV0pIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENtZEFyZ3VtZW50Lk9iamVjdFJlZmVyZW5jZTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tpXSA9IGxvY2FsSWRUb1JlbW90ZUlkKHBhcnNlSW50KFwiXCIuY29uY2F0KGFyZ3NbaV0pKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzW2ldICE9PSBcInN0cmluZ1wiICYmIHR5cGVvZiBhcmdzW2ldICE9PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiQmFkIGFyZ3VtZW50IHR5cGUgaW4gY29tbWFuZFwiLCBjb21tYW5kTmFtZSwgXCJhcmd1bWVudCBpbmRleFwiLCBpKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5Db25zb2xlQ29tbWFuZCxcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmROYW1lOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogYXJnc1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyBNZWFudCB0byBiZSBzaG93biB0byB1c2VyLCBub3QgZm9yIGxvZ2dpbmdcclxuICAgICAgICAgICAgX3RoaXMuc3AucHJpbnRDb25zb2xlKFwic2VudFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIENvbnNvbGVDb21tYW5kc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQ29uc29sZUNvbW1hbmRzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxudmFyIF9fYXNzaWduID0gKHRoaXMgJiYgdGhpcy5fX2Fzc2lnbikgfHwgZnVuY3Rpb24gKCkge1xyXG4gICAgX19hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uKHQpIHtcclxuICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHtcclxuICAgICAgICAgICAgcyA9IGFyZ3VtZW50c1tpXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKVxyXG4gICAgICAgICAgICAgICAgdFtwXSA9IHNbcF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0O1xyXG4gICAgfTtcclxuICAgIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG59O1xyXG5pbXBvcnQgeyBwcmludENvbnNvbGUgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGdldFBjSW52ZW50b3J5IH0gZnJvbSBcIi4vcmVtb3RlU2VydmVyXCI7XHJcbmltcG9ydCB7IGdldEludmVudG9yeSwgZ2V0RGlmZiwgaGFzRXh0cmFzLCByZW1vdmVTaW1wbGVJdGVtc0FzTWFueUFzUG9zc2libGUsIHN1bUludmVudG9yaWVzIH0gZnJvbSBcIi4uLy4uL3N5bmMvaW52ZW50b3J5XCI7XHJcbmltcG9ydCB7IExhc3RJbnZTZXJ2aWNlIH0gZnJvbSBcIi4vbGFzdEludlNlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlIH0gZnJvbSBcIi4vc3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IGxvY2FsSWRUb1JlbW90ZUlkIH0gZnJvbSBcIi4uLy4uL3ZpZXcvd29ybGRWaWV3TWlzY1wiO1xyXG52YXIgQ29udGFpbmVyc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoQ29udGFpbmVyc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBDb250YWluZXJzU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBjb250cm9sbGVyLm9uKCdjb250YWluZXJDaGFuZ2VkJywgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQ29udGFpbmVyQ2hhbmdlZChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgQ29udGFpbmVyc1NlcnZpY2UucHJvdG90eXBlLm9uQ29udGFpbmVyQ2hhbmdlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgc3dlZXRDYW50RHJvcFNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlKTtcclxuICAgICAgICBpZiAoZS5vbGRDb250YWluZXIgJiYgZS5uZXdDb250YWluZXIpIHtcclxuICAgICAgICAgICAgaWYgKGUub2xkQ29udGFpbmVyLmdldEZvcm1JRCgpID09PSAweDE0IHx8XHJcbiAgICAgICAgICAgICAgICBlLm5ld0NvbnRhaW5lci5nZXRGb3JtSUQoKSA9PT0gMHgxNCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGxhc3RJbnZTZXJ2aWNlXzEgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoTGFzdEludlNlcnZpY2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFsYXN0SW52U2VydmljZV8xLmxhc3RJbnYpIHtcclxuICAgICAgICAgICAgICAgICAgICBsYXN0SW52U2VydmljZV8xLmxhc3RJbnYgPSBnZXRQY0ludmVudG9yeSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdJbnYgPSBnZXRJbnZlbnRvcnkodGhpcy5zcC5HYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBJdCBzZWVtcyB0aGF0ICdpZ25vcmVXb3JuID0gZmFsc2UnIGZpeGVzIHRoaXM6XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3NreXJpbS1tdWx0aXBsYXllci9pc3N1ZS10cmFja2VyL2lzc3Vlcy80M1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEZvciBzb21lIHJlYXNvbiBleGNlc3MgZGlmZiBpcyBwcm9kdWNlZCB3aGVuICdpZ25vcmVXb3JuID0gdHJ1ZSdcclxuICAgICAgICAgICAgICAgICAgICAvLyBJIHRob3VnaHQgdGhhdCBpdCB3b3VsZCBiZSB2aWNlIHZlcnNhIGJ1dCB0aGF0J3MgaG93IGl0IHdvcmtzXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlnbm9yZVdvcm4gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IGdldERpZmYobGFzdEludlNlcnZpY2VfMS5sYXN0SW52LCBuZXdJbnYsIGlnbm9yZVdvcm4pO1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZSgnZGlmZjonKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpZmYuZW50cmllcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJbXCIuY29uY2F0KGksIFwiXSBcIikuY29uY2F0KEpTT04uc3RyaW5naWZ5KGRpZmYuZW50cmllc1tpXSkpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1zZ3MgPSBkaWZmLmVudHJpZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoZW50cnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogcmV2aWV3IHRoaXMgY29uZGl0aW9uLCBzZWVtcyB0byBiZSBpbmNvcnJlY3RcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5LmNvdW50ID4gMFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBzd2VldENhbnREcm9wU2VydmljZS5jYW5Ecm9wT3JQdXRJdGVtKGVudHJ5LmJhc2VJZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkgeyByZXR1cm4gZW50cnkuY291bnQgIT09IDA7IH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGVudHJ5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5Q29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZW50cnkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1zZyA9IF9fYXNzaWduKF9fYXNzaWduKHt9LCBlbnRyeUNvcHkpLCB7IHQ6IGVudHJ5LmNvdW50ID4gMCA/IE1zZ1R5cGUuUHV0SXRlbSA6IE1zZ1R5cGUuVGFrZUl0ZW0sIHRhcmdldDogZS5vbGRDb250YWluZXIuZ2V0Rm9ybUlEKCkgPT09IDB4MTRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGxvY2FsSWRUb1JlbW90ZUlkKGUubmV3Q29udGFpbmVyLmdldEZvcm1JRCgpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbG9jYWxJZFRvUmVtb3RlSWQoZS5vbGRDb250YWluZXIuZ2V0Rm9ybUlEKCkpIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtc2cuY291bnQgPSBNYXRoLmFicyhtc2cuY291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoKChfYSA9IF90aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGVudHJ5LmJhc2VJZCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXROYW1lKCkpID09PSBtc2cubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG1zZy5uYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtc2c7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbXNncy5mb3JFYWNoKGZ1bmN0aW9uIChtc2cpIHsgcmV0dXJuIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtc2csXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgICAgICB9KTsgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudCBlbWl0dGluZyAxLDIsMyw0LDUgY2hhbmdlcyB3aGVuIHRha2luZy9wdXR0aW5nIDUgcG90aW9ucyBvbmUgYnkgb25lXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjb2RlIG1ha2VzIGl0IDEsMSwxLDEsMSBidXQgd29ya3Mgb25seSBmb3IgZXh0cmEtbGVzcyBpdGVtc1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEF0IHRoZSBtb21lbnQgb2Ygd3JpdGluZyB0aGlzIEkgdGhpbmsgaXQncyBub3QgbmVlZGVkIGZvciBpdGVtcyB3aXRoIGV4dHJhc1xyXG4gICAgICAgICAgICAgICAgICAgIGRpZmYuZW50cmllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEludlNlcnZpY2VfMS5sYXN0SW52ICYmICFoYXNFeHRyYXMoZW50cnkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHV0ID0gZW50cnkuY291bnQgPiAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRha2UgPSBlbnRyeS5jb3VudCA8IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEludlNlcnZpY2VfMS5sYXN0SW52ID0gcmVtb3ZlU2ltcGxlSXRlbXNBc01hbnlBc1Bvc3NpYmxlKGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiwgZW50cnkuYmFzZUlkLCBlbnRyeS5jb3VudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0YWtlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkZCA9IHsgZW50cmllczogW2VudHJ5XSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZC5lbnRyaWVzWzBdLmNvdW50ICo9IC0xO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiA9IHN1bUludmVudG9yaWVzKGxhc3RJbnZTZXJ2aWNlXzEubGFzdEludiwgYWRkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBDb250YWluZXJzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBDb250YWluZXJzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuLy8gVE9ETzogcmVmYWN0b3IgdGhpcyBvdXRcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgQ3JhZnRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKENyYWZ0U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIENyYWZ0U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5mdXJuaXR1cmVTdHJlYWsgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgY29udHJvbGxlci5vbignY29udGFpbmVyQ2hhbmdlZCcsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNvbnRhaW5lckNoYW5nZWQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIENyYWZ0U2VydmljZS5wcm90b3R5cGUub25Db250YWluZXJDaGFuZ2VkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgb2xkQ29udGFpbmVySWQgPSBlLm9sZENvbnRhaW5lciA/IGUub2xkQ29udGFpbmVyLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB2YXIgbmV3Q29udGFpbmVySWQgPSBlLm5ld0NvbnRhaW5lciA/IGUubmV3Q29udGFpbmVyLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB2YXIgYmFzZU9iaklkID0gZS5iYXNlT2JqID8gZS5iYXNlT2JqLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICBpZiAob2xkQ29udGFpbmVySWQgIT09IDB4MTQgJiYgbmV3Q29udGFpbmVySWQgIT09IDB4MTQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZnVybml0dXJlUmVmID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpLmdldEZ1cm5pdHVyZVJlZmVyZW5jZSgpO1xyXG4gICAgICAgIGlmICghZnVybml0dXJlUmVmKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGZ1cm5pdHVyZUlkID0gZnVybml0dXJlUmVmLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIGlmIChvbGRDb250YWluZXJJZCA9PT0gMHgxNCAmJiBuZXdDb250YWluZXJJZCA9PT0gMCkge1xyXG4gICAgICAgICAgICB2YXIgY3JhZnRJbnB1dE9iamVjdHMgPSB0aGlzLmZ1cm5pdHVyZVN0cmVhay5nZXQoZnVybml0dXJlSWQpO1xyXG4gICAgICAgICAgICBpZiAoIWNyYWZ0SW5wdXRPYmplY3RzKSB7XHJcbiAgICAgICAgICAgICAgICBjcmFmdElucHV0T2JqZWN0cyA9IHsgZW50cmllczogW10gfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjcmFmdElucHV0T2JqZWN0cy5lbnRyaWVzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgYmFzZUlkOiBiYXNlT2JqSWQsXHJcbiAgICAgICAgICAgICAgICBjb3VudDogZS5udW1JdGVtcyxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuZnVybml0dXJlU3RyZWFrLnNldChmdXJuaXR1cmVJZCwgY3JhZnRJbnB1dE9iamVjdHMpO1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkFkZGluZyBiYXNlT2JqSWRcIiwgYmFzZU9iaklkLnRvU3RyaW5nKDE2KSwgXCJudW1JdGVtc1wiLCBlLm51bUl0ZW1zLCBcInRvIGNyYWZ0XCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChvbGRDb250YWluZXJJZCA9PT0gMCAmJiBuZXdDb250YWluZXJJZCA9PT0gMHgxNCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnRmluaXNoaW5nIGNyYWZ0Jyk7XHJcbiAgICAgICAgICAgIHZhciBjcmFmdElucHV0T2JqZWN0cyA9IHRoaXMuZnVybml0dXJlU3RyZWFrLmdldChmdXJuaXR1cmVJZCk7XHJcbiAgICAgICAgICAgIGlmIChjcmFmdElucHV0T2JqZWN0cyAmJiBjcmFmdElucHV0T2JqZWN0cy5lbnRyaWVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mdXJuaXR1cmVTdHJlYWsuZGVsZXRlKGZ1cm5pdHVyZUlkKTtcclxuICAgICAgICAgICAgICAgIHZhciB3b3JrYmVuY2ggPSBsb2NhbElkVG9SZW1vdGVJZChmdXJuaXR1cmVJZCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXdvcmtiZW5jaCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwibG9jYWxJZFRvUmVtb3RlSWQgcmV0dXJuZWQgMCBmb3IgZnVybml0dXJlSWRcIiwgZnVybml0dXJlSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciByZXN1bHRPYmplY3RJZCA9IGJhc2VPYmpJZDtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VuZGluZyBjcmFmdCB3b3JrYmVuY2hcIiwgd29ya2JlbmNoLCBcInJlc3VsdE9iamVjdElkXCIsIHJlc3VsdE9iamVjdElkLCBcImNyYWZ0SW5wdXRPYmplY3RzXCIsIEpTT04uc3RyaW5naWZ5KGNyYWZ0SW5wdXRPYmplY3RzLmVudHJpZXMpKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkNyYWZ0SXRlbSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogeyB3b3JrYmVuY2g6IHdvcmtiZW5jaCwgY3JhZnRJbnB1dE9iamVjdHM6IGNyYWZ0SW5wdXRPYmplY3RzLCByZXN1bHRPYmplY3RJZDogcmVzdWx0T2JqZWN0SWQgfSxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBDcmFmdFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgQ3JhZnRTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBBY3RvciB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFJlc3Bhd25OZWVkZWRFcnJvciB9IGZyb20gXCIuLi8uLi9saWIvZXJyb3JzXCI7XHJcbmltcG9ydCB7IEFuaW1hdGlvbkV2ZW50TmFtZSB9IGZyb20gXCIuLi8uLi9zeW5jL2FuaW1hdGlvblwiO1xyXG5pbXBvcnQgeyBSYWdkb2xsU2VydmljZSB9IGZyb20gXCIuL3JhZ2RvbGxTZXJ2aWNlXCI7XHJcbnZhciBEZWF0aFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRGVhdGhTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRGVhdGhTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmFwcGx5RGVhdGhTdGF0ZSA9IGZ1bmN0aW9uIChhY3RvciwgaXNEZWFkKSB7XHJcbiAgICAgICAgICAgIGlmIChhY3Rvci5pc0RlYWQoKSA9PT0gaXNEZWFkICYmIF90aGlzLmlzUGxheWVyKGFjdG9yKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaXNEZWFkID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5raWxsQWN0b3IoYWN0b3IsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMucmVzdXJyZWN0QWN0b3IoYWN0b3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5raWxsQWN0b3IgPSBmdW5jdGlvbiAoYWN0b3IsIGtpbGxlcikge1xyXG4gICAgICAgICAgICBpZiAoa2lsbGVyID09PSB2b2lkIDApIHsga2lsbGVyID0gbnVsbDsgfVxyXG4gICAgICAgICAgICBpZiAoX3RoaXMuaXNQbGF5ZXIoYWN0b3IpID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5wbGF5ZXJEZWFkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmJ1c3lGb3JPdGhlclJlYXNvbnNDb3VudGVyKys7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5VdGlsaXR5LndhaXQoNy41KS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmJ1c3lGb3JPdGhlclJlYXNvbnNDb3VudGVyLS07IH0pO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuYWxsb3dlZFBsYXllckFuaW1hdGlvbnMgPSBbXTtcclxuICAgICAgICAgICAgICAgIGFjdG9yLnNldERvbnRNb3ZlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMua2lsbFdpdGhQdXNoKGFjdG9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGFjdG9yLmVuZERlZmVycmVkS2lsbCgpO1xyXG4gICAgICAgICAgICAgICAgYWN0b3Iua2lsbChraWxsZXIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5yZXN1cnJlY3RBY3RvciA9IGZ1bmN0aW9uIChhY3Rvcikge1xyXG4gICAgICAgICAgICBpZiAoX3RoaXMuaXNQbGF5ZXIoYWN0b3IpID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5wbGF5ZXJEZWFkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5idXN5Rm9yT3RoZXJSZWFzb25zQ291bnRlcisrO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuVXRpbGl0eS53YWl0KDcuNSkudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5idXN5Rm9yT3RoZXJSZWFzb25zQ291bnRlci0tOyB9KTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmFsbG93ZWRQbGF5ZXJBbmltYXRpb25zID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIGFjdG9yLnNldERvbnRNb3ZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnJlc3N1cmVjdFdpdGhQdXNoS2lsbChhY3Rvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUmVzcGF3bk5lZWRlZEVycm9yKFwibmVlZHMgdG8gYmUgcmVzcGF3bmVkXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5raWxsV2l0aFB1c2ggPSBmdW5jdGlvbiAoYWN0b3IpIHtcclxuICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAoX2EgPSBfdGhpcy5hbGxvd2VkUGxheWVyQW5pbWF0aW9ucykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnB1c2goQW5pbWF0aW9uRXZlbnROYW1lLlJhZ2RvbGwpO1xyXG4gICAgICAgICAgICBhY3Rvci5wdXNoQWN0b3JBd2F5KGFjdG9yLCAwKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLnJlc3N1cmVjdFdpdGhQdXNoS2lsbCA9IGZ1bmN0aW9uIChhY3QpIHtcclxuICAgICAgICAgICAgdmFyIGZvcm1JZCA9IGFjdC5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgdmFyIHJhZ2RvbGxTZXJ2aWNlID0gX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSYWdkb2xsU2VydmljZSk7XHJcbiAgICAgICAgICAgIHJhZ2RvbGxTZXJ2aWNlLnNhZmVSZW1vdmVSYWdkb2xsRnJvbVdvcmxkKGFjdCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChmb3JtSWQpKTtcclxuICAgICAgICAgICAgICAgIGlmICghYWN0b3IpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBzaG91bGQgdXNlIGFjdG9yIHZhcmlhYmxlIGluc3RlYWQgb2YgZ2V0UGxheWVyP1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogdXNlIGRpZmZlcmVudCBpR2V0VXBUeXBlIGlmIHJlc3N1cmVjdGluZyB1bmRlciB3YXRlclxyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKS5zZXRBbmltYXRpb25WYXJpYWJsZUludChcImlHZXRVcFR5cGVcIiwgMSk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5EZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQoYWN0b3IsIEFuaW1hdGlvbkV2ZW50TmFtZS5HZXRVcEJlZ2luKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5pc1BsYXllciA9IGZ1bmN0aW9uIChhY3Rvcikge1xyXG4gICAgICAgICAgICByZXR1cm4gYWN0b3IuZ2V0Rm9ybUlEKCkgPT09IF90aGlzLnBsYXllckFjdG9ySWQ7XHJcbiAgICAgICAgfTtcclxuICAgICAgICAvLyBOdWxsIHRvIGFsbG93IGFsbCBhbmltYXRpb25zLiBFbXB0eSBhcnJheSB0byBkaXNhbGxvdyBhbGxcclxuICAgICAgICBfdGhpcy5hbGxvd2VkUGxheWVyQW5pbWF0aW9ucyA9IG51bGw7XHJcbiAgICAgICAgX3RoaXMucGxheWVyQWN0b3JJZCA9IDB4MTQ7XHJcbiAgICAgICAgX3RoaXMucGxheWVyRGVhZCA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmJ1c3lGb3JPdGhlclJlYXNvbnNDb3VudGVyID0gMDtcclxuICAgICAgICBjb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBjb250cm9sbGVyLmVtaXR0ZXIub24oXCJhcHBseURlYXRoU3RhdGVFdmVudFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BcHBseURlYXRoU3RhdGUoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmhvb2tEaXNhYmxlS2lsbE1vdmVzKCk7XHJcbiAgICAgICAgX3RoaXMuaG9va0Rpc2FibGVTdGFnZ2VyKCk7XHJcbiAgICAgICAgX3RoaXMuaG9va0Rpc2FibGVCbG9ja2VkQW5pbXMoKTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBEZWF0aFNlcnZpY2UucHJvdG90eXBlLmlzQnVzeSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wbGF5ZXJEZWFkIHx8IHRoaXMuYnVzeUZvck90aGVyUmVhc29uc0NvdW50ZXIgPiAwO1xyXG4gICAgfTtcclxuICAgIERlYXRoU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgcGxheWVyID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIHBsYXllciA9PT0gbnVsbCB8fCBwbGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBsYXllci5zdGFydERlZmVycmVkS2lsbCgpO1xyXG4gICAgfTtcclxuICAgIERlYXRoU2VydmljZS5wcm90b3R5cGUub25BcHBseURlYXRoU3RhdGUgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuYXBwbHlEZWF0aFN0YXRlKGUuYWN0b3IsIGUuaXNEZWFkKTtcclxuICAgIH07XHJcbiAgICBEZWF0aFNlcnZpY2UucHJvdG90eXBlLmhvb2tEaXNhYmxlS2lsbE1vdmVzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICAgICAgfSwgMHhmZjAwMDAwMCwgMHhmZmZmZmZmZiwgXCJLaWxsTW92ZSpcIik7XHJcbiAgICB9O1xyXG4gICAgRGVhdGhTZXJ2aWNlLnByb3RvdHlwZS5ob29rRGlzYWJsZVN0YWdnZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIGN0eC5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uICgpIHsgfSxcclxuICAgICAgICB9LCAweGZmMDAwMDAwLCAweGZmZmZmZmZmLCBcInN0YWdnZXJTdGFydFwiKTtcclxuICAgIH07XHJcbiAgICBEZWF0aFNlcnZpY2UucHJvdG90eXBlLmhvb2tEaXNhYmxlQmxvY2tlZEFuaW1zID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIGlmIChfdGhpcy5hbGxvd2VkUGxheWVyQW5pbWF0aW9ucyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghX3RoaXMuYWxsb3dlZFBsYXllckFuaW1hdGlvbnMuaW5jbHVkZXMoY3R4LmFuaW1FdmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKCkgeyB9LFxyXG4gICAgICAgIH0sIHRoaXMucGxheWVyQWN0b3JJZCwgdGhpcy5wbGF5ZXJBY3RvcklkKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gRGVhdGhTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IERlYXRoU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgRGlzYWJsZURpZmZpY3VsdHlTZWxlY3Rpb25TZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5kaWZmaWN1bHR5ID0gNTtcclxuICAgICAgICBfdGhpcy5jb3VudGVyID0gMDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5jb3VudGVyKys7XHJcbiAgICAgICAgaWYgKHRoaXMuY291bnRlciA+PSA2MCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvdW50ZXIgPSAwO1xyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkuc2V0SU5JSW50KFwiaURpZmZpY3VsdHk6R2FtZVBsYXlcIiwgdGhpcy5kaWZmaWN1bHR5KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBEaXNhYmxlRGlmZmljdWx0eVNlbGVjdGlvblNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIERpc2FibGVGYXN0VHJhdmVsU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBEaXNhYmxlRmFzdFRyYXZlbFNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5lbmFibGVGYXN0VHJhdmVsKGZhbHNlKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IERpc2FibGVGYXN0VHJhdmVsU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBsb2dFcnJvciB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIHR1cm4gb2ZmIHBsYXllciBsZXZlbCBleHBcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZYUFBlclNraWxsUmFua1wiLCAwKTtcclxuICAgICAgICAvLyB0dXJuIG9mZiBza2lsbCBleHBcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDE4IC8qIEFjdG9yVmFsdWUuQWx0ZXJhdGlvbiAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxOSAvKiBBY3RvclZhbHVlLkNvbmp1cmF0aW9uICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDIwIC8qIEFjdG9yVmFsdWUuRGVzdHJ1Y3Rpb24gKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMjEgLyogQWN0b3JWYWx1ZS5JbGx1c2lvbiAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgyMiAvKiBBY3RvclZhbHVlLlJlc3RvcmF0aW9uICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDIzIC8qIEFjdG9yVmFsdWUuRW5jaGFudGluZyAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCg2IC8qIEFjdG9yVmFsdWUuT25lSGFuZGVkICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDcgLyogQWN0b3JWYWx1ZS5Ud29IYW5kZWQgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoOCAvKiBBY3RvclZhbHVlLkFyY2hlcnkgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoOSAvKiBBY3RvclZhbHVlLkJsb2NrICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDEwIC8qIEFjdG9yVmFsdWUuU21pdGhpbmcgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTEgLyogQWN0b3JWYWx1ZS5IZWF2eUFybW9yICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDEyIC8qIEFjdG9yVmFsdWUuTGlnaHRBcm1vciAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxMyAvKiBBY3RvclZhbHVlLlBpY2twb2NrZXQgKi8pO1xyXG4gICAgICAgIHRoaXMudHVybk9mZlNraWxsTG9jYWxFeHAoMTQgLyogQWN0b3JWYWx1ZS5Mb2NrcGlja2luZyAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxNSAvKiBBY3RvclZhbHVlLlNuZWFrICovKTtcclxuICAgICAgICB0aGlzLnR1cm5PZmZTa2lsbExvY2FsRXhwKDE2IC8qIEFjdG9yVmFsdWUuQWxjaGVteSAqLyk7XHJcbiAgICAgICAgdGhpcy50dXJuT2ZmU2tpbGxMb2NhbEV4cCgxNyAvKiBBY3RvclZhbHVlLlNwZWVjaCAqLyk7XHJcbiAgICB9O1xyXG4gICAgRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2UucHJvdG90eXBlLnR1cm5PZmZTa2lsbExvY2FsRXhwID0gZnVuY3Rpb24gKGF2KSB7XHJcbiAgICAgICAgdmFyIGF2aSA9IHRoaXMuc3AuQWN0b3JWYWx1ZUluZm8uZ2V0QWN0b3JWYWx1ZUluZm9CeUlEKGF2KTtcclxuICAgICAgICBpZiAoYXZpID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiTm90IGZvdW5kIEFjdG9yVmFsdWVJbmZvIGZvciBhY3RvciB2YWx1ZVwiLCBhdik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXZpLnNldFNraWxsVXNlTXVsdCgwKTtcclxuICAgICAgICBhdmkuc2V0U2tpbGxPZmZzZXRNdWx0KDApO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIHJldHVybiBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBEaXNhYmxlU2tpbGxBZHZhbmNlU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSB9IGZyb20gXCIuL3N3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZVwiO1xyXG5pbXBvcnQgeyBXb3JsZENsZWFuZXJTZXJ2aWNlIH0gZnJvbSBcIi4vd29ybGRDbGVhbmVyU2VydmljZVwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBEcm9wSXRlbVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRHJvcEl0ZW1TZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRHJvcEl0ZW1TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oJ2NvbnRhaW5lckNoYW5nZWQnLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Db250YWluZXJDaGFuZ2VkKGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBEcm9wSXRlbVNlcnZpY2UucHJvdG90eXBlLm9uQ29udGFpbmVyQ2hhbmdlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIHN3ZWV0Q2FudERyb3BTZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSk7XHJcbiAgICAgICAgdmFyIHBsID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIHZhciBpc1BsYXllciA9IHBsICYmIGUub2xkQ29udGFpbmVyICYmIHBsLmdldEZvcm1JRCgpID09PSBlLm9sZENvbnRhaW5lci5nZXRGb3JtSUQoKTtcclxuICAgICAgICB2YXIgbm9Db250YWluZXIgPSBlLm5ld0NvbnRhaW5lciA9PT0gbnVsbCB8fCBlLm5ld0NvbnRhaW5lciA9PT0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHZhciBpc1JlZmVyZW5jZSA9IGUucmVmZXJlbmNlICE9PSBudWxsO1xyXG4gICAgICAgIGlmIChlLm5ld0NvbnRhaW5lciAmJiBlLm5ld0NvbnRhaW5lci5nZXRGb3JtSUQoKSA9PT0gcGwuZ2V0Rm9ybUlEKCkpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICBpZiAoIXRoaXMuc3AuVWkuaXNNZW51T3BlbihcIkludmVudG9yeU1lbnVcIikpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICBpZiAoaXNQbGF5ZXIgJiZcclxuICAgICAgICAgICAgaXNSZWZlcmVuY2UgJiZcclxuICAgICAgICAgICAgbm9Db250YWluZXIgJiZcclxuICAgICAgICAgICAgc3dlZXRDYW50RHJvcFNlcnZpY2UuY2FuRHJvcE9yUHV0SXRlbShlLmJhc2VPYmouZ2V0Rm9ybUlEKCkpKSB7XHJcbiAgICAgICAgICAgIHZhciByYWRpdXMgPSAyMDAwO1xyXG4gICAgICAgICAgICB2YXIgYmFzZUlkID0gZS5iYXNlT2JqLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICB2YXIgcGxheWVyID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICB2YXIgc2V0ID0gbmV3IFNldCgpO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDIwMDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVmcklkID0gKF9hID0gdGhpcy5zcC5HYW1lLmZpbmRSYW5kb21SZWZlcmVuY2VPZlR5cGUodGhpcy5zcC5HYW1lLmdldEZvcm1FeChiYXNlSWQpLCBwbGF5ZXIuZ2V0UG9zaXRpb25YKCksIHBsYXllci5nZXRQb3NpdGlvblkoKSwgcGxheWVyLmdldFBvc2l0aW9uWigpLCByYWRpdXMpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmcklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0LmFkZChyZWZySWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIG51bUZvdW5kXzEgPSAwO1xyXG4gICAgICAgICAgICB2YXIgd29ybGRDbGVhbmVyU2VydmljZV8xID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFdvcmxkQ2xlYW5lclNlcnZpY2UpO1xyXG4gICAgICAgICAgICBzZXQuZm9yRWFjaChmdW5jdGlvbiAocmVmcklkKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVmID0gX3RoaXMuc3AuT2JqZWN0UmVmZXJlbmNlLmZyb20oX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmICE9PSBudWxsICYmIHJlZi5pc0RlbGV0ZWQoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVmcklkXzEgPSByZWYuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmxkQ2xlYW5lclNlcnZpY2VfMS5nZXRXY1Byb3RlY3Rpb24ocmVmcklkXzEpID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZi5kZWxldGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgKytudW1Gb3VuZF8xO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJGb3VuZCBhbmQgZGVsZXRlZCByZWZlcmVuY2UgXCIgKyByZWZySWRfMS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRm91bmQgcmVmZXJlbmNlIFwiICsgcmVmcklkXzEudG9TdHJpbmcoMTYpICsgXCIgYnV0IGl0J3MgcHJvdGVjdGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmICghbnVtRm91bmRfMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxvZ1RyYWNlKHRoaXMsIFwiSWdub3JpbmcgaXRlbSBkcm9wIGFzIGZhbHNlIHBvc2l0aXZlXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciB0ID0gTXNnVHlwZS5Ecm9wSXRlbTtcclxuICAgICAgICAgICAgdmFyIGNvdW50ID0gZS5udW1JdGVtcztcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICB0OiB0LFxyXG4gICAgICAgICAgICAgICAgICAgIGJhc2VJZDogYmFzZUlkLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50OiBjb3VudCxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gRHJvcEl0ZW1TZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IERyb3BJdGVtU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBjb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICBjb250cm9sbGVyLmVtaXR0ZXIub24oXCJnYW1lTG9hZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25HYW1lTG9hZChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0SW5DaGFyZ2VuKHRydWUsIHRydWUsIGZhbHNlKTtcclxuICAgIH07XHJcbiAgICBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlLnByb3RvdHlwZS5vbkdhbWVMb2FkID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEluQ2hhcmdlbih0cnVlLCB0cnVlLCBmYWxzZSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRW5mb3JjZUxpbWl0YXRpb25zU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBhdXRoR2FtZURhdGFTdG9yYWdlS2V5IH0gZnJvbSBcIi4uLy4uL2ZlYXR1cmVzL2F1dGhNb2RlbFwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBGcm9udEhvdFJlbG9hZFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoRnJvbnRIb3RSZWxvYWRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gRnJvbnRIb3RSZWxvYWRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIHZhciBlbmFibGUgPSAhIV90aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImVuYWJsZS1mcm9udC1ob3RyZWxvYWRcIl07XHJcbiAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiZW5hYmxlLWZyb250LWhvdHJlbG9hZCBpc1wiLCBlbmFibGUpO1xyXG4gICAgICAgIGlmICghZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBfdGhpcztcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gVE9ETzogcmVmYWN0b3Igb3V0IHZlcnkgc2ltaWxhciBjb2RlIGluIHNreW1wQ2xpZW50LnRzXHJcbiAgICAgICAgdmFyIGF1dGhHYW1lRGF0YSA9IF90aGlzLnNwLnN0b3JhZ2VbYXV0aEdhbWVEYXRhU3RvcmFnZUtleV07XHJcbiAgICAgICAgdmFyIHN0b3JhZ2VIYXNWYWxpZEF1dGhHYW1lRGF0YSA9IChhdXRoR2FtZURhdGEgPT09IG51bGwgfHwgYXV0aEdhbWVEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoR2FtZURhdGEubG9jYWwpIHx8IChhdXRoR2FtZURhdGEgPT09IG51bGwgfHwgYXV0aEdhbWVEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoR2FtZURhdGEucmVtb3RlKTtcclxuICAgICAgICBpZiAoc3RvcmFnZUhhc1ZhbGlkQXV0aEdhbWVEYXRhKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlJlY292ZXJlZCBBdXRoR2FtZURhdGEgZnJvbSBzdG9yYWdlLCBzdGFydGluZyBGcm9udEhvdFJlbG9hZFNlcnZpY2VcIik7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbm5lY3RUb0Zyb250SG90UmVsb2FkKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJVbmFibGUgdG8gcmVjb3ZlciBBdXRoR2FtZURhdGEgZnJvbSBzdG9yYWdlLCB3YWl0aW5nIGZvciBhdXRoXCIpO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJhdXRoQXR0ZW1wdFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BdXRoQXR0ZW1wdChlKTsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEZyb250SG90UmVsb2FkU2VydmljZS5wcm90b3R5cGUub25BdXRoQXR0ZW1wdCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0VG9Gcm9udEhvdFJlbG9hZCgpO1xyXG4gICAgfTtcclxuICAgIEZyb250SG90UmVsb2FkU2VydmljZS5wcm90b3R5cGUuY29ubmVjdFRvRnJvbnRIb3RSZWxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB1cmwgPSBcImxvY2FsaG9zdDoxMjM0XCI7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkxvYWRpbmcgdXJsXCIsIHVybCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLmJyb3dzZXIubG9hZFVybCh1cmwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBGcm9udEhvdFJlbG9hZFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgRnJvbnRIb3RSZWxvYWRTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCwgcmVtb3RlSWRUb0xvY2FsSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG4vLyBUaGUgcmVhc29uIHdlIHVzZSBnbG9iYWwgc2t5cmltUGxhdGZvcm0gaXMgdGhhdCB0aGlzLnNwIG1heSBiZSBsaW1pdGVkLCBhbmQgZ2FtZW1vZGUgYXBpIG5lZWRzIHVubGltaXRlZCBhY2Nlc3MgdG8gc2t5cmltUGxhdGZvcm1cclxuLy8gU2xpZ3RobHkgZGlmZmVyZW50IHR5cGVzXHJcbmltcG9ydCAqIGFzIHNreXJpbVBsYXRmb3JtIGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2VcIjtcclxudmFyIEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEdhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuc2V0dXBFdmVudFNvdXJjZSA9IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGN0eC5fZm4oY3R4KTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCInZXZlbnRTb3VyY2VzXCIsIGN0eC5fZXZlbnROYW1lLCBcIi0gQWRkZWRcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIidldmVudFNvdXJjZXNcIiwgY3R4Ll9ldmVudE5hbWUsIFwiLVwiLCBlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShfdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10pKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXSA9IF90aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXS5maWx0ZXIoZnVuY3Rpb24gKGN0eCkgeyByZXR1cm4gIWN0eC5fZXhwaXJlZDsgfSk7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXS5mb3JFYWNoKGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNldHVwRXZlbnRTb3VyY2UoY3R4KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiZGlzYWJsZS1nYW1lbW9kZS11cGRhdGVzXCJdKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLnN0b3JhZ2VbJ0dhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlX3Nhd0V2ZW50U291cmNlcyddID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkdhbWVtb2RlIHVwZGF0ZXMgYXJlIGRpc2FibGVkIGJ5IHNldHRpbmdzXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiR2FtZW1vZGUgdXBkYXRlcyBhcmUgZGlzYWJsZWQgYnkgc2V0dGluZ3MgLSBwcm9jZXNzaW5nIGZpcnN0IHVwZGF0ZSBvbmx5XCIpO1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbJ0dhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlX3Nhd0V2ZW50U291cmNlcyddID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2VbJ2V2ZW50U291cmNlQ29udGV4dHMnXSA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlWydldmVudFNvdXJjZUNvbnRleHRzJ10uZm9yRWFjaChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBjdHguc2VuZEV2ZW50ID0gZnVuY3Rpb24gKCkgeyB9O1xyXG4gICAgICAgICAgICAgICAgY3R4Ll9leHBpcmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBldmVudFNvdXJjZXNSZWNvcmQgPSB7fTtcclxuICAgICAgICBldmVudC5tZXNzYWdlLmV2ZW50U291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChwYWlyKSB7IHJldHVybiBldmVudFNvdXJjZXNSZWNvcmRbcGFpci5uYW1lXSA9IHBhaXIuY29udGVudDsgfSk7XHJcbiAgICAgICAgdmFyIGV2ZW50TmFtZXMgPSBPYmplY3Qua2V5cyhldmVudFNvdXJjZXNSZWNvcmQpO1xyXG4gICAgICAgIHZhciBibG9ja2VkRXZlbnRTb3VyY2VzID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJibG9ja2VkRXZlbnRTb3VyY2VzXCJdO1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGJsb2NrZWRFdmVudFNvdXJjZXMpKSB7XHJcbiAgICAgICAgICAgIGJsb2NrZWRFdmVudFNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbiAoYmxvY2tlZEV2ZW50U291cmNlKSB7XHJcbiAgICAgICAgICAgICAgICBldmVudE5hbWVzID0gZXZlbnROYW1lcy5maWx0ZXIoZnVuY3Rpb24gKGV2ZW50TmFtZSkgeyByZXR1cm4gZXZlbnROYW1lICE9PSBibG9ja2VkRXZlbnRTb3VyY2U7IH0pO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiJ2V2ZW50U291cmNlc1wiLCBibG9ja2VkRXZlbnRTb3VyY2UsIFwiLSBCbG9ja2VkIGJ5IHRoZSBjbGllbnRcIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSk7XHJcbiAgICAgICAgZXZlbnROYW1lcy5mb3JFYWNoKGZ1bmN0aW9uIChldmVudE5hbWUpIHtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZS52ZXJpZnlTZXJ2ZXJKcyhldmVudFNvdXJjZXNSZWNvcmRbZXZlbnROYW1lXSk7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQuc3JjID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCInZXZlbnRTb3VyY2VzXCIsIGV2ZW50TmFtZSwgJ1ZlcmlmaWNhdGlvbiBmYWlsZWQ6JywgcmVzdWx0LmVycm9yKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZuID0gbmV3IEZ1bmN0aW9uKCdjdHgnLCByZXN1bHQuc3JjKTtcclxuICAgICAgICAgICAgICAgIHZhciBjdHggPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmcjogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgX21vZGVsOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICBpOiAtMSxcclxuICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChfcHJvcE5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiY3R4LmdldCBjYW4ndCBiZSB1c2VkIGluIGV2ZW50IHNvdXJjZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3Bhd246IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiY3R4LnJlc3Bhd24gY2FuJ3QgYmUgdXNlZCBpbiBldmVudCBzb3VyY2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBzcDogc2t5cmltUGxhdGZvcm0sXHJcbiAgICAgICAgICAgICAgICAgICAgc2VuZEV2ZW50OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbUV2ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc0pzb25EdW1wczogYXJncy5tYXAoZnVuY3Rpb24gKGFyZykgeyByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnKTsgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudE5hbWU6IGV2ZW50TmFtZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0Rm9ybUlkSW5TZXJ2ZXJGb3JtYXQ6IGZ1bmN0aW9uIChjbGllbnRzaWRlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbElkVG9SZW1vdGVJZChjbGllbnRzaWRlRm9ybUlkKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGdldEZvcm1JZEluQ2xpZW50Rm9ybWF0OiBmdW5jdGlvbiAoc2VydmVyc2lkZUZvcm1JZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3RlSWRUb0xvY2FsSWQoc2VydmVyc2lkZUZvcm1JZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBfZm46IGZuLFxyXG4gICAgICAgICAgICAgICAgICAgIF9ldmVudE5hbWU6IGV2ZW50TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZToge30sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3Auc3RvcmFnZVsnZXZlbnRTb3VyY2VDb250ZXh0cyddLnB1c2goY3R4KTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNldHVwRXZlbnRTb3VyY2UoY3R4KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiJ2V2ZW50U291cmNlc1wiLCBldmVudE5hbWUsIFwiLVwiLCBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuL3JlbW90ZVNlcnZlclwiO1xyXG4vLyBUT0RPOiByZWZhY3RvclxyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCwgcmVtb3RlSWRUb0xvY2FsSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbi8vIFRoZSByZWFzb24gd2UgdXNlIGdsb2JhbCBza3lyaW1QbGF0Zm9ybSBpcyB0aGF0IHRoaXMuc3AgbWF5IGJlIGxpbWl0ZWQsIGFuZCBnYW1lbW9kZSBhcGkgbmVlZHMgdW5saW1pdGVkIGFjY2VzcyB0byBza3lyaW1QbGF0Zm9ybVxyXG4vLyBTbGlndGhseSBkaWZmZXJlbnQgdHlwZXNcclxuaW1wb3J0ICogYXMgc2t5cmltUGxhdGZvcm0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGxvZ0Vycm9yLCBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuL3NlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZVwiO1xyXG52YXIgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEdhbWVtb2RlVXBkYXRlU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIEdhbWVtb2RlVXBkYXRlU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZUdhbWVtb2RlRGF0YU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DcmVhdGVBY3Rvck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVGljaygpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLnVwZGF0ZU93bmVyQ3R4ID0ge1xyXG4gICAgICAgICAgICBzcDogc2t5cmltUGxhdGZvcm0sXHJcbiAgICAgICAgICAgIHJlZnI6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgX21vZGVsOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGdldEZvcm1JZEluU2VydmVyRm9ybWF0OiBmdW5jdGlvbiAoY2xpZW50c2lkZUZvcm1JZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsSWRUb1JlbW90ZUlkKGNsaWVudHNpZGVGb3JtSWQpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBnZXRGb3JtSWRJbkNsaWVudEZvcm1hdDogZnVuY3Rpb24gKHNlcnZlcnNpZGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZW1vdGVJZFRvTG9jYWxJZChzZXJ2ZXJzaWRlRm9ybUlkKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAocHJvcE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb2RlbFtwcm9wTmFtZV07XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHN0YXRlOiB7fSxcclxuICAgICAgICAgICAgX3ZpZXc6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgaTogLTEsXHJcbiAgICAgICAgICAgIHJlc3Bhd246IGZ1bmN0aW9uICgpIHsgdGhyb3cgbmV3IEVycm9yKFwiY3R4LnJlc3Bhd24gaXMgbm90IGF2YWlsYWJsZSBmb3IgdXBkYXRlT3duZXJcIik7IH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLnVwZGF0ZU5laWdoYm9yQ3R4ID0ge1xyXG4gICAgICAgICAgICByZWZyOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIHZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIF9tb2RlbDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBzcDogc2t5cmltUGxhdGZvcm0sXHJcbiAgICAgICAgICAgIHN0YXRlOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIF92aWV3OiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGk6IC0xLFxyXG4gICAgICAgICAgICBnZXRGb3JtSWRJblNlcnZlckZvcm1hdDogZnVuY3Rpb24gKGNsaWVudHNpZGVGb3JtSWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbElkVG9SZW1vdGVJZChjbGllbnRzaWRlRm9ybUlkKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0Rm9ybUlkSW5DbGllbnRGb3JtYXQ6IGZ1bmN0aW9uIChzZXJ2ZXJzaWRlRm9ybUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3RlSWRUb0xvY2FsSWQoc2VydmVyc2lkZUZvcm1JZCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKHByb3BOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxbcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZXNwYXduOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl92aWV3LmRlc3Ryb3lGb3JtKHRoaXMuaSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIF90aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zS2V5cyA9IFtdO1xyXG4gICAgICAgIF90aGlzLnVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zID0ge307XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5zZXRGb3JtVmlld0FycmF5ID0gZnVuY3Rpb24gKGZvcm1WaWV3QXJyYXkpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4Ll92aWV3ID0gZm9ybVZpZXdBcnJheTtcclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLnNldEkgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JDdHguaSA9IGk7XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS51cGRhdGVOZWlnaGJvciA9IGZ1bmN0aW9uIChyZWZyLCBtb2RlbCwgc3RhdGUpIHtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9hID0gdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9uc0tleXM7IF9pIDwgX2EubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBrZXkgPSBfYVtfaV07XHJcbiAgICAgICAgICAgIHZhciB2ID0gbW9kZWxba2V5XTtcclxuICAgICAgICAgICAgLy8gQWNjb3JkaW5nIHRvIGRvY3M6XHJcbiAgICAgICAgICAgIC8vIEluIGB1cGRhdGVPd25lcmAvYHVwZGF0ZU5laWdoYm9yYCBlcXVhbHMgdG8gYSB2YWx1ZSBvZiBhIGN1cnJlbnRseSBwcm9jZXNzZWQgcHJvcGVydHkuXHJcbiAgICAgICAgICAgIC8vIENhbid0IGJlIGB1bmRlZmluZWRgIGhlcmUsIHNpbmNlIHVwZGF0ZXMgYXJlIG5vdCByZWNlaXZlZCBmb3IgYHVuZGVmaW5lZGAgcHJvcGVydHkgdmFsdWVzLlxyXG4gICAgICAgICAgICAvLyBJbiBvdGhlciBjb250ZXh0cyBpcyBhbHdheXMgYHVuZGVmaW5lZGAuXHJcbiAgICAgICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JDdHgucmVmciA9IHJlZnI7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4LnZhbHVlID0gdjtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTmVpZ2hib3JDdHguX21vZGVsID0gbW9kZWw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU5laWdoYm9yQ3R4LnN0YXRlID0gc3RhdGU7XHJcbiAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnNba2V5XTtcclxuICAgICAgICAgICAgICAgIC8vIEFjdHVhbGx5LCAnZicgc2hvdWxkIGFsd2F5cyBiZSBhIHZhbGlkIGZ1bmN0aW9uLCBidXQgd2hvIGtub3dzXHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy51cGRhdGVOZWlnaGJvckN0eCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcInVwZGF0ZU5laWdoYm9yXCIsIGtleSwgJy0nLCBlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlR2FtZW1vZGVEYXRhTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImRpc2FibGUtZ2FtZW1vZGUtdXBkYXRlc1wiXSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5zdG9yYWdlWydHYW1lbW9kZVVwZGF0ZVNlcnZpY2Vfc2F3VXBkYXRlRnVuY3Rpb25zJ10gPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiR2FtZW1vZGUgdXBkYXRlcyBhcmUgZGlzYWJsZWQgYnkgc2V0dGluZ3NcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJHYW1lbW9kZSB1cGRhdGVzIGFyZSBkaXNhYmxlZCBieSBzZXR0aW5ncyAtIHByb2Nlc3NpbmcgZmlyc3QgdXBkYXRlIG9ubHlcIik7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVsnR2FtZW1vZGVVcGRhdGVTZXJ2aWNlX3Nhd1VwZGF0ZUZ1bmN0aW9ucyddID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zcC5zdG9yYWdlWyd1cGRhdGVOZWlnaGJvckZ1bmN0aW9ucyddID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHRoaXMuc3Auc3RvcmFnZVsndXBkYXRlT3duZXJGdW5jdGlvbnMnXSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLnVwZGF0ZUdhbWVtb2RlVXBkYXRlRnVuY3Rpb25zKCd1cGRhdGVOZWlnaGJvckZ1bmN0aW9ucycsIGV2ZW50Lm1lc3NhZ2UudXBkYXRlTmVpZ2hib3JGdW5jdGlvbnMpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlR2FtZW1vZGVVcGRhdGVGdW5jdGlvbnMoJ3VwZGF0ZU93bmVyRnVuY3Rpb25zJywgZXZlbnQubWVzc2FnZS51cGRhdGVPd25lckZ1bmN0aW9ucyk7XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5vbkNyZWF0ZUFjdG9yTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCFldmVudC5tZXNzYWdlLmlzTWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBPdGhlcndpc2Ugd29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4IG1heSBiZSB1bmFzc2lnbmVkXHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlbW90ZVNlcnZlciA9IF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmVtb3RlU2VydmVyKTtcclxuICAgICAgICAgICAgdmFyIHdvcmxkTW9kZWwgPSByZW1vdGVTZXJ2ZXIuZ2V0V29ybGRNb2RlbCgpO1xyXG4gICAgICAgICAgICB2YXIgbXlGb3JtTW9kZWwgPSB3b3JsZE1vZGVsLmZvcm1zW3dvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeF07XHJcbiAgICAgICAgICAgIGlmICghbXlGb3JtTW9kZWwpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcIlVuYWJsZSB0byBmaW5kIGZvcm1Nb2RlbCB3aXRoIGluZGV4XCIsIHdvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyRm9ybUlkeCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX3RoaXMuc2V0T3duZXJNb2RlbChteUZvcm1Nb2RlbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnByb3RvdHlwZS5vblRpY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGtleXMgPSB0aGlzLnNwLnN0b3JhZ2VbXCJ1cGRhdGVOZWlnaGJvckZ1bmN0aW9uc19rZXlzXCJdO1xyXG4gICAgICAgIGlmIChrZXlzICYmIEFycmF5LmlzQXJyYXkoa2V5cykpIHtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9uc0tleXMgPSBrZXlzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9uc0tleXMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gVE9ETzogU2hvdWxkbid0IHdlIGNoZWNrIHN0b3JhZ2UgdmFsdWUgYmVmb3JlIGFzc2lnbm1lbnQ/XHJcbiAgICAgICAgdGhpcy51cGRhdGVOZWlnaGJvckZ1bmN0aW9ucyA9IHRoaXMuc3Auc3RvcmFnZVtcInVwZGF0ZU5laWdoYm9yRnVuY3Rpb25zXCJdO1xyXG4gICAgfTtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHBsYXllclJlZiA9IHRoaXMuc3AuT2JqZWN0UmVmZXJlbmNlLmZyb20odGhpcy5zcC5HYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICB2YXIga2V5cyA9IHRoaXMuc3Auc3RvcmFnZVtcInVwZGF0ZU93bmVyRnVuY3Rpb25zX2tleXNcIl07XHJcbiAgICAgICAgaWYgKCFrZXlzIHx8ICFBcnJheS5pc0FycmF5KGtleXMpKSB7XHJcbiAgICAgICAgICAgIGtleXMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGZ1bmNzID0gdGhpcy5zcC5zdG9yYWdlW1widXBkYXRlT3duZXJGdW5jdGlvbnNcIl07XHJcbiAgICAgICAgaWYgKHRoaXMuc3Auc3RvcmFnZVtcIm93bmVyTW9kZWxTZXRcIl0gIT09IHRydWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgb3duZXJNb2RlbCA9IHRoaXMuc3Auc3RvcmFnZVtcIm93bmVyTW9kZWxcIl07XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBrZXlzXzEgPSBrZXlzOyBfaSA8IGtleXNfMS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIHByb3BOYW1lID0ga2V5c18xW19pXTtcclxuICAgICAgICAgICAgdmFyIGYgPSBmdW5jc1twcm9wTmFtZV07XHJcbiAgICAgICAgICAgIC8vIEFjdHVhbGx5LCBtdXN0IGFsd2F5cyBiZSBhIHZhbGlkIGZ1bmNpdG9uLCBidXQgd2hvIGtub3dzXHJcbiAgICAgICAgICAgIGlmICghZikge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51cGRhdGVPd25lckN0eC5fbW9kZWwgPSBvd25lck1vZGVsO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMudXBkYXRlT3duZXJDdHguX21vZGVsKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU93bmVyQ3R4LnZhbHVlID0gdGhpcy51cGRhdGVPd25lckN0eC5fbW9kZWxbcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICBpZiAodGhpcy51cGRhdGVPd25lckN0eC52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU93bmVyQ3R4LnJlZnIgPSBwbGF5ZXJSZWY7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlT3duZXJDdHguX21vZGVsID0gb3duZXJNb2RlbDtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGlmIChmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZih0aGlzLnVwZGF0ZU93bmVyQ3R4KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJ1cGRhdGVPd25lclwiLCBwcm9wTmFtZSwgJy0nLCBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UucHJvdG90eXBlLnNldE93bmVyTW9kZWwgPSBmdW5jdGlvbiAob3duZXJNb2RlbCkge1xyXG4gICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcIm93bmVyTW9kZWxcIl0gPSBvd25lck1vZGVsO1xyXG4gICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcIm93bmVyTW9kZWxTZXRcIl0gPSB0cnVlO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEdhbWVtb2RlVXBkYXRlU2VydmljZS5wcm90b3R5cGUudXBkYXRlR2FtZW1vZGVVcGRhdGVGdW5jdGlvbnMgPSBmdW5jdGlvbiAoc3RvcmFnZVZhciwgZnVuY3Rpb25Tb3VyY2VzKSB7XHJcbiAgICAgICAgdmFyIHNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgIHZhciBmdW5jdGlvblNvdXJjZXNSZWNvcmQgPSB7fTtcclxuICAgICAgICBmdW5jdGlvblNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbiAocGFpcikgeyByZXR1cm4gZnVuY3Rpb25Tb3VyY2VzUmVjb3JkW3BhaXIubmFtZV0gPSBwYWlyLmNvbnRlbnQ7IH0pO1xyXG4gICAgICAgIHRoaXMuc3Auc3RvcmFnZVtzdG9yYWdlVmFyXSA9IGZ1bmN0aW9uU291cmNlc1JlY29yZDtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9hID0gT2JqZWN0LmtleXMoZnVuY3Rpb25Tb3VyY2VzUmVjb3JkKTsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gX2FbX2ldO1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gc2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLnZlcmlmeVNlcnZlckpzKHRoaXMuc3Auc3RvcmFnZVtzdG9yYWdlVmFyXVtwcm9wTmFtZV0pO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0LnNyYyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgc3RvcmFnZVZhciwgcHJvcE5hbWUsICdWZXJpZmljYXRpb24gZmFpbGVkOicsIHJlc3VsdC5lcnJvcik7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zcC5zdG9yYWdlW3N0b3JhZ2VWYXJdW3Byb3BOYW1lXTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLnN0b3JhZ2Vbc3RvcmFnZVZhcl1bcHJvcE5hbWVdID0gbmV3IEZ1bmN0aW9uKCdjdHgnLCByZXN1bHQuc3JjKTtcclxuICAgICAgICAgICAgICAgIHZhciBlbXB0eUZ1bmN0aW9uID0gZnVuY3Rpb25Tb3VyY2VzUmVjb3JkW3Byb3BOYW1lXSA9PT0gJyc7XHJcbiAgICAgICAgICAgICAgICBpZiAoZW1wdHlGdW5jdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnNwLnN0b3JhZ2Vbc3RvcmFnZVZhcl1bcHJvcE5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIHN0b3JhZ2VWYXIsIHByb3BOYW1lLCAnQWRkZWQgZW1wdHknKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIHN0b3JhZ2VWYXIsIHByb3BOYW1lLCAnQWRkZWQnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgc3RvcmFnZVZhciwgcHJvcE5hbWUsIGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcIlwiLmNvbmNhdChzdG9yYWdlVmFyLCBcIl9rZXlzXCIpXSA9IE9iamVjdC5rZXlzKHRoaXMuc3Auc3RvcmFnZVtzdG9yYWdlVmFyXSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEdhbWVtb2RlVXBkYXRlU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBHYW1lbW9kZVVwZGF0ZVNlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuLy8gVE9ETzogcmVmYWN0b3IgdGhpcyBvdXRcclxuaW1wb3J0IHsgbG9jYWxJZFRvUmVtb3RlSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbnZhciBIaXRTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKEhpdFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBIaXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnJlY2VudE1hZ2ljSGl0cyA9IG5ldyBNYXAoKTtcclxuICAgICAgICBjb250cm9sbGVyLm9uKCdoaXQnLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25IaXQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIEhpdFNlcnZpY2UucHJvdG90eXBlLm9uSGl0ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAvLyBUT0RPOiBhZGQgbW9yZSBsb2dnaW5nIGluIGNhc2Ugb2YgJ3JldHVybidcclxuICAgICAgICAvLyBUT0RPOiBhbGxvdyBub24td2VhcG9uIHNvdXJjZXNcclxuICAgICAgICB2YXIgYWdncmVzc29yID0gZS5hZ2dyZXNzb3IuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgaWYgKGFnZ3Jlc3NvciA8IDB4ZmYwMDAwMDAgJiYgYWdncmVzc29yICE9PSAweDE0KVxyXG4gICAgICAgICAgICByZXR1cm47IC8vIGFsbCBza3ltcCBucGNzIGFyZSBGRitcclxuICAgICAgICBpZiAoYWdncmVzc29yID49IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgLy8gVE9ETzogbWFrZSBob3N0IHNlcnZpY2VcclxuICAgICAgICAgICAgdmFyIGhvc3RlZCA9IHN0b3JhZ2VbJ2hvc3RlZCddO1xyXG4gICAgICAgICAgICB2YXIgYWxyZWFkeUhvc3RlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShob3N0ZWQpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVtb3RlSWQgPSBsb2NhbElkVG9SZW1vdGVJZChhZ2dyZXNzb3IpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGhvc3RlZC5pbmNsdWRlcyhyZW1vdGVJZCkgfHwgaG9zdGVkLmluY2x1ZGVzKHJlbW90ZUlkICsgMHgxMDAwMDAwMDApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeUhvc3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFhbHJlYWR5SG9zdGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGJhc2UgPSBlLnRhcmdldC5nZXRCYXNlT2JqZWN0KCk7XHJcbiAgICAgICAgdmFyIHR5cGUgPSBiYXNlID09PSBudWxsIHx8IGJhc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJhc2UuZ2V0VHlwZSgpO1xyXG4gICAgICAgIGlmICh0eXBlID09PSAzNCAvKiBGb3JtVHlwZS5TdGF0aWMgKi8gfHwgdHlwZSA9PT0gMzYgLyogRm9ybVR5cGUuTW92YWJsZVN0YXRpYyAqLykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBpc1dlYXBvbiA9IHRoaXMuc3AuV2VhcG9uLmZyb20oZS5zb3VyY2UpO1xyXG4gICAgICAgIHZhciBpc1NwZWxsID0gIWlzV2VhcG9uICYmIHRoaXMuc3AuU3BlbGwuZnJvbShlLnNvdXJjZSk7XHJcbiAgICAgICAgdmFyIGlzU2Nyb2xsID0gIWlzV2VhcG9uICYmICFpc1NwZWxsICYmIHRoaXMuc3AuU2Nyb2xsLmZyb20oZS5zb3VyY2UpO1xyXG4gICAgICAgIGlmICghaXNXZWFwb24gJiYgIWlzU3BlbGwgJiYgIWlzU2Nyb2xsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gcHJldmVudCBkb3VibGUgaGl0IHRoYXQgaGFwcGVucyBmb3Igc29tZSByZWFzb24gd2l0aCBtYWdpYyBwcm9qZWN0aWxlc1xyXG4gICAgICAgIGlmIChpc1NwZWxsIHx8IGlzU2Nyb2xsKSB7XHJcbiAgICAgICAgICAgIHZhciBhZ2dyZXNzb3JJZCA9IGUuYWdncmVzc29yLmdldEZvcm1JRCgpO1xyXG4gICAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgdmFyIGxhc3RIaXRUaW1lID0gdGhpcy5yZWNlbnRNYWdpY0hpdHMuZ2V0KGFnZ3Jlc3NvcklkKTtcclxuICAgICAgICAgICAgaWYgKGxhc3RIaXRUaW1lICYmIG5vdyAtIGxhc3RIaXRUaW1lIDwgMTAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5yZWNlbnRNYWdpY0hpdHMuc2V0KGFnZ3Jlc3NvcklkLCBub3cpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7IHQ6IE1zZ1R5cGUuT25IaXQsIGRhdGE6IHRoaXMuZ2V0SGl0RGF0YShlKSB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgSGl0U2VydmljZS5wcm90b3R5cGUuZ2V0SGl0RGF0YSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIGhpdERhdGEgPSB7XHJcbiAgICAgICAgICAgIGFnZ3Jlc3NvcjogbG9jYWxJZFRvUmVtb3RlSWQoZS5hZ2dyZXNzb3IuZ2V0Rm9ybUlEKCkpLFxyXG4gICAgICAgICAgICBpc0Jhc2hBdHRhY2s6IGUuaXNCYXNoQXR0YWNrLFxyXG4gICAgICAgICAgICBpc0hpdEJsb2NrZWQ6IGUuaXNIaXRCbG9ja2VkLFxyXG4gICAgICAgICAgICBpc1Bvd2VyQXR0YWNrOiBlLmlzUG93ZXJBdHRhY2ssXHJcbiAgICAgICAgICAgIGlzU25lYWtBdHRhY2s6IGUuaXNTbmVha0F0dGFjayxcclxuICAgICAgICAgICAgcHJvamVjdGlsZTogZS5wcm9qZWN0aWxlID8gZS5wcm9qZWN0aWxlLmdldEZvcm1JRCgpIDogMCxcclxuICAgICAgICAgICAgc291cmNlOiBlLnNvdXJjZSA/IGUuc291cmNlLmdldEZvcm1JRCgpIDogMCxcclxuICAgICAgICAgICAgdGFyZ2V0OiBsb2NhbElkVG9SZW1vdGVJZChlLnRhcmdldC5nZXRGb3JtSUQoKSlcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBoaXREYXRhO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBIaXRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IEhpdFNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIEtleWJvYXJkRXZlbnRzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhLZXlib2FyZEV2ZW50c1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBLZXlib2FyZEV2ZW50c1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMubGFzdE51bUtleXMgPSAwO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgS2V5Ym9hcmRFdmVudHNTZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBudW1LZXlzID0gdGhpcy5zcC5JbnB1dC5nZXROdW1LZXlzUHJlc3NlZCgpO1xyXG4gICAgICAgIGlmICh0aGlzLmxhc3ROdW1LZXlzICE9PSBudW1LZXlzKSB7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdE51bUtleXMgPSBudW1LZXlzO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwicXVlcnlLZXlDb2RlQmluZGluZ3NcIiwge1xyXG4gICAgICAgICAgICAgICAgaXNEb3duOiBmdW5jdGlvbiAoYmluZGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nLmV2ZXJ5KGZ1bmN0aW9uIChrZXkpIHsgcmV0dXJuIF90aGlzLnNwLklucHV0LmlzS2V5UHJlc3NlZChrZXkpOyB9KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIEtleWJvYXJkRXZlbnRzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBLZXlib2FyZEV2ZW50c1NlcnZpY2UgfTtcclxuO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgTGFzdEludlNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoTGFzdEludlNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBMYXN0SW52U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTGFzdEludlNlcnZpY2UucHJvdG90eXBlLCBcImxhc3RJbnZcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbGFzdEludjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKG5ld1ZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xhc3RJbnYgPSBuZXdWYWx1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gTGFzdEludlNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgTGFzdEludlNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxudmFyIExvYWRHYW1lU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhMb2FkR2FtZVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBMb2FkR2FtZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuX2lzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybSA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJsb2FkR2FtZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbkxvYWRHYW1lKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIExvYWRHYW1lU2VydmljZS5wcm90b3R5cGUubG9hZEdhbWUgPSBmdW5jdGlvbiAocG9zLCByb3QsIHdvcmxkT3JDZWxsLCBjaGFuZ2VGb3JtTnBjLCBsb2FkT3JkZXIsIHRpbWUpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHRoaXMuc3AubG9hZEdhbWUocG9zLCByb3QsIHdvcmxkT3JDZWxsLCBjaGFuZ2VGb3JtTnBjLCBsb2FkT3JkZXIsIHRpbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAvLyBIb3RmaXggbm9uLXZhbmlsbGEgaGVhZHBhcnRzIGJ1Z1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHRoaXMuc3AubG9hZEdhbWUocG9zLCByb3QsIHdvcmxkT3JDZWxsLCB1bmRlZmluZWQsIGxvYWRPcmRlciwgdGltZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2lzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybSA9IHRydWU7XHJcbiAgICB9O1xyXG4gICAgTG9hZEdhbWVTZXJ2aWNlLnByb3RvdHlwZS5vbkxvYWRHYW1lID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdmFyIGdhbWVMb2FkRXZlbnQgPSB7XHJcbiAgICAgICAgICAgICAgICBpc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm06IHRoaXMuX2lzQ2F1c2VkQnlTa3lyaW1QbGF0Zm9ybVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiZ2FtZUxvYWRcIiwgZ2FtZUxvYWRFdmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5faXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInRpY2tcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBfdGhpcy5faXNDYXVzZWRCeVNreXJpbVBsYXRmb3JtID0gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIExvYWRHYW1lU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBMb2FkR2FtZVNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IEdhbWUsIFV0aWxpdHksIHByaW50Q29uc29sZSwgY3JlYXRlVGV4dCwgc2V0VGV4dFNpemUgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgZ2V0U2NyZWVuUmVzb2x1dGlvbiB9IGZyb20gXCIuLi8uLi92aWV3L2Zvcm1WaWV3XCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXR0aW5nc1NlcnZpY2VcIjtcclxudmFyIFNUQVRFX0tFWSA9ICdsb2FkT3JkZXJDaGVja1N0YXRlJztcclxuO1xyXG52YXIgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMudmVyaWZ5TG9hZE9yZGVyKCk7XHJcbiAgICB9O1xyXG4gICAgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUudmVyaWZ5TG9hZE9yZGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHNldHRpbmdzU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXR0aW5nc1NlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMucmVzZXRUZXh0KCk7XHJcbiAgICAgICAgdmFyIGNsaWVudE1vZHMgPSB0aGlzLmdldENsaWVudE1vZHMoKTtcclxuICAgICAgICB0aGlzLnByaW50TW9kT3JkZXIoJ0NsaWVudCBsb2FkIG9yZGVyOicsIGNsaWVudE1vZHMpO1xyXG4gICAgICAgIHJldHVybiBzZXR0aW5nc1NlcnZpY2UuZ2V0U2VydmVyTW9kcygpXHJcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChzZXJ2ZXJNb2RzKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnByaW50TW9kT3JkZXIoJ1NlcnZlciBsb2FkIG9yZGVyOicsIHNlcnZlck1vZHMpO1xyXG4gICAgICAgICAgICBpZiAoY2xpZW50TW9kcy5sZW5ndGggPCBzZXJ2ZXJNb2RzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWlzc2luZyBzb21lIHNlcnZlciBtb2RzLiBTZXJ2ZXIgaGFzIFwiLmNvbmNhdChzZXJ2ZXJNb2RzLmxlbmd0aCwgXCIsIHdlIGhhdmUgXCIpLmNvbmNhdChjbGllbnRNb2RzLmxlbmd0aCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChjbGllbnRNb2RzLmxlbmd0aCA+IHNlcnZlck1vZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy51cGRhdGVUZXh0KCdMT0FEIE9SREVSIFdBUk5JTkc6IHlvdSBoYXZlIG1vcmUgbW9kcyB0aGFuIHNlcnZlciFcXG4ob3IgY291bGQgbm90IHJlY2VpdmUgc2VydmVyIG1vZCBsaXN0KVxcbkNoZWNrIGNvbnNvbGUgZm9yIGRldGFpbHMuJywgWzI1NSwgMjU1LCAwLCAxXSwgNSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGZhaWwgPSBbXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZXJ2ZXJNb2RzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBOZWVkIGNhc2UtaW5zZW5zaXRpdmUgY2hlY2sgZm9yIDEuNitcclxuICAgICAgICAgICAgICAgIGlmIChjbGllbnRNb2RzW2ldLmZpbGVuYW1lLnRvTG93ZXJDYXNlKCkgIT09IHNlcnZlck1vZHNbaV0uZmlsZW5hbWUudG9Mb3dlckNhc2UoKSB8fFxyXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudE1vZHNbaV0uc2l6ZSAhPT0gc2VydmVyTW9kc1tpXS5zaXplIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50TW9kc1tpXS5jcmMzMiAhPT0gc2VydmVyTW9kc1tpXS5jcmMzMikge1xyXG4gICAgICAgICAgICAgICAgICAgIGZhaWwucHVzaChpKTtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJcIi5jb25jYXQoaSwgXCItdGggbW9kIChudW1iZXJlZCBmcm9tIDApIGRvZXMgbm90IG1hdGNoLlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiU2VydmVyIGhhcyBcIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkoc2VydmVyTW9kc1tpXSkpKTtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJXZSBoYXZlIFwiLmNvbmNhdChKU09OLnN0cmluZ2lmeShjbGllbnRNb2RzW2ldKSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChmYWlsLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdMb2FkIG9yZGVyIGNoZWNrIGZhaWxlZCEgSW5kaWNlczogJyArIEpTT04uc3RyaW5naWZ5KGZhaWwpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgIHByaW50Q29uc29sZShlcnIpO1xyXG4gICAgICAgICAgICBpZiAoX3RoaXMuc3Auc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnaWdub3JlTG9hZE9yZGVyTWlzbWF0Y2gnXSkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMudXBkYXRlVGV4dCgnTE9BRCBPUkRFUiBFUlJPUiFcXG5Ib3dldmVyLCBpZ25vcmluZyBpdCBiZWNhdXNlIG9mIGlnbm9yZUxvYWRPcmRlck1pc21hdGNoIGJlaW5nIHNldC4nICtcclxuICAgICAgICAgICAgICAgICAgICAnXFxuRXhwZWN0IEVWRVJZVEhJTkcgQlJFQUssIHVubGVzcyB5b3Uga25vdyB3aGF0IHlvdSBhcmUgZG9pbmcuXFxuQ2hlY2sgY29uc29sZSBmb3IgZGV0YWlscy4nICtcclxuICAgICAgICAgICAgICAgICAgICAnXFxuVGhpcyBtZXNzYWdlIHdpbGwgZGlzYXBwZWFyIGFmdGVyIDMwIHNlY29uZHMuJywgWzI1NSwgMCwgMCwgMV0sIDMwKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBfdGhpcy51cGRhdGVUZXh0KCdMT0FEIE9SREVSIEVSUk9SIVxcbkNoZWNrIGNvbnNvbGUgZm9yIGRldGFpbHMuJywgWzI1NSwgMCwgMCwgMV0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgdGhpcy5zcC5zdG9yYWdlW1NUQVRFX0tFWV0gIT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3Auc3RvcmFnZVtTVEFURV9LRVldO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHJlcGxhY2VtZW50KSB7XHJcbiAgICAgICAgdmFyIG9sZFN0YXRlID0gdGhpcy5zcC5zdG9yYWdlW1NUQVRFX0tFWV0gPSB0aGlzLmdldFN0YXRlKCk7XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfYSA9IE9iamVjdC5lbnRyaWVzKHJlcGxhY2VtZW50KTsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgdmFyIF9iID0gX2FbX2ldLCBrID0gX2JbMF0sIHYgPSBfYlsxXTtcclxuICAgICAgICAgICAgb2xkU3RhdGVba10gPSB2O1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5yZXNldFRleHQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHN0YXR1c1RleHRJZCA9IHRoaXMuZ2V0U3RhdGUoKS5zdGF0dXNUZXh0SWQ7XHJcbiAgICAgICAgaWYgKHN0YXR1c1RleHRJZCkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHN0YXR1c1RleHRJZCk7XHJcbiAgICAgICAgICAgIHN0YXR1c1RleHRJZCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IHN0YXR1c1RleHRJZDogc3RhdHVzVGV4dElkIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS51cGRhdGVUZXh0ID0gZnVuY3Rpb24gKHRleHQsIGNvbG9yLCBjbGVhckRlbGF5KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2EgPSBnZXRTY3JlZW5SZXNvbHV0aW9uKCksIHdpZHRoID0gX2Eud2lkdGgsIGhlaWdodCA9IF9hLmhlaWdodDtcclxuICAgICAgICB0aGlzLnJlc2V0VGV4dCgpO1xyXG4gICAgICAgIHZhciBzdGF0dXNUZXh0SWQgPSBjcmVhdGVUZXh0KHdpZHRoIC8gMiwgaGVpZ2h0IC8gMiwgdGV4dCwgY29sb3IpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHN0YXR1c1RleHRJZCwgMC41KTtcclxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgc3RhdHVzVGV4dElkOiBzdGF0dXNUZXh0SWQgfSk7XHJcbiAgICAgICAgaWYgKGNsZWFyRGVsYXkpIHtcclxuICAgICAgICAgICAgVXRpbGl0eS53YWl0KGNsZWFyRGVsYXkpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMucmVzZXRUZXh0KCk7IH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5lbnVtZXJhdGVDbGllbnRNb2RzID0gZnVuY3Rpb24gKGdldENvdW50LCBnZXRBdCkge1xyXG4gICAgICAgIHZhciByZXN1bHQgPSBbXTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdldENvdW50KCk7ICsraSkge1xyXG4gICAgICAgICAgICB2YXIgZmlsZW5hbWUgPSBnZXRBdChpKTtcclxuICAgICAgICAgICAgdmFyIF9hID0gdGhpcy5nZXRGaWxlSW5mb1NhZmUoZmlsZW5hbWUpLCBjcmMzMiA9IF9hLmNyYzMyLCBzaXplID0gX2Euc2l6ZTtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2goeyBmaWxlbmFtZTogZmlsZW5hbWUsIGNyYzMyOiBjcmMzMiwgc2l6ZTogc2l6ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH07XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5nZXRDbGllbnRNb2RzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmVudW1lcmF0ZUNsaWVudE1vZHMoR2FtZS5nZXRNb2RDb3VudCwgR2FtZS5nZXRNb2ROYW1lKTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS5wcmludE1vZE9yZGVyID0gZnVuY3Rpb24gKGhlYWRlciwgb3JkZXIpIHtcclxuICAgICAgICBwcmludENvbnNvbGUoaGVhZGVyKTtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9hID0gT2JqZWN0LmVudHJpZXMob3JkZXIpOyBfaSA8IF9hLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIgX2IgPSBfYVtfaV0sIGkgPSBfYlswXSwgbW9kID0gX2JbMV07XHJcbiAgICAgICAgICAgIHByaW50Q29uc29sZShcIiNcIi5jb25jYXQoaSwgXCIgXCIpLmNvbmNhdChKU09OLnN0cmluZ2lmeShtb2QpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIDtcclxuICAgIExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLmdldEZpbGVJbmZvU2FmZSA9IGZ1bmN0aW9uIChmaWxlbmFtZSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNwLmdldEZpbGVJbmZvKGZpbGVuYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBlLm1lc3NhZ2U7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gXCJzdHJpbmdcIiAmJiBtZXNzYWdlLmluY2x1ZGVzKCdpcyBub3QgYSB2YWxpZCBhcmd1bWVudCcpKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkZhaWxlZCB0byBnZXQgZmlsZSBpbmZvIGZvclwiLCBmaWxlbmFtZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjcmMzMjogMCwgc2l6ZTogMCB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBMb2FkT3JkZXJWZXJpZmljYXRpb25TZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG4vLyBUT0RPOiByZWZhY3RvciB0aGlzIG91dFxyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCwgcmVtb3RlSWRUb0xvY2FsSWQgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbi8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbmltcG9ydCB7IEdhbWUsIGdldEFuaW1hdGlvblZhcmlhYmxlc0Zyb21BY3RvciwgU3BlbGxUeXBlIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gJy4vY2xpZW50TGlzdGVuZXInO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbnZhciBNYWdpY1N5bmNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKE1hZ2ljU3luY1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBNYWdpY1N5bmNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnBsYXllcklkID0gMHgxNDtcclxuICAgICAgICBfdGhpcy5zZW5kVXBkYXRlQW5pbWF0aW9uVmFyaWFibGVzUmF0ZU1zID0gNTAwO1xyXG4gICAgICAgIF90aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZyA9IG51bGw7XHJcbiAgICAgICAgX3RoaXMubGFzdFNlbmRVcGRhdGVBbmltYXRpb25WYXJpYWJsZXMgPSAwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInNwZWxsQ2FzdFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TcGVsbENhc3QoZSk7IH0pO1xyXG4gICAgICAgIHZhciBzZWxmID0gX3RoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7IH0sXHJcbiAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLm9uU2VuZEFuaW1hdGlvbkV2ZW50TGVhdmUoY3R4KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIF90aGlzLnBsYXllcklkLCBfdGhpcy5wbGF5ZXJJZCk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUub25VcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAodGhpcy5pc0FueU1hZ2ljU3R1ZmZFcXVpcGVkKCkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKERhdGUubm93KCkgLSB0aGlzLmxhc3RTZW5kVXBkYXRlQW5pbWF0aW9uVmFyaWFibGVzIDw9IHRoaXMuc2VuZFVwZGF0ZUFuaW1hdGlvblZhcmlhYmxlc1JhdGVNcykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubGFzdFNlbmRVcGRhdGVBbmltYXRpb25WYXJpYWJsZXMgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgIGlmICghYWMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgYW5pbVZhcmlhYmxlcyA9IF90aGlzLmdldEFuaW1hdGlvblZhcmlhYmxlc0Zyb21BY3RvckNvbnZlcnRlZChhYy5nZXRGb3JtSUQoKSk7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogeyB0OiBNc2dUeXBlLlVwZGF0ZUFuaW1WYXJpYWJsZXMsIGRhdGE6IF90aGlzLmdldFVwZGF0ZUFuaW1WYXJpYWJsZXNFdmVudERhdGEoYWMsIGFuaW1WYXJpYWJsZXMpIH0sXHJcbiAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLm9uU3BlbGxDYXN0ID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIGlzSW50ZXJydXB0Q2FzdCA9IGZhbHNlO1xyXG4gICAgICAgIHZhciBtc2cgPSB0aGlzLmdldFNwZWxsQ2FzdEV2ZW50RGF0YShldmVudCwgaXNJbnRlcnJ1cHRDYXN0KTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7IHQ6IE1zZ1R5cGUuU3BlbGxDYXN0LCBkYXRhOiBtc2cgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnID0gbXNnO1xyXG4gICAgfTtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZEFuaW1hdGlvbkV2ZW50TGVhdmUgPSBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoIXRoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnIHx8ICF0aGlzLmlzSW50ZXJhcHRTcGVsbENhc3RBbmltKGN0eC5hbmltRXZlbnROYW1lKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghX3RoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnIHx8IF90aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZy5pbnRlcnJ1cHRDYXN0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIG1zZyA9IF90aGlzLmxhc3RTcGVsbENhc3RFdmVudE1zZztcclxuICAgICAgICAgICAgbXNnLmludGVycnVwdENhc3QgPSB0cnVlO1xyXG4gICAgICAgICAgICBtc2cuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMgPSBfdGhpcy5nZXRBbmltYXRpb25WYXJpYWJsZXNGcm9tQWN0b3JDb252ZXJ0ZWQocmVtb3RlSWRUb0xvY2FsSWQoX3RoaXMubGFzdFNwZWxsQ2FzdEV2ZW50TXNnLmNhc3RlcikpO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHsgdDogTXNnVHlwZS5TcGVsbENhc3QsIGRhdGE6IG1zZyB9LFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBNYWdpY1N5bmNTZXJ2aWNlLnByb3RvdHlwZS5nZXRTcGVsbENhc3RFdmVudERhdGEgPSBmdW5jdGlvbiAoZSwgaXNJbnRlcnJ1cHRDYXN0KSB7XHJcbiAgICAgICAgdmFyIHNwZWxsQ2FzdERhdGEgPSB7XHJcbiAgICAgICAgICAgIGNhc3RlcjogbG9jYWxJZFRvUmVtb3RlSWQoZS5jYXN0ZXIuZ2V0Rm9ybUlEKCksIHRydWUpLFxyXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgICAgICB0YXJnZXQ6IGUudGFyZ2V0ID8gbG9jYWxJZFRvUmVtb3RlSWQoZS50YXJnZXQuZ2V0Rm9ybUlEKCksIHRydWUpIDogMCxcclxuICAgICAgICAgICAgc3BlbGw6IGUuc3BlbGwgPyBlLnNwZWxsLmdldEZvcm1JRCgpIDogMCxcclxuICAgICAgICAgICAgaW50ZXJydXB0Q2FzdDogaXNJbnRlcnJ1cHRDYXN0LFxyXG4gICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG4gICAgICAgICAgICBpc0R1YWxDYXN0aW5nOiBlLmlzRHVhbENhc3RpbmcsXHJcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgICAgIGNhc3RpbmdTb3VyY2U6IGUuY2FzdGluZ1NvdXJjZSxcclxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuICAgICAgICAgICAgYWltQW5nbGU6IGUuYWltQW5nbGUsXHJcbiAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgICAgIGFpbUhlYWRpbmc6IGUuYWltSGVhZGluZyxcclxuICAgICAgICAgICAgYWN0b3JBbmltYXRpb25WYXJpYWJsZXM6IHRoaXMuZ2V0QW5pbWF0aW9uVmFyaWFibGVzRnJvbUFjdG9yQ29udmVydGVkKGUuY2FzdGVyLmdldEZvcm1JRCgpKSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBzcGVsbENhc3REYXRhO1xyXG4gICAgfTtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLmdldEFuaW1hdGlvblZhcmlhYmxlc0Zyb21BY3RvckNvbnZlcnRlZCA9IGZ1bmN0aW9uIChhY3RvcklkKSB7XHJcbiAgICAgICAgdmFyIGFuaW1WYXJzID0gZ2V0QW5pbWF0aW9uVmFyaWFibGVzRnJvbUFjdG9yKGFjdG9ySWQpO1xyXG4gICAgICAgIHZhciBib29sZWFucyA9IGFuaW1WYXJzLmJvb2xlYW5zO1xyXG4gICAgICAgIHZhciBmbG9hdHMgPSBhbmltVmFycy5mbG9hdHM7XHJcbiAgICAgICAgdmFyIGludGVnZXJzID0gYW5pbVZhcnMuaW50ZWdlcnM7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgYm9vbGVhbnM6IEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoYm9vbGVhbnMpKSxcclxuICAgICAgICAgICAgZmxvYXRzOiBBcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGZsb2F0cykpLFxyXG4gICAgICAgICAgICBpbnRlZ2VyczogQXJyYXkuZnJvbShuZXcgVWludDhBcnJheShpbnRlZ2VycykpLFxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUuZ2V0VXBkYXRlQW5pbVZhcmlhYmxlc0V2ZW50RGF0YSA9IGZ1bmN0aW9uIChhYywgYW5pbVZhcmlhYmxlcykge1xyXG4gICAgICAgIHZhciBhbmltVmFyc0RhdGEgPSB7XHJcbiAgICAgICAgICAgIGFjdG9yUmVtb3RlSWQ6IGxvY2FsSWRUb1JlbW90ZUlkKGFjLmdldEZvcm1JRCgpLCB0cnVlKSxcclxuICAgICAgICAgICAgYWN0b3JBbmltYXRpb25WYXJpYWJsZXM6IGFuaW1WYXJpYWJsZXMsXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gYW5pbVZhcnNEYXRhO1xyXG4gICAgfTtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLmlzSW50ZXJhcHRTcGVsbENhc3RBbmltID0gZnVuY3Rpb24gKGFuaW1FdmVudE5hbWUpIHtcclxuICAgICAgICB2YXIgZXZlbnROYW1lID0gYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIHJldHVybiBldmVudE5hbWUgPT09IFwibWxoX2VxdWlwcGVkX2V2ZW50XCIgfHwgZXZlbnROYW1lID09PSBcIm1yaF9lcXVpcHBlZF9ldmVudFwiO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIE1hZ2ljU3luY1NlcnZpY2UucHJvdG90eXBlLmlzU3BlbGxDYXN0QW5pbSA9IGZ1bmN0aW9uIChhbmltRXZlbnROYW1lKSB7XHJcbiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGFuaW1FdmVudE5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB2YXIgaXNTcGVsbENhc3RBbmltRm9yTGVmdEhhbmQgPSBldmVudE5hbWUgPT09IFwibWxoX3NwZWxsYWltZWRjb25jZW50cmF0aW9uc3RhcnRcIiB8fCBldmVudE5hbWUgPT09IFwibWxoX3NwZWxsYWltZWRzdGFydFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtbGhfc3BlbGxyZWFkeV9ldmVudFwiIHx8XHJcbiAgICAgICAgICAgIGV2ZW50TmFtZSA9PT0gXCJtbGhfc3BlbGxyZWxlYXNlX2V2ZW50XCIgfHwgZXZlbnROYW1lID09PSBcIm1saF9lcXVpcHBlZF9ldmVudFwiO1xyXG4gICAgICAgIHZhciBpc1NwZWxsQ2FzdEFuaW1Gb3JSaWdodEhhbmQgPSBldmVudE5hbWUgPT09IFwibXJoX3NwZWxsYWltZWRjb25jZW50cmF0aW9uc3RhcnRcIiB8fCBldmVudE5hbWUgPT09IFwibXJoX3NwZWxsYWltZWRzdGFydFwiIHx8IGV2ZW50TmFtZSA9PT0gXCJtcmhfc3BlbGxyZWFkeV9ldmVudFwiIHx8XHJcbiAgICAgICAgICAgIGV2ZW50TmFtZSA9PT0gXCJtcmhfc3BlbGxyZWxlYXNlX2V2ZW50XCIgfHwgZXZlbnROYW1lID09PSBcIm1yaF9lcXVpcHBlZF9ldmVudFwiO1xyXG4gICAgICAgIHJldHVybiBpc1NwZWxsQ2FzdEFuaW1Gb3JMZWZ0SGFuZCB8fCBpc1NwZWxsQ2FzdEFuaW1Gb3JSaWdodEhhbmQ7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgTWFnaWNTeW5jU2VydmljZS5wcm90b3R5cGUuaXNBbnlNYWdpY1N0dWZmRXF1aXBlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgYWMgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIGlmICghYWMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYWMuZ2V0RXF1aXBwZWRTcGVsbChTcGVsbFR5cGUuTGVmdCkgfHwgYWMuZ2V0RXF1aXBwZWRTcGVsbChTcGVsbFR5cGUuUmlnaHQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYWMuZ2V0RXF1aXBwZWRTcGVsbChTcGVsbFR5cGUuVm9pc2UpIHx8IGFjLmdldEVxdWlwcGVkU3BlbGwoU3BlbGxUeXBlLkluc3RhbnQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbGVmdEhhbmRFcXVpcG1lbnRUeXBlID0gYWMuZ2V0RXF1aXBwZWRJdGVtVHlwZSgxIC8qIFNsb3RUeXBlLkxlZnQgKi8pO1xyXG4gICAgICAgIHZhciByaWdodEhhbmRFcXVpcG1lbnRUeXBlID0gYWMuZ2V0RXF1aXBwZWRJdGVtVHlwZSgyIC8qIFNsb3RUeXBlLlJpZ2h0ICovKTtcclxuICAgICAgICAvLyBUT0RPOiBTcGVsbCA9PiBTcGVsbE9yU2Nyb2xsLCBzaW5jZSBTcGVsbCBpcyBub3cgYSBkZXByZWNhdGVkIG5hbWUgKFRPRE86IFJlbW92ZSBpbiAyLjEwLjApXHJcbiAgICAgICAgaWYgKGxlZnRIYW5kRXF1aXBtZW50VHlwZSA9PT0gOSAvKiBFcXVpcHBlZEl0ZW1UeXBlLlNwZWxsICovIHx8IGxlZnRIYW5kRXF1aXBtZW50VHlwZSA9PT0gOCAvKiBFcXVpcHBlZEl0ZW1UeXBlLlN0YWZmICovIHx8XHJcbiAgICAgICAgICAgIHJpZ2h0SGFuZEVxdWlwbWVudFR5cGUgPT09IDkgLyogRXF1aXBwZWRJdGVtVHlwZS5TcGVsbCAqLyB8fCByaWdodEhhbmRFcXVpcG1lbnRUeXBlID09PSA4IC8qIEVxdWlwcGVkSXRlbVR5cGUuU3RhZmYgKi8pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gTWFnaWNTeW5jU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBNYWdpY1N5bmNTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBzZXRUZXh0U2l6ZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBOZXRJbmZvU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhOZXRJbmZvU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIE5ldEluZm9TZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMucmVjZWl2ZWRQYWNrZXRDb3VudCA9IDA7XHJcbiAgICAgICAgX3RoaXMuc2VudFBhY2tldENvdW50ID0gMDtcclxuICAgICAgICBfdGhpcy5sb2NhbExhZ1VuaXRzID0gMDtcclxuICAgICAgICBfdGhpcy5kZWxheU1zID0gMTAwMDtcclxuICAgICAgICBfdGhpcy5sYXN0RHQgPSAwO1xyXG4gICAgICAgIF90aGlzLmR0ID0gMDtcclxuICAgICAgICBfdGhpcy5ncmVlbkFSR0IgPSBbMCwgMTI4LCAwLCAxXTtcclxuICAgICAgICBfdGhpcy5yZWRBUkdCID0gWzI1NSwgMCwgMCwgMV07XHJcbiAgICAgICAgLy8gY2xlYXIgcHJldmlvdXMgdGV4dHMgaW4gY2FzZSBvZiBob3RyZWxvYWRcclxuICAgICAgICBpZiAoX3RoaXMuc3Auc3RvcmFnZVtOZXRJbmZvVGV4dHMuTmFtZV0gJiYgX3RoaXMuc3Auc3RvcmFnZVtOZXRJbmZvVGV4dHMuTmFtZV0uY2xlYXIpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRGVzdHJveWluZyBvbGQgTmV0SW5mb1RleHRzXCIpO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgKF9hID0gX3RoaXMuc3Auc3RvcmFnZVtOZXRJbmZvVGV4dHMuTmFtZV0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbGVhcigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJGYWlsZWQgdG8gZGVzdHJveSBvbGQgTmV0SW5mb1RleHRzOlwiLCBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIV90aGlzLmlzRW5hYmxlZCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBfdGhpcztcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMudGV4dElkcyA9IG5ldyBOZXRJbmZvVGV4dHMoX3RoaXMuc3ApO1xyXG4gICAgICAgIF90aGlzLnNwLnN0b3JhZ2VbTmV0SW5mb1RleHRzLk5hbWVdID0gX3RoaXMudGV4dElkcztcclxuICAgICAgICBfdGhpcy5sYXN0RHQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNlbmRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNlbmRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uU2VuZE1lc3NhZ2VXaXRoUmVmcklkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJhbnlNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkFueU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcIm5ld0xvY2FsTGFnVmFsdWVDYWxjdWxhdGVkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk5ld0xvY2FsTGFnVmFsdWVDYWxjdWxhdGVkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLmFkZFNlbnRQYWNrZXRDb3VudCgxKTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUub25TZW5kTWVzc2FnZVdpdGhSZWZySWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuYWRkU2VudFBhY2tldENvdW50KDEpO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5vbkFueU1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuYWRkUmVjZWl2ZWRQYWNrZXRDb3VudCgxKTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUub25OZXdMb2NhbExhZ1ZhbHVlQ2FsY3VsYXRlZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy5zZXRMb2NhbExhZ1VuaXRzKGUubGFnVW5pdHNOb1opO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy50ZXh0SWRzID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmR0ICs9IERhdGUubm93KCkgLSB0aGlzLmxhc3REdDtcclxuICAgICAgICB0aGlzLmxhc3REdCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdmFyIGlzQ29ubmVjdGVkID0gdGhpcy5zcC5tcENsaWVudFBsdWdpbi5pc0Nvbm5lY3RlZCgpO1xyXG4gICAgICAgIHRoaXMuc3Auc2V0VGV4dFN0cmluZyh0aGlzLnRleHRJZHMuY29ubmVjdGlvblN0YXRlVGV4dElkLCBcIlwiLmNvbmNhdChpc0Nvbm5lY3RlZCA/IFwiT05cIiA6IFwiT0ZGXCIpKTtcclxuICAgICAgICB0aGlzLnNwLnNldFRleHRDb2xvcih0aGlzLnRleHRJZHMuY29ubmVjdGlvblN0YXRlVGV4dElkLCBpc0Nvbm5lY3RlZCA/IHRoaXMuZ3JlZW5BUkdCIDogdGhpcy5yZWRBUkdCKTtcclxuICAgICAgICAvLyBodHRwczovL3d3dy5jcmVhdGlvbmtpdC5jb20vaW5kZXgucGhwP3RpdGxlPVVuaXRcclxuICAgICAgICB2YXIgdW5pdHMgPSB0aGlzLmdldExvY2FsTGFnVW5pdHMoKTtcclxuICAgICAgICB2YXIgdW5pdHNJbk1ldGVyID0gNzAuMDIxODgxODM4MTtcclxuICAgICAgICB2YXIgbWV0ZXJzID0gTWF0aC5yb3VuZCh1bml0cyAvIHVuaXRzSW5NZXRlciAqIDEwKSAvIDEwO1xyXG4gICAgICAgIHRoaXMuc3Auc2V0VGV4dFN0cmluZyh0aGlzLnRleHRJZHMubG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCwgXCJcIi5jb25jYXQodW5pdHMsIFwiIHVuaXRzICh+XCIpLmNvbmNhdChtZXRlcnMsIFwiIG0pXCIpKTtcclxuICAgICAgICBpZiAodGhpcy5kZWxheU1zID4gdGhpcy5kdCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3Auc2V0VGV4dFN0cmluZyh0aGlzLnRleHRJZHMucmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQsIFwiXCIuY29uY2F0KE1hdGgucm91bmQodGhpcy5nZXRBbmRDbGVhclJlY2VpdmVkUGFja2V0Q291bnQoKSkpKTtcclxuICAgICAgICB0aGlzLnNwLnNldFRleHRTdHJpbmcodGhpcy50ZXh0SWRzLnNlbnRQYWNrZXRBbW91bnRUZXh0SWQsIFwiXCIuY29uY2F0KE1hdGgucm91bmQodGhpcy5nZXRBbmRDbGVhclNlbnRQYWNrZXRDb3VudCgpKSkpO1xyXG4gICAgICAgIHRoaXMuZHQgPSAwO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5hZGRSZWNlaXZlZFBhY2tldENvdW50ID0gZnVuY3Rpb24gKGNvdW50KSB7XHJcbiAgICAgICAgdGhpcy5yZWNlaXZlZFBhY2tldENvdW50ICs9IGNvdW50O1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5nZXRBbmRDbGVhclJlY2VpdmVkUGFja2V0Q291bnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5yZWNlaXZlZFBhY2tldENvdW50O1xyXG4gICAgICAgIHRoaXMucmVjZWl2ZWRQYWNrZXRDb3VudCA9IDA7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5hZGRTZW50UGFja2V0Q291bnQgPSBmdW5jdGlvbiAoY291bnQpIHtcclxuICAgICAgICB0aGlzLnNlbnRQYWNrZXRDb3VudCArPSBjb3VudDtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuZ2V0QW5kQ2xlYXJTZW50UGFja2V0Q291bnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5zZW50UGFja2V0Q291bnQ7XHJcbiAgICAgICAgdGhpcy5zZW50UGFja2V0Q291bnQgPSAwO1xyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvU2VydmljZS5wcm90b3R5cGUuc2V0TG9jYWxMYWdVbml0cyA9IGZ1bmN0aW9uIChkaXN0YW5jZSkge1xyXG4gICAgICAgIHRoaXMubG9jYWxMYWdVbml0cyA9IGRpc3RhbmNlO1xyXG4gICAgfTtcclxuICAgIE5ldEluZm9TZXJ2aWNlLnByb3RvdHlwZS5nZXRMb2NhbExhZ1VuaXRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsTGFnVW5pdHM7XHJcbiAgICB9O1xyXG4gICAgTmV0SW5mb1NlcnZpY2UucHJvdG90eXBlLmlzRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gISF0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcInNob3ctbmV0LWluZm9cIl07XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIE5ldEluZm9TZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IE5ldEluZm9TZXJ2aWNlIH07XHJcbnZhciBOZXRJbmZvVGV4dHMgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBOZXRJbmZvVGV4dHMoc3AsIGNvbm5lY3Rpb25TdGF0aWNUZXh0SWQsIGNvbm5lY3Rpb25TdGF0ZVRleHRJZCwgcmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQsIHJlY2VpdmVkUGFja2V0QW1vdW50VGV4dElkLCBzZW50UGFja2V0U3RhdGljVGV4dElkLCBzZW50UGFja2V0QW1vdW50VGV4dElkLCBsb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkLCBsb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkKSB7XHJcbiAgICAgICAgaWYgKGNvbm5lY3Rpb25TdGF0aWNUZXh0SWQgPT09IHZvaWQgMCkgeyBjb25uZWN0aW9uU3RhdGljVGV4dElkID0gc3AuY3JlYXRlVGV4dCgxMDAsIDM1MCwgXCJjb25uZWN0aW9uOlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKGNvbm5lY3Rpb25TdGF0ZVRleHRJZCA9PT0gdm9pZCAwKSB7IGNvbm5lY3Rpb25TdGF0ZVRleHRJZCA9IHNwLmNyZWF0ZVRleHQoMjIwLCAzNTAsIFwiXCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAocmVjZWl2ZWRQYWNrZXRTdGF0aWNUZXh0SWQgPT09IHZvaWQgMCkgeyByZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZCA9IHNwLmNyZWF0ZVRleHQoMTIwLCAzOTAsIFwiaW5jb21pbmcgKHAvcyk6XCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAocmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQgPT09IHZvaWQgMCkgeyByZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZCA9IHNwLmNyZWF0ZVRleHQoMjUwLCAzOTAsIFwiXCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAoc2VudFBhY2tldFN0YXRpY1RleHRJZCA9PT0gdm9pZCAwKSB7IHNlbnRQYWNrZXRTdGF0aWNUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDEyMCwgNDMwLCBcIm91dGdvaW5nIChwL3MpOlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgaWYgKHNlbnRQYWNrZXRBbW91bnRUZXh0SWQgPT09IHZvaWQgMCkgeyBzZW50UGFja2V0QW1vdW50VGV4dElkID0gc3AuY3JlYXRlVGV4dCgyNTAsIDQzMCwgXCJcIiwgWzI1NSwgMjU1LCAyNTUsIDFdKTsgfVxyXG4gICAgICAgIGlmIChsb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkID09PSB2b2lkIDApIHsgbG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZCA9IHNwLmNyZWF0ZVRleHQoOTAsIDQ3MCwgXCJsb2NhbCBsYWc6XCIsIFsyNTUsIDI1NSwgMjU1LCAxXSk7IH1cclxuICAgICAgICBpZiAobG9jYWxQb3NpdGlvbkxhZ0Ftb3VudFRleHRJZCA9PT0gdm9pZCAwKSB7IGxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQgPSBzcC5jcmVhdGVUZXh0KDI1MCwgNDcwLCBcIlwiLCBbMjU1LCAyNTUsIDI1NSwgMV0pOyB9XHJcbiAgICAgICAgdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvblN0YXRpY1RleHRJZCA9IGNvbm5lY3Rpb25TdGF0aWNUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uU3RhdGVUZXh0SWQgPSBjb25uZWN0aW9uU3RhdGVUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5yZWNlaXZlZFBhY2tldFN0YXRpY1RleHRJZCA9IHJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkO1xyXG4gICAgICAgIHRoaXMucmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQgPSByZWNlaXZlZFBhY2tldEFtb3VudFRleHRJZDtcclxuICAgICAgICB0aGlzLnNlbnRQYWNrZXRTdGF0aWNUZXh0SWQgPSBzZW50UGFja2V0U3RhdGljVGV4dElkO1xyXG4gICAgICAgIHRoaXMuc2VudFBhY2tldEFtb3VudFRleHRJZCA9IHNlbnRQYWNrZXRBbW91bnRUZXh0SWQ7XHJcbiAgICAgICAgdGhpcy5sb2NhbFBvc2l0aW9uTGFnU3RhdGljVGV4dElkID0gbG9jYWxQb3NpdGlvbkxhZ1N0YXRpY1RleHRJZDtcclxuICAgICAgICB0aGlzLmxvY2FsUG9zaXRpb25MYWdBbW91bnRUZXh0SWQgPSBsb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMuY29ubmVjdGlvblN0YXRpY1RleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLmNvbm5lY3Rpb25TdGF0ZVRleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLnJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMucmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5zZW50UGFja2V0U3RhdGljVGV4dElkLCAwLjUpO1xyXG4gICAgICAgIHNldFRleHRTaXplKHRoaXMuc2VudFBhY2tldEFtb3VudFRleHRJZCwgMC41KTtcclxuICAgICAgICBzZXRUZXh0U2l6ZSh0aGlzLmxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQsIDAuNSk7XHJcbiAgICAgICAgc2V0VGV4dFNpemUodGhpcy5sb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkLCAwLjUpO1xyXG4gICAgfVxyXG4gICAgTmV0SW5mb1RleHRzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMuY29ubmVjdGlvblN0YXRpY1RleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLmNvbm5lY3Rpb25TdGF0ZVRleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLnJlY2VpdmVkUGFja2V0U3RhdGljVGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMucmVjZWl2ZWRQYWNrZXRBbW91bnRUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5zZW50UGFja2V0U3RhdGljVGV4dElkKTtcclxuICAgICAgICB0aGlzLnNwLmRlc3Ryb3lUZXh0KHRoaXMuc2VudFBhY2tldEFtb3VudFRleHRJZCk7XHJcbiAgICAgICAgdGhpcy5zcC5kZXN0cm95VGV4dCh0aGlzLmxvY2FsUG9zaXRpb25MYWdTdGF0aWNUZXh0SWQpO1xyXG4gICAgICAgIHRoaXMuc3AuZGVzdHJveVRleHQodGhpcy5sb2NhbFBvc2l0aW9uTGFnQW1vdW50VGV4dElkKTtcclxuICAgIH07XHJcbiAgICBOZXRJbmZvVGV4dHMuTmFtZSA9IFwibmV0SW5mb1RleHRzXCI7XHJcbiAgICByZXR1cm4gTmV0SW5mb1RleHRzO1xyXG59KCkpO1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nVHJhY2UsIGxvZ0Vycm9yIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgTmV2ZXJFcnJvciB9IGZyb20gXCIuLi8uLi9saWIvZXJyb3JzXCI7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tIFwiLi4vLi4vbWVzc2FnZXNcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi9yZW1vdGVTZXJ2ZXJcIjtcclxudmFyIE5ldHdvcmtpbmdTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKE5ldHdvcmtpbmdTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gTmV0d29ya2luZ1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInRpY2tcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25UaWNrKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInNlbmRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNlbmRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZW5kUmF3TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZW5kUmF3TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2VuZE1lc3NhZ2VXaXRoUmVmcklkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNlbmRNZXNzYWdlV2l0aFJlZnJJZChlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHRoaXMuc3AubXBDbGllbnRQbHVnaW4uc2VuZChKU09OLnN0cmluZ2lmeShlLm1lc3NhZ2UpLCB0aGlzLmlzUmVsaWFibGUoZS5yZWxpYWJpbGl0eSkpO1xyXG4gICAgfTtcclxuICAgIE5ldHdvcmtpbmdTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRSYXdNZXNzYWdlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXHJcbiAgICAgICAgdGhpcy5zcC5tcENsaWVudFBsdWdpbi5zZW5kUmF3KGUucmF3TWVzc2FnZSwgZS5yYXdNZXNzYWdlLmJ5dGVMZW5ndGgsIHRoaXMuaXNSZWxpYWJsZShlLnJlbGlhYmlsaXR5KSk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLm9uU2VuZE1lc3NhZ2VXaXRoUmVmcklkID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgcmVmcklkID0gZS5tZXNzYWdlLl9yZWZySWQ7XHJcbiAgICAgICAgdmFyIHJlbW90ZVNlcnZlciA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihSZW1vdGVTZXJ2ZXIpO1xyXG4gICAgICAgIHZhciBpZHhJbk1vZGVsID0gcmVmcklkXHJcbiAgICAgICAgICAgID8gcmVtb3RlU2VydmVyLmdldFdvcmxkTW9kZWwoKS5mb3Jtcy5maW5kSW5kZXgoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIGYgJiYgZi5yZWZySWQgPT09IHJlZnJJZDsgfSlcclxuICAgICAgICAgICAgOiByZW1vdGVTZXJ2ZXIuZ2V0V29ybGRNb2RlbCgpLnBsYXllckNoYXJhY3RlckZvcm1JZHg7XHJcbiAgICAgICAgLy8gZml4ZXMgXCJjYW4ndCBnZXQgcHJvcGVydHkgaWR4IG9mIG51bGwgb3IgdW5kZWZpbmVkXCJcclxuICAgICAgICBpZiAoIXJlbW90ZVNlcnZlci5nZXRXb3JsZE1vZGVsKCkuZm9ybXNbaWR4SW5Nb2RlbF0pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgZS5tZXNzYWdlLmlkeCA9IHJlbW90ZVNlcnZlci5nZXRXb3JsZE1vZGVsKCkuZm9ybXNbaWR4SW5Nb2RlbF0uaWR4O1xyXG4gICAgICAgIGRlbGV0ZSBlLm1lc3NhZ2UuX3JlZnJJZDtcclxuICAgICAgICB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLnNlbmQoSlNPTi5zdHJpbmdpZnkoZS5tZXNzYWdlKSwgdGhpcy5pc1JlbGlhYmxlKGUucmVsaWFiaWxpdHkpKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChob3N0TmFtZSwgcG9ydCkge1xyXG4gICAgICAgIHRoaXMuc2VydmVyQWRkcmVzcyA9IHsgaG9zdE5hbWU6IGhvc3ROYW1lLCBwb3J0OiBwb3J0IH07XHJcbiAgICAgICAgdGhpcy5jcmVhdGVDbGllbnRTYWZlKCk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLnJlY29ubmVjdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZUNsaWVudFNhZmUoKTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zcC5tcENsaWVudFBsdWdpbi5kZXN0cm95Q2xpZW50KCk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNwLm1wQ2xpZW50UGx1Z2luLmlzQ29ubmVjdGVkKCk7XHJcbiAgICB9O1xyXG4gICAgTmV0d29ya2luZ1NlcnZpY2UucHJvdG90eXBlLm9uVGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuc3AubXBDbGllbnRQbHVnaW4udGljayhmdW5jdGlvbiAocGFja2V0VHlwZSwgcmF3Q29udGVudCwgZXJyb3IpIHtcclxuICAgICAgICAgICAgc3dpdGNoIChwYWNrZXRUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY29ubmVjdGlvbkFjY2VwdGVkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJjb25uZWN0aW9uQWNjZXB0ZWRcIiwge30pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNvbm5lY3Rpb25EZW5pZWRcIjpcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImNvbm5lY3Rpb25EZW5pZWRcIiwgeyBlcnJvcjogZXJyb3IgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVjb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY29ubmVjdGlvbkZhaWxlZFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY29ubmVjdGlvbkZhaWxlZFwiLCB7fSk7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVjb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiZGlzY29ubmVjdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY29ubmVjdGlvbkRpc2Nvbm5lY3RcIiwge30pO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnJlY29ubmVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIm1lc3NhZ2VcIjpcclxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBpbiB0aGVvcnkgY2FuIGJlIGVtcHR5IGpzb25Db250ZW50IGFuZCBub24tZW1wdHkgZXJyb3JcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbXNnQW55ID0gdm9pZCAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyYXdDb250ZW50ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1zZ0FueSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJudWxsIHJhd0NvbnRlbnRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKChuZXcgVWludDhBcnJheShyYXdDb250ZW50KVswXSkgPT09IDB4N2IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzdW1lIGpzb25cclxuICAgICAgICAgICAgICAgICAgICAgICAgbXNnQW55ID0gSlNPTi5wYXJzZShfdGhpcy5zcC5kZWNvZGVVdGY4KHJhd0NvbnRlbnQpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc3VtZSByYXdcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyByYXdDb250ZW50OiByYXdDb250ZW50IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueVJhd01lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuT3BlbkNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcIm9wZW5Db250YWluZXJNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlTW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVNb3ZlbWVudE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVBbmltYXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVBbmltYXRpb25NZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlRXF1aXBtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidXBkYXRlRXF1aXBtZW50TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkNoYW5nZVZhbHVlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImNoYW5nZVZhbHVlc01lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5TcGVsbENhc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzcGVsbENhc3RNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlQW5pbVZhcmlhYmxlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZUFuaW1WYXJpYWJsZXNNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVXBkYXRlQXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZUFwcGVhcmFuY2VNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVGVsZXBvcnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ0ZWxlcG9ydE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInVwZGF0ZVByb3BlcnR5TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkRlYXRoU3RhdGVDb250YWluZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJkZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkNyZWF0ZUFjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY3JlYXRlQWN0b3JNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuQ3VzdG9tUGFja2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiY3VzdG9tUGFja2V0TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLkRlc3Ryb3lBY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImRlc3Ryb3lBY3Rvck1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5Ib3N0U3RhcnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJob3N0U3RhcnRNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuSG9zdFN0b3ApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJob3N0U3RvcE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5TZXRJbnZlbnRvcnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZXRJbnZlbnRvcnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuU2V0UmFjZU1lbnVPcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2V0UmFjZU1lbnVPcGVuTWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZ0FueS50ID09PSBNc2dUeXBlLlNwU25pcHBldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB7IG1lc3NhZ2U6IG1zZ0FueSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNwU25pcHBldE1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImFueU1lc3NhZ2VcIiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtc2dBbnkudCA9PT0gTXNnVHlwZS5VcGRhdGVHYW1lbW9kZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0geyBtZXNzYWdlOiBtc2dBbnkgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJ1cGRhdGVHYW1lbW9kZURhdGFNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhbnlNZXNzYWdlXCIsIGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnQW55LnQgPT09IE1zZ1R5cGUuVGVsZXBvcnQyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IHsgbWVzc2FnZTogbXNnQW55IH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwidGVsZXBvcnRNZXNzYWdlMlwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYW55TWVzc2FnZVwiLCBldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0aHJvdyBuZXcgTmV2ZXJFcnJvcihtc2dBbnkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmhhbmRsZWQgTXNnVHlwZSBcIiArIG1zZ0FueS50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUuY3JlYXRlQ2xpZW50U2FmZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX2EgPSB0aGlzLnNlcnZlckFkZHJlc3MsIGhvc3ROYW1lID0gX2EuaG9zdE5hbWUsIHBvcnQgPSBfYS5wb3J0O1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiY3JlYXRlQ2xpZW50U2FmZSBcIiArIGhvc3ROYW1lICsgXCI6XCIgKyBwb3J0KTtcclxuICAgICAgICBpZiAodGhpcy5zZXJ2ZXJBZGRyZXNzLmhvc3ROYW1lICE9PSBcIlwiICYmIHRoaXMuc2VydmVyQWRkcmVzcy5wb3J0ICE9PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AubXBDbGllbnRQbHVnaW4uY3JlYXRlQ2xpZW50KGhvc3ROYW1lLCBwb3J0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiY3JlYXRlQ2xpZW50U2FmZSBmYWlsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUsIFwic2VydmVyQWRkcmVzc1wiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLnNwLnN0b3JhZ2VbXCJzZXJ2ZXJBZGRyZXNzXCJdO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJlcyA9PT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHJlcztcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0Lmhvc3ROYW1lID09PSBcInN0cmluZ1wiICYmIHR5cGVvZiByZXN1bHQucG9ydCA9PT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHsgaG9zdE5hbWU6IFwiXCIsIHBvcnQ6IDAgfTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKG5ld1ZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3Auc3RvcmFnZVtcInNlcnZlckFkZHJlc3NcIl0gPSBuZXdWYWx1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBOZXR3b3JraW5nU2VydmljZS5wcm90b3R5cGUuaXNSZWxpYWJsZSA9IGZ1bmN0aW9uIChyZWxpYWJpbGl0eSkge1xyXG4gICAgICAgIHN3aXRjaCAocmVsaWFiaWxpdHkpIHtcclxuICAgICAgICAgICAgY2FzZSBcInJlbGlhYmxlXCI6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgY2FzZSBcInVucmVsaWFibGVcIjpcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBOZXZlckVycm9yKHJlbGlhYmlsaXR5KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIE5ldHdvcmtpbmdTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IE5ldHdvcmtpbmdTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IEFtbW8sIEdhbWUgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGdldEVxdWlwbWVudCB9IGZyb20gXCIuLi8uLi9zeW5jL2VxdWlwbWVudFwiO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG52YXIgUGxheWVyQm93U2hvdFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoUGxheWVyQm93U2hvdFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBQbGF5ZXJCb3dTaG90U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpc18xID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpc18xLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXNfMS5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpc18xLnNjb3JlID0gMDtcclxuICAgICAgICBfdGhpc18xLmludmVudG9yeVVuYmxvY2tNb21lbnQgPSAwO1xyXG4gICAgICAgIF90aGlzXzEuY29udHJvbGxlci5lbWl0dGVyLm9uKFwicXVlcnlCbG9ja1NldEludmVudG9yeUV2ZW50XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpc18xLm9uUXVlcnlCbG9ja1NldEludmVudG9yeUV2ZW50KGUpOyB9KTtcclxuICAgICAgICBfdGhpc18xLmNvbnRyb2xsZXIub24oXCJwbGF5ZXJCb3dTaG90XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpc18xLm9uUGxheWVyQm93U2hvdChlKTsgfSk7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3RoaXNfMTtcclxuICAgICAgICB2YXIgZXZlbnRQYXR0ZXJucyA9IFtcImF0dGFja1JlbGVhc2VcIiwgXCJjcm9zc2Jvd0F0dGFja1N0YXJ0XCJdO1xyXG4gICAgICAgIGV2ZW50UGF0dGVybnMuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnRQYXR0ZXJuKSB7XHJcbiAgICAgICAgICAgIF90aGlzXzEuc3AuaG9va3Muc2VuZEFuaW1hdGlvbkV2ZW50LmFkZCh7XHJcbiAgICAgICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjdHguYW5pbWF0aW9uU3VjY2VlZGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN0eC5hbmltRXZlbnROYW1lID09PSBcImNyb3NzYm93QXR0YWNrU3RhcnRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zY29yZSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGN0eC5hbmltRXZlbnROYW1lID09PSBcImF0dGFja1JlbGVhc2VcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuc2NvcmUgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IF90aGlzLm9uUGxheWVyQ3Jvc3Nib3dTaG90KCk7IH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcmUgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zY29yZSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBldmVudFBhdHRlcm4pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpc18xO1xyXG4gICAgfVxyXG4gICAgUGxheWVyQm93U2hvdFNlcnZpY2UucHJvdG90eXBlLm9uUXVlcnlCbG9ja1NldEludmVudG9yeUV2ZW50ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICBpZiAoRGF0ZS5ub3coKSA8IHRoaXMuaW52ZW50b3J5VW5ibG9ja01vbWVudCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkJsb2NrZWQgaW52ZW50b3J5IG9wZXJhdGlvblwiKTtcclxuICAgICAgICAgICAgZS5ibG9jaygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJOb3QgYmxvY2tlZCBpbnZlbnRvcnkgb3BlcmF0aW9uXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBQbGF5ZXJCb3dTaG90U2VydmljZS5wcm90b3R5cGUub25QbGF5ZXJCb3dTaG90ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLlBsYXllckJvd1Nob3QsXHJcbiAgICAgICAgICAgICAgICB3ZWFwb25JZDogZS53ZWFwb24uZ2V0Rm9ybUlEKCksXHJcbiAgICAgICAgICAgICAgICBhbW1vSWQ6IGUuYW1tby5nZXRGb3JtSUQoKSxcclxuICAgICAgICAgICAgICAgIHBvd2VyOiBlLnBvd2VyLFxyXG4gICAgICAgICAgICAgICAgaXNTdW5HYXppbmc6IGUuaXNTdW5HYXppbmcgfHwgZmFsc2VcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQm93U2hvdFNlcnZpY2UucHJvdG90eXBlLm9uUGxheWVyQ3Jvc3Nib3dTaG90ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBhY3RvciA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBpZiAoYWN0b3IgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgY3Jvc3Nib3cgPSBhY3Rvci5nZXRFcXVpcHBlZFdlYXBvbihmYWxzZSk7XHJcbiAgICAgICAgaWYgKGNyb3NzYm93ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiQ291bGRuJ3QgZ2V0IGVxdWlwcGVkIHdlYXBvblwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgd2VhcG9uVHlwZSA9IGNyb3NzYm93LmdldFdlYXBvblR5cGUoKTtcclxuICAgICAgICBpZiAod2VhcG9uVHlwZSAhPT0gOSAvKiBXZWFwb25UeXBlLkNyb3NzYm93ICovKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRXhwZWN0ZWQgd2VhcG9uIHRvIGJlIGNyb3NzYm93LCBidXQgZ290IFdlYXBvblR5cGVcIiwgd2VhcG9uVHlwZSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGVxdWlwcGVkQW1tb0VudHJpZXMgPSBnZXRFcXVpcG1lbnQoYWN0b3IsIDApLmludi5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoZW50cnkpIHsgcmV0dXJuIGVudHJ5Lndvcm4gJiYgQW1tby5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGVudHJ5LmJhc2VJZCkpOyB9KTtcclxuICAgICAgICBpZiAoZXF1aXBwZWRBbW1vRW50cmllcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJBbW1vIG5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXF1aXBwZWRBbW1vRW50cmllcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIHZhciBlcXVpcHBlZEFtbW9JZHMgPSBlcXVpcHBlZEFtbW9FbnRyaWVzLm1hcChmdW5jdGlvbiAoZW50cnkpIHsgcmV0dXJuIGVudHJ5LmJhc2VJZDsgfSk7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiRm91bmQgbW9yZSB0aGFuIDEgYW1tb3M6XCIsIGVxdWlwcGVkQW1tb0lkcyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlXCIsIHtcclxuICAgICAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5QbGF5ZXJCb3dTaG90LFxyXG4gICAgICAgICAgICAgICAgd2VhcG9uSWQ6IGNyb3NzYm93LmdldEZvcm1JRCgpLFxyXG4gICAgICAgICAgICAgICAgYW1tb0lkOiBlcXVpcHBlZEFtbW9FbnRyaWVzWzBdLmJhc2VJZCxcclxuICAgICAgICAgICAgICAgIGlzU3VuR2F6aW5nOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHBvd2VyOiAxLjBcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gRml4ZXMgcmFjZSBjb25kaXRpb24gd2hlbiB0aGUgc2VydmVyIHJlbW92ZXMgYW4gaXRlbSBmYXN0ZXIgdGhhbiBsb2NhbCBjcm9zc2JvdyBkb2VzIHRoYXQ6IC0xIHRvdGFsXHJcbiAgICAgICAgLy8gVGhlbiBjcm9zc2JvdyByZW1vdmVzIG9uZSBtb3JlIGl0ZW06IC0yIHRvdGFsXHJcbiAgICAgICAgLy8gVGhlIGl0ZW0gaXMgYmVpbmcgYWRkZWQgYmFjazogLTEgdG90YWwgKHdoaWNoIGlzIGNvcnJlY3QgYnV0IGxvb2tzIHVnbHkgaW4gcHJvY2VzcylcclxuICAgICAgICB0aGlzLmludmVudG9yeVVuYmxvY2tNb21lbnQgPSBEYXRlLm5vdygpICsgNSAqIDEwMDA7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTZW50IGNyb3NzYm93IHNob3RcIik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFBsYXllckJvd1Nob3RTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFBsYXllckJvd1Nob3RTZXJ2aWNlIH07XHJcbjtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxudmFyIF9fZ2VuZXJhdG9yID0gKHRoaXMgJiYgdGhpcy5fX2dlbmVyYXRvcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIGJvZHkpIHtcclxuICAgIHZhciBfID0geyBsYWJlbDogMCwgc2VudDogZnVuY3Rpb24oKSB7IGlmICh0WzBdICYgMSkgdGhyb3cgdFsxXTsgcmV0dXJuIHRbMV07IH0sIHRyeXM6IFtdLCBvcHM6IFtdIH0sIGYsIHksIHQsIGc7XHJcbiAgICByZXR1cm4gZyA9IHsgbmV4dDogdmVyYigwKSwgXCJ0aHJvd1wiOiB2ZXJiKDEpLCBcInJldHVyblwiOiB2ZXJiKDIpIH0sIHR5cGVvZiBTeW1ib2wgPT09IFwiZnVuY3Rpb25cIiAmJiAoZ1tTeW1ib2wuaXRlcmF0b3JdID0gZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzOyB9KSwgZztcclxuICAgIGZ1bmN0aW9uIHZlcmIobikgeyByZXR1cm4gZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHN0ZXAoW24sIHZdKTsgfTsgfVxyXG4gICAgZnVuY3Rpb24gc3RlcChvcCkge1xyXG4gICAgICAgIGlmIChmKSB0aHJvdyBuZXcgVHlwZUVycm9yKFwiR2VuZXJhdG9yIGlzIGFscmVhZHkgZXhlY3V0aW5nLlwiKTtcclxuICAgICAgICB3aGlsZSAoZyAmJiAoZyA9IDAsIG9wWzBdICYmIChfID0gMCkpLCBfKSB0cnkge1xyXG4gICAgICAgICAgICBpZiAoZiA9IDEsIHkgJiYgKHQgPSBvcFswXSAmIDIgPyB5W1wicmV0dXJuXCJdIDogb3BbMF0gPyB5W1widGhyb3dcIl0gfHwgKCh0ID0geVtcInJldHVyblwiXSkgJiYgdC5jYWxsKHkpLCAwKSA6IHkubmV4dCkgJiYgISh0ID0gdC5jYWxsKHksIG9wWzFdKSkuZG9uZSkgcmV0dXJuIHQ7XHJcbiAgICAgICAgICAgIGlmICh5ID0gMCwgdCkgb3AgPSBbb3BbMF0gJiAyLCB0LnZhbHVlXTtcclxuICAgICAgICAgICAgc3dpdGNoIChvcFswXSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAwOiBjYXNlIDE6IHQgPSBvcDsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDQ6IF8ubGFiZWwrKzsgcmV0dXJuIHsgdmFsdWU6IG9wWzFdLCBkb25lOiBmYWxzZSB9O1xyXG4gICAgICAgICAgICAgICAgY2FzZSA1OiBfLmxhYmVsKys7IHkgPSBvcFsxXTsgb3AgPSBbMF07IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA3OiBvcCA9IF8ub3BzLnBvcCgpOyBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISh0ID0gXy50cnlzLCB0ID0gdC5sZW5ndGggPiAwICYmIHRbdC5sZW5ndGggLSAxXSkgJiYgKG9wWzBdID09PSA2IHx8IG9wWzBdID09PSAyKSkgeyBfID0gMDsgY29udGludWU7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDMgJiYgKCF0IHx8IChvcFsxXSA+IHRbMF0gJiYgb3BbMV0gPCB0WzNdKSkpIHsgXy5sYWJlbCA9IG9wWzFdOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gNiAmJiBfLmxhYmVsIDwgdFsxXSkgeyBfLmxhYmVsID0gdFsxXTsgdCA9IG9wOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0ICYmIF8ubGFiZWwgPCB0WzJdKSB7IF8ubGFiZWwgPSB0WzJdOyBfLm9wcy5wdXNoKG9wKTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodFsyXSkgXy5vcHMucG9wKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcCA9IGJvZHkuY2FsbCh0aGlzQXJnLCBfKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7IG9wID0gWzYsIGVdOyB5ID0gMDsgfSBmaW5hbGx5IHsgZiA9IHQgPSAwOyB9XHJcbiAgICAgICAgaWYgKG9wWzBdICYgNSkgdGhyb3cgb3BbMV07IHJldHVybiB7IHZhbHVlOiBvcFswXSA/IG9wWzFdIDogdm9pZCAwLCBkb25lOiB0cnVlIH07XHJcbiAgICB9XHJcbn07XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSAnaW5zcGVjdG9yJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XHJcbnZhciBQcm9maWxpbmdTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFByb2ZpbGluZ1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBQcm9maWxpbmdTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIHZhciBzZXR0aW5ncyA9IHNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXTtcclxuICAgICAgICBpZiAoIXNldHRpbmdzW1wiZW5hYmxlUHJvZmlsaW5nXCJdKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlByb2ZpbGluZ1NlcnZpY2U6IGRpc2FibGVkXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwcm9maWxpbmdEdXJhdGlvbk1zID0gX3RoaXMuZ2V0SW50ZWdlcihzZXR0aW5nc1tcInByb2ZpbGluZ0R1cmF0aW9uTXNcIl0pIHx8IDEwMDAwO1xyXG4gICAgICAgIHZhciBzZXNzaW9uID0gbmV3IFNlc3Npb24oKTtcclxuICAgICAgICBzZXNzaW9uLmNvbm5lY3QoKTtcclxuICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJQcm9maWxpbmdTZXJ2aWNlOiBzdGFydFwiKTtcclxuICAgICAgICBfdGhpcy5zdGFydFByb2ZpbGluZyhzZXNzaW9uLCBwcm9maWxpbmdEdXJhdGlvbk1zKTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBQcm9maWxpbmdTZXJ2aWNlLnByb3RvdHlwZS5zdGFydFByb2ZpbGluZyA9IGZ1bmN0aW9uIChzZXNzaW9uLCBwcm9maWxpbmdEdXJhdGlvbk1zKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcHJvZmlsZSwgZmlsZU5hbWVTdWZmaXg7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6IHJldHVybiBbNCAvKnlpZWxkKi8sIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24ucG9zdCgnUHJvZmlsZXIuZW5hYmxlJywgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24ucG9zdCgnUHJvZmlsZXIuc3RhcnQnLCBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCBwcm9maWxpbmdEdXJhdGlvbk1zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJQcm9maWxpbmdTZXJ2aWNlOiBzdG9wXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5wb3N0KCdQcm9maWxlci5zdG9wJywgZnVuY3Rpb24gKGVyciwgcmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9maWxlID0gKF9hLnNlbnQoKSkucHJvZmlsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWVTdWZmaXggPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKCkucmVwbGFjZShcIi4wXCIsIFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKFwiLi9wcm9maWxlXCIuY29uY2F0KGZpbGVOYW1lU3VmZml4LCBcIi5jcHVwcm9maWxlXCIpLCBKU09OLnN0cmluZ2lmeShwcm9maWxlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUHJvZmlsaW5nU2VydmljZS5wcm90b3R5cGUuZ2V0SW50ZWdlciA9IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFByb2ZpbGluZ1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgUHJvZmlsaW5nU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG52YXIgUmFnZG9sbFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoUmFnZG9sbFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBSYWdkb2xsU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICAvLyBUT0RPOiB0aGluayBhYm91dCB0cmFja2luZyByYWdkb2xsIHN0YXRlIG9mIHBsYXllclxyXG4gICAgICAgIF90aGlzLnNhZmVSZW1vdmVSYWdkb2xsRnJvbVdvcmxkID0gZnVuY3Rpb24gKGFjdG9yLCBhZnRlclJlbW92ZUNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnNldExvY2FsRGFtYWdlTXVsdCgwKTtcclxuICAgICAgICAgICAgYWN0b3IuZm9yY2VSZW1vdmVSYWdkb2xsRnJvbVdvcmxkKCkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNldExvY2FsRGFtYWdlTXVsdChfdGhpcy5kZWZhdWx0TG9jYWxEYW1hZ2VNdWx0KTtcclxuICAgICAgICAgICAgICAgICAgICBhZnRlclJlbW92ZUNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBfdGhpcy5kZWZhdWx0TG9jYWxEYW1hZ2VNdWx0ID0gMTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBSYWdkb2xsU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnNldExvY2FsRGFtYWdlTXVsdCh0aGlzLmRlZmF1bHRMb2NhbERhbWFnZU11bHQpO1xyXG4gICAgfTtcclxuICAgIFJhZ2RvbGxTZXJ2aWNlLnByb3RvdHlwZS5zZXRMb2NhbERhbWFnZU11bHQgPSBmdW5jdGlvbiAoZGFtYWdlTXVsdCkge1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZkRpZmZNdWx0SFBUb1BDRVwiLCBkYW1hZ2VNdWx0KTtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZEaWZmTXVsdEhQVG9QQ0hcIiwgZGFtYWdlTXVsdCk7XHJcbiAgICAgICAgdGhpcy5zcC5HYW1lLnNldEdhbWVTZXR0aW5nRmxvYXQoXCJmRGlmZk11bHRIUFRvUENMXCIsIGRhbWFnZU11bHQpO1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZkRpZmZNdWx0SFBUb1BDTlwiLCBkYW1hZ2VNdWx0KTtcclxuICAgICAgICB0aGlzLnNwLkdhbWUuc2V0R2FtZVNldHRpbmdGbG9hdChcImZEaWZmTXVsdEhQVG9QQ1ZFXCIsIGRhbWFnZU11bHQpO1xyXG4gICAgICAgIHRoaXMuc3AuR2FtZS5zZXRHYW1lU2V0dGluZ0Zsb2F0KFwiZkRpZmZNdWx0SFBUb1BDVkhcIiwgZGFtYWdlTXVsdCk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFJhZ2RvbGxTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFJhZ2RvbGxTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbnZhciBfX2dlbmVyYXRvciA9ICh0aGlzICYmIHRoaXMuX19nZW5lcmF0b3IpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBib2R5KSB7XHJcbiAgICB2YXIgXyA9IHsgbGFiZWw6IDAsIHNlbnQ6IGZ1bmN0aW9uKCkgeyBpZiAodFswXSAmIDEpIHRocm93IHRbMV07IHJldHVybiB0WzFdOyB9LCB0cnlzOiBbXSwgb3BzOiBbXSB9LCBmLCB5LCB0LCBnO1xyXG4gICAgcmV0dXJuIGcgPSB7IG5leHQ6IHZlcmIoMCksIFwidGhyb3dcIjogdmVyYigxKSwgXCJyZXR1cm5cIjogdmVyYigyKSB9LCB0eXBlb2YgU3ltYm9sID09PSBcImZ1bmN0aW9uXCIgJiYgKGdbU3ltYm9sLml0ZXJhdG9yXSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSksIGc7XHJcbiAgICBmdW5jdGlvbiB2ZXJiKG4pIHsgcmV0dXJuIGZ1bmN0aW9uICh2KSB7IHJldHVybiBzdGVwKFtuLCB2XSk7IH07IH1cclxuICAgIGZ1bmN0aW9uIHN0ZXAob3ApIHtcclxuICAgICAgICBpZiAoZikgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkdlbmVyYXRvciBpcyBhbHJlYWR5IGV4ZWN1dGluZy5cIik7XHJcbiAgICAgICAgd2hpbGUgKGcgJiYgKGcgPSAwLCBvcFswXSAmJiAoXyA9IDApKSwgXykgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKGYgPSAxLCB5ICYmICh0ID0gb3BbMF0gJiAyID8geVtcInJldHVyblwiXSA6IG9wWzBdID8geVtcInRocm93XCJdIHx8ICgodCA9IHlbXCJyZXR1cm5cIl0pICYmIHQuY2FsbCh5KSwgMCkgOiB5Lm5leHQpICYmICEodCA9IHQuY2FsbCh5LCBvcFsxXSkpLmRvbmUpIHJldHVybiB0O1xyXG4gICAgICAgICAgICBpZiAoeSA9IDAsIHQpIG9wID0gW29wWzBdICYgMiwgdC52YWx1ZV07XHJcbiAgICAgICAgICAgIHN3aXRjaCAob3BbMF0pIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgMDogY2FzZSAxOiB0ID0gb3A7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA0OiBfLmxhYmVsKys7IHJldHVybiB7IHZhbHVlOiBvcFsxXSwgZG9uZTogZmFsc2UgfTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNTogXy5sYWJlbCsrOyB5ID0gb3BbMV07IG9wID0gWzBdOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNzogb3AgPSBfLm9wcy5wb3AoKTsgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEodCA9IF8udHJ5cywgdCA9IHQubGVuZ3RoID4gMCAmJiB0W3QubGVuZ3RoIC0gMV0pICYmIChvcFswXSA9PT0gNiB8fCBvcFswXSA9PT0gMikpIHsgXyA9IDA7IGNvbnRpbnVlOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSAzICYmICghdCB8fCAob3BbMV0gPiB0WzBdICYmIG9wWzFdIDwgdFszXSkpKSB7IF8ubGFiZWwgPSBvcFsxXTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDYgJiYgXy5sYWJlbCA8IHRbMV0pIHsgXy5sYWJlbCA9IHRbMV07IHQgPSBvcDsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodCAmJiBfLmxhYmVsIDwgdFsyXSkgeyBfLmxhYmVsID0gdFsyXTsgXy5vcHMucHVzaChvcCk7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRbMl0pIF8ub3BzLnBvcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgb3AgPSBib2R5LmNhbGwodGhpc0FyZywgXyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkgeyBvcCA9IFs2LCBlXTsgeSA9IDA7IH0gZmluYWxseSB7IGYgPSB0ID0gMDsgfVxyXG4gICAgICAgIGlmIChvcFswXSAmIDUpIHRocm93IG9wWzFdOyByZXR1cm4geyB2YWx1ZTogb3BbMF0gPyBvcFsxXSA6IHZvaWQgMCwgZG9uZTogdHJ1ZSB9O1xyXG4gICAgfVxyXG59O1xyXG4vLyBAdHMtZXhwZWN0LWVycm9yIChUT0RPOiBSZW1vdmUgaW4gMi4xMC4wKVxyXG5pbXBvcnQgeyBBY3RvciwgaW50ZXJydXB0Q2FzdCwgY2FzdFNwZWxsSW1tZWRpYXRlLCBhcHBseUFuaW1hdGlvblZhcmlhYmxlc1RvQWN0b3IgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmltcG9ydCB7IEFybW9yLCBDZWxsLCBHYW1lLCBPYmplY3RSZWZlcmVuY2UsIFRFU01vZFBsYXRmb3JtLCBVaSwgVXRpbGl0eSwgV29ybGRTcGFjZSwgb24sIC8vIFRPRE86IHVzZSB0aGlzLmNvbnRyb2xsZXIub24gaW5zdGVhZFxyXG5vbmNlLCAvLyBUT0RPOiB1c2UgdGhpcy5jb250cm9sbGVyLm9uY2UgaW5zdGVhZFxyXG5zdG9yYWdlLCAvLyBUT0RPOiB1c2UgdGhpcy5zcC5zdG9yYWdlIGluc3RlYWRcclxuIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5pbXBvcnQgKiBhcyBtZXNzYWdlcyBmcm9tICcuLi8uLi9tZXNzYWdlcyc7XHJcbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvbiAqL1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gJy4uLy4uL2V4dGVuc2lvbnMvb2JqZWN0UmVmZXJlbmNlRXgnO1xyXG5pbXBvcnQgeyBJZE1hbmFnZXIgfSBmcm9tICcuLi8uLi9saWIvaWRNYW5hZ2VyJztcclxuaW1wb3J0IHsgbmFtZW9mIH0gZnJvbSAnLi4vLi4vbGliL25hbWVvZic7XHJcbmltcG9ydCB7IHNldEFjdG9yVmFsdWVQZXJjZW50YWdlIH0gZnJvbSAnLi4vLi4vc3luYy9hY3RvcnZhbHVlcyc7XHJcbmltcG9ydCB7IGFwcGx5QXBwZWFyYW5jZVRvUGxheWVyIH0gZnJvbSAnLi4vLi4vc3luYy9hcHBlYXJhbmNlJztcclxuaW1wb3J0IHsgYXBwbHlFcXVpcG1lbnQsIGlzQmFkTWVudVNob3duIH0gZnJvbSAnLi4vLi4vc3luYy9lcXVpcG1lbnQnO1xyXG5pbXBvcnQgeyBhcHBseUludmVudG9yeSB9IGZyb20gJy4uLy4uL3N5bmMvaW52ZW50b3J5JztcclxuaW1wb3J0IHsgbGVhcm5TcGVsbHMsIHJlbW92ZUFsbFNwZWxscyB9IGZyb20gJy4uLy4uL3N5bmMvc3BlbGwnO1xyXG5pbXBvcnQgeyBNb2RlbEFwcGx5VXRpbHMgfSBmcm9tICcuLi8uLi92aWV3L21vZGVsQXBwbHlVdGlscyc7XHJcbmltcG9ydCB7IExvYWRHYW1lU2VydmljZSB9IGZyb20gJy4vbG9hZEdhbWVTZXJ2aWNlJztcclxuaW1wb3J0IHsgUmFnZG9sbFNlcnZpY2UgfSBmcm9tICcuL3JhZ2RvbGxTZXJ2aWNlJztcclxuaW1wb3J0IHsgUmVzcGF3bk5lZWRlZEVycm9yIH0gZnJvbSAnLi4vLi4vbGliL2Vycm9ycyc7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSAnLi9jbGllbnRMaXN0ZW5lcic7XHJcbi8vIFRPRE86IHJlZmFjdG9yIHdvcmxkVmlld01pc2MgaW50byBzZXJ2aWNlXHJcbmltcG9ydCB7IGdldE9iamVjdFJlZmVyZW5jZSwgZ2V0Vmlld0Zyb21TdG9yYWdlLCByZW1vdGVJZFRvTG9jYWxJZCwgfSBmcm9tICcuLi8uLi92aWV3L3dvcmxkVmlld01pc2MnO1xyXG5pbXBvcnQgeyBUaW1lU2VydmljZSB9IGZyb20gJy4vdGltZVNlcnZpY2UnO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tICcuLi8uLi9sb2dnaW5nJztcclxuaW1wb3J0IHsgVm9pY2VDaGF0U2VydmljZSB9IGZyb20gJy4vdm9pY2VDaGF0U2VydmljZSc7XHJcbmltcG9ydCB7IE1zZ1R5cGUgfSBmcm9tICcuLi8uLi9tZXNzYWdlcyc7XHJcbmV4cG9ydCB2YXIgZ2V0UGNJbnZlbnRvcnkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgcmVzID0gc3RvcmFnZVsncGNJbnYnXTtcclxuICAgIGlmICh0eXBlb2YgcmVzID09PSAnb2JqZWN0JyAmJiByZXNbJ2VudHJpZXMnXSkge1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG59O1xyXG52YXIgc2V0UGNJbnZlbnRvcnkgPSBmdW5jdGlvbiAoaW52KSB7XHJcbiAgICBzdG9yYWdlWydwY0ludiddID0gaW52O1xyXG59O1xyXG52YXIgcGNJbnZMYXN0QXBwbHkgPSAwO1xyXG5vbigndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKGlzQmFkTWVudVNob3duKCkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoRGF0ZS5ub3coKSAtIHBjSW52TGFzdEFwcGx5ID4gNTAwMCkge1xyXG4gICAgICAgIHBjSW52TGFzdEFwcGx5ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICB2YXIgcGNJbnYgPSBnZXRQY0ludmVudG9yeSgpO1xyXG4gICAgICAgIGlmIChwY0ludikge1xyXG4gICAgICAgICAgICBhcHBseUludmVudG9yeShHYW1lLmdldFBsYXllcigpLCBwY0ludiwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcbnZhciB1bmVxdWlwSXJvbkhlbG1ldCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBpcm9uSGVsbWVudCA9IEFybW9yLmZyb20oR2FtZS5nZXRGb3JtRXgoMHgwMDAxMmU0ZCkpO1xyXG4gICAgdmFyIHBsID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgIGlmIChwbCkge1xyXG4gICAgICAgIHBsLnVuZXF1aXBJdGVtKGlyb25IZWxtZW50LCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICB9XHJcbn07XHJcbnZhciBSZW1vdGVTZXJ2ZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoUmVtb3RlU2VydmVyLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gUmVtb3RlU2VydmVyKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLm51bVNldEludmVudG9yeSA9IDA7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiaG9zdFN0YXJ0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Ib3N0U3RhcnRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJob3N0U3RvcE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uSG9zdFN0b3BNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZXRJbnZlbnRvcnlNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNldEludmVudG9yeU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcIm9wZW5Db250YWluZXJNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk9wZW5Db250YWluZXJNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVNb3ZlbWVudE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlTW92ZW1lbnRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVBbmltYXRpb25NZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZUFuaW1hdGlvbk1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZUVxdWlwbWVudE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlRXF1aXBtZW50TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY2hhbmdlVmFsdWVzTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DaGFuZ2VWYWx1ZXNNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVBcHBlYXJhbmNlTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVBcHBlYXJhbmNlTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidGVsZXBvcnRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblRlbGVwb3J0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwidGVsZXBvcnRNZXNzYWdlMlwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25UZWxlcG9ydE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DcmVhdGVBY3Rvck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImRlc3Ryb3lBY3Rvck1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uRGVzdHJveUFjdG9yTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic2V0UmFjZU1lbnVPcGVuTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TZXRSYWNlTWVudU9wZW5NZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ1cGRhdGVQcm9wZXJ0eU1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlUHJvcGVydHlNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJkZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25EZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY29ubmVjdGlvbkFjY2VwdGVkXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmhhbmRsZUNvbm5lY3Rpb25BY2NlcHRlZCgpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJzcGVsbENhc3RNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNwZWxsQ2FzdE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZUFuaW1WYXJpYWJsZXNNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblVwZGF0ZUFuaW1WYXJpYWJsZXNNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJ2b2ljZUNoYXRNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblZvaWNlQ2hhdE1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcInVwZGF0ZVZvaWNlQ2hhdE1lc3NhZ2VcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlVm9pY2VDaGF0TWVzc2FnZShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbkhvc3RTdGFydE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgdGFyZ2V0ID0gbXNnLnRhcmdldDtcclxuICAgICAgICB2YXIgaG9zdGVkID0gc3RvcmFnZVsnaG9zdGVkJ107XHJcbiAgICAgICAgaWYgKHR5cGVvZiBob3N0ZWQgIT09IHR5cGVvZiBbXSkge1xyXG4gICAgICAgICAgICAvLyBpZiB5b3UgdHJ5IHRvIHN3aXRjaCB0byBTZXQgcGxlYXNlIGNoZWNrb3V0IC5jb25jYXQgdXNhZ2UuXHJcbiAgICAgICAgICAgIC8vIGNvbmNhdCBjb21waWxlcyBidXQgZG9lc24ndCB3b3JrIGFzIGV4cGVjdGVkXHJcbiAgICAgICAgICAgIGhvc3RlZCA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICAgICBzdG9yYWdlWydob3N0ZWQnXSA9IGhvc3RlZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFob3N0ZWQuaW5jbHVkZXModGFyZ2V0KSkge1xyXG4gICAgICAgICAgICBob3N0ZWQucHVzaCh0YXJnZXQpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uSG9zdFN0b3BNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIHRhcmdldCA9IG1zZy50YXJnZXQ7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgJ2hvc3RTdG9wICcgKyB0YXJnZXQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICB2YXIgaG9zdGVkID0gc3RvcmFnZVsnaG9zdGVkJ107XHJcbiAgICAgICAgaWYgKHR5cGVvZiBob3N0ZWQgPT09IHR5cGVvZiBbXSkge1xyXG4gICAgICAgICAgICBzdG9yYWdlWydob3N0ZWQnXSA9IGhvc3RlZC5maWx0ZXIoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHggIT09IHRhcmdldDsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25TZXRJbnZlbnRvcnlNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB0aGlzLm51bVNldEludmVudG9yeSsrO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgc2V0UGNJbnZlbnRvcnkobXNnLmludmVudG9yeSk7XHJcbiAgICAgICAgICAgIHZhciBibG9ja2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KCdxdWVyeUJsb2NrU2V0SW52ZW50b3J5RXZlbnQnLCB7XHJcbiAgICAgICAgICAgICAgICBibG9jazogZnVuY3Rpb24gKCkgeyByZXR1cm4gYmxvY2tlZCA9IHRydWU7IH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmICghYmxvY2tlZCkge1xyXG4gICAgICAgICAgICAgICAgcGNJbnZMYXN0QXBwbHkgPSAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbk9wZW5Db250YWluZXJNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfX2F3YWl0ZXIoX3RoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByZW1vdGVJZCwgbG9jYWxJZCwgcmVmciwgYmFzZU9iamVjdCwgYmFzZVR5cGUsIGZ1bmN0aW9uQ2hlY2tlciwgZmFjdE5hbWUsIGRlbGF5U2Vjb25kcztcclxuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDogcmV0dXJuIFs0IC8qeWllbGQqLywgVXRpbGl0eS53YWl0KDAuMSldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpOyAvLyBHaXZlIGEgY2hhbmNlIHRvIHVwZGF0ZSBpbnZlbnRvcnlcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlSWQgPSBldmVudC5tZXNzYWdlLnRhcmdldDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxJZCA9IHJlbW90ZUlkVG9Mb2NhbElkKHJlbW90ZUlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmciA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGxvY2FsSWQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlZnIgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsICdvbk9wZW5Db250YWluZXJNZXNzYWdlIC0gcmVmciBub3QgZm91bmQnLCAncmVtb3RlSWQnLCByZW1vdGVJZC50b1N0cmluZygxNiksICdsb2NhbElkJywgbG9jYWxJZC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuYWN0aXZhdGUoR2FtZS5nZXRQbGF5ZXIoKSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VPYmplY3QgPSByZWZyLmdldEJhc2VPYmplY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmFzZVR5cGUgPSBiYXNlT2JqZWN0ID09PSBudWxsIHx8IGJhc2VPYmplY3QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJhc2VPYmplY3QuZ2V0VHlwZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkNoZWNrZXIgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmYWN0TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5U2Vjb25kcyA9IC0xLjA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYXNlVHlwZSA9PT0gMjggLyogRm9ybVR5cGUuQ29udGFpbmVyICovKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbkNoZWNrZXIgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBVaS5pc01lbnVPcGVuKFwiQ29udGFpbmVyTWVudVwiKTsgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY3ROYW1lID0gXCInQ29udGFpbmVyTWVudSBvcGVuJ1wiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXlTZWNvbmRzID0gMC4wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJhc2VUeXBlID09PSA0MCAvKiBGb3JtVHlwZS5GdXJuaXR1cmUgKi8pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uQ2hlY2tlciA9IGZ1bmN0aW9uICgpIHsgdmFyIF9hOyByZXR1cm4gISEoKF9hID0gR2FtZS5nZXRQbGF5ZXIoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZ1cm5pdHVyZVJlZmVyZW5jZSgpKTsgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY3ROYW1lID0gXCInZ2V0RnVybml0dXJlUmVmZXJlbmNlIG5vdCBudWxsJ1wiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXlTZWNvbmRzID0gMS4wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmdW5jdGlvbkNoZWNrZXIgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25PcGVuQ29udGFpbmVyTWVzYWdlIC0gbm90IGEgY29udGFpbmVyIG9yIGZ1cm5pdHVyZVwiLCBiYXNlVHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW4gU2t5TVAgY29udGFpbmVycyBoYXZlIDItbmQsIGNsb3NpbmcgYWN0aXZhdGlvbiB1bmRlciB0aGUgaG9vZC5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBkaWZmZXJzIGZyb20gU2t5cmltJ3MgYmVoYXZpb3IsIHdoZXJlIGl0J3MganVzdCBvbmUgYWN0aXZhdGlvbi5cclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9fYXdhaXRlcihfdGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25PcGVuQ29udGFpbmVyTWVzYWdlIC0gd2FpdGluZyBmb3JcIiwgZmFjdE5hbWUsIFwidG8gYmUgdHJ1ZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hLmxhYmVsID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEhZnVuY3Rpb25DaGVja2VyKCkpIHJldHVybiBbMyAvKmJyZWFrKi8sIDNdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgVXRpbGl0eS53YWl0KDAuMSldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJvbk9wZW5Db250YWluZXJNZXNhZ2UgLSB3YWl0aW5nIGZvclwiLCBmYWN0TmFtZSwgXCJ0byBiZSBmYWxzZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hLmxhYmVsID0gNDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmdW5jdGlvbkNoZWNrZXIoKSkgcmV0dXJuIFszIC8qYnJlYWsqLywgNl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBVdGlsaXR5LndhaXQoMC4xKV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIm9uT3BlbkNvbnRhaW5lck1lc2FnZSAtIG1lbnUgY2xvc2VkXCIsIGZhY3ROYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdDogbWVzc2FnZXMuTXNnVHlwZS5BY3RpdmF0ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc3RlcjogMHgxNCwgdGFyZ2V0OiBldmVudC5tZXNzYWdlLnRhcmdldCwgaXNTZWNvbmRBY3RpdmF0aW9uOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwib25PcGVuQ29udGFpbmVyTWVzYWdlIC0gd2FpdGluZ1wiLCBkZWxheVNlY29uZHMsIFwic2Vjb25kcyBiZWZvcmUgc2VuZGluZyBBY3RpdmF0ZU1lc3NhZ2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlsaXR5LndhaXRNZW51TW9kZShkZWxheVNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwib25PcGVuQ29udGFpbmVyTWVzYWdlIC0gc2VudCBBY3RpdmF0ZU1lc3NhZ2VcIiwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7IH0pKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7IH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25UZWxlcG9ydE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGlkID0gKFwiaWR4XCIgaW4gbXNnICYmIHR5cGVvZiBtc2cuaWR4ID09PSBcIm51bWJlclwiKSA/IF90aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpIDogX3RoaXMuZ2V0TXlBY3RvckluZGV4KCk7XHJcbiAgICAgICAgICAgIHZhciByZWZyID0gaWQgPT09IF90aGlzLmdldE15QWN0b3JJbmRleCgpID8gR2FtZS5nZXRQbGF5ZXIoKSA6IGdldE9iamVjdFJlZmVyZW5jZShpZCk7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlRlbGVwb3J0aW5nIGlkXCIsIGlkLCBcInJlZnJJZFwiLCByZWZyID09PSBudWxsIHx8IHJlZnIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpLCBcIi4uLlwiLCBtc2cucG9zLCAnY2VsbC93b3JsZCBpcycsIG1zZy53b3JsZE9yQ2VsbC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICB2YXIgcmFnZG9sbFNlcnZpY2UgPSBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJhZ2RvbGxTZXJ2aWNlKTtcclxuICAgICAgICAgICAgdmFyIHJlZnJJZCA9IHJlZnIgPT09IG51bGwgfHwgcmVmciA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmci5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgdmFyIHJlbW92ZVJhZ2RvbGxDYWxsYmFjayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIFRFU01vZFBsYXRmb3JtLm1vdmVSZWZyVG9Qb3NpdGlvbihPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQgfHwgMCkpLCBDZWxsLmZyb20oR2FtZS5nZXRGb3JtRXgobXNnLndvcmxkT3JDZWxsKSksIFdvcmxkU3BhY2UuZnJvbShHYW1lLmdldEZvcm1FeChtc2cud29ybGRPckNlbGwpKSwgbXNnLnBvc1swXSwgbXNnLnBvc1sxXSwgbXNnLnBvc1syXSwgbXNnLnJvdFswXSwgbXNnLnJvdFsxXSwgbXNnLnJvdFsyXSk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgIGlmIChhY3RvciAvKiYmIGFjdG9yLmdldEZvcm1JRCgpID09PSAweDE0Ki8pIHtcclxuICAgICAgICAgICAgICAgIHJhZ2RvbGxTZXJ2aWNlLnNhZmVSZW1vdmVSYWdkb2xsRnJvbVdvcmxkKGFjdG9yLCByZW1vdmVSYWdkb2xsQ2FsbGJhY2spO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlUmFnZG9sbENhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uQ3JlYXRlQWN0b3JNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgaWYgKHRoaXMuc2tpcEZvcm1WaWV3Q3JlYXRpb24obXNnKSkge1xyXG4gICAgICAgICAgICB2YXIgcmVmcklkXzEgPSBtc2cucmVmcklkO1xyXG4gICAgICAgICAgICB0aGlzLm9uY2VMb2FkKHJlZnJJZF8xLCBmdW5jdGlvbiAocmVmcikge1xyXG4gICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBPYmplY3RSZWZlcmVuY2VFeC5kZWFsV2l0aFJlZihyZWZyLCByZWZyLmdldEJhc2VPYmplY3QoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1zZy5wcm9wcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobXNnLnByb3BzLmludmVudG9yeSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJbnZlbnRvcnkocmVmciwgbXNnLnByb3BzLmludmVudG9yeSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc09wZW4ocmVmciwgISFtc2cucHJvcHNbJ2lzT3BlbiddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0hhcnZlc3RlZChyZWZyLCAhIW1zZy5wcm9wc1snaXNIYXJ2ZXN0ZWQnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsTm9kZVNjYWxlKHJlZnIsIG1zZy5wcm9wcy5zZXROb2RlU2NhbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbE5vZGVUZXh0dXJlU2V0KHJlZnIsIG1zZy5wcm9wcy5zZXROb2RlVGV4dHVyZVNldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNEaXNhYmxlZChyZWZyLCAhIW1zZy5wcm9wc1snZGlzYWJsZWQnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IG1vdmUgdG8gYSBzZXBhcmF0ZSBtb2R1bGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbl8xID0gbXNnLnByb3BzLmxhc3RBbmltYXRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYW5pbWF0aW9uXzEgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWZyaWRfMSA9IHJlZnIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgeyByZXR1cm4gX19hd2FpdGVyKF90aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpXzEsIHJlczI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfYi5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlfMSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2IubGFiZWwgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKGlfMSA8IDUpKSByZXR1cm4gWzMgLypicmVhayovLCA0XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMyID0gKF9hID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcmlkXzEpKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnBsYXlBbmltYXRpb24oYW5pbWF0aW9uXzEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBVdGlsaXR5LndhaXQoMildO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9iLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYi5sYWJlbCA9IDM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaV8xKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6IHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7IH0pKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gbXNnLnByb3BzLmRpc3BsYXlOYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIGluIHN5bmMgd2l0aCBzcFNuaXBwZXRTZXJ2aWNlLnRzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGlzcGxheU5hbWUgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXBsYWNlVmFsdWUgPSAoX2EgPSByZWZyLmdldEJhc2VPYmplY3QoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldE5hbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlVmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lID0gZGlzcGxheU5hbWUucmVwbGFjZSgvJW9yaWdpbmFsX25hbWUlL2csIHJlcGxhY2VWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgXCJDb3VsZG4ndCBnZXQgYSByZXBsYWNlVmFsdWUgZm9yIFNldERpc3BsYXlOYW1lLCByZWZyLmdldEZvcm1JRCgpIHdhc1wiLCByZWZyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZyLnNldERpc3BsYXlOYW1lKGRpc3BsYXlOYW1lLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcImNhbGxpbmcgc2V0RGlzcGxheU5hbWVcIiwgZGlzcGxheU5hbWUsIFwiZm9yXCIsIHJlZnIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCAnRmFpbGVkIHRvIGFwcGx5IG1vZGVsIHRvJywgcmVmcklkXzEudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDcmVhdGUgYWN0b3JcIik7XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmFsbG9jYXRlSWRGb3IobXNnLmlkeCk7XHJcbiAgICAgICAgaWYgKHRoaXMud29ybGRNb2RlbC5mb3Jtcy5sZW5ndGggPD0gaSkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkTW9kZWwuZm9ybXMubGVuZ3RoID0gaSArIDE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBtb3ZlbWVudCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAvLyBUT0RPOiBiZXR0ZXIgY2hlY2sgaWYgaXQgaXMgYW4gbnBjIChub3QgYW4gb2JqZWN0IHJlZmVyZW5jZSlcclxuICAgICAgICBpZiAobXNnLnJlZnJJZCAhPT0gdW5kZWZpbmVkICYmIG1zZy5yZWZySWQgPj0gMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICBtb3ZlbWVudCA9IHtcclxuICAgICAgICAgICAgICAgIHBvczogbXNnLnRyYW5zZm9ybS5wb3MsXHJcbiAgICAgICAgICAgICAgICByb3Q6IG1zZy50cmFuc2Zvcm0ucm90LFxyXG4gICAgICAgICAgICAgICAgd29ybGRPckNlbGw6IG1zZy50cmFuc2Zvcm0ud29ybGRPckNlbGwsXHJcbiAgICAgICAgICAgICAgICBydW5Nb2RlOiAnU3RhbmRpbmcnLFxyXG4gICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAwLFxyXG4gICAgICAgICAgICAgICAgaXNJbkp1bXBTdGF0ZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc1NuZWFraW5nOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGlzQmxvY2tpbmc6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaXNXZWFwRHJhd246IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaXNEZWFkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGhlYWx0aFBlcmNlbnRhZ2U6IDEuMCxcclxuICAgICAgICAgICAgICAgIHNwZWVkOiAwLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZm9ybSA9IHtcclxuICAgICAgICAgICAgaWR4OiBtc2cuaWR4LFxyXG4gICAgICAgICAgICBtb3ZlbWVudDogbW92ZW1lbnQsXHJcbiAgICAgICAgICAgIG51bU1vdmVtZW50Q2hhbmdlczogMCxcclxuICAgICAgICAgICAgbnVtQXBwZWFyYW5jZUNoYW5nZXM6IDAsXHJcbiAgICAgICAgICAgIGJhc2VJZDogbXNnLmJhc2VJZCxcclxuICAgICAgICAgICAgcmVmcklkOiBtc2cucmVmcklkLFxyXG4gICAgICAgICAgICBpc015Q2xvbmU6IG1zZy5pc01lLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy53b3JsZE1vZGVsLmZvcm1zW2ldID0gZm9ybTtcclxuICAgICAgICBpZiAobXNnLmFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgZm9ybS5hcHBlYXJhbmNlID0gbXNnLmFwcGVhcmFuY2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cuZXF1aXBtZW50KSB7XHJcbiAgICAgICAgICAgIGZvcm0uZXF1aXBtZW50ID0gbXNnLmVxdWlwbWVudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5pc0RlYWQpIHtcclxuICAgICAgICAgICAgZm9ybS5pc0RlYWQgPSBtc2cuaXNEZWFkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLmFuaW1hdGlvbikge1xyXG4gICAgICAgICAgICBmb3JtLmFuaW1hdGlvbiA9IG1zZy5hbmltYXRpb247XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cucHJvcHMpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gbXNnLnByb3BzKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtW3Byb3BOYW1lXSA9IG1zZy5wcm9wc1twcm9wTmFtZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgbXNnLmN1c3RvbVByb3BzSnNvbkR1bXBzLmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICB2YXIgcGFyc2VkO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgcGFyc2VkID0gSlNPTi5wYXJzZShlbGVtZW50LnByb3BWYWx1ZUpzb25EdW1wKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCBcImNyZWF0ZUFjdG9yXCIsIChfYSA9IG1zZy5yZWZySWQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b1N0cmluZygxNiksIFwiZmFpbGVkIHRvIHBhcnNlIGN1c3RvbSBwcm9wXCIsIGVsZW1lbnQucHJvcE5hbWUsIGVsZW1lbnQucHJvcFZhbHVlSnNvbkR1bXAsIGUubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvcm1bZWxlbWVudC5wcm9wTmFtZV0gPSBwYXJzZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKG1zZy5pc01lKSB7XHJcbiAgICAgICAgICAgIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID0gaTtcclxuICAgICAgICAgICAgdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlclJlZnJJZCA9IG1zZy5yZWZySWQgfHwgMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gVE9ETzogbW92ZSB0byBhIHNlcGFyYXRlIG1vZHVsZVxyXG4gICAgICAgIGlmIChtc2cucHJvcHMgJiYgIW1zZy5wcm9wcy5pc0hvc3RlZEJ5T3RoZXIpIHtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5wcm9wcyAmJiBtc2cucHJvcHMuaXNSYWNlTWVudU9wZW4gJiYgbXNnLmlzTWUpIHtcclxuICAgICAgICAgICAgdGhpcy5vblNldFJhY2VNZW51T3Blbk1lc3NhZ2UoeyBtZXNzYWdlOiB7IHQ6IE1zZ1R5cGUuU2V0UmFjZU1lbnVPcGVuLCBvcGVuOiB0cnVlIH0gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBudW1TZXRJbnZlbnRvcnkgPSB0aGlzLm51bVNldEludmVudG9yeTtcclxuICAgICAgICB2YXIgYXBwbHlQY0ludiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKG1zZy5lcXVpcG1lbnQpIHtcclxuICAgICAgICAgICAgICAgIGFwcGx5RXF1aXBtZW50KEdhbWUuZ2V0UGxheWVyKCksIG1zZy5lcXVpcG1lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChudW1TZXRJbnZlbnRvcnkgIT09IF90aGlzLm51bVNldEludmVudG9yeSkge1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsICdTa2lwcGluZyBpbnZlbnRvcnkgYXBwbHkgZHVlIHRvIG5ld2VyIHNldEludmVudG9yeSBtZXNzYWdlJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG1zZy5wcm9wcyAmJiBtc2cucHJvcHMuaW52ZW50b3J5KSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5vblNldEludmVudG9yeU1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5TZXRJbnZlbnRvcnksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGludmVudG9yeTogbXNnLnByb3BzLmludmVudG9yeVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAobXNnLmlzTWUgJiYgbXNnLnByb3BzICYmIG1zZy5wcm9wcy5sZWFybmVkU3BlbGxzKSB7XHJcbiAgICAgICAgICAgIHZhciBsZWFybmVkU3BlbGxzXzEgPSBtc2cucHJvcHMubGVhcm5lZFNwZWxscztcclxuICAgICAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgVXRpbGl0eS53YWl0KDEpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwbGF5ZXIgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQWxsU3BlbGxzKHBsYXllcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlYXJuU3BlbGxzKHBsYXllciwgbGVhcm5lZFNwZWxsc18xKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwicGxheWVyIGxlYXJuZWRTcGVsbHM6XCIsIEpTT04uc3RyaW5naWZ5KGxlYXJuZWRTcGVsbHNfMSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1zZy5pc01lKSB7XHJcbiAgICAgICAgICAgIGlmICgoX2EgPSBtc2cucHJvcHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pc0RlYWQpIHtcclxuICAgICAgICAgICAgICAgIG9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwiYXBwbHlEZWF0aFN0YXRlRXZlbnRcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RvcjogR2FtZS5nZXRQbGF5ZXIoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNEZWFkOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLmlzTWUpIHtcclxuICAgICAgICAgICAgdmFyIHNwYXduVGFza18xID0geyBydW5uaW5nOiBmYWxzZSB9O1xyXG4gICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBVc2UgTW92ZVJlZnJUb1Bvc2l0aW9uIHRvIHNwYXduIGlmIHBvc3NpYmxlIChub3QgaW4gbWFpbiBtZW51KVxyXG4gICAgICAgICAgICAgICAgLy8gSW4gY2FzZSBvZiBjb25uZWN0aW9uIGxvc3QgdGhpcyBpcyBlc3NlbnRpYWxcclxuICAgICAgICAgICAgICAgIGlmICghc3Bhd25UYXNrXzEucnVubmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwYXduVGFza18xLnJ1bm5pbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCAnVXNpbmcgbW92ZVJlZnJUb1Bvc2l0aW9uIHRvIHNwYXduIHBsYXllcicpO1xyXG4gICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7IHJldHVybiBfX2F3YWl0ZXIoX3RoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbCwgcG9zLCBzcXIsIGRpc3RhbmNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRydWUpIHJldHVybiBbMyAvKmJyZWFrKi8sIDJdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnU3Bhd25pbmcuLi4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVEVTTW9kUGxhdGZvcm0ubW92ZVJlZnJUb1Bvc2l0aW9uKEdhbWUuZ2V0UGxheWVyKCksIENlbGwuZnJvbShHYW1lLmdldEZvcm1FeChtc2cudHJhbnNmb3JtLndvcmxkT3JDZWxsKSksIFdvcmxkU3BhY2UuZnJvbShHYW1lLmdldEZvcm1FeChtc2cudHJhbnNmb3JtLndvcmxkT3JDZWxsKSksIG1zZy50cmFuc2Zvcm0ucG9zWzBdLCBtc2cudHJhbnNmb3JtLnBvc1sxXSwgbXNnLnRyYW5zZm9ybS5wb3NbMl0sIG1zZy50cmFuc2Zvcm0ucm90WzBdLCBtc2cudHJhbnNmb3JtLnJvdFsxXSwgbXNnLnRyYW5zZm9ybS5yb3RbMl0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBVdGlsaXR5LndhaXQoMSldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbCA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDJdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsLmdldFBvc2l0aW9uWCgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGwuZ2V0UG9zaXRpb25ZKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbC5nZXRQb3NpdGlvblooKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3FyID0gZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHggKiB4OyB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZSA9IE1hdGguc3FydChzcXIocG9zWzBdIC0gbXNnLnRyYW5zZm9ybS5wb3NbMF0pICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNxcihwb3NbMV0gLSBtc2cudHJhbnNmb3JtLnBvc1sxXSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPCAyNTYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDJdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjogcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTsgfSkoKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBVbmZvcnR1bmF0ZWxseSBpdCByZXF1aXJlcyB0d28gY2FsbHMgdG8gd29ya1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxpdHkud2FpdCgxKS50aGVuKGFwcGx5UGNJbnYpO1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxpdHkud2FpdCgxLjMpLnRoZW4oYXBwbHlQY0ludik7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gTm90ZTogYXBwZWFyYW5jZSBwYXJ0IHdhcyBjb3B5LXBhc3RlZFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtc2cuYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBseUFwcGVhcmFuY2VUb1BsYXllcihtc2cuYXBwZWFyYW5jZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG1zZy5wcm9wcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiYXNlQWN0b3JWYWx1ZXNfMSA9IG5ldyBNYXAoW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ2hlYWxSYXRlJywgbXNnLnByb3BzLmhlYWxSYXRlXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydoZWFsUmF0ZU11bHQnLCBtc2cucHJvcHMuaGVhbFJhdGVNdWx0XSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydoZWFsdGgnLCBtc2cucHJvcHMuaGVhbHRoXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydtYWdpY2thUmF0ZScsIG1zZy5wcm9wcy5tYWdpY2thUmF0ZV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnbWFnaWNrYVJhdGVNdWx0JywgbXNnLnByb3BzLm1hZ2lja2FSYXRlTXVsdF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnbWFnaWNrYScsIG1zZy5wcm9wcy5tYWdpY2thXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydzdGFtaW5hUmF0ZScsIG1zZy5wcm9wcy5zdGFtaW5hUmF0ZV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnc3RhbWluYVJhdGVNdWx0JywgbXNnLnByb3BzLnN0YW1pbmFSYXRlTXVsdF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFsnc3RhbWluYScsIG1zZy5wcm9wcy5zdGFtaW5hXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydoZWFsdGhQZXJjZW50YWdlJywgbXNnLnByb3BzLmhlYWx0aFBlcmNlbnRhZ2VdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ3N0YW1pbmFQZXJjZW50YWdlJywgbXNnLnByb3BzLnN0YW1pbmFQZXJjZW50YWdlXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgWydtYWdpY2thUGVyY2VudGFnZScsIG1zZy5wcm9wcy5tYWdpY2thUGVyY2VudGFnZV0sXHJcbiAgICAgICAgICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBsYXllcl8xID0gR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyXzEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmFzZUFjdG9yVmFsdWVzXzEuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmluY2x1ZGVzKCdQZXJjZW50YWdlJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN1YktleSA9IGtleS5yZXBsYWNlKCdQZXJjZW50YWdlJywgJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3ViVmFsdWUgPSBiYXNlQWN0b3JWYWx1ZXNfMS5nZXQoc3ViS2V5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdWJWYWx1ZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldEFjdG9yVmFsdWVQZXJjZW50YWdlKHBsYXllcl8xLCBzdWJLZXksIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyXzEuc2V0QWN0b3JWYWx1ZShrZXksIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIG9uY2UoJ3RpY2snLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBvbmNlKCd0aWNrJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghc3Bhd25UYXNrXzEucnVubmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzcGF3blRhc2tfMS5ydW5uaW5nID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRPcmRlciA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpXzIgPSAwOyBpXzIgPCBfdGhpcy5zcC5HYW1lLmdldE1vZENvdW50KCk7ICsraV8yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkT3JkZXIucHVzaChfdGhpcy5zcC5HYW1lLmdldE1vZE5hbWUoaV8yKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwibG9hZGluZyBnYW1lIGluIHdvcmxkL2NlbGxcIiwgbXNnLnRyYW5zZm9ybS53b3JsZE9yQ2VsbC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9hZEdhbWVTZXJ2aWNlID0gX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihMb2FkR2FtZVNlcnZpY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2FkR2FtZVNlcnZpY2UubG9hZEdhbWUobXNnLnRyYW5zZm9ybS5wb3MsIG1zZy50cmFuc2Zvcm0ucm90LCBtc2cudHJhbnNmb3JtLndvcmxkT3JDZWxsLCBtc2cuYXBwZWFyYW5jZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbXNnLmFwcGVhcmFuY2UubmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWNlSWQ6IG1zZy5hcHBlYXJhbmNlLnJhY2VJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBJbiB0eXBlcywgaXNGZW1hbGUgaXMgdW5kZXIgZmFjZSwgYnV0IGluIHRoZSByZWFsaXR5IFNQIGV4cGVjdHMgaXQgaGVyZS4gRml4IHJlcXVpcmVkLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZlbWFsZTogbXNnLmFwcGVhcmFuY2UuaXNGZW1hbGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFjZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYWlyQ29sb3I6IG1zZy5hcHBlYXJhbmNlLmhhaXJDb2xvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keVNraW5Db2xvcjogbXNnLmFwcGVhcmFuY2Uuc2tpbkNvbG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkVGV4dHVyZVNldElkOiBtc2cuYXBwZWFyYW5jZS5oZWFkVGV4dHVyZVNldElkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkUGFydElkczogbXNnLmFwcGVhcmFuY2UuaGVhZHBhcnRJZHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNldHM6IG1zZy5hcHBlYXJhbmNlLnByZXNldHNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsIGxvYWRPcmRlciwgeyBtaW51dGVzOiAwLCBzZWNvbmRzOiAwLCBob3VyczogX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihUaW1lU2VydmljZSkuZ2V0VGltZSgpLm5ld0dhbWVIb3VyVmFsdWUgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5UGNJbnYoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxpdHkud2FpdCgwLjMpLnRoZW4oYXBwbHlQY0ludik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3RlOiBhcHBlYXJhbmNlIHBhcnQgd2FzIGNvcHktcGFzdGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXNnLmFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBseUFwcGVhcmFuY2VUb1BsYXllcihtc2cuYXBwZWFyYW5jZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vbkRlc3Ryb3lBY3Rvck1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdmFyIGkgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgIHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXSA9IHVuZGVmaW5lZDtcclxuICAgICAgICAoX2EgPSBnZXRWaWV3RnJvbVN0b3JhZ2UoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnN5bmNGb3JtQXJyYXkodGhpcy53b3JsZE1vZGVsKTtcclxuICAgICAgICAvLyBTaHJpbmsgdG8gZml0XHJcbiAgICAgICAgd2hpbGUgKDEpIHtcclxuICAgICAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMud29ybGRNb2RlbC5mb3Jtcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGlmICghbGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy53b3JsZE1vZGVsLmZvcm1zW2xlbmd0aCAtIDFdKSB7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLndvcmxkTW9kZWwuZm9ybXMubGVuZ3RoID0gbGVuZ3RoIC0gMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID09PSBpKSB7XHJcbiAgICAgICAgICAgIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID0gLTE7XHJcbiAgICAgICAgICAgIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJSZWZySWQgPSAwO1xyXG4gICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRvIGEgc2VwYXJhdGUgbW9kdWxlXHJcbiAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIEdhbWUucXVpdFRvTWFpbk1lbnUoKTsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZnJlZUlkRm9yKG1zZy5pZHgpO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVNb3ZlbWVudE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV07XHJcbiAgICAgICAgaWYgKGZvcm0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uVXBkYXRlTW92ZW1lbnRNZXNzYWdlIC0gRm9ybSB3aXRoIGlkeFwiLCBtc2cuaWR4LCBcIm5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtLm1vdmVtZW50ID0gbXNnLmRhdGE7XHJcbiAgICAgICAgaWYgKCFmb3JtLm51bU1vdmVtZW50Q2hhbmdlcykge1xyXG4gICAgICAgICAgICBmb3JtLm51bU1vdmVtZW50Q2hhbmdlcyA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm0ubnVtTW92ZW1lbnRDaGFuZ2VzKys7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZUFuaW1hdGlvbk1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV07XHJcbiAgICAgICAgaWYgKGZvcm0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uVXBkYXRlQW5pbWF0aW9uTWVzc2FnZSAtIEZvcm0gd2l0aCBpZHhcIiwgbXNnLmlkeCwgXCJub3QgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybS5hbmltYXRpb24gPSBtc2cuZGF0YTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlQXBwZWFyYW5jZU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICB2YXIgZm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXTtcclxuICAgICAgICBpZiAoZm9ybSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25VcGRhdGVBcHBlYXJhbmNlTWVzc2FnZSAtIEZvcm0gd2l0aCBpZHhcIiwgbXNnLmlkeCwgXCJub3QgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybS5hcHBlYXJhbmNlID0gbXNnLmRhdGEgfHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmICghZm9ybS5udW1BcHBlYXJhbmNlQ2hhbmdlcykge1xyXG4gICAgICAgICAgICBmb3JtLm51bUFwcGVhcmFuY2VDaGFuZ2VzID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybS5udW1BcHBlYXJhbmNlQ2hhbmdlcysrO1xyXG4gICAgICAgIHZhciBuZXdBcHBlYXJhbmNlID0gbXNnLmRhdGE7XHJcbiAgICAgICAgaWYgKGkgPT09IHRoaXMuZ2V0TXlBY3RvckluZGV4KCkgJiYgbmV3QXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBhcHBseUFwcGVhcmFuY2VUb1BsYXllcihuZXdBcHBlYXJhbmNlKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIkFwcGxpZWQgYXBwZWFyYW5jZSB0byB0aGUgcGxheWVyXCIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5vblVwZGF0ZUVxdWlwbWVudE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgaSA9IHRoaXMuZ2V0SWRNYW5hZ2VyKCkuZ2V0SWQobXNnLmlkeCk7XHJcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaV07XHJcbiAgICAgICAgaWYgKGZvcm0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uVXBkYXRlRXF1aXBtZW50TWVzc2FnZSAtIEZvcm0gd2l0aCBpZHhcIiwgbXNnLmlkeCwgXCJub3QgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybS5lcXVpcG1lbnQgPSBtc2cuZGF0YTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVXBkYXRlUHJvcGVydHlNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICB2YXIgbXNnRGF0YSA9IHRoaXMuZXh0cmFjdFVwZGF0ZVByb3BlcnR5TWVzc2FnZURhdGEobXNnKTtcclxuICAgICAgICBpZiAodGhpcy5za2lwRm9ybVZpZXdDcmVhdGlvbihtc2cpKSB7XHJcbiAgICAgICAgICAgIHZhciByZWZySWRfMiA9IG1zZy5yZWZySWQ7XHJcbiAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkXzIpKTtcclxuICAgICAgICAgICAgICAgIGlmICghcmVmcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCAnVXBkYXRlUHJvcGVydHk6IHJlZnIgbm90IGZvdW5kJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG1zZy5wcm9wTmFtZSA9PT0gJ2ludmVudG9yeScpIHtcclxuICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbEludmVudG9yeShyZWZyLCBtc2dEYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1zZy5wcm9wTmFtZSA9PT0gJ2lzT3BlbicpIHtcclxuICAgICAgICAgICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzT3BlbihyZWZyLCAhIW1zZ0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnLnByb3BOYW1lID09PSAnaXNIYXJ2ZXN0ZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0hhcnZlc3RlZChyZWZyLCAhIW1zZ0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobXNnLnByb3BOYW1lID09PSAnZGlzYWJsZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc0Rpc2FibGVkKHJlZnIsICEhbXNnRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBpID0gdGhpcy5nZXRJZE1hbmFnZXIoKS5nZXRJZChtc2cuaWR4KTtcclxuICAgICAgICB2YXIgZm9ybSA9IHRoaXMud29ybGRNb2RlbC5mb3Jtc1tpXTtcclxuICAgICAgICBmb3JtW21zZy5wcm9wTmFtZV0gPSBtc2dEYXRhO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25EZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBkZWF0aCBzdGF0ZTpcIiwgSlNPTi5zdHJpbmdpZnkobXNnLnRJc0RlYWQpKTtcclxuICAgICAgICB2YXIgaWQgPSB0aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy50SXNEZWFkLmlkeCk7XHJcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXNbaWRdO1xyXG4gICAgICAgIGlmIChmb3JtID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJvbkRlYXRoU3RhdGVDb250YWluZXJNZXNzYWdlIC0gRm9ybSB3aXRoIGlkeFwiLCBtc2cudElzRGVhZC5pZHgsIFwibm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtc2cudElzRGVhZC5wcm9wTmFtZSAhPT0gbmFtZW9mKCdpc0RlYWQnKSkge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIm9uRGVhdGhTdGF0ZUNvbnRhaW5lck1lc3NhZ2UgLSBJbnZhbGlkIHByb3BOYW1lXCIsIG1zZy50SXNEZWFkLnByb3BOYW1lKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbXNnRGF0YSA9IHRoaXMuZXh0cmFjdFVwZGF0ZVByb3BlcnR5TWVzc2FnZURhdGEobXNnLnRJc0RlYWQpO1xyXG4gICAgICAgIGlmICh0eXBlb2YgbXNnRGF0YSAhPT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwib25EZWF0aFN0YXRlQ29udGFpbmVyTWVzc2FnZSAtIEludmFsaWQgZGF0YVwiLCBtc2dEYXRhKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXNnLnRDaGFuZ2VWYWx1ZXMpIHtcclxuICAgICAgICAgICAgdGhpcy5vbkNoYW5nZVZhbHVlc01lc3NhZ2UoeyBtZXNzYWdlOiBtc2cudENoYW5nZVZhbHVlcyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGVQcm9wZXJ0eU1lc3NhZ2UoeyBtZXNzYWdlOiBtc2cudElzRGVhZCB9KTsgfSk7XHJcbiAgICAgICAgaWYgKG1zZy50VGVsZXBvcnQpIHtcclxuICAgICAgICAgICAgdGhpcy5vblRlbGVwb3J0TWVzc2FnZSh7IG1lc3NhZ2U6IG1zZy50VGVsZXBvcnQgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICB2YXIgYWN0b3IgPSBpZCA9PT0gX3RoaXMuZ2V0V29ybGRNb2RlbCgpLnBsYXllckNoYXJhY3RlckZvcm1JZHhcclxuICAgICAgICAgICAgICAgID8gR2FtZS5nZXRQbGF5ZXIoKVxyXG4gICAgICAgICAgICAgICAgOiBBY3Rvci5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlbW90ZUlkVG9Mb2NhbElkKChfYSA9IGZvcm0ucmVmcklkKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwKSkpO1xyXG4gICAgICAgICAgICBpZiAoYWN0b3IpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJhcHBseURlYXRoU3RhdGVFdmVudFwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdG9yOiBhY3RvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNEZWFkOiBtc2dEYXRhXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgUmVzcGF3bk5lZWRlZEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdG9yLmRpc2FibGVOb1dhaXQoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rvci5kZWxldGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5oYW5kbGVDb25uZWN0aW9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy53b3JsZE1vZGVsLmZvcm1zID0gW107XHJcbiAgICAgICAgdGhpcy53b3JsZE1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPSAtMTtcclxuICAgICAgICB0aGlzLndvcmxkTW9kZWwucGxheWVyQ2hhcmFjdGVyUmVmcklkID0gMDtcclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkhhbmRsZSBjb25uZWN0aW9uIGFjY2VwdGVkXCIpO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25DaGFuZ2VWYWx1ZXNNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbXNnID0gZXZlbnQubWVzc2FnZTtcclxuICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBpZCA9IF90aGlzLmdldElkTWFuYWdlcigpLmdldElkKG1zZy5pZHgpO1xyXG4gICAgICAgICAgICB2YXIgcmVmciA9IGlkID09PSBfdGhpcy5nZXRNeUFjdG9ySW5kZXgoKSA/IEdhbWUuZ2V0UGxheWVyKCkgOiBnZXRPYmplY3RSZWZlcmVuY2UoaWQpO1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIF9hID0gbXNnLmRhdGEsIGhlYWx0aCA9IF9hLmhlYWx0aCwgc3RhbWluYSA9IF9hLnN0YW1pbmEsIG1hZ2lja2EgPSBfYS5tYWdpY2thO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGhlYWx0aCA9PT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgc2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoYWMsICdoZWFsdGgnLCBoZWFsdGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhbWluYSA9PT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgc2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoYWMsICdzdGFtaW5hJywgc3RhbWluYSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBtYWdpY2thID09PSBcIm51bWJlclwiKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRBY3RvclZhbHVlUGVyY2VudGFnZShhYywgJ21hZ2lja2EnLCBtYWdpY2thKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25TZXRSYWNlTWVudU9wZW5NZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgaWYgKG1zZy5vcGVuKSB7XHJcbiAgICAgICAgICAgIC8vIHdhaXQgMC4zcyBjYXVzZSB3ZSBjYW4gc2VlIHZpc3VhbCBidWdzIHdoZW4gdGVsZXBvcnRpbmdcclxuICAgICAgICAgICAgLy8gYW5kIHNob3dpbmcgdGhpcyBtZW51IGF0IHRoZSBzYW1lIHRpbWUgaW4gb25Db25uZWN0XHJcbiAgICAgICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBVdGlsaXR5LndhaXQoMC4zKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICB1bmVxdWlwSXJvbkhlbG1ldCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIEdhbWUuc2hvd1JhY2VNZW51KCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgY2xvc2VNZW51IGluIFNreXJpbVBsYXRmb3JtXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8qKiBQYWNrZXQgaGFuZGxlcnMgZW5kICoqL1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5nZXRXb3JsZE1vZGVsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndvcmxkTW9kZWw7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5nZXRNeUFjdG9ySW5kZXggPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4O1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuZ2V0TXlSZW1vdGVSZWZySWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud29ybGRNb2RlbC5wbGF5ZXJDaGFyYWN0ZXJSZWZySWQ7XHJcbiAgICB9O1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5nZXRJZE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaWRNYW5hZ2VyXztcclxuICAgIH07XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoUmVtb3RlU2VydmVyLnByb3RvdHlwZSwgXCJ3b3JsZE1vZGVsXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzdG9yYWdlW1wid29ybGRNb2RlbFwiXSA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgICAgICAgICAgICBzdG9yYWdlW1wid29ybGRNb2RlbFwiXSA9IHsgZm9ybXM6IFtdLCBwbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4OiAtMSwgcGxheWVyQ2hhcmFjdGVyUmVmcklkOiAwIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN0b3JhZ2VbXCJ3b3JsZE1vZGVsXCJdO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXHJcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLCBcImlkTWFuYWdlcl9cIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHN0b3JhZ2VbXCJpZE1hbmFnZXJcIl0gPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgICAgICAgICAgLy8gTm90ZTogZnVsbCBJZE1hbmFnZXIgb2JqZWN0IHByZXNlcnZlZCBhY3Jvc3MgaG90LXJlbG9hZHMsIGluY2x1ZGluZyBtZXRob2RzLlxyXG4gICAgICAgICAgICAgICAgc3RvcmFnZVtcImlkTWFuYWdlclwiXSA9IG5ldyBJZE1hbmFnZXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gc3RvcmFnZVtcImlkTWFuYWdlclwiXTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uY2VMb2FkID0gZnVuY3Rpb24gKHJlZnJJZCwgY2FsbGJhY2ssIG1heEF0dGVtcHRzKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAobWF4QXR0ZW1wdHMgPT09IHZvaWQgMCkgeyBtYXhBdHRlbXB0cyA9IDEyMDsgfVxyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICAgICAgaWYgKHJlZnIpIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHJlZnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbWF4QXR0ZW1wdHMtLTtcclxuICAgICAgICAgICAgICAgIGlmIChtYXhBdHRlbXB0cyA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBvbmNlKCd1cGRhdGUnLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlTG9hZChyZWZySWQsIGNhbGxiYWNrLCBtYXhBdHRlbXB0cyk7IH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsICdGYWlsZWQgdG8gbG9hZCBvYmplY3QgcmVmZXJlbmNlICcgKyByZWZySWQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUuc2tpcEZvcm1WaWV3Q3JlYXRpb24gPSBmdW5jdGlvbiAobXNnKSB7XHJcbiAgICAgICAgLy8gT3B0aW1pemF0aW9uIGFkZGVkIGluICMxMTg2LCBob3dldmVyIGl0IGRvZXNuJ3Qgd29yayBmb3IgZG9vcnMgZm9yIHNvbWUgcmVhc29uXHJcbiAgICAgICAgcmV0dXJuIG1zZy5yZWZySWQgJiYgbXNnLnJlZnJJZCA8IDB4ZmYwMDAwMDAgJiYgbXNnLmJhc2VSZWNvcmRUeXBlICE9PSAnRE9PUic7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgUmVtb3RlU2VydmVyLnByb3RvdHlwZS5leHRyYWN0VXBkYXRlUHJvcGVydHlNZXNzYWdlRGF0YSA9IGZ1bmN0aW9uICh1cGRhdGVQcm9wZXJ0eU1lc3NhZ2UpIHtcclxuICAgICAgICB2YXIgbXNnRGF0YSA9IHVwZGF0ZVByb3BlcnR5TWVzc2FnZS5kYXRhO1xyXG4gICAgICAgIGlmICh1cGRhdGVQcm9wZXJ0eU1lc3NhZ2UuZGF0YUR1bXAgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbXNnRGF0YSA9IEpTT04ucGFyc2UodXBkYXRlUHJvcGVydHlNZXNzYWdlLmRhdGFEdW1wKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsICdleHRyYWN0VXBkYXRlUHJvcGVydHlNZXNzYWdlRGF0YSAtIEZhaWxlZCB0byBwYXJzZSBkYXRhRHVtcCcsIHVwZGF0ZVByb3BlcnR5TWVzc2FnZS5kYXRhRHVtcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbXNnRGF0YTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uU3BlbGxDYXN0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIG9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShHYW1lLmdldEZvcm1FeChyZW1vdGVJZFRvTG9jYWxJZChtc2cuZGF0YS5jYXN0ZXIpKSk7XHJcbiAgICAgICAgICAgIGlmICghYWMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgYWN0b3JBbmltYXRpb25WYXJpYWJsZXMgPSB7XHJcbiAgICAgICAgICAgICAgICBib29sZWFuczogbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMuYm9vbGVhbnMpLFxyXG4gICAgICAgICAgICAgICAgZmxvYXRzOiBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hY3RvckFuaW1hdGlvblZhcmlhYmxlcy5mbG9hdHMpLFxyXG4gICAgICAgICAgICAgICAgaW50ZWdlcnM6IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzLmludGVnZXJzKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAobXNnLmRhdGEuaW50ZXJydXB0Q2FzdCkge1xyXG4gICAgICAgICAgICAgICAgaW50ZXJydXB0Q2FzdChhYy5nZXRGb3JtSUQoKSwgbXNnLmRhdGEuY2FzdGluZ1NvdXJjZSwgYWN0b3JBbmltYXRpb25WYXJpYWJsZXMpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBzcGVsbCA9IGFjLmdldEVxdWlwcGVkU3BlbGwobXNnLmRhdGEuY2FzdGluZ1NvdXJjZSk7XHJcbiAgICAgICAgICAgIGlmIChzcGVsbCkge1xyXG4gICAgICAgICAgICAgICAgY2FzdFNwZWxsSW1tZWRpYXRlKGFjLmdldEZvcm1JRCgpLCBtc2cuZGF0YS5jYXN0aW5nU291cmNlLCBzcGVsbC5nZXRGb3JtSUQoKSwgcmVtb3RlSWRUb0xvY2FsSWQobXNnLmRhdGEudGFyZ2V0KSwgbXNnLmRhdGEuYWltQW5nbGUsIG1zZy5kYXRhLmFpbUhlYWRpbmcsIGFjdG9yQW5pbWF0aW9uVmFyaWFibGVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVBbmltVmFyaWFibGVzTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgb25jZSgndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHJlbW90ZUlkVG9Mb2NhbElkKG1zZy5kYXRhLmFjdG9yUmVtb3RlSWQpKSk7XHJcbiAgICAgICAgICAgIGlmICghYWMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgYWN0b3JBbmltYXRpb25WYXJpYWJsZXMgPSB7XHJcbiAgICAgICAgICAgICAgICBib29sZWFuczogbmV3IFVpbnQ4QXJyYXkobXNnLmRhdGEuYWN0b3JBbmltYXRpb25WYXJpYWJsZXMuYm9vbGVhbnMpLFxyXG4gICAgICAgICAgICAgICAgZmxvYXRzOiBuZXcgVWludDhBcnJheShtc2cuZGF0YS5hY3RvckFuaW1hdGlvblZhcmlhYmxlcy5mbG9hdHMpLFxyXG4gICAgICAgICAgICAgICAgaW50ZWdlcnM6IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmFjdG9yQW5pbWF0aW9uVmFyaWFibGVzLmludGVnZXJzKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB2YXIgaXNBcHBseWVkID0gYXBwbHlBbmltYXRpb25WYXJpYWJsZXNUb0FjdG9yKGFjLmdldEZvcm1JRCgpLCBhY3RvckFuaW1hdGlvblZhcmlhYmxlcyk7XHJcbiAgICAgICAgICAgIGlmICghaXNBcHBseWVkKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcihfdGhpcywgJ0ZhaWxlZCBhcHBseSBBbmltYXRpb25WYXJpYWJsZXMgdG8gYWN0b3Igd2l0aCBpZDogJyArIGFjLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBSZW1vdGVTZXJ2ZXIucHJvdG90eXBlLm9uVm9pY2VDaGF0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBtc2cgPSBldmVudC5tZXNzYWdlO1xyXG4gICAgICAgIC8vIFVwZGF0ZSBmb3JtIG1vZGVsIHdpdGggaXNUYWxraW5nIHN0YXRlXHJcbiAgICAgICAgdmFyIHNwZWFrZXJGb3JtID0gdGhpcy53b3JsZE1vZGVsLmZvcm1zLmZpbmQoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIGYgJiYgZi5yZWZySWQgPT09IG1zZy5kYXRhLnNwZWFrZXJJZDsgfSk7XHJcbiAgICAgICAgaWYgKHNwZWFrZXJGb3JtKSB7XHJcbiAgICAgICAgICAgIHNwZWFrZXJGb3JtLmlzVGFsa2luZyA9IG1zZy5kYXRhLmlzVGFsa2luZztcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gRm9yd2FyZCB0byBWb2ljZUNoYXRTZXJ2aWNlIGZvciBwcm9jZXNzaW5nXHJcbiAgICAgICAgdmFyIHZvaWNlQ2hhdFNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoVm9pY2VDaGF0U2VydmljZSk7XHJcbiAgICAgICAgaWYgKHZvaWNlQ2hhdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgdmFyIGF1ZGlvRGF0YSA9IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmF1ZGlvRGF0YSk7XHJcbiAgICAgICAgICAgIHZvaWNlQ2hhdFNlcnZpY2Uub25SZWNlaXZlVm9pY2VEYXRhKG1zZy5kYXRhLnNwZWFrZXJJZCwgYXVkaW9EYXRhLmJ1ZmZlciwgMCwgMCwgMCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFJlbW90ZVNlcnZlci5wcm90b3R5cGUub25VcGRhdGVWb2ljZUNoYXRNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgLy8gVXBkYXRlIGZvcm0gbW9kZWwgd2l0aCBpc1RhbGtpbmcgc3RhdGVcclxuICAgICAgICB2YXIgc3BlYWtlckZvcm0gPSB0aGlzLndvcmxkTW9kZWwuZm9ybXMuZmluZChmdW5jdGlvbiAoZikgeyByZXR1cm4gZiAmJiBmLnJlZnJJZCA9PT0gbXNnLmRhdGEuc3BlYWtlcklkOyB9KTtcclxuICAgICAgICBpZiAoc3BlYWtlckZvcm0pIHtcclxuICAgICAgICAgICAgc3BlYWtlckZvcm0uaXNUYWxraW5nID0gbXNnLmRhdGEuaXNUYWxraW5nO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBGb3J3YXJkIHRvIFZvaWNlQ2hhdFNlcnZpY2Ugd2l0aCAzRCBwb3NpdGlvbiBkYXRhXHJcbiAgICAgICAgdmFyIHZvaWNlQ2hhdFNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoVm9pY2VDaGF0U2VydmljZSk7XHJcbiAgICAgICAgaWYgKHZvaWNlQ2hhdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgdmFyIGF1ZGlvRGF0YSA9IG5ldyBVaW50OEFycmF5KG1zZy5kYXRhLmF1ZGlvRGF0YSk7XHJcbiAgICAgICAgICAgIHZvaWNlQ2hhdFNlcnZpY2Uub25SZWNlaXZlVm9pY2VEYXRhKG1zZy5kYXRhLnNwZWFrZXJJZCwgYXVkaW9EYXRhLmJ1ZmZlciwgbXNnLmRhdGEucG9zaXRpb25bMF0sIC8vIHhcclxuICAgICAgICAgICAgbXNnLmRhdGEucG9zaXRpb25bMV0sIC8vIHlcclxuICAgICAgICAgICAgbXNnLmRhdGEucG9zaXRpb25bMl0gLy8gelxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gUmVtb3RlU2VydmVyO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFJlbW90ZVNlcnZlciB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBTaW5nbGVQbGF5ZXJTZXJ2aWNlIH0gZnJvbSBcIi4vc2luZ2xlUGxheWVyU2VydmljZVwiO1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IGdldE1vdmVtZW50IH0gZnJvbSBcIi4uLy4uL3N5bmMvbW92ZW1lbnRHZXRcIjtcclxuLy8gVE9ETzogcmVmYWN0b3IgdGhpcyBvdXRcclxuaW1wb3J0ICogYXMgd29ybGRWaWV3TWlzYyBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdNaXNjXCI7XHJcbmltcG9ydCB7IEFuaW1hdGlvblNvdXJjZSB9IGZyb20gXCIuLi8uLi9zeW5jL2FuaW1hdGlvblwiO1xyXG5pbXBvcnQgeyBnZXRBcHBlYXJhbmNlIH0gZnJvbSBcIi4uLy4uL3N5bmMvYXBwZWFyYW5jZVwiO1xyXG5pbXBvcnQgeyBnZXRBY3RvclZhbHVlcyB9IGZyb20gXCIuLi8uLi9zeW5jL2FjdG9ydmFsdWVzXCI7XHJcbmltcG9ydCB7IGdldEVxdWlwbWVudCB9IGZyb20gXCIuLi8uLi9zeW5jL2VxdWlwbWVudFwiO1xyXG5pbXBvcnQgeyBuZXh0SG9zdEF0dGVtcHQgfSBmcm9tIFwiLi4vLi4vdmlldy9ob3N0QXR0ZW1wdHNcIjtcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4vcmVtb3RlU2VydmVyXCI7XHJcbmltcG9ydCB7IERlYXRoU2VydmljZSB9IGZyb20gXCIuL2RlYXRoU2VydmljZVwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBwbGF5ZXJGb3JtSWQgPSAweDE0O1xyXG4vLyBUT0RPOiBzcGxpdCB0aGlzIHNlcnZpY2UgaW50byBFcXVpcG1lbnRTZXJ2aWNlLCBNb3ZlbWVudFNlcnZpY2UsIEFuaW1hdGlvblNlcnZpY2UsIEFjdG9yVmFsdWVTZXJ2aWNlLCBIb3N0QXR0ZW1wdHNTZXJ2aWNlXHJcbnZhciBTZW5kSW5wdXRzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTZW5kSW5wdXRzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNlbmRJbnB1dHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmxhc3RTZW5kTW92ZW1lbnRNb21lbnQgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgX3RoaXMucGxheWVyQW5pbVNvdXJjZSA9IG5ldyBNYXAoKTsgLy8gVE9ETzogbWFrZSBzZXJ2aWNlXHJcbiAgICAgICAgX3RoaXMubGFzdEFuaW1hdGlvblNlbnQgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgX3RoaXMuYWN0b3JWYWx1ZXNOZWVkVXBkYXRlID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuaXNSYWNlU2V4TWVudVNob3duID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuZXF1aXBtZW50Q2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgICAgIF90aGlzLm51bUVxdWlwbWVudENoYW5nZXMgPSAwO1xyXG4gICAgICAgIF90aGlzLnByZXZWYWx1ZXMgPSB7IGhlYWx0aDogMCwgc3RhbWluYTogMCwgbWFnaWNrYTogMCB9O1xyXG4gICAgICAgIF90aGlzLnByZXZBY3RvclZhbHVlc1VwZGF0ZVRpbWUgPSAwO1xyXG4gICAgICAgIF90aGlzLnByZXZDYXN0aW5nRGV0ZWN0ZWRUaW1lID0gMDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJlcXVpcFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25FcXVpcChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInVuZXF1aXBcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uVW5lcXVpcChlKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImxvYWRHYW1lXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uTG9hZEdhbWUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5zaW5nbGVQbGF5ZXJTZXJ2aWNlLmlzU2luZ2xlUGxheWVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VuZElucHV0cygpO1xyXG4gICAgICAgICAgICB2YXIgcGxheWVyID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICB2YXIgaXNQbGF5ZXJDYXN0aW5nID0gcGxheWVyLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzQ2FzdGluZ1JpZ2h0XCIpXHJcbiAgICAgICAgICAgICAgICB8fCBwbGF5ZXIuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNDYXN0aW5nTGVmdFwiKVxyXG4gICAgICAgICAgICAgICAgfHwgcGxheWVyLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzQ2FzdGluZ0R1YWxcIik7XHJcbiAgICAgICAgICAgIGlmIChpc1BsYXllckNhc3RpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJldkNhc3RpbmdEZXRlY3RlZFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5vbkVxdWlwID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgaWYgKCFldmVudC5hY3RvciB8fCAhZXZlbnQuYmFzZU9iaikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChldmVudC5hY3Rvci5nZXRGb3JtSUQoKSAhPT0gcGxheWVyRm9ybUlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHR5cGUgPSBldmVudC5iYXNlT2JqLmdldFR5cGUoKTtcclxuICAgICAgICBpZiAodHlwZSAhPT0gMjcgLyogRm9ybVR5cGUuQm9vayAqLyAmJiB0eXBlICE9PSA0NiAvKiBGb3JtVHlwZS5Qb3Rpb24gKi8gJiYgdHlwZSAhPT0gMzAgLyogRm9ybVR5cGUuSW5ncmVkaWVudCAqLykge1xyXG4gICAgICAgICAgICAvLyBUcmlnZ2VyIFVwZGF0ZUVxdWlwbWVudCBvbmx5IGZvciBlcXVpcHMgdGhhdCBhcmUgbm90IHNwZWxsIHRvbWVzLCBwb3Rpb25zLCBpbmdyZWRpZW50c1xyXG4gICAgICAgICAgICB0aGlzLmVxdWlwbWVudENoYW5nZWQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBTZW5kIE9uRXF1aXAgZm9yIGFueSBlcXVpcHMgaW5jbHVkaW5nIHNwZWxsIHRvbWVzLCBwb3Rpb25zLCBpbmdyZWRpZW50c1xyXG4gICAgICAgIC8vIE90aGVyd2lzZSwgdGhlIHNlcnZlciB3b24ndCB0cmlnZ2VyIHNwZWxsIGxlYXJuLCBwb3Rpb24gZHJpbmssIGluZ3JlZGllbnQgZWF0IGFuZCBQYXB5cnVzIHNjcmlwdHNcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICBtZXNzYWdlOiB7IHQ6IE1zZ1R5cGUuT25FcXVpcCwgYmFzZUlkOiBldmVudC5iYXNlT2JqLmdldEZvcm1JRCgpIH0sXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5vblVuZXF1aXAgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICBpZiAoIWV2ZW50LmFjdG9yIHx8ICFldmVudC5iYXNlT2JqKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV2ZW50LmFjdG9yLmdldEZvcm1JRCgpID09PSBwbGF5ZXJGb3JtSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5lcXVpcG1lbnRDaGFuZ2VkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLm9uTG9hZEdhbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAvLyBDdXJyZW50bHkgb25seSBhcm1vciBpcyBlcXVpcHBlZCBhZnRlciByZWxvZ2dpbmcgKHNlZSByZW1vdGVTZXJ2ZXIudHMpXHJcbiAgICAgICAgLy8gVGhpcyBoYWNrIGZvcmNlcyBzZW5kaW5nIC9lcXVpcG1lbnQgd2l0aG91dCB3ZWFwb25zLyBiYWNrIHRvIHRoZSBzZXJ2ZXJcclxuICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdCgzKS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIChfdGhpcy5lcXVpcG1lbnRDaGFuZ2VkID0gdHJ1ZSk7IH0pO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kSW5wdXRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIGhvc3RlZCA9IHR5cGVvZiB0aGlzLnNwLnN0b3JhZ2VbJ2hvc3RlZCddID09PSB0eXBlb2YgW10gPyB0aGlzLnNwLnN0b3JhZ2VbJ2hvc3RlZCddIDogW107XHJcbiAgICAgICAgdmFyIHRhcmdldHMgPSBbdW5kZWZpbmVkXS5jb25jYXQoaG9zdGVkKTtcclxuICAgICAgICB2YXIgbW9kZWxTb3VyY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoUmVtb3RlU2VydmVyKTtcclxuICAgICAgICB2YXIgd29ybGQgPSBtb2RlbFNvdXJjZS5nZXRXb3JsZE1vZGVsKCk7XHJcbiAgICAgICAgdGFyZ2V0cy5mb3JFYWNoKGZ1bmN0aW9uICh0YXJnZXQpIHtcclxuICAgICAgICAgICAgdmFyIHRhcmdldEZvcm1Nb2RlbCA9IHRhcmdldCA/IF90aGlzLmdldEZvcm0odGFyZ2V0LCB3b3JsZCkgOiBfdGhpcy5nZXRGb3JtKHVuZGVmaW5lZCwgd29ybGQpO1xyXG4gICAgICAgICAgICBfdGhpcy5zZW5kTW92ZW1lbnQodGFyZ2V0LCB0YXJnZXRGb3JtTW9kZWwpO1xyXG4gICAgICAgICAgICBfdGhpcy5zZW5kQW5pbWF0aW9uKHRhcmdldCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNlbmRBcHBlYXJhbmNlKHRhcmdldCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNlbmRFcXVpcG1lbnQodGFyZ2V0KTtcclxuICAgICAgICAgICAgX3RoaXMuc2VuZEFjdG9yVmFsdWVQZXJjZW50YWdlKHRhcmdldCwgdGFyZ2V0Rm9ybU1vZGVsKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNlbmRIb3N0QXR0ZW1wdHMoKTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuc2VuZE1vdmVtZW50ID0gZnVuY3Rpb24gKF9yZWZySWQsIGZvcm0pIHtcclxuICAgICAgICB2YXIgb3duZXIgPSB0aGlzLmdldElucHV0T3duZXIoX3JlZnJJZCk7XHJcbiAgICAgICAgaWYgKCFvd25lcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciByZWZySWRTdHIgPSBcIlwiLmNvbmNhdChfcmVmcklkKTtcclxuICAgICAgICB2YXIgc2VuZE1vdmVtZW50UmF0ZU1zID0gMTMwO1xyXG4gICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHZhciBsYXN0ID0gdGhpcy5sYXN0U2VuZE1vdmVtZW50TW9tZW50LmdldChyZWZySWRTdHIpO1xyXG4gICAgICAgIGlmICghbGFzdCB8fCBub3cgLSBsYXN0ID4gc2VuZE1vdmVtZW50UmF0ZU1zKSB7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5VcGRhdGVNb3ZlbWVudCxcclxuICAgICAgICAgICAgICAgIGRhdGE6IGdldE1vdmVtZW50KG93bmVyLCBmb3JtKSxcclxuICAgICAgICAgICAgICAgIF9yZWZySWQ6IF9yZWZySWRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwidW5yZWxpYWJsZVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RTZW5kTW92ZW1lbnRNb21lbnQuc2V0KHJlZnJJZFN0ciwgbm93KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRBY3RvclZhbHVlUGVyY2VudGFnZSA9IGZ1bmN0aW9uIChfcmVmcklkLCBmb3JtKSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBjYW5TZW5kID0gZm9ybSAmJiAoKF9hID0gZm9ybS5pc0RlYWQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGZhbHNlKSA9PT0gZmFsc2U7XHJcbiAgICAgICAgaWYgKCFjYW5TZW5kKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5nZXRJbnB1dE93bmVyKF9yZWZySWQpO1xyXG4gICAgICAgIGlmICghb3duZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYXYgPSBnZXRBY3RvclZhbHVlcyh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgIHZhciBjdXJyZW50VGltZSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgaWYgKHRoaXMuYWN0b3JWYWx1ZXNOZWVkVXBkYXRlID09PSBmYWxzZSAmJlxyXG4gICAgICAgICAgICB0aGlzLnByZXZWYWx1ZXMuaGVhbHRoID09PSBhdi5oZWFsdGggJiZcclxuICAgICAgICAgICAgdGhpcy5wcmV2VmFsdWVzLnN0YW1pbmEgPT09IGF2LnN0YW1pbmEgJiZcclxuICAgICAgICAgICAgdGhpcy5wcmV2VmFsdWVzLm1hZ2lja2EgPT09IGF2Lm1hZ2lja2EpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY3VycmVudFRpbWUgLSB0aGlzLnByZXZBY3RvclZhbHVlc1VwZGF0ZVRpbWUgPCAyMDAwICYmXHJcbiAgICAgICAgICAgIHRoaXMuYWN0b3JWYWx1ZXNOZWVkVXBkYXRlID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIERlbGF5aW5nIGFjdG9yIHZhbHVlcyB1cGRhdGUgZHVlIHRvIGNhc3RpbmdcclxuICAgICAgICAvLyBUT0RPOiB1c2UgcGFydGlhbCB1cGRhdGVzIGZvciBhY3RvciB2YWx1ZXMgb25jZSBzZXJ2ZXIgZmluYWxseSBzdXBwb3J0cyBpdFxyXG4gICAgICAgIC8vIGkuZS4ga2VlcCBzZW5kaW5nIGhlYWx0aCBhbmQgc3RhbWluYSBkdXJpbmcgY2FzdGluZywgYnV0IGRlbGF5IG1hZ2lja2EgdXBkYXRlXHJcbiAgICAgICAgaWYgKGN1cnJlbnRUaW1lIC0gdGhpcy5wcmV2Q2FzdGluZ0RldGVjdGVkVGltZSA8IDUwMCAmJlxyXG4gICAgICAgICAgICBhdi5oZWFsdGggPiAwIC8vIGRvbid0IGRlbGF5IGRlYXRoIGFjdG9yIHZhbHVlIHVwZGF0ZVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBkZWF0aFNlcnZpY2UgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoRGVhdGhTZXJ2aWNlKTtcclxuICAgICAgICBpZiAoZGVhdGhTZXJ2aWNlLmlzQnVzeSgpKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTm90IHNlbmRpbmcgYWN0b3IgdmFsdWVzLCBkZWF0aCBzZXJ2aWNlIGlzIGJ1c3lcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgIHQ6IE1zZ1R5cGUuQ2hhbmdlVmFsdWVzLFxyXG4gICAgICAgICAgICBkYXRhOiBhdixcclxuICAgICAgICAgICAgX3JlZnJJZDogX3JlZnJJZFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgIHJlbGlhYmlsaXR5OiBcInVucmVsaWFibGVcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuYWN0b3JWYWx1ZXNOZWVkVXBkYXRlID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5wcmV2VmFsdWVzID0gYXY7XHJcbiAgICAgICAgdGhpcy5wcmV2QWN0b3JWYWx1ZXNVcGRhdGVUaW1lID0gY3VycmVudFRpbWU7XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRBbmltYXRpb24gPSBmdW5jdGlvbiAoX3JlZnJJZCkge1xyXG4gICAgICAgIHZhciBvd25lciA9IHRoaXMuZ2V0SW5wdXRPd25lcihfcmVmcklkKTtcclxuICAgICAgICBpZiAoIW93bmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gRXh0ZXJtbHkgaW1wb3J0YW50IHRoYXQgaXQncyBhIGxvY2FsIGlkIHNpbmNlIEFuaW1hdGlvblNvdXJjZSBkZXBlbmRzIG9uIGl0XHJcbiAgICAgICAgdmFyIHJlZnJJZFN0ciA9IG93bmVyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KTtcclxuICAgICAgICB2YXIgYW5pbVNvdXJjZSA9IHRoaXMucGxheWVyQW5pbVNvdXJjZS5nZXQocmVmcklkU3RyKTtcclxuICAgICAgICBpZiAoIWFuaW1Tb3VyY2UpIHtcclxuICAgICAgICAgICAgYW5pbVNvdXJjZSA9IG5ldyBBbmltYXRpb25Tb3VyY2Uob3duZXIpO1xyXG4gICAgICAgICAgICB0aGlzLnBsYXllckFuaW1Tb3VyY2Uuc2V0KHJlZnJJZFN0ciwgYW5pbVNvdXJjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhbmltID0gYW5pbVNvdXJjZS5nZXRBbmltYXRpb24oKTtcclxuICAgICAgICB2YXIgbGFzdEFuaW1hdGlvblNlbnQgPSB0aGlzLmxhc3RBbmltYXRpb25TZW50LmdldChyZWZySWRTdHIpO1xyXG4gICAgICAgIGlmICghbGFzdEFuaW1hdGlvblNlbnQgfHxcclxuICAgICAgICAgICAgYW5pbS5udW1DaGFuZ2VzICE9PSBsYXN0QW5pbWF0aW9uU2VudC5udW1DaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgIC8vIERyaW5rIHBvdGlvbiBhbmltIGZyb20gdGhpcyBtb2QgaHR0cHM6Ly93d3cubmV4dXNtb2RzLmNvbS9za3lyaW1zcGVjaWFsZWRpdGlvbi9tb2RzLzk3NjYwXHJcbiAgICAgICAgICAgIGlmIChhbmltLmFuaW1FdmVudE5hbWUgIT09ICcnICYmICFhbmltLmFuaW1FdmVudE5hbWUuc3RhcnRzV2l0aChcIkRyaW5rUG90aW9uX1wiKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0QW5pbWF0aW9uU2VudC5zZXQocmVmcklkU3RyLCBhbmltKTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQWN0b3JWYWx1ZXNBZnRlckFuaW1hdGlvbihhbmltLmFuaW1FdmVudE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5VcGRhdGVBbmltYXRpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogYW5pbSxcclxuICAgICAgICAgICAgICAgICAgICBfcmVmcklkOiBfcmVmcklkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS5zZW5kQXBwZWFyYW5jZSA9IGZ1bmN0aW9uIChfcmVmcklkKSB7XHJcbiAgICAgICAgaWYgKF9yZWZySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2hvd24gPSB0aGlzLnNwLlVpLmlzTWVudU9wZW4oJ1JhY2VTZXggTWVudScpO1xyXG4gICAgICAgIGlmIChzaG93biAhPSB0aGlzLmlzUmFjZVNleE1lbnVTaG93bikge1xyXG4gICAgICAgICAgICB0aGlzLmlzUmFjZVNleE1lbnVTaG93biA9IHNob3duO1xyXG4gICAgICAgICAgICBpZiAoIXNob3duKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLnByaW50Q29uc29sZSgnRXhpdGVkIGZyb20gcmFjZSBtZW51Jyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXBwZWFyYW5jZSA9IGdldEFwcGVhcmFuY2UodGhpcy5zcC5HYW1lLmdldFBsYXllcigpKTtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IGxvZyBhcHBlYXJhbmNlIGNvbnRlbnRzIHRvIGRlYnVnIGFwcGVhcmFuY2UgaXNzdWVzP1xyXG4gICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5VcGRhdGVBcHBlYXJhbmNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IGFwcGVhcmFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgX3JlZnJJZDogX3JlZnJJZFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVdpdGhSZWZySWRcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRFcXVpcG1lbnQgPSBmdW5jdGlvbiAoX3JlZnJJZCkge1xyXG4gICAgICAgIGlmIChfcmVmcklkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuZXF1aXBtZW50Q2hhbmdlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmVxdWlwbWVudENoYW5nZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgKyt0aGlzLm51bUVxdWlwbWVudENoYW5nZXM7XHJcbiAgICAgICAgICAgIHZhciBlcSA9IGdldEVxdWlwbWVudCh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCksIHRoaXMubnVtRXF1aXBtZW50Q2hhbmdlcyk7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgdDogTXNnVHlwZS5VcGRhdGVFcXVpcG1lbnQsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiBlcSxcclxuICAgICAgICAgICAgICAgIF9yZWZySWQ6IF9yZWZySWRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcInNlbmRNZXNzYWdlV2l0aFJlZnJJZFwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLnNlbmRIb3N0QXR0ZW1wdHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHJlbW90ZUlkID0gbmV4dEhvc3RBdHRlbXB0KCk7XHJcbiAgICAgICAgaWYgKCFyZW1vdGVJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuSG9zdCxcclxuICAgICAgICAgICAgICAgIHJlbW90ZUlkOiByZW1vdGVJZFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZWxpYWJpbGl0eTogXCJ1bnJlbGlhYmxlXCJcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTZW5kSW5wdXRzU2VydmljZS5wcm90b3R5cGUuZ2V0SW5wdXRPd25lciA9IGZ1bmN0aW9uIChfcmVmcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIF9yZWZySWRcclxuICAgICAgICAgICAgPyB0aGlzLnNwLkFjdG9yLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeCh3b3JsZFZpZXdNaXNjLnJlbW90ZUlkVG9Mb2NhbElkKF9yZWZySWQpKSlcclxuICAgICAgICAgICAgOiB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICB9O1xyXG4gICAgU2VuZElucHV0c1NlcnZpY2UucHJvdG90eXBlLmdldEZvcm0gPSBmdW5jdGlvbiAocmVmcklkLCB3b3JsZCkge1xyXG4gICAgICAgIHZhciBmb3JtID0gcmVmcklkXHJcbiAgICAgICAgICAgID8gd29ybGQgPT09IG51bGwgfHwgd29ybGQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHdvcmxkLmZvcm1zLmZpbmQoZnVuY3Rpb24gKGYpIHsgcmV0dXJuIChmID09PSBudWxsIHx8IGYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGYucmVmcklkKSA9PT0gcmVmcklkOyB9KVxyXG4gICAgICAgICAgICA6IHdvcmxkLmZvcm1zW3dvcmxkLnBsYXllckNoYXJhY3RlckZvcm1JZHhdO1xyXG4gICAgICAgIHJldHVybiBmb3JtO1xyXG4gICAgfTtcclxuICAgIFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZS51cGRhdGVBY3RvclZhbHVlc0FmdGVyQW5pbWF0aW9uID0gZnVuY3Rpb24gKGFuaW1OYW1lKSB7XHJcbiAgICAgICAgaWYgKGFuaW1OYW1lID09PSAnSnVtcExhbmQnIHx8XHJcbiAgICAgICAgICAgIGFuaW1OYW1lID09PSAnSnVtcExhbmREaXJlY3Rpb25hbCcgfHxcclxuICAgICAgICAgICAgYW5pbU5hbWUgPT09ICdEZWF0aEFuaW0nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0b3JWYWx1ZXNOZWVkVXBkYXRlID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNlbmRJbnB1dHNTZXJ2aWNlLnByb3RvdHlwZSwgXCJzaW5nbGVQbGF5ZXJTZXJ2aWNlXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTaW5nbGVQbGF5ZXJTZXJ2aWNlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gU2VuZElucHV0c1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU2VuZElucHV0c1NlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbmltcG9ydCB7IHZlcmlmeSB9IGZyb20gJ25vZGU6Y3J5cHRvJztcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tICcuL2NsaWVudExpc3RlbmVyJztcclxuaW1wb3J0IHsgU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSAnLi9zZXR0aW5nc1NlcnZpY2UnO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xyXG52YXIgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UucHJvdG90eXBlLnZlcmlmeVNlcnZlckpzID0gZnVuY3Rpb24gKHNyYykge1xyXG4gICAgICAgIGlmICghc3JjKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdFbXB0eSBzZXJ2ZXIgSlMsIHNraXBwaW5nIHZlcmlmaWNhdGlvbicpO1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IHNyYywgZXJyb3I6IG51bGwgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNldHRpbmdzU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTZXR0aW5nc1NlcnZpY2UpO1xyXG4gICAgICAgIHZhciBnZXRUYXJnZXRQZWVyUmVzdWx0ID0gc2V0dGluZ3NTZXJ2aWNlLmdldFRhcmdldFBlZXIoKTtcclxuICAgICAgICBpZiAoIWdldFRhcmdldFBlZXJSZXN1bHQudGFyZ2V0UGVlckNhY2hlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IG51bGwsIGVycm9yOiAndGFyZ2V0IHBlZXIgbm90IHJlYWR5JyB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcHVibGljS2V5cyA9IGdldFRhcmdldFBlZXJSZXN1bHQudGFyZ2V0UGVlckNhY2hlZC5wdWJsaWNLZXlzO1xyXG4gICAgICAgIGlmICghcHVibGljS2V5cykge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnTm8gcHVibGljIGtleXMgY29uZmlndXJlZCwgc2tpcHBpbmcgc2VydmVyIEpTIHZlcmlmaWNhdGlvbicpO1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IHNyYywgZXJyb3I6IG51bGwgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGxhc3RMaW5lU3RhcnQgPSBzcmMubGFzdEluZGV4T2YoJ1xcbicpICsgMTtcclxuICAgICAgICB2YXIgc2lnUHJlZml4ID0gJy8vIHNreW1wOnNpZzp5Oic7XHJcbiAgICAgICAgaWYgKGxhc3RMaW5lU3RhcnQgPT09IDAgfHwgIXNyYy5zdWJzdHJpbmcobGFzdExpbmVTdGFydCkuc3RhcnRzV2l0aChzaWdQcmVmaXgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNyYzogbnVsbCwgZXJyb3I6ICdubyBzaWduYXR1cmUgZm91bmQnIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBfYSA9IHNyYy5zdWJzdHJpbmcobGFzdExpbmVTdGFydCArIHNpZ1ByZWZpeC5sZW5ndGgpLnNwbGl0KCc6JyksIGtleUlkID0gX2FbMF0sIHNpZyA9IF9hWzFdO1xyXG4gICAgICAgIGlmICghdGhpcy5pc0FscGhhTnVtZXJpYyhrZXlJZCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBudWxsLCBlcnJvcjogJ21hbGZvcm1lZCBrZXkgaWQnIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBrZXkgPSBwdWJsaWNLZXlzW2tleUlkXTtcclxuICAgICAgICBpZiAoIWtleSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzcmM6IG51bGwsIGVycm9yOiAndW5rbm93biBrZXknIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0b1ZlcmlmeSA9IHRoaXMudG9BcnJheUJ1ZmZlclZpZXcoc3JjLnN1YnN0cmluZygwLCBsYXN0TGluZVN0YXJ0IC0gMSksICd1dGY4Jyk7XHJcbiAgICAgICAgaWYgKCF2ZXJpZnkobnVsbCwgdG9WZXJpZnksIGtleSwgdGhpcy50b0FycmF5QnVmZmVyVmlldyhzaWcsICdiYXNlNjQnKSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3JjOiBudWxsLCBlcnJvcjogJ2JhZCBzaWduYXR1cmUnIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VydmVyIEpTIHZlcmlmaWVkIHdpdGgga2V5IFwiLmNvbmNhdChrZXlJZCkpO1xyXG4gICAgICAgIHJldHVybiB7IHNyYzogc3JjLCBlcnJvcjogbnVsbCB9O1xyXG4gICAgfTtcclxuICAgIFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZS5wcm90b3R5cGUuaXNBbHBoYU51bWVyaWMgPSBmdW5jdGlvbiAoc3RyKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGNvZGUgPSBzdHIuY2hhckNvZGVBdChpKTtcclxuICAgICAgICAgICAgaWYgKCEoKDk3IDw9IGNvZGUgJiYgY29kZSA8PSAxMjIpIHx8XHJcbiAgICAgICAgICAgICAgICAoNjUgPD0gY29kZSAmJiBjb2RlIDw9IDkwKSB8fFxyXG4gICAgICAgICAgICAgICAgKDQ4IDw9IGNvZGUgJiYgY29kZSA8PSA1NykpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9O1xyXG4gICAgU2VydmVySnNWZXJpZmljYXRpb25TZXJ2aWNlLnByb3RvdHlwZS50b0FycmF5QnVmZmVyVmlldyA9IGZ1bmN0aW9uIChzdHIsIGVuYykge1xyXG4gICAgICAgIHZhciBidWYgPSBCdWZmZXIuZnJvbShzdHIsIGVuYyk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2UgfTtcclxuIiwidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCAoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHxcclxuICAgICAgICAgICAgKHsgX19wcm90b19fOiBbXSB9IGluc3RhbmNlb2YgQXJyYXkgJiYgZnVuY3Rpb24gKGQsIGIpIHsgZC5fX3Byb3RvX18gPSBiOyB9KSB8fFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYiwgcCkpIGRbcF0gPSBiW3BdOyB9O1xyXG4gICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZCwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYiAhPT0gXCJmdW5jdGlvblwiICYmIGIgIT09IG51bGwpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJDbGFzcyBleHRlbmRzIHZhbHVlIFwiICsgU3RyaW5nKGIpICsgXCIgaXMgbm90IGEgY29uc3RydWN0b3Igb3IgbnVsbFwiKTtcclxuICAgICAgICBleHRlbmRTdGF0aWNzKGQsIGIpO1xyXG4gICAgICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxyXG4gICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcclxuICAgIH07XHJcbn0pKCk7XHJcbnZhciBfX2Fzc2lnbiA9ICh0aGlzICYmIHRoaXMuX19hc3NpZ24pIHx8IGZ1bmN0aW9uICgpIHtcclxuICAgIF9fYXNzaWduID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbih0KSB7XHJcbiAgICAgICAgZm9yICh2YXIgcywgaSA9IDEsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7XHJcbiAgICAgICAgICAgIHMgPSBhcmd1bWVudHNbaV07XHJcbiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gcykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSlcclxuICAgICAgICAgICAgICAgIHRbcF0gPSBzW3BdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gX19hc3NpZ24uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG52YXIgX19nZW5lcmF0b3IgPSAodGhpcyAmJiB0aGlzLl9fZ2VuZXJhdG9yKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgYm9keSkge1xyXG4gICAgdmFyIF8gPSB7IGxhYmVsOiAwLCBzZW50OiBmdW5jdGlvbigpIHsgaWYgKHRbMF0gJiAxKSB0aHJvdyB0WzFdOyByZXR1cm4gdFsxXTsgfSwgdHJ5czogW10sIG9wczogW10gfSwgZiwgeSwgdCwgZztcclxuICAgIHJldHVybiBnID0geyBuZXh0OiB2ZXJiKDApLCBcInRocm93XCI6IHZlcmIoMSksIFwicmV0dXJuXCI6IHZlcmIoMikgfSwgdHlwZW9mIFN5bWJvbCA9PT0gXCJmdW5jdGlvblwiICYmIChnW1N5bWJvbC5pdGVyYXRvcl0gPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXM7IH0pLCBnO1xyXG4gICAgZnVuY3Rpb24gdmVyYihuKSB7IHJldHVybiBmdW5jdGlvbiAodikgeyByZXR1cm4gc3RlcChbbiwgdl0pOyB9OyB9XHJcbiAgICBmdW5jdGlvbiBzdGVwKG9wKSB7XHJcbiAgICAgICAgaWYgKGYpIHRocm93IG5ldyBUeXBlRXJyb3IoXCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBleGVjdXRpbmcuXCIpO1xyXG4gICAgICAgIHdoaWxlIChnICYmIChnID0gMCwgb3BbMF0gJiYgKF8gPSAwKSksIF8pIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChmID0gMSwgeSAmJiAodCA9IG9wWzBdICYgMiA/IHlbXCJyZXR1cm5cIl0gOiBvcFswXSA/IHlbXCJ0aHJvd1wiXSB8fCAoKHQgPSB5W1wicmV0dXJuXCJdKSAmJiB0LmNhbGwoeSksIDApIDogeS5uZXh0KSAmJiAhKHQgPSB0LmNhbGwoeSwgb3BbMV0pKS5kb25lKSByZXR1cm4gdDtcclxuICAgICAgICAgICAgaWYgKHkgPSAwLCB0KSBvcCA9IFtvcFswXSAmIDIsIHQudmFsdWVdO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKG9wWzBdKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDA6IGNhc2UgMTogdCA9IG9wOyBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDogXy5sYWJlbCsrOyByZXR1cm4geyB2YWx1ZTogb3BbMV0sIGRvbmU6IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICBjYXNlIDU6IF8ubGFiZWwrKzsgeSA9IG9wWzFdOyBvcCA9IFswXTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDc6IG9wID0gXy5vcHMucG9wKCk7IF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKHQgPSBfLnRyeXMsIHQgPSB0Lmxlbmd0aCA+IDAgJiYgdFt0Lmxlbmd0aCAtIDFdKSAmJiAob3BbMF0gPT09IDYgfHwgb3BbMF0gPT09IDIpKSB7IF8gPSAwOyBjb250aW51ZTsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcFswXSA9PT0gMyAmJiAoIXQgfHwgKG9wWzFdID4gdFswXSAmJiBvcFsxXSA8IHRbM10pKSkgeyBfLmxhYmVsID0gb3BbMV07IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSA2ICYmIF8ubGFiZWwgPCB0WzFdKSB7IF8ubGFiZWwgPSB0WzFdOyB0ID0gb3A7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHQgJiYgXy5sYWJlbCA8IHRbMl0pIHsgXy5sYWJlbCA9IHRbMl07IF8ub3BzLnB1c2gob3ApOyBicmVhazsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0WzJdKSBfLm9wcy5wb3AoKTtcclxuICAgICAgICAgICAgICAgICAgICBfLnRyeXMucG9wKCk7IGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG9wID0gYm9keS5jYWxsKHRoaXNBcmcsIF8pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgb3AgPSBbNiwgZV07IHkgPSAwOyB9IGZpbmFsbHkgeyBmID0gdCA9IDA7IH1cclxuICAgICAgICBpZiAob3BbMF0gJiA1KSB0aHJvdyBvcFsxXTsgcmV0dXJuIHsgdmFsdWU6IG9wWzBdID8gb3BbMV0gOiB2b2lkIDAsIGRvbmU6IHRydWUgfTtcclxuICAgIH1cclxufTtcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgcHJpbnRDb25zb2xlLCBVdGlsaXR5IH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSBcIi4vYXV0aFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBUaW1lcnNTZXJ2aWNlIH0gZnJvbSBcIi4vdGltZXJzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi8uLi9sb2dnaW5nXCI7XHJcbnZhciBTZXR0aW5nc1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU2V0dGluZ3NTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU2V0dGluZ3NTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnRhcmdldFBlZXJDYWNoZSA9IG51bGw7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5nZXRTZXJ2ZXJNYXN0ZXJLZXkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1hc3RlcktleSA9IHRoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wic2VydmVyLW1hc3Rlci1rZXlcIl07XHJcbiAgICAgICAgaWYgKCFtYXN0ZXJLZXkpIHtcclxuICAgICAgICAgICAgbWFzdGVyS2V5ID0gdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJtYXN0ZXIta2V5XCJdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIW1hc3RlcktleSkge1xyXG4gICAgICAgICAgICBtYXN0ZXJLZXkgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcInNlcnZlci1pcFwiXSArIFwiOlwiICsgdGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJzZXJ2ZXItcG9ydFwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG1hc3RlcktleTtcclxuICAgIH07XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLmdldE1hc3RlclVybCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVVcmwodGhpcy5zcC5zZXR0aW5nc1tcInNreW1wNS1jbGllbnRcIl1bXCJtYXN0ZXJcIl0gfHwgXCJodHRwczovL2dhdGV3YXkuc2t5bXAubmV0XCIpO1xyXG4gICAgfTtcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUubWFrZU1hc3RlckFwaUNsaWVudCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbWFzdGVyQXBpQmFzZVVybCA9IHRoaXMuZ2V0TWFzdGVyVXJsKCk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBIdHRwQ2xpZW50KG1hc3RlckFwaUJhc2VVcmwpO1xyXG4gICAgfTtcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUuZ2V0VGFyZ2V0UGVlciA9IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKHRoaXMudGFyZ2V0UGVlckNhY2hlKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayh0aGlzLnRhcmdldFBlZXJDYWNoZSk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHRhcmdldFBlZXJDYWNoZWQ6IHRoaXMudGFyZ2V0UGVlckNhY2hlIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ2V0VGFyZ2V0UGVlckltcGwoZnVuY3Rpb24gKHRhcmdldFBlZXIpIHtcclxuICAgICAgICAgICAgX3RoaXMudGFyZ2V0UGVlckNhY2hlID0gdGFyZ2V0UGVlcjtcclxuICAgICAgICAgICAgY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKHRhcmdldFBlZXIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiB7IHRhcmdldFBlZXJDYWNoZWQ6IG51bGwgfTtcclxuICAgIH07XHJcbiAgICAvLyBoYXZlIHRvIHVzZSBjYWxsYmFja3MgaGVyZTogcHJvbWlzZXMgZG9uJ3Qgd29yayBpbiB0aGUgbWFpbiBtZW51XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLmdldFRhcmdldFBlZXJJbXBsID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgbWFzdGVyQXBpQ2xpZW50ID0gdGhpcy5tYWtlTWFzdGVyQXBpQ2xpZW50KCk7XHJcbiAgICAgICAgdmFyIG1hc3RlcktleSA9IHRoaXMuZ2V0U2VydmVyTWFzdGVyS2V5KCk7XHJcbiAgICAgICAgdmFyIHNlcnZlckluZm9SZXF1ZXN0VGltZW91dE1zID0gNTAwMDtcclxuICAgICAgICB2YXIgZGVmYXVsdFBlZXIgPSB7XHJcbiAgICAgICAgICAgIGhvc3Q6IHRoaXMuc3Auc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2VydmVyLWlwJ10sXHJcbiAgICAgICAgICAgIHBvcnQ6IHRoaXMuc3Auc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2VydmVyLXBvcnQnXSxcclxuICAgICAgICAgICAgcHVibGljS2V5czogdGhpcy5zcC5zZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzZXJ2ZXItcHVibGljLWtleXMnXSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHZhciByZXNvbHZlZCA9IGZhbHNlO1xyXG4gICAgICAgIHZhciBzdGF0ZXMgPSB7XHJcbiAgICAgICAgICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5zcC5zZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzZXJ2ZXItaW5mby1pZ25vcmUnXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgJ1NraXBwaW5nIHNlcnZlcmluZm8gcmVxdWVzdCBkdWUgdG8gc2VydmVyLWluZm8taWdub3JlIGluIGNvbmZpZycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZXMucmVzb2x2ZShkZWZhdWx0UGVlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihUaW1lcnNTZXJ2aWNlKS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmV0dXJuIHN0YXRlcy5yZWplY3QobmV3IEVycm9yKCdnZXRUYXJnZXRQZWVyOiBzZXJ2ZXJpbmZvIHJlcXVlc3QgdGltZWQgb3V0JykpOyB9LCBzZXJ2ZXJJbmZvUmVxdWVzdFRpbWVvdXRNcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhlYWRlcnMgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IChfYSA9IF90aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoQXV0aFNlcnZpY2UpLnJlYWRBdXRoRGF0YUZyb21EaXNrKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXNzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZXNzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnNbJ1gtU2Vzc2lvbiddID0gc2Vzc2lvbjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbWFzdGVyQXBpQ2xpZW50LmdldChcIi9hcGkvc2VydmVycy9cIi5jb25jYXQobWFzdGVyS2V5LCBcIi9zZXJ2ZXJpbmZvXCIpLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSwgc3RhdGVzLmhhbmRsZVJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVzLnJlamVjdChlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgaGFuZGxlUmVzcG9uc2U6IGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJzdGF0dXMgXCIuY29uY2F0KHJlcy5zdGF0dXMpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVzLnJlc29sdmUoSlNPTi5wYXJzZShyZXMuYm9keSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZXMucmVqZWN0KGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZXNvbHZlOiBmdW5jdGlvbiAodGFyZ2V0UGVlcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc29sdmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUmVzb2x2ZWQgdGFyZ2V0IHBlZXJcIiwgdGFyZ2V0UGVlcik7XHJcbiAgICAgICAgICAgICAgICB2YXIgZW5yaWNoZWRUYXJnZXRQZWVyID0gX19hc3NpZ24oe30sIHRhcmdldFBlZXIpO1xyXG4gICAgICAgICAgICAgICAgZW5yaWNoZWRUYXJnZXRQZWVyLnB1YmxpY0tleXMgPSBfX2Fzc2lnbihfX2Fzc2lnbih7fSwgZGVmYXVsdFBlZXIucHVibGljS2V5cyksIHRhcmdldFBlZXIucHVibGljS2V5cyk7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJFbnJpY2hlZCB0YXJnZXQgcGVlclwiLCBlbnJpY2hlZFRhcmdldFBlZXIpO1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZW5yaWNoZWRUYXJnZXRQZWVyKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVqZWN0OiBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTZXJ2ZXIgaW5mbyByZXF1ZXN0IGZhaWxlZCwgZmFsbGluZyBiYWNrIHRvXCIsIGRlZmF1bHRQZWVyLCBcIjsgZXJyb3I6XCIsIGVycik7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhkZWZhdWx0UGVlcik7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfTtcclxuICAgICAgICBzdGF0ZXMuc3RhcnQoKTtcclxuICAgIH07XHJcbiAgICBTZXR0aW5nc1NlcnZpY2UucHJvdG90eXBlLmdldFNlcnZlck1vZHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbWFzdGVyQXBpQ2xpZW50LCBtYXN0ZXJLZXksIGF0dGVtcHQsIHJlcywgbWFuaWZlc3QsIGVfMTtcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFzdGVyQXBpQ2xpZW50ID0gdGhpcy5tYWtlTWFzdGVyQXBpQ2xpZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hc3RlcktleSA9IHRoaXMuZ2V0U2VydmVyTWFzdGVyS2V5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShtYXN0ZXJLZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhdHRlbXB0ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2EubGFiZWwgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoYXR0ZW1wdCA8IDUpKSByZXR1cm4gWzMgLypicmVhayovLCA3XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2EubGFiZWwgPSAyO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2EudHJ5cy5wdXNoKFsyLCA0LCAsIDZdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiVHJ5aW5nIHRvIGdldCBzZXJ2ZXIgbW9kcywgYXR0ZW1wdCBcIi5jb25jYXQoYXR0ZW1wdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBtYXN0ZXJBcGlDbGllbnQuZ2V0KFwiL2FwaS9zZXJ2ZXJzL1wiLmNvbmNhdChtYXN0ZXJLZXksIFwiL21hbmlmZXN0Lmpzb25cIikpXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9IF9hLnNlbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXMgIT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJzdGF0dXMgY29kZSBcIi5jb25jYXQocmVzLnN0YXR1cywgXCIsIGVycm9yIFwiKS5jb25jYXQocmVzLmVycm9yKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFuaWZlc3QgPSBKU09OLnBhcnNlKHJlcy5ib2R5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hbmlmZXN0LnZlcnNpb25NYWpvciAhPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwic2VydmVyIG1hbmlmZXN0IHZlcnNpb24gaXMgXCIuY29uY2F0KG1hbmlmZXN0LnZlcnNpb25NYWpvciwgXCIsIHdlIGV4cGVjdCAxXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovLCBbXV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi8sIG1hbmlmZXN0Lm1vZHNdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgZV8xID0gX2Euc2VudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJSZXF1ZXN0L3BhcnNlIGVycm9yOiBcIi5jb25jYXQoZV8xKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIFV0aWxpdHkud2FpdCgwLjEgKyBNYXRoLnJhbmRvbSgpKV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA1OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDZdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgKythdHRlbXB0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAxXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDc6IHJldHVybiBbMiAvKnJldHVybiovLCBbXV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFNldHRpbmdzU2VydmljZS5wcm90b3R5cGUuZ2V0U2VydmVyUG9ydCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBSZXR1cm4gdGhlIHNlcnZlciBwb3J0IGZyb20gc2V0dGluZ3NcclxuICAgICAgICByZXR1cm4gdGhpcy5zcC5zZXR0aW5nc1snc2t5bXA1LWNsaWVudCddWydzZXJ2ZXItcG9ydCddIHx8IDc3Nzc7XHJcbiAgICB9O1xyXG4gICAgU2V0dGluZ3NTZXJ2aWNlLnByb3RvdHlwZS5ub3JtYWxpemVVcmwgPSBmdW5jdGlvbiAodXJsKSB7XHJcbiAgICAgICAgaWYgKHVybC5lbmRzV2l0aCgnLycpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1cmwuc2xpY2UoMCwgdXJsLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdXJsO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIHJldHVybiBTZXR0aW5nc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU2V0dGluZ3NTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IE5ldHdvcmtpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vbmV0d29ya2luZ1NlcnZpY2VcIjtcclxudmFyIFNpbmdsZVBsYXllclNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU2luZ2xlUGxheWVyU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNpbmdsZVBsYXllclNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuX2lzU2luZ2xlUGxheWVyID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiZ2FtZUxvYWRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uR2FtZUxvYWQoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTaW5nbGVQbGF5ZXJTZXJ2aWNlLnByb3RvdHlwZSwgXCJpc1NpbmdsZVBsYXllclwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc1NpbmdsZVBsYXllcjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBTaW5nbGVQbGF5ZXJTZXJ2aWNlLnByb3RvdHlwZS5vbkdhbWVMb2FkID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgaWYgKCFldmVudC5pc0NhdXNlZEJ5U2t5cmltUGxhdGZvcm0gJiYgIXRoaXMuX2lzU2luZ2xlUGxheWVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuRGVidWcubWVzc2FnZUJveCgnU2F2ZSBoYXMgYmVlbiBsb2FkZWQgaW4gbXVsdGlwbGF5ZXIsIHN3aXRjaGluZyB0byB0aGUgc2luZ2xlLXBsYXllciBtb2RlJyk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihOZXR3b3JraW5nU2VydmljZSkuY2xvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy5faXNTaW5nbGVQbGF5ZXIgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnNwLkdhbWUuc2V0SW5DaGFyZ2VuKGZhbHNlLCBmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gU2luZ2xlUGxheWVyU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTaW5nbGVQbGF5ZXJTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBwcmludENvbnNvbGUsIHNldHRpbmdzLCBzdG9yYWdlLCB9IGZyb20gJ3NreXJpbVBsYXRmb3JtJztcclxuaW1wb3J0ICogYXMgbmV0d29ya2luZyBmcm9tICcuL25ldHdvcmtpbmdTZXJ2aWNlJztcclxuaW1wb3J0IHsgc2V0dXBIb29rcyB9IGZyb20gJy4uLy4uL3N5bmMvYW5pbWF0aW9uJztcclxuaW1wb3J0IHsgYXV0aEdhbWVEYXRhU3RvcmFnZUtleSB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2F1dGhNb2RlbCc7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSAnLi9jbGllbnRMaXN0ZW5lcic7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSAnLi4vLi4vbG9nZ2luZyc7XHJcbmltcG9ydCB7IFNldHRpbmdzU2VydmljZSB9IGZyb20gJy4vc2V0dGluZ3NTZXJ2aWNlJztcclxucHJpbnRDb25zb2xlKCdIZWxsbyBNdWx0aXBsYXllciEnKTtcclxucHJpbnRDb25zb2xlKCdzZXR0aW5nczonLCBzZXR0aW5nc1snc2t5bXA1LWNsaWVudCddKTtcclxudmFyIFNreW1wQ2xpZW50ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFNreW1wQ2xpZW50LCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU2t5bXBDbGllbnQoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY29ubmVjdGlvbkZhaWxlZFwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Db25uZWN0aW9uRmFpbGVkKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIub24oXCJjb25uZWN0aW9uRGVuaWVkXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkNvbm5lY3Rpb25EZW5pZWQoZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BY3RvckNyZWF0ZU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIC8vIFRPRE86IHJlZmFjdG9yIG91dCB2ZXJ5IHNpbWlsYXIgY29kZSBpbiBmcm9udEhvdFJlbG9hZFNlcnZpY2UudHNcclxuICAgICAgICB2YXIgYXV0aEdhbWVEYXRhID0gc3RvcmFnZVthdXRoR2FtZURhdGFTdG9yYWdlS2V5XTtcclxuICAgICAgICB2YXIgc3RvcmFnZUhhc1ZhbGlkQXV0aEdhbWVEYXRhID0gKGF1dGhHYW1lRGF0YSA9PT0gbnVsbCB8fCBhdXRoR2FtZURhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhHYW1lRGF0YS5sb2NhbCkgfHwgKGF1dGhHYW1lRGF0YSA9PT0gbnVsbCB8fCBhdXRoR2FtZURhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhHYW1lRGF0YS5yZW1vdGUpO1xyXG4gICAgICAgIGlmIChzdG9yYWdlSGFzVmFsaWRBdXRoR2FtZURhdGEpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiUmVjb3ZlcmVkIEF1dGhHYW1lRGF0YSBmcm9tIHN0b3JhZ2UsIHN0YXJ0aW5nIGNsaWVudFwiKTtcclxuICAgICAgICAgICAgX3RoaXMuc3RhcnRDbGllbnQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlVuYWJsZSB0byByZWNvdmVyIEF1dGhHYW1lRGF0YSBmcm9tIHN0b3JhZ2UsIHJlcXVlc3RpbmcgYXV0aFwiKTtcclxuICAgICAgICAgICAgLy8gTmV4dCB0aWNrIGJlY2F1c2Ugd2UncmUgaW4gY29uc3RydWN0b3Igb2YgdGhlIHNlcnZpY2UsIEF1dGhTZXJ2aWNlIG1heSBub3QgYmUgbGlzdGVuaW5nIGV2ZW50cyB5ZXRcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidGlja1wiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmVtaXR0ZXIuZW1pdChcImF1dGhOZWVkZWRcIiwge30pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiYXV0aEF0dGVtcHRcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uQXV0aEF0dGVtcHQoZSk7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUub25BdXRoQXR0ZW1wdCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDYXVnaHQgYXV0aCBldmVudFwiKTtcclxuICAgICAgICBzdG9yYWdlW2F1dGhHYW1lRGF0YVN0b3JhZ2VLZXldID0gZS5hdXRoR2FtZURhdGE7XHJcbiAgICAgICAgdGhpcy5zdGFydENsaWVudCgpO1xyXG4gICAgICAgIC8vIFRPRE86IHJlbW92ZSB0aGlzIHdoZW4geW91IHdpbGwgYmUgYWJsZSB0byBzZWUgZXJyb3JzIHdpdGhvdXQgY29uc29sZVxyXG4gICAgICAgIC8vIHRoaXMuc3AuYnJvd3Nlci5zZXRGb2N1c2VkKGZhbHNlKTtcclxuICAgIH07XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUub25BY3RvckNyZWF0ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmIChlLm1lc3NhZ2UuaXNNZSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLmJyb3dzZXIuc2V0Rm9jdXNlZChmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFNreW1wQ2xpZW50LnByb3RvdHlwZS5vbkNvbm5lY3Rpb25GYWlsZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiQ29ubmVjdGlvbiBmYWlsZWRcIik7XHJcbiAgICB9O1xyXG4gICAgU2t5bXBDbGllbnQucHJvdG90eXBlLm9uQ29ubmVjdGlvbkRlbmllZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgXCJDb25uZWN0aW9uIGRlbmllZDogXCIgKyBlLmVycm9yKTtcclxuICAgIH07XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUuc3RhcnRDbGllbnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAvLyBvbmNlKFwidGlja1wiLCAuLi4pIGlzIG5lZWRlZCB0byBlbnN1cmUgbmV0d29ya2luZyBzZXJ2aWNlIGluaXRpYWxpemVkXHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ0aWNrXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmVzdGFibGlzaENvbm5lY3Rpb25Db25kaXRpb25hbCgpOyB9KTtcclxuICAgICAgICB0aGlzLmN0b3IoKTtcclxuICAgIH07XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUuY3RvciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyBUT0RPOiByZWZhY3RvciBpbnRvIHNlcnZpY2VcclxuICAgICAgICBzZXR1cEhvb2tzKCk7XHJcbiAgICAgICAgdGhpcy5zcC5wcmludENvbnNvbGUoJ1NreW1wQ2xpZW50IGN0b3InKTtcclxuICAgIH07XHJcbiAgICBTa3ltcENsaWVudC5wcm90b3R5cGUuZXN0YWJsaXNoQ29ubmVjdGlvbkNvbmRpdGlvbmFsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIGlzQ29ubmVjdGVkID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKG5ldHdvcmtpbmcuTmV0d29ya2luZ1NlcnZpY2UpLmlzQ29ubmVjdGVkKCk7XHJcbiAgICAgICAgaWYgKGlzQ29ubmVjdGVkKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsICdSZWNvbm5lY3QgaXMgbm90IHJlcXVpcmVkJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFNldHRpbmdzU2VydmljZSkuZ2V0VGFyZ2V0UGVlcihmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgdmFyIGhvc3QgPSBfYS5ob3N0LCBwb3J0ID0gX2EucG9ydDtcclxuICAgICAgICAgICAgc3RvcmFnZS50YXJnZXRJcCA9IGhvc3Q7XHJcbiAgICAgICAgICAgIHN0b3JhZ2UudGFyZ2V0UG9ydCA9IHBvcnQ7XHJcbiAgICAgICAgICAgIHByaW50Q29uc29sZShcIkNvbm5lY3RpbmcgdG8gXCIuY29uY2F0KGhvc3QsIFwiOlwiKS5jb25jYXQocG9ydCkpO1xyXG4gICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKG5ldHdvcmtpbmcuTmV0d29ya2luZ1NlcnZpY2UpLmNvbm5lY3QoaG9zdCwgcG9ydCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFNreW1wQ2xpZW50O1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNreW1wQ2xpZW50IH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbnZhciBfX2dlbmVyYXRvciA9ICh0aGlzICYmIHRoaXMuX19nZW5lcmF0b3IpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBib2R5KSB7XHJcbiAgICB2YXIgXyA9IHsgbGFiZWw6IDAsIHNlbnQ6IGZ1bmN0aW9uKCkgeyBpZiAodFswXSAmIDEpIHRocm93IHRbMV07IHJldHVybiB0WzFdOyB9LCB0cnlzOiBbXSwgb3BzOiBbXSB9LCBmLCB5LCB0LCBnO1xyXG4gICAgcmV0dXJuIGcgPSB7IG5leHQ6IHZlcmIoMCksIFwidGhyb3dcIjogdmVyYigxKSwgXCJyZXR1cm5cIjogdmVyYigyKSB9LCB0eXBlb2YgU3ltYm9sID09PSBcImZ1bmN0aW9uXCIgJiYgKGdbU3ltYm9sLml0ZXJhdG9yXSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpczsgfSksIGc7XHJcbiAgICBmdW5jdGlvbiB2ZXJiKG4pIHsgcmV0dXJuIGZ1bmN0aW9uICh2KSB7IHJldHVybiBzdGVwKFtuLCB2XSk7IH07IH1cclxuICAgIGZ1bmN0aW9uIHN0ZXAob3ApIHtcclxuICAgICAgICBpZiAoZikgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkdlbmVyYXRvciBpcyBhbHJlYWR5IGV4ZWN1dGluZy5cIik7XHJcbiAgICAgICAgd2hpbGUgKGcgJiYgKGcgPSAwLCBvcFswXSAmJiAoXyA9IDApKSwgXykgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKGYgPSAxLCB5ICYmICh0ID0gb3BbMF0gJiAyID8geVtcInJldHVyblwiXSA6IG9wWzBdID8geVtcInRocm93XCJdIHx8ICgodCA9IHlbXCJyZXR1cm5cIl0pICYmIHQuY2FsbCh5KSwgMCkgOiB5Lm5leHQpICYmICEodCA9IHQuY2FsbCh5LCBvcFsxXSkpLmRvbmUpIHJldHVybiB0O1xyXG4gICAgICAgICAgICBpZiAoeSA9IDAsIHQpIG9wID0gW29wWzBdICYgMiwgdC52YWx1ZV07XHJcbiAgICAgICAgICAgIHN3aXRjaCAob3BbMF0pIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgMDogY2FzZSAxOiB0ID0gb3A7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSA0OiBfLmxhYmVsKys7IHJldHVybiB7IHZhbHVlOiBvcFsxXSwgZG9uZTogZmFsc2UgfTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNTogXy5sYWJlbCsrOyB5ID0gb3BbMV07IG9wID0gWzBdOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGNhc2UgNzogb3AgPSBfLm9wcy5wb3AoKTsgXy50cnlzLnBvcCgpOyBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEodCA9IF8udHJ5cywgdCA9IHQubGVuZ3RoID4gMCAmJiB0W3QubGVuZ3RoIC0gMV0pICYmIChvcFswXSA9PT0gNiB8fCBvcFswXSA9PT0gMikpIHsgXyA9IDA7IGNvbnRpbnVlOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wWzBdID09PSAzICYmICghdCB8fCAob3BbMV0gPiB0WzBdICYmIG9wWzFdIDwgdFszXSkpKSB7IF8ubGFiZWwgPSBvcFsxXTsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BbMF0gPT09IDYgJiYgXy5sYWJlbCA8IHRbMV0pIHsgXy5sYWJlbCA9IHRbMV07IHQgPSBvcDsgYnJlYWs7IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodCAmJiBfLmxhYmVsIDwgdFsyXSkgeyBfLmxhYmVsID0gdFsyXTsgXy5vcHMucHVzaChvcCk7IGJyZWFrOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRbMl0pIF8ub3BzLnBvcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIF8udHJ5cy5wb3AoKTsgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgb3AgPSBib2R5LmNhbGwodGhpc0FyZywgXyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkgeyBvcCA9IFs2LCBlXTsgeSA9IDA7IH0gZmluYWxseSB7IGYgPSB0ID0gMDsgfVxyXG4gICAgICAgIGlmIChvcFswXSAmIDUpIHRocm93IG9wWzFdOyByZXR1cm4geyB2YWx1ZTogb3BbMF0gPyBvcFsxXSA6IHZvaWQgMCwgZG9uZTogdHJ1ZSB9O1xyXG4gICAgfVxyXG59O1xyXG5pbXBvcnQgeyBNc2dUeXBlIH0gZnJvbSBcIi4uLy4uL21lc3NhZ2VzXCI7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSBcIi4vY2xpZW50TGlzdGVuZXJcIjtcclxuLy8gVE9ETzogcmVmYWN0b3Igd29ybGRWaWV3TWlzYyBpbnRvIHNlcnZpY2VcclxuaW1wb3J0IHsgcmVtb3RlSWRUb0xvY2FsSWQgfSBmcm9tICcuLi8uLi92aWV3L3dvcmxkVmlld01pc2MnO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBXb3JsZFZpZXcgfSBmcm9tIFwiLi4vLi4vdmlldy93b3JsZFZpZXdcIjtcclxudmFyIFNwU25pcHBldFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3BTbmlwcGV0U2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFNwU25pcHBldFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwic3BTbmlwcGV0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25TcFNuaXBwZXRNZXNzYWdlKGUpOyB9KTtcclxuICAgICAgICBfdGhpcy5zcEFueSA9IHNwO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFNwU25pcHBldFNlcnZpY2UucHJvdG90eXBlLm9uU3BTbmlwcGV0TWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50Lm1lc3NhZ2U7XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoJ3VwZGF0ZScsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF9fYXdhaXRlcihfdGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ydW4obXNnKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaXNOb1Jlc3VsdFNuaXBwZXQgPSBtc2cuc25pcHBldElkeCA9PT0gMHhmZmZmZmZmZjtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNOb1Jlc3VsdFNuaXBwZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyAhPT0gbnVsbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiB0eXBlb2YgcmVzICE9PSBcIm51bWJlclwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHR5cGVvZiByZXMgIT09IFwic3RyaW5nXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgdHlwZW9mIHJlcyAhPT0gXCJib29sZWFuXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IoX3RoaXMsIFwiVW5zdXBwb3J0ZWQgU3BTbmlwcGV0IHJlc3VsdCB0eXBlICdcIi5jb25jYXQodHlwZW9mIHJlcywgXCInXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHJlcyA9PT0gbnVsbCA/IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdDogTXNnVHlwZS5GaW5pc2hTcFNuaXBwZXQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuaXBwZXRJZHg6IG1zZy5zbmlwcGV0SWR4XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ6IE1zZ1R5cGUuRmluaXNoU3BTbmlwcGV0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWU6IHJlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuaXBwZXRJZHg6IG1zZy5zbmlwcGV0SWR4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5lbWl0KFwic2VuZE1lc3NhZ2VcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWxpYWJpbGl0eTogXCJyZWxpYWJsZVwiXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKF90aGlzLCAnU3BTbmlwcGV0ICcgKyBtc2cuY2xhc3MgKyAnICcgKyBtc2cuZnVuY3Rpb24gKyAnIGZhaWxlZCAnICsgZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7IH0pO1xyXG4gICAgfTtcclxuICAgIFNwU25pcHBldFNlcnZpY2UucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIChzbmlwcGV0KSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGZ1bmN0aW9uTG93ZXJDYXNlLCBjbGFzc0xvd2VyQ2FzZSwgbmV3TmFtZSwgc2VsZklkLCBzZWxmLCByZXBsYWNlVmFsdWUsIHdvcmxkVmlld18xLCBmb3JtLCBzaWduLCBjb3VudCwgc291bmRJZCwgc291bmQsIG5hbWUsIG5hbWU7XHJcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2IpIHtcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uTG93ZXJDYXNlID0gc25pcHBldC5mdW5jdGlvbi50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgY2xhc3NMb3dlckNhc2UgPSBzbmlwcGV0LmNsYXNzLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAvLyBrZWVwIGluIHN5bmMgd2l0aCByZW1vdGVTZXJ2ZXIudHNcclxuICAgICAgICAgICAgICAgIGlmIChjbGFzc0xvd2VyQ2FzZSA9PT0gXCJvYmplY3RyZWZlcmVuY2VcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmdW5jdGlvbkxvd2VyQ2FzZSA9PT0gXCJzZXRkaXNwbGF5bmFtZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld05hbWUgPSBzbmlwcGV0LmFyZ3VtZW50c1swXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdOYW1lID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmSWQgPSByZW1vdGVJZFRvTG9jYWxJZChzbmlwcGV0LnNlbGZJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmID0gdGhpcy5zcC5PYmplY3RSZWZlcmVuY2UuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHNlbGZJZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVZhbHVlID0gKF9hID0gc2VsZiA9PT0gbnVsbCB8fCBzZWxmID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZWxmLmdldEJhc2VPYmplY3QoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldE5hbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlVmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld05hbWUgPSBuZXdOYW1lLnJlcGxhY2UoLyVvcmlnaW5hbF9uYW1lJS9nLCByZXBsYWNlVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuaXBwZXQuYXJndW1lbnRzWzBdID0gbmV3TmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiQ291bGRuJ3QgZ2V0IGEgcmVwbGFjZVZhbHVlIGZvciBTZXREaXNwbGF5TmFtZSwgc25pcHBldC5zZWxmSWQgd2FzXCIsIHNuaXBwZXQuc2VsZklkLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkVuY291bnRlcmVkIFNldERpc3BsYXlOYW1lIHdpdGggbm9uLXN0cmluZyBhcmd1bWVudFwiLCBuZXdOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChjbGFzc0xvd2VyQ2FzZSA9PT0gXCJnYW1lXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZnVuY3Rpb25Mb3dlckNhc2UgPT09IFwic2hvd3JhY2VtZW51XCIgfHwgZnVuY3Rpb25Mb3dlckNhc2UgPT09IFwic2hvd2xpbWl0ZWRyYWNlbWVudVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwic2hvd3JhY2VtZW51IGNhbGxlZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29ybGRWaWV3XzEgPSB0aGlzLmNvbnRyb2xsZXIubG9va3VwTGlzdGVuZXIoV29ybGRWaWV3KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29ybGRWaWV3XzEuc2V0Rm9ybVZpZXdVcGRhdGVBbGxvd2VkKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJXYWl0aW5nIDEuMHMgYmVmb3JlIGNhbGxpbmcgc2hvd3JhY2VtZW51XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdCgxLjApLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucnVuU3RhdGljKHNuaXBwZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ybGRWaWV3XzEud2FpdEdhbWVUaW1lQW5kQWxsb3dGb3JtVmlld1VwZGF0ZSgxLjApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChjbGFzc0xvd2VyQ2FzZSA9PT0gXCJza3ltcGhhY2tzXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZnVuY3Rpb25Mb3dlckNhc2UgPT09IFwiYWRkaXRlbVwiIHx8IGZ1bmN0aW9uTG93ZXJDYXNlID09PSBcInJlbW92ZWl0ZW1cIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JtID0gdGhpcy5zcC5Gb3JtLmZyb20odGhpcy5kZXNlcmlhbGl6ZUFyZyhzbmlwcGV0LmFyZ3VtZW50c1swXSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJVbmFibGUgdG8gZmluZCBmb3JtIHdpdGggaWQgXCIgKyBzbmlwcGV0LmFyZ3VtZW50c1swXS5mb3JtSWQudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaWduID0gc25pcHBldC5mdW5jdGlvbiA9PT0gXCJBZGRJdGVtXCIgPyBcIitcIiA6IFwiLVwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudCA9IHNuaXBwZXQuYXJndW1lbnRzWzFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VuZElkID0gMHgzMzRhYjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm0uZ2V0Rm9ybUlEKCkgIT09IDB4Zikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc291bmRJZCA9IDB4MTQxMTU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgc291bmQgPSB0aGlzLnNwLlNvdW5kLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeChzb3VuZElkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3VuZCAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IGZvcm0uZ2V0TmFtZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUudHJpbSgpID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJTb3VuZCB3aWxsIG5vdCBiZSBwbGF5ZWQgYmVjYXVzZSBpdGVtIGhhcyBubyBuYW1lXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291bmQucGxheSh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJVbmFibGUgdG8gZmluZCBzb3VuZCB3aXRoIGlkIFwiICsgc291bmRJZC50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb3VudCA8PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIlBvc2l0aXZlIGNvdW50IGV4cGVjdGVkLCBnb3QgXCIgKyBjb3VudC50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBmb3JtLmdldE5hbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lLnRyaW0oKSA9PT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiTm90aWZpY2F0aW9uIHdpbGwgbm90IGJlIHNob3duIGJlY2F1c2UgaXRlbSBoYXMgbm8gbmFtZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3AuRGVidWcubm90aWZpY2F0aW9uKHNpZ24gKyBcIiBcIiArIG5hbWUgKyBcIiAoXCIgKyBjb3VudCArIFwiKVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIHNpZ24gKyBcIiBcIiArIG5hbWUgKyBcIiAoXCIgKyBjb3VudCArIFwiKVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVua25vd24gU2t5bXBIYWNrIC0gXCIgKyBzbmlwcGV0LmZ1bmN0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qL107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gWzIgLypyZXR1cm4qLywgc25pcHBldC5zZWxmSWQgPyB0aGlzLnJ1bk1ldGhvZChzbmlwcGV0KSA6IHRoaXMucnVuU3RhdGljKHNuaXBwZXQpXTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgU3BTbmlwcGV0U2VydmljZS5wcm90b3R5cGUuZGVzZXJpYWxpemVBcmcgPSBmdW5jdGlvbiAoYXJnKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgdmFyIGZvcm1JZCA9IHJlbW90ZUlkVG9Mb2NhbElkKGFyZy5mb3JtSWQpO1xyXG4gICAgICAgICAgICB2YXIgZm9ybSA9IHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZm9ybUlkKTtcclxuICAgICAgICAgICAgdmFyIGNsID0gdGhpcy5zcEFueVthcmcudHlwZV07XHJcbiAgICAgICAgICAgIGlmICghY2wpIHtcclxuICAgICAgICAgICAgICAgIHZhciBtYXRjaGluZ0tleSA9IE9iamVjdC5rZXlzKHRoaXMuc3BBbnkpLmZpbmQoZnVuY3Rpb24gKGtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXkudG9Mb3dlckNhc2UoKSA9PT0gYXJnLnR5cGUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoaW5nS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2wgPSB0aGlzLnNwQW55W21hdGNoaW5nS2V5XTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWNsKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJkZXNlcmlhbGl6ZUFyZyAtIENsYXNzIFwiLmNvbmNhdChhcmcudHlwZSwgXCIgbm90IGZvdW5kXCIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgZ2FtZU9iamVjdCA9IGNsLmZyb20oZm9ybSk7XHJcbiAgICAgICAgICAgIHJldHVybiBnYW1lT2JqZWN0O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXJnO1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIFNwU25pcHBldFNlcnZpY2UucHJvdG90eXBlLnJ1bk1ldGhvZCA9IGZ1bmN0aW9uIChzbmlwcGV0KSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgc2VsZklkLCBzZWxmLCBjbCwgbWF0Y2hpbmdLZXksIHNlbGZDYXN0ZWQsIGY7XHJcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgICAgIHJldHVybiBfX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGZJZCA9IHJlbW90ZUlkVG9Mb2NhbElkKHNuaXBwZXQuc2VsZklkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZiA9IHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoc2VsZklkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWxmKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5hYmxlIHRvIGZpbmQgZm9ybSB3aXRoIGlkIFwiLmNvbmNhdChzZWxmSWQudG9TdHJpbmcoMTYpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsID0gdGhpcy5zcEFueVtzbmlwcGV0LmNsYXNzXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hpbmdLZXkgPSBPYmplY3Qua2V5cyh0aGlzLnNwQW55KS5maW5kKGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ga2V5LnRvTG93ZXJDYXNlKCkgPT09IHNuaXBwZXQuY2xhc3MudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoaW5nS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2wgPSB0aGlzLnNwQW55W21hdGNoaW5nS2V5XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJydW5NZXRob2QgLSBDbGFzcyBcIi5jb25jYXQoc25pcHBldC5jbGFzcywgXCIgbm90IGZvdW5kLCBmb3VuZFwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZkNhc3RlZCA9IGNsLmZyb20oc2VsZik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2VsZkNhc3RlZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkZvcm0gXCIuY29uY2F0KHNlbGZJZC50b1N0cmluZygxNiksIFwiIGlzIG5vdCBpbnN0YW5jZSBvZiBcIikuY29uY2F0KHNuaXBwZXQuY2xhc3MsIFwiLCBmb3JtIHR5cGUgaXMgXCIpLmNvbmNhdChzZWxmLmdldFR5cGUoKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmID0gc2VsZkNhc3RlZFtzbmlwcGV0LmZ1bmN0aW9uXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgZi5hcHBseShzZWxmQ2FzdGVkLCBzbmlwcGV0LmFyZ3VtZW50cy5tYXAoZnVuY3Rpb24gKGFyZykgeyByZXR1cm4gX3RoaXMuZGVzZXJpYWxpemVBcmcoYXJnKTsgfSkpXTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBbMiAvKnJldHVybiovLCBfYS5zZW50KCldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBTcFNuaXBwZXRTZXJ2aWNlLnByb3RvdHlwZS5ydW5TdGF0aWMgPSBmdW5jdGlvbiAoc25pcHBldCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHBhcHlydXNDbGFzcztcclxuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIF9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFweXJ1c0NsYXNzID0gdGhpcy5zcEFueVtzbmlwcGV0LmNsYXNzXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgcGFweXJ1c0NsYXNzW3NuaXBwZXQuZnVuY3Rpb25dLmFwcGx5KHBhcHlydXNDbGFzcywgc25pcHBldC5hcmd1bWVudHMubWFwKGZ1bmN0aW9uIChhcmcpIHsgcmV0dXJuIF90aGlzLmRlc2VyaWFsaXplQXJnKGFyZyk7IH0pKV07XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gWzIgLypyZXR1cm4qLywgX2Euc2VudCgpXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgcmV0dXJuIFNwU25pcHBldFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3BTbmlwcGV0U2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyByZXF1aXJlZFZlcnNpb24gfSBmcm9tIFwiLi4vLi4vdmVyc2lvblwiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBTcFZlcnNpb25DaGVja1NlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vbmNlVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFNwVmVyc2lvbkNoZWNrU2VydmljZS5wcm90b3R5cGUub25jZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciByZWFsVmVyc2lvbiA9IHRoaXMuc3AuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XHJcbiAgICAgICAgaWYgKCFyZXF1aXJlZFZlcnNpb24uaW5jbHVkZXMocmVhbFZlcnNpb24pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuRGVidWcubWVzc2FnZUJveChcIllvdSBuZWVkIHRvIGhhdmUgb24gb2YgdGhvc2UgU2t5cmltUGxhdGZvcm0gdmVyc2lvbnMgXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KHJlcXVpcmVkVmVyc2lvbiksIFwiIHRvIGpvaW4gdGhpcyBzZXJ2ZXIuIFlvdXIgY3VycmVudCB2ZXJzaW9uIGlzIFwiKS5jb25jYXQocmVhbFZlcnNpb24pKTtcclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXRNZW51TW9kZSgwLjUpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbigndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghX3RoaXMuc3AuVWkuaXNNZW51T3BlbignTWVzc2FnZUJveE1lbnUnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLnF1aXRUb01haW5NZW51KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFNwVmVyc2lvbkNoZWNrU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgTXNnVHlwZSB9IGZyb20gXCIuLi8uLi9tZXNzYWdlc1wiO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBwbGF5ZXJJZCA9IDB4MTQ7XHJcbi8vIGV4IEFuaW1EZWJ1Z1NlcnZpY2UgcGFydFxyXG52YXIgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5jdXJyZW50QW5pbSA9IG51bGw7XHJcbiAgICAgICAgX3RoaXMuc3RvcEFuaW1JblByb2dyZXNzID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuZXhpdEFuaW1OYW1lID0gbnVsbDtcclxuICAgICAgICBfdGhpcy5pbnRlcnJ1cHRBbmltTmFtZSA9IG51bGw7XHJcbiAgICAgICAgX3RoaXMudHJ5SW52b2tlQW5pbUNvdW50ID0gMDtcclxuICAgICAgICBfdGhpcy5sYXN0Tm90aWZpY2F0aW9uTW9tZW50ID0gMDtcclxuICAgICAgICBfdGhpcy50cnlJbnZva2VBbmltQ291bnRNYXggPSAxMDAwMDAwMDAwO1xyXG4gICAgICAgIF90aGlzLmV4aXRBbmltRXZlbnQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgX3RoaXMub3B0aW9uc0NhY2hlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIF90aGlzLm9wdGlvbkNiID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIF90aGlzLnVzZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9IHRydWU7XHJcbiAgICAgICAgdmFyIGhhc1N3ZWV0UGllID0gX3RoaXMuaGFzU3dlZXRQaWUoKTtcclxuICAgICAgICBpZiAoIWhhc1N3ZWV0UGllKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZGlzYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGVuYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF90aGlzLnNldHRpbmdzID0gX3RoaXMuc3Auc2V0dGluZ3NbXCJza3ltcDUtY2xpZW50XCJdW1wiYW5pbURlYnVnXCJdO1xyXG4gICAgICAgIGlmIChoYXNTd2VldFBpZSkge1xyXG4gICAgICAgICAgICB2YXIgc2VsZl8xID0gX3RoaXM7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uIChjdHgpIHsgfSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZl8xLm9uU2VuZEFuaW1hdGlvbkV2ZW50TGVhdmUoY3R4KTtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmXzEub25TZW5kRXhpdEFuaW1hdGlvbkV2ZW50TGVhdmUoY3R4KTsgLy8gVHJhY2tpbmcgdGhlIHN1Y2Nlc3NmdWwgbGF1bmNoIG9mIHRoZSBleGl0IGFuaW1hdGlvblxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSwgcGxheWVySWQsIHBsYXllcklkKTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcImJ1dHRvbkV2ZW50XCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbkJ1dHRvbkV2ZW50KGUpOyB9KTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLm9uKFwiY3VzdG9tUGFja2V0TWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DdXN0b21QYWNrZXRNZXNzYWdlMihlKTsgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5vbkN1c3RvbVBhY2tldE1lc3NhZ2UyID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBjb250ZW50ID0ge307XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29udGVudCA9IEpTT04ucGFyc2UoZS5tZXNzYWdlLmNvbnRlbnRKc29uRHVtcCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkZhaWxlZCB0byBwYXJzZSBjdXN0b20gcGFja2V0IGNvbnRlbnRKc29uRHVtcDpcIiwgZS5tZXNzYWdlLmNvbnRlbnRKc29uRHVtcCwgXCJFcnJvcjpcIiwgZXJyKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb250ZW50W1wiY3VzdG9tUGFja2V0VHlwZVwiXSAhPT0gXCJpbnZva2VBbmltXCIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIGN1c3RvbSBwYWNrZXQgd2l0aCBjdXN0b21QYWNrZXRUeXBlIGludm9rZUFuaW1cIik7XHJcbiAgICAgICAgdmFyIG5hbWUgPSBjb250ZW50W1wiYW5pbUV2ZW50TmFtZVwiXTtcclxuICAgICAgICB2YXIgcmVxdWVzdElkID0gY29udGVudFtcInJlcXVlc3RJZFwiXTtcclxuICAgICAgICB2YXIgd2VhcG9uRHJhd25BbGxvd2VkID0gY29udGVudFtcIndlYXBvbkRyYXduQWxsb3dlZFwiXTtcclxuICAgICAgICB2YXIgZnVybml0dXJlQWxsb3dlZCA9IGNvbnRlbnRbXCJmdXJuaXR1cmVBbGxvd2VkXCJdO1xyXG4gICAgICAgIHZhciBleGl0QW5pbU5hbWUgPSBjb250ZW50W1wiZXhpdEFuaW1OYW1lXCJdO1xyXG4gICAgICAgIHZhciBpbnRlcnJ1cHRBbmltTmFtZSA9IGNvbnRlbnRbXCJpbnRlcnJ1cHRBbmltTmFtZVwiXTtcclxuICAgICAgICB2YXIgdGltZU1zID0gY29udGVudFtcInRpbWVNc1wiXTtcclxuICAgICAgICB2YXIgaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCA9IGNvbnRlbnRbXCJpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkXCJdO1xyXG4gICAgICAgIHZhciBwYXJlbnRBbmltRXZlbnROYW1lID0gY29udGVudFtcInBhcmVudEFuaW1FdmVudE5hbWVcIl07XHJcbiAgICAgICAgdmFyIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9IGNvbnRlbnRbXCJlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXNcIl07XHJcbiAgICAgICAgdmFyIHByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zID0gY29udGVudFtcInByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zXCJdO1xyXG4gICAgICAgIGlmICh0eXBlb2YgbmFtZSAhPT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkV4cGVjdGVkIGFuaW1FdmVudE5hbWUgdG8gYmUgc3RyaW5nXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0eXBlb2YgcmVxdWVzdElkICE9PSBcInN0cmluZ1wiICYmIHR5cGVvZiByZXF1ZXN0SWQgIT09IFwibnVtYmVyXCIgJiYgdHlwZW9mIHJlcXVlc3RJZCAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIkV4cGVjdGVkIHJlcXVlc3RJZCB0byBiZSBzdHJpbmcgb3IgbnVtYmVyIG9yIHVuZGVmaW5lZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlRyeWluZyB0byBpbnZva2UgYW5pbVwiLCBuYW1lLCBcIndpdGggd2VhcG9uRHJhd25BbGxvd2VkPVwiLCB3ZWFwb25EcmF3bkFsbG93ZWQsIFwiLCBmdXJuaXR1cmVBbGxvd2VkPVwiLCBmdXJuaXR1cmVBbGxvd2VkLCBcIiwgZXhpdEFuaW1OYW1lPVwiLCBleGl0QW5pbU5hbWUsIFwiLCBpbnRlcnJ1cHRBbmltTmFtZT1cIiwgaW50ZXJydXB0QW5pbU5hbWUsIFwiLCB0aW1lTXM9XCIsIHRpbWVNcywgXCIsIGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQ9XCIsIGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQsIFwiLCBwYXJlbnRBbmltRXZlbnROYW1lPVwiLCBwYXJlbnRBbmltRXZlbnROYW1lLCBcIiwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zPVwiLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMsIFwiLCBwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcz1cIiwgcHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMpO1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gX3RoaXMudHJ5SW52b2tlQW5pbShuYW1lLCB7IHdlYXBvbkRyYXduQWxsb3dlZDogd2VhcG9uRHJhd25BbGxvd2VkLCBmdXJuaXR1cmVBbGxvd2VkOiBmdXJuaXR1cmVBbGxvd2VkLCBleGl0QW5pbU5hbWU6IGV4aXRBbmltTmFtZSwgaW50ZXJydXB0QW5pbU5hbWU6IGludGVycnVwdEFuaW1OYW1lLCB0aW1lTXM6IHRpbWVNcywgaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZDogaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCwgcGFyZW50QW5pbUV2ZW50TmFtZTogcGFyZW50QW5pbUV2ZW50TmFtZSwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMsIHByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zOiBwcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcyB9KTtcclxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICB0OiBNc2dUeXBlLkN1c3RvbVBhY2tldCxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRKc29uRHVtcDogSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbVBhY2tldFR5cGU6IFwiaW52b2tlQW5pbVJlc3VsdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDogcmVzdWx0LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RJZDogcmVxdWVzdElkLFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5lbWl0dGVyLmVtaXQoXCJzZW5kTWVzc2FnZVwiLCB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgcmVsaWFiaWxpdHk6IFwicmVsaWFibGVcIixcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLm9uU2VuZEFuaW1hdGlvbkV2ZW50TGVhdmUgPSBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgYW5pbUxvd2VyQ2FzZSA9IGN0eC5hbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgaWYgKGFuaW1Mb3dlckNhc2Uuc3RhcnRzV2l0aChcImlkbGVcIikgJiYgIWFuaW1Mb3dlckNhc2Uuc3RhcnRzV2l0aChcImlkbGVmb3JjZWRlZmF1bHRzdGF0ZVwiKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIG9ubHkgZm9yIHBsYXllci5wbGF5aWRsZVxyXG4gICAgICAgICAgICAgICAgaWYgKCFfdGhpcy5zcC5VaS5pc01lbnVPcGVuKFwiQ29uc29sZVwiIC8qIE1lbnUuQ29uc29sZSAqLykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoKF9hID0gX3RoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZ1cm5pdHVyZVJlZmVyZW5jZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiRm9yY2luZyB0aGlyZCBwZXJzb24gYW5kIGRpc2FibGluZyBwbGF5ZXIgY29udHJvbHNcIik7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmZvcmNlVGhpcmRQZXJzb24oKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZGlzYWJsZVBsYXllckNvbnRyb2xzKHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDApO1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuY3VycmVudEFuaW0gPSB7IG5hbWU6IGN0eC5hbmltRXZlbnROYW1lLCBvcHRpb25zOiBudWxsLCBwcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGU6IG51bGwgfTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnN0YXJ0QW50aUV4cGxvaXRQb2xsaW5nKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZS5wcm90b3R5cGUuZXhpdEFuaW0gPSBmdW5jdGlvbiAob3B0aW9ucykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hLCBfYjtcclxuICAgICAgICAvLyBUT0RPKDEpOiBTZWUgYW5vdGhlciBUT0RPKDEpIGluIHRoaXMgZmlsZVxyXG4gICAgICAgIGlmIChvcHRpb25zLnBsYXlFeGl0QW5pbSkge1xyXG4gICAgICAgICAgICB2YXIgdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0gPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW0pIHtcclxuICAgICAgICAgICAgICAgIHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXNlUGxheWVyQ29udHJvbHNEZWxheU1zID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlVzaW5nIGludGVycnVwdCBhbmltIGFzIGV4aXQgYW5pbTogXCIuY29uY2F0KHRoaXMuaW50ZXJydXB0QW5pbU5hbWUsIFwiLiBSZWFzb246IHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltIGlzIHRydWVcIikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICgoX2IgPSAoX2EgPSB0aGlzLmN1cnJlbnRBbmltKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucHJlZmVySW50ZXJydXB0QW5pbVN0YXRlKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IucHJlZmVyKSB7XHJcbiAgICAgICAgICAgICAgICB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVzZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJVc2luZyBpbnRlcnJ1cHQgYW5pbSBhcyBleGl0IGFuaW06IFwiLmNvbmNhdCh0aGlzLmludGVycnVwdEFuaW1OYW1lLCBcIi4gUmVhc29uOiBwcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGUucHJlZmVyIGlzIHRydWVcIikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhbmltRXZlbnRUb1NlbmQgPSB1c2VJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbSA/ICh0aGlzLmludGVycnVwdEFuaW1OYW1lIHx8IFwiSWRsZVN0b3BcIikgOiAodGhpcy5leGl0QW5pbU5hbWUgfHwgXCJJZGxlRm9yY2VEZWZhdWx0U3RhdGVcIik7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKSwgYW5pbUV2ZW50VG9TZW5kKTtcclxuICAgICAgICAgICAgdGhpcy5leGl0QW5pbUV2ZW50ID0gYW5pbUV2ZW50VG9TZW5kO1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnNDYWNoZSA9IG9wdGlvbnM7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VudCBhbmltYXRpb24gZXZlbnQ6XCIsIGFuaW1FdmVudFRvU2VuZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRBbmltID0gbnVsbDtcclxuICAgICAgICAgICAgdmFyIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlTZWNvbmRzID0gKHR5cGVvZiBvcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9PT0gXCJudW1iZXJcIlxyXG4gICAgICAgICAgICAgICAgJiYgb3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgPiAwXHJcbiAgICAgICAgICAgICAgICAmJiBOdW1iZXIuaXNGaW5pdGUob3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMpXHJcbiAgICAgICAgICAgICAgICAmJiB0aGlzLnVzZVBsYXllckNvbnRyb2xzRGVsYXlNcylcclxuICAgICAgICAgICAgICAgID8gb3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgLyAxMDAwXHJcbiAgICAgICAgICAgICAgICA6IDAuNTtcclxuICAgICAgICAgICAgdmFyIHN0b3BBbmltRGVsYXlTZWNvbmRzID0gZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheVNlY29uZHMgKyAwLjU7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcEFuaW1JblByb2dyZXNzID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheVNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5lbmFibGVQbGF5ZXJDb250cm9scyh0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3AuVXRpbGl0eS53YWl0KHN0b3BBbmltRGVsYXlTZWNvbmRzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIF90aGlzLnN0b3BBbmltSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgaWYgKF90aGlzLm9wdGlvbkNiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMub3B0aW9uQ2IoKTtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcHRpb25DYiA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5vblNlbmRFeGl0QW5pbWF0aW9uRXZlbnRMZWF2ZSA9IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmIChjdHguYW5pbWF0aW9uU3VjY2VlZGVkICYmIHRoaXMuZXhpdEFuaW1FdmVudCAmJiB0aGlzLm9wdGlvbnNDYWNoZSAmJiBjdHguYW5pbUV2ZW50TmFtZSA9PT0gdGhpcy5leGl0QW5pbUV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0gPSBudWxsO1xyXG4gICAgICAgICAgICB2YXIgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheVNlY29uZHMgPSAodHlwZW9mIHRoaXMub3B0aW9uc0NhY2hlLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyA9PT0gXCJudW1iZXJcIlxyXG4gICAgICAgICAgICAgICAgJiYgdGhpcy5vcHRpb25zQ2FjaGUuZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zID4gMFxyXG4gICAgICAgICAgICAgICAgJiYgTnVtYmVyLmlzRmluaXRlKHRoaXMub3B0aW9uc0NhY2hlLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcylcclxuICAgICAgICAgICAgICAgICYmIHRoaXMudXNlUGxheWVyQ29udHJvbHNEZWxheU1zKVxyXG4gICAgICAgICAgICAgICAgPyB0aGlzLm9wdGlvbnNDYWNoZS5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgLyAxMDAwXHJcbiAgICAgICAgICAgICAgICA6IDAuNTtcclxuICAgICAgICAgICAgdmFyIHN0b3BBbmltRGVsYXlTZWNvbmRzID0gZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheVNlY29uZHMgKyAwLjU7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcEFuaW1JblByb2dyZXNzID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zQ2FjaGUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRoaXMuZXhpdEFuaW1FdmVudCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdGhpcy51c2VQbGF5ZXJDb250cm9sc0RlbGF5TXMgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdChlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5U2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmVuYWJsZVBsYXllckNvbnRyb2xzKHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoc3RvcEFuaW1EZWxheVNlY29uZHMpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3RvcEFuaW1JblByb2dyZXNzID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9uQ2IpIHtcclxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcHRpb25DYigpO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLm9wdGlvbkNiID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9uc0NhY2hlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB0aGlzLmV4aXRBbmltRXZlbnQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbkNiKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbkNiID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5zdGFydEFudGlFeHBsb2l0UG9sbGluZyA9IGZ1bmN0aW9uIChtb2RlKSB7XHJcbiAgICAgICAgLy8gRml4ZXMgaHR0cHM6Ly9naXRodWIuY29tL3NreXJpbS1tdWx0aXBsYXllci9za3ltcDUtZ2FtZW1vZGUvaXNzdWVzLzI0MFxyXG4gICAgICAgIC8vIFAuUy4gVGhlcmUgaXMgYSB2ZXJ5IHNpbWlsYXIgY29kZSBpbiBza3ltcDUtZ2FtZW1vZGVcclxuICAgICAgICAvLyBTZWUgZGlzYWJsZUNoZWF0cy50cywgc2t5bXA1LWdhbWVtb2RlIGZvciBjb21tZW50c1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKG1vZGUgPT09IHZvaWQgMCkgeyBtb2RlID0gXCJkZWF0aFwiOyB9XHJcbiAgICAgICAgdmFyIF9jYWxsTmF0aXZlID0gdGhpcy5zcC5jYWxsTmF0aXZlO1xyXG4gICAgICAgIHZhciBjYW1lcmFTdGF0ZSA9IC0xO1xyXG4gICAgICAgIHZhciBuZWVkc0V4aXRpbmdBbmltID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgIGlmIChpID49IDEwICogNjApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYW1lcmFTdGF0ZSA9IF9jYWxsTmF0aXZlKFwiR2FtZVwiLCBcImdldENhbWVyYVN0YXRlXCIsIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgIG5lZWRzRXhpdGluZ0FuaW0gPSBfdGhpcy5uZWVkc0V4aXRpbmdBbmltO1xyXG4gICAgICAgICAgICBpZiAoIW5lZWRzRXhpdGluZ0FuaW0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmKEluZmluaXR5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY2FtZXJhU3RhdGUgPT09IDApIHsgLy8gMS1zdCBwZXJzb25cclxuICAgICAgICAgICAgICAgIF9jYWxsTmF0aXZlKFwiR2FtZVwiLCBcImZvcmNlVGhpcmRQZXJzb25cIiwgdW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLmV4aXRBbmltKHsgcGxheUV4aXRBbmltOiB0cnVlLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IHVuZGVmaW5lZCB9KTtcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlID09PSBcImRlYXRoXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAoX2EgPSBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZGFtYWdlQWN0b3JWYWx1ZShcIkhlYWx0aFwiLCAxMDAwMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZihJbmZpbml0eSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGYoaSArIDEpOyB9KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGYoMCk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLm9uQnV0dG9uRXZlbnQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfYSwgX2I7XHJcbiAgICAgICAgLy8gVE9ETzogZGUtaGFyZGNvZGUgY29udHJvbHNcclxuICAgICAgICBpZiAoZS5pc1ByZXNzZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZS5jb2RlID09PSA1NyAvKiBEeFNjYW5Db2RlLlNwYWNlYmFyICovXHJcbiAgICAgICAgICAgIHx8IGUuY29kZSA9PT0gMTcgLyogRHhTY2FuQ29kZS5XICovXHJcbiAgICAgICAgICAgIHx8IGUuY29kZSA9PT0gMzAgLyogRHhTY2FuQ29kZS5BICovXHJcbiAgICAgICAgICAgIHx8IGUuY29kZSA9PT0gMzEgLyogRHhTY2FuQ29kZS5TICovXHJcbiAgICAgICAgICAgIHx8IGUuY29kZSA9PT0gMzIgLyogRHhTY2FuQ29kZS5EICovKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm5lZWRzRXhpdGluZ0FuaW0pIHtcclxuICAgICAgICAgICAgICAgIGlmICgoX2EgPSB0aGlzLmN1cnJlbnRBbmltKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhpdEFuaW0oeyBwbGF5RXhpdEFuaW06IHRydWUsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogdGhpcy5jdXJyZW50QW5pbS5vcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhpdEFuaW0oeyBwbGF5RXhpdEFuaW06IHRydWUsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogdW5kZWZpbmVkIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5uZWVkc0V4aXRpbmdBbmltKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaW50ZXJ2YWxNcyA9IChfYiA9IHRoaXMuc2V0dGluZ3MpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5leGl0QW5pbU5vdGlmaWNhdGlvbkludGVydmFsTXM7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWludGVydmFsTXMgfHwgKERhdGUubm93KCkgLSB0aGlzLmxhc3ROb3RpZmljYXRpb25Nb21lbnQpID49IGludGVydmFsTXMpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3ROb3RpZmljYXRpb25Nb21lbnQgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3AuRGVidWcubm90aWZpY2F0aW9uKFwi0J/RgNC+0LHQtdC7LCDRh9GC0L7QsdGLINCy0YvQudGC0Lgg0LjQtyDQsNC90LjQvNCw0YbQuNC4XCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghZS5pc1VwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLnNldHRpbmdzIHx8ICF0aGlzLnNldHRpbmdzLmFuaW1LZXlzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFuaW1FdmVudCA9IHRoaXMuc2V0dGluZ3MuYW5pbUtleXNbZS5jb2RlXTtcclxuICAgICAgICBpZiAoIWFuaW1FdmVudCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU3RhcnRpbmcgYW5pbXMgZnJvbSBrZXlib2FyZCBpcyBkaXNhYmxlZCBpbiB0aGlzIHZlcnNpb25cIik7XHJcbiAgICAgICAgLy8gdGhpcy50cnlJbnZva2VBbmltKGFuaW1FdmVudCwge1xyXG4gICAgICAgIC8vICAgICB3ZWFwb25EcmF3bkFsbG93ZWQ6IGZhbHNlLFxyXG4gICAgICAgIC8vICAgICBmdXJuaXR1cmVBbGxvd2VkOiBmYWxzZSxcclxuICAgICAgICAvLyAgICAgZXhpdEFuaW1OYW1lOiBudWxsLFxyXG4gICAgICAgIC8vICAgICBpbnRlcnJ1cHRBbmltTmFtZTogbnVsbCxcclxuICAgICAgICAvLyAgICAgdGltZU1zOiAwLFxyXG4gICAgICAgIC8vICAgICBpc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkOiB0cnVlLFxyXG4gICAgICAgIC8vICAgICBwYXJlbnRBbmltRXZlbnROYW1lOiBudWxsLFxyXG4gICAgICAgIC8vICAgICBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IG51bGwsXHJcbiAgICAgICAgLy8gICAgIHByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zOiBudWxsLFxyXG4gICAgICAgIC8vIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS50cnlJbnZva2VBbmltID0gZnVuY3Rpb24gKGFuaW1FdmVudCwgb3B0aW9ucykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy50cnlJbnZva2VBbmltQ291bnQrKztcclxuICAgICAgICBpZiAodGhpcy50cnlJbnZva2VBbmltQ291bnQgPj0gdGhpcy50cnlJbnZva2VBbmltQ291bnRNYXgpIHtcclxuICAgICAgICAgICAgdGhpcy50cnlJbnZva2VBbmltQ291bnQgPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgY3VycmVudEludm9rZUFuaW1Db3VudCA9IHRoaXMudHJ5SW52b2tlQW5pbUNvdW50O1xyXG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5leGl0QW5pbU5hbWUgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgdGhpcy5leGl0QW5pbU5hbWUgPSBvcHRpb25zLmV4aXRBbmltTmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXhpdEFuaW1OYW1lID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmludGVycnVwdEFuaW1OYW1lID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW50ZXJydXB0QW5pbU5hbWUgPSBvcHRpb25zLmludGVycnVwdEFuaW1OYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5pbnRlcnJ1cHRBbmltTmFtZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy50aW1lTXMgPT09IFwibnVtYmVyXCIgJiYgb3B0aW9ucy50aW1lTXMgPiAwICYmIE51bWJlci5pc0Zpbml0ZShvcHRpb25zLnRpbWVNcykpIHtcclxuICAgICAgICAgICAgdmFyIHRpbWVTZWNvbmRzID0gb3B0aW9ucy50aW1lTXMgLyAxMDAwO1xyXG4gICAgICAgICAgICAvLyBVc2luZyBVdGlsaXR5LndhaXQgbWFrZXMgc2Vuc2UgYmVjYXVzZSBpdCB3YWl0cyBnYW1lIHRpbWUsIG5vdCBzaW1wbHkgcmVhbCB0aW1lLlxyXG4gICAgICAgICAgICB0aGlzLnNwLlV0aWxpdHkud2FpdCh0aW1lU2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMudHJ5SW52b2tlQW5pbUNvdW50ICE9PSBjdXJyZW50SW52b2tlQW5pbUNvdW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCFfdGhpcy5uZWVkc0V4aXRpbmdBbmltKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIGlzUGxheUV4aXRBbmltQWZ0ZXJ3YXJkc0VuYWJsZWQgPSB0eXBlb2Ygb3B0aW9ucy5pc1BsYXlFeGl0QW5pbUFmdGVyd2FyZHNFbmFibGVkID09PSBcImJvb2xlYW5cIiA/IG9wdGlvbnMuaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCA6IHRydWU7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5leGl0QW5pbSh7IHBsYXlFeGl0QW5pbTogaXNQbGF5RXhpdEFuaW1BZnRlcndhcmRzRW5hYmxlZCwgZW5hYmxlUGxheWVyQ29udHJvbHNEZWxheU1zOiBvcHRpb25zLmVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgaWYgKCFwbGF5ZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJwbGF5ZXJfbm90X2ZvdW5kXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBsYXllci5pc1dlYXBvbkRyYXduKCkgJiYgIW9wdGlvbnMud2VhcG9uRHJhd25BbGxvd2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwid2VhcG9uX2RyYXduXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBsYXllci5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJiSW5KdW1wU3RhdGVcIikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJqdW1wX3N0YXRlXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc3AuVWkuaXNNZW51T3BlbihcIkZhdm9yaXRlc01lbnVcIiAvKiBNZW51LkZhdm9yaXRlcyAqLykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJmYXZvcml0ZXNfbWVudV9vcGVuXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc3AuVWkuaXNNZW51T3BlbihcIkNvbnNvbGVcIiAvKiBNZW51LkNvbnNvbGUgKi8pKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IFwiY29uc29sZV9tZW51X29wZW5cIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zdG9wQW5pbUluUHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJidXN5X3N0b3BwaW5nX2FuaW1cIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGxheWVyLmdldEZ1cm5pdHVyZVJlZmVyZW5jZSgpICYmICFvcHRpb25zLmZ1cm5pdHVyZUFsbG93ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJwbGF5ZXJfaW5fZnVybml0dXJlXCIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBsYXllci5pc1NuZWFraW5nKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogXCJwbGF5ZXJfc25lYWtpbmdcIiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGxheWVyLmlzU3dpbW1pbmcoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBcInBsYXllcl9zd2ltbWluZ1wiIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhbmltRXZlbnQudG9Mb3dlckNhc2UoKSA9PT0gXCJpZGxlZm9yY2VkZWZhdWx0c3RhdGVcIikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5uZWVkc0V4aXRpbmdBbmltKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV4aXRBbmltKHsgcGxheUV4aXRBbmltOiB0cnVlLCBlbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXM6IHVuZGVmaW5lZCB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdmFyIGRvSW52b2tlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuc3AuR2FtZS5mb3JjZVRoaXJkUGVyc29uKCk7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmRpc2FibGVQbGF5ZXJDb250cm9scyh0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwKTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnNwLkRlYnVnLnNlbmRBbmltYXRpb25FdmVudChfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpLCBhbmltRXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHByZWZlckludGVycnVwdEFuaW1TdGF0ZSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMucHJlZmVySW50ZXJydXB0QW5pbUFzRXhpdEFuaW1UaW1lTXMgPT09IFwibnVtYmVyXCJcclxuICAgICAgICAgICAgICAgICAgICAmJiBvcHRpb25zLnByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zID4gMFxyXG4gICAgICAgICAgICAgICAgICAgICYmIE51bWJlci5pc0Zpbml0ZShvcHRpb25zLnByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZV8xID0geyBwcmVmZXI6IHRydWUgfTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJQcmVmZXIgaW50ZXJydXB0IGFuaW0gYXMgZXhpdCBhbmltIGZvciBcIi5jb25jYXQob3B0aW9ucy5wcmVmZXJJbnRlcnJ1cHRBbmltQXNFeGl0QW5pbVRpbWVNcywgXCIgbXNcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNwLlV0aWxpdHkud2FpdChvcHRpb25zLnByZWZlckludGVycnVwdEFuaW1Bc0V4aXRBbmltVGltZU1zIC8gMTAwMCkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlXzEucHJlZmVyID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlByZWZlciBpbnRlcnJ1cHQgYW5pbSBhcyBleGl0IGFuaW0gc3RhdGUgY2hhbmdlZCB0byBmYWxzZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBwcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGUgPSBzdGF0ZV8xO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgX3RoaXMuY3VycmVudEFuaW0gPSB7IG5hbWU6IGFuaW1FdmVudCwgb3B0aW9uczogb3B0aW9ucywgcHJlZmVySW50ZXJydXB0QW5pbVN0YXRlOiBwcmVmZXJJbnRlcnJ1cHRBbmltU3RhdGUgfTtcclxuICAgICAgICAgICAgICAgIF90aGlzLnN0YXJ0QW50aUV4cGxvaXRQb2xsaW5nKFwibm9fZGVhdGhcIik7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5wYXJlbnRBbmltRXZlbnROYW1lID09PSBcInN0cmluZ1wiICYmIHRoaXMuY3VycmVudEFuaW1OYW1lID09PSBvcHRpb25zLnBhcmVudEFuaW1FdmVudE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGRvSW52b2tlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zLnBhcmVudEFuaW1FdmVudE5hbWUpICYmIG9wdGlvbnMucGFyZW50QW5pbUV2ZW50TmFtZS5pbmNsdWRlcyh0aGlzLmN1cnJlbnRBbmltTmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIGRvSW52b2tlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5uZWVkc0V4aXRpbmdBbmltKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPICgxKTogY29uc2lkZXIgbm90IHVzaW5nIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNcyBoZXJlLCBiZWNhdXNlIHVzZUludGVycnVwdEFuaW1Bc0V4aXRBbmltIGRvZXNuJ3QgbmVlZCBpdFxyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25DYiA9IGRvSW52b2tlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leGl0QW5pbSh7IHBsYXlFeGl0QW5pbTogdHJ1ZSwgdXNlSW50ZXJydXB0QW5pbUFzRXhpdEFuaW06IHRydWUsIGVuYWJsZVBsYXllckNvbnRyb2xzRGVsYXlNczogb3B0aW9ucy5lbmFibGVQbGF5ZXJDb250cm9sc0RlbGF5TXMgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkb0ludm9rZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiU2VudCBhbmltYXRpb24gZXZlbnQ6IFwiLmNvbmNhdChhbmltRXZlbnQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gICAgfTtcclxuICAgIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZS5oYXNTd2VldFBpZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbW9kQ291bnQgPSB0aGlzLnNwLkdhbWUuZ2V0TW9kQ291bnQoKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZENvdW50OyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3AuR2FtZS5nZXRNb2ROYW1lKGkpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3N3ZWV0cGllJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UucHJvdG90eXBlLCBcIm5lZWRzRXhpdGluZ0FuaW1cIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50QW5pbU5hbWUgIT09IG51bGw7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlLnByb3RvdHlwZSwgXCJjdXJyZW50QW5pbU5hbWVcIiwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50QW5pbSA/IHRoaXMuY3VycmVudEFuaW0ubmFtZSA6IG51bGw7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcclxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0Q2FtZXJhRW5mb3JjZW1lbnRTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMucmVxdWVzdEFkZFBlcmtzVG9BY3RvcnMgPSBmdW5jdGlvbiAoYWN0b3JJZHMsIHBlcmtJZHMpIHtcclxuICAgICAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhY3RvcnMgPSBhY3Rvcklkcy5tYXAoZnVuY3Rpb24gKGFjdG9ySWQpIHsgcmV0dXJuIF90aGlzLnNwLkFjdG9yLmZyb20oX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgoYWN0b3JJZCkpOyB9KS5maWx0ZXIoZnVuY3Rpb24gKGFjdG9yKSB7IHJldHVybiBhY3RvciAhPT0gbnVsbDsgfSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGVya3MgPSBwZXJrSWRzLm1hcChmdW5jdGlvbiAocGVya0lkKSB7IHJldHVybiBfdGhpcy5zcC5QZXJrLmZyb20oX3RoaXMuc3AuR2FtZS5nZXRGb3JtRXgocGVya0lkKSk7IH0pLmZpbHRlcihmdW5jdGlvbiAocGVyaykgeyByZXR1cm4gcGVyayAhPT0gbnVsbDsgfSk7XHJcbiAgICAgICAgICAgICAgICBhY3RvcnMuZm9yRWFjaChmdW5jdGlvbiAoYWN0b3IpIHsgcmV0dXJuIHBlcmtzLmZvckVhY2goZnVuY3Rpb24gKHBlcmspIHsgcmV0dXJuIGFjdG9yID09PSBudWxsIHx8IGFjdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3Rvci5hZGRQZXJrKHBlcmspOyB9KTsgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKCFfdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZGlzYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGVuYWJsZWRcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnRyb2xsZXIub24oJ2NvbnRhaW5lckNoYW5nZWQnLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25Db250YWluZXJDaGFuZ2VkKGUpOyB9KTtcclxuICAgICAgICBjb250cm9sbGVyLmVtaXR0ZXIub24oXCJzZXRJbnZlbnRvcnlNZXNzYWdlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vblNldEludmVudG9yeU1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIGNvbnRyb2xsZXIuZW1pdHRlci5vbihcImNyZWF0ZUFjdG9yTWVzc2FnZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25DcmVhdGVBY3Rvck1lc3NhZ2UoZSk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5vbkNvbnRhaW5lckNoYW5nZWQgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGUub2xkQ29udGFpbmVyICYmIGUubmV3Q29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIGlmIChlLm5ld0NvbnRhaW5lci5nZXRGb3JtSUQoKSA9PT0gMHgxNCAmJiBlLm51bUl0ZW1zID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVQbGF5ZXJJbnZlbnRvcnlDaGFuZ2VkKHtcclxuICAgICAgICAgICAgICAgICAgICBiYXNlSWQ6IGUuYmFzZU9iai5nZXRGb3JtSUQoKSxcclxuICAgICAgICAgICAgICAgICAgICBjb3VudDogZS5udW1JdGVtcyxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5vblNldEludmVudG9yeU1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgZW50cmllcyA9IGUubWVzc2FnZS5pbnZlbnRvcnkuZW50cmllcztcclxuICAgICAgICBpZiAoZW50cmllcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UodGhpcywgXCJSZWNlaXZlZCBTZXRJbnZlbnRvcnlNZXNzYWdlIHdpdGggZW1wdHkgaW52ZW50b3J5XCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZW50cmllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkgeyByZXR1cm4gX3RoaXMuaGFuZGxlUGxheWVySW52ZW50b3J5Q2hhbmdlZChlbnRyeSk7IH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5vbkNyZWF0ZUFjdG9yTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgX2EsIF9iO1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFlLm1lc3NhZ2UuaXNNZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBlbnRyaWVzID0gKF9iID0gKF9hID0gZS5tZXNzYWdlLnByb3BzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuaW52ZW50b3J5KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZW50cmllcztcclxuICAgICAgICBpZiAoZW50cmllcyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKHRoaXMsIFwiUmVjZWl2ZWQgQ3JlYXRlQWN0b3JNZXNzYWdlIHdpdGhvdXQgaW52ZW50b3J5XCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIlJlY2VpdmVkIENyZWF0ZUFjdG9yTWVzc2FnZSB3aXRoIGVtcHR5IGludmVudG9yeVwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub25jZShcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGVudHJpZXMuZm9yRWFjaChmdW5jdGlvbiAoZW50cnkpIHsgcmV0dXJuIF90aGlzLmhhbmRsZVBsYXllckludmVudG9yeUNoYW5nZWQoZW50cnkpOyB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUuaGFuZGxlUGxheWVySW52ZW50b3J5Q2hhbmdlZCA9IGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KGVudHJ5LmJhc2VJZCk7XHJcbiAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGVudHJ5LmNvdW50IDw9IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcGVya0lkcyA9IHRoaXMuZ2V0UGVya0lkc0J5S2V5d29yZChpdGVtKTtcclxuICAgICAgICBpZiAocGVya0lkcykge1xyXG4gICAgICAgICAgICB2YXIgcGxheWVySWQgPSAweDE0O1xyXG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RBZGRQZXJrc1RvQWN0b3JzKFtwbGF5ZXJJZF0sIHBlcmtJZHMpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUuZ2V0UGVya0lkc0J5S2V5d29yZCA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgdGhpcy5nZXRLZXl3b3JkUGVya01hcCgpLmZvckVhY2goZnVuY3Rpb24gKHYsIGspIHtcclxuICAgICAgICAgICAgdmFyIGtleVdvcmQgPSBfdGhpcy5zcC5LZXl3b3JkLmdldEtleXdvcmQoayk7XHJcbiAgICAgICAgICAgIGlmIChpdGVtLmhhc0tleXdvcmQoa2V5V29yZCkpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHYpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPiAwID8gcmVzdWx0IDogbnVsbDtcclxuICAgIH07XHJcbiAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gY29uZmlnXHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUuZ2V0S2V5d29yZFBlcmtNYXAgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBNYXAoW1xyXG4gICAgICAgICAgICAvLyDQodGC0YDQtdC70LXRhlxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCb3cxXCIsIDB4MTAzNkYwXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQm93MlwiLCAweDU4RjYxXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQm93M1wiLCAweDEwNUYxOV0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0JvdzRcIiwgMHg1OEY2M10sXHJcbiAgICAgICAgICAgIC8vINCj0LHQuNC50YbQsFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtTbmVhazFcIiwgMHg1ODIxMF0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya1NuZWFrMlwiLCAweDEwNUYyM10sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya1NuZWFrM1wiLCAweDU4MjA4XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrU25lYWs0XCIsIDB4NTgyMTFdLFxyXG4gICAgICAgICAgICAvLyDQn9C10YXQvtGC0LjQvdC10YZcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQXJtb3JMaWdodDFcIiwgMHgxMDVGMjJdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtBcm1vckxpZ2h0MlwiLCAweDUxQjFDXSxcclxuICAgICAgICAgICAgLy8g0JfQsNGH0LDRgNC+0LLQsNGC0LXQu9GMXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0VuY2hhbnQyXCIsIDB4MTA4QTQ0XSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrRW5jaGFudDFcIiwgMHg1OEY3Q10sXHJcbiAgICAgICAgICAgIC8vINCb0LDRgtC90LjQulxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtBcm1vckhlYXZ5MVwiLCAweEJDRDJCXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQXJtb3JIZWF2eTJcIiwgMHg1OEY2RF0sXHJcbiAgICAgICAgICAgIC8vINCp0LjRgtC+0L3QvtGB0LXRhlxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmtCbG9jazFcIiwgMHg1OEY2N10sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0Jsb2NrMlwiLCAweDEwNjI1M10sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVya0Jsb2NrM1wiLCAweDU4RjZBXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrQmxvY2s0XCIsIDB4NThGNjldLFxyXG4gICAgICAgICAgICAvLyDQnNC10YfQvdC40LosINC60LvQuNC90L7Quiwg0YDRg9Cx0LDQutCwLCDQutGA0YPRiNC40YLQtdC70YwsINC80L7QvdCw0YUsINC60L7Qv9C10LnRidC40LosINGB0YLRgNCw0LbQvdC40LogKNC00LLRg9GA0YPRh9C90L7QtSDQvtGA0YPQttC40LUpXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazFIYW5kMkhhbmQxXCIsIDB4NThGNkZdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsySGFuZDJcIiwgMHhDQjQwN10sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazJIYW5kM1wiLCAweDk2NTkwXSxcclxuICAgICAgICAgICAgW1wiU3dlZXRQZXJrMkhhbmQ0XCIsIDB4NTJENTFdLFxyXG4gICAgICAgICAgICAvLyDQkNGB0YHQsNGB0LjQvSwg0YDQsNC30LLQtdC00YfQuNC6LCDRiNC/0LjQvtC9LCDQv9GA0LXQtNGI0LXRgdGC0LLQtdC90L3QuNC6LCDRgNGL0YbQsNGA0YwsINGA0LDQt9Cx0L7QudC90LjQuiwg0LHQtdGA0YHQtdGA0LosINCz0YDQvtC80LjQu9CwICjQvtC00L3QvtGA0YPRh9C90L7QtSDQvtGA0YPQttC40LUpXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazFIYW5kMkhhbmQxXCIsIDB4NThGNkZdLFxyXG4gICAgICAgICAgICBbXCJTd2VldFBlcmsxSGFuZDJcIiwgMHhDQjQwNl0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazFIYW5kM1wiLCAweDEwNjI1Nl0sXHJcbiAgICAgICAgICAgIFtcIlN3ZWV0UGVyazFIYW5kNFwiLCAweDUyRDUwXSxcclxuICAgICAgICBdKTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5RHluYW1pY1BlcmtzU2VydmljZS5wcm90b3R5cGUuaGFzU3dlZXRQaWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1vZENvdW50ID0gdGhpcy5zcC5HYW1lLmdldE1vZENvdW50KCk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLkdhbWUuZ2V0TW9kTmFtZShpKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdzd2VldHBpZScpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGNvbnRyb2xsZXIuZW1pdHRlci5vbihcIm5pY2tuYW1lQ3JlYXRlXCIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBfdGhpcy5vbk5pY2tuYW1lQ3JlYXRlKGUpOyB9KTtcclxuICAgICAgICBjb250cm9sbGVyLmVtaXR0ZXIub24oXCJuaWNrbmFtZURlc3Ryb3lcIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTmlja25hbWVEZXN0cm95KGUpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZS5wcm90b3R5cGUub25OaWNrbmFtZUNyZWF0ZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBzdG9yYWdlTmlja25hbWUgPSB0eXBlb2YgdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl0gPT09ICdvYmplY3QnXHJcbiAgICAgICAgICAgID8gdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl1cclxuICAgICAgICAgICAgOiBudWxsO1xyXG4gICAgICAgIGlmIChzdG9yYWdlTmlja25hbWUgPT09IG51bGwgJiYgZS5yZW1vdGVSZWZySWQpIHtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl0gPSAoX2EgPSB7fSwgX2FbZS5yZW1vdGVSZWZySWRdID0gZS50ZXh0SWQsIF9hKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoc3RvcmFnZU5pY2tuYW1lICE9PSBudWxsICYmIGUucmVtb3RlUmVmcklkKSB7XHJcbiAgICAgICAgICAgIHN0b3JhZ2VOaWNrbmFtZVtlLnJlbW90ZVJlZnJJZF0gPSBlLnRleHRJZDtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl0gPSBzdG9yYWdlTmlja25hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlLnByb3RvdHlwZS5vbk5pY2tuYW1lRGVzdHJveSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIHN0b3JhZ2VOaWNrbmFtZSA9IHR5cGVvZiB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXSA9PT0gJ29iamVjdCdcclxuICAgICAgICAgICAgPyB0aGlzLnNwLnN0b3JhZ2VbXCJpZFRleHROaWNrbmFtZVwiXVxyXG4gICAgICAgICAgICA6IG51bGw7XHJcbiAgICAgICAgaWYgKHN0b3JhZ2VOaWNrbmFtZSAhPT0gbnVsbCAmJiBlLnJlbW90ZVJlZnJJZCkge1xyXG4gICAgICAgICAgICBkZWxldGUgc3RvcmFnZU5pY2tuYW1lW2UucmVtb3RlUmVmcklkXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW1wiaWRUZXh0Tmlja25hbWVcIl0gPSBzdG9yYWdlTmlja25hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZSB9O1xyXG47XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbi8vIFRPRE86IG1vdmUgdG8gc2VydmljZVxyXG52YXIgcGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA9IDA7XHJcbnZhciBwbGF5ZXJMYXN0SXNTcHJpbnRpbmdWYWx1ZSA9IGZhbHNlO1xyXG52YXIgYmxvY2tQbGF5ZXJDb250cm9sVGltZVN0YW1wID0gMDtcclxudmFyIGlzUGxheWVyQ29udHJvbERpc2FibGVkID0gdHJ1ZTtcclxudmFyIHBsYXllckF0dGFja1RpbWVvdXQgPSAwO1xyXG52YXIgYWN0aXZlVGltZXJzID0gbmV3IFNldCgpO1xyXG4vLyBUT0RPOiBtb3ZlIHRvIGNvbmZpZ1xyXG52YXIgc3RhbWluYUF0dGFja01hcCA9IG5ldyBNYXAoW1xyXG4gICAgW1wiU3RkXCIsIDddLFxyXG4gICAgW1wiUG93ZXJcIiwgMzVdLFxyXG4gICAgW1wiSnVtcFwiLCAxNV0sXHJcbiAgICBbXCJCb3dcIiwgMjVdLFxyXG4gICAgW1wiQ3Jvc3Nib3dcIiwgMzBdLFxyXG5dKTtcclxuLy8gVE9ETzogY29uc2lkZXIgc3BsaXR0aW5nIHRoaXMgc2VydmljZSAoc2VwYXJhdGUgc3RhbWluYSBhbmQgdGltZXIgbWFuYWdlbWVudClcclxuLy8gVE9ETzogc3Vic2NyaWJlIGV2ZW50cy9ob29rcyBpbiBjb25zdHJ1Y3RvclxyXG52YXIgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBpZiAoIV90aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBkaXNhYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKF90aGlzLCBcIlN3ZWV0VGFmZnkgZmVhdHVyZXMgZW5hYmxlZFwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLm9uY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5zZXRBdHRhY2tTdGFtaW5hUmVzdHJpY3Rpb24oKTtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcnNJZk5lZWRlZCgpO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5zZXRBdHRhY2tTdGFtaW5hUmVzdHJpY3Rpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBpZiAoIXRoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5vbihcInVwZGF0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBwbGF5ZXIgPSBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICBwbGF5ZXJMYXN0U3RhbWluYVZhbHVlID0gcGxheWVyLmdldEFjdG9yVmFsdWUoXCJTdGFtaW5hXCIpO1xyXG4gICAgICAgICAgICBwbGF5ZXJMYXN0SXNTcHJpbnRpbmdWYWx1ZSA9IHBsYXllci5pc1NwcmludGluZygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSBbJ1NwcmludFN0YXJ0J107IF9pIDwgX2EubGVuZ3RoOyBfaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2FbX2ldO1xyXG4gICAgICAgICAgICB2YXIgc3AgPSB0aGlzLnNwO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllckxhc3RTdGFtaW5hVmFsdWUgPCA3LjUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2IgPSAwLCBfYyA9IFsnYmxvY2tTdGFydCddOyBfYiA8IF9jLmxlbmd0aDsgX2IrKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9jW19iXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0SXNTcHJpbnRpbmdWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfZCA9IDAsIF9lID0gWydhdHRhY2tTdGFydConLCAnQXR0YWNrU3RhcnQqJ107IF9kIDwgX2UubGVuZ3RoOyBfZCsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2VbX2RdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0U3RhbWluYVZhbHVlIDwgKChfYSA9IHN0YW1pbmFBdHRhY2tNYXAuZ2V0KFwiU3RkXCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfZiA9IDAsIF9nID0gWydhdHRhY2tQb3dlclN0YXJ0KicsICdBdHRhY2tQb3dlclN0YXJ0KiddOyBfZiA8IF9nLmxlbmd0aDsgX2YrKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9nW19mXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA8ICgoX2EgPSBzdGFtaW5hQXR0YWNrTWFwLmdldChcIlBvd2VyXCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfaCA9IDAsIF9qID0gWydKdW1wRGlyZWN0aW9uYWxTdGFydConLCAnSnVtcFN0YW5kaW5nU3RhcnQqJ107IF9oIDwgX2oubGVuZ3RoOyBfaCsrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2pbX2hdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0U3RhbWluYVZhbHVlIDwgKChfYSA9IHN0YW1pbmFBdHRhY2tNYXAuZ2V0KFwiSnVtcFwiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgbGVhdmU6IChmdW5jdGlvbiAoKSB7IH0pLFxyXG4gICAgICAgICAgICB9LCAweDE0LCAweDE0LCBwYXR0ZXJuKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2sgPSAwLCBfbCA9IFsnYm93QXR0YWNrU3RhcnQqJ107IF9rIDwgX2wubGVuZ3RoOyBfaysrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXR0ZXJuID0gX2xbX2tdO1xyXG4gICAgICAgICAgICB0aGlzLnNwLmhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgZW50ZXI6IChmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJMYXN0U3RhbWluYVZhbHVlIDwgKChfYSA9IHN0YW1pbmFBdHRhY2tNYXAuZ2V0KFwiQm93XCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfbSA9IDAsIF9vID0gWydjcm9zc2Jvd0F0dGFja1N0YXJ0KiddOyBfbSA8IF9vLmxlbmd0aDsgX20rKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9vW19tXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyTGFzdFN0YW1pbmFWYWx1ZSA8ICgoX2EgPSBzdGFtaW5hQXR0YWNrTWFwLmdldChcIkNyb3NzYm93XCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguYW5pbUV2ZW50TmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICBsZWF2ZTogKGZ1bmN0aW9uICgpIHsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUucmVnaXN0ZXJIYW5kbGVyc0lmTmVlZGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfYSA9IFsnYXR0YWNrU3RhcnQqJywgJ0F0dGFja1N0YXJ0KiddOyBfaSA8IF9hLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9hW19pXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKGN0eCkgeyByZXR1cm4gc2VsZi5ibG9ja1BsYXllckF0dGFjayhjdHguYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdsZWZ0aGFuZCcpKTsgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBfYiA9IDAsIF9jID0gWydhdHRhY2tQb3dlclN0YXJ0KicsICdBdHRhY2tQb3dlclN0YXJ0KicsICdKdW1wKiddOyBfYiA8IF9jLmxlbmd0aDsgX2IrKykge1xyXG4gICAgICAgICAgICB2YXIgcGF0dGVybiA9IF9jW19iXTtcclxuICAgICAgICAgICAgdGhpcy5zcC5ob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGVudGVyOiAoZnVuY3Rpb24gKCkgeyB9KSxcclxuICAgICAgICAgICAgICAgIGxlYXZlOiAoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBsYXllckF0dGFja1RpbWVvdXQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVRpbWVycy5jbGVhcigpO1xyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIH0sIDB4MTQsIDB4MTQsIHBhdHRlcm4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoaXNQbGF5ZXJDb250cm9sRGlzYWJsZWQgPT09IHRydWUgJiYgRGF0ZS5ub3coKSAtIGJsb2NrUGxheWVyQ29udHJvbFRpbWVTdGFtcCA+PSBwbGF5ZXJBdHRhY2tUaW1lb3V0KSB7XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpLnNldERvbnRNb3ZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIGlzUGxheWVyQ29udHJvbERpc2FibGVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuYmxvY2tQbGF5ZXJBdHRhY2sgPSBmdW5jdGlvbiAoaXNMZWZ0SGFuZCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgICAgIHZhciBwbGF5ZXIgPSBfdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICBpZiAocGxheWVyLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcImJJbkp1bXBTdGF0ZVwiKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBfYiA9IF90aGlzLmdldFRpbWluZ3MoKF9hID0gcGxheWVyLmdldEVxdWlwcGVkV2VhcG9uKGlzTGVmdEhhbmQpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0V2VhcG9uVHlwZSgpKSwgZGVsYXkgPSBfYlswXSwgdGltZW91dCA9IF9iWzFdO1xyXG4gICAgICAgICAgICB2YXIgcm5kID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICBhY3RpdmVUaW1lcnMuYWRkKHJuZCk7XHJcbiAgICAgICAgICAgIF90aGlzLnNwLlV0aWxpdHkud2FpdChkZWxheSAvIDEwMDApLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFhY3RpdmVUaW1lcnMuZGVsZXRlKHJuZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlzUGxheWVyQ29udHJvbERpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBibG9ja1BsYXllckNvbnRyb2xUaW1lU3RhbXAgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkuc2V0RG9udE1vdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcGxheWVyQXR0YWNrVGltZW91dCA9IHRpbWVvdXQ7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UucHJvdG90eXBlLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleSA9IGZ1bmN0aW9uIChrZXksIHdlYXBvblRpbWluZ3MpIHtcclxuICAgICAgICB2YXIgdmFsdWUgPSB3ZWFwb25UaW1pbmdzW2tleV07XHJcbiAgICAgICAgaWYgKHZhbHVlICYmIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgICAgICB2YXIgZWxlbWVudDAgPSB2YWx1ZVswXTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50MCAhPT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgbG9nRXJyb3IodGhpcywgXCJJbnZhbGlkIHRpbWluZ3MgY29uZmlnIGZvciB3ZWFwb24gdHlwZVwiLCBrZXksIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbMCwgMF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGVsZW1lbnQxID0gdmFsdWVbMV07XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudDEgIT09IFwibnVtYmVyXCIpIHtcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiSW52YWxpZCB0aW1pbmdzIGNvbmZpZyBmb3Igd2VhcG9uIHR5cGVcIiwga2V5LCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gWzAsIDBdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBbZWxlbWVudDAsIGVsZW1lbnQxXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFswLCAwXTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuZ2V0U2V0dGluZ3NGcm9tRmlsZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcInN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlXCJdO1xyXG4gICAgICAgIGlmICghc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2UgfHwgdHlwZW9mIHN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlICE9PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiTm8gc3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2Ugc2V0dGluZ3MgZm91bmRcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgd2VhcG9uVGltaW5ncyA9IHN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLndlYXBvblRpbWluZ3M7XHJcbiAgICAgICAgaWYgKCF3ZWFwb25UaW1pbmdzIHx8IHR5cGVvZiB3ZWFwb25UaW1pbmdzICE9PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiTm8gd2VhcG9uVGltaW5ncyBzZXR0aW5ncyBmb3VuZFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzO1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRTZXR0aW5nc0RlZmF1bHQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZmlzdDogWzAsIDMwXSxcclxuICAgICAgICAgICAgc3dvcmQ6IFswLCAzMF0sXHJcbiAgICAgICAgICAgIGRhZ2dlcjogWzAsIDYwXSxcclxuICAgICAgICAgICAgd2FyQXhlOiBbMCwgNjBdLFxyXG4gICAgICAgICAgICBtYWNlOiBbMCwgNjVdLFxyXG4gICAgICAgICAgICBncmVhdHN3b3JkOiBbMCwgNjVdLFxyXG4gICAgICAgICAgICAvLyBOb3RlOiBib3RoIG9mIEJhdHRsZWF4ZSBhbmQgV2FyaGFtbWVyIHdlYXBvbiB0eXBlcyBjb3JyZXNwb25kIHRvIGlkPTYuXHJcbiAgICAgICAgICAgIGJhdHRsZWF4ZTogWzAsIDcwXSxcclxuICAgICAgICAgICAgd2FyaGFtbWVyOiBbMCwgNzBdLFxyXG4gICAgICAgICAgICBib3c6IFswLCA3MF0sXHJcbiAgICAgICAgICAgIHN0YWZmOiBbMCwgNzBdLFxyXG4gICAgICAgICAgICBjcm9zc2JvdzogWzAsIDcwXSxcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRUaW1pbmdzRnJvbUNvbmZpZyA9IGZ1bmN0aW9uICh3ZWFwb24pIHtcclxuICAgICAgICBpZiAoIXdlYXBvbikge1xyXG4gICAgICAgICAgICB3ZWFwb24gPSAwIC8qIFdlYXBvblR5cGUuRmlzdCAqLztcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gc2t5bXA1LWNsaWVudC1zZXR0aW5ncy50eHQgaXMgcGVyZmVjdGx5IGVkaXRhYmxlIGJ5IHVzZXJzLCBzbyB3ZSBkb24ndCB1c2UgaXQgZm9yIG5vdy5cclxuICAgICAgICAvLyBJdCdzIHdlbGwtdGVzdGVkIHRob3VnaCwgc28gd2UgY2FuIGVuYWJsZSBpdCBvbmNlIHdlIGhhdmUgYSBwcm90ZWN0aW9uIG1lY2hhbmlzbS5cclxuICAgICAgICAvLyBjb25zdCB3ZWFwb25UaW1pbmdzID0gdGhpcy5nZXRTZXR0aW5nc0Zyb21GaWxlKCk7XHJcbiAgICAgICAgdmFyIHdlYXBvblRpbWluZ3MgPSB0aGlzLmdldFNldHRpbmdzRGVmYXVsdCgpO1xyXG4gICAgICAgIGlmICghd2VhcG9uVGltaW5ncykge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHdlYXBvblRpbWluZ3NSZXN1bHQgPSB7XHJcbiAgICAgICAgICAgIGZpc3Q6IFswLCAwXSxcclxuICAgICAgICAgICAgc3dvcmQ6IFswLCAwXSxcclxuICAgICAgICAgICAgZGFnZ2VyOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIHdhckF4ZTogWzAsIDBdLFxyXG4gICAgICAgICAgICBtYWNlOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIGdyZWF0c3dvcmQ6IFswLCAwXSxcclxuICAgICAgICAgICAgYmF0dGxlYXhlOiBbMCwgMF0sXHJcbiAgICAgICAgICAgIHdhcmhhbW1lcjogWzAsIDBdLFxyXG4gICAgICAgICAgICBib3c6IFswLCAwXSxcclxuICAgICAgICAgICAgc3RhZmY6IFswLCAwXSxcclxuICAgICAgICAgICAgY3Jvc3Nib3c6IFswLCAwXSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuZmlzdCA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwiZmlzdFwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LnN3b3JkID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJzd29yZFwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LmRhZ2dlciA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwiZGFnZ2VyXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQud2FyQXhlID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJ3YXJBeGVcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5tYWNlID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJtYWNlXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQuZ3JlYXRzd29yZCA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwiZ3JlYXRzd29yZFwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LmJhdHRsZWF4ZSA9IHRoaXMuZ2V0QW5kVmFsaWRhdGVUaW1pbmdzQ29uZmlnS2V5KFwiYmF0dGxlYXhlXCIsIHdlYXBvblRpbWluZ3MpO1xyXG4gICAgICAgIHdlYXBvblRpbWluZ3NSZXN1bHQud2FyaGFtbWVyID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJ3YXJoYW1tZXJcIiwgd2VhcG9uVGltaW5ncyk7XHJcbiAgICAgICAgd2VhcG9uVGltaW5nc1Jlc3VsdC5ib3cgPSB0aGlzLmdldEFuZFZhbGlkYXRlVGltaW5nc0NvbmZpZ0tleShcImJvd1wiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LnN0YWZmID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJzdGFmZlwiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICB3ZWFwb25UaW1pbmdzUmVzdWx0LmNyb3NzYm93ID0gdGhpcy5nZXRBbmRWYWxpZGF0ZVRpbWluZ3NDb25maWdLZXkoXCJjcm9zc2Jvd1wiLCB3ZWFwb25UaW1pbmdzKTtcclxuICAgICAgICBzd2l0Y2ggKHdlYXBvbikge1xyXG4gICAgICAgICAgICBjYXNlIDAgLyogV2VhcG9uVHlwZS5GaXN0ICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuZmlzdDtcclxuICAgICAgICAgICAgY2FzZSAxIC8qIFdlYXBvblR5cGUuU3dvcmQgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5zd29yZDtcclxuICAgICAgICAgICAgY2FzZSAyIC8qIFdlYXBvblR5cGUuRGFnZ2VyICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuZGFnZ2VyO1xyXG4gICAgICAgICAgICBjYXNlIDMgLyogV2VhcG9uVHlwZS5XYXJBeGUgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC53YXJBeGU7XHJcbiAgICAgICAgICAgIGNhc2UgNCAvKiBXZWFwb25UeXBlLk1hY2UgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5tYWNlO1xyXG4gICAgICAgICAgICBjYXNlIDUgLyogV2VhcG9uVHlwZS5HcmVhdHN3b3JkICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuZ3JlYXRzd29yZDtcclxuICAgICAgICAgICAgY2FzZSA2IC8qIFdlYXBvblR5cGUuQmF0dGxlYXhlICovOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdlYXBvblRpbWluZ3NSZXN1bHQuYmF0dGxlYXhlO1xyXG4gICAgICAgICAgICBjYXNlIDYgLyogV2VhcG9uVHlwZS5XYXJoYW1tZXIgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC53YXJoYW1tZXI7XHJcbiAgICAgICAgICAgIGNhc2UgNyAvKiBXZWFwb25UeXBlLkJvdyAqLzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB3ZWFwb25UaW1pbmdzUmVzdWx0LmJvdztcclxuICAgICAgICAgICAgY2FzZSA4IC8qIFdlYXBvblR5cGUuU3RhZmYgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5zdGFmZjtcclxuICAgICAgICAgICAgY2FzZSA5IC8qIFdlYXBvblR5cGUuQ3Jvc3Nib3cgKi86XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd2VhcG9uVGltaW5nc1Jlc3VsdC5jcm9zc2JvdztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGxvZ0Vycm9yKHRoaXMsIFwiTm8gdGltaW5ncyBmb3VuZCBmb3Igd2VhcG9uIHR5cGVcIiwgd2VhcG9uKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuZ2V0VGltaW5ncyA9IGZ1bmN0aW9uICh3ZWFwb24pIHtcclxuICAgICAgICB2YXIgdGltaW5nc0Zyb21Db25maWcgPSB0aGlzLmdldFRpbWluZ3NGcm9tQ29uZmlnKHdlYXBvbik7XHJcbiAgICAgICAgaWYgKCF3ZWFwb24gfHwgIXRpbWluZ3NGcm9tQ29uZmlnKSB7XHJcbiAgICAgICAgICAgIHdlYXBvbiA9IDAgLyogV2VhcG9uVHlwZS5GaXN0ICovO1xyXG4gICAgICAgICAgICB0aW1pbmdzRnJvbUNvbmZpZyA9IHRoaXMuZ2V0VGltaW5nc0Zyb21Db25maWcod2VhcG9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aW1pbmdzRnJvbUNvbmZpZykge1xyXG4gICAgICAgICAgICBsb2dFcnJvcih0aGlzLCBcIk5vIHRpbWluZ3MgZm91bmQgZm9yIHdlYXBvbiB0eXBlXCIsIHdlYXBvbik7XHJcbiAgICAgICAgICAgIHJldHVybiBbMCwgMF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aW1pbmdzRnJvbUNvbmZpZztcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZS5wcm90b3R5cGUuaGFzU3dlZXRQaWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1vZENvdW50ID0gdGhpcy5zcC5HYW1lLmdldE1vZENvdW50KCk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLkdhbWUuZ2V0TW9kTmFtZShpKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdzd2VldHBpZScpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFN3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBicm93c2VyIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gJy4vY2xpZW50TGlzdGVuZXInO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xyXG4vLyBUT0RPOiBtb3ZlIHRvIHNlcnZlci9nYW1lbW9kZVxyXG52YXIgU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5hbHRhcnMgPSBbXHJcbiAgICAgICAgICAgIDB4MDAxMDA3ODAsIDB4MDAwRDk4ODMsIDB4MDAwRDk4N0IsIDB4MDAwRDk4ODEsIDB4MDAwRDk4ODcsIDB4MDAwRkI5OTcsXHJcbiAgICAgICAgICAgIDB4MDAwRDk4ODUsIDB4MDAwRDk4N0QsIDB4MDAwNzE4NTQsIDB4MDcxODc1MDAsIDB4MDIwMGM4NmIsIDB4MDAwZDk4N2YsXHJcbiAgICAgICAgICAgIDB4MDcwNThkNGUsIDB4MDcwNThkNTMsIDB4MDcwQTY5MTIsIDB4MDcwNThkNTEsIDB4MDcwNThkNTAsIDB4MDcwNThkNGYsXHJcbiAgICAgICAgICAgIDB4MDcwNThkNGQsIDB4MDcwNThkNGMsIDB4MDcwNThkNGIsIDB4MDcwNWUyZmEsIDB4MDcwNThkNGEsIDB4MDcwNThkNDksXHJcbiAgICAgICAgICAgIDB4MDcwNWUzNjcsIDB4MDcwNThkNDgsIDB4MDcwNThkNTUsIDB4MDcwNThkNDYsIDB4MDcwNThkNDcsIDB4MDcwNWUyYjAsXHJcbiAgICAgICAgICAgIDB4MDcwNThkNDVcclxuICAgICAgICBdO1xyXG4gICAgICAgIGlmICghX3RoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGRpc2FibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBlbmFibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJhY3RpdmF0ZVwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gX3RoaXMub25BY3RpdmF0ZShlKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UucHJvdG90eXBlLm9uQWN0aXZhdGUgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgX2E7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc1N3ZWV0UGllKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuYWx0YXJzLmluY2x1ZGVzKCgoX2EgPSBldmVudC50YXJnZXQuZ2V0QmFzZU9iamVjdCgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Rm9ybUlEKCkpIHx8IC0xKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyb3dzZXIuc2V0Rm9jdXNlZCh0cnVlKTtcclxuICAgICAgICB2YXIgc3JjID0gXCJ3aW5kb3cuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ2luaXRTa2lsbE1lbnUnKSlcIjtcclxuICAgICAgICBicm93c2VyLmV4ZWN1dGVKYXZhU2NyaXB0KHNyYyk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2UucHJvdG90eXBlLmhhc1N3ZWV0UGllID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtb2RDb3VudCA9IHRoaXMuc3AuR2FtZS5nZXRNb2RDb3VudCgpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kQ291bnQ7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zcC5HYW1lLmdldE1vZE5hbWUoaSkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3dlZXRwaWUnKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBTd2VldFRhZmZ5U2tpbGxNZW51U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgbG9nVHJhY2UgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIC8vIFRPRE86IG1vdmUgdGhpcyB0byBjb25maWdcclxuICAgICAgICBfdGhpcy5zdGVhbHRoID0gWzB4QkUxMjYsIDB4QzA3QzYsIDB4QzA3QzcsIDB4QzA3QzgsIDB4QzA3QzldO1xyXG4gICAgICAgIF90aGlzLm1hZ2ljID0gWzB4NTgyMTMsIDB4MTA1RjI0LCAweDU4MjE0XTtcclxuICAgICAgICBfdGhpcy53YXJyaW9yID0gWzB4Q0I0MEQsIDB4Q0I0MEYsIDB4Q0I0MTQsIDB4Q0I0MTEsIDB4Q0I0MTIsIDB4Q0I0MTAsIDB4Q0I0MEVdO1xyXG4gICAgICAgIGlmICghX3RoaXMuaGFzU3dlZXRQaWUoKSkge1xyXG4gICAgICAgICAgICBsb2dUcmFjZShfdGhpcywgXCJTd2VldFRhZmZ5IGZlYXR1cmVzIGRpc2FibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsIFwiU3dlZXRUYWZmeSBmZWF0dXJlcyBlbmFibGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25jZVVwZGF0ZSgpOyB9KTtcclxuICAgICAgICByZXR1cm4gX3RoaXM7XHJcbiAgICB9XHJcbiAgICBTd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlLnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5oYXNTd2VldFBpZSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5hZGRTdGF0aWNQZXJrc1RvVGhlUGxheWVyKCk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZS5wcm90b3R5cGUuYWRkU3RhdGljUGVya3NUb1RoZVBsYXllciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgdmFyIGFsbFN0YXRpY1BlcmtJZHMgPSB0aGlzLnN0ZWFsdGguY29uY2F0KHRoaXMubWFnaWMpLmNvbmNhdCh0aGlzLndhcnJpb3IpO1xyXG4gICAgICAgIGFsbFN0YXRpY1BlcmtJZHMuZm9yRWFjaChmdW5jdGlvbiAocGVya0lkKSB7XHJcbiAgICAgICAgICAgIHBsYXllci5hZGRQZXJrKF90aGlzLnNwLlBlcmsuZnJvbShfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChwZXJrSWQpKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZS5wcm90b3R5cGUuaGFzU3dlZXRQaWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG1vZENvdW50ID0gdGhpcy5zcC5HYW1lLmdldE1vZENvdW50KCk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLkdhbWUuZ2V0TW9kTmFtZShpKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdzd2VldHBpZScpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG4vLyBUT0RPOiBtb3ZlIHRvIHRoZSBzZXJ2ZXIvZ2FtZW1vZGVcclxudmFyIFN3ZWV0VGFmZnlTd2VldENhbnREcm9wU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMuY2FudERyb3BLZXl3b3JkID0gXCJTd2VldENhbnREcm9wXCI7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlLnByb3RvdHlwZS5jYW5Ecm9wT3JQdXRJdGVtID0gZnVuY3Rpb24gKGl0ZW1JZCkge1xyXG4gICAgICAgIHZhciBpdGVtID0gdGhpcy5zcC5HYW1lLmdldEZvcm1FeChpdGVtSWQpO1xyXG4gICAgICAgIGlmIChpdGVtICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChpdGVtLmhhc0tleXdvcmQodGhpcy5zcC5LZXl3b3JkLmdldEtleXdvcmQodGhpcy5jYW50RHJvcEtleXdvcmQpKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBUaW1lU2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhUaW1lU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFRpbWVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLmxhc3RUaW1lVXBkID0gMDtcclxuICAgICAgICBjb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFRpbWVTZXJ2aWNlLnByb3RvdHlwZS5nZXRUaW1lID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBob3Vyc09mZnNldFNldHRpbmcgPSB0aGlzLnNwLnNldHRpbmdzW1wic2t5bXA1LWNsaWVudFwiXVtcImhvdXJzT2Zmc2V0XCJdO1xyXG4gICAgICAgIHZhciBob3Vyc09mZnNldCA9IHR5cGVvZiBob3Vyc09mZnNldFNldHRpbmcgPT09IFwibnVtYmVyXCIgPyBob3Vyc09mZnNldFNldHRpbmcgOiAwO1xyXG4gICAgICAgIHZhciBob3Vyc09mZnNldE1zID0gaG91cnNPZmZzZXQgKiA2MCAqIDYwICogMTAwMDtcclxuICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKERhdGUubm93KCkgKyBob3Vyc09mZnNldE1zKTtcclxuICAgICAgICB2YXIgbmV3R2FtZUhvdXJWYWx1ZSA9IDA7XHJcbiAgICAgICAgbmV3R2FtZUhvdXJWYWx1ZSArPSBkLmdldFVUQ0hvdXJzKCk7XHJcbiAgICAgICAgbmV3R2FtZUhvdXJWYWx1ZSArPSBkLmdldFVUQ01pbnV0ZXMoKSAvIDYwO1xyXG4gICAgICAgIG5ld0dhbWVIb3VyVmFsdWUgKz0gZC5nZXRVVENTZWNvbmRzKCkgLyA2MCAvIDYwO1xyXG4gICAgICAgIG5ld0dhbWVIb3VyVmFsdWUgKz0gZC5nZXRVVENNaWxsaXNlY29uZHMoKSAvIDYwIC8gNjAgLyAxMDAwO1xyXG4gICAgICAgIHJldHVybiB7IG5ld0dhbWVIb3VyVmFsdWU6IG5ld0dhbWVIb3VyVmFsdWUsIGRhdGU6IGQgfTtcclxuICAgIH07XHJcbiAgICBUaW1lU2VydmljZS5wcm90b3R5cGUuZXZlcnkyc2Vjb25kcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgZ2FtZUhvdXJJZCA9IDB4Mzg7XHJcbiAgICAgICAgdmFyIGdhbWVNb250aElkID0gMHgzNjtcclxuICAgICAgICB2YXIgZ2FtZURheUlkID0gMHgzNztcclxuICAgICAgICB2YXIgZ2FtZVllYXJJZCA9IDB4MzU7XHJcbiAgICAgICAgdmFyIHRpbWVTY2FsZUlkID0gMHgzYTtcclxuICAgICAgICB2YXIgZ2FtZUhvdXIgPSB0aGlzLnNwLkdsb2JhbFZhcmlhYmxlLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeChnYW1lSG91cklkKSk7XHJcbiAgICAgICAgdmFyIGdhbWVEYXkgPSB0aGlzLnNwLkdsb2JhbFZhcmlhYmxlLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeChnYW1lRGF5SWQpKTtcclxuICAgICAgICB2YXIgZ2FtZU1vbnRoID0gdGhpcy5zcC5HbG9iYWxWYXJpYWJsZS5mcm9tKHRoaXMuc3AuR2FtZS5nZXRGb3JtRXgoZ2FtZU1vbnRoSWQpKTtcclxuICAgICAgICB2YXIgZ2FtZVllYXIgPSB0aGlzLnNwLkdsb2JhbFZhcmlhYmxlLmZyb20odGhpcy5zcC5HYW1lLmdldEZvcm1FeChnYW1lWWVhcklkKSk7XHJcbiAgICAgICAgdmFyIHRpbWVTY2FsZSA9IHRoaXMuc3AuR2xvYmFsVmFyaWFibGUuZnJvbSh0aGlzLnNwLkdhbWUuZ2V0Rm9ybUV4KHRpbWVTY2FsZUlkKSk7XHJcbiAgICAgICAgaWYgKCFnYW1lSG91ciB8fCAhZ2FtZURheSB8fCAhZ2FtZU1vbnRoIHx8ICFnYW1lWWVhciB8fCAhdGltZVNjYWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIF9hID0gdGhpcy5nZXRUaW1lKCksIG5ld0dhbWVIb3VyVmFsdWUgPSBfYS5uZXdHYW1lSG91clZhbHVlLCBkYXRlID0gX2EuZGF0ZTtcclxuICAgICAgICB2YXIgZGlmZiA9IE1hdGguYWJzKGdhbWVIb3VyLmdldFZhbHVlKCkgLSBuZXdHYW1lSG91clZhbHVlKTtcclxuICAgICAgICBpZiAoZGlmZiA+PSAxIC8gNjApIHtcclxuICAgICAgICAgICAgZ2FtZUhvdXIuc2V0VmFsdWUobmV3R2FtZUhvdXJWYWx1ZSk7XHJcbiAgICAgICAgICAgIGdhbWVEYXkuc2V0VmFsdWUoZGF0ZS5nZXRVVENEYXRlKCkpO1xyXG4gICAgICAgICAgICBnYW1lTW9udGguc2V0VmFsdWUoZGF0ZS5nZXRVVENNb250aCgpKTtcclxuICAgICAgICAgICAgZ2FtZVllYXIuc2V0VmFsdWUoZGF0ZS5nZXRVVENGdWxsWWVhcigpIC0gMjAyMCArIDE5OSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRpbWVTY2FsZS5zZXRWYWx1ZShnYW1lSG91ci5nZXRWYWx1ZSgpID4gbmV3R2FtZUhvdXJWYWx1ZSA/IDAuNiA6IDEuMik7XHJcbiAgICB9O1xyXG4gICAgVGltZVNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChEYXRlLm5vdygpIC0gdGhpcy5sYXN0VGltZVVwZCA8PSAyMDAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sYXN0VGltZVVwZCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgdGhpcy5ldmVyeTJzZWNvbmRzKCk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFRpbWVTZXJ2aWNlO1xyXG59KENsaWVudExpc3RlbmVyKSk7XHJcbmV4cG9ydCB7IFRpbWVTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbnZhciBQcm9jZXNzTWV0aG9kVHlwZTtcclxuKGZ1bmN0aW9uIChQcm9jZXNzTWV0aG9kVHlwZSkge1xyXG4gICAgUHJvY2Vzc01ldGhvZFR5cGVbXCJ1cGRhdGVcIl0gPSBcInVwZGF0ZVwiO1xyXG4gICAgUHJvY2Vzc01ldGhvZFR5cGVbXCJ0aWNrXCJdID0gXCJ0aWNrXCI7XHJcbn0pKFByb2Nlc3NNZXRob2RUeXBlIHx8IChQcm9jZXNzTWV0aG9kVHlwZSA9IHt9KSk7XHJcbnZhciBUaW1lcnNTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikge1xyXG4gICAgX19leHRlbmRzKFRpbWVyc1NlcnZpY2UsIF9zdXBlcik7XHJcbiAgICBmdW5jdGlvbiBUaW1lcnNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIF90aGlzLnRpbWVyc0FyciA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIF90aGlzLmludGVydmFsc0FyciA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIF90aGlzLmxhc3RDYWxsVGltZSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgX3RoaXMucHJvY2Vzc01ldGhvZFR5cGVTdG9yYWdlS2V5ID0gXCJ1cGRhdGVUeXBlU3RvcmFnZUtleVwiO1xyXG4gICAgICAgIHZhciBzdG9yYWdlUHJvY2Vzc01ldGhvZCA9IHNwLnN0b3JhZ2VbX3RoaXMucHJvY2Vzc01ldGhvZFR5cGVTdG9yYWdlS2V5XTtcclxuICAgICAgICBpZiAodHlwZW9mIHN0b3JhZ2VQcm9jZXNzTWV0aG9kICE9PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgX3RoaXMuc2V0UHJvY2Vzc01ldGhvZChzdG9yYWdlUHJvY2Vzc01ldGhvZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBfdGhpcy5zZXRQcm9jZXNzTWV0aG9kKFByb2Nlc3NNZXRob2RUeXBlLnRpY2spO1xyXG4gICAgICAgIH1cclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwibWVudU9wZW5cIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIF90aGlzLm9uTWVudU9wZW4oZSk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJwcmVMb2FkR2FtZVwiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5vblByZUxvYWRHYW1lKCk7IH0pO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLnNldFRpbWVvdXQgPSBmdW5jdGlvbiAoaGFuZGxlciwgdGltZW91dCkge1xyXG4gICAgICAgIHZhciBhcmdzID0gW107XHJcbiAgICAgICAgZm9yICh2YXIgX2kgPSAyOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICAgICAgYXJnc1tfaSAtIDJdID0gYXJndW1lbnRzW19pXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRpbWVyID0geyBoYW5kbGVyOiBoYW5kbGVyLCBhcmdzOiBhcmdzLCBkZWxheU1zOiB0aW1lb3V0ICE9PSBudWxsICYmIHRpbWVvdXQgIT09IHZvaWQgMCA/IHRpbWVvdXQgOiAwLCBwYXNzZWRNczogMCB9O1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50aW1lcnNBcnIubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLnRpbWVyc0FycltpXSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50aW1lcnNBcnJbaV0gPSB0aW1lcjtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpICsgMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy50aW1lcnNBcnIucHVzaCh0aW1lcik7XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUuY2xlYXJUaW1lb3V0ID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgICAgICAgaWYgKGlkID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy50aW1lcnNBcnIgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaWQgPD0gMCB8fCBpZCA+IHRoaXMudGltZXJzQXJyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudGltZXJzQXJyW2lkIC0gMV0gPSBudWxsO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5zZXRJbnRlcnZhbCA9IGZ1bmN0aW9uIChoYW5kbGVyLCB0aW1lb3V0KSB7XHJcbiAgICAgICAgdmFyIGFyZ3MgPSBbXTtcclxuICAgICAgICBmb3IgKHZhciBfaSA9IDI7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgICAgICBhcmdzW19pIC0gMl0gPSBhcmd1bWVudHNbX2ldO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgdGltZXIgPSB7IGhhbmRsZXI6IGhhbmRsZXIsIGFyZ3M6IGFyZ3MsIGRlbGF5TXM6IHRpbWVvdXQgIT09IG51bGwgJiYgdGltZW91dCAhPT0gdm9pZCAwID8gdGltZW91dCA6IDAsIHBhc3NlZE1zOiAwIH07XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmludGVydmFsc0Fyci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaW50ZXJ2YWxzQXJyW2ldKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmludGVydmFsc0FycltpXSA9IHRpbWVyO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGkgKyAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmludGVydmFsc0Fyci5wdXNoKHRpbWVyKTtcclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5jbGVhckludGVydmFsID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgICAgICAgaWYgKGlkID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnRlcnZhbHNBcnIgPSBuZXcgQXJyYXkoKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaWQgPD0gMCB8fCBpZCA+IHRoaXMuaW50ZXJ2YWxzQXJyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW50ZXJ2YWxzQXJyW2lkIC0gMV0gPSBudWxsO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH07XHJcbiAgICBUaW1lcnNTZXJ2aWNlLnByb3RvdHlwZS5zZXRQcm9jZXNzTWV0aG9kID0gZnVuY3Rpb24gKG1ldGhvZCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgc3dpdGNoIChtZXRob2QpIHtcclxuICAgICAgICAgICAgY2FzZSBQcm9jZXNzTWV0aG9kVHlwZS50aWNrOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW3RoaXMucHJvY2Vzc01ldGhvZFR5cGVTdG9yYWdlS2V5XSA9IFByb2Nlc3NNZXRob2RUeXBlLnRpY2s7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUV2ZW50SGFuZGxlID0gdGhpcy5jb250cm9sbGVyLm9uKFByb2Nlc3NNZXRob2RUeXBlLnRpY2ssIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLnByb2Nlc3NUaW1lcnMoKTsgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIGNhc2UgUHJvY2Vzc01ldGhvZFR5cGUudXBkYXRlOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5zcC5zdG9yYWdlW3RoaXMucHJvY2Vzc01ldGhvZFR5cGVTdG9yYWdlS2V5XSA9IFByb2Nlc3NNZXRob2RUeXBlLnVwZGF0ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRXZlbnRIYW5kbGUgPSB0aGlzLmNvbnRyb2xsZXIub24oUHJvY2Vzc01ldGhvZFR5cGUudXBkYXRlLCBmdW5jdGlvbiAoKSB7IHJldHVybiBfdGhpcy5wcm9jZXNzVGltZXJzKCk7IH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNwLkdhbWUuZ2V0UGxheWVyKCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIEZJWE1FKEdNLTEwMDgpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZXRQcm9jZXNzTWV0aG9kKFByb2Nlc3NNZXRob2RUeXBlLnVwZGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChfYSkge1xyXG4gICAgICAgICAgICB0aGlzLnNldFByb2Nlc3NNZXRob2QoUHJvY2Vzc01ldGhvZFR5cGUudGljayk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLnByb2Nlc3NUaW1lcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGR0ID0gRGF0ZS5ub3coKSAtIHRoaXMubGFzdENhbGxUaW1lO1xyXG4gICAgICAgIHRoaXMubGFzdENhbGxUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAvLyBwcm9jZXNzIHRpbWVyc1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50aW1lcnNBcnIubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIHRpbWVyID0gdGhpcy50aW1lcnNBcnJbaV07XHJcbiAgICAgICAgICAgIGlmICh0aW1lcikge1xyXG4gICAgICAgICAgICAgICAgdGltZXIucGFzc2VkTXMgKz0gZHQ7XHJcbiAgICAgICAgICAgICAgICBpZiAodGltZXIucGFzc2VkTXMgPj0gdGltZXIuZGVsYXlNcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGltZXJzQXJyW2ldID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRpbWVyLmhhbmRsZXIgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lci5oYW5kbGVyLmNhbGwodGhpcywgdGltZXIuYXJncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmFsKHRpbWVyLmhhbmRsZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChpID09PSB0aGlzLnRpbWVyc0Fyci5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAvLyByZW1vdmUgbGFzdCB1bnVzZWQgZWxlbWVudFxyXG4gICAgICAgICAgICAgICAgdGhpcy50aW1lcnNBcnIubGVuZ3RoIC09IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gcHJvY2VzcyBpbnRlcnZhbHNcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaW50ZXJ2YWxzQXJyLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBpbnRlcnZhbCA9IHRoaXMuaW50ZXJ2YWxzQXJyW2ldO1xyXG4gICAgICAgICAgICBpZiAoaW50ZXJ2YWwpIHtcclxuICAgICAgICAgICAgICAgIGludGVydmFsLnBhc3NlZE1zICs9IGR0O1xyXG4gICAgICAgICAgICAgICAgaWYgKGludGVydmFsLnBhc3NlZE1zID49IGludGVydmFsLmRlbGF5TXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbC5wYXNzZWRNcyA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnRlcnZhbC5oYW5kbGVyID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwuaGFuZGxlci5jYWxsKHRoaXMsIGludGVydmFsLmFyZ3MpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZhbChpbnRlcnZhbC5oYW5kbGVyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoaSA9PT0gdGhpcy5pbnRlcnZhbHNBcnIubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGxhc3QgdW51c2VkIGVsZW1lbnRcclxuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJ2YWxzQXJyLmxlbmd0aCAtPSAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFRpbWVyc1NlcnZpY2UucHJvdG90eXBlLm9uTWVudU9wZW4gPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIGlmIChlLm5hbWUgPT09IFwiTWFpbiBNZW51XCIgLyogTWVudS5NYWluICovKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZUV2ZW50SGFuZGxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwLnVuc3Vic2NyaWJlKHRoaXMudXBkYXRlRXZlbnRIYW5kbGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvY2Vzc01ldGhvZChQcm9jZXNzTWV0aG9kVHlwZS50aWNrKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVGltZXJzU2VydmljZS5wcm90b3R5cGUub25QcmVMb2FkR2FtZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy51cGRhdGVFdmVudEhhbmRsZSkge1xyXG4gICAgICAgICAgICB0aGlzLnNwLnVuc3Vic2NyaWJlKHRoaXMudXBkYXRlRXZlbnRIYW5kbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldFByb2Nlc3NNZXRob2QoUHJvY2Vzc01ldGhvZFR5cGUudXBkYXRlKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gVGltZXJzU2VydmljZTtcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBUaW1lcnNTZXJ2aWNlIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSwgbG9nRXJyb3IgfSBmcm9tIFwiLi4vLi4vbG9nZ2luZ1wiO1xyXG5pbXBvcnQgeyBDbGllbnRMaXN0ZW5lciB9IGZyb20gXCIuL2NsaWVudExpc3RlbmVyXCI7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuL3JlbW90ZVNlcnZlclwiO1xyXG52YXIgVm9pY2VDaGF0U2VydmljZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHtcclxuICAgIF9fZXh0ZW5kcyhWb2ljZUNoYXRTZXJ2aWNlLCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gVm9pY2VDaGF0U2VydmljZShzcCwgY29udHJvbGxlcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7XHJcbiAgICAgICAgX3RoaXMuc3AgPSBzcDtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjtcclxuICAgICAgICBfdGhpcy5pc0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMuaXNUYWxraW5nID0gZmFsc2U7XHJcbiAgICAgICAgX3RoaXMucHVzaFRvVGFsa0tleSA9IDB4NTY7IC8vIFYga2V5XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlci5vbihcInRpY2tcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25UaWNrKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUub25Db25uZWN0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIFZvaWNlIGNoYXQgaW5pdGlhbGl6YXRpb24gaGFuZGxlZCBlbHNld2hlcmUgZm9yIG5vd1xyXG4gICAgICAgIGxvZ1RyYWNlKFwiVm9pY2VDaGF0U2VydmljZTogQ29ubmVjdGVkXCIpO1xyXG4gICAgfTtcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLm9uRGlzY29ubmVjdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy5pc1RhbGtpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5zdG9wVGFsa2luZygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgIH07XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5vblRpY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBDaGVjayBwdXNoLXRvLXRhbGsga2V5IHN0YXRlXHJcbiAgICAgICAgdmFyIGtleVByZXNzZWQgPSB0aGlzLnNwLklucHV0LmlzS2V5UHJlc3NlZCh0aGlzLnB1c2hUb1RhbGtLZXkpO1xyXG4gICAgICAgIGlmIChrZXlQcmVzc2VkICYmICF0aGlzLmlzVGFsa2luZykge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0VGFsa2luZygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICgha2V5UHJlc3NlZCAmJiB0aGlzLmlzVGFsa2luZykge1xyXG4gICAgICAgICAgICB0aGlzLnN0b3BUYWxraW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIEhhbmRsZSBjb250aW51b3VzIHZvaWNlIGNoYXQgdXBkYXRlcyBpZiBuZWVkZWRcclxuICAgIH07XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5zdGFydFRhbGtpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5pc1RhbGtpbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICBsb2dUcmFjZShcIlZvaWNlQ2hhdFNlcnZpY2U6IFN0YXJ0ZWQgdGFsa2luZ1wiKTtcclxuICAgICAgICAgICAgLy8gQWN0dWFsIHZvaWNlIGNhcHR1cmUgaGFuZGxlZCBieSB1bmRlcmx5aW5nIHN5c3RlbVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgbG9nRXJyb3IoXCJWb2ljZUNoYXRTZXJ2aWNlOiBGYWlsZWQgdG8gc3RhcnQgdGFsa2luZzogXCIuY29uY2F0KGVycm9yKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFZvaWNlQ2hhdFNlcnZpY2UucHJvdG90eXBlLnN0b3BUYWxraW5nID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNUYWxraW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKFwiVm9pY2VDaGF0U2VydmljZTogU3RvcHBlZCB0YWxraW5nXCIpO1xyXG4gICAgICAgICAgICAvLyBBY3R1YWwgdm9pY2UgY2FwdHVyZSBzdG9wcGluZyBoYW5kbGVkIGJ5IHVuZGVybHlpbmcgc3lzdGVtXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcihcIlZvaWNlQ2hhdFNlcnZpY2U6IEZhaWxlZCB0byBzdG9wIHRhbGtpbmc6IFwiLmNvbmNhdChlcnJvcikpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvLyBIYW5kbGUgaW5jb21pbmcgdm9pY2UgY2hhdCBkYXRhIGZyb20gb3RoZXIgcGxheWVyc1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUub25SZWNlaXZlVm9pY2VEYXRhID0gZnVuY3Rpb24gKHNwZWFrZXJJZCwgYXVkaW9EYXRhLCB4LCB5LCB6KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBWb2ljZSBwbGF5YmFjayBoYW5kbGVkIGJ5IHVuZGVybHlpbmcgc3lzdGVtXHJcbiAgICAgICAgICAgIGxvZ1RyYWNlKFwiVm9pY2VDaGF0U2VydmljZTogUmVjZWl2ZWQgdm9pY2UgZGF0YSBmcm9tIFwiLmNvbmNhdChzcGVha2VySWQsIFwiIGF0IChcIikuY29uY2F0KHgsIFwiLCBcIikuY29uY2F0KHksIFwiLCBcIikuY29uY2F0KHosIFwiKVwiKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcihcIlZvaWNlQ2hhdFNlcnZpY2U6IEZhaWxlZCB0byBwcm9jZXNzIHZvaWNlIGRhdGE6IFwiLmNvbmNhdChlcnJvcikpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvLyBIYW5kbGUgYmluYXJ5IHZvaWNlIHBhY2tldHMgcmVjZWl2ZWQgZnJvbSB0aGUgc2VydmVyXHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5vblBhY2tldCA9IGZ1bmN0aW9uICh0eXBlLCByYXdDb250ZW50LCBlcnJvcikge1xyXG4gICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICBsb2dFcnJvcihcIlZvaWNlQ2hhdFNlcnZpY2U6IFBhY2tldCBlcnJvcjogXCIuY29uY2F0KGVycm9yKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFyYXdDb250ZW50IHx8IHJhd0NvbnRlbnQuYnl0ZUxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBiaW5hcnkgdm9pY2UgcGFja2V0XHJcbiAgICAgICAgdmFyIGRhdGEgPSBuZXcgVWludDhBcnJheShyYXdDb250ZW50KTtcclxuICAgICAgICBpZiAoZGF0YVswXSA9PT0gMTM1KSB7IC8vIEJpbmFyeVZvaWNlUGFja2V0SWRcclxuICAgICAgICAgICAgaWYgKHJhd0NvbnRlbnQuYnl0ZUxlbmd0aCA+PSA5KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBFeHRyYWN0IHNwZWFrZXIgSUQgKDQgYnl0ZXMpXHJcbiAgICAgICAgICAgICAgICB2YXIgc3BlYWtlcklkQnl0ZXMgPSBkYXRhLnNsaWNlKDEsIDUpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwZWFrZXJJZF8xID0gbmV3IERhdGFWaWV3KHNwZWFrZXJJZEJ5dGVzLmJ1ZmZlcikuZ2V0VWludDMyKDAsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgLy8gRXh0cmFjdCBkYXRhIHNpemUgKDQgYnl0ZXMpXHJcbiAgICAgICAgICAgICAgICB2YXIgZGF0YVNpemVCeXRlcyA9IGRhdGEuc2xpY2UoNSwgOSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgZGF0YVNpemUgPSBuZXcgRGF0YVZpZXcoZGF0YVNpemVCeXRlcy5idWZmZXIpLmdldFVpbnQzMigwLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIGlmIChyYXdDb250ZW50LmJ5dGVMZW5ndGggPT09IDkgKyBkYXRhU2l6ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhY3QgYXVkaW8gZGF0YVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhdWRpb0RhdGEgPSBkYXRhLnNsaWNlKDkpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEdldCBzcGVha2VyIHBvc2l0aW9uIGZyb20gd29ybGQgbW9kZWxcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVtb3RlU2VydmVyID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJlbW90ZVNlcnZlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmxkTW9kZWwgPSByZW1vdGVTZXJ2ZXIuZ2V0V29ybGRNb2RlbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB4ID0gMCwgeSA9IDAsIHogPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgdGhlIHNwZWFrZXIgaW4gdGhlIHdvcmxkIG1vZGVsIHRvIGdldCBwb3NpdGlvblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcGVha2VyRm9ybSA9IHdvcmxkTW9kZWwuZm9ybXMuZmluZChmdW5jdGlvbiAoZikgeyByZXR1cm4gZiAmJiBmLnJlZnJJZCA9PT0gc3BlYWtlcklkXzE7IH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzcGVha2VyRm9ybSAmJiBzcGVha2VyRm9ybS5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB4ID0gc3BlYWtlckZvcm0ubW92ZW1lbnQucG9zWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB5ID0gc3BlYWtlckZvcm0ubW92ZW1lbnQucG9zWzFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB6ID0gc3BlYWtlckZvcm0ubW92ZW1lbnQucG9zWzJdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uUmVjZWl2ZVZvaWNlRGF0YShzcGVha2VySWRfMSwgYXVkaW9EYXRhLmJ1ZmZlciwgeCwgeSwgeik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy8gR2V0IGN1cnJlbnQgcHVzaC10by10YWxrIGtleVxyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUuZ2V0UHVzaFRvVGFsa0tleSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wdXNoVG9UYWxrS2V5O1xyXG4gICAgfTtcclxuICAgIC8vIFNldCBwdXNoLXRvLXRhbGsga2V5XHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5zZXRQdXNoVG9UYWxrS2V5ID0gZnVuY3Rpb24gKGtleSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzVGFsa2luZykge1xyXG4gICAgICAgICAgICB0aGlzLnN0b3BUYWxraW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucHVzaFRvVGFsa0tleSA9IGtleTtcclxuICAgIH07XHJcbiAgICAvLyBDaGVjayBpZiBjdXJyZW50bHkgdGFsa2luZ1xyXG4gICAgVm9pY2VDaGF0U2VydmljZS5wcm90b3R5cGUuZ2V0SXNUYWxraW5nID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzVGFsa2luZztcclxuICAgIH07XHJcbiAgICAvLyBDaGVjayBpZiB2b2ljZSBjaGF0IGlzIGluaXRpYWxpemVkXHJcbiAgICBWb2ljZUNoYXRTZXJ2aWNlLnByb3RvdHlwZS5nZXRJc0luaXRpYWxpemVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzSW5pdGlhbGl6ZWQ7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFZvaWNlQ2hhdFNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgVm9pY2VDaGF0U2VydmljZSB9O1xyXG4iLCJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZXh0ZW5kU3RhdGljcyA9IGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxyXG4gICAgICAgICAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChkLCBiKSB7IGZvciAodmFyIHAgaW4gYikgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChiLCBwKSkgZFtwXSA9IGJbcF07IH07XHJcbiAgICAgICAgcmV0dXJuIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChkLCBiKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSBcImZ1bmN0aW9uXCIgJiYgYiAhPT0gbnVsbClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNsYXNzIGV4dGVuZHMgdmFsdWUgXCIgKyBTdHJpbmcoYikgKyBcIiBpcyBub3QgYSBjb25zdHJ1Y3RvciBvciBudWxsXCIpO1xyXG4gICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XHJcbiAgICAgICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XHJcbiAgICAgICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xyXG4gICAgfTtcclxufSkoKTtcclxuaW1wb3J0IHsgQ2xpZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9jbGllbnRMaXN0ZW5lclwiO1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gXCIuLi8uLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4XCI7XHJcbmltcG9ydCB7IGxvZ1RyYWNlIH0gZnJvbSBcIi4uLy4uL2xvZ2dpbmdcIjtcclxudmFyIFdvcmxkQ2xlYW5lclNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoV29ybGRDbGVhbmVyU2VydmljZSwgX3N1cGVyKTtcclxuICAgIGZ1bmN0aW9uIFdvcmxkQ2xlYW5lclNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzO1xyXG4gICAgICAgIF90aGlzLnNwID0gc3A7XHJcbiAgICAgICAgX3RoaXMuY29udHJvbGxlciA9IGNvbnRyb2xsZXI7XHJcbiAgICAgICAgX3RoaXMucHJvdGVjdGlvbiA9IG5ldyBNYXAoKTtcclxuICAgICAgICBfdGhpcy5jb250cm9sbGVyLm9uKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uVXBkYXRlKCk7IH0pO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIuZW1pdHRlci5vbihcImdhbWVMb2FkXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uR2FtZUxvYWQoKTsgfSk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzO1xyXG4gICAgfVxyXG4gICAgV29ybGRDbGVhbmVyU2VydmljZS5wcm90b3R5cGUubW9kV2NQcm90ZWN0aW9uID0gZnVuY3Rpb24gKGFjdG9ySWQsIG1vZCkge1xyXG4gICAgICAgIHZhciBjdXJyZW50UHJvdGVjdGlvbiA9IHRoaXMucHJvdGVjdGlvbi5nZXQoYWN0b3JJZCk7XHJcbiAgICAgICAgdGhpcy5wcm90ZWN0aW9uLnNldChhY3RvcklkLCBjdXJyZW50UHJvdGVjdGlvbiA/IGN1cnJlbnRQcm90ZWN0aW9uICsgbW9kIDogbW9kKTtcclxuICAgIH07XHJcbiAgICBXb3JsZENsZWFuZXJTZXJ2aWNlLnByb3RvdHlwZS5nZXRXY1Byb3RlY3Rpb24gPSBmdW5jdGlvbiAoYWN0b3JJZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByb3RlY3Rpb24uZ2V0KGFjdG9ySWQpIHx8IDA7XHJcbiAgICB9O1xyXG4gICAgV29ybGRDbGVhbmVyU2VydmljZS5wcm90b3R5cGUub25HYW1lTG9hZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgcGxheWVyID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIGlmICghcGxheWVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbml0aWFsUG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKHBsYXllcik7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsQ2VsbE9yV29ybGQgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRXb3JsZE9yQ2VsbChwbGF5ZXIpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkQ2xlYW5lclNlcnZpY2UucHJvdG90eXBlLm9uVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc09uZUFjdG9yKCk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRDbGVhbmVyU2VydmljZS5wcm90b3R5cGUucHJvY2Vzc09uZUFjdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBwYyA9IHRoaXMuc3AuR2FtZS5nZXRQbGF5ZXIoKTtcclxuICAgICAgICBpZiAocGMgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYWN0b3IgPSB0aGlzLnNwLkdhbWUuZmluZFJhbmRvbUFjdG9yKHBjLmdldFBvc2l0aW9uWCgpLCBwYy5nZXRQb3NpdGlvblkoKSwgcGMuZ2V0UG9zaXRpb25aKCksIDgxOTIpO1xyXG4gICAgICAgIGlmIChhY3RvciA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhY3RvcklkID0gYWN0b3IuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgdmFyIGN1cnJlbnRQcm90ZWN0aW9uID0gdGhpcy5wcm90ZWN0aW9uLmdldChhY3RvcklkKSB8fCAwO1xyXG4gICAgICAgIGlmIChjdXJyZW50UHJvdGVjdGlvbiA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYWN0b3JJZCA9PT0gMHgxNCB8fCBhY3Rvci5pc0Rpc2FibGVkKCkgfHwgYWN0b3IuaXNEZWxldGVkKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5pc0FjdG9ySW5EaWFsb2d1ZShhY3RvcikpIHtcclxuICAgICAgICAgICAgLy8gRGVsZXRpbmcgYWN0b3IgaW4gZGlhbG9ndWUgY3Jhc2hlcyBTa3lyaW1cclxuICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3NreXJpbS1tdWx0aXBsYXllci9pc3N1ZS10cmFja2VyL2lzc3Vlcy8xM1xyXG4gICAgICAgICAgICBhY3Rvci5zZXRQb3NpdGlvbigwLCAwLCAwKTtcclxuICAgICAgICAgICAgYWN0b3IuZGlzYWJsZU5vV2FpdCh0cnVlKTsgLy8gU2VlbXMgdG8gbm90IGNyYXNoXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gS2VlcCB2YW5pbGEgcHJlLXBsYWNlZCBib2RpZXMsIGJ1dCBkZWxldGUgcGxheWVyIGJvZGllc1xyXG4gICAgICAgIGlmIChhY3Rvci5pc0RlYWQoKSAmJiBhY3RvcklkIDwgMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICBhY3Rvci5ibG9ja0FjdGl2YXRpb24odHJ1ZSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhhY3Rvcik7XHJcbiAgICAgICAgdmFyIGNlbGxPcldvcmxkID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwoYWN0b3IpO1xyXG4gICAgICAgIHZhciBjaGlja2VuUmFjZSA9IDB4YTkxOWQ7XHJcbiAgICAgICAgLy8gV2UgZGlzY292ZXJlZCBhbm9tYWx5IGNoaWNrZW5zIHRoYXQgZmFpbCB0byBEaXNhYmxlIGlmIHdlIGxvYWQgZ2FtZSBuZWFyIHRvIHRoZW1cclxuICAgICAgICAvLyBSZWZzOiAxMDZDMjIsIDEwNkMyM1xyXG4gICAgICAgIGlmIChhY3RvcklkIDwgMHhmZjAwMDAwMCAmJiAoKF9hID0gYWN0b3IuZ2V0UmFjZSgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Rm9ybUlEKCkpID09PSBjaGlja2VuUmFjZSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbml0aWFsUG9zICYmIE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlTm9aKHBvcywgdGhpcy5pbml0aWFsUG9zKSA8IDQwOTYpIHtcclxuICAgICAgICAgICAgICAgIGlmIChjZWxsT3JXb3JsZCA9PT0gdGhpcy5pbml0aWFsQ2VsbE9yV29ybGQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0FjdG9ySW5EaWFsb2d1ZShhY3RvcikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCBcIkRlbGV0aW5nIGNoaWNrZW4gYW5vbWFseVwiLCBhY3RvcklkLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0b3Iua2lsbFNpbGVudChudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICBhY3Rvci5ibG9ja0FjdGl2YXRpb24odHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0b3IuZGlzYWJsZU5vV2FpdChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0b3Iuc2V0QWxwaGEoMCwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBhY3Rvci5kaXNhYmxlKGZhbHNlKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFjID0gX3RoaXMuc3AuQWN0b3IuZnJvbShfdGhpcy5zcC5HYW1lLmdldEZvcm1FeChhY3RvcklkKSk7XHJcbiAgICAgICAgICAgIGlmICghYWMgfHwgX3RoaXMuaXNBY3RvckluRGlhbG9ndWUoYWMpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYWMuZGVsZXRlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRDbGVhbmVyU2VydmljZS5wcm90b3R5cGUuaXNBY3RvckluRGlhbG9ndWUgPSBmdW5jdGlvbiAoYWMpIHtcclxuICAgICAgICByZXR1cm4gYWMuaXNJbkRpYWxvZ3VlV2l0aFBsYXllcigpIHx8IGFjLmdldERpYWxvZ3VlVGFyZ2V0KCkgIT09IG51bGw7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFdvcmxkQ2xlYW5lclNlcnZpY2U7XHJcbn0oQ2xpZW50TGlzdGVuZXIpKTtcclxuZXhwb3J0IHsgV29ybGRDbGVhbmVyU2VydmljZSB9O1xyXG4iLCJpbXBvcnQgeyBFdmVudEVtaXR0ZXJGYWN0b3J5IH0gZnJvbSBcIi4vZXZlbnRzL2V2ZW50c1wiO1xyXG5pbXBvcnQgKiBhcyBzcCBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxudmFyIFNwQXBpSW50ZXJhY3RvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIFNwQXBpSW50ZXJhY3RvcigpIHtcclxuICAgIH1cclxuICAgIFNwQXBpSW50ZXJhY3Rvci5zZXR1cCA9IGZ1bmN0aW9uIChsaXN0ZW5lcnMpIHtcclxuICAgICAgICBsaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAobGlzdGVuZXIpIHsgcmV0dXJuIFNwQXBpSW50ZXJhY3Rvci5yZWdpc3Rlckxpc3RlbmVyRm9yTG9va3VwKGxpc3RlbmVyLmNvbnN0cnVjdG9yLCBsaXN0ZW5lcik7IH0pO1xyXG4gICAgfTtcclxuICAgIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKFNwQXBpSW50ZXJhY3Rvci5jb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBTcEFwaUludGVyYWN0b3IuY29udHJvbGxlcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmNvbnRyb2xsZXIgPSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IGhhbmRsZSBlcnJvcnMgaW4gZXZlbnQgaGFuZGxlcnMuIHdpbGwgb3V0cHV0IHRvIGdhbWUgY29uc29sZSBieSBkZWZhdWx0XHJcbiAgICAgICAgICAgIG9uOiBzcC5vbixcclxuICAgICAgICAgICAgb25jZTogc3Aub25jZSxcclxuICAgICAgICAgICAgZW1pdHRlcjogRXZlbnRFbWl0dGVyRmFjdG9yeS5tYWtlRXZlbnRFbWl0dGVyKCksXHJcbiAgICAgICAgICAgIGxvb2t1cExpc3RlbmVyOiBmdW5jdGlvbiAoY29uc3RydWN0b3IpIHtcclxuICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lciA9IFNwQXBpSW50ZXJhY3Rvci5saXN0ZW5lcnNGb3JMb29rdXBCeU5hbWUuZ2V0KGNvbnN0cnVjdG9yKTtcclxuICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwibGlzdGVuZXIgbm90IGZvdW5kIGZvciBuYW1lICdcIi5jb25jYXQoY29uc3RydWN0b3IubmFtZSwgXCInXCIpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghKGxpc3RlbmVyIGluc3RhbmNlb2YgY29uc3RydWN0b3IpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwibGlzdGVuZXIgY2xhc3MgbWlzbWF0Y2ggZm9yIG5hbWUgJ1wiLmNvbmNhdChjb25zdHJ1Y3Rvci5uYW1lLCBcIidcIikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVyO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIFNwQXBpSW50ZXJhY3Rvci5jb250cm9sbGVyO1xyXG4gICAgfTtcclxuICAgIFNwQXBpSW50ZXJhY3Rvci5yZWdpc3Rlckxpc3RlbmVyRm9yTG9va3VwID0gZnVuY3Rpb24gKGNvbnN0cnVjdG9yLCBsaXN0ZW5lcikge1xyXG4gICAgICAgIGlmIChTcEFwaUludGVyYWN0b3IubGlzdGVuZXJzRm9yTG9va3VwQnlOYW1lLmhhcyhjb25zdHJ1Y3RvcikpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwibGlzdGVuZXIgcmUtcmVnaXN0cmF0aW9uIGZvciBuYW1lICdcIi5jb25jYXQoY29uc3RydWN0b3IsIFwiJ1wiKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFNwQXBpSW50ZXJhY3Rvci5saXN0ZW5lcnNGb3JMb29rdXBCeU5hbWUuc2V0KGNvbnN0cnVjdG9yLCBsaXN0ZW5lcik7XHJcbiAgICB9O1xyXG4gICAgU3BBcGlJbnRlcmFjdG9yLmxpc3RlbmVyc0Zvckxvb2t1cEJ5TmFtZSA9IG5ldyBNYXAoKTtcclxuICAgIHJldHVybiBTcEFwaUludGVyYWN0b3I7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IFNwQXBpSW50ZXJhY3RvciB9O1xyXG4iLCJleHBvcnQgdmFyIGdldEFjdG9yVmFsdWVzID0gZnVuY3Rpb24gKGFjKSB7XHJcbiAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgaGVhbHRoOiAwLCBzdGFtaW5hOiAwLCBtYWdpY2thOiAwIH07XHJcbiAgICB9XHJcbiAgICB2YXIgaGVhbHRoUGVyY2VudGFnZSA9IChhYy5pc0RlYWQoKSkgPyAwIDogYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoXCJoZWFsdGhcIik7XHJcbiAgICB2YXIgc3RhbWluYVBlcmNlbnRhZ2UgPSBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZShcInN0YW1pbmFcIik7XHJcbiAgICB2YXIgbWFnaWNrYVBlcmNlbnRhZ2UgPSBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZShcIm1hZ2lja2FcIik7XHJcbiAgICB2YXIgcmVzdWx0QWN0b3JWYWx1ZSA9IHtcclxuICAgICAgICBoZWFsdGg6IGhlYWx0aFBlcmNlbnRhZ2UsXHJcbiAgICAgICAgc3RhbWluYTogc3RhbWluYVBlcmNlbnRhZ2UsXHJcbiAgICAgICAgbWFnaWNrYTogbWFnaWNrYVBlcmNlbnRhZ2UsXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3VsdEFjdG9yVmFsdWU7XHJcbn07XHJcbmV4cG9ydCB2YXIgZ2V0TWF4aW11bUFjdG9yVmFsdWUgPSBmdW5jdGlvbiAoYWMsIGF2TmFtZSkge1xyXG4gICAgdmFyIGN1cnJlbnRQZXJjZW50YWdlID0gYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoYXZOYW1lKTtcclxuICAgIHJldHVybiBjdXJyZW50UGVyY2VudGFnZSA9PT0gMCA/XHJcbiAgICAgICAgYWMuZ2V0QmFzZUFjdG9yVmFsdWUoYXZOYW1lKSA6XHJcbiAgICAgICAgTWF0aC5jZWlsKGFjLmdldEFjdG9yVmFsdWUoYXZOYW1lKSAvIGN1cnJlbnRQZXJjZW50YWdlKTtcclxufTtcclxuZXhwb3J0IHZhciBzZXRBY3RvclZhbHVlUGVyY2VudGFnZSA9IGZ1bmN0aW9uIChhYywgYXZOYW1lLCBwZXJjZW50YWdlKSB7XHJcbiAgICAvLyBBY3RvciB2YWx1ZSBwZXJjZW50YWdlIGZvciBoZWFsdGggbWF5IGJlIGJlbG93IHplcm8gKC0xLjggZm9yIGV4YW1wbGUsIGl0IG1lYW5zIHUgaGF2ZSAtMTgwJSBoZWFsdGgpXHJcbiAgICB2YXIgY3VycmVudFBlcmNlbnRhZ2UgPSBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZShhdk5hbWUpO1xyXG4gICAgaWYgKGN1cnJlbnRQZXJjZW50YWdlID09PSBwZXJjZW50YWdlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdmFyIGN1cnJlbnRNYXhWYWx1ZSA9IGdldE1heGltdW1BY3RvclZhbHVlKGFjLCBhdk5hbWUpO1xyXG4gICAgdmFyIGRlbHRhUGVyY2VudGFnZSA9IHBlcmNlbnRhZ2UgLSBjdXJyZW50UGVyY2VudGFnZTtcclxuICAgIGlmIChkZWx0YVBlcmNlbnRhZ2UgPiAwKSB7XHJcbiAgICAgICAgYWMucmVzdG9yZUFjdG9yVmFsdWUoYXZOYW1lLCBkZWx0YVBlcmNlbnRhZ2UgKiBjdXJyZW50TWF4VmFsdWUpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoZGVsdGFQZXJjZW50YWdlIDwgMCkge1xyXG4gICAgICAgIGFjLmRhbWFnZUFjdG9yVmFsdWUoYXZOYW1lLCBkZWx0YVBlcmNlbnRhZ2UgKiBjdXJyZW50TWF4VmFsdWUpO1xyXG4gICAgfVxyXG59O1xyXG4iLCIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktZnVuY3Rpb24gKi9cclxuaW1wb3J0IHsgRGVidWcsIGhvb2tzLCBBY3RvciwgcHJpbnRDb25zb2xlLCBVdGlsaXR5LCBHYW1lLCBzdG9yYWdlLCBcclxuLy8gQHRzLWV4cGVjdC1lcnJvciAoVE9ETzogUmVtb3ZlIGluIDIuMTAuMClcclxuc2V0Q29sbGlzaW9uIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IGFwcGx5V2VhcERyYXduIH0gZnJvbSBcIi4vbW92ZW1lbnRBcHBseVwiO1xyXG5leHBvcnQgdmFyIEFuaW1hdGlvbkV2ZW50TmFtZTtcclxuKGZ1bmN0aW9uIChBbmltYXRpb25FdmVudE5hbWUpIHtcclxuICAgIEFuaW1hdGlvbkV2ZW50TmFtZVtcIlJhZ2RvbGxcIl0gPSBcIlJhZ2RvbGxcIjtcclxuICAgIEFuaW1hdGlvbkV2ZW50TmFtZVtcIkdldFVwQmVnaW5cIl0gPSBcIkdldFVwQmVnaW5cIjtcclxufSkoQW5pbWF0aW9uRXZlbnROYW1lIHx8IChBbmltYXRpb25FdmVudE5hbWUgPSB7fSkpO1xyXG47XHJcbnZhciBhbGxvd2VkSWRsZXMgPSBuZXcgQXJyYXkoKTtcclxudmFyIHJlZnNXaXRoRGVmYXVsdEFuaW1zRGlzYWJsZWQgPSBuZXcgU2V0KCk7XHJcbnZhciBhbGxvd2VkQW5pbXMgPSBuZXcgU2V0KCk7XHJcbnZhciBhY3RvclNpdEFuaW1zTG93ZXJDYXNlID0gW1xyXG4gICAgJ2lkbGVzdG9vbGVudGVycGxheWVyJyxcclxuICAgICdpZGxlc3Rvb2xlbnRlcicsXHJcbiAgICAnaWRsZXN0b29sZW50ZXJpbnN0YW50JyxcclxuICAgICdpZGxlY2hhaXJyaWdodGVudGVyJyxcclxuICAgICdpZGxlY2hhaXJsZWZ0ZW50ZXInLFxyXG4gICAgJ2lkbGVjaGFpcmZyb250ZW50ZXInLFxyXG4gICAgJ2lkbGVjaGFpcmVudGVyaW5zdGFudCcsXHJcbiAgICAnaWRsZWphcmxjaGFpcmVudGVyJyxcclxuICAgICdpZGxlamFybGNoYWlyZW50ZXJpbnN0YW50JyxcclxuICAgICdpZGxlc25vd2VsZnByaW5jZWNoYWlyZGlhbG9ndWUnLFxyXG4gICAgJ2lkbGVzbm93ZWxmcHJpbmNlY2hhaXJlbnRlcicsXHJcbiAgICAnaWRsZXNub3dlbGZwcmluY2VjaGFpcmVudGVyaW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRlbnRlcmluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkZnJvbnRlbnRlcicsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRsZWZ0ZW50ZXInLFxyXG4gICAgJ2lkbGVjaGFpcmNoaWxkcmlnaHRlbnRlcicsXHJcbl07XHJcbnZhciBhY3RvckdldFVwQW5pbXNMb3dlckNhc2UgPSBbXHJcbiAgICAnaWRsZXN0b29sYmFja2V4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcnJpZ2h0ZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlycmlnaHRxdWlja2V4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmxlZnRleGl0JyxcclxuICAgICdpZGxlY2hhaXJsZWZ0cXVpY2tleGl0JyxcclxuICAgICdpZGxlY2hhaXJmcm9udGV4aXQnLFxyXG4gICAgJ2lkbGVjaGFpcmZyb250cXVpY2tleGl0JyxcclxuICAgICdpZGxlY2hhaXJjaGlsZGZyb250ZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRsZWZ0ZXhpdCcsXHJcbiAgICAnaWRsZWNoYWlyY2hpbGRyaWdodGV4aXQnXHJcbl07XHJcbi8vIEl0J3MgY3JpdGljYWwgZm9yIHZhbHVlcyB0byBiZSB0aGUgY29ycmVjdCBjYXNlLCBub3QganVzdCBsb3dlcmNhc2UsIG90aGVyd2lzZSAnYWxsb3dlZElkbGVzJyBjaGVjayB3aWxsIGJyZWFrXHJcbi8vIFdlIGRvbid0IHdhbnQgdG8gbW9kaWZ5IHRoZSBjaGVjayBpdHNlbGYsIGJlY2F1c2UgaXQnbGwgYmUgc2xvd2VyXHJcbnZhciBhbmltT3ZlcnJpZGVzTG93ZXJDYXNlID0ge1xyXG4gICAgJ2lkbGVjaGFpcmJvb2tfb25lcGFnZSc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcnNob3VsZGVyZmxleCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2lkbGVjaGFpcndyaXRlJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlyYXJtc2Nyb3NzZWR2YXIxJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnY2hhaXJlYXRpbmdzdGFydF92YW1waXJlbWVhdCc6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgJ2NoYWlycmVhZGluZ3N0YXJ0JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnY2hhaXJ2YW1waXJlZWF0aW5nc3RhcnQnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdjaGFpcmRyaW5raW5nc3RhcnQnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgICdjaGFpcmVhdGluZ3N0YXJ0JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAvLyBUaGUgb25seSB0cmlwbGUgYW5pbWF0aW9uIHdlIGtub3cgZm9yIG5vdy4gT25lIGJhc2UgYW5pbSB0byBzaXQsIHRoZW4gdHdvIHRvIGVhdFxyXG4gICAgJ2NoYWlyZWF0aW5nc291cHN0YXJ0JzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZWVhdHNvdXAnOiAnSWRsZUNoYWlyRW50ZXJJbnN0YW50JyxcclxuICAgIC8vIE5vIG5lZWQgdG8gcmUtcGxheSB0aGUgYW5pbWF0aW9uLCB1c2UgaW5zdGFudCB2YXJpYW50IGZvciBzcGF3bmluZyBhY3RvcnNcclxuICAgIC8vIFRoaXMgaXMgbm90IGVzc2VudGlhbCwgYnV0IG1ha2VzIHRoZSBzeW5jIGZlZWwgbW9yZSBzbW9vdGguIFRoZSBsaXN0IGlzIG5vdCBjb21wbGV0ZS5cclxuICAgICdpZGxlY2hhaXJyaWdodGVudGVyJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlybGVmdGVudGVyJzogJ0lkbGVDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZWNoYWlyZnJvbnRlbnRlcic6ICdJZGxlQ2hhaXJFbnRlckluc3RhbnQnLFxyXG4gICAgLy8gVW50ZXN0ZWQgeWV0IGxvb2tzIGNvcnJlY3RcclxuICAgICdpZGxlc25vd2VsZnByaW5jZWZpcmVhbmRmb3JnZXQnOiAnSWRsZVNub3dFbGZQcmluY2VDaGFpckVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZXRhYmxlbXVnZW50ZXInOiAnSWRsZVRhYmxlRW50ZXJJbnN0YW50JyxcclxuICAgICdpZGxldGFibGVkcmlua2VudGVyJzogJ0lkbGVUYWJsZUVudGVySW5zdGFudCcsXHJcbiAgICAnaWRsZXRhYmxlZHJpbmthbmRtdWdlbnRlcic6ICdJZGxlVGFibGVFbnRlckluc3RhbnQnXHJcbn07XHJcbi8vIHVuY2xhc3NpZmllZDpcclxuLy8gSWRsZUNoYWlyRW50ZXJJbnN0YW50XHJcbi8vIElkbGVDaGFpckVudGVyU3RhcnRcclxuLy8gSWRsZUNoYWlyRW50ZXJTdG9wXHJcbi8vIElkbGVDaGFpckVudGVyVG9TaXRcclxuLy8gSWRsZUNoYWlyRXhpdFN0YXJ0XHJcbi8vIElkbGVDaGFpckV4aXRUb1N0YW5kXHJcbi8vIElkbGVDaGFpclNpdHRpbmdcclxuLy8gSWRsZUxlZnRDaGFpckVudGVyU3RhcnRcclxuLy8gQ2hhaXJJZGxlXHJcbi8vIElkbGVSaWdodENoYWlyRW50ZXJTdGFydFxyXG4vLyBJZGxlTGVmdENoYWlyRW50ZXJTdGFydFxyXG52YXIgaXNJZGxlID0gZnVuY3Rpb24gKGFuaW1FdmVudE5hbWUpIHtcclxuICAgIHZhciBhbmltRXZlbnROYW1lTG93ZXJDYXNlID0gYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgcmV0dXJuIChhbmltRXZlbnROYW1lTG93ZXJDYXNlID09PSBcIm1vdGlvbmRyaXZlbmlkbGVcIiB8fFxyXG4gICAgICAgIChhbmltRXZlbnROYW1lTG93ZXJDYXNlLnN0YXJ0c1dpdGgoXCJpZGxlXCIpICYmXHJcbiAgICAgICAgICAgIGFuaW1FdmVudE5hbWVMb3dlckNhc2UgIT09IFwiaWRsZXN0b3BcIiAmJlxyXG4gICAgICAgICAgICBhbmltRXZlbnROYW1lTG93ZXJDYXNlICE9PSBcImlkbGVmb3JjZWRlZmF1bHRzdGF0ZVwiKSk7XHJcbn07XHJcbmV4cG9ydCB2YXIgYXBwbHlBbmltYXRpb24gPSBmdW5jdGlvbiAocmVmciwgYW5pbSwgc3RhdGUpIHtcclxuICAgIGlmIChzdGF0ZS5sYXN0TnVtQ2hhbmdlcyA9PT0gYW5pbS5udW1DaGFuZ2VzKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgc3RhdGUubGFzdE51bUNoYW5nZXMgPSBhbmltLm51bUNoYW5nZXM7XHJcbiAgICBpZiAoc3RhdGUudXNlQW5pbU92ZXJyaWRlcykge1xyXG4gICAgICAgIHZhciBhbmltT3ZlcnJpZGUgPSBhbmltT3ZlcnJpZGVzTG93ZXJDYXNlW2FuaW0uYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpXTtcclxuICAgICAgICBpZiAoYW5pbU92ZXJyaWRlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgYW5pbS5hbmltRXZlbnROYW1lID0gYW5pbU92ZXJyaWRlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHZhciBhbmltRXZlbnROYW1lTG93ZXJDYXNlID0gYW5pbS5hbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAoaXNJZGxlKGFuaW0uYW5pbUV2ZW50TmFtZSkpIHtcclxuICAgICAgICBhbGxvd2VkSWRsZXMucHVzaChbcmVmci5nZXRGb3JtSUQoKSwgYW5pbS5hbmltRXZlbnROYW1lXSk7XHJcbiAgICB9XHJcbiAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgaWYgKGFuaW0uYW5pbUV2ZW50TmFtZSA9PT0gXCJTa3ltcEZha2VFcXVpcFwiKSB7XHJcbiAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgIGFwcGx5V2VhcERyYXduKGFjLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGFuaW0uYW5pbUV2ZW50TmFtZSA9PT0gXCJTa3ltcEZha2VVbmVxdWlwXCIpIHtcclxuICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgYXBwbHlXZWFwRHJhd24oYWMsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGFuaW0uYW5pbUV2ZW50TmFtZSA9PT0gXCJSYWdkb2xsXCIpIHtcclxuICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgaWYgKHN0b3JhZ2VbXCJhbmltYXRpb25GdW5jMVNldFwiXSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgc3RvcmFnZVtcImFuaW1hdGlvbkZ1bmMxXCJdKGFjKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGFjLnB1c2hBY3RvckF3YXkoYWMsIDApO1xyXG4gICAgICAgICAgICAgICAgYWMuc2V0QWN0b3JWYWx1ZShcIlZhcmlhYmxlMTBcIiwgLTEwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChyZWZzV2l0aERlZmF1bHRBbmltc0Rpc2FibGVkLmhhcyhyZWZyLmdldEZvcm1JRCgpKSkge1xyXG4gICAgICAgIGlmIChhbmltRXZlbnROYW1lTG93ZXJDYXNlLmluY2x1ZGVzKFwiYXR0YWNrXCIpKSB7XHJcbiAgICAgICAgICAgIGFsbG93ZWRBbmltcy5hZGQocmVmci5nZXRGb3JtSUQoKSArIFwiOlwiICsgYW5pbS5hbmltRXZlbnROYW1lKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBEZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQocmVmciwgYW5pbS5hbmltRXZlbnROYW1lKTtcclxuICAgIGlmIChhbmltLmFuaW1FdmVudE5hbWUgPT09IFwiR2V0VXBCZWdpblwiKSB7XHJcbiAgICAgICAgdmFyIHJlZnJJZF8xID0gcmVmci5nZXRGb3JtSUQoKTtcclxuICAgICAgICBVdGlsaXR5LndhaXQoMSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkXzEpKTtcclxuICAgICAgICAgICAgaWYgKGFjKSB7XHJcbiAgICAgICAgICAgICAgICBhYy5zZXRBY3RvclZhbHVlKFwiVmFyaWFibGUxMFwiLCAxMDAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKGFjdG9yU2l0QW5pbXNMb3dlckNhc2UuZmluZChmdW5jdGlvbiAoeCkgeyByZXR1cm4geCA9PT0gYW5pbUV2ZW50TmFtZUxvd2VyQ2FzZTsgfSkgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHNldENvbGxpc2lvbihyZWZyLmdldEZvcm1JRCgpLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgICBpZiAoYWN0b3JHZXRVcEFuaW1zTG93ZXJDYXNlLmZpbmQoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHggPT09IGFuaW1FdmVudE5hbWVMb3dlckNhc2U7IH0pICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBzZXRDb2xsaXNpb24ocmVmci5nZXRGb3JtSUQoKSwgdHJ1ZSk7XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCB2YXIgc2V0RGVmYXVsdEFuaW1zRGlzYWJsZWQgPSBmdW5jdGlvbiAocmVmcklkLCBkaXNhYmxlZCkge1xyXG4gICAgaWYgKGRpc2FibGVkKSB7XHJcbiAgICAgICAgcmVmc1dpdGhEZWZhdWx0QW5pbXNEaXNhYmxlZC5hZGQocmVmcklkKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHJlZnNXaXRoRGVmYXVsdEFuaW1zRGlzYWJsZWQuZGVsZXRlKHJlZnJJZCk7XHJcbiAgICB9XHJcbn07XHJcbnZhciBBbmltYXRpb25Tb3VyY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBBbmltYXRpb25Tb3VyY2UocmVmcikge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5yZWZySWQgPSAwO1xyXG4gICAgICAgIHRoaXMubnVtQ2hhbmdlcyA9IDA7XHJcbiAgICAgICAgdGhpcy5hbmltRXZlbnROYW1lID0gXCJcIjtcclxuICAgICAgICB0aGlzLndlYXBOb25EcmF3bkJsb2NrZXIgPSAwO1xyXG4gICAgICAgIHRoaXMud2VhcERyYXduQmxvY2tlciA9IDA7XHJcbiAgICAgICAgdGhpcy5zbmVha0Jsb2NrZXIgPSBudWxsO1xyXG4gICAgICAgIHRoaXMucmVmcklkID0gcmVmci5nZXRGb3JtSUQoKTtcclxuICAgICAgICBob29rcy5zZW5kQW5pbWF0aW9uRXZlbnQuYWRkKHtcclxuICAgICAgICAgICAgZW50ZXI6IGZ1bmN0aW9uICgpIHsgfSxcclxuICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChjdHgpIHtcclxuICAgICAgICAgICAgICAgIGlmIChjdHguc2VsZklkICE9PSBfdGhpcy5yZWZySWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIWN0eC5hbmltYXRpb25TdWNjZWVkZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBXb3JrYXJvdW5kLCBzZWUgY2FycnlBbmltU3lzdGVtLnRzIGluIGdhbWVtb2RlXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZS1zZW5zZXRpdmUgY2hlY2sgaGVyZSBmb3IgYmV0dGVyIHBlcmZvcm1hbmNlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN0eC5hbmltRXZlbnROYW1lICE9PSBcIk9mZnNldENhcnJ5QmFza2V0U3RhcnRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgX3RoaXMub25TZW5kQW5pbWF0aW9uRXZlbnQoY3R4LmFuaW1FdmVudE5hbWUpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgQW5pbWF0aW9uU291cmNlLnByb3RvdHlwZS5maWx0ZXJNb3ZlbWVudCA9IGZ1bmN0aW9uIChtb3YpIHtcclxuICAgICAgICBpZiAodGhpcy53ZWFwRHJhd25CbG9ja2VyID49IERhdGUubm93KCkpIHtcclxuICAgICAgICAgICAgbW92LmlzV2VhcERyYXduID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMud2VhcE5vbkRyYXduQmxvY2tlciA+PSBEYXRlLm5vdygpKSB7XHJcbiAgICAgICAgICAgIG1vdi5pc1dlYXBEcmF3biA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zbmVha0Jsb2NrZXIgPT09IG1vdi5pc1NuZWFraW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc25lYWtCbG9ja2VyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAodGhpcy5zbmVha0Jsb2NrZXIgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgbW92LmlzU25lYWtpbmcgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICh0aGlzLnNuZWFrQmxvY2tlciA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgbW92LmlzU25lYWtpbmcgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG1vdjtcclxuICAgIH07XHJcbiAgICBBbmltYXRpb25Tb3VyY2UucHJvdG90eXBlLmdldEFuaW1hdGlvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgX2EgPSB0aGlzLCBudW1DaGFuZ2VzID0gX2EubnVtQ2hhbmdlcywgYW5pbUV2ZW50TmFtZSA9IF9hLmFuaW1FdmVudE5hbWU7XHJcbiAgICAgICAgcmV0dXJuIHsgbnVtQ2hhbmdlczogbnVtQ2hhbmdlcywgYW5pbUV2ZW50TmFtZTogYW5pbUV2ZW50TmFtZSB9O1xyXG4gICAgfTtcclxuICAgIEFuaW1hdGlvblNvdXJjZS5wcm90b3R5cGUub25TZW5kQW5pbWF0aW9uRXZlbnQgPSBmdW5jdGlvbiAoYW5pbUV2ZW50TmFtZSkge1xyXG4gICAgICAgIGlmIChpZ25vcmVkQW5pbXMuaGFzKGFuaW1FdmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGxvd2VyID0gYW5pbUV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIHZhciBpc1RvcmNoRXZlbnQgPSBsb3dlci5pbmNsdWRlcyhcInRvcmNoXCIpO1xyXG4gICAgICAgIGlmIChhbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoXCJ1bmVxdWlwXCIpICYmICFpc1RvcmNoRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy53ZWFwTm9uRHJhd25CbG9ja2VyID0gRGF0ZS5ub3coKSArIDMwMDtcclxuICAgICAgICAgICAgYW5pbUV2ZW50TmFtZSA9IFwiU2t5bXBGYWtlVW5lcXVpcFwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChhbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoXCJlcXVpcFwiKSAmJiAhaXNUb3JjaEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMud2VhcERyYXduQmxvY2tlciA9IERhdGUubm93KCkgKyAzMDA7XHJcbiAgICAgICAgICAgIGFuaW1FdmVudE5hbWUgPSBcIlNreW1wRmFrZUVxdWlwXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhbmltRXZlbnROYW1lID09PSBcIlNuZWFrU3RhcnRcIikge1xyXG4gICAgICAgICAgICB0aGlzLnNuZWFrQmxvY2tlciA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFuaW1FdmVudE5hbWUgPT09IFwiU25lYWtTdG9wXCIpIHtcclxuICAgICAgICAgICAgdGhpcy5zbmVha0Jsb2NrZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm51bUNoYW5nZXMrKztcclxuICAgICAgICB0aGlzLmFuaW1FdmVudE5hbWUgPSBhbmltRXZlbnROYW1lO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBBbmltYXRpb25Tb3VyY2U7XHJcbn0oKSk7XHJcbmV4cG9ydCB7IEFuaW1hdGlvblNvdXJjZSB9O1xyXG52YXIgaWdub3JlZEFuaW1zID0gbmV3IFNldChbXHJcbiAgICBcIm1vdmVTdGFydFwiLFxyXG4gICAgXCJtb3ZlU3RvcFwiLFxyXG4gICAgXCJ0dXJuU3RvcFwiLFxyXG4gICAgXCJDeWNsaWNDcm9zc0JsZW5kXCIsXHJcbiAgICBcIkN5Y2xpY0ZyZWV6ZVwiLFxyXG4gICAgXCJUdXJuTGVmdFwiLFxyXG4gICAgXCJUdXJuUmlnaHRcIixcclxuXSk7XHJcbmV4cG9ydCB2YXIgc2V0dXBIb29rcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGhvb2tzLnNlbmRBbmltYXRpb25FdmVudC5hZGQoe1xyXG4gICAgICAgIGVudGVyOiBmdW5jdGlvbiAoY3R4KSB7XHJcbiAgICAgICAgICAgIGlmIChyZWZzV2l0aERlZmF1bHRBbmltc0Rpc2FibGVkLmhhcyhjdHguc2VsZklkKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGN0eC5hbmltRXZlbnROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoXCJhdHRhY2tcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYW5pbUtleSA9IGN0eC5zZWxmSWQgKyBcIjpcIiArIGN0eC5hbmltRXZlbnROYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhbGxvd2VkQW5pbXMuaGFzKGFuaW1LZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93ZWRBbmltcy5kZWxldGUoYW5pbUtleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJibG9jayBhbmltIFwiICsgY3R4LmFuaW1FdmVudE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGN0eC5hbmltRXZlbnROYW1lID0gXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIFNob3dSYWNlTWVudSBmb3JjZXMgdGhpcyBhbmltXHJcbiAgICAgICAgICAgIGlmIChjdHguYW5pbUV2ZW50TmFtZSA9PT0gXCJPZmZzZXRCb3VuZFN0YW5kaW5nUGxheWVySW5zdGFudFwiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gKGN0eC5hbmltRXZlbnROYW1lID0gXCJcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gRGlzYWJsZSBpZGxlIGFuaW1hdGlvbnMgZm9yIDB4ZmYgYWN0b3JzXHJcbiAgICAgICAgICAgIGlmIChjdHguc2VsZklkIDwgMHhmZjAwMDAwMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpc0lkbGUoY3R4LmFuaW1FdmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaSA9IGFsbG93ZWRJZGxlcy5maW5kSW5kZXgoZnVuY3Rpb24gKHBhaXIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFpclswXSA9PT0gY3R4LnNlbGZJZCAmJiBwYWlyWzFdID09PSBjdHguYW5pbUV2ZW50TmFtZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaSA9PT0gLTEgPyAoY3R4LmFuaW1FdmVudE5hbWUgPSBcIlwiKSA6IGFsbG93ZWRJZGxlcy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICB9KTtcclxufTtcclxuIiwiaW1wb3J0IHsgQWN0b3JCYXNlLCBHYW1lLCBURVNNb2RQbGF0Zm9ybSwgUmFjZSwgSGVhZFBhcnQsIFRleHR1cmVTZXQsIHByaW50Q29uc29sZSwgVm9pY2VUeXBlLCBvbmNlLCBVdGlsaXR5LCB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5leHBvcnQgdmFyIGdldEFwcGVhcmFuY2UgPSBmdW5jdGlvbiAoYWN0b3IpIHtcclxuICAgIHZhciBiYXNlID0gQWN0b3JCYXNlLmZyb20oYWN0b3IuZ2V0QmFzZU9iamVjdCgpKTtcclxuICAgIHZhciBoYWlyQ29sb3IgPSBiYXNlLmdldEhhaXJDb2xvcigpO1xyXG4gICAgdmFyIHNraW5Db2xvciA9IFRFU01vZFBsYXRmb3JtLmdldFNraW5Db2xvcihiYXNlKTtcclxuICAgIHZhciBuZXdBcHBlYXJhbmNlID0ge1xyXG4gICAgICAgIGlzRmVtYWxlOiBiYXNlLmdldFNleCgpID09PSAxLFxyXG4gICAgICAgIHJhY2VJZDogYmFzZS5nZXRSYWNlKCkgPyBiYXNlLmdldFJhY2UoKS5nZXRGb3JtSUQoKSA6IDAsXHJcbiAgICAgICAgd2VpZ2h0OiBiYXNlLmdldFdlaWdodCgpLFxyXG4gICAgICAgIGhhaXJDb2xvcjogaGFpckNvbG9yID8gaGFpckNvbG9yLmdldENvbG9yKCkgOiAwLFxyXG4gICAgICAgIGhlYWRwYXJ0SWRzOiBbXSxcclxuICAgICAgICBoZWFkVGV4dHVyZVNldElkOiBiYXNlLmdldEZhY2VUZXh0dXJlU2V0KClcclxuICAgICAgICAgICAgPyBiYXNlLmdldEZhY2VUZXh0dXJlU2V0KCkuZ2V0Rm9ybUlEKClcclxuICAgICAgICAgICAgOiAwLFxyXG4gICAgICAgIG9wdGlvbnM6IG5ldyBBcnJheSgxOSksXHJcbiAgICAgICAgcHJlc2V0czogbmV3IEFycmF5KDQpLFxyXG4gICAgICAgIHRpbnRzOiBbXSxcclxuICAgICAgICBza2luQ29sb3I6IHNraW5Db2xvciA/IHNraW5Db2xvci5nZXRDb2xvcigpIDogMCxcclxuICAgICAgICBuYW1lOiBhY3Rvci5nZXRCYXNlT2JqZWN0KCkuZ2V0TmFtZSgpLFxyXG4gICAgfTtcclxuICAgIHZhciBudW1IZWFkcGFydHMgPSBiYXNlLmdldE51bUhlYWRQYXJ0cygpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1IZWFkcGFydHM7ICsraSkge1xyXG4gICAgICAgIHZhciBwYXJ0ID0gYmFzZS5nZXROdGhIZWFkUGFydChpKTtcclxuICAgICAgICBpZiAocGFydCkge1xyXG4gICAgICAgICAgICBuZXdBcHBlYXJhbmNlLmhlYWRwYXJ0SWRzLnB1c2gocGFydC5nZXRGb3JtSUQoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdBcHBlYXJhbmNlLm9wdGlvbnMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICBuZXdBcHBlYXJhbmNlLm9wdGlvbnNbaV0gPSBiYXNlLmdldEZhY2VNb3JwaChpKTtcclxuICAgIH1cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3QXBwZWFyYW5jZS5wcmVzZXRzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgbmV3QXBwZWFyYW5jZS5wcmVzZXRzW2ldID0gYmFzZS5nZXRGYWNlUHJlc2V0KGkpO1xyXG4gICAgfVxyXG4gICAgdmFyIG51bVRpbnRzID0gR2FtZS5nZXRQbGF5ZXIoKS5nZXRGb3JtSUQoKSA9PT0gYWN0b3IuZ2V0Rm9ybUlEKClcclxuICAgICAgICA/IEdhbWUuZ2V0TnVtVGludE1hc2tzKClcclxuICAgICAgICA6IDA7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bVRpbnRzOyArK2kpIHtcclxuICAgICAgICB2YXIgdGludCA9IHtcclxuICAgICAgICAgICAgdGV4dHVyZVBhdGg6IEdhbWUuZ2V0TnRoVGludE1hc2tUZXh0dXJlUGF0aChpKSxcclxuICAgICAgICAgICAgdHlwZTogR2FtZS5nZXROdGhUaW50TWFza1R5cGUoaSksXHJcbiAgICAgICAgICAgIGFyZ2I6IEdhbWUuZ2V0TnRoVGludE1hc2tDb2xvcihpKSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIG5ld0FwcGVhcmFuY2UudGludHMucHVzaCh0aW50KTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXdBcHBlYXJhbmNlO1xyXG59O1xyXG52YXIgaXNWaXNpYmxlID0gZnVuY3Rpb24gKGFyZ2IpIHsgcmV0dXJuIGFyZ2IgPiAweDAwZmZmZmZmIHx8IGFyZ2IgPCAwOyB9O1xyXG5leHBvcnQgdmFyIGFwcGx5VGludHMgPSBmdW5jdGlvbiAoYWN0b3IsIGFwcGVhcmFuY2UpIHtcclxuICAgIGlmICghYXBwZWFyYW5jZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIm51bGwgYXBwZWFyYW5jZSBoYXMgYmVlbiBwYXNzZWQgdG8gYXBwbHlUaW50c1wiKTtcclxuICAgIH1cclxuICAgIHZhciB0aW50cyA9IGFwcGVhcmFuY2UudGludHMuZmlsdGVyKGZ1bmN0aW9uICh0KSB7IHJldHVybiBpc1Zpc2libGUodC5hcmdiKTsgfSk7XHJcbiAgICB2YXIgcmFjZVdhclBhaW50UmVnZXggPSAvLipIZWFkLitXYXJQYWludC4qLztcclxuICAgIHZhciB1bmlXYXJQYWludFJlZ2V4ID0gLy4qSGVhZFdhclBhaW50LiovO1xyXG4gICAgdmFyIHJhY2VTcGVjaWZpY1dhclBhaW50ID0gdGludHMuZmlsdGVyKGZ1bmN0aW9uICh0KSB7IHJldHVybiBpc1Zpc2libGUodC5hcmdiKSAmJiB0LnRleHR1cmVQYXRoLm1hdGNoKHJhY2VXYXJQYWludFJlZ2V4KTsgfSkubGVuZ3RoOyAvLyBNYWxlSGVhZE5vcmRXYXJQYWludFxyXG4gICAgdmFyIHVuaVdhclBhaW50ID0gdGludHMuZmlsdGVyKGZ1bmN0aW9uICh0KSB7IHJldHVybiBpc1Zpc2libGUodC5hcmdiKSAmJiB0LnRleHR1cmVQYXRoLm1hdGNoKHVuaVdhclBhaW50UmVnZXgpOyB9KS5sZW5ndGg7IC8vIE1hbGVIZWFkV2FyUGFpbnRcclxuICAgIGlmIChyYWNlU3BlY2lmaWNXYXJQYWludCArIHVuaVdhclBhaW50ID4gMSkge1xyXG4gICAgICAgIC8vIElmIHZpc2libGUgd2FyIHBhaW50cyBvZiB0aGVzZSB0d28gdHlwZXMgcHJlc2VudCwgdGhlbiBTa3lyaW0gY3Jhc2hlc1xyXG4gICAgICAgIHByaW50Q29uc29sZShcImJhZCB3YXJwYWludCFcIiwgcmFjZVNwZWNpZmljV2FyUGFpbnQsIHVuaVdhclBhaW50KTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBURVNNb2RQbGF0Zm9ybS5jbGVhclRpbnRNYXNrcyhhY3Rvcik7XHJcbiAgICB0aW50cy5mb3JFYWNoKGZ1bmN0aW9uICh0aW50KSB7XHJcbiAgICAgICAgVEVTTW9kUGxhdGZvcm0ucHVzaFRpbnRNYXNrKGFjdG9yLCB0aW50LnR5cGUsIHRpbnQuYXJnYiwgdGludC50ZXh0dXJlUGF0aCk7XHJcbiAgICB9KTtcclxuICAgIHZhciBwbGF5ZXJCYXNlSWQgPSBHYW1lLmdldFBsYXllcigpLmdldEJhc2VPYmplY3QoKS5nZXRGb3JtSUQoKTtcclxuICAgIGlmIChhY3RvcilcclxuICAgICAgICBURVNNb2RQbGF0Zm9ybS5zZXRGb3JtSWRVbnNhZmUoYWN0b3IuZ2V0QmFzZU9iamVjdCgpLCBwbGF5ZXJCYXNlSWQpO1xyXG59O1xyXG5leHBvcnQgdmFyIHNpbGVudFZvaWNlVHlwZUlkID0gMHgwMDAyZjdjMztcclxudmFyIGFwcGx5QXBwZWFyYW5jZUNvbW1vbiA9IGZ1bmN0aW9uIChhcHBlYXJhbmNlLCBucGMpIHtcclxuICAgIHZhciByYWNlID0gUmFjZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGFwcGVhcmFuY2UucmFjZUlkKSk7XHJcbiAgICB2YXIgaGVhZHBhcnRzID0gYXBwZWFyYW5jZS5oZWFkcGFydElkc1xyXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGlkKSB7IHJldHVybiBIZWFkUGFydC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGlkKSk7IH0pXHJcbiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoaGVhZHBhcnQpIHsgcmV0dXJuICEhaGVhZHBhcnQ7IH0pO1xyXG4gICAgVEVTTW9kUGxhdGZvcm0uc2V0TnBjU2V4KG5wYywgYXBwZWFyYW5jZS5pc0ZlbWFsZSA/IDEgOiAwKTtcclxuICAgIGlmIChyYWNlKSB7XHJcbiAgICAgICAgVEVTTW9kUGxhdGZvcm0uc2V0TnBjUmFjZShucGMsIHJhY2UpO1xyXG4gICAgfVxyXG4gICAgbnBjLnNldFdlaWdodChhcHBlYXJhbmNlLndlaWdodCk7XHJcbiAgICBURVNNb2RQbGF0Zm9ybS5zZXROcGNTa2luQ29sb3IobnBjLCBhcHBlYXJhbmNlLnNraW5Db2xvcik7XHJcbiAgICBURVNNb2RQbGF0Zm9ybS5zZXROcGNIYWlyQ29sb3IobnBjLCBhcHBlYXJhbmNlLmhhaXJDb2xvcik7XHJcbiAgICBURVNNb2RQbGF0Zm9ybS5yZXNpemVIZWFkcGFydHNBcnJheShucGMsIGhlYWRwYXJ0cy5sZW5ndGgpO1xyXG4gICAgaGVhZHBhcnRzLmZvckVhY2goZnVuY3Rpb24gKHYsIGkpIHsgcmV0dXJuIG5wYy5zZXROdGhIZWFkUGFydCh2LCBpKTsgfSk7XHJcbiAgICBucGMuc2V0RmFjZVRleHR1cmVTZXQoVGV4dHVyZVNldC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KGFwcGVhcmFuY2UuaGVhZFRleHR1cmVTZXRJZCkpKTsgLy8gc2V0RmFjZVRleHR1cmVTZXQgc3VwcG9ydHMgbnVsbCBhcmd1bWVudFxyXG4gICAgbnBjLnNldFZvaWNlVHlwZShWb2ljZVR5cGUuZnJvbShHYW1lLmdldEZvcm1FeChzaWxlbnRWb2ljZVR5cGVJZCkpKTtcclxuICAgIGFwcGVhcmFuY2Uub3B0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uICh2LCBpKSB7IHJldHVybiBucGMuc2V0RmFjZU1vcnBoKHYsIGkpOyB9KTtcclxuICAgIGFwcGVhcmFuY2UucHJlc2V0cy5mb3JFYWNoKGZ1bmN0aW9uICh2LCBpKSB7IHJldHVybiBucGMuc2V0RmFjZVByZXNldCh2LCBpKTsgfSk7XHJcbiAgICBpZiAoYXBwZWFyYW5jZS5uYW1lKSB7XHJcbiAgICAgICAgbnBjLnNldE5hbWUoYXBwZWFyYW5jZS5uYW1lKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIC8vIGZvciB1bmRlZmluZWQgb3IgZW1wdHkgbmFtZVxyXG4gICAgICAgIG5wYy5zZXROYW1lKFwiIFwiKTtcclxuICAgIH1cclxufTtcclxuZXhwb3J0IHZhciBhcHBseUFwcGVhcmFuY2UgPSBmdW5jdGlvbiAoYXBwZWFyYW5jZSkge1xyXG4gICAgdmFyIG5wYyA9IFRFU01vZFBsYXRmb3JtLmNyZWF0ZU5wYygpO1xyXG4gICAgaWYgKCFucGMpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJjcmVhdGVOcGMgcmV0dXJuZWQgbnVsbFwiKTtcclxuICAgIH1cclxuICAgIGFwcGx5QXBwZWFyYW5jZUNvbW1vbihhcHBlYXJhbmNlLCBucGMpO1xyXG4gICAgcmV0dXJuIG5wYztcclxufTtcclxuZXhwb3J0IHZhciBhcHBseUFwcGVhcmFuY2VUb1BsYXllciA9IGZ1bmN0aW9uIChhcHBlYXJhbmNlKSB7XHJcbiAgICBhcHBseUFwcGVhcmFuY2VDb21tb24oYXBwZWFyYW5jZSwgQWN0b3JCYXNlLmZyb20oR2FtZS5nZXRQbGF5ZXIoKS5nZXRCYXNlT2JqZWN0KCkpKTtcclxuICAgIGFwcGx5VGludHMobnVsbCwgYXBwZWFyYW5jZSk7XHJcbiAgICBHYW1lLmdldFBsYXllcigpLnF1ZXVlTmlOb2RlVXBkYXRlKCk7XHJcbiAgICBVdGlsaXR5LndhaXQoMC4wNjI1KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBvbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgICAgICAoX2EgPSBHYW1lLmdldFBsYXllcigpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc3RhcnREZWZlcnJlZEtpbGwoKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59O1xyXG4iLCJpbXBvcnQgeyBBY3RvciwgQW1tbywgR2FtZSwgU3BlbGwsIFVpLCBzZXRJbnZlbnRvcnksIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBnZXRJbnZlbnRvcnkgfSBmcm9tICcuL2ludmVudG9yeSc7XHJcbmV4cG9ydCB2YXIgZ2V0RXF1aXBlZFNwZWxsID0gZnVuY3Rpb24gKHJlZnIsIHNwZWxsVHlwZSkge1xyXG4gICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgIGlmICghYWN0b3IpIHtcclxuICAgICAgICByZXR1cm4gMDtcclxuICAgIH1cclxuICAgIHN3aXRjaCAoc3BlbGxUeXBlKSB7XHJcbiAgICAgICAgY2FzZSAwIC8qIFNwZWxsVHlwZS5MZWZ0ICovOiB7XHJcbiAgICAgICAgICAgIHZhciBzcGVsbCA9IGFjdG9yLmdldEVxdWlwcGVkU3BlbGwoMCAvKiBTcGVsbFR5cGUuTGVmdCAqLyk7XHJcbiAgICAgICAgICAgIHJldHVybiBzcGVsbCA/IHNwZWxsLmdldEZvcm1JRCgpIDogMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAxIC8qIFNwZWxsVHlwZS5SaWdodCAqLzoge1xyXG4gICAgICAgICAgICB2YXIgc3BlbGwgPSBhY3Rvci5nZXRFcXVpcHBlZFNwZWxsKDEgLyogU3BlbGxUeXBlLlJpZ2h0ICovKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNwZWxsID8gc3BlbGwuZ2V0Rm9ybUlEKCkgOiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlIDIgLyogU3BlbGxUeXBlLlZvaWNlICovOiB7XHJcbiAgICAgICAgICAgIHZhciBzcGVsbCA9IGFjdG9yLmdldEVxdWlwcGVkU3BlbGwoMiAvKiBTcGVsbFR5cGUuVm9pY2UgKi8pO1xyXG4gICAgICAgICAgICByZXR1cm4gc3BlbGwgPyBzcGVsbC5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgMyAvKiBTcGVsbFR5cGUuSW5zdGFudCAqLzoge1xyXG4gICAgICAgICAgICB2YXIgc3BlbGwgPSBhY3Rvci5nZXRFcXVpcHBlZFNwZWxsKDMgLyogU3BlbGxUeXBlLkluc3RhbnQgKi8pO1xyXG4gICAgICAgICAgICByZXR1cm4gc3BlbGwgPyBzcGVsbC5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG52YXIgZmlsdGVyV29ybiA9IGZ1bmN0aW9uIChpbnYpIHtcclxuICAgIHJldHVybiB7IGVudHJpZXM6IGludi5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoeCkgeyByZXR1cm4geC53b3JuIHx8IHgud29ybkxlZnQ7IH0pIH07XHJcbn07XHJcbnZhciByZW1vdmVVbm5lY2Vzc2FyeUV4dHJhID0gZnVuY3Rpb24gKGludiwgaWdub3JlQW1tbykge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBlbnRyaWVzOiBpbnYuZW50cmllcy5tYXAoZnVuY3Rpb24gKHgpIHtcclxuICAgICAgICAgICAgdmFyIHIgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHgpKTtcclxuICAgICAgICAgICAgci5jaGFyZ2VQZXJjZW50ID0gci5tYXhDaGFyZ2U7XHJcbiAgICAgICAgICAgIGlmIChpZ25vcmVBbW1vKSB7XHJcbiAgICAgICAgICAgICAgICByLmNvdW50ID0gQW1tby5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHguYmFzZUlkKSkgPyByLmNvdW50IDogMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHIuY291bnQgPSBBbW1vLmZyb20oR2FtZS5nZXRGb3JtRXgoeC5iYXNlSWQpKSA/IDEwMDAgOiAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlbGV0ZSByLm5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgIH0pLFxyXG4gICAgfTtcclxufTtcclxuZXhwb3J0IHZhciBnZXRFcXVpcG1lbnQgPSBmdW5jdGlvbiAoYWMsIG51bUNoYW5nZXMpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgaW52OiBnZXRJbnZlbnRvcnkoYWMpLFxyXG4gICAgICAgIGxlZnRTcGVsbDogZ2V0RXF1aXBlZFNwZWxsKGFjLCAwIC8qIFNwZWxsVHlwZS5MZWZ0ICovKSxcclxuICAgICAgICByaWdodFNwZWxsOiBnZXRFcXVpcGVkU3BlbGwoYWMsIDEgLyogU3BlbGxUeXBlLlJpZ2h0ICovKSxcclxuICAgICAgICB2b2ljZVNwZWxsOiBnZXRFcXVpcGVkU3BlbGwoYWMsIDIgLyogU3BlbGxUeXBlLlZvaWNlICovKSxcclxuICAgICAgICBpbnN0YW50U3BlbGw6IGdldEVxdWlwZWRTcGVsbChhYywgMyAvKiBTcGVsbFR5cGUuSW5zdGFudCAqLyksXHJcbiAgICAgICAgbnVtQ2hhbmdlczogbnVtQ2hhbmdlcyxcclxuICAgIH07XHJcbn07XHJcbmV4cG9ydCB2YXIgc3luY1NwZWxsRXF1aXBtZW50ID0gZnVuY3Rpb24gKGFjLCBzcGVsbEJhc2VJZCwgc3BlbGxUeXBlKSB7XHJcbiAgICBpZiAoc3BlbGxCYXNlSWQgIT09IHVuZGVmaW5lZCAmJiBzcGVsbEJhc2VJZCA+IDApIHtcclxuICAgICAgICBhYy5lcXVpcFNwZWxsKFNwZWxsLmZyb20oR2FtZS5nZXRGb3JtRXgoc3BlbGxCYXNlSWQpKSwgc3BlbGxUeXBlKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHZhciBlcXVpcGVkU3BlbGwgPSBhYy5nZXRFcXVpcHBlZFNwZWxsKHNwZWxsVHlwZSk7XHJcbiAgICAgICAgaWYgKGVxdWlwZWRTcGVsbCkge1xyXG4gICAgICAgICAgICBhYy51bmVxdWlwU3BlbGwoZXF1aXBlZFNwZWxsLCBzcGVsbFR5cGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuZXhwb3J0IHZhciBhcHBseUVxdWlwbWVudCA9IGZ1bmN0aW9uIChhYywgZXEpIHtcclxuICAgIGFjLnJlbW92ZUFsbEl0ZW1zKG51bGwsIGZhbHNlLCB0cnVlKTtcclxuICAgIGFjLnVuZXF1aXBBbGwoKTtcclxuICAgIGFjLnJlbW92ZUFsbEl0ZW1zKG51bGwsIGZhbHNlLCB0cnVlKTtcclxuICAgIHZhciBuZXdJbnZlbnRvcnkgPSByZW1vdmVVbm5lY2Vzc2FyeUV4dHJhKGZpbHRlcldvcm4oZXEuaW52KSwgYWMuZ2V0Rm9ybUlEKCkgPT09IDB4MTQpO1xyXG4gICAgc2V0SW52ZW50b3J5KGFjLmdldEZvcm1JRCgpLCBuZXdJbnZlbnRvcnkpO1xyXG4gICAgc3luY1NwZWxsRXF1aXBtZW50KGFjLCBlcS5sZWZ0U3BlbGwsIDAgLyogU3BlbGxUeXBlLkxlZnQgKi8pO1xyXG4gICAgc3luY1NwZWxsRXF1aXBtZW50KGFjLCBlcS5yaWdodFNwZWxsLCAxIC8qIFNwZWxsVHlwZS5SaWdodCAqLyk7XHJcbiAgICBzeW5jU3BlbGxFcXVpcG1lbnQoYWMsIGVxLnZvaWNlU3BlbGwsIDIgLyogU3BlbGxUeXBlLlZvaWNlICovKTtcclxuICAgIHN5bmNTcGVsbEVxdWlwbWVudChhYywgZXEuaW5zdGFudFNwZWxsLCAzIC8qIFNwZWxsVHlwZS5JbnN0YW50ICovKTtcclxuICAgIHJldHVybiB0cnVlO1xyXG59O1xyXG5leHBvcnQgdmFyIGlzQmFkTWVudVNob3duID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIChVaS5pc01lbnVPcGVuKCdJbnZlbnRvcnlNZW51JykgfHxcclxuICAgICAgICBVaS5pc01lbnVPcGVuKCdGYXZvcml0ZXNNZW51JykgfHxcclxuICAgICAgICBVaS5pc01lbnVPcGVuKCdNYWdpY01lbnUnKSB8fFxyXG4gICAgICAgIFVpLmlzTWVudU9wZW4oJ0NvbnRhaW5lck1lbnUnKSB8fFxyXG4gICAgICAgIFVpLmlzTWVudU9wZW4oJ0NyYWZ0aW5nIE1lbnUnKSAvLyBBY3R1YWxseSBJIGRvbid0IHRoaW5rIGl0IGNhdXNlcyBjcmFzaGVzXHJcbiAgICApO1xyXG59O1xyXG4iLCJpbXBvcnQgeyBnZXRFeHRyYUNvbnRhaW5lckNoYW5nZXMsIGdldENvbnRhaW5lciwgT2JqZWN0UmVmZXJlbmNlLCBURVNNb2RQbGF0Zm9ybSwgR2FtZSwgc3RvcmFnZSwgRW5jaGFudG1lbnQsIFBvdGlvbiwgQWN0b3IsIEFtbW8sIHByaW50Q29uc29sZSwgRm9ybSwgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuLy8gJ2xveHN3b3JkIChMZWdlbmRhcnkpJyA9PiAnbG94c3dvcmQnXHJcbnZhciBnZXRSZWFsTmFtZSA9IGZ1bmN0aW9uIChzKSB7XHJcbiAgICBpZiAoIXMpIHtcclxuICAgICAgICByZXR1cm4gcztcclxuICAgIH1cclxuICAgIHZhciBhcnIgPSBzLnNwbGl0KFwiIFwiKTtcclxuICAgIGlmIChhcnIubGVuZ3RoICYmIGFyclthcnIubGVuZ3RoIC0gMV0ubWF0Y2goL15cXCguKlxcKSQvKSkge1xyXG4gICAgICAgIGFyci5wb3AoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBhcnIuam9pbihcIiBcIik7XHJcbn07XHJcbi8vICdhYWFhYWFhYWFhYWFhYWFhJyA9PiAnYWFhLi4uJ1xyXG52YXIgY3JvcE5hbWUgPSBmdW5jdGlvbiAocykge1xyXG4gICAgaWYgKCFzKSB7XHJcbiAgICAgICAgcmV0dXJuIHM7XHJcbiAgICB9XHJcbiAgICB2YXIgbWF4ID0gMTI4O1xyXG4gICAgcmV0dXJuIHMubGVuZ3RoID49IG1heFxyXG4gICAgICAgID8gc1xyXG4gICAgICAgICAgICAuc3BsaXQoXCJcIilcclxuICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoeCwgaSkgeyByZXR1cm4gaSA8IG1heDsgfSlcclxuICAgICAgICAgICAgLmpvaW4oXCJcIilcclxuICAgICAgICAgICAgLmNvbmNhdChcIi4uLlwiKVxyXG4gICAgICAgIDogcztcclxufTtcclxudmFyIGNoZWNrSWZOYW1lSXNHZW5lcmF0ZWRCeUdhbWUgPSBmdW5jdGlvbiAoYVN0ciwgYlN0ciwgZm9ybU5hbWUpIHtcclxuICAgIGlmICghYVN0ci5sZW5ndGggJiYgYlN0ci5zdGFydHNXaXRoKGZvcm1OYW1lKSkge1xyXG4gICAgICAgIHZhciBiRW5kaW5nID0gYlN0ci5zdWJzdHIoZm9ybU5hbWUubGVuZ3RoKTtcclxuICAgICAgICBpZiAoYkVuZGluZy5tYXRjaCgvXlxcc1xcKC4qXFwpJC8pKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufTtcclxudmFyIG5hbWVzRXF1YWwgPSBmdW5jdGlvbiAoYSwgYikge1xyXG4gICAgdmFyIGFTdHIgPSBhLm5hbWUgfHwgXCJcIjtcclxuICAgIHZhciBiU3RyID0gYi5uYW1lIHx8IFwiXCI7XHJcbiAgICBpZiAoY3JvcE5hbWUoZ2V0UmVhbE5hbWUoYVN0cikpID09PSBjcm9wTmFtZShnZXRSZWFsTmFtZShiU3RyKSkpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIGlmIChhLmJhc2VJZCA9PT0gYi5iYXNlSWQpIHtcclxuICAgICAgICB2YXIgZm9ybSA9IEdhbWUuZ2V0Rm9ybUV4KGEuYmFzZUlkKTtcclxuICAgICAgICBpZiAoZm9ybSkge1xyXG4gICAgICAgICAgICB2YXIgZm9ybU5hbWUgPSBmb3JtLmdldE5hbWUoKTtcclxuICAgICAgICAgICAgaWYgKGNoZWNrSWZOYW1lSXNHZW5lcmF0ZWRCeUdhbWUoYVN0ciwgYlN0ciwgZm9ybU5hbWUpIHx8XHJcbiAgICAgICAgICAgICAgICBjaGVja0lmTmFtZUlzR2VuZXJhdGVkQnlHYW1lKGJTdHIsIGFTdHIsIGZvcm1OYW1lKSlcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufTtcclxudmFyIGV4dHJhc0VxdWFsID0gZnVuY3Rpb24gKGEsIGIsIGlnbm9yZVdvcm4pIHtcclxuICAgIGlmIChpZ25vcmVXb3JuID09PSB2b2lkIDApIHsgaWdub3JlV29ybiA9IGZhbHNlOyB9XHJcbiAgICByZXR1cm4gKGEuaGVhbHRoID09PSBiLmhlYWx0aCAmJlxyXG4gICAgICAgIGEuZW5jaGFudG1lbnRJZCA9PT0gYi5lbmNoYW50bWVudElkICYmXHJcbiAgICAgICAgYS5tYXhDaGFyZ2UgPT09IGIubWF4Q2hhcmdlICYmXHJcbiAgICAgICAgISFhLnJlbW92ZUVuY2hhbnRtZW50T25VbmVxdWlwID09PSAhIWIucmVtb3ZlRW5jaGFudG1lbnRPblVuZXF1aXAgJiZcclxuICAgICAgICBhLmNoYXJnZVBlcmNlbnQgPT09IGIuY2hhcmdlUGVyY2VudCAmJlxyXG4gICAgICAgIC8vbmFtZXNFcXVhbChhLCBiKSAmJlxyXG4gICAgICAgIGEuc291bCA9PT0gYi5zb3VsICYmXHJcbiAgICAgICAgYS5wb2lzb25JZCA9PT0gYi5wb2lzb25JZCAmJlxyXG4gICAgICAgIGEucG9pc29uQ291bnQgPT09IGIucG9pc29uQ291bnQgJiZcclxuICAgICAgICAoKCEhYS53b3JuID09PSAhIWIud29ybiAmJiAhIWEud29ybkxlZnQgPT09ICEhYi53b3JuTGVmdCkgfHwgaWdub3JlV29ybikpO1xyXG59O1xyXG5leHBvcnQgdmFyIGhhc0V4dHJhcyA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICByZXR1cm4gIWV4dHJhc0VxdWFsKGUsIHsgYmFzZUlkOiAwLCBjb3VudDogMCB9KTtcclxufTtcclxudmFyIGV4dHJhY3RFeHRyYURhdGEgPSBmdW5jdGlvbiAocmVmciwgZXh0cmFMaXN0LCBvdXQpIHtcclxuICAgIC8vIEkgc2VlIHRoYXQgRXh0cmFXb3JuIGlzIG5vdCBlbWl0dGVkIGZvciAweEZGIGFjdG9ycyB3aGVuIGFycm93cyBhcmUgZXF1aXBwZWQuIEZpeGluZ1xyXG4gICAgdmFyIGl0ZW0gPSBHYW1lLmdldEZvcm1FeChvdXQuYmFzZUlkKTtcclxuICAgIGlmIChBbW1vLmZyb20oaXRlbSkpIHtcclxuICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgIGlmIChhY3RvciAmJiBhY3Rvci5pc0VxdWlwcGVkKGl0ZW0pKSB7XHJcbiAgICAgICAgICAgIG91dC53b3JuID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAoZXh0cmFMaXN0IHx8IFtdKS5mb3JFYWNoKGZ1bmN0aW9uIChleHRyYSkge1xyXG4gICAgICAgIHN3aXRjaCAoZXh0cmEudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIFwiSGVhbHRoXCI6XHJcbiAgICAgICAgICAgICAgICBvdXQuaGVhbHRoID0gTWF0aC5yb3VuZChleHRyYS5oZWFsdGggKiAxMCkgLyAxMDtcclxuICAgICAgICAgICAgICAgIC8vIFRFU01vZFBsYXRmb3JtOjpBZGRJdGVtRXggbWFrZXMgYWxsIGl0ZW1zIGF0IGxlYXN0IDEuMDEgaGVhbHRoXHJcbiAgICAgICAgICAgICAgICBpZiAob3V0LmhlYWx0aCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvdXQuaGVhbHRoO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJDb3VudFwiOlxyXG4gICAgICAgICAgICAgICAgb3V0LmNvdW50ID0gZXh0cmEuY291bnQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIkVuY2hhbnRtZW50XCI6XHJcbiAgICAgICAgICAgICAgICBvdXQuZW5jaGFudG1lbnRJZCA9IGV4dHJhLmVuY2hhbnRtZW50SWQ7XHJcbiAgICAgICAgICAgICAgICBvdXQubWF4Q2hhcmdlID0gZXh0cmEubWF4Q2hhcmdlO1xyXG4gICAgICAgICAgICAgICAgb3V0LnJlbW92ZUVuY2hhbnRtZW50T25VbmVxdWlwID0gZXh0cmEucmVtb3ZlT25VbmVxdWlwO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJDaGFyZ2VcIjpcclxuICAgICAgICAgICAgICAgIG91dC5jaGFyZ2VQZXJjZW50ID0gZXh0cmEuY2hhcmdlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJQb2lzb25cIjpcclxuICAgICAgICAgICAgICAgIG91dC5wb2lzb25JZCA9IGV4dHJhLnBvaXNvbklkO1xyXG4gICAgICAgICAgICAgICAgb3V0LnBvaXNvbkNvdW50ID0gZXh0cmEuY291bnQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIlNvdWxcIjpcclxuICAgICAgICAgICAgICAgIG91dC5zb3VsID0gZXh0cmEuc291bDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiVGV4dERpc3BsYXlEYXRhXCI6XHJcbiAgICAgICAgICAgICAgICBvdXQubmFtZSA9IGV4dHJhLm5hbWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIldvcm5cIjpcclxuICAgICAgICAgICAgICAgIG91dC53b3JuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiV29ybkxlZnRcIjpcclxuICAgICAgICAgICAgICAgIG91dC53b3JuTGVmdCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufTtcclxudmFyIHNxdWFzaCA9IGZ1bmN0aW9uIChpbnYpIHtcclxuICAgIHZhciByZXMgPSBuZXcgQXJyYXkoKTtcclxuICAgIGludi5lbnRyaWVzLmZvckVhY2goZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgc2FtZSA9IHJlcy5maW5kKGZ1bmN0aW9uICh4KSB7IHJldHVybiBlLmJhc2VJZCA9PT0geC5iYXNlSWQgJiYgZXh0cmFzRXF1YWwoeCwgZSk7IH0pO1xyXG4gICAgICAgIGlmIChzYW1lKSB7XHJcbiAgICAgICAgICAgIHNhbWUuY291bnQgKz0gZS5jb3VudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJlcy5wdXNoKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZSkpKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB7IGVudHJpZXM6IHJlcy5maWx0ZXIoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguY291bnQgIT09IDA7IH0pIH07XHJcbn07XHJcbnZhciBnZXRFeHRyYUNvbnRhaW5lckNoYW5nZXNBc0ludmVudG9yeSA9IGZ1bmN0aW9uIChyZWZyKSB7XHJcbiAgICB2YXIgZXh0cmFDb250YWluZXJDaGFuZ2VzID0gZ2V0RXh0cmFDb250YWluZXJDaGFuZ2VzKHJlZnIuZ2V0Rm9ybUlEKCkpO1xyXG4gICAgdmFyIGVudHJpZXMgPSBuZXcgQXJyYXkoKTtcclxuICAgIChleHRyYUNvbnRhaW5lckNoYW5nZXMgfHwgW10pLmZvckVhY2goZnVuY3Rpb24gKGNoYW5nZXNFbnRyeSkge1xyXG4gICAgICAgIHZhciBlbnRyeSA9IHtcclxuICAgICAgICAgICAgYmFzZUlkOiBjaGFuZ2VzRW50cnkuYmFzZUlkLFxyXG4gICAgICAgICAgICBjb3VudDogY2hhbmdlc0VudHJ5LmNvdW50RGVsdGEsXHJcbiAgICAgICAgfTtcclxuICAgICAgICAoY2hhbmdlc0VudHJ5LmV4dGVuZERhdGFMaXN0IHx8IFtdKS5mb3JFYWNoKGZ1bmN0aW9uIChleHRyYUxpc3QpIHtcclxuICAgICAgICAgICAgdmFyIGUgPSB7XHJcbiAgICAgICAgICAgICAgICBiYXNlSWQ6IGVudHJ5LmJhc2VJZCxcclxuICAgICAgICAgICAgICAgIGNvdW50OiAxLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBleHRyYWN0RXh0cmFEYXRhKHJlZnIsIGV4dHJhTGlzdCwgZSk7XHJcbiAgICAgICAgICAgIGVudHJpZXMucHVzaChlKTtcclxuICAgICAgICAgICAgZW50cnkuY291bnQgLT0gZS5jb3VudDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZW50cnkuY291bnQgIT09IDApIHtcclxuICAgICAgICAgICAgZW50cmllcy5wdXNoKGVudHJ5KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHZhciByZXMgPSB7IGVudHJpZXM6IGVudHJpZXMgfTtcclxuICAgIHJlcyA9IHNxdWFzaChyZXMpO1xyXG4gICAgcmV0dXJuIHJlcztcclxufTtcclxudmFyIGdldEJhc2VDb250YWluZXJBc0ludmVudG9yeSA9IGZ1bmN0aW9uIChyZWZyKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGVudHJpZXM6IGdldENvbnRhaW5lcihyZWZyLmdldEJhc2VPYmplY3QoKS5nZXRGb3JtSUQoKSksXHJcbiAgICB9O1xyXG59O1xyXG5leHBvcnQgdmFyIHN1bUludmVudG9yaWVzID0gZnVuY3Rpb24gKGxocywgcmhzKSB7XHJcbiAgICB2YXIgbGVmdEVudHJpZXNXaXRoRXh0cmFzID0gbGhzLmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uIChlKSB7IHJldHVybiBoYXNFeHRyYXMoZSk7IH0pO1xyXG4gICAgdmFyIHJpZ2h0RW50cmllc1dpdGhFeHRyYXMgPSByaHMuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGhhc0V4dHJhcyhlKTsgfSk7XHJcbiAgICB2YXIgbGVmdEVudHJpZXNTaW1wbGUgPSBsaHMuZW50cmllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuICFoYXNFeHRyYXMoZSk7IH0pO1xyXG4gICAgdmFyIHJpZ2h0RW50cmllc1NpbXBsZSA9IHJocy5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoZSkgeyByZXR1cm4gIWhhc0V4dHJhcyhlKTsgfSk7XHJcbiAgICBsZWZ0RW50cmllc1NpbXBsZS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdmFyIG1hdGNoaW5nID0gcmlnaHRFbnRyaWVzU2ltcGxlLmZpbmQoZnVuY3Rpb24gKHgpIHsgcmV0dXJuIHguYmFzZUlkID09PSBlLmJhc2VJZDsgfSk7XHJcbiAgICAgICAgaWYgKG1hdGNoaW5nKSB7XHJcbiAgICAgICAgICAgIGUuY291bnQgKz0gbWF0Y2hpbmcuY291bnQ7XHJcbiAgICAgICAgICAgIG1hdGNoaW5nLmNvdW50ID0gMDtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgZW50cmllczogbGVmdEVudHJpZXNXaXRoRXh0cmFzXHJcbiAgICAgICAgICAgIC5jb25jYXQocmlnaHRFbnRyaWVzV2l0aEV4dHJhcylcclxuICAgICAgICAgICAgLmNvbmNhdChsZWZ0RW50cmllc1NpbXBsZSlcclxuICAgICAgICAgICAgLmNvbmNhdChyaWdodEVudHJpZXNTaW1wbGUpXHJcbiAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGUuY291bnQgIT09IDA7IH0pLFxyXG4gICAgfTtcclxufTtcclxuZXhwb3J0IHZhciByZW1vdmVTaW1wbGVJdGVtc0FzTWFueUFzUG9zc2libGUgPSBmdW5jdGlvbiAoaW52LCBiYXNlSWQsIGNvdW50KSB7XHJcbiAgICB2YXIgcmVzID0geyBlbnRyaWVzOiBbXSB9O1xyXG4gICAgcmVzLmVudHJpZXMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGludi5lbnRyaWVzKSk7XHJcbiAgICB2YXIgZW50cnkgPSByZXMuZW50cmllcy5maW5kKGZ1bmN0aW9uIChlKSB7IHJldHVybiAhaGFzRXh0cmFzKGUpICYmIGUuYmFzZUlkID09PSBiYXNlSWQ7IH0pO1xyXG4gICAgaWYgKGVudHJ5KSB7XHJcbiAgICAgICAgZW50cnkuY291bnQgLT0gY291bnQ7XHJcbiAgICB9XHJcbiAgICByZXMuZW50cmllcyA9IHJlcy5lbnRyaWVzLmZpbHRlcihmdW5jdGlvbiAoZSkgeyByZXR1cm4gZS5jb3VudCA+IDA7IH0pO1xyXG4gICAgcmV0dXJuIHJlcztcclxufTtcclxuZXhwb3J0IHZhciBnZXREaWZmID0gZnVuY3Rpb24gKGxocywgcmhzLCBpZ25vcmVXb3JuKSB7XHJcbiAgICB2YXIgbGhzQ29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkobGhzKSk7XHJcbiAgICB2YXIgcmhzQ29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmhzKSk7XHJcbiAgICByaHNDb3B5LmVudHJpZXMuZm9yRWFjaChmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgIHZhciBzYW1lRnJvbUxlZnQgPSBsaHNDb3B5LmVudHJpZXMuZmluZChmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5iYXNlSWQgPT09IGUuYmFzZUlkICYmIGV4dHJhc0VxdWFsKHgsIGUsIGlnbm9yZVdvcm4pOyB9KTtcclxuICAgICAgICBpZiAoc2FtZUZyb21MZWZ0KSB7XHJcbiAgICAgICAgICAgIHNhbWVGcm9tTGVmdC5jb3VudCAtPSBlLmNvdW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbGhzQ29weS5lbnRyaWVzLnB1c2goZSk7XHJcbiAgICAgICAgICAgIGxoc0NvcHkuZW50cmllc1tsaHNDb3B5LmVudHJpZXMubGVuZ3RoIC0gMV0uY291bnQgKj0gLTE7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4geyBlbnRyaWVzOiBsaHNDb3B5LmVudHJpZXMuZmlsdGVyKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LmNvdW50ICE9PSAwOyB9KSB9O1xyXG59O1xyXG5leHBvcnQgdmFyIGdldEludmVudG9yeSA9IGZ1bmN0aW9uIChyZWZyKSB7XHJcbiAgICByZXR1cm4gc3F1YXNoKHN1bUludmVudG9yaWVzKGdldEJhc2VDb250YWluZXJBc0ludmVudG9yeShyZWZyKSwgZ2V0RXh0cmFDb250YWluZXJDaGFuZ2VzQXNJbnZlbnRvcnkocmVmcikpKTtcclxufTtcclxudmFyIGJhc2VzUmVzZXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoc3RvcmFnZVtcImJhc2VzUmVzZXRFeGlzdHNcIl0gIT09IHRydWUpIHtcclxuICAgICAgICBzdG9yYWdlW1wiYmFzZXNSZXNldEV4aXN0c1wiXSA9IHRydWU7XHJcbiAgICAgICAgc3RvcmFnZVtcImJhc2VzUmVzZXRcIl0gPSBuZXcgU2V0KCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3RvcmFnZVtcImJhc2VzUmVzZXRcIl07XHJcbn07XHJcbnZhciByZXNldEJhc2UgPSBmdW5jdGlvbiAocmVmcikge1xyXG4gICAgdmFyIGJhc2UgPSByZWZyLmdldEJhc2VPYmplY3QoKTtcclxuICAgIHZhciBiYXNlSWQgPSBiYXNlID8gYmFzZS5nZXRGb3JtSUQoKSA6IDA7XHJcbiAgICBpZiAoIWJhc2VzUmVzZXQoKS5oYXMoYmFzZUlkKSkge1xyXG4gICAgICAgIGJhc2VzUmVzZXQoKS5hZGQoYmFzZUlkKTtcclxuICAgICAgICBURVNNb2RQbGF0Zm9ybS5yZXNldENvbnRhaW5lcihiYXNlKTtcclxuICAgICAgICByZWZyLnJlbW92ZUFsbEl0ZW1zKG51bGwsIGZhbHNlLCB0cnVlKTtcclxuICAgIH1cclxufTtcclxuZXhwb3J0IHZhciBhcHBseUludmVudG9yeSA9IGZ1bmN0aW9uIChyZWZyLCBuZXdJbnZlbnRvcnksIGVuYWJsZUNyYXNoUHJvdGVjdGlvbiwgaWdub3JlV29ybikge1xyXG4gICAgaWYgKGlnbm9yZVdvcm4gPT09IHZvaWQgMCkgeyBpZ25vcmVXb3JuID0gZmFsc2U7IH1cclxuICAgIHJlc2V0QmFzZShyZWZyKTtcclxuICAgIHZhciBkaWZmID0gZ2V0RGlmZihuZXdJbnZlbnRvcnksIGdldEludmVudG9yeShyZWZyKSwgaWdub3JlV29ybikuZW50cmllcztcclxuICAgIHZhciByZXMgPSB0cnVlO1xyXG4gICAgZGlmZi5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiAoYS5jb3VudCA8IGIuY291bnQgPyAtMSA6IDEpOyB9KTtcclxuICAgIGRpZmYuZm9yRWFjaChmdW5jdGlvbiAoZSwgaSkge1xyXG4gICAgICAgIGlmIChpID4gMCAmJiBlbmFibGVDcmFzaFByb3RlY3Rpb24pIHtcclxuICAgICAgICAgICAgcmVzID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFic0NvdW50ID0gTWF0aC5hYnMoZS5jb3VudCk7XHJcbiAgICAgICAgdmFyIHF1ZXVlTmlOb2RlVXBkYXRlTmVlZGVkID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIHdvcm4gPSAhIWUud29ybjtcclxuICAgICAgICB2YXIgd29ybkxlZnQgPSAhIWUud29ybkxlZnQ7XHJcbiAgICAgICAgdmFyIG9uZVN0ZXBDb3VudCA9IGUuY291bnQgLyBhYnNDb3VudDtcclxuICAgICAgICB2YXIgZiA9IEdhbWUuZ2V0Rm9ybUV4KGUuYmFzZUlkKTtcclxuICAgICAgICBpZiAoIWYpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHByaW50Q29uc29sZShcIkJhZCBmb3JtIElEIFwiLmNvbmNhdChlLmJhc2VJZC50b1N0cmluZygxNikpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHR5cGUgPSBmLmdldFR5cGUoKTtcclxuICAgICAgICAvLyBGb3IgbWlzYyBpdGVtcywgcG90aW9ucyBhbmQgaW5ncmVkaWVudHMgd2UgZG9uJ3Qgd2FudCB0byBzcGxpdCB0aGVtIGludG8gbXVsdGlwbGUgaXRlbXNcclxuICAgICAgICAvLyBUaGlzIHdhcyBtYWRlIHRvIGZpeCBhIHBlcmZvcm1hbmNlIGlzc3VlIHdpdGggdXNlcnMgaGF2aW5nIDEwMDAwKyBvZiBtaXNjIGl0ZW1zIChpLmUuIGdvbGQpXHJcbiAgICAgICAgaWYgKHR5cGUgPT09IDMyIC8qIEZvcm1UeXBlLk1pc2MgKi8gfHxcclxuICAgICAgICAgICAgdHlwZSA9PT0gNDYgLyogRm9ybVR5cGUuUG90aW9uICovIHx8XHJcbiAgICAgICAgICAgIHR5cGUgPT09IDMwIC8qIEZvcm1UeXBlLkluZ3JlZGllbnQgKi8pIHtcclxuICAgICAgICAgICAgYWJzQ291bnQgPSAxO1xyXG4gICAgICAgICAgICBvbmVTdGVwQ291bnQgPSBlLmNvdW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGFic0NvdW50ID4gMTAwMCkge1xyXG4gICAgICAgICAgICAgICAgYWJzQ291bnQgPSAxO1xyXG4gICAgICAgICAgICAgICAgb25lU3RlcENvdW50ID0gMTtcclxuICAgICAgICAgICAgICAgIC8vIEFsc28gZm9yIGFycm93cyB3aXRoIHN0cmFuZ2UgY291bnRcclxuICAgICAgICAgICAgICAgIGlmICh3b3JuICYmIGUuY291bnQgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWJzQ291bnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChlLmNvdW50ID4gMSAmJiBBbW1vLmZyb20oR2FtZS5nZXRGb3JtRXgoZS5iYXNlSWQpKSkge1xyXG4gICAgICAgICAgICAgICAgYWJzQ291bnQgPSAxO1xyXG4gICAgICAgICAgICAgICAgb25lU3RlcENvdW50ID0gZS5jb3VudDtcclxuICAgICAgICAgICAgICAgIGlmIChlLmNvdW50ID4gNjAwMDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBXaHkgd291bGQgYWN0b3IgaGF2ZSA2MGsgYXJyb3dzP1xyXG4gICAgICAgICAgICAgICAgICAgIGUuY291bnQgPSAxO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIGlfMSA9IDA7IGlfMSA8IGFic0NvdW50OyArK2lfMSkge1xyXG4gICAgICAgICAgICBpZiAod29ybiB8fCB3b3JuTGVmdCkge1xyXG4gICAgICAgICAgICAgICAgVEVTTW9kUGxhdGZvcm0ucHVzaFdvcm5TdGF0ZSghIXdvcm4sICEhd29ybkxlZnQpO1xyXG4gICAgICAgICAgICAgICAgcXVldWVOaU5vZGVVcGRhdGVOZWVkZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhZGRJdGVtRXhBcmdzID0gdm9pZCAwO1xyXG4gICAgICAgICAgICBhZGRJdGVtRXhBcmdzID0gW1xyXG4gICAgICAgICAgICAgICAgcmVmcixcclxuICAgICAgICAgICAgICAgIGYsXHJcbiAgICAgICAgICAgICAgICBvbmVTdGVwQ291bnQsXHJcbiAgICAgICAgICAgICAgICBlLmhlYWx0aCA/IGUuaGVhbHRoIDogMSxcclxuICAgICAgICAgICAgICAgIGUuZW5jaGFudG1lbnRJZFxyXG4gICAgICAgICAgICAgICAgICAgID8gRW5jaGFudG1lbnQuZnJvbShHYW1lLmdldEZvcm1FeChlLmVuY2hhbnRtZW50SWQpKVxyXG4gICAgICAgICAgICAgICAgICAgIDogbnVsbCxcclxuICAgICAgICAgICAgICAgIGUubWF4Q2hhcmdlID8gZS5tYXhDaGFyZ2UgOiAwLFxyXG4gICAgICAgICAgICAgICAgISFlLnJlbW92ZUVuY2hhbnRtZW50T25VbmVxdWlwLFxyXG4gICAgICAgICAgICAgICAgZS5jaGFyZ2VQZXJjZW50ID8gZS5jaGFyZ2VQZXJjZW50IDogMCxcclxuICAgICAgICAgICAgICAgIGUubmFtZSA/IGNyb3BOYW1lKGUubmFtZSkgOiBmLmdldE5hbWUoKSxcclxuICAgICAgICAgICAgICAgIGUuc291bCA/IGUuc291bCA6IDAsXHJcbiAgICAgICAgICAgICAgICBlLnBvaXNvbklkID8gUG90aW9uLmZyb20oR2FtZS5nZXRGb3JtRXgoZS5wb2lzb25JZCkpIDogbnVsbCxcclxuICAgICAgICAgICAgICAgIGUucG9pc29uQ291bnQgPyBlLnBvaXNvbkNvdW50IDogMFxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICB2YXIgYXJnc1RvUHJpbnQgPSBhZGRJdGVtRXhBcmdzLm1hcChmdW5jdGlvbiAoYXJnKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgT2JqZWN0UmVmZXJlbmNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiT2JqZWN0UmVmZXJlbmNlKFwiLmNvbmNhdChhcmcuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpLCBcIilcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBGb3JtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiRm9ybShcIi5jb25jYXQoYXJnLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSwgXCIpXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwcmludENvbnNvbGUoXCJURVNNb2RQbGF0Zm9ybS5hZGRJdGVtRXgoXCIuY29uY2F0KGFyZ3NUb1ByaW50LmpvaW4oXCIsIFwiKSwgXCIpXCIpKTtcclxuICAgICAgICAgICAgVEVTTW9kUGxhdGZvcm0uYWRkSXRlbUV4LmFwcGx5KFRFU01vZFBsYXRmb3JtLCBhZGRJdGVtRXhBcmdzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHF1ZXVlTmlOb2RlVXBkYXRlTmVlZGVkKSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICAgICAgYWMucXVldWVOaU5vZGVVcGRhdGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlcztcclxufTtcclxuIiwiaW1wb3J0IHsgQWN0b3IsIEdhbWUsIFRFU01vZFBsYXRmb3JtLCBEZWJ1ZyB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBSZXNwYXduTmVlZGVkRXJyb3IgfSBmcm9tIFwiLi4vbGliL2Vycm9yc1wiO1xyXG5pbXBvcnQgeyBPYmplY3RSZWZlcmVuY2VFeCB9IGZyb20gXCIuLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4XCI7XHJcbmltcG9ydCB7IFNwQXBpSW50ZXJhY3RvciB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zcEFwaUludGVyYWN0b3JcIjtcclxudmFyIHNxciA9IGZ1bmN0aW9uICh4KSB7IHJldHVybiB4ICogeDsgfTtcclxuZXhwb3J0IHZhciBhcHBseU1vdmVtZW50ID0gZnVuY3Rpb24gKHJlZnIsIG0sIGlzTXlDbG9uZSkge1xyXG4gICAgaWYgKHRlbGVwb3J0SWZOZWVkKHJlZnIsIG0pKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gWiBheGlzIGlzbid0IHVzZWZ1bCBoZXJlXHJcbiAgICB2YXIgYWNYID0gcmVmci5nZXRQb3NpdGlvblgoKTtcclxuICAgIHZhciBhY1kgPSByZWZyLmdldFBvc2l0aW9uWSgpO1xyXG4gICAgdmFyIGxhZ1VuaXRzTm9aID0gTWF0aC5yb3VuZChNYXRoLnNxcnQoc3FyKG0ucG9zWzBdIC0gYWNYKSArIHNxcihtLnBvc1sxXSAtIGFjWSkpKTtcclxuICAgIGlmIChpc015Q2xvbmUgPT09IHRydWUpIHtcclxuICAgICAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkuZW1pdHRlci5lbWl0KFwibmV3TG9jYWxMYWdWYWx1ZUNhbGN1bGF0ZWRcIiwgeyBsYWdVbml0c05vWjogbGFnVW5pdHNOb1ogfSk7XHJcbiAgICB9XHJcbiAgICB0cmFuc2xhdGVUbyhyZWZyLCBtKTtcclxuICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICBpZiAoIWFjKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdmFyIGxvb2tBdCA9IG51bGw7XHJcbiAgICBpZiAobS5sb29rQXQpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsb29rQXQgPSBHYW1lLmZpbmRDbG9zZXN0QWN0b3IobS5sb29rQXRbMF0sIG0ubG9va0F0WzFdLCBtLmxvb2tBdFsyXSwgMTI4KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgbG9va0F0ID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAobG9va0F0KSB7XHJcbiAgICAgICAgYWMuc2V0SGVhZFRyYWNraW5nKHRydWUpO1xyXG4gICAgICAgIGFjLnNldExvb2tBdChsb29rQXQsIGZhbHNlKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGFjLnNldEhlYWRUcmFja2luZyhmYWxzZSk7XHJcbiAgICB9XHJcbiAgICAvLyBhYy5zdG9wQ29tYmF0KCk7XHJcbiAgICBhYy5ibG9ja0FjdGl2YXRpb24odHJ1ZSk7XHJcbiAgICBrZWVwT2Zmc2V0RnJvbUFjdG9yKGFjLCBtKTtcclxuICAgIGFwcGx5U3ByaW50aW5nKGFjLCBtLnJ1bk1vZGUgPT09IFwiU3ByaW50aW5nXCIpO1xyXG4gICAgYXBwbHlCbG9ja2luZyhhYywgbSk7XHJcbiAgICBhcHBseVNuZWFraW5nKGFjLCBtLmlzU25lYWtpbmcpO1xyXG4gICAgYXBwbHlXZWFwRHJhd24oYWMsIG0uaXNXZWFwRHJhd24pO1xyXG4gICAgYXBwbHlIZWFsdGhQZXJjZW50YWdlKGFjLCBtLmhlYWx0aFBlcmNlbnRhZ2UpO1xyXG4gICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmVtaXR0ZXIuZW1pdChcImFwcGx5RGVhdGhTdGF0ZUV2ZW50XCIsIHsgYWN0b3I6IGFjLCBpc0RlYWQ6IG0uaXNEZWFkIH0pO1xyXG59O1xyXG52YXIga2VlcE9mZnNldEZyb21BY3RvciA9IGZ1bmN0aW9uIChhYywgbSkge1xyXG4gICAgdmFyIG9mZnNldEFuZ2xlID0gbS5yb3RbMl0gLSBhYy5nZXRBbmdsZVooKTtcclxuICAgIGlmIChNYXRoLmFicyhvZmZzZXRBbmdsZSkgPCA1KSB7XHJcbiAgICAgICAgb2Zmc2V0QW5nbGUgPSAwO1xyXG4gICAgfVxyXG4gICAgaWYgKG0ucnVuTW9kZSA9PT0gXCJTdGFuZGluZ1wiKSB7XHJcbiAgICAgICAgcmV0dXJuIGFjLmtlZXBPZmZzZXRGcm9tQWN0b3IoYWMsIDAsIDAsIDAsIDAsIDAsIG9mZnNldEFuZ2xlLCAxLCAxKTtcclxuICAgIH1cclxuICAgIHZhciBvZmZzZXQgPSBbXHJcbiAgICAgICAgMyAqIE1hdGguc2luKChtLmRpcmVjdGlvbiAvIDE4MCkgKiBNYXRoLlBJKSxcclxuICAgICAgICAzICogTWF0aC5jb3MoKG0uZGlyZWN0aW9uIC8gMTgwKSAqIE1hdGguUEkpLFxyXG4gICAgICAgIGdldE9mZnNldFoobS5ydW5Nb2RlKSxcclxuICAgIF07XHJcbiAgICBhYy5rZWVwT2Zmc2V0RnJvbUFjdG9yKGFjLCBvZmZzZXRbMF0sIG9mZnNldFsxXSwgb2Zmc2V0WzJdLCAwLCAwLCBvZmZzZXRBbmdsZSwgbS5ydW5Nb2RlID09PSBcIldhbGtpbmdcIiA/IDIwNDggOiAxLCAxKTtcclxufTtcclxudmFyIGdldE9mZnNldFogPSBmdW5jdGlvbiAocnVuTW9kZSkge1xyXG4gICAgc3dpdGNoIChydW5Nb2RlKSB7XHJcbiAgICAgICAgY2FzZSBcIldhbGtpbmdcIjpcclxuICAgICAgICAgICAgcmV0dXJuIC01MTI7XHJcbiAgICAgICAgY2FzZSBcIlJ1bm5pbmdcIjpcclxuICAgICAgICAgICAgcmV0dXJuIC0xMDI0O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIDA7XHJcbn07XHJcbnZhciBhcHBseVNwcmludGluZyA9IGZ1bmN0aW9uIChhYywgaXNTcHJpbnRpbmcpIHtcclxuICAgIGlmIChhYy5pc1NwcmludGluZygpICE9IGlzU3ByaW50aW5nKSB7XHJcbiAgICAgICAgRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KGFjLCBpc1NwcmludGluZyA/IFwiU3ByaW50U3RhcnRcIiA6IFwiU3ByaW50U3RvcFwiKTtcclxuICAgIH1cclxufTtcclxudmFyIGFwcGx5QmxvY2tpbmcgPSBmdW5jdGlvbiAoYWMsIG0pIHtcclxuICAgIGlmIChhYy5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc0Jsb2NraW5nXCIpICE9IG0uaXNCbG9ja2luZykge1xyXG4gICAgICAgIERlYnVnLnNlbmRBbmltYXRpb25FdmVudChhYywgbS5pc0Jsb2NraW5nID8gXCJCbG9ja1N0YXJ0XCIgOiBcIkJsb2NrU3RvcFwiKTtcclxuICAgICAgICBEZWJ1Zy5zZW5kQW5pbWF0aW9uRXZlbnQoYWMsIG0uaXNTbmVha2luZyA/IFwiU25lYWtTdGFydFwiIDogXCJTbmVha1N0b3BcIik7XHJcbiAgICB9XHJcbn07XHJcbnZhciBhcHBseVNuZWFraW5nID0gZnVuY3Rpb24gKGFjLCBpc1NuZWFraW5nKSB7XHJcbiAgICB2YXIgY3VycmVudElzU25lYWtpbmcgPSBhYy5pc1NuZWFraW5nKCkgfHwgYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVCb29sKFwiSXNTbmVha2luZ1wiKTtcclxuICAgIGlmIChjdXJyZW50SXNTbmVha2luZyAhPSBpc1NuZWFraW5nKSB7XHJcbiAgICAgICAgRGVidWcuc2VuZEFuaW1hdGlvbkV2ZW50KGFjLCBpc1NuZWFraW5nID8gXCJTbmVha1N0YXJ0XCIgOiBcIlNuZWFrU3RvcFwiKTtcclxuICAgIH1cclxufTtcclxuZXhwb3J0IHZhciBhcHBseVdlYXBEcmF3biA9IGZ1bmN0aW9uIChhYywgaXNXZWFwRHJhd24pIHtcclxuICAgIGlmIChhYy5pc1dlYXBvbkRyYXduKCkgIT09IGlzV2VhcERyYXduKSB7XHJcbiAgICAgICAgVEVTTW9kUGxhdGZvcm0uc2V0V2VhcG9uRHJhd25Nb2RlKGFjLCBpc1dlYXBEcmF3biA/IDEgOiAwKTtcclxuICAgIH1cclxufTtcclxudmFyIGFwcGx5SGVhbHRoUGVyY2VudGFnZSA9IGZ1bmN0aW9uIChhYywgaGVhbHRoUGVyY2VudGFnZSkge1xyXG4gICAgdmFyIGN1cnJlbnRQZXJjZW50YWdlID0gYWMuZ2V0QWN0b3JWYWx1ZVBlcmNlbnRhZ2UoJ2hlYWx0aCcpO1xyXG4gICAgaWYgKGN1cnJlbnRQZXJjZW50YWdlID09PSBoZWFsdGhQZXJjZW50YWdlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdmFyIGN1cnJlbnRNYXggPSBhYy5nZXRCYXNlQWN0b3JWYWx1ZSgnaGVhbHRoJyk7XHJcbiAgICB2YXIgZGVsdGFQZXJjZW50YWdlID0gaGVhbHRoUGVyY2VudGFnZSAtIGN1cnJlbnRQZXJjZW50YWdlO1xyXG4gICAgdmFyIGsgPSAwLjI1O1xyXG4gICAgaWYgKGRlbHRhUGVyY2VudGFnZSA+IDApIHtcclxuICAgICAgICBhYy5yZXN0b3JlQWN0b3JWYWx1ZSgnaGVhbHRoJywgZGVsdGFQZXJjZW50YWdlICogY3VycmVudE1heCAqIGspO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoZGVsdGFQZXJjZW50YWdlIDwgMCkge1xyXG4gICAgICAgIGFjLmRhbWFnZUFjdG9yVmFsdWUoJ2hlYWx0aCcsIGRlbHRhUGVyY2VudGFnZSAqIGN1cnJlbnRNYXggKiBrKTtcclxuICAgIH1cclxufTtcclxuLy8gVXNlIGdsb2JhbCB0ZW1wIHZhciB0byBhdm9pZCBhbGxvY2F0aW9uIG9mIGFuIGFycmF5IG9uIGVhY2ggdHJhbnNsYXRlVG9cclxudmFyIGdUZW1wVGFyZ2V0UG9zID0gWzAsIDAsIDBdO1xyXG52YXIgdHJhbnNsYXRlVG8gPSBmdW5jdGlvbiAocmVmciwgbSkge1xyXG4gICAgdmFyIF9hO1xyXG4gICAgdmFyIHRpbWUgPSAwLjI7XHJcbiAgICBpZiAobS5pc0luSnVtcFN0YXRlIHx8IG0ucnVuTW9kZSAhPT0gXCJTdGFuZGluZ1wiKSB7XHJcbiAgICAgICAgdGltZSA9IDAuMjtcclxuICAgIH1cclxuICAgIC8vIExvY2FsIGxhZyBjb21wZW5zYXRpb25cclxuICAgIC8vIFRPRE86IFJlbW92ZSBcInx8IDBcIiBoYWNrIChhZGRlZCB0byBzdXBwb3J0IG9sZCBNcENsaWVudFBsdWdpbilcclxuICAgIHZhciBkaXN0YW5jZUFkZCA9IChtLnNwZWVkIHx8IDApICogdGltZTtcclxuICAgIHZhciBkaXJlY3Rpb24gPSBtLnJvdFsyXSArIG0uZGlyZWN0aW9uO1xyXG4gICAgZ1RlbXBUYXJnZXRQb3NbMF0gPSBtLnBvc1swXTtcclxuICAgIGdUZW1wVGFyZ2V0UG9zWzFdID0gbS5wb3NbMV07XHJcbiAgICBnVGVtcFRhcmdldFBvc1syXSA9IG0ucG9zWzJdO1xyXG4gICAgLy8gV2UgZG8gbm90IHdhbnQgdG8gYWRkIHBvcyBpbiBjYXNlIG9mIHN0YW5kaW5nLWp1bXBpbmdcclxuICAgIGlmIChtLnJ1bk1vZGUgIT09IFwiU3RhbmRpbmdcIikge1xyXG4gICAgICAgIGdUZW1wVGFyZ2V0UG9zWzBdICs9IE1hdGguc2luKGRpcmVjdGlvbiAvIDE4MCAqIE1hdGguUEkpICogZGlzdGFuY2VBZGQ7XHJcbiAgICAgICAgZ1RlbXBUYXJnZXRQb3NbMV0gKz0gTWF0aC5jb3MoZGlyZWN0aW9uIC8gMTgwICogTWF0aC5QSSkgKiBkaXN0YW5jZUFkZDtcclxuICAgIH1cclxuICAgIHZhciByZWZyUmVhbFBvcyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFBvcyhyZWZyKTtcclxuICAgIHZhciBkaXN0YW5jZSA9IE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlKHJlZnJSZWFsUG9zLCBnVGVtcFRhcmdldFBvcyk7XHJcbiAgICB2YXIgc3BlZWQgPSBkaXN0YW5jZSAvIHRpbWU7XHJcbiAgICB2YXIgYW5nbGVEaWZmID0gTWF0aC5hYnMobS5yb3RbMl0gLSByZWZyLmdldEFuZ2xlWigpKTtcclxuICAgIGlmIChtLnJ1bk1vZGUgIT09IFwiU3RhbmRpbmdcIiB8fFxyXG4gICAgICAgIG0uaXNJbkp1bXBTdGF0ZSB8fFxyXG4gICAgICAgIE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlTm9aKHJlZnJSZWFsUG9zLCBnVGVtcFRhcmdldFBvcykgPiA4IHx8XHJcbiAgICAgICAgYW5nbGVEaWZmID4gODAgfHxcclxuICAgICAgICAoKF9hID0gQWN0b3IuZnJvbShyZWZyKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldFNpdFN0YXRlKCkpID09PSAzKSB7XHJcbiAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICBpZiAoYWN0b3IgJiYgYWN0b3IuZ2V0QWN0b3JWYWx1ZShcIlZhcmlhYmxlMTBcIikgPCAtOTk5KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFhY3RvciB8fCAhYWN0b3IuaXNEZWFkKCkpIHtcclxuICAgICAgICAgICAgcmVmci50cmFuc2xhdGVUbyhnVGVtcFRhcmdldFBvc1swXSwgZ1RlbXBUYXJnZXRQb3NbMV0sIGdUZW1wVGFyZ2V0UG9zWzJdLCBtLnJvdFswXSwgbS5yb3RbMV0sIG0ucm90WzJdLCBzcGVlZCwgMCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG52YXIgdGVsZXBvcnRJZk5lZWQgPSBmdW5jdGlvbiAocmVmciwgbSkge1xyXG4gICAgaWYgKGlzSW5EaWZmZXJlbnRXb3JsZE9yQ2VsbChyZWZyLCBtLndvcmxkT3JDZWxsKSB8fFxyXG4gICAgICAgICghcmVmci5pczNETG9hZGVkKCkgJiYgaXNJbkRpZmZlcmVudEV4dGVyaW9yQ2VsbChyZWZyLCBtLnBvcykpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFJlc3Bhd25OZWVkZWRFcnJvcihcIm5lZWRzIHRvIGJlIHJlc3Bhd25lZFwiKTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufTtcclxudmFyIGNlbGxXaWR0aCA9IDQwOTY7XHJcbnZhciBpc0luRGlmZmVyZW50RXh0ZXJpb3JDZWxsID0gZnVuY3Rpb24gKHJlZnIsIHBvcykge1xyXG4gICAgdmFyIGN1cnJlbnRQb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MocmVmcik7XHJcbiAgICB2YXIgcGxheWVyUG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKEdhbWUuZ2V0UGxheWVyKCkpO1xyXG4gICAgdmFyIHRhcmdldERpc3RhbmNlVG9QbGF5ZXIgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZShwbGF5ZXJQb3MsIHBvcyk7XHJcbiAgICB2YXIgY3VycmVudERpc3RhbmNlVG9QbGF5ZXIgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXREaXN0YW5jZShwbGF5ZXJQb3MsIGN1cnJlbnRQb3MpO1xyXG4gICAgcmV0dXJuIGN1cnJlbnREaXN0YW5jZVRvUGxheWVyID4gY2VsbFdpZHRoICYmIHRhcmdldERpc3RhbmNlVG9QbGF5ZXIgPD0gY2VsbFdpZHRoO1xyXG59O1xyXG52YXIgaXNJbkRpZmZlcmVudFdvcmxkT3JDZWxsID0gZnVuY3Rpb24gKHJlZnIsIHdvcmxkT3JDZWxsKSB7XHJcbiAgICByZXR1cm4gd29ybGRPckNlbGwgIT09IE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsKHJlZnIpO1xyXG59O1xyXG4iLCJpbXBvcnQgeyBBY3RvciwgVEVTTW9kUGxhdGZvcm0gfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tICcuLi9leHRlbnNpb25zL29iamVjdFJlZmVyZW5jZUV4JztcclxudmFyIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvcigpIHtcclxuICAgIH1cclxuICAgIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5zYXZlUG9zaXRpb24gPSBmdW5jdGlvbiAocG9zLCB3b3JsZE9yQ2VsbCkge1xyXG4gICAgICAgIHRoaXMubGFzdFBjUG9zID0gcG9zO1xyXG4gICAgICAgIHRoaXMubGFzdFBjUG9zQ2hlY2sgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgIHRoaXMubGFzdFBjV29ybGRPckNlbGwgPSB3b3JsZE9yQ2VsbDtcclxuICAgIH07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3IuZ2V0U3BlZWQgPSBmdW5jdGlvbiAoY3VycmVudFBvcywgd29ybGRPckNlbGwpIHtcclxuICAgICAgICBpZiAodGhpcy5sYXN0UGNQb3NDaGVjayA9PT0gLTEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB0aW1lRGVsdGFTZWMgPSAoRGF0ZS5ub3coKSAtIHRoaXMubGFzdFBjUG9zQ2hlY2spIC8gMTAwMDtcclxuICAgICAgICBpZiAodGltZURlbHRhU2VjID4gNSlcclxuICAgICAgICAgICAgcmV0dXJuIDA7IC8vIFRvbyBpbmFjY3VyYXRlXHJcbiAgICAgICAgaWYgKHRpbWVEZWx0YVNlYyA9PT0gMClcclxuICAgICAgICAgICAgcmV0dXJuIDA7IC8vIERpdmlzaW9uIGJ5IHplcm9cclxuICAgICAgICBpZiAod29ybGRPckNlbGwgIT09IHRoaXMubGFzdFBjV29ybGRPckNlbGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBkaXN0YW5jZSA9IE9iamVjdFJlZmVyZW5jZUV4LmdldERpc3RhbmNlKGN1cnJlbnRQb3MsIHRoaXMubGFzdFBjUG9zKTtcclxuICAgICAgICByZXR1cm4gZGlzdGFuY2UgLyB0aW1lRGVsdGFTZWM7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLmxhc3RQY1BvcyA9IFswLCAwLCAwXTtcclxuICAgIFBsYXllckNoYXJhY3RlclNwZWVkQ2FsY3VsYXRvci5sYXN0UGNQb3NDaGVjayA9IC0xO1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLmxhc3RQY1dvcmxkT3JDZWxsID0gMDtcclxuICAgIHJldHVybiBQbGF5ZXJDaGFyYWN0ZXJTcGVlZENhbGN1bGF0b3I7XHJcbn0oKSk7XHJcbmV4cG9ydCB2YXIgZ2V0TW92ZW1lbnQgPSBmdW5jdGlvbiAocmVmciwgZm9ybSkge1xyXG4gICAgdmFyIF9hO1xyXG4gICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgIC8vIEl0IGlzIHJ1bm5pbmcgZm9yIE9iamVjdFJlZmVyZW5jZXMgYmVjYXVzZSBTdGFuZGluZ1xyXG4gICAgLy8gRG9lc24ndCBsZWFkIHRvIHRyYW5zbGF0ZVRvIGNhbGxcclxuICAgIHZhciBydW5Nb2RlID0gYWMgPyBnZXRSdW5Nb2RlKGFjKSA6IFwiUnVubmluZ1wiO1xyXG4gICAgdmFyIGhlYWx0aFBlcmNlbnRhZ2UgPSBhYyAmJiBhYy5nZXRBY3RvclZhbHVlUGVyY2VudGFnZShcImhlYWx0aFwiKTtcclxuICAgIGlmIChhYyAmJiBhYy5pc0RlYWQoKSkge1xyXG4gICAgICAgIGhlYWx0aFBlcmNlbnRhZ2UgPSAwO1xyXG4gICAgfVxyXG4gICAgdmFyIGxvb2tBdCA9IHVuZGVmaW5lZDtcclxuICAgIGlmIChyZWZyLmdldEZvcm1JRCgpICE9PSAweDE0KSB7XHJcbiAgICAgICAgdmFyIGNvbWJhdFRhcmdldCA9IGFjID09PSBudWxsIHx8IGFjID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhYy5nZXRDb21iYXRUYXJnZXQoKTtcclxuICAgICAgICBpZiAoY29tYmF0VGFyZ2V0KSB7XHJcbiAgICAgICAgICAgIGxvb2tBdCA9IFtcclxuICAgICAgICAgICAgICAgIGNvbWJhdFRhcmdldC5nZXRQb3NpdGlvblgoKSxcclxuICAgICAgICAgICAgICAgIGNvbWJhdFRhcmdldC5nZXRQb3NpdGlvblkoKSxcclxuICAgICAgICAgICAgICAgIGNvbWJhdFRhcmdldC5nZXRQb3NpdGlvblooKSxcclxuICAgICAgICAgICAgXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgcG9zID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0UG9zKHJlZnIpO1xyXG4gICAgdmFyIHNwZWVkO1xyXG4gICAgaWYgKHJlZnIuZ2V0Rm9ybUlEKCkgIT09IDB4MTQpIHtcclxuICAgICAgICBzcGVlZCA9IHJlZnIuZ2V0QW5pbWF0aW9uVmFyaWFibGVGbG9hdChcIlNwZWVkU2FtcGxlZFwiKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIC8vIFJlYWwgcGxheWVycyBvZnRlbiBydW4gaW50byB0aGUgd2FsbC5cclxuICAgICAgICAvLyBXZSBuZWVkIHRvIGhhdmUgemVybyBzcGVlZCBpbiB0aGlzIGNhc2UuIFNwZWVkU2FtcGxlZCBkb2Vzbid0IGhlbHBcclxuICAgICAgICB2YXIgdyA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsKHJlZnIpO1xyXG4gICAgICAgIHNwZWVkID0gUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLmdldFNwZWVkKHBvcywgdyk7XHJcbiAgICAgICAgUGxheWVyQ2hhcmFjdGVyU3BlZWRDYWxjdWxhdG9yLnNhdmVQb3NpdGlvbihwb3MsIHcpO1xyXG4gICAgICAgIC8vIEl0J3MgdW5yZWFsaXN0aWMgc3BlZWQuIEl0IHN0aWxsIG1heSBoYXBwZW4gZHVlIHRvIHRlbGVwb3J0c1xyXG4gICAgICAgIGlmIChzcGVlZCA+IDIwMDApIHtcclxuICAgICAgICAgICAgc3BlZWQgPSAwO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHZhciB3b3JsZE9yQ2VsbCA9IHJlZnIuZ2V0V29ybGRTcGFjZSgpIHx8IHJlZnIuZ2V0UGFyZW50Q2VsbCgpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICB3b3JsZE9yQ2VsbDogKHdvcmxkT3JDZWxsID09PSBudWxsIHx8IHdvcmxkT3JDZWxsID09PSB2b2lkIDAgPyB2b2lkIDAgOiB3b3JsZE9yQ2VsbC5nZXRGb3JtSUQoKSkgfHwgMCxcclxuICAgICAgICBwb3M6IHBvcyxcclxuICAgICAgICByb3Q6IFtyZWZyLmdldEFuZ2xlWCgpLCByZWZyLmdldEFuZ2xlWSgpLCByZWZyLmdldEFuZ2xlWigpXSxcclxuICAgICAgICBydW5Nb2RlOiBydW5Nb2RlLFxyXG4gICAgICAgIGRpcmVjdGlvbjogcnVuTW9kZSAhPT0gXCJTdGFuZGluZ1wiXHJcbiAgICAgICAgICAgID8gMzYwICogcmVmci5nZXRBbmltYXRpb25WYXJpYWJsZUZsb2F0KFwiRGlyZWN0aW9uXCIpXHJcbiAgICAgICAgICAgIDogMCxcclxuICAgICAgICBpc0luSnVtcFN0YXRlOiAhIShhYyAmJiBhYy5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJiSW5KdW1wU3RhdGVcIikpLFxyXG4gICAgICAgIGlzU25lYWtpbmc6ICEhKGFjICYmIGlzU25lYWtpbmcoYWMpKSxcclxuICAgICAgICBpc0Jsb2NraW5nOiAhIShhYyAmJiBhYy5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJJc0Jsb2NraW5nXCIpKSxcclxuICAgICAgICBpc1dlYXBEcmF3bjogISEoYWMgJiYgYWMuaXNXZWFwb25EcmF3bigpKSxcclxuICAgICAgICBpc0RlYWQ6ICgoX2EgPSBmb3JtID09PSBudWxsIHx8IGZvcm0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZvcm0uaXNEZWFkKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBmYWxzZSkgfHwgISEoYWMgJiYgYWMuaXNEZWFkKCkpLFxyXG4gICAgICAgIGhlYWx0aFBlcmNlbnRhZ2U6IGhlYWx0aFBlcmNlbnRhZ2UgfHwgMCxcclxuICAgICAgICBsb29rQXQ6IGxvb2tBdCxcclxuICAgICAgICBzcGVlZDogc3BlZWRcclxuICAgIH07XHJcbn07XHJcbnZhciBpc1NuZWFraW5nID0gZnVuY3Rpb24gKGFjKSB7XHJcbiAgICByZXR1cm4gYWMuaXNTbmVha2luZygpIHx8IGFjLmdldEFuaW1hdGlvblZhcmlhYmxlQm9vbChcIklzU25lYWtpbmdcIik7XHJcbn07XHJcbnZhciBnZXRSdW5Nb2RlID0gZnVuY3Rpb24gKGFjKSB7XHJcbiAgICBpZiAoYWMuaXNTcHJpbnRpbmcoKSkge1xyXG4gICAgICAgIHJldHVybiBcIlNwcmludGluZ1wiO1xyXG4gICAgfVxyXG4gICAgdmFyIHNwZWVkID0gYWMuZ2V0QW5pbWF0aW9uVmFyaWFibGVGbG9hdChcIlNwZWVkU2FtcGxlZFwiKTtcclxuICAgIGlmICghc3BlZWQpIHtcclxuICAgICAgICByZXR1cm4gXCJTdGFuZGluZ1wiO1xyXG4gICAgfVxyXG4gICAgdmFyIGZ1cm5pdHVyZSA9IGFjLmdldEZ1cm5pdHVyZVJlZmVyZW5jZSgpO1xyXG4gICAgaWYgKGZ1cm5pdHVyZSAhPT0gbnVsbClcclxuICAgICAgICByZXR1cm4gXCJTdGFuZGluZ1wiOyAvLyBUT0RPOiBTaXR0aW5nP1xyXG4gICAgdmFyIGlzUnVubmluZyA9IHRydWU7XHJcbiAgICBpZiAoYWMuZ2V0Rm9ybUlEKCkgPT0gMHgxNCkge1xyXG4gICAgICAgIGlmICghVEVTTW9kUGxhdGZvcm0uaXNQbGF5ZXJSdW5uaW5nRW5hYmxlZCgpIHx8IHNwZWVkIDwgMTUwKVxyXG4gICAgICAgICAgICBpc1J1bm5pbmcgPSBmYWxzZTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGlmICghYWMuaXNSdW5uaW5nKCkgfHwgc3BlZWQgPCAxNTApIHtcclxuICAgICAgICAgICAgaXNSdW5uaW5nID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGFjLmdldEFuaW1hdGlvblZhcmlhYmxlRmxvYXQoXCJJc0Jsb2NraW5nXCIpKSB7XHJcbiAgICAgICAgaXNSdW5uaW5nID0gaXNTbmVha2luZyhhYyk7XHJcbiAgICB9XHJcbiAgICB2YXIgY2FycnlXZWlnaHQgPSBhYy5nZXRBY3RvclZhbHVlKFwiQ2FycnlXZWlnaHRcIik7XHJcbiAgICB2YXIgdG90YWxJdGVtV2VpZ2h0ID0gYWMuZ2V0VG90YWxJdGVtV2VpZ2h0KCk7XHJcbiAgICBpZiAoY2FycnlXZWlnaHQgPCB0b3RhbEl0ZW1XZWlnaHQpIHtcclxuICAgICAgICBpc1J1bm5pbmcgPSBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiBpc1J1bm5pbmcgPyBcIlJ1bm5pbmdcIiA6IFwiV2Fsa2luZ1wiO1xyXG59O1xyXG4iLCJpbXBvcnQgeyBHYW1lLCBTcGVsbCwgcHJpbnRDb25zb2xlIH0gZnJvbSAnc2t5cmltUGxhdGZvcm0nO1xyXG5leHBvcnQgdmFyIHJlbW92ZUFsbFNwZWxscyA9IGZ1bmN0aW9uIChhY3Rvcikge1xyXG4gICAgdmFyIHNwZWxsVG9SZW1vdmUgPSBuZXcgQXJyYXkoKTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWN0b3IuZ2V0U3BlbGxDb3VudCgpOyBpKyspIHtcclxuICAgICAgICB2YXIgc3BlbGwgPSBhY3Rvci5nZXROdGhTcGVsbChpKTtcclxuICAgICAgICBpZiAoc3BlbGwpIHtcclxuICAgICAgICAgICAgc3BlbGxUb1JlbW92ZS5wdXNoKHNwZWxsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBmb3IgKHZhciBfaSA9IDAsIHNwZWxsVG9SZW1vdmVfMSA9IHNwZWxsVG9SZW1vdmU7IF9pIDwgc3BlbGxUb1JlbW92ZV8xLmxlbmd0aDsgX2krKykge1xyXG4gICAgICAgIHZhciBzcGVsbCA9IHNwZWxsVG9SZW1vdmVfMVtfaV07XHJcbiAgICAgICAgdmFyIHJlbW92ZVJlc3VsdCA9IGFjdG9yLnJlbW92ZVNwZWxsKHNwZWxsKTtcclxuICAgICAgICBwcmludENvbnNvbGUoXCJyZW1vdmVSZXN1bHQ6IFwiLmNvbmNhdChyZW1vdmVSZXN1bHQsIFwiLCBzcGVsbElkVG9SZW1vdmU6IFwiKS5jb25jYXQoc3BlbGxcclxuICAgICAgICAgICAgLmdldEZvcm1JRCgpXHJcbiAgICAgICAgICAgIC50b1N0cmluZygxNiksIFwiLCBzcGVsbE5hbWU6IFwiKS5jb25jYXQoc3BlbGwuZ2V0TmFtZSgpKSk7XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCB2YXIgbGVhcm5TcGVsbHMgPSBmdW5jdGlvbiAoYWN0b3IsIHNwZWxsc0lkcykge1xyXG4gICAgZm9yICh2YXIgX2kgPSAwLCBzcGVsbHNJZHNfMSA9IHNwZWxsc0lkczsgX2kgPCBzcGVsbHNJZHNfMS5sZW5ndGg7IF9pKyspIHtcclxuICAgICAgICB2YXIgc3BlbGxJZCA9IHNwZWxsc0lkc18xW19pXTtcclxuICAgICAgICB2YXIgc3BlbGwgPSBTcGVsbC5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHNwZWxsSWQpKTtcclxuICAgICAgICBpZiAoc3BlbGwpIHtcclxuICAgICAgICAgICAgdmFyIGFkZFJlc3VsdCA9IGFjdG9yLmFkZFNwZWxsKHNwZWxsLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHByaW50Q29uc29sZShcImFkZFJlc3VsdDogXCIuY29uY2F0KGFkZFJlc3VsdCwgXCIsIHNwZWxsSWRUb0xlYXJuOiBcIikuY29uY2F0KHNwZWxsXHJcbiAgICAgICAgICAgICAgICAuZ2V0Rm9ybUlEKClcclxuICAgICAgICAgICAgICAgIC50b1N0cmluZygxNiksIFwiLCBzcGVsbE5hbWU6IFwiKS5jb25jYXQoc3BlbGwuZ2V0TmFtZSgpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG4iLCJpbXBvcnQgeyBVdGlsaXR5LCBEZWJ1ZywgZ2V0UGxhdGZvcm1WZXJzaW9uLCBvbiwgR2FtZSwgVWkgfSBmcm9tICdza3lyaW1QbGF0Zm9ybSc7XHJcbmV4cG9ydCB2YXIgcmVxdWlyZWRWZXJzaW9uID0gJzIuOS4wJztcclxudmFyIHJlYWxWZXJzaW9uID0gdHlwZW9mIGdldFBsYXRmb3JtVmVyc2lvbiA9PT0gJ2Z1bmN0aW9uJyA/IGdldFBsYXRmb3JtVmVyc2lvbigpIDogJ3Vua25vd24nO1xyXG4vLyBUT0RPOiBubyBvbmUgYWN0dWFsbHkgY2FsbHMgdGhpcyBmdW5jdGlvbi4gbWFrZSBhIHNlcnZpY2VcclxuZXhwb3J0IHZhciB2ZXJpZnlWZXJzaW9uID0gZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCFyZXF1aXJlZFZlcnNpb24uaW5jbHVkZXMocmVhbFZlcnNpb24pKSB7XHJcbiAgICAgICAgRGVidWcubWVzc2FnZUJveChcIllvdSBuZWVkIHRvIGhhdmUgb24gb2YgdGhvc2UgU2t5cmltUGxhdGZvcm0gdmVyc2lvbnMgXCIuY29uY2F0KEpTT04uc3RyaW5naWZ5KHJlcXVpcmVkVmVyc2lvbiksIFwiIHRvIGpvaW4gdGhpcyBzZXJ2ZXIuIFlvdXIgY3VycmVudCB2ZXJzaW9uIGlzIFwiKS5jb25jYXQocmVhbFZlcnNpb24pKTtcclxuICAgICAgICBVdGlsaXR5LndhaXRNZW51TW9kZSgwLjUpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBvbigndXBkYXRlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFVaS5pc01lbnVPcGVuKCdNZXNzYWdlQm94TWVudScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgR2FtZS5xdWl0VG9NYWluTWVudSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuIiwiaW1wb3J0IHsgQWN0b3IsIEFjdG9yQmFzZSwgY3JlYXRlVGV4dCwgZGVzdHJveVRleHQsIEdhbWUsIEtleXdvcmQsIE5ldEltbWVyc2UsIE9iamVjdFJlZmVyZW5jZSwgb25jZSwgcHJpbnRDb25zb2xlLCBzZXRUZXh0UG9zLCBzZXRUZXh0U2l6ZSwgc2V0VGV4dFN0cmluZywgc3RvcmFnZSwgVEVTTW9kUGxhdGZvcm0sIFV0aWxpdHksIHdvcmxkUG9pbnRUb1NjcmVlblBvaW50IH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IHNldERlZmF1bHRBbmltc0Rpc2FibGVkLCBhcHBseUFuaW1hdGlvbiB9IGZyb20gXCIuLi9zeW5jL2FuaW1hdGlvblwiO1xyXG5pbXBvcnQgeyBhcHBseUFwcGVhcmFuY2UgfSBmcm9tIFwiLi4vc3luYy9hcHBlYXJhbmNlXCI7XHJcbmltcG9ydCB7IGlzQmFkTWVudVNob3duLCBhcHBseUVxdWlwbWVudCB9IGZyb20gXCIuLi9zeW5jL2VxdWlwbWVudFwiO1xyXG5pbXBvcnQgeyBSZXNwYXduTmVlZGVkRXJyb3IgfSBmcm9tIFwiLi4vbGliL2Vycm9yc1wiO1xyXG5pbXBvcnQgeyBhcHBseU1vdmVtZW50IH0gZnJvbSBcIi4uL3N5bmMvbW92ZW1lbnRBcHBseVwiO1xyXG5pbXBvcnQgeyBTcGF3blByb2Nlc3MgfSBmcm9tIFwiLi9zcGF3blByb2Nlc3NcIjtcclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tIFwiLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeFwiO1xyXG5pbXBvcnQgeyBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyIH0gZnJvbSBcIi4vcGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlclwiO1xyXG5pbXBvcnQgeyBnZXRNb3ZlbWVudCB9IGZyb20gXCIuLi9zeW5jL21vdmVtZW50R2V0XCI7XHJcbmltcG9ydCB7IGxhc3RUcnlIb3N0LCB0cnlIb3N0IH0gZnJvbSBcIi4vaG9zdEF0dGVtcHRzXCI7XHJcbmltcG9ydCB7IE1vZGVsQXBwbHlVdGlscyB9IGZyb20gXCIuL21vZGVsQXBwbHlVdGlsc1wiO1xyXG5pbXBvcnQgeyBsb2NhbElkVG9SZW1vdGVJZCB9IGZyb20gXCIuL3dvcmxkVmlld01pc2NcIjtcclxuaW1wb3J0IHsgU3BBcGlJbnRlcmFjdG9yIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NwQXBpSW50ZXJhY3RvclwiO1xyXG5pbXBvcnQgeyBXb3JsZENsZWFuZXJTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NlcnZpY2VzL3dvcmxkQ2xlYW5lclNlcnZpY2VcIjtcclxuaW1wb3J0IHsgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NlcnZpY2VzL2dhbWVtb2RlVXBkYXRlU2VydmljZVwiO1xyXG52YXIgX3NjcmVlblJlc29sdXRpb247XHJcbmV4cG9ydCB2YXIgZ2V0U2NyZWVuUmVzb2x1dGlvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICghX3NjcmVlblJlc29sdXRpb24pIHtcclxuICAgICAgICBfc2NyZWVuUmVzb2x1dGlvbiA9IHtcclxuICAgICAgICAgICAgd2lkdGg6IFV0aWxpdHkuZ2V0SU5JSW50KFwiaVNpemUgVzpEaXNwbGF5XCIpLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IFV0aWxpdHkuZ2V0SU5JSW50KFwiaVNpemUgSDpEaXNwbGF5XCIpLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gX3NjcmVlblJlc29sdXRpb247XHJcbn07XHJcbnZhciBGb3JtVmlldyA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIEZvcm1WaWV3KHJlbW90ZVJlZnJJZCkge1xyXG4gICAgICAgIHRoaXMucmVtb3RlUmVmcklkID0gcmVtb3RlUmVmcklkO1xyXG4gICAgICAgIHRoaXMubGFzdEhhcnZlc3RlZEFwcGx5ID0gMDtcclxuICAgICAgICB0aGlzLmxhc3RPcGVuQXBwbHkgPSAwO1xyXG4gICAgICAgIHRoaXMuaXNTZXROb2RlVGV4dHVyZVNldEFwcGxpZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmlzU2V0Tm9kZVNjYWxlQXBwbGllZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucmVmcklkID0gMDtcclxuICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5hbmltU3RhdGUgPSB0aGlzLmdldERlZmF1bHRBbmltU3RhdGUoKTtcclxuICAgICAgICB0aGlzLm1vdlN0YXRlID0ge1xyXG4gICAgICAgICAgICBsYXN0TnVtQ2hhbmdlczogMCxcclxuICAgICAgICAgICAgbGFzdEFwcGx5OiAwLFxyXG4gICAgICAgICAgICBsYXN0UmVob3N0OiAwLFxyXG4gICAgICAgICAgICBldmVyQXBwbGllZDogZmFsc2UsXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmFwcGVhcmFuY2VTdGF0ZSA9IHRoaXMuZ2V0RGVmYXVsdEFwcGVhcmFuY2VTdGF0ZSgpO1xyXG4gICAgICAgIHRoaXMuZXFTdGF0ZSA9IHRoaXMuZ2V0RGVmYXVsdEVxdWlwU3RhdGUoKTtcclxuICAgICAgICB0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCA9IDA7XHJcbiAgICAgICAgdGhpcy5sZXZlbGVkQmFzZUlkID0gMDtcclxuICAgICAgICB0aGlzLmlzT25TY3JlZW4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmxhc3RQY1dvcmxkT3JDZWxsID0gMDtcclxuICAgICAgICB0aGlzLmxhc3RXb3JsZE9yQ2VsbCA9IDA7XHJcbiAgICAgICAgdGhpcy5zcGF3bk1vbWVudCA9IDA7XHJcbiAgICAgICAgdGhpcy53YXNIb3N0ZWRCeU90aGVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7fTtcclxuICAgICAgICB0aGlzLmxvY2FsSW1tb3J0YWwgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnRleHROYW1lSWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgdGhpcy52b2ljZUluZGljYXRvcklkID0gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChtb2RlbCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nLCBfaDtcclxuICAgICAgICAvLyBPdGhlciBwbGF5ZXJzIG11dGF0ZSBpbnRvIFBDIGNsb25lcyB3aGVuIG1vdmluZyB0byBhbm90aGVyIGxvY2F0aW9uXHJcbiAgICAgICAgaWYgKG1vZGVsLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5sYXN0V29ybGRPckNlbGwpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RXb3JsZE9yQ2VsbCA9IG1vZGVsLm1vdmVtZW50LndvcmxkT3JDZWxsO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5sYXN0V29ybGRPckNlbGwgIT09IG1vZGVsLm1vdmVtZW50LndvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJbMV0gd29ybGRPckNlbGwgY2hhbmdlZCwgZGVzdHJveWluZyBGb3JtVmlldyBcIi5jb25jYXQodGhpcy5sYXN0V29ybGRPckNlbGwudG9TdHJpbmcoMTYpLCBcIiA9PiBcIikuY29uY2F0KG1vZGVsLm1vdmVtZW50LndvcmxkT3JDZWxsLnRvU3RyaW5nKDE2KSkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0V29ybGRPckNlbGwgPSBtb2RlbC5tb3ZlbWVudC53b3JsZE9yQ2VsbDtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZySWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIERvbid0IHNwYXduIGRlYWQgYWN0b3JzIGlmIG5vdCBhbHJlYWR5XHJcbiAgICAgICAgaWYgKG1vZGVsLmlzRGVhZCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5yZWZySWQgPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBQbGF5ZXJzIHdpdGggZGlmZmVyZW50IHdvcmxkT3JDZWxsIHNob3VsZCBiZSBpbnZpc2libGVcclxuICAgICAgICBpZiAobW9kZWwubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgdmFyIHdvcmxkT3JDZWxsID0gT2JqZWN0UmVmZXJlbmNlRXguZ2V0V29ybGRPckNlbGwoR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgICAgIGlmICh3b3JsZE9yQ2VsbCAhPT0gMCAmJlxyXG4gICAgICAgICAgICAgICAgbW9kZWwubW92ZW1lbnQud29ybGRPckNlbGwgIT09IHdvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcklkID0gMDtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBBcHBseSBhcHBlYXJhbmNlIGJlZm9yZSBiYXNlIGZvcm0gc2VsZWN0aW9uIHRvIHByZXZlbnQgZG91YmxlLXNwYXduXHJcbiAgICAgICAgaWYgKG1vZGVsLmFwcGVhcmFuY2UgfHwgKCFtb2RlbC5hcHBlYXJhbmNlICYmIHRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UpKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSB8fFxyXG4gICAgICAgICAgICAgICAgbW9kZWwubnVtQXBwZWFyYW5jZUNoYW5nZXMgIT09IHRoaXMuYXBwZWFyYW5jZVN0YXRlLmxhc3ROdW1DaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBCb3RoIG5vbi1udWxsXHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZWwuYXBwZWFyYW5jZSAmJiB0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsQXBwZWFyYW5jZUNvcHkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG1vZGVsLmFwcGVhcmFuY2UpKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdGVBcHBlYXJhbmNlQ29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5hcHBlYXJhbmNlU3RhdGUuYXBwZWFyYW5jZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1vZGVsQXBwZWFyYW5jZUNvcHkubmFtZSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVBcHBlYXJhbmNlQ29weS5uYW1lID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZXF1YWxXaXRob3V0TmFtZXMgPSBKU09OLnN0cmluZ2lmeShtb2RlbEFwcGVhcmFuY2VDb3B5KSA9PT0gSlNPTi5zdHJpbmdpZnkoc3RhdGVBcHBlYXJhbmNlQ29weSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVxdWFsV2l0aG91dE5hbWVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoYW5nZSBuYW1lIGlucGxhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZnJfMSA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHRoaXMucmVmcklkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChfYSA9IHJlZnJfMSA9PT0gbnVsbCB8fCByZWZyXzEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnJfMS5nZXRCYXNlT2JqZWN0KCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXROYW1lKG1vZGVsLmFwcGVhcmFuY2UubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJfMSA9PT0gbnVsbCB8fCByZWZyXzEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnJfMS5zZXREaXNwbGF5TmFtZShtb2RlbC5hcHBlYXJhbmNlLm5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL3ByaW50Q29uc29sZShcIkFwcGVhcmFuY2UgdXBkYXRlZCwgY2hhbmdpbmcgbmFtZSBpbnBsYWNlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRm9yY2UgcmUtYXBwbHkgYXBwZWFyYW5jZSBvbiB0aGUgbmV4dCBnZXRBcHBlYXJhbmNlQmFzZWRCYXNlIGNhbGxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL3ByaW50Q29uc29sZShcIkFwcGVhcmFuY2UgdXBkYXRlZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBGb3JjZSByZS1hcHBseSBhcHBlYXJhbmNlIG9uIHRoZSBuZXh0IGdldEFwcGVhcmFuY2VCYXNlZEJhc2UgY2FsbFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAvL3ByaW50Q29uc29sZShcIkFwcGVhcmFuY2UgdXBkYXRlZFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UgPSBtb2RlbC5hcHBlYXJhbmNlIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVhcmFuY2VTdGF0ZS5sYXN0TnVtQ2hhbmdlcyA9IG1vZGVsLm51bUFwcGVhcmFuY2VDaGFuZ2VzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciByZWZJZCA9IG1vZGVsLnJlZnJJZCAmJiBtb2RlbC5yZWZySWQgPCAweGZmMDAwMDAwID8gbW9kZWwucmVmcklkIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChyZWZJZCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5yZWZySWQgIT09IHJlZklkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVmcklkID0gbW9kZWwucmVmcklkO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVmcl8yID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgodGhpcy5yZWZySWQpKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZWZyXzIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYmFzZSA9IHJlZnJfMi5nZXRCYXNlT2JqZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJhc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0UmVmZXJlbmNlRXguZGVhbFdpdGhSZWYocmVmcl8yLCBiYXNlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZUNoYWluID0gbW9kZWwudGVtcGxhdGVDaGFpbjtcclxuICAgICAgICAgICAgLy8gVGhlcmUgaXMgbm8gcGxhY2UgZm9yIHJhbmRvbS9sZXZlbGluZyBpbiAxLXNpemVkIGNoYWluXHJcbiAgICAgICAgICAgIC8vIEp1c3Qgc3Bhd24gYW4gTlBDLCBkbyBub3QgZ2VuZXJhdGUgYSB0ZW1wb3JhcnkgVEVTTlBDIGZvcm1cclxuICAgICAgICAgICAgaWYgKCh0ZW1wbGF0ZUNoYWluID09PSBudWxsIHx8IHRlbXBsYXRlQ2hhaW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRlbXBsYXRlQ2hhaW4ubGVuZ3RoKSA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVDaGFpbiA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBUT0RPOiBnZXRMZXZlbGVkQmFzZSBjcmFzaGVzIHRvbyBvZnRlbiBBVE1cclxuICAgICAgICAgICAgdmFyIGJhc2UgPSBudWxsOyAvL0dhbWUuZ2V0Rm9ybUV4KHRoaXMuZ2V0TGV2ZWxlZEJhc2UodGVtcGxhdGVDaGFpbikpO1xyXG4gICAgICAgICAgICBpZiAoYmFzZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgYmFzZSA9IEdhbWUuZ2V0Rm9ybUV4KG1vZGVsLmJhc2VJZCB8fCBOYU4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChiYXNlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBiYXNlID0gR2FtZS5nZXRGb3JtRXgodGhpcy5nZXRBcHBlYXJhbmNlQmFzZWRCYXNlKCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChiYXNlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHJlZnJfMyA9IE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybUV4KHRoaXMucmVmcklkKSk7XHJcbiAgICAgICAgICAgIHZhciByZXNwYXduUmVxdWlyZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKCFyZWZyXzMpIHtcclxuICAgICAgICAgICAgICAgIHJlc3Bhd25SZXF1aXJlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoIXJlZnJfMy5nZXRCYXNlT2JqZWN0KCkpIHtcclxuICAgICAgICAgICAgICAgIHJlc3Bhd25SZXF1aXJlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAocmVmcl8zLmdldEJhc2VPYmplY3QoKS5nZXRGb3JtSUQoKSAhPT0gYmFzZS5nZXRGb3JtSUQoKSkge1xyXG4gICAgICAgICAgICAgICAgcmVzcGF3blJlcXVpcmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocmVzcGF3blJlcXVpcmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIHZhciBwbGF5ZXJfMSA9IEdhbWUuZ2V0UGxheWVyKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3Bhd25NZXRob2RPcmlnaW5hbCA9IHtcclxuICAgICAgICAgICAgICAgICAgICBzcGF3bjogZnVuY3Rpb24gKGJhc2VGb3JtLCBfc3Bhd25Qb3NpdGlvbiwgX3NwYXduUm90YXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsYXllcl8xLnBsYWNlQXRNZShiYXNlRm9ybSwgMSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyU3Bhd25Qcm9jZXNzOiBmdW5jdGlvbiAoc3Bhd25pbmdSZWZyLCBzcGF3blBvc2l0aW9uLCBhcHBlYXJhbmNlLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgU3Bhd25Qcm9jZXNzKGFwcGVhcmFuY2UsIHNwYXduUG9zaXRpb24sIHNwYXduaW5nUmVmci5nZXRGb3JtSUQoKSwgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB2YXIgc3Bhd25NZXRob2RTdHViID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwYXduOiBmdW5jdGlvbiAoYmFzZUZvcm0sIHNwYXduUG9zaXRpb24sIHNwYXduUm90YXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGYgPSBzdG9yYWdlW1wiZm9ybVZpZXdGdW5jMVwiXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9IGYoYmFzZUZvcm0sIHNwYXduUG9zaXRpb24sIHNwYXduUm90YXRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVmO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlclNwYXduUHJvY2VzczogZnVuY3Rpb24gKHNwYXduaW5nUmVmciwgc3Bhd25Qb3NpdGlvbiwgYXBwZWFyYW5jZSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGYgPSBzdG9yYWdlW1wiZm9ybVZpZXdGdW5jMlwiXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZihzcGF3bmluZ1JlZnIsIHNwYXduUG9zaXRpb24sIGFwcGVhcmFuY2UsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwYXduVXNpbmdTdHViTWV0aG9kID0gYmFzZS5nZXRUeXBlKCkgPT09IDQzIC8qIEZvcm1UeXBlLk5QQyAqL1xyXG4gICAgICAgICAgICAgICAgICAgICYmICF0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgc3RvcmFnZVtcImZvcm1WaWV3RnVuYzFTZXRcIl0gPT09IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAmJiBzdG9yYWdlW1wiZm9ybVZpZXdGdW5jMlNldFwiXSA9PT0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHZhciBzcGF3bk1ldGhvZCA9IHNwYXduVXNpbmdTdHViTWV0aG9kID8gc3Bhd25NZXRob2RTdHViIDogc3Bhd25NZXRob2RPcmlnaW5hbDtcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbC5tb3ZlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnJfMyA9IHNwYXduTWV0aG9kLnNwYXduKGJhc2UsIG1vZGVsLm1vdmVtZW50LnBvcywgbW9kZWwubW92ZW1lbnQucm90KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHByaW50Q29uc29sZShcIm1vZGVsLm1vdmVtZW50IHdhcyBcIiArIG1vZGVsLm1vdmVtZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSB7fTtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndhc0hvc3RlZEJ5T3RoZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAoYmFzZS5nZXRUeXBlKCkgIT09IDQzIC8qIEZvcm1UeXBlLk5QQyAqLykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnJfMyA9PT0gbnVsbCB8fCByZWZyXzMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnJfMy5zZXRBbmdsZSgoKF9iID0gbW9kZWwubW92ZW1lbnQpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5yb3RbMF0pIHx8IDAsICgoX2MgPSBtb2RlbC5tb3ZlbWVudCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnJvdFsxXSkgfHwgMCwgKChfZCA9IG1vZGVsLm1vdmVtZW50KSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Qucm90WzJdKSB8fCAwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciByYWNlID0gKF9mID0gKF9lID0gQWN0b3IuZnJvbShyZWZyXzMpKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UuZ2V0UmFjZSgpKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2YuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRyYXVnclJhY2UgPSAweGQ1MztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZmFsbWVyUmFjZSA9IDB4MTMxZjQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNoYXVydXNSYWNlID0gMHgxMzFlYjtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZnJvc3RiaXRlU3BpZGVyUmFjZUdpYW50ID0gMHg0ZTUwNztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZnJvc3RiaXRlU3BpZGVyUmFjZUxhcmdlID0gMHg1MzQ3NztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZHdhcnZlbkNlbnR1cmlvblJhY2UgPSAweDEzMWYxO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkd2FydmVuU3BoZXJlUmFjZSA9IDB4MTMxZjI7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGR3YXJ2ZW5TcGlkZXJSYWNlID0gMHgxMzFmMztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3ByaWdnYW5SYWNlID0gMHgyMDEzYjc3O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcHJpZ2dhblJhY2UyID0gMHhmMzkwMztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3ByaWdnYW5SYWNlMyA9IDB4MTMyMDQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwcmlnZ2FuUmFjZTQgPSAweDQwMWI2NDQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwcmlnZ2FuUmFjZTUgPSAweDlhYTQ0O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB3b2xmUmFjZSA9IDB4MTMyMGE7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gcG90ZW50aWFsIG1hc3RlcmFtYnVzaHNjcmlwdFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyYWNlID09PSBkcmF1Z3JSYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGZhbG1lclJhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gY2hhdXJ1c1JhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gZnJvc3RiaXRlU3BpZGVyUmFjZUdpYW50XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IGZyb3N0Yml0ZVNwaWRlclJhY2VMYXJnZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBkd2FydmVuQ2VudHVyaW9uUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBkd2FydmVuU3BoZXJlUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBkd2FydmVuU3BpZGVyUmFjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBzcHJpZ2dhblJhY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gc3ByaWdnYW5SYWNlMlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSBzcHJpZ2dhblJhY2UzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IHJhY2UgPT09IHNwcmlnZ2FuUmFjZTRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgcmFjZSA9PT0gc3ByaWdnYW5SYWNlNVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCByYWNlID09PSB3b2xmUmFjZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAoX2cgPSBBY3Rvci5mcm9tKHJlZnJfMykpID09PSBudWxsIHx8IF9nID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZy5zZXRBY3RvclZhbHVlKFwiQWdncmVzc2lvblwiLCAyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmcl8zICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmxvb2t1cExpc3RlbmVyKFdvcmxkQ2xlYW5lclNlcnZpY2UpLm1vZFdjUHJvdGVjdGlvbihyZWZyXzMuZ2V0Rm9ybUlEKCksIDEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogcmVzZXQgYWxsIHN0YXRlcz9cclxuICAgICAgICAgICAgICAgIHRoaXMuZXFTdGF0ZSA9IHRoaXMuZ2V0RGVmYXVsdEVxdWlwU3RhdGUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYW5pbVN0YXRlID0gdGhpcy5nZXREZWZhdWx0QW5pbVN0YXRlKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3Bhd25Qb3MgPSB2b2lkIDA7XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZWwubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzcGF3blBvcyA9IG1vZGVsLm1vdmVtZW50LnBvcztcclxuICAgICAgICAgICAgICAgICAgICAvLyBwcmludENvbnNvbGUoXCJTcGF3biBOUEMgYXQgbW92ZW1lbnQucG9zXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25Qb3MgPSBPYmplY3RSZWZlcmVuY2VFeC5nZXRQb3MoR2FtZS5nZXRQbGF5ZXIoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJpbnRDb25zb2xlKFwiU3Bhd24gTlBDIGF0IHBsYXllciBwb3NcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmcl8zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3Bhd25NZXRob2QudHJpZ2dlclNwYXduUHJvY2VzcyhyZWZyXzMsIHNwYXduUG9zLCBtb2RlbC5hcHBlYXJhbmNlIHx8IG51bGwsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVhZHkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zcGF3bk1vbWVudCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJVbmFibGUgdG8gdHJpZ2dlclNwYXduUHJvY2VzcyBmb3IgbnVsbCByZWZyXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGVsLmFwcGVhcmFuY2UgJiYgbW9kZWwuYXBwZWFyYW5jZS5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmcl8zID09PSBudWxsIHx8IHJlZnJfMyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmcl8zLnNldERpc3BsYXlOYW1lKFwiXCIgKyBtb2RlbC5hcHBlYXJhbmNlLm5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKF9oID0gQWN0b3IuZnJvbShyZWZyXzMpKSA9PT0gbnVsbCB8fCBfaCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2guc2V0QWN0b3JWYWx1ZShcImF0dGFja0RhbWFnZU11bHRcIiwgMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5yZWZySWQgPSByZWZyXzMuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5yZWFkeSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgodGhpcy5yZWZySWQpKTtcclxuICAgICAgICBpZiAocmVmcikge1xyXG4gICAgICAgICAgICB2YXIgYWN0b3IgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAoYWN0b3IgJiYgIXRoaXMubG9jYWxJbW1vcnRhbCkge1xyXG4gICAgICAgICAgICAgICAgYWN0b3Iuc3RhcnREZWZlcnJlZEtpbGwoKTtcclxuICAgICAgICAgICAgICAgIGFjdG9yLnNldEFjdG9yVmFsdWUoXCJoZWFsdGhcIiwgMTAwMDAwMCk7XHJcbiAgICAgICAgICAgICAgICBhY3Rvci5zZXRBY3RvclZhbHVlKFwibWFnaWNrYVwiLCAxMDAwMDAwKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxJbW1vcnRhbCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5hcHBseUFsbChyZWZyLCBtb2RlbCk7XHJcbiAgICAgICAgICAgIHZhciBnYW1lbW9kZVVwZGF0ZVNlcnZpY2UgPSBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkubG9va3VwTGlzdGVuZXIoR2FtZW1vZGVVcGRhdGVTZXJ2aWNlKTtcclxuICAgICAgICAgICAgZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnVwZGF0ZU5laWdoYm9yKHJlZnIsIG1vZGVsLCB0aGlzLnN0YXRlKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5pc09uU2NyZWVuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5zcGF3bk1vbWVudCA9IDA7XHJcbiAgICAgICAgdmFyIHJlZnJJZCA9IHRoaXMucmVmcklkO1xyXG4gICAgICAgIG9uY2UoXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAocmVmcklkID49IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnIuZGVsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkubG9va3VwTGlzdGVuZXIoV29ybGRDbGVhbmVyU2VydmljZSkubW9kV2NQcm90ZWN0aW9uKHJlZnJJZCwgLTEpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgICAgIGlmIChhYykge1xyXG4gICAgICAgICAgICAgICAgICAgIFRFU01vZFBsYXRmb3JtLnNldFdlYXBvbkRyYXduTW9kZShhYywgLTEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5sb2NhbEltbW9ydGFsID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVOaWNrbmFtZSgpO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5hcHBseUFsbCA9IGZ1bmN0aW9uIChyZWZyLCBtb2RlbCkge1xyXG4gICAgICAgIHZhciBfYSwgX2IsIF9jO1xyXG4gICAgICAgIHZhciBmb3JjZWRXZWFwRHJhd24gPSBudWxsO1xyXG4gICAgICAgIGlmIChQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldENyb3NzaGFpclJlZklkKCkgPT09IHRoaXMucmVmcklkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdEhhcnZlc3RlZEFwcGx5ID0gMDtcclxuICAgICAgICAgICAgdGhpcy5sYXN0T3BlbkFwcGx5ID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgaWYgKG5vdyAtIHRoaXMubGFzdEhhcnZlc3RlZEFwcGx5ID4gNjY2KSB7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdEhhcnZlc3RlZEFwcGx5ID0gbm93O1xyXG4gICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbElzSGFydmVzdGVkKHJlZnIsICEhbW9kZWwuaXNIYXJ2ZXN0ZWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobm93IC0gdGhpcy5sYXN0T3BlbkFwcGx5ID4gMTMzKSB7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdE9wZW5BcHBseSA9IG5vdztcclxuICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxJc09wZW4ocmVmciwgISFtb2RlbC5pc09wZW4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuaXNTZXROb2RlU2NhbGVBcHBsaWVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNTZXROb2RlU2NhbGVBcHBsaWVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgTW9kZWxBcHBseVV0aWxzLmFwcGx5TW9kZWxOb2RlU2NhbGUocmVmciwgbW9kZWwuc2V0Tm9kZVNjYWxlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzU2V0Tm9kZVRleHR1cmVTZXRBcHBsaWVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNTZXROb2RlVGV4dHVyZVNldEFwcGxpZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbE5vZGVUZXh0dXJlU2V0KHJlZnIsIG1vZGVsLnNldE5vZGVUZXh0dXJlU2V0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsLmludmVudG9yeSAmJlxyXG4gICAgICAgICAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldENyb3NzaGFpclJlZklkKCkgPT0gdGhpcy5yZWZySWQgJiZcclxuICAgICAgICAgICAgIWlzQmFkTWVudVNob3duKCkpIHtcclxuICAgICAgICAgICAgLy8gRG8gbm90IGxldCBhY3RvcnMgYnJlYWtpbmcgdGhlaXIgZXF1aXBtZW50IHZpYSBpbnZlbnRvcnkgYXBwbHlcclxuICAgICAgICAgICAgLy8gSG93ZXZlciwgYWN0dWFsbHksIGFjdG9ycyBkbyBub3QgaGF2ZSBpbnZlbnRvcnkgaW4gdGhlaXIgbW9kZWxzXHJcbiAgICAgICAgICAgIC8vIEV4Y2VwdCB5b3VyIGNsb25lLlxyXG4gICAgICAgICAgICBpZiAoIUFjdG9yLmZyb20ocmVmcikpIHtcclxuICAgICAgICAgICAgICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSW52ZW50b3J5KHJlZnIsIG1vZGVsLmludmVudG9yeSk7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5pbnZlbnRvcnkgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsLmFuaW1hdGlvbikge1xyXG4gICAgICAgICAgICBpZiAobW9kZWwuYW5pbWF0aW9uLmFuaW1FdmVudE5hbWUgPT09IFwiU2t5bXBGYWtlVW5lcXVpcFwiKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JjZWRXZWFwRHJhd24gPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChtb2RlbC5hbmltYXRpb24uYW5pbUV2ZW50TmFtZSA9PT0gXCJTa3ltcEZha2VFcXVpcFwiKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JjZWRXZWFwRHJhd24gPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFRPRE86IG1ha2UgaG9zdCBzZXJ2aWNlXHJcbiAgICAgICAgdmFyIGhvc3RlZCA9IHN0b3JhZ2VbJ2hvc3RlZCddO1xyXG4gICAgICAgIHZhciBhbHJlYWR5SG9zdGVkID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaG9zdGVkKSkge1xyXG4gICAgICAgICAgICB2YXIgcmVtb3RlSWQgPSBsb2NhbElkVG9SZW1vdGVJZCh0aGlzLnJlZnJJZCk7XHJcbiAgICAgICAgICAgIGlmIChob3N0ZWQuaW5jbHVkZXMocmVtb3RlSWQpIHx8IGhvc3RlZC5pbmNsdWRlcyhyZW1vdGVJZCArIDB4MTAwMDAwMDAwKSkge1xyXG4gICAgICAgICAgICAgICAgYWxyZWFkeUhvc3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgc2V0RGVmYXVsdEFuaW1zRGlzYWJsZWQodGhpcy5yZWZySWQsIGFscmVhZHlIb3N0ZWQgPyBmYWxzZSA6IHRydWUpO1xyXG4gICAgICAgIGlmIChhbHJlYWR5SG9zdGVkKSB7XHJcbiAgICAgICAgICAgIChfYSA9IEFjdG9yLmZyb20ocmVmcikpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbGVhcktlZXBPZmZzZXRGcm9tQWN0b3IoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsLm1vdmVtZW50KSB7XHJcbiAgICAgICAgICAgIHZhciBhYyA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm1vdlN0YXRlLmxhc3RBcHBseSAmJlxyXG4gICAgICAgICAgICAgICAgRGF0ZS5ub3coKSAtIHRoaXMubW92U3RhdGUubGFzdEFwcGx5ID4gMTUwMCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKERhdGUubm93KCkgLSB0aGlzLm1vdlN0YXRlLmxhc3RSZWhvc3QgPiAxMDAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZTdGF0ZS5sYXN0UmVob3N0ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVtb3RlSWQgPSB0aGlzLnJlbW90ZVJlZnJJZDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYWMgJiYgYWMuaXMzRExvYWRlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJ5SG9zdElmTmVlZChhYywgcmVtb3RlSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJ0cnlIb3N0SWZOZWVkIC0gcmVhc29uOiBub3Qgc2VlaW5nIG1vdmVtZW50IGZvciBsb25nIHRpbWVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICgrbW9kZWwubnVtTW92ZW1lbnRDaGFuZ2VzICE9PVxyXG4gICAgICAgICAgICAgICAgdGhpcy5tb3ZTdGF0ZS5sYXN0TnVtQ2hhbmdlcyB8fFxyXG4gICAgICAgICAgICAgICAgRGF0ZS5ub3coKSAtIHRoaXMubW92U3RhdGUubGFzdEFwcGx5ID4gMjAwMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tb3ZTdGF0ZS5sYXN0QXBwbHkgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGVsLmlzSG9zdGVkQnlPdGhlciB8fCAhdGhpcy5tb3ZTdGF0ZS5ldmVyQXBwbGllZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiYWNrdXAgPSBtb2RlbC5tb3ZlbWVudC5pc1dlYXBEcmF3bjtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9yY2VkV2VhcERyYXduID09PSB0cnVlIHx8IGZvcmNlZFdlYXBEcmF3biA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwubW92ZW1lbnQuaXNXZWFwRHJhd24gPSBmb3JjZWRXZWFwRHJhd247XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5TW92ZW1lbnQocmVmciwgbW9kZWwubW92ZW1lbnQsICEhbW9kZWwuaXNNeUNsb25lKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBSZXNwYXduTmVlZGVkRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFdvcmxkT3JDZWxsID0gbW9kZWwubW92ZW1lbnQud29ybGRPckNlbGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVmcklkID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbW9kZWwubW92ZW1lbnQuaXNXZWFwRHJhd24gPSBiYWNrdXA7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZTdGF0ZS5sYXN0TnVtQ2hhbmdlcyA9ICttb2RlbC5udW1Nb3ZlbWVudENoYW5nZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZTdGF0ZS5ldmVyQXBwbGllZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVtb3RlSWQgPSB0aGlzLnJlbW90ZVJlZnJJZDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYWMgJiYgcmVtb3RlSWQgJiYgYWMuaXMzRExvYWRlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjLmNsZWFyS2VlcE9mZnNldEZyb21BY3RvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBtYWtlIGhvc3Qgc2VydmljZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaG9zdGVkXzEgPSBzdG9yYWdlWydob3N0ZWQnXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFscmVhZHlIb3N0ZWRfMSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShob3N0ZWRfMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZW1vdGVJZF8xID0gbG9jYWxJZFRvUmVtb3RlSWQoYWMuZ2V0Rm9ybUlEKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhvc3RlZF8xLmluY2x1ZGVzKHJlbW90ZUlkXzEpIHx8IGhvc3RlZF8xLmluY2x1ZGVzKHJlbW90ZUlkXzEgKyAweDEwMDAwMDAwMCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHJlYWR5SG9zdGVkXzEgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYWxyZWFkeUhvc3RlZF8xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50cnlIb3N0SWZOZWVkKGFjLCByZW1vdGVJZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcmV2aW91c2x5LCB3ZSBkaWQgdGhpcyBjbGVhbnVwIG9uIGVhY2ggdXBkYXRlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IEkgZ3Vlc3MgaXQncyB0b28gZXhwZW5zaXZlIGFuZCBjYW4gcG9zc2libHkgaHVydCBGUFNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBURVNNb2RQbGF0Zm9ybS5zZXRXZWFwb25EcmF3bk1vZGUoYWMsIC0xKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocmVmci5pczNETG9hZGVkKCkpIHtcclxuICAgICAgICAgICAgaWYgKG1vZGVsLmFuaW1hdGlvbikge1xyXG4gICAgICAgICAgICAgICAgYXBwbHlBbmltYXRpb24ocmVmciwgbW9kZWwuYW5pbWF0aW9uLCB0aGlzLmFuaW1TdGF0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gVXNlIHRoZW0gb25seSBvbmNlLCBmb3Igc3Bhd25pbmcgYWN0b3JzIHdpdGggY29ycmVjdCBhbmltYXRpb25zXHJcbiAgICAgICAgICAgIHRoaXMuYW5pbVN0YXRlLnVzZUFuaW1PdmVycmlkZXMgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsLmFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgdmFyIGFjdG9yID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICAgICAgaWYgKGFjdG9yICYmICFQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmlzSW5KdW1wU3RhdGUoKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0V29ybGRPckNlbGwoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxhc3RQY1dvcmxkT3JDZWxsICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0V29ybGRPckNlbGwoKSAhPT0gdGhpcy5sYXN0UGNXb3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWRyYXcgdGludHMgaWYgUEMgd29ybGQvY2VsbCBjaGFuZ2VkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXNPblNjcmVlbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RQY1dvcmxkT3JDZWxsID0gUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5nZXRXb3JsZE9yQ2VsbCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIGhlYWRQb3MgPSBbXHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5nZXROb2RlV29ybGRQb3NpdGlvblgoYWN0b3IsIFwiTlBDIEhlYWQgW0hlYWRdXCIsIGZhbHNlKSxcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLmdldE5vZGVXb3JsZFBvc2l0aW9uWShhY3RvciwgXCJOUEMgSGVhZCBbSGVhZF1cIiwgZmFsc2UpLFxyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2UuZ2V0Tm9kZVdvcmxkUG9zaXRpb25aKGFjdG9yLCBcIk5QQyBIZWFkIFtIZWFkXVwiLCBmYWxzZSksXHJcbiAgICAgICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICAgICAgdmFyIHNjcmVlblBvaW50ID0gd29ybGRQb2ludFRvU2NyZWVuUG9pbnQoaGVhZFBvcylbMF07XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNPblNjcmVlbiA9IHNjcmVlblBvaW50WzBdID4gMCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblBvaW50WzFdID4gMCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblBvaW50WzJdID4gMCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblBvaW50WzBdIDwgMSAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblBvaW50WzFdIDwgMSAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblBvaW50WzJdIDwgMTtcclxuICAgICAgICAgICAgICAgIGlmIChpc09uU2NyZWVuICE9IHRoaXMuaXNPblNjcmVlbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNPblNjcmVlbiA9IGlzT25TY3JlZW47XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzT25TY3JlZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3IucXVldWVOaU5vZGVVcGRhdGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgR2FtZS5nZXRQbGF5ZXIoKS5xdWV1ZU5pTm9kZVVwZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWwuZXF1aXBtZW50KSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVxU3RhdGUubGFzdE51bUNoYW5nZXMgIT09IG1vZGVsLmVxdWlwbWVudC5udW1DaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWMgPSBBY3Rvci5mcm9tKHJlZnIpO1xyXG4gICAgICAgICAgICAgICAgLy8gSWYgd2UgZG8gbm90IGJsb2NrIGludmVudG9yeSBoZXJlLCB3ZSB3aWxsIGJlIGFibGUgdG8gcmVwcm9kdWNlIHRoZSBidWc6XHJcbiAgICAgICAgICAgICAgICAvLyAxLiBQbGFjZSB+OTAgYm90cyBhbmQgZm9yY2UgdGhlbSB0byByZWVxdWlwIGlyb24gc3dvcmRzIHRvIHRoZSBsZWZ0IGhhbmQgKHJhdGUgc2hvdWxkIGJlIH41MG1zKVxyXG4gICAgICAgICAgICAgICAgLy8gMi4gT3BlbiB5b3VyIGludmVudG9yeSBhbmQgcmVlcXVpcCBkaWZmZXJlbnQgaXRlbXMgZmFzdFxyXG4gICAgICAgICAgICAgICAgLy8gMy4gQWZ0ZXIgMS0yIG1pbnV0ZXMgY2xvc2UgeW91ciBpbnZlbnRvcnkgYW5kIHNlZSB0aGF0IEhVRCBkaXNhcHBlYXJlZFxyXG4gICAgICAgICAgICAgICAgaWYgKGFjICYmXHJcbiAgICAgICAgICAgICAgICAgICAgIWlzQmFkTWVudVNob3duKCkgJiZcclxuICAgICAgICAgICAgICAgICAgICBEYXRlLm5vdygpIC0gdGhpcy5lcVN0YXRlLmxhc3RFcU1vbWVudCA+IDUwMCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIERhdGUubm93KCkgLSB0aGlzLnNwYXduTW9tZW50ID4gLTEgJiZcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNwYXduTW9tZW50ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vaWYgKHRoaXMuc3Bhd25Nb21lbnQgPiAwICYmIERhdGUubm93KCkgLSB0aGlzLnNwYXduTW9tZW50ID4gNTAwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHBseUVxdWlwbWVudChhYywgbW9kZWwuZXF1aXBtZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVxU3RhdGUubGFzdE51bUNoYW5nZXMgPSBtb2RlbC5lcXVpcG1lbnQubnVtQ2hhbmdlcztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lcVN0YXRlLmxhc3RFcU1vbWVudCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zdCByZXM6IGJvb2xlYW4gPSBhcHBseUVxdWlwbWVudChhYywgbW9kZWwuZXF1aXBtZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAvL2lmIChyZXMpIHRoaXMuZXFTdGF0ZS5sYXN0TnVtQ2hhbmdlcyA9IG1vZGVsLmVxdWlwbWVudC5udW1DaGFuZ2VzO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChGb3JtVmlldy5pc0Rpc3BsYXlpbmdOaWNrbmFtZXMgJiYgdGhpcy5yZWZySWQgJiYgKChfYiA9IG1vZGVsLmFwcGVhcmFuY2UpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5uYW1lKSkge1xyXG4gICAgICAgICAgICB2YXIgaGVhZFBhcnQgPSBcIk5QQyBIZWFkIFtIZWFkXVwiO1xyXG4gICAgICAgICAgICB2YXIgbWF4Tmlja25hbWVEcmF3RGlzdGFuY2UgPSAxMDAwO1xyXG4gICAgICAgICAgICB2YXIgcGxheWVyQWN0b3IgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgICAgICB2YXIgaXNWaXNpYmxlQnlQbGF5ZXIgPSAhKChfYyA9IG1vZGVsLm1vdmVtZW50KSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuaXNTbmVha2luZylcclxuICAgICAgICAgICAgICAgICYmIHBsYXllckFjdG9yLmdldERpc3RhbmNlKHJlZnIpIDw9IG1heE5pY2tuYW1lRHJhd0Rpc3RhbmNlXHJcbiAgICAgICAgICAgICAgICAmJiBwbGF5ZXJBY3Rvci5oYXNMT1MocmVmcilcclxuICAgICAgICAgICAgICAgICYmICF0aGlzLmlzU3dlZXRIaWRlUGVyc29uKHJlZnIpO1xyXG4gICAgICAgICAgICBpZiAoaXNWaXNpYmxlQnlQbGF5ZXIpIHtcclxuICAgICAgICAgICAgICAgIHZhciBoZWFkU2NyZWVuUG9zID0gd29ybGRQb2ludFRvU2NyZWVuUG9pbnQoW1xyXG4gICAgICAgICAgICAgICAgICAgIE5ldEltbWVyc2UuZ2V0Tm9kZVdvcmxkUG9zaXRpb25YKHJlZnIsIGhlYWRQYXJ0LCBmYWxzZSksXHJcbiAgICAgICAgICAgICAgICAgICAgTmV0SW1tZXJzZS5nZXROb2RlV29ybGRQb3NpdGlvblkocmVmciwgaGVhZFBhcnQsIGZhbHNlKSxcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLmdldE5vZGVXb3JsZFBvc2l0aW9uWihyZWZyLCBoZWFkUGFydCwgZmFsc2UpICsgMzJcclxuICAgICAgICAgICAgICAgIF0pWzBdO1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlc29sdXRpb24gPSBnZXRTY3JlZW5SZXNvbHV0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGV4dFhQb3MgPSBNYXRoLnJvdW5kKGhlYWRTY3JlZW5Qb3NbMF0gKiByZXNvbHV0aW9uLndpZHRoKTtcclxuICAgICAgICAgICAgICAgIHZhciB0ZXh0WVBvcyA9IE1hdGgucm91bmQoKDEgLSBoZWFkU2NyZWVuUG9zWzFdKSAqIHJlc29sdXRpb24uaGVpZ2h0KTtcclxuICAgICAgICAgICAgICAgIHZhciBpc1RhbGtpbmdUZXh0ID0gKG1vZGVsID09PSBudWxsIHx8IG1vZGVsID09PSB2b2lkIDAgPyB2b2lkIDAgOiBtb2RlbC5pc1RhbGtpbmcpID8gXCJTcGVha2luZ1wiIDogXCJcIjtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy50ZXh0TmFtZUlkICYmIGhlYWRTY3JlZW5Qb3NbMl0gPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0TmFtZUlkID0gY3JlYXRlVGV4dCh0ZXh0WFBvcywgdGV4dFlQb3MsIHJlZnIuZ2V0RGlzcGxheU5hbWUoKSwgWzEsIDEsIDEsIDAuOF0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFRleHRTaXplKHRoaXMudGV4dE5hbWVJZCwgMC41KTtcclxuICAgICAgICAgICAgICAgICAgICBTcEFwaUludGVyYWN0b3IuZ2V0Q29udHJvbGxlckluc3RhbmNlKCkuZW1pdHRlci5lbWl0KFwibmlja25hbWVDcmVhdGVcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVSZWZySWQ6IHRoaXMuZ2V0UmVtb3RlUmVmcklkKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRJZDogdGhpcy50ZXh0TmFtZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZGVsZXRlTmlja25hbWUgPSBoZWFkU2NyZWVuUG9zWzJdIDwgMDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlTmlja25hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVOaWNrbmFtZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50ZXh0TmFtZUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRleHRQb3ModGhpcy50ZXh0TmFtZUlkLCB0ZXh0WFBvcywgdGV4dFlQb3MpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy52b2ljZUluZGljYXRvcklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52b2ljZUluZGljYXRvcklkID0gY3JlYXRlVGV4dCh0ZXh0WFBvcywgdGV4dFlQb3MgLSAzNSwgXCJcIiwgWzEsIDAuODUsIDAuMiwgMC44XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGV4dFNpemUodGhpcy52b2ljZUluZGljYXRvcklkLCAwLjQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudm9pY2VJbmRpY2F0b3JJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUZXh0U3RyaW5nKHRoaXMudm9pY2VJbmRpY2F0b3JJZCwgaGVhZFNjcmVlblBvc1syXSA+PSAwID8gaXNUYWxraW5nVGV4dCA6IFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUZXh0UG9zKHRoaXMudm9pY2VJbmRpY2F0b3JJZCwgdGV4dFhQb3MsIHRleHRZUG9zIC0gMzUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTmlja25hbWUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVOaWNrbmFtZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuaXNTd2VldEhpZGVQZXJzb24gPSBmdW5jdGlvbiAocmVmcikge1xyXG4gICAgICAgIHZhciBhY3RvciA9IEFjdG9yLmZyb20ocmVmcik7XHJcbiAgICAgICAgaWYgKCFhY3Rvcikge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBrZXl3b3JkID0gS2V5d29yZC5nZXRLZXl3b3JkKCdTd2VldEhpZGVQZXJzb24nKTtcclxuICAgICAgICByZXR1cm4gYWN0b3Iud29ybkhhc0tleXdvcmQoa2V5d29yZCk7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLnJlbW92ZU5pY2tuYW1lID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnRleHROYW1lSWQpIHtcclxuICAgICAgICAgICAgU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmVtaXR0ZXIuZW1pdChcIm5pY2tuYW1lRGVzdHJveVwiLCB7XHJcbiAgICAgICAgICAgICAgICByZW1vdGVSZWZySWQ6IHRoaXMuZ2V0UmVtb3RlUmVmcklkKCksXHJcbiAgICAgICAgICAgICAgICB0ZXh0SWQ6IHRoaXMudGV4dE5hbWVJZFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZGVzdHJveVRleHQodGhpcy50ZXh0TmFtZUlkKTtcclxuICAgICAgICAgICAgdGhpcy50ZXh0TmFtZUlkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy52b2ljZUluZGljYXRvcklkKSB7XHJcbiAgICAgICAgICAgIGRlc3Ryb3lUZXh0KHRoaXMudm9pY2VJbmRpY2F0b3JJZCk7XHJcbiAgICAgICAgICAgIHRoaXMudm9pY2VJbmRpY2F0b3JJZCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldEFwcGVhcmFuY2VCYXNlZEJhc2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGJhc2UgPSBBY3RvckJhc2UuZnJvbShHYW1lLmdldEZvcm1FeCh0aGlzLmFwcGVhcmFuY2VCYXNlZEJhc2VJZCkpO1xyXG4gICAgICAgIGlmICghYmFzZSAmJiB0aGlzLmFwcGVhcmFuY2VTdGF0ZS5hcHBlYXJhbmNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwZWFyYW5jZUJhc2VkQmFzZUlkID0gYXBwbHlBcHBlYXJhbmNlKHRoaXMuYXBwZWFyYW5jZVN0YXRlLmFwcGVhcmFuY2UpLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5hcHBlYXJhbmNlQmFzZWRCYXNlSWQ7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldExldmVsZWRCYXNlID0gZnVuY3Rpb24gKHRlbXBsYXRlQ2hhaW4pIHtcclxuICAgICAgICBpZiAodGVtcGxhdGVDaGFpbiA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc3RyID0gdGVtcGxhdGVDaGFpbi5qb2luKCcsJyk7XHJcbiAgICAgICAgaWYgKHRoaXMubGV2ZWxlZEJhc2VJZCA9PT0gMCkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHZhciBsZXZlbGVkQmFzZSA9IFRFU01vZFBsYXRmb3JtLmV2YWx1YXRlTGV2ZWxlZE5wYyhzdHIpO1xyXG4gICAgICAgICAgICBpZiAoIWxldmVsZWRCYXNlKSB7XHJcbiAgICAgICAgICAgICAgICBwcmludENvbnNvbGUoXCJGYWlsZWQgdG8gZXZhbHVhdGUgbGV2ZWxlZCBucGNcIiwgc3RyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmxldmVsZWRCYXNlSWQgPSAobGV2ZWxlZEJhc2UgPT09IG51bGwgfHwgbGV2ZWxlZEJhc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxldmVsZWRCYXNlLmdldEZvcm1JRCgpKSB8fCAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5sZXZlbGVkQmFzZUlkO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS5nZXREZWZhdWx0RXF1aXBTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4geyBsYXN0TnVtQ2hhbmdlczogMCwgbGFzdEVxTW9tZW50OiAwIH07XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldERlZmF1bHRBcHBlYXJhbmNlU3RhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgbGFzdE51bUNoYW5nZXM6IDAsIGFwcGVhcmFuY2U6IG51bGwgfTtcclxuICAgIH07XHJcbiAgICA7XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0RGVmYXVsdEFuaW1TdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4geyBsYXN0TnVtQ2hhbmdlczogMCwgdXNlQW5pbU92ZXJyaWRlczogdHJ1ZSB9O1xyXG4gICAgfTtcclxuICAgIDtcclxuICAgIEZvcm1WaWV3LnByb3RvdHlwZS50cnlIb3N0SWZOZWVkID0gZnVuY3Rpb24gKGFjLCByZW1vdGVJZCkge1xyXG4gICAgICAgIHZhciBsYXN0ID0gbGFzdFRyeUhvc3RbcmVtb3RlSWRdO1xyXG4gICAgICAgIGlmICghbGFzdCB8fCBEYXRlLm5vdygpIC0gbGFzdCA+PSAxMDAwKSB7XHJcbiAgICAgICAgICAgIGxhc3RUcnlIb3N0W3JlbW90ZUlkXSA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgIGlmIChnZXRNb3ZlbWVudChhYykud29ybGRPckNlbGwgPT09XHJcbiAgICAgICAgICAgICAgICBnZXRNb3ZlbWVudChHYW1lLmdldFBsYXllcigpKS53b3JsZE9yQ2VsbCkge1xyXG4gICAgICAgICAgICAgICAgdHJ5SG9zdChyZW1vdGVJZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG4gICAgO1xyXG4gICAgRm9ybVZpZXcucHJvdG90eXBlLmdldExvY2FsUmVmcklkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlZnJJZDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5wcm90b3R5cGUuZ2V0UmVtb3RlUmVmcklkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlbW90ZVJlZnJJZDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlldy5pc0Rpc3BsYXlpbmdOaWNrbmFtZXMgPSB0cnVlO1xyXG4gICAgcmV0dXJuIEZvcm1WaWV3O1xyXG59KCkpO1xyXG5leHBvcnQgeyBGb3JtVmlldyB9O1xyXG4iLCJpbXBvcnQgeyBGb3JtVmlldyB9IGZyb20gXCIuL2Zvcm1WaWV3XCI7XHJcbmltcG9ydCB7IFNwQXBpSW50ZXJhY3RvciB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zcEFwaUludGVyYWN0b3JcIjtcclxuaW1wb3J0IHsgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL3NlcnZpY2VzL2dhbWVtb2RlVXBkYXRlU2VydmljZVwiO1xyXG52YXIgRm9ybVZpZXdBcnJheSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIEZvcm1WaWV3QXJyYXkoKSB7XHJcbiAgICAgICAgdGhpcy5mb3JtVmlld3MgPSBuZXcgQXJyYXkoKTtcclxuICAgIH1cclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLnVwZGF0ZUZvcm0gPSBmdW5jdGlvbiAoZm9ybSwgaSkge1xyXG4gICAgICAgIHZhciB2aWV3ID0gdGhpcy5mb3JtVmlld3NbaV07XHJcbiAgICAgICAgaWYgKCF2aWV3KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybVZpZXdzW2ldID0gbmV3IEZvcm1WaWV3KGZvcm0ucmVmcklkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHZpZXcudXBkYXRlKGZvcm0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5kZXN0cm95Rm9ybSA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgdmFyIGZvcm1WaWV3ID0gdGhpcy5mb3JtVmlld3NbaV07XHJcbiAgICAgICAgaWYgKGZvcm1WaWV3ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3JtVmlldy5kZXN0cm95KCk7XHJcbiAgICAgICAgdGhpcy5mb3JtVmlld3NbaV0gPSB1bmRlZmluZWQ7XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24gKG5ld1NpemUpIHtcclxuICAgICAgICBpZiAodGhpcy5mb3JtVmlld3MubGVuZ3RoID4gbmV3U2l6ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1WaWV3cy5zbGljZShuZXdTaXplKS5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ICYmIHYuZGVzdHJveSgpOyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5mb3JtVmlld3MubGVuZ3RoID0gbmV3U2l6ZTtcclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS51cGRhdGVBbGwgPSBmdW5jdGlvbiAobW9kZWwsIHNob3dNZSwgaXNDbG9uZVZpZXcpIHtcclxuICAgICAgICB2YXIgZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlID0gU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpLmxvb2t1cExpc3RlbmVyKEdhbWVtb2RlVXBkYXRlU2VydmljZSk7XHJcbiAgICAgICAgZ2FtZW1vZGVVcGRhdGVTZXJ2aWNlLnNldEZvcm1WaWV3QXJyYXkodGhpcyk7XHJcbiAgICAgICAgdmFyIGZvcm1zID0gbW9kZWwuZm9ybXM7XHJcbiAgICAgICAgdmFyIG4gPSBmb3Jtcy5sZW5ndGg7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGZvcm0gPSBmb3Jtc1tpXTtcclxuICAgICAgICAgICAgaWYgKCFmb3JtIHx8IChtb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID09PSBpICYmICFzaG93TWUpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3lGb3JtKGkpO1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHJlYWxQb3MgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHZhciBvZmZzZXQgPSBtb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4ID09PSBpIHx8IGlzQ2xvbmVWaWV3O1xyXG4gICAgICAgICAgICBpZiAob2Zmc2V0ICYmIGZvcm0ubW92ZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIHJlYWxQb3MgPSBmb3JtLm1vdmVtZW50LnBvcztcclxuICAgICAgICAgICAgICAgIGZvcm0ubW92ZW1lbnQucG9zID0gW1xyXG4gICAgICAgICAgICAgICAgICAgIHJlYWxQb3NbMF0gKyAxMjgsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVhbFBvc1sxXSArIDEyOCxcclxuICAgICAgICAgICAgICAgICAgICByZWFsUG9zWzJdLFxyXG4gICAgICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaXNDbG9uZVZpZXcpIHtcclxuICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgdXNpbmcgdGhlIHNhbWUgcmVmciBieSBub3JtYWwgYW5kIGNsb25lIHZpZXdzXHJcbiAgICAgICAgICAgICAgICBpZiAoIWZvcm0ucmVmcklkIHx8IGZvcm0ucmVmcklkID49IDB4ZmYwMDAwMDApIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYmFja3VwID0gZm9ybS5pc0hvc3RlZEJ5T3RoZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9ybS5pc0hvc3RlZEJ5T3RoZXIgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IEV4cGxhaW4gd2h5IGRvIG5vdCBHYW1lbW9kZUFwaVN1cHBvcnQuc2V0SShpKTsgaGVyZVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRm9ybShmb3JtLCBpKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3JtLmlzSG9zdGVkQnlPdGhlciA9IGJhY2t1cDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGdhbWVtb2RlVXBkYXRlU2VydmljZS5zZXRJKGkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVGb3JtKGZvcm0sIGkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChvZmZzZXQgJiYgZm9ybS5tb3ZlbWVudCAmJiByZWFsUG9zKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtLm1vdmVtZW50LnBvcyA9IHJlYWxQb3M7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUuc3luY0Zvcm1WaWV3ID0gZnVuY3Rpb24gKG1vZGVsLCBzaG93TWUpIHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZGVsLmZvcm1zLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGlmICghbW9kZWwuZm9ybXNbaV0gfHwgKG1vZGVsLnBsYXllckNoYXJhY3RlckZvcm1JZHggPT09IGkgJiYgIXNob3dNZSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveUZvcm0oaSk7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5nZXRSZW1vdGVSZWZySWQgPSBmdW5jdGlvbiAoY2xpZW50c2lkZVJlZnJJZCkge1xyXG4gICAgICAgIGlmIChjbGllbnRzaWRlUmVmcklkIDwgMHhmZjAwMDAwMClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBmdW5jdGlvbiBpcyBvbmx5IGZvciAweGZmIGZvcm1zXCIpO1xyXG4gICAgICAgIHZhciBmb3JtVmlldyA9IHRoaXMuZm9ybVZpZXdzLmZpbmQoZnVuY3Rpb24gKGZvcm1WaWV3KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmb3JtVmlldyAmJiBmb3JtVmlldy5nZXRMb2NhbFJlZnJJZCgpID09PSBjbGllbnRzaWRlUmVmcklkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBmb3JtVmlldyA/IGZvcm1WaWV3LmdldFJlbW90ZVJlZnJJZCgpIDogMDtcclxuICAgIH07XHJcbiAgICBGb3JtVmlld0FycmF5LnByb3RvdHlwZS5nZXRMb2NhbFJlZnJJZCA9IGZ1bmN0aW9uIChyZW1vdGVSZWZySWQpIHtcclxuICAgICAgICBpZiAocmVtb3RlUmVmcklkIDwgMHhmZjAwMDAwMClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBmdW5jdGlvbiBpcyBvbmx5IGZvciAweGZmIGZvcm1zXCIpO1xyXG4gICAgICAgIHZhciBmb3JtVmlldyA9IHRoaXMuZm9ybVZpZXdzLmZpbmQoZnVuY3Rpb24gKGZvcm1WaWV3KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmb3JtVmlldyAmJiBmb3JtVmlldy5nZXRSZW1vdGVSZWZySWQoKSA9PT0gcmVtb3RlUmVmcklkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBmb3JtVmlldyA/IGZvcm1WaWV3LmdldExvY2FsUmVmcklkKCkgOiAwO1xyXG4gICAgfTtcclxuICAgIEZvcm1WaWV3QXJyYXkucHJvdG90eXBlLmdldE50aEZvcm1WaWV3ID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5mb3JtVmlld3NbaV07XHJcbiAgICB9O1xyXG4gICAgRm9ybVZpZXdBcnJheS5wcm90b3R5cGUuZ2V0Rm9ybVZpZXdzQXJyYXlMZW5ndGggPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybVZpZXdzLmxlbmd0aDtcclxuICAgIH07XHJcbiAgICByZXR1cm4gRm9ybVZpZXdBcnJheTtcclxufSgpKTtcclxuZXhwb3J0IHsgRm9ybVZpZXdBcnJheSB9O1xyXG4iLCJpbXBvcnQgeyBzdG9yYWdlIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbnN0b3JhZ2VbXCJob3N0QXR0ZW1wdHNcIl0gPSBbXTtcclxuZXhwb3J0IHZhciB0cnlIb3N0ID0gZnVuY3Rpb24gKHRhcmdldFJlbW90ZUlkKSB7XHJcbiAgICBzdG9yYWdlW1wiaG9zdEF0dGVtcHRzXCJdLnB1c2godGFyZ2V0UmVtb3RlSWQpO1xyXG59O1xyXG5leHBvcnQgdmFyIG5leHRIb3N0QXR0ZW1wdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBhcnIgPSBzdG9yYWdlW1wiaG9zdEF0dGVtcHRzXCJdO1xyXG4gICAgaWYgKGFyci5sZW5ndGggPT09IDApIHtcclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFyci5zaGlmdCgpO1xyXG59O1xyXG5leHBvcnQgdmFyIGxhc3RUcnlIb3N0ID0ge307XHJcbiIsImltcG9ydCB7IE9iamVjdFJlZmVyZW5jZSwgR2FtZSwgVGV4dHVyZVNldCwgTmV0SW1tZXJzZSB9IGZyb20gXCJza3lyaW1QbGF0Zm9ybVwiO1xyXG5pbXBvcnQgeyBhcHBseUludmVudG9yeSB9IGZyb20gXCIuLi9zeW5jL2ludmVudG9yeVwiO1xyXG5pbXBvcnQgeyBsb2dFcnJvciwgbG9nVHJhY2UgfSBmcm9tIFwiLi4vbG9nZ2luZ1wiO1xyXG4vLyBGb3IgMHhmZjAwMDAwMCsgdXNlZCBmcm9tIEZvcm1WaWV3XHJcbi8vIEZvciBvYmplY3RzIGZyb20gbWFzdGVyIGZpbGVzIHVzZWQgZGlyZWN0bHkgZnJvbSByZW1vdGVTZXJ2ZXIudHNcclxudmFyIE1vZGVsQXBwbHlVdGlscyA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIE1vZGVsQXBwbHlVdGlscygpIHtcclxuICAgIH1cclxuICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSW52ZW50b3J5ID0gZnVuY3Rpb24gKHJlZnIsIGludmVudG9yeSkge1xyXG4gICAgICAgIGFwcGx5SW52ZW50b3J5KHJlZnIsIGludmVudG9yeSwgZmFsc2UsIHRydWUpO1xyXG4gICAgfTtcclxuICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNPcGVuID0gZnVuY3Rpb24gKHJlZnIsIGlzT3Blbikge1xyXG4gICAgICAgIHZhciBfYTtcclxuICAgICAgICByZWZyLnNldE9wZW4oaXNPcGVuKTtcclxuICAgICAgICAvLyBTZWUgYWxzbyBvYmplY3RSZWZlcmVuY2VFeC50c1xyXG4gICAgICAgIHZhciBjYXZlR1NlY3JldERvb3IwMSA9IDB4NmY3MDM7XHJcbiAgICAgICAgLy8gVE9ETzogYWRkIG1vcmUgYWN0aXZhdG9ycyB0byBzdXBwb3J0IG1vcmUgY2VsbHNcclxuICAgICAgICB2YXIgcGFyZW50QWN0aXZhdG9ySWQgPSAweDQ2MGNhO1xyXG4gICAgICAgIGlmICgoKF9hID0gcmVmci5nZXRCYXNlT2JqZWN0KCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5nZXRGb3JtSUQoKSkgPT09IGNhdmVHU2VjcmV0RG9vcjAxKSB7XHJcbiAgICAgICAgICAgIHZhciBvcGVuT3JPcGVuaW5nID0gWzEsIDJdLmluY2x1ZGVzKHJlZnIuZ2V0T3BlblN0YXRlKCkpO1xyXG4gICAgICAgICAgICBpZiAob3Blbk9yT3BlbmluZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpc09wZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICByZWZyLmFjdGl2YXRlKE9iamVjdFJlZmVyZW5jZS5mcm9tKEdhbWUuZ2V0Rm9ybShwYXJlbnRBY3RpdmF0b3JJZCkpLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFvcGVuT3JPcGVuaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNPcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmci5hY3RpdmF0ZShPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm0ocGFyZW50QWN0aXZhdG9ySWQpKSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNEaXNhYmxlZCA9IGZ1bmN0aW9uIChyZWZyLCBkaXNhYmxlZCkge1xyXG4gICAgICAgIHZhciB3YXNEaXNhYmxlZCA9IHJlZnIuaXNEaXNhYmxlZCgpO1xyXG4gICAgICAgIGlmICh3YXNEaXNhYmxlZCA9PSBkaXNhYmxlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChkaXNhYmxlZCkge1xyXG4gICAgICAgICAgICByZWZyLmRpc2FibGUoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmVmci5lbmFibGUodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsSXNIYXJ2ZXN0ZWQgPSBmdW5jdGlvbiAocmVmciwgaXNIYXJ2ZXN0ZWQpIHtcclxuICAgICAgICB2YXIgYmFzZSA9IHJlZnIuZ2V0QmFzZU9iamVjdCgpO1xyXG4gICAgICAgIGlmIChiYXNlKSB7XHJcbiAgICAgICAgICAgIHZhciB0ID0gYmFzZS5nZXRUeXBlKCk7XHJcbiAgICAgICAgICAgIGlmICh0ID09IDM4IC8qIEZvcm1UeXBlLlRyZWUgKi8gfHwgdCA9PSAzOSAvKiBGb3JtVHlwZS5GbG9yYSAqLykge1xyXG4gICAgICAgICAgICAgICAgdmFyIHdhc0hhcnZlc3RlZCA9IHJlZnIuaXNIYXJ2ZXN0ZWQoKTtcclxuICAgICAgICAgICAgICAgIGlmIChpc0hhcnZlc3RlZCAhPSB3YXNIYXJ2ZXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYWMgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0hhcnZlc3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDIwOyArK2kpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjID0gR2FtZS5maW5kUmFuZG9tQWN0b3IocmVmci5nZXRQb3NpdGlvblgoKSwgcmVmci5nZXRQb3NpdGlvblkoKSwgcmVmci5nZXRQb3NpdGlvblooKSwgMTAwMDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjICYmIGFjLmdldEZvcm1JRCgpICE9PSAweDE0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGFydmVzdGVkICYmIGFjICYmIGFjLmdldEZvcm1JRCgpICE9PSAweDE0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuYWN0aXZhdGUoYWMsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5zZXRIYXJ2ZXN0ZWQoaXNIYXJ2ZXN0ZWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWRfMSA9IHJlZnIuZ2V0Rm9ybUlEKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnIuZGlzYWJsZShmYWxzZSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdG9yZWRSZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgoaWRfMSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3RvcmVkUmVmcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3RvcmVkUmVmci5lbmFibGUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgd2FzSGFydmVzdGVkID0gcmVmci5pc0Rpc2FibGVkKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNIYXJ2ZXN0ZWQgIT0gd2FzSGFydmVzdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGFydmVzdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZF8yID0gcmVmci5nZXRGb3JtSUQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5kaXNhYmxlKGZhbHNlKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN0b3JlZFJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChpZF8yKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdG9yZWRSZWZyICYmICFyZXN0b3JlZFJlZnIuaXNEaXNhYmxlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdG9yZWRSZWZyLmRlbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlbGV0aW9uIHRha2VzIHRpbWUsIHNvIGluIHByYWN0aWNlIHRoaXMgd291bGQgYmUgY2FsbGVkIGEgbG90IG9mIHRpbWVzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmci5lbmFibGUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE1vZGVsQXBwbHlVdGlscy5hcHBseU1vZGVsTm9kZVRleHR1cmVTZXQgPSBmdW5jdGlvbiAocmVmciwgc2V0Tm9kZVRleHR1cmVTZXQpIHtcclxuICAgICAgICBpZiAoc2V0Tm9kZVRleHR1cmVTZXQpIHtcclxuICAgICAgICAgICAgc2V0Tm9kZVRleHR1cmVTZXQuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZpcnN0UGVyc29uID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGV4dHVyZVNldCA9IFRleHR1cmVTZXQuZnJvbShHYW1lLmdldEZvcm1FeChlbGVtZW50LnRleHR1cmVTZXRJZCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRleHR1cmVTZXQgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBOZXRJbW1lcnNlLnNldE5vZGVUZXh0dXJlU2V0KHJlZnIsIGVsZW1lbnQubm9kZU5hbWUsIHRleHR1cmVTZXQsIGZpcnN0UGVyc29uKTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dUcmFjZShcIk1vZGVsQXBwbHlVdGlsc1wiLCByZWZyLmdldEZvcm1JRCgpLnRvU3RyaW5nKDE2KSwgXCJBcHBsaWVkIHRleHR1cmUgc2V0XCIsIGVsZW1lbnQudGV4dHVyZVNldElkLnRvU3RyaW5nKDE2KSwgXCJ0b1wiLCBlbGVtZW50Lm5vZGVOYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ0Vycm9yKFwiTW9kZWxBcHBseVV0aWxzXCIsIHJlZnIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpLCBcIkZhaWxlZCB0byBhcHBseSB0ZXh0dXJlIHNldFwiLCBlbGVtZW50LnRleHR1cmVTZXRJZC50b1N0cmluZygxNiksIFwidG9cIiwgZWxlbWVudC5ub2RlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBNb2RlbEFwcGx5VXRpbHMuYXBwbHlNb2RlbE5vZGVTY2FsZSA9IGZ1bmN0aW9uIChyZWZyLCBzZXROb2RlU2NhbGUpIHtcclxuICAgICAgICBpZiAoc2V0Tm9kZVNjYWxlKSB7XHJcbiAgICAgICAgICAgIHNldE5vZGVTY2FsZS5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZmlyc3RQZXJzb24gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIE5ldEltbWVyc2Uuc2V0Tm9kZVNjYWxlKHJlZnIsIGVsZW1lbnQubm9kZU5hbWUsIGVsZW1lbnQuc2NhbGUsIGZpcnN0UGVyc29uKTtcclxuICAgICAgICAgICAgICAgIGxvZ1RyYWNlKFwiTW9kZWxBcHBseVV0aWxzXCIsIHJlZnIuZ2V0Rm9ybUlEKCkudG9TdHJpbmcoMTYpLCBcIkFwcGxpZWQgbm9kZSBzY2FsZVwiLCBlbGVtZW50LnNjYWxlLCBcInRvXCIsIGVsZW1lbnQubm9kZU5hbWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIE1vZGVsQXBwbHlVdGlscztcclxufSgpKTtcclxuZXhwb3J0IHsgTW9kZWxBcHBseVV0aWxzIH07XHJcbiIsImltcG9ydCB7IEdhbWUgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tIFwiLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeFwiO1xyXG52YXIgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIoKSB7XHJcbiAgICB9XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLnVwZGF0ZURhdGEgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIF9hO1xyXG4gICAgICAgIHZhciBwbGF5ZXIgPSBHYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIGlmICghcGxheWVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbkp1bXBTdGF0ZSA9IHBsYXllci5nZXRBbmltYXRpb25WYXJpYWJsZUJvb2woXCJiSW5KdW1wU3RhdGVcIik7XHJcbiAgICAgICAgdGhpcy53b3JsZE9yQ2VsbCA9IE9iamVjdFJlZmVyZW5jZUV4LmdldFdvcmxkT3JDZWxsKHBsYXllcik7XHJcbiAgICAgICAgdGhpcy5jcm9zc2hhaXJSZWZJZCA9ICgoX2EgPSBHYW1lLmdldEN1cnJlbnRDcm9zc2hhaXJSZWYoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmdldEZvcm1JRCgpKSB8fCAwO1xyXG4gICAgfTtcclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuaXNJbkp1bXBTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbkp1bXBTdGF0ZTtcclxuICAgIH07XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmdldFdvcmxkT3JDZWxsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndvcmxkT3JDZWxsO1xyXG4gICAgfTtcclxuICAgIFBsYXllckNoYXJhY3RlckRhdGFIb2xkZXIuZ2V0Q3Jvc3NoYWlyUmVmSWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY3Jvc3NoYWlyUmVmSWQ7XHJcbiAgICB9O1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci5pbkp1bXBTdGF0ZSA9IGZhbHNlO1xyXG4gICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci53b3JsZE9yQ2VsbCA9IDA7XHJcbiAgICBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyLmNyb3NzaGFpclJlZklkID0gMDtcclxuICAgIHJldHVybiBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyO1xyXG59KCkpO1xyXG5leHBvcnQgeyBQbGF5ZXJDaGFyYWN0ZXJEYXRhSG9sZGVyIH07XHJcbiIsImltcG9ydCB7IE9iamVjdFJlZmVyZW5jZSwgR2FtZSwgQWN0b3IgfSBmcm9tIFwic2t5cmltUGxhdGZvcm1cIjtcclxuaW1wb3J0IHsgYXBwbHlUaW50cyB9IGZyb20gXCIuLi9zeW5jL2FwcGVhcmFuY2VcIjtcclxuaW1wb3J0IHsgT2JqZWN0UmVmZXJlbmNlRXggfSBmcm9tIFwiLi4vZXh0ZW5zaW9ucy9vYmplY3RSZWZlcmVuY2VFeFwiO1xyXG52YXIgU3Bhd25Qcm9jZXNzID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gU3Bhd25Qcm9jZXNzKGFwcGVhcmFuY2UsIHBvcywgcmVmcklkLCBjYWxsYmFjaykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrO1xyXG4gICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgaWYgKCFyZWZyIHx8IHJlZnIuZ2V0Rm9ybUlEKCkgIT09IHJlZnJJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlZnIuc2V0UG9zaXRpb24uYXBwbHkocmVmciwgcG9zKS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmVuYWJsZShhcHBlYXJhbmNlLCByZWZySWQpOyB9KTtcclxuICAgIH1cclxuICAgIFNwYXduUHJvY2Vzcy5wcm90b3R5cGUuZW5hYmxlID0gZnVuY3Rpb24gKGFwcGVhcmFuY2UsIHJlZnJJZCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICBpZiAoIXJlZnIgfHwgcmVmci5nZXRGb3JtSUQoKSAhPT0gcmVmcklkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICBpZiAoYWMgJiYgYXBwZWFyYW5jZSkge1xyXG4gICAgICAgICAgICBhcHBseVRpbnRzKGFjLCBhcHBlYXJhbmNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVmci5lbmFibGUoZmFsc2UpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMucmVzdXJyZWN0KHJlZnJJZCk7IH0pO1xyXG4gICAgfTtcclxuICAgIFNwYXduUHJvY2Vzcy5wcm90b3R5cGUucmVzdXJyZWN0ID0gZnVuY3Rpb24gKHJlZnJJZCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHJlZnIgPSBPYmplY3RSZWZlcmVuY2UuZnJvbShHYW1lLmdldEZvcm1FeChyZWZySWQpKTtcclxuICAgICAgICBpZiAoIXJlZnIgfHwgcmVmci5nZXRGb3JtSUQoKSAhPT0gcmVmcklkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGFjID0gQWN0b3IuZnJvbShyZWZyKTtcclxuICAgICAgICBpZiAoYWMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFjLnJlc3VycmVjdCgpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIE9iamVjdFJlZmVyZW5jZUV4LmRlYWxXaXRoUmVmKHJlZnIsIHJlZnIuZ2V0QmFzZU9iamVjdCgpKTtcclxuICAgICAgICByZXR1cm4gcmVmci5zZXRNb3Rpb25UeXBlKDQgLyogTW90aW9uVHlwZS5LZXlmcmFtZWQgKi8sIHRydWUpLnRoZW4odGhpcy5jYWxsYmFjayk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFNwYXduUHJvY2VzcztcclxufSgpKTtcclxuZXhwb3J0IHsgU3Bhd25Qcm9jZXNzIH07XHJcbiIsInZhciBfX2V4dGVuZHMgPSAodGhpcyAmJiB0aGlzLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBleHRlbmRTdGF0aWNzID0gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBleHRlbmRTdGF0aWNzID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8XHJcbiAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIHApKSBkW3BdID0gYltwXTsgfTtcclxuICAgICAgICByZXR1cm4gZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGIgIT09IFwiZnVuY3Rpb25cIiAmJiBiICE9PSBudWxsKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2xhc3MgZXh0ZW5kcyB2YWx1ZSBcIiArIFN0cmluZyhiKSArIFwiIGlzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIG51bGxcIik7XHJcbiAgICAgICAgZXh0ZW5kU3RhdGljcyhkLCBiKTtcclxuICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cclxuICAgICAgICBkLnByb3RvdHlwZSA9IGIgPT09IG51bGwgPyBPYmplY3QuY3JlYXRlKGIpIDogKF9fLnByb3RvdHlwZSA9IGIucHJvdG90eXBlLCBuZXcgX18oKSk7XHJcbiAgICB9O1xyXG59KSgpO1xyXG5pbXBvcnQgeyBGb3JtVmlld0FycmF5IH0gZnJvbSAnLi9mb3JtVmlld0FycmF5JztcclxuaW1wb3J0IHsgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlciB9IGZyb20gJy4vcGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlcic7XHJcbmltcG9ydCB7IENsaWVudExpc3RlbmVyIH0gZnJvbSAnLi4vc2VydmljZXMvc2VydmljZXMvY2xpZW50TGlzdGVuZXInO1xyXG5pbXBvcnQgeyBsb2dUcmFjZSB9IGZyb20gXCIuLi9sb2dnaW5nXCI7XHJcbmltcG9ydCB7IFNpbmdsZVBsYXllclNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvc2VydmljZXMvc2luZ2xlUGxheWVyU2VydmljZVwiO1xyXG5pbXBvcnQgeyBSZW1vdGVTZXJ2ZXIgfSBmcm9tIFwiLi4vc2VydmljZXMvc2VydmljZXMvcmVtb3RlU2VydmVyXCI7XHJcbnZhciBXb3JsZFZpZXcgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7XHJcbiAgICBfX2V4dGVuZHMoV29ybGRWaWV3LCBfc3VwZXIpO1xyXG4gICAgZnVuY3Rpb24gV29ybGRWaWV3KHNwLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpcztcclxuICAgICAgICBfdGhpcy5zcCA9IHNwO1xyXG4gICAgICAgIF90aGlzLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xyXG4gICAgICAgIGNvbnRyb2xsZXIub24oXCJ1cGRhdGVcIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gX3RoaXMub25VcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgY29udHJvbGxlci5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLm9uY2VVcGRhdGUoKTsgfSk7XHJcbiAgICAgICAgX3RoaXMuc3RhdGUgPSBfdGhpcy5tYWtlRW1wdHlTdGF0ZSgpO1xyXG4gICAgICAgIHZhciBvbGRWaWV3ID0gX3RoaXMuc3Auc3RvcmFnZVtcInZpZXdcIl07XHJcbiAgICAgICAgLy8gY2FuJ3QgdXNlIGluc3RhbmNlb2YgaGVyZSBiZWNhdXNlIGVhY2ggaG90IHJlbG9hZCBjcmVhdGVzIGEgbmV3IGNsYXNzXHJcbiAgICAgICAgX3RoaXMub2xkVmlldyA9IHR5cGVvZiBvbGRWaWV3ID09PSBcIm9iamVjdFwiID8gb2xkVmlldyA6IHVuZGVmaW5lZDtcclxuICAgICAgICBfdGhpcy5zcC5zdG9yYWdlW1widmlld1wiXSA9IF90aGlzO1xyXG4gICAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH1cclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUuZ2V0UmVtb3RlUmVmcklkID0gZnVuY3Rpb24gKGNsaWVudHNpZGVSZWZySWQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5mb3JtVmlld3MuZ2V0UmVtb3RlUmVmcklkKGNsaWVudHNpZGVSZWZySWQpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUuZ2V0TG9jYWxSZWZySWQgPSBmdW5jdGlvbiAocmVtb3RlUmVmcklkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZm9ybVZpZXdzLmdldExvY2FsUmVmcklkKHJlbW90ZVJlZnJJZCk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5zeW5jRm9ybUFycmF5ID0gZnVuY3Rpb24gKG1vZGVsKSB7XHJcbiAgICAgICAgdmFyIHNldHRpbmdzID0gdGhpcy5zcC5zZXR0aW5ncztcclxuICAgICAgICB2YXIgc2hvd01lID0gc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2hvdy1tZSddO1xyXG4gICAgICAgIHRoaXMuc3RhdGUuZm9ybVZpZXdzLnN5bmNGb3JtVmlldyhtb2RlbCwgISFzaG93TWUpO1xyXG4gICAgfTtcclxuICAgIFdvcmxkVmlldy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnN0YXRlLmZvcm1WaWV3cy5yZXNpemUoMCk7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5jbG9uZUZvcm1WaWV3cy5yZXNpemUoMCk7IC8vIFJlY2Vucmx5IGFkZGVkLCBub3QgdGVzdGVkIGlmIGl0J3MgbmVlZGVkXHJcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMubWFrZUVtcHR5U3RhdGUoKTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLmdldEZvcm1WaWV3cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5mb3JtVmlld3M7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB0aGlzLnJlc2V0QWxsRm9ybVZpZXdzSWZQbGF5ZXJDaGFuZ2VkV29ybGQoKTtcclxuICAgICAgICB2YXIgc2luZ2xlUGxheWVyU2VydmljZSA9IHRoaXMuY29udHJvbGxlci5sb29rdXBMaXN0ZW5lcihTaW5nbGVQbGF5ZXJTZXJ2aWNlKTtcclxuICAgICAgICBpZiAoIXNpbmdsZVBsYXllclNlcnZpY2UuaXNTaW5nbGVQbGF5ZXIpIHtcclxuICAgICAgICAgICAgdmFyIG1vZGVsU291cmNlID0gdGhpcy5jb250cm9sbGVyLmxvb2t1cExpc3RlbmVyKFJlbW90ZVNlcnZlcik7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlV29ybGQobW9kZWxTb3VyY2UuZ2V0V29ybGRNb2RlbCgpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5vbmNlVXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm9sZFZpZXcpIHtcclxuICAgICAgICAgICAgdGhpcy5vbGRWaWV3LmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5vbGRWaWV3ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUHJldmlvdXMgVmlldyBkZXN0cm95ZWQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy53YWl0R2FtZVRpbWVBbmRBbGxvd0Zvcm1WaWV3VXBkYXRlKDEuMCk7XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5yZXNldEFsbEZvcm1WaWV3c0lmUGxheWVyQ2hhbmdlZFdvcmxkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuc3RhdGU7XHJcbiAgICAgICAgdmFyIHBjID0gdGhpcy5zcC5HYW1lLmdldFBsYXllcigpO1xyXG4gICAgICAgIHZhciBwY1dvcmxkT3JDZWxsID0gKHBjLmdldFdvcmxkU3BhY2UoKSB8fCBwYy5nZXRQYXJlbnRDZWxsKCkpLmdldEZvcm1JRCgpO1xyXG4gICAgICAgIGlmIChzdGF0ZS5wY1dvcmxkT3JDZWxsICE9PSBwY1dvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChzdGF0ZS5wY1dvcmxkT3JDZWxsKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dUcmFjZSh0aGlzLCAnUmVzZXQgYWxsIGZvcm0gdmlld3MnKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmZvcm1WaWV3cy5yZXNpemUoMCk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5jbG9uZUZvcm1WaWV3cy5yZXNpemUoMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3RhdGUucGNXb3JsZE9yQ2VsbCA9IHBjV29ybGRPckNlbGw7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8vIFdvcmsgYXJvdW5kIHNob3dSYWNlTWVudSBpc3N1ZVxyXG4gICAgLy8gRGVmYXVsdCBub3JkIGluIFJhY2UgTWVudSB3aWxsIGhhdmUgdmVyeSB1Z2x5IGZhY2VcclxuICAgIC8vIElmIG90aGVyIHBsYXllcnMgYXJlIHNwYXduaW5nIHdoZW4gd2Ugc2hvdyB0aGlzIG1lbnVcclxuICAgIC8vIFRPRE86IHNlcGFyYXRlIGxpc3RlbmVyXHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLndhaXRHYW1lVGltZUFuZEFsbG93Rm9ybVZpZXdVcGRhdGUgPSBmdW5jdGlvbiAoc2Vjb25kcykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgLy8gV2FpdCAxcyBnYW1lIHRpbWUgKHRpbWUgc3BlbnQgaW4gUmFjZSBNZW51IGlzbid0IGNvdW50ZWQpXHJcbiAgICAgICAgdGhpcy5zcC5VdGlsaXR5LndhaXQoc2Vjb25kcykudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnN0YXRlLmFsbG93VXBkYXRlID0gdHJ1ZTtcclxuICAgICAgICAgICAgbG9nVHJhY2UoX3RoaXMsICdVcGRhdGUgaXMgbm93IGFsbG93ZWQnKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLnNldEZvcm1WaWV3VXBkYXRlQWxsb3dlZCA9IGZ1bmN0aW9uIChhbGxvd2VkKSB7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5hbGxvd1VwZGF0ZSA9IGFsbG93ZWQ7XHJcbiAgICAgICAgbG9nVHJhY2UodGhpcywgJ1VwZGF0ZSBpcyBub3cnLCBhbGxvd2VkID8gJ2FsbG93ZWQnIDogJ2Rpc2FsbG93ZWQnKTtcclxuICAgIH07XHJcbiAgICBXb3JsZFZpZXcucHJvdG90eXBlLnVwZGF0ZVdvcmxkID0gZnVuY3Rpb24gKG1vZGVsKSB7XHJcbiAgICAgICAgdmFyIHNldHRpbmdzID0gdGhpcy5zcC5zZXR0aW5ncztcclxuICAgICAgICB2YXIgc3RhdGUgPSB0aGlzLnN0YXRlO1xyXG4gICAgICAgIGlmICghc3RhdGUuYWxsb3dVcGRhdGUpIHtcclxuICAgICAgICAgICAgbW9kZWwgPSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtczogW10sXHJcbiAgICAgICAgICAgICAgICBwbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4OiBtb2RlbC5wbGF5ZXJDaGFyYWN0ZXJGb3JtSWR4LFxyXG4gICAgICAgICAgICAgICAgcGxheWVyQ2hhcmFjdGVyUmVmcklkOiBtb2RlbC5wbGF5ZXJDaGFyYWN0ZXJSZWZySWRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNraXBVcGRhdGVzID0gc2V0dGluZ3NbJ3NreW1wNS1jbGllbnQnXVsnc2tpcFVwZGF0ZXMnXTtcclxuICAgICAgICAvLyBza2lwIDUwJSBvZiB1cGRhdGVzIGlmIHNwZWNpZmllZCBpbiB0aGUgc2V0dGluZ3NcclxuICAgICAgICBzdGF0ZS5jb3VudGVyID0gIXN0YXRlLmNvdW50ZXI7XHJcbiAgICAgICAgaWYgKHN0YXRlLmNvdW50ZXIgJiYgc2tpcFVwZGF0ZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzdGF0ZS5mb3JtVmlld3MucmVzaXplKG1vZGVsLmZvcm1zLmxlbmd0aCk7XHJcbiAgICAgICAgdmFyIHNob3dNZSA9IHNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3Nob3ctbWUnXTtcclxuICAgICAgICB2YXIgc2hvd0Nsb25lcyA9IHNldHRpbmdzWydza3ltcDUtY2xpZW50J11bJ3Nob3ctY2xvbmVzJ107XHJcbiAgICAgICAgUGxheWVyQ2hhcmFjdGVyRGF0YUhvbGRlci51cGRhdGVEYXRhKCk7XHJcbiAgICAgICAgc3RhdGUuZm9ybVZpZXdzLnVwZGF0ZUFsbChtb2RlbCwgISFzaG93TWUsIGZhbHNlKTtcclxuICAgICAgICBpZiAoc2hvd0Nsb25lcykge1xyXG4gICAgICAgICAgICBzdGF0ZS5jbG9uZUZvcm1WaWV3cy51cGRhdGVBbGwobW9kZWwsIGZhbHNlLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmNsb25lRm9ybVZpZXdzLnJlc2l6ZSgwKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgV29ybGRWaWV3LnByb3RvdHlwZS5tYWtlRW1wdHlTdGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBmb3JtVmlld3M6IG5ldyBGb3JtVmlld0FycmF5KCksXHJcbiAgICAgICAgICAgIGNsb25lRm9ybVZpZXdzOiBuZXcgRm9ybVZpZXdBcnJheSgpLFxyXG4gICAgICAgICAgICBhbGxvd1VwZGF0ZTogZmFsc2UsXHJcbiAgICAgICAgICAgIHBjV29ybGRPckNlbGw6IDAsXHJcbiAgICAgICAgICAgIGNvdW50ZXI6IGZhbHNlLFxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFdvcmxkVmlldztcclxufShDbGllbnRMaXN0ZW5lcikpO1xyXG5leHBvcnQgeyBXb3JsZFZpZXcgfTtcclxuIiwiaW1wb3J0IHsgR2FtZSwgT2JqZWN0UmVmZXJlbmNlLCBzdG9yYWdlIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IFNwQXBpSW50ZXJhY3RvciB9IGZyb20gJy4uL3NlcnZpY2VzL3NwQXBpSW50ZXJhY3Rvcic7XHJcbmltcG9ydCB7IFJlbW90ZVNlcnZlciB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zZXJ2aWNlcy9yZW1vdGVTZXJ2ZXJcIjtcclxuZXhwb3J0IHZhciBnZXRWaWV3RnJvbVN0b3JhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgcmVzID0gc3RvcmFnZVtcInZpZXdcIl07XHJcbiAgICAvLyBjYW4ndCB1c2UgaW5zdGFuY2VvZiBoZXJlIGJlY2F1c2UgZWFjaCBob3QgcmVsb2FkIGNyZWF0ZXMgYSBuZXcgY2xhc3NcclxuICAgIGlmICh0eXBlb2YgcmVzID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbn07XHJcbmV4cG9ydCB2YXIgbG9jYWxJZFRvUmVtb3RlSWQgPSBmdW5jdGlvbiAobG9jYWxGb3JtSWQsIG5ld0Nhc3QpIHtcclxuICAgIGlmIChuZXdDYXN0ID09PSB2b2lkIDApIHsgbmV3Q2FzdCA9IGZhbHNlOyB9XHJcbiAgICBpZiAobmV3Q2FzdCAmJiBsb2NhbEZvcm1JZCA9PSAweDE0KSB7XHJcbiAgICAgICAgcmV0dXJuIFNwQXBpSW50ZXJhY3Rvci5nZXRDb250cm9sbGVySW5zdGFuY2UoKS5sb29rdXBMaXN0ZW5lcihSZW1vdGVTZXJ2ZXIpLmdldE15UmVtb3RlUmVmcklkKCk7XHJcbiAgICB9XHJcbiAgICBpZiAobG9jYWxGb3JtSWQgPj0gMHhmZjAwMDAwMCkge1xyXG4gICAgICAgIHZhciB2aWV3ID0gZ2V0Vmlld0Zyb21TdG9yYWdlKCk7XHJcbiAgICAgICAgaWYgKCF2aWV3KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsb2NhbEZvcm1JZCA9IHZpZXcuZ2V0UmVtb3RlUmVmcklkKGxvY2FsRm9ybUlkKTtcclxuICAgICAgICBpZiAoIWxvY2FsRm9ybUlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBzZXJ2ZXJzaWRlIGlkcyBhcmUgNjRiaXRcclxuICAgICAgICBpZiAobG9jYWxGb3JtSWQgPj0gMHgxMDAwMDAwMDApIHtcclxuICAgICAgICAgICAgbG9jYWxGb3JtSWQgLT0gMHgxMDAwMDAwMDA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGxvY2FsRm9ybUlkO1xyXG59O1xyXG5leHBvcnQgdmFyIHJlbW90ZUlkVG9Mb2NhbElkID0gZnVuY3Rpb24gKHJlbW90ZUZvcm1JZCkge1xyXG4gICAgaWYgKHJlbW90ZUZvcm1JZCA+PSAweGZmMDAwMDAwKSB7XHJcbiAgICAgICAgdmFyIHZpZXcgPSBnZXRWaWV3RnJvbVN0b3JhZ2UoKTtcclxuICAgICAgICBpZiAoIXZpZXcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlbW90ZUZvcm1JZCA9IHZpZXcuZ2V0TG9jYWxSZWZySWQocmVtb3RlRm9ybUlkKTtcclxuICAgICAgICBpZiAoIXJlbW90ZUZvcm1JZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVtb3RlRm9ybUlkO1xyXG59O1xyXG5leHBvcnQgdmFyIGdldE9iamVjdFJlZmVyZW5jZSA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICB2YXIgdmlldyA9IGdldFZpZXdGcm9tU3RvcmFnZSgpO1xyXG4gICAgaWYgKHZpZXcpIHtcclxuICAgICAgICB2YXIgZm9ybVZpZXcgPSB2aWV3LmdldEZvcm1WaWV3cygpLmdldE50aEZvcm1WaWV3KGkpO1xyXG4gICAgICAgIGlmIChmb3JtVmlldykge1xyXG4gICAgICAgICAgICB2YXIgcmVmcklkID0gZm9ybVZpZXcuZ2V0TG9jYWxSZWZySWQoKTtcclxuICAgICAgICAgICAgaWYgKHJlZnJJZCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHZhciByZWZyID0gT2JqZWN0UmVmZXJlbmNlLmZyb20oR2FtZS5nZXRGb3JtRXgocmVmcklkKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmciAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWZyO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn07XHJcbiIsIm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShcImNyeXB0b1wiKTsiLCJtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoXCJmc1wiKTsiLCJtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoXCJpbnNwZWN0b3JcIik7IiwibW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKFwibm9kZTpjcnlwdG9cIik7IiwibW9kdWxlLmV4cG9ydHMgPSBza3lyaW1QbGF0Zm9ybTsiLCJpbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJy4vaW5kZXguanMnXG5cbmV4cG9ydCB7IEV2ZW50RW1pdHRlciB9XG5leHBvcnQgZGVmYXVsdCBFdmVudEVtaXR0ZXJcbiIsIi8vIFRoZSBtb2R1bGUgY2FjaGVcbnZhciBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18gPSB7fTtcblxuLy8gVGhlIHJlcXVpcmUgZnVuY3Rpb25cbmZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHtcblx0Ly8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlXG5cdHZhciBjYWNoZWRNb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdO1xuXHRpZiAoY2FjaGVkTW9kdWxlICE9PSB1bmRlZmluZWQpIHtcblx0XHRyZXR1cm4gY2FjaGVkTW9kdWxlLmV4cG9ydHM7XG5cdH1cblx0Ly8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSlcblx0dmFyIG1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF0gPSB7XG5cdFx0Ly8gbm8gbW9kdWxlLmlkIG5lZWRlZFxuXHRcdC8vIG5vIG1vZHVsZS5sb2FkZWQgbmVlZGVkXG5cdFx0ZXhwb3J0czoge31cblx0fTtcblxuXHQvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb25cblx0X193ZWJwYWNrX21vZHVsZXNfX1ttb2R1bGVJZF0obW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7XG5cblx0Ly8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGVcblx0cmV0dXJuIG1vZHVsZS5leHBvcnRzO1xufVxuXG4iLCIvLyBnZXREZWZhdWx0RXhwb3J0IGZ1bmN0aW9uIGZvciBjb21wYXRpYmlsaXR5IHdpdGggbm9uLWhhcm1vbnkgbW9kdWxlc1xuX193ZWJwYWNrX3JlcXVpcmVfXy5uID0gKG1vZHVsZSkgPT4ge1xuXHR2YXIgZ2V0dGVyID0gbW9kdWxlICYmIG1vZHVsZS5fX2VzTW9kdWxlID9cblx0XHQoKSA9PiAobW9kdWxlWydkZWZhdWx0J10pIDpcblx0XHQoKSA9PiAobW9kdWxlKTtcblx0X193ZWJwYWNrX3JlcXVpcmVfXy5kKGdldHRlciwgeyBhOiBnZXR0ZXIgfSk7XG5cdHJldHVybiBnZXR0ZXI7XG59OyIsIi8vIGRlZmluZSBnZXR0ZXIgZnVuY3Rpb25zIGZvciBoYXJtb255IGV4cG9ydHNcbl9fd2VicGFja19yZXF1aXJlX18uZCA9IChleHBvcnRzLCBkZWZpbml0aW9uKSA9PiB7XG5cdGZvcih2YXIga2V5IGluIGRlZmluaXRpb24pIHtcblx0XHRpZihfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZGVmaW5pdGlvbiwga2V5KSAmJiAhX193ZWJwYWNrX3JlcXVpcmVfXy5vKGV4cG9ydHMsIGtleSkpIHtcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBkZWZpbml0aW9uW2tleV0gfSk7XG5cdFx0fVxuXHR9XG59OyIsIl9fd2VicGFja19yZXF1aXJlX18ubyA9IChvYmosIHByb3ApID0+IChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKSkiLCIvLyBkZWZpbmUgX19lc01vZHVsZSBvbiBleHBvcnRzXG5fX3dlYnBhY2tfcmVxdWlyZV9fLnIgPSAoZXhwb3J0cykgPT4ge1xuXHRpZih0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wudG9TdHJpbmdUYWcpIHtcblx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAnTW9kdWxlJyB9KTtcblx0fVxuXHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pO1xufTsiLCJpbXBvcnQgeyBHYW1lLCBVdGlsaXR5LCBvbmNlIH0gZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IFNreW1wQ2xpZW50IH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc2t5bXBDbGllbnRcIjtcclxuaW1wb3J0ICogYXMgc3AgZnJvbSBcInNreXJpbVBsYXRmb3JtXCI7XHJcbmltcG9ydCB7IEJsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3NlcnZpY2VzL2Jsb2NrUGFweXJ1c0V2ZW50c1NlcnZpY2UnO1xyXG5pbXBvcnQgeyBFbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zZXJ2aWNlcy9lbmZvcmNlTGltaXRhdGlvbnNTZXJ2aWNlJztcclxuaW1wb3J0IHsgTG9hZEdhbWVTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zZXJ2aWNlcy9sb2FkR2FtZVNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTZW5kSW5wdXRzU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2VydmljZXMvc2VuZElucHV0c1NlcnZpY2UnO1xyXG5pbXBvcnQgeyBTaW5nbGVQbGF5ZXJTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zaW5nbGVQbGF5ZXJTZXJ2aWNlJztcclxuaW1wb3J0IHsgU3BBcGlJbnRlcmFjdG9yIH0gZnJvbSAnLi9zZXJ2aWNlcy9zcEFwaUludGVyYWN0b3InO1xyXG5pbXBvcnQgeyBUaW1lU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3RpbWVTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFNwVmVyc2lvbkNoZWNrU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3NwVmVyc2lvbkNoZWNrU2VydmljZVwiO1xyXG5pbXBvcnQgeyBDb25zb2xlQ29tbWFuZHNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvY29uc29sZUNvbW1hbmRzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBMYXN0SW52U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2xhc3RJbnZTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEFjdGl2YXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvYWN0aXZhdGlvblNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQ3JhZnRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvY3JhZnRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IERyb3BJdGVtU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Ryb3BJdGVtU2VydmljZVwiO1xyXG5pbXBvcnQgeyBIaXRTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvaGl0U2VydmljZVwiO1xyXG5pbXBvcnQgeyBSYWdkb2xsU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3JhZ2RvbGxTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IERlYXRoU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2RlYXRoU2VydmljZVwiO1xyXG5pbXBvcnQgeyBDb250YWluZXJzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2NvbnRhaW5lcnNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IE5ldHdvcmtpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvbmV0d29ya2luZ1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgUmVtb3RlU2VydmVyIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvcmVtb3RlU2VydmVyXCI7XHJcbmltcG9ydCB7IFNwU25pcHBldFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zcFNuaXBwZXRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlEeW5hbWljUGVya3NTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVN3ZWV0Q2FudERyb3BTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlTdGF0aWNQZXJrc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldFRhZmZ5U3RhdGljUGVya3NTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IERpc2FibGVTa2lsbEFkdmFuY2VTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2VcIjtcclxuaW1wb3J0IHsgRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvZGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2Rpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5UGxheWVyQ29tYmF0U2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlQbGF5ZXJDb21iYXRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFdvcmxkQ2xlYW5lclNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy93b3JsZENsZWFuZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN3ZWV0VGFmZnlTa2lsbE1lbnVTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvc3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2VcIjtcclxuaW1wb3J0IHsgTG9hZE9yZGVyVmVyaWZpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2xvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQnJvd3NlclNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9icm93c2VyU2VydmljZVwiO1xyXG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2F1dGhTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENoYXJhY3RlclNlbGVjdFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9jaGFyYWN0ZXJTZWxlY3RTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IE5ldEluZm9TZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvbmV0SW5mb1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgQW5pbURlYnVnU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2FuaW1EZWJ1Z1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgVGltZXJzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3RpbWVyc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgUGxheWVyQm93U2hvdFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9wbGF5ZXJCb3dTaG90U2VydmljZVwiO1xyXG5pbXBvcnQgeyBHYW1lbW9kZUV2ZW50U291cmNlU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2dhbWVtb2RlRXZlbnRTb3VyY2VTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEdhbWVtb2RlVXBkYXRlU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2dhbWVtb2RlVXBkYXRlU2VydmljZVwiO1xyXG5pbXBvcnQgeyBGcm9udEhvdFJlbG9hZFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9mcm9udEhvdFJlbG9hZFNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvYmxvY2tlZEFuaW1hdGlvbnNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFZvaWNlQ2hhdFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy92b2ljZUNoYXRTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFdvcmxkVmlldyB9IGZyb20gXCIuL3ZpZXcvd29ybGRWaWV3XCI7XHJcbmltcG9ydCB7IEtleWJvYXJkRXZlbnRzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL2tleWJvYXJkRXZlbnRzU2VydmljZVwiO1xyXG5pbXBvcnQgeyBNYWdpY1N5bmNTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvbWFnaWNTeW5jU2VydmljZVwiO1xyXG5pbXBvcnQgeyBQcm9maWxpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZXMvc2VydmljZXMvcHJvZmlsaW5nU2VydmljZVwiO1xyXG5pbXBvcnQgeyBTZXR0aW5nc1NlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zZXR0aW5nc1NlcnZpY2VcIjtcclxuaW1wb3J0IHsgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlcy9zZXJ2aWNlcy9zd2VldENhbWVyYUVuZm9yY2VtZW50U2VydmljZVwiO1xyXG5pbXBvcnQgeyBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3N3ZWV0VGFmZnlOaWNrbmFtZXNTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFNlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VzL3NlcnZpY2VzL3NlcnZlckpzVmVyaWZpY2F0aW9uU2VydmljZVwiO1xyXG5vbmNlKFwidXBkYXRlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgIFV0aWxpdHkuc2V0SU5JQm9vbChcImJBbHdheXNBY3RpdmU6R2VuZXJhbFwiLCB0cnVlKTtcclxuICAgIEdhbWUuc2V0R2FtZVNldHRpbmdJbnQoXCJpRGVhdGhEcm9wV2VhcG9uQ2hhbmNlXCIsIDApO1xyXG59KTtcclxudmFyIG1haW4gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIHZhciBjb250cm9sbGVyID0gU3BBcGlJbnRlcmFjdG9yLmdldENvbnRyb2xsZXJJbnN0YW5jZSgpO1xyXG4gICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXHJcbiAgICAgICAgICAgIG5ldyBCbG9ja1BhcHlydXNFdmVudHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IExvYWRHYW1lU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTaW5nbGVQbGF5ZXJTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEVuZm9yY2VMaW1pdGF0aW9uc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU2VuZElucHV0c1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU2t5bXBDbGllbnQoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgVGltZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3BWZXJzaW9uQ2hlY2tTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IENvbnNvbGVDb21tYW5kc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgTGFzdEludlNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQWN0aXZhdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQ3JhZnRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IERyb3BJdGVtU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBIaXRTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFJhZ2RvbGxTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IERlYXRoU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBDb250YWluZXJzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBOZXR3b3JraW5nU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBSZW1vdGVTZXJ2ZXIoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3BTbmlwcGV0U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTZXR0aW5nc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRUYWZmeUR5bmFtaWNQZXJrc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRUYWZmeVN0YXRpY1BlcmtzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldFRhZmZ5U3dlZXRDYW50RHJvcFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRUYWZmeVBsYXllckNvbWJhdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRUYWZmeVNraWxsTWVudVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgU3dlZXRDYW1lcmFFbmZvcmNlbWVudFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRGlzYWJsZVNraWxsQWR2YW5jZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgRGlzYWJsZUZhc3RUcmF2ZWxTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IERpc2FibGVEaWZmaWN1bHR5U2VsZWN0aW9uU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBXb3JsZENsZWFuZXJTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IExvYWRPcmRlclZlcmlmaWNhdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQnJvd3NlclNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQXV0aFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgQ2hhcmFjdGVyU2VsZWN0U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBOZXRJbmZvU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBBbmltRGVidWdTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IFRpbWVyc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgUGxheWVyQm93U2hvdFNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgR2FtZW1vZGVFdmVudFNvdXJjZVNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgR2FtZW1vZGVVcGRhdGVTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IEZyb250SG90UmVsb2FkU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBCbG9ja2VkQW5pbWF0aW9uc1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgVm9pY2VDaGF0U2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBXb3JsZFZpZXcoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgS2V5Ym9hcmRFdmVudHNTZXJ2aWNlKHNwLCBjb250cm9sbGVyKSxcclxuICAgICAgICAgICAgbmV3IE1hZ2ljU3luY1NlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgICAgICBuZXcgUHJvZmlsaW5nU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTd2VldFRhZmZ5Tmlja25hbWVzU2VydmljZShzcCwgY29udHJvbGxlciksXHJcbiAgICAgICAgICAgIG5ldyBTZXJ2ZXJKc1ZlcmlmaWNhdGlvblNlcnZpY2Uoc3AsIGNvbnRyb2xsZXIpLFxyXG4gICAgICAgIF07XHJcbiAgICAgICAgU3BBcGlJbnRlcmFjdG9yLnNldHVwKGxpc3RlbmVycyk7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgIC8vIFRPRE86IGhhbmRsZSBzZXR1cCBmYWlsdXJlLiB3aWxsIG91dHB1dCB0byBnYW1lIGNvbnNvbGUgYnkgZGVmYXVsdFxyXG4gICAgICAgIHRocm93IGU7XHJcbiAgICB9XHJcbn07XHJcbi8vIFsxOC4wOC4yMDIzXVxyXG4vLyBJIHNhdyBcImF0dGVtcHQgdG8gY2FsbCBob29rcy5hZGQgd2hpbGUgaW4gaG9vayBjb250ZXh0XCIgZXJyb3JcclxuLy8gSSdtIG5vdCBzdXJlIGlmIGl0J3MgYSBDKysgYnVnIGluIFNreXJpbVBsYXRmb3JtIG9yIGFuIGFydGlmYWN0IG9mIHdlYnBhY2sraG90cmVsb2FkXHJcbi8vIEJ1dCBsZXQncyBmb3Igbm93IGVuc3VyZSB0aGF0IFwibWFpblwiIGV4ZWN1dGVzIGluc2lkZSB0aWNrIGNvbnRleHRcclxub25jZShcInRpY2tcIiwgbWFpbik7XHJcbiJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==